var URI;

var URIQuery;

(function() {
    function a(a, b) {
        var c = /^(.*)\//;
        if (a.authority && !a.path) {
            return "/" + b;
        } else {
            return a.getPath().match(c)[0] + b;
        }
    }
    var b = /\/((?!\.\.\/)[^\/]*)\/\.\.\//;
    function c(a) {
        if (!a) {
            return "";
        }
        var c = a.replace(/\/\.\//g, "/");
        c = c.replace(/\/\.$/, "/");
        while (c.match(b)) {
            c = c.replace(b, "/");
        }
        c = c.replace(/\/([^\/]*)\/\.\.$/, "/");
        while (c.match(/\/\.\.\//)) {
            c = c.replace(/\/\.\.\//, "/");
        }
        return c;
    }
    function d(a) {
        var b = [];
        for (var c in a) {
            if (a.hasOwnProperty(c)) {
                b.push(c);
            }
        }
        return b.sort();
    }
    function e(a) {
        return a;
    }
    function f(a) {
        return a;
    }
    URI = function(a) {
        if (!a) {
            a = "";
        }
        var b = /^(?:([^:\/?\#]+):)?(?:\/\/([^\/?\#]*))?([^?\#]*)(?:\?([^\#]*))?(?:\#(.*))?/;
        var c = a.match(b);
        var d = c[1] || null;
        var e = c[2] || null;
        var f = c[3] || null;
        var g = c[4] || null;
        var h = c[5] || null;
        this.getScheme = function() {
            return d;
        };
        this.setScheme = function(a) {
            d = a;
        };
        this.getAuthority = function() {
            return e;
        };
        this.setAuthority = function(a) {
            e = a;
        };
        this.getPath = function() {
            return f;
        };
        this.setPath = function(a) {
            f = a;
        };
        this.getQuery = function() {
            return g;
        };
        this.setQuery = function(a) {
            g = a;
        };
        this.getFragment = function() {
            return h;
        };
        this.setFragment = function(a) {
            h = a;
        };
    };
    URI.prototype.toString = function() {
        var a = "";
        if (this.getScheme()) {
            a += this.getScheme() + ":";
        }
        if (this.getAuthority()) {
            a += "//" + this.getAuthority();
        }
        if (this.getPath()) {
            a += this.getPath();
        }
        if (this.getQuery()) {
            a += "?" + this.getQuery();
        }
        if (this.getFragment()) {
            a += "#" + this.getFragment();
        }
        return a;
    };
    URI.prototype.resolve = function(b) {
        var d = new URI();
        if (this.getScheme()) {
            d.setScheme(this.getScheme());
            d.setAuthority(this.getAuthority());
            d.setPath(c(this.getPath()));
            d.setQuery(this.getQuery());
        } else {
            if (this.getAuthority()) {
                d.setAuthority(this.getAuthority());
                d.setPath(c(this.getPath()));
                d.setQuery(this.getQuery());
            } else {
                if (!this.getPath()) {
                    d.setPath(b.getPath());
                    if (this.getQuery()) {
                        d.setQuery(this.getQuery());
                    } else {
                        d.setQuery(b.getQuery());
                    }
                } else {
                    if (this.getPath().charAt(0) === "/") {
                        d.setPath(c(this.getPath()));
                    } else {
                        d.setPath(a(b, this.getPath()));
                        d.setPath(c(d.getPath()));
                    }
                    d.setQuery(this.getQuery());
                }
                d.setAuthority(b.getAuthority());
            }
            d.setScheme(b.getScheme());
        }
        d.setFragment(this.getFragment());
        return d;
    };
    URI.prototype.parseQuery = function() {
        return URIQuery.fromString(this.getQuery(), this.querySeparator);
    };
    URIQuery = function() {
        this.params = {};
        this.separator = "&";
    };
    URIQuery.fromString = function(a, b) {
        var c = new URIQuery();
        if (b) {
            c.separator = b;
        }
        c.addStringParams(a);
        return c;
    };
    URIQuery.prototype.addStringParams = function(a) {
        var b = a.split(this.separator);
        var c, d, e;
        for (var g = 0; g < b.length; g++) {
            c = b[g].split("=", 2);
            d = f(c[0].replace(/\+/g, " "));
            e = f(c[1].replace(/\+/g, " "));
            if (!this.params.hasOwnProperty(d)) {
                this.params[d] = [];
            }
            this.params[d].push(e);
        }
    };
    URIQuery.prototype.getParam = function(a) {
        if (this.params.hasOwnProperty(a)) {
            return this.params[a][0];
        }
        return null;
    };
    URIQuery.prototype.toString = function() {
        var a = [];
        var b = d(this.params);
        var c, e;
        for (c = 0; c < b.length; c++) {
            for (e = 0; e < this.params[b[c]].length; e++) {
                a.push(b[c].replace(/ /g, "+") + "=" + this.params[b[c]][e].replace(/ /g, "+"));
            }
        }
        return a.join(this.separator);
    };
})();

(function(a) {
    var b, c = "1.7.2", d = Math.round, e, f = {}, g = "en", h = typeof module !== "undefined" && module.exports, i = "months|monthsShort|weekdays|weekdaysShort|weekdaysMin|longDateFormat|calendar|relativeTime|ordinal|meridiem".split("|"), j = /^\/?Date\((\-?\d+)/i, k = /(\[[^\[]*\])|(\\)?(Mo|MM?M?M?|Do|DDDo|DD?D?D?|ddd?d?|do?|w[o|w]?|YYYY|YY|a|A|hh?|HH?|mm?|ss?|SS?S?|zz?|ZZ?|.)/g, l = /(\[[^\[]*\])|(\\)?(LT|LL?L?L?)/g, m = /([0-9a-zA-Z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+)/gi, n = /\d\d?/, o = /\d{1,3}/, p = /\d{3}/, q = /\d{1,4}/, r = /[0-9a-z\u00A0-\uD7FF\uF900-\uFDCF\uFDF0-\uFFEF]+/i, s = /Z|[\+\-]\d\d:?\d\d/i, t = /T/i, u = /^\s*\d{4}-\d\d-\d\d(T(\d\d(:\d\d(:\d\d(\.\d\d?\d?)?)?)?)?([\+\-]\d\d:?\d\d)?)?/, v = "YYYY-MM-DDTHH:mm:ssZ", w = [ [ "HH:mm:ss.S", /T\d\d:\d\d:\d\d\.\d{1,3}/ ], [ "HH:mm:ss", /T\d\d:\d\d:\d\d/ ], [ "HH:mm", /T\d\d:\d\d/ ], [ "HH", /T\d\d/ ] ], x = /([\+\-]|\d\d)/gi, y = "Month|Date|Hours|Minutes|Seconds|Milliseconds".split("|"), z = {
        Milliseconds: 1,
        Seconds: 1e3,
        Minutes: 6e4,
        Hours: 36e5,
        Days: 864e5,
        Months: 2592e6,
        Years: 31536e6
    }, A = {}, B = "DDD w M D d".split(" "), C = "M D H h m s w".split(" "), D = {
        M: function() {
            return this.month() + 1;
        },
        MMM: function(a) {
            return E("monthsShort", this.month(), this, a);
        },
        MMMM: function(a) {
            return E("months", this.month(), this, a);
        },
        D: function() {
            return this.date();
        },
        DDD: function() {
            var a = new Date(this.year(), this.month(), this.date()), b = new Date(this.year(), 0, 1);
            return ~~((a - b) / 864e5 + 1.5);
        },
        d: function() {
            return this.day();
        },
        dd: function(a) {
            return E("weekdaysMin", this.day(), this, a);
        },
        ddd: function(a) {
            return E("weekdaysShort", this.day(), this, a);
        },
        dddd: function(a) {
            return E("weekdays", this.day(), this, a);
        },
        w: function() {
            var a = new Date(this.year(), this.month(), this.date() - this.day() + 5), b = new Date(a.getFullYear(), 0, 4);
            return ~~((a - b) / 864e5 / 7 + 1.5);
        },
        YY: function() {
            return K(this.year() % 100, 2);
        },
        YYYY: function() {
            return K(this.year(), 4);
        },
        a: function() {
            return this.lang().meridiem(this.hours(), this.minutes(), true);
        },
        A: function() {
            return this.lang().meridiem(this.hours(), this.minutes(), false);
        },
        H: function() {
            return this.hours();
        },
        h: function() {
            return this.hours() % 12 || 12;
        },
        m: function() {
            return this.minutes();
        },
        s: function() {
            return this.seconds();
        },
        S: function() {
            return ~~(this.milliseconds() / 100);
        },
        SS: function() {
            return K(~~(this.milliseconds() / 10), 2);
        },
        SSS: function() {
            return K(this.milliseconds(), 3);
        },
        Z: function() {
            var a = -this.zone(), b = "+";
            if (a < 0) {
                a = -a;
                b = "-";
            }
            return b + K(~~(a / 60), 2) + ":" + K(~~a % 60, 2);
        },
        ZZ: function() {
            var a = -this.zone(), b = "+";
            if (a < 0) {
                a = -a;
                b = "-";
            }
            return b + K(~~(10 * a / 6), 4);
        }
    };
    function E(a, b, c, d) {
        var e = c.lang();
        return e[a].call ? e[a](c, d) : e[a][b];
    }
    function F(a, b) {
        return function(c) {
            return K(a.call(this, c), b);
        };
    }
    function G(a) {
        return function(b) {
            var c = a.call(this, b);
            return c + this.lang().ordinal(c);
        };
    }
    while (B.length) {
        e = B.pop();
        D[e + "o"] = G(D[e]);
    }
    while (C.length) {
        e = C.pop();
        D[e + e] = F(D[e], 2);
    }
    D.DDDD = F(D.DDD, 3);
    function H(a, b, c) {
        this._d = a;
        this._isUTC = !!b;
        this._a = a._a || null;
        this._lang = c || false;
    }
    function I(a) {
        var b = this._data = {}, c = a.years || a.y || 0, d = a.months || a.M || 0, e = a.weeks || a.w || 0, f = a.days || a.d || 0, g = a.hours || a.h || 0, h = a.minutes || a.m || 0, i = a.seconds || a.s || 0, j = a.milliseconds || a.ms || 0;
        this._milliseconds = j + i * 1e3 + h * 6e4 + g * 36e5;
        this._days = f + e * 7;
        this._months = d + c * 12;
        b.milliseconds = j % 1e3;
        i += J(j / 1e3);
        b.seconds = i % 60;
        h += J(i / 60);
        b.minutes = h % 60;
        g += J(h / 60);
        b.hours = g % 24;
        f += J(g / 24);
        f += e * 7;
        b.days = f % 30;
        d += J(f / 30);
        b.months = d % 12;
        c += J(d / 12);
        b.years = c;
        this._lang = false;
    }
    function J(a) {
        if (a < 0) {
            return Math.ceil(a);
        } else {
            return Math.floor(a);
        }
    }
    function K(a, b) {
        var c = a + "";
        while (c.length < b) {
            c = "0" + c;
        }
        return c;
    }
    function L(a, b, c) {
        var d = b._milliseconds, e = b._days, f = b._months, g;
        if (d) {
            a._d.setTime(+a + d * c);
        }
        if (e) {
            a.date(a.date() + e * c);
        }
        if (f) {
            g = a.date();
            a.date(1).month(a.month() + f * c).date(Math.min(g, a.daysInMonth()));
        }
    }
    function M(a) {
        return Object.prototype.toString.call(a) === "[object Array]";
    }
    function N(a, b) {
        var c = Math.min(a.length, b.length), d = Math.abs(a.length - b.length), e = 0, f;
        for (f = 0; f < c; f++) {
            if (~~a[f] !== ~~b[f]) {
                e++;
            }
        }
        return e + d;
    }
    function O(a, b, c, d) {
        var e, f, g = [];
        for (e = 0; e < 7; e++) {
            g[e] = a[e] = a[e] == null ? e === 2 ? 1 : 0 : a[e];
        }
        a[7] = g[7] = b;
        if (a[8] != null) {
            g[8] = a[8];
        }
        a[3] += c || 0;
        a[4] += d || 0;
        f = new Date(0);
        if (b) {
            f.setUTCFullYear(a[0], a[1], a[2]);
            f.setUTCHours(a[3], a[4], a[5], a[6]);
        } else {
            f.setFullYear(a[0], a[1], a[2]);
            f.setHours(a[3], a[4], a[5], a[6]);
        }
        f._a = g;
        return f;
    }
    function P(a, c) {
        var d, e, g = [];
        if (!c && h) {
            c = require("./lang/" + a);
        }
        for (d = 0; d < i.length; d++) {
            c[i[d]] = c[i[d]] || f.en[i[d]];
        }
        for (d = 0; d < 12; d++) {
            e = b([ 2e3, d ]);
            g[d] = new RegExp("^" + (c.months[d] || c.months(e, "")) + "|^" + (c.monthsShort[d] || c.monthsShort(e, "")).replace(".", ""), "i");
        }
        c.monthsParse = c.monthsParse || g;
        f[a] = c;
        return c;
    }
    function Q(a) {
        var c = typeof a === "string" && a || a && a._lang || null;
        return c ? f[c] || P(c) : b;
    }
    function R(a) {
        if (a.match(/\[.*\]/)) {
            return a.replace(/^\[|\]$/g, "");
        }
        return a.replace(/\\/g, "");
    }
    function S(a) {
        var b = a.match(k), c, d;
        for (c = 0, d = b.length; c < d; c++) {
            if (D[b[c]]) {
                b[c] = D[b[c]];
            } else {
                b[c] = R(b[c]);
            }
        }
        return function(e) {
            var f = "";
            for (c = 0; c < d; c++) {
                f += typeof b[c].call === "function" ? b[c].call(e, a) : b[c];
            }
            return f;
        };
    }
    function T(a, b) {
        var c = 5;
        function d(b) {
            return a.lang().longDateFormat[b] || b;
        }
        while (c-- && l.test(b)) {
            b = b.replace(l, d);
        }
        if (!A[b]) {
            A[b] = S(b);
        }
        return A[b](a);
    }
    function U(a) {
        switch (a) {
          case "DDDD":
            return p;

          case "YYYY":
            return q;

          case "S":
          case "SS":
          case "SSS":
          case "DDD":
            return o;

          case "MMM":
          case "MMMM":
          case "dd":
          case "ddd":
          case "dddd":
          case "a":
          case "A":
            return r;

          case "Z":
          case "ZZ":
            return s;

          case "T":
            return t;

          case "MM":
          case "DD":
          case "YY":
          case "HH":
          case "hh":
          case "mm":
          case "ss":
          case "M":
          case "D":
          case "d":
          case "H":
          case "h":
          case "m":
          case "s":
            return n;

          default:
            return new RegExp(a.replace("\\", ""));
        }
    }
    function V(a, b, c, d) {
        var e, f;
        switch (a) {
          case "M":
          case "MM":
            c[1] = b == null ? 0 : ~~b - 1;
            break;

          case "MMM":
          case "MMMM":
            for (e = 0; e < 12; e++) {
                if (Q().monthsParse[e].test(b)) {
                    c[1] = e;
                    f = true;
                    break;
                }
            }
            if (!f) {
                c[8] = false;
            }
            break;

          case "D":
          case "DD":
          case "DDD":
          case "DDDD":
            if (b != null) {
                c[2] = ~~b;
            }
            break;

          case "YY":
            c[0] = ~~b + (~~b > 70 ? 1900 : 2e3);
            break;

          case "YYYY":
            c[0] = ~~Math.abs(b);
            break;

          case "a":
          case "A":
            d.isPm = (b + "").toLowerCase() === "pm";
            break;

          case "H":
          case "HH":
          case "h":
          case "hh":
            c[3] = ~~b;
            break;

          case "m":
          case "mm":
            c[4] = ~~b;
            break;

          case "s":
          case "ss":
            c[5] = ~~b;
            break;

          case "S":
          case "SS":
          case "SSS":
            c[6] = ~~(("0." + b) * 1e3);
            break;

          case "Z":
          case "ZZ":
            d.isUTC = true;
            e = (b + "").match(x);
            if (e && e[1]) {
                d.tzh = ~~e[1];
            }
            if (e && e[2]) {
                d.tzm = ~~e[2];
            }
            if (e && e[0] === "+") {
                d.tzh = -d.tzh;
                d.tzm = -d.tzm;
            }
            break;
        }
        if (b == null) {
            c[8] = false;
        }
    }
    function W(a, b) {
        var c = [ 0, 0, 1, 0, 0, 0, 0 ], d = {
            tzh: 0,
            tzm: 0
        }, e = b.match(k), f, g;
        for (f = 0; f < e.length; f++) {
            g = (U(e[f]).exec(a) || [])[0];
            if (g) {
                a = a.slice(a.indexOf(g) + g.length);
            }
            if (D[e[f]]) {
                V(e[f], g, c, d);
            }
        }
        if (d.isPm && c[3] < 12) {
            c[3] += 12;
        }
        if (d.isPm === false && c[3] === 12) {
            c[3] = 0;
        }
        return O(c, d.isUTC, d.tzh, d.tzm);
    }
    function X(a, b) {
        var c, d = a.match(m) || [], e, f = 99, g, h, i;
        for (g = 0; g < b.length; g++) {
            h = W(a, b[g]);
            e = T(new H(h), b[g]).match(m) || [];
            i = N(d, e);
            if (i < f) {
                f = i;
                c = h;
            }
        }
        return c;
    }
    function Y(a) {
        var b = "YYYY-MM-DDT", c;
        if (u.exec(a)) {
            for (c = 0; c < 4; c++) {
                if (w[c][1].exec(a)) {
                    b += w[c][0];
                    break;
                }
            }
            return s.exec(a) ? W(a, b + " Z") : W(a, b);
        }
        return new Date(a);
    }
    function Z(a, b, c, d, e) {
        var f = e.relativeTime[a];
        return typeof f === "function" ? f(b || 1, !!c, a, d) : f.replace(/%d/i, b || 1);
    }
    function $(a, b, c) {
        var e = d(Math.abs(a) / 1e3), f = d(e / 60), g = d(f / 60), h = d(g / 24), i = d(h / 365), j = e < 45 && [ "s", e ] || f === 1 && [ "m" ] || f < 45 && [ "mm", f ] || g === 1 && [ "h" ] || g < 22 && [ "hh", g ] || h === 1 && [ "d" ] || h <= 25 && [ "dd", h ] || h <= 45 && [ "M" ] || h < 345 && [ "MM", d(h / 30) ] || i === 1 && [ "y" ] || [ "yy", i ];
        j[2] = b;
        j[3] = a > 0;
        j[4] = c;
        return Z.apply({}, j);
    }
    b = function(c, d) {
        if (c === null || c === "") {
            return null;
        }
        var e, f;
        if (b.isMoment(c)) {
            return new H(new Date(+c._d), c._isUTC, c._lang);
        } else if (d) {
            if (M(d)) {
                e = X(c, d);
            } else {
                e = W(c, d);
            }
        } else {
            f = j.exec(c);
            e = c === a ? new Date() : f ? new Date(+f[1]) : c instanceof Date ? c : M(c) ? O(c) : typeof c === "string" ? Y(c) : new Date(c);
        }
        return new H(e);
    };
    b.utc = function(a, c) {
        if (M(a)) {
            return new H(O(a, true), true);
        }
        if (typeof a === "string" && !s.exec(a)) {
            a += " +0000";
            if (c) {
                c += " Z";
            }
        }
        return b(a, c).utc();
    };
    b.unix = function(a) {
        return b(a * 1e3);
    };
    b.duration = function(a, c) {
        var d = b.isDuration(a), e = typeof a === "number", f = d ? a._data : e ? {} : a, g;
        if (e) {
            if (c) {
                f[c] = a;
            } else {
                f.milliseconds = a;
            }
        }
        g = new I(f);
        if (d) {
            g._lang = a._lang;
        }
        return g;
    };
    b.humanizeDuration = function(a, c, d) {
        return b.duration(a, c === true ? null : c).humanize(c === true ? true : d);
    };
    b.version = c;
    b.defaultFormat = v;
    b.lang = function(a, c) {
        var d;
        if (!a) {
            return g;
        }
        if (c || !f[a]) {
            P(a, c);
        }
        if (f[a]) {
            for (d = 0; d < i.length; d++) {
                b[i[d]] = f[a][i[d]];
            }
            b.monthsParse = f[a].monthsParse;
            g = a;
        }
    };
    b.langData = Q;
    b.isMoment = function(a) {
        return a instanceof H;
    };
    b.isDuration = function(a) {
        return a instanceof I;
    };
    b.lang("en", {
        months: "January_February_March_April_May_June_July_August_September_October_November_December".split("_"),
        monthsShort: "Jan_Feb_Mar_Apr_May_Jun_Jul_Aug_Sep_Oct_Nov_Dec".split("_"),
        weekdays: "Sunday_Monday_Tuesday_Wednesday_Thursday_Friday_Saturday".split("_"),
        weekdaysShort: "Sun_Mon_Tue_Wed_Thu_Fri_Sat".split("_"),
        weekdaysMin: "Su_Mo_Tu_We_Th_Fr_Sa".split("_"),
        longDateFormat: {
            LT: "h:mm A",
            L: "MM/DD/YYYY",
            LL: "MMMM D YYYY",
            LLL: "MMMM D YYYY LT",
            LLLL: "dddd, MMMM D YYYY LT"
        },
        meridiem: function(a, b, c) {
            if (a > 11) {
                return c ? "pm" : "PM";
            } else {
                return c ? "am" : "AM";
            }
        },
        calendar: {
            sameDay: "[Today at] LT",
            nextDay: "[Tomorrow at] LT",
            nextWeek: "dddd [at] LT",
            lastDay: "[Yesterday at] LT",
            lastWeek: "[last] dddd [at] LT",
            sameElse: "L"
        },
        relativeTime: {
            future: "in %s",
            past: "%s ago",
            s: "a few seconds",
            m: "a minute",
            mm: "%d minutes",
            h: "an hour",
            hh: "%d hours",
            d: "a day",
            dd: "%d days",
            M: "a month",
            MM: "%d months",
            y: "a year",
            yy: "%d years"
        },
        ordinal: function(a) {
            var b = a % 10;
            return ~~(a % 100 / 10) === 1 ? "th" : b === 1 ? "st" : b === 2 ? "nd" : b === 3 ? "rd" : "th";
        }
    });
    b.fn = H.prototype = {
        clone: function() {
            return b(this);
        },
        valueOf: function() {
            return +this._d;
        },
        unix: function() {
            return Math.floor(+this._d / 1e3);
        },
        toString: function() {
            return this._d.toString();
        },
        toDate: function() {
            return this._d;
        },
        toArray: function() {
            var a = this;
            return [ a.year(), a.month(), a.date(), a.hours(), a.minutes(), a.seconds(), a.milliseconds(), !!this._isUTC ];
        },
        isValid: function() {
            if (this._a) {
                if (this._a[8] != null) {
                    return !!this._a[8];
                }
                return !N(this._a, (this._a[7] ? b.utc(this._a) : b(this._a)).toArray());
            }
            return !isNaN(this._d.getTime());
        },
        utc: function() {
            this._isUTC = true;
            return this;
        },
        local: function() {
            this._isUTC = false;
            return this;
        },
        format: function(a) {
            return T(this, a ? a : b.defaultFormat);
        },
        add: function(a, c) {
            var d = c ? b.duration(+c, a) : b.duration(a);
            L(this, d, 1);
            return this;
        },
        subtract: function(a, c) {
            var d = c ? b.duration(+c, a) : b.duration(a);
            L(this, d, -1);
            return this;
        },
        diff: function(a, c, e) {
            var f = this._isUTC ? b(a).utc() : b(a).local(), g = (this.zone() - f.zone()) * 6e4, h = this._d - f._d - g, i = this.year() - f.year(), j = this.month() - f.month(), k = this.date() - f.date(), l;
            if (c === "months") {
                l = i * 12 + j + k / 30;
            } else if (c === "years") {
                l = i + (j + k / 30) / 12;
            } else {
                l = c === "seconds" ? h / 1e3 : c === "minutes" ? h / 6e4 : c === "hours" ? h / 36e5 : c === "days" ? h / 864e5 : c === "weeks" ? h / 6048e5 : h;
            }
            return e ? l : d(l);
        },
        from: function(a, c) {
            return b.duration(this.diff(a)).lang(this._lang).humanize(!c);
        },
        fromNow: function(a) {
            return this.from(b(), a);
        },
        calendar: function() {
            var a = this.diff(b().sod(), "days", true), c = this.lang().calendar, d = c.sameElse, e = a < -6 ? d : a < -1 ? c.lastWeek : a < 0 ? c.lastDay : a < 1 ? c.sameDay : a < 2 ? c.nextDay : a < 7 ? c.nextWeek : d;
            return this.format(typeof e === "function" ? e.apply(this) : e);
        },
        isLeapYear: function() {
            var a = this.year();
            return a % 4 === 0 && a % 100 !== 0 || a % 400 === 0;
        },
        isDST: function() {
            return this.zone() < b([ this.year() ]).zone() || this.zone() < b([ this.year(), 5 ]).zone();
        },
        day: function(a) {
            var b = this._isUTC ? this._d.getUTCDay() : this._d.getDay();
            return a == null ? b : this.add({
                d: a - b
            });
        },
        startOf: function(a) {
            switch (a.replace(/s$/, "")) {
              case "year":
                this.month(0);

              case "month":
                this.date(1);

              case "day":
                this.hours(0);

              case "hour":
                this.minutes(0);

              case "minute":
                this.seconds(0);

              case "second":
                this.milliseconds(0);
            }
            return this;
        },
        endOf: function(a) {
            return this.startOf(a).add(a.replace(/s?$/, "s"), 1).subtract("ms", 1);
        },
        sod: function() {
            return this.clone().startOf("day");
        },
        eod: function() {
            return this.clone().endOf("day");
        },
        zone: function() {
            return this._isUTC ? 0 : this._d.getTimezoneOffset();
        },
        daysInMonth: function() {
            return b.utc([ this.year(), this.month() + 1, 0 ]).date();
        },
        lang: function(b) {
            if (b === a) {
                return Q(this);
            } else {
                this._lang = b;
                return this;
            }
        }
    };
    function _(a, c) {
        b.fn[a] = function(a) {
            var b = this._isUTC ? "UTC" : "";
            if (a != null) {
                this._d["set" + b + c](a);
                return this;
            } else {
                return this._d["get" + b + c]();
            }
        };
    }
    for (e = 0; e < y.length; e++) {
        _(y[e].toLowerCase(), y[e]);
    }
    _("year", "FullYear");
    b.duration.fn = I.prototype = {
        weeks: function() {
            return J(this.days() / 7);
        },
        valueOf: function() {
            return this._milliseconds + this._days * 864e5 + this._months * 2592e6;
        },
        humanize: function(a) {
            var b = +this, c = this.lang().relativeTime, d = $(b, !a, this.lang()), e = b <= 0 ? c.past : c.future;
            if (a) {
                if (typeof e === "function") {
                    d = e(d);
                } else {
                    d = e.replace(/%s/i, d);
                }
            }
            return d;
        },
        lang: b.fn.lang
    };
    function aa(a) {
        b.duration.fn[a] = function() {
            return this._data[a];
        };
    }
    function ba(a, c) {
        b.duration.fn["as" + a] = function() {
            return +this / c;
        };
    }
    for (e in z) {
        if (z.hasOwnProperty(e)) {
            ba(e, z[e]);
            aa(e.toLowerCase());
        }
    }
    ba("Weeks", 6048e5);
    if (h) {
        module.exports.moment = b;
    }
    if (typeof ender === "undefined") {
        this["moment"] = b;
    }
    if (typeof define === "function" && define.amd) {
        define("moment", [], function() {
            return b;
        });
    }
}).call(this);

if (typeof isNodeEnvironment == "function" && isNodeEnvironment()) {
    var moment = module.exports.moment;
}

var namespace = {
    addon: {},
    attach: {},
    backend: {},
    bg: {
        task: {}
    },
    cb: {},
    cloud: {},
    crawling: {},
    cs: {},
    files: {},
    fg: {},
    format: {},
    iframe: {},
    library: {},
    pdf: {},
    plugin: {},
    pop: {},
    guru: {
        crawling: {},
        db: {},
        format: {},
        deduplication: {}
    },
    scratch: {},
    target: {},
    test: {},
    upload: {},
    webimport: {},
    wizard: {},
    write: {}
};

function isBrowserEnvironment() {
    return typeof window === "object" && typeof window.document === "object" && !isNodeEnvironment();
}

function isNodeEnvironment() {
    return typeof module == "object" && module && typeof module.exports === "object";
}

function isChromeEnvironment() {
    return typeof window === "object" && typeof window.chrome === "object";
}

if (isNodeEnvironment()) {
    var PP = namespace;
    PP.ent = require("ent");
    module.exports = PP;
}

if (!isBrowserEnvironment()) {
    var window = {};
    if (!global.isPaperpileCiteServerInstance) {
        var $ = require("cheerio");
        $.prototype.filterNode = function(a) {
            var b = a.toLowerCase();
            return this.find("*").filter(function() {
                var a = this.name.toLowerCase();
                return a === b;
            });
        };
        var $xmlNodeJs = $.load("XMLSTRING", {
            xmlMode: true
        });
        var xhrc = require("xmlhttprequest-cookie");
        var XMLHttpRequest = xhrc.XMLHttpRequest;
        var CookieJar = xhrc.CookieJar;
        var userAgent = "Mozilla/5.0 (Macintosh; Intel Mac OS X 10_12_2) AppleWebKit/537.36 (KHTML, like Gecko) Chrome/55.0.2883.95 Safari/537.36";
    }
}

if (window.ppAlreadyExists === undefined) {
    window.ppAlreadyExists = false;
}

if (window.PP) {
    console.log("window.PP already exists -- not loading singletons");
    window.ppAlreadyExists = true;
} else {
    window.PP = namespace;
    var PP = window.PP;
}

if (window.document) {
    var runningNode = document.getElementById("pp-extension-running");
    if (runningNode) {
        window.extensionExists = true;
    }
}

if (window.isWorker) {
    var PP = namespace;
}

var extV = "344";

var webappV = "344";

var urlBase = "https://paperpile.com";

var placeholderRegex = /^__PP_/;

if (extV.match(placeholderRegex) && webappV.match(placeholderRegex)) {
    window.PP_EXTENSION_VERSION = 0;
    window.PP_WEBAPP_VERSION = 0;
    window.PP_URL_BASE = "http://127.0.0.1:8080";
} else {
    window.PP_EXTENSION_VERSION = extV;
    window.PP_WEBAPP_VERSION = webappV;
    window.PP_URL_BASE = urlBase;
}

if (typeof require !== "undefined" && typeof module !== "undefined" && "exports" in module) {
    module.exports = PP;
} else {
    if (!window.isWorker) {}
}

if (!window.ppAlreadyExists && window.$) {
    $.fn.filterNode = function(a) {
        var b = a.toLowerCase();
        return this.find("*").filter(function() {
            var a = this.nodeName.toLowerCase();
            return a === b;
        });
    };
}

function createSingleton(a, b, c) {
    if (isBrowserEnvironment()) {
        if (window.ppAlreadyExists === true && window.doNotClobber === true) {
            return;
        }
    }
    a[c] = new a[b]();
}

PP.Ajax = {
    request: function(a) {
        var b = this;
        if (window.plackSession) {
            var c = PP.Utils.getCookie("plack_session");
            if (window.plackSession !== c) {
                window.plackSession = null;
                PP.log({
                    type: "exception",
                    subtype: "Sanitation",
                    msg: "Plack session mismatch",
                    session_user_id: PP.Session.user_id
                });
            }
        }
        var d = {
            url: a.url,
            data: a.params,
            type: "GET"
        };
        var e = PP.Utils.clone(a);
        var f = a.callback;
        delete a.callback;
        var g = 0;
        if (a.delay) {
            g = a.delay;
        }
        var h = 0;
        if (a.maxRetries !== undefined) {
            h = a.maxRetries;
        }
        var i = 0;
        if (a.curRetryCount === undefined) {
            a.curRetryCount = 0;
        } else {
            i = a.curRetryCount;
        }
        if (a.timeout) {
            d.timeout = a.timeout;
        }
        if (a.dataType) {
            d.dataType = a.dataType;
        }
        if (a.cache === false) {
            d.cache = false;
        }
        if (a.method) {
            d.type = a.method;
        }
        if (a.oauth) {
            var j = d.url;
            var k = d.type;
            var l = d.data;
            var m = a.oauth.signURL(j, k, l);
            if (m != j) {
                d.url = m;
                delete d.data;
            }
            if (a.oauth && a.oauth["addHeaders"]) {
                a.oauth.addHeaders(a);
            }
        }
        if (a.accessToken) {
            if (!a.headers) {
                a.headers = {};
            }
            a.headers["Authorization"] = "Bearer " + a.accessToken;
        }
        if (a.headers) {
            d.beforeSend = function(b, c) {
                b.origUrl = c.url;
                for (var d in a.headers) {
                    if (a.headers.hasOwnProperty(d)) {
                        b.setRequestHeader(d, a.headers[d]);
                    }
                }
            };
        } else {
            d.beforeSend = function(a, b) {
                a.origUrl = b.url;
            };
        }
        if (a.scope) {
            d.context = a.scope;
        }
        if (a.progress && isBrowserEnvironment()) {
            var n = a.progress;
            delete a.progress;
            d.xhr = function() {
                var a = new window.XMLHttpRequest();
                a.addEventListener("progress", function(a) {
                    if (a.lengthComputable) {
                        var b = a.loaded / a.total;
                        n(b);
                    }
                }, false);
                return a;
            };
        }
        d.async = true;
        var o = {
            url: a.url,
            urlHistory: [ a.url ]
        };
        var p;
        var q;
        if (a.requestListenFn) {
            q = a.requestListenFn;
            if (window && window.chrome && window.chrome.webRequest) {
                chrome.webRequest.onBeforeRequest.addListener(q, {
                    urls: [ "<all_urls>" ]
                });
            }
        }
        if (a.trackRedirects && isChromeEnvironment() && window.chrome.webRequest) {
            p = function(b) {
                var c = window.unescape(b.url);
                if (o.url === c || o.url === b.url) {
                    var d = PP.Utils.ellipsis(b.url, 30, null, "...");
                    var e = PP.Utils.ellipsis(b.redirectUrl, 30, null, "...");
                    console.log(a.logPrefix || "", "found redirect URL", d, "->", e);
                    o.urlHistory.push(b.redirectUrl);
                    o.url = b.redirectUrl;
                }
            };
            chrome.webRequest.onBeforeRedirect.addListener(p, {
                urls: [ "<all_urls>" ]
            });
        }
        var r;
        if (a.loadingMessage && isBrowserEnvironment()) {
            var s = a.loadingMessageDelay || 1e3;
            r = window.setTimeout(function() {
                a.loadingMessageObject = PP.backend.Utils.showLoadingMessage(a.loadingMessage);
            }, s);
        }
        if (typeof jQuery != "undefined") {
            jQuery.support.cors = true;
        }
        var t = function() {
            var c = new Date().getTime();
            var g = function(d, g, k) {
                var l;
                var m = new Date().getTime();
                if (p && isChromeEnvironment()) {
                    if (window.chrome.webRequest) {
                        chrome.webRequest.onBeforeRedirect.removeListener(p);
                    }
                }
                if (q && isChromeEnvironment()) {
                    if (window.chrome.webRequest) {
                        chrome.webRequest.onBeforeRequest.removeListener(q);
                    }
                }
                if (isBrowserEnvironment()) {
                    if (o.url !== a.url) {
                        j.redirectUrl = [ o.url ];
                    }
                    if (o.urlHistory) {
                        j.redirectHistory = o.urlHistory;
                    }
                    if (a.trackRedirects) {
                        if ((g === "parsererror" || g === "success") && !("redirectUrl" in j)) {
                            var n = [];
                            if (g === "success") {
                                n = b.getRedirectUrlFromBody(a.url, j.responseText, a.purpose);
                            } else {
                                n = b.getRedirectUrlFromBody(a.url, j.responseText, a.purpose);
                            }
                            if (n.length > 0) {
                                j.redirectUrl = n;
                            }
                        } else if (g === "success" && "redirectUrl" in j && j.redirectUrl[0]) {
                            var s = b.getRedirectUrlFromBody(j.redirectUrl[0], j.responseText, a.purpose);
                            if (s.length > 0) {
                                j.redirectUrl = s;
                            }
                        }
                    }
                }
                if (r !== undefined) {
                    clearTimeout(r);
                    PP.backend.Utils.clearLoadingMessage(a.loadingMessageObject);
                    delete a.loadingMessageObject;
                }
                if (g === "success") {
                    var t = 5e3;
                    var u = 1e4;
                    var v = m - c;
                    var w = true;
                    var x = "";
                    if (a.params && a.params.query) {
                        var y = a.params.query;
                        var z = JSON.parse(y);
                        x = z.action;
                        if (z.mcollection) {
                            if (z.mcollection === "Logs") {
                                w = false;
                            }
                            x += "/" + z.mcollection;
                        }
                    }
                    var A = a.url;
                    if (PP.Ajax.isPaperpileAjax(a.url)) {
                        A = A.replace(/https?:\/\/(127.0.0.1:8080|paperpile.com|stage.paperpile.com)\//, "");
                        A = A.replace(/\?.*$/, "");
                    } else {
                        if (a.logTiming !== true) {
                            w = false;
                        }
                        A = PP.Utils.getDomainSuffix(a.url);
                    }
                    if (w) {
                        var B = .5;
                        if (PP.Ajax.isPaperpileAjax(a.url)) {
                            if (PP.Globals.isBackgroundPage()) {
                                B = .1;
                            }
                            if (x && x.match(/update\/library/i)) {
                                B = .1;
                            }
                        }
                        if (Math.random() < B) {
                            var C = a.url;
                            var D = C.split("?");
                            if (D.length > 1) {
                                C = D[0];
                            }
                            var E = PP.Ajax.isPaperpileAjax(a.url);
                            var F = E ? "Paperpile" : "Non-Paperpile";
                            if (typeof PP.backend.Logs != "undefined") {
                                PP.backend.Logs.googleAnalytics({
                                    timingOnly: true,
                                    type: F,
                                    subtype: x || A,
                                    msg: C,
                                    duration: v
                                });
                            }
                        }
                    }
                    if (PP.Ajax.isPaperpileAjax(a.url) && v > t) {
                        var G = x;
                        if (G == "") {
                            G = A;
                        }
                        var H = true;
                        if (G == "insert/Logs") {
                            H = false;
                        }
                        if (H) {
                            if (typeof PP.log == "function") {
                                PP.log({
                                    type: "performance",
                                    subtype: "Paperpile Ajax",
                                    msg: "Slow request at " + G,
                                    url: a.url,
                                    start: c,
                                    end: m,
                                    duration: v
                                });
                            }
                        }
                    } else if (v > u) {
                        if (typeof PP.log == "function") {
                            PP.log({
                                type: "performance",
                                subtype: "Other Ajax",
                                msg: "Slow request at " + A,
                                url: a.url,
                                start: c,
                                end: m,
                                duration: v
                            });
                        }
                    }
                    PP.Utils.callback(f, a.scope || j, [ d, g, k ]);
                } else {
                    if (g === "error" && d.status === 401 && PP.Ajax.isPaperpileAjax(a.url)) {
                        if (PP.bg.LoginState) {
                            PP.bg.LoginState.setLoggedOut();
                        }
                        if (PP.Globals.isWebApp() || PP.Globals.isBackgroundPage()) {
                            if (!(a.params && a.params.query && a.params.query.match('"mcollection":"Logs"'))) {
                                PP.Utils.createErrorStatus("You need to sign in again", [ "STATUS_PANEL_SIGN_IN" ]);
                            }
                        }
                        PP.Utils.callback(f, a.scope || j, [ d.responseText, g, d ]);
                        return;
                    }
                    if (g === "timeout") {
                        if (typeof PP.log == "function") {
                            PP.log({
                                type: "performance",
                                subtype: "Ajax timeout",
                                msg: "URL timed out: " + a.url,
                                url: a.url,
                                start: c,
                                end: m,
                                duration: v
                            });
                        }
                        if (h > 0 && i < h) {
                            if (typeof PP.log == "function") {
                                PP.log({
                                    type: "performance",
                                    subtype: "Ajax timeout -> retry",
                                    msg: "Timeout retry (" + i + " of " + h + ") for URL: " + a.url,
                                    url: a.url,
                                    start: c,
                                    end: m,
                                    duration: v
                                });
                            }
                            e.curRetryCount = i + 1;
                            PP.Utils.defer(function() {
                                b.request(e);
                            }, 20);
                        }
                        PP.Utils.callback(f, a.scope || j, [ d.responseText, g, d ]);
                        return;
                    }
                    if (PP.Ajax.isPaperpileAjax(a.url) && a.noErrorStatusPanel !== true && g !== "abort" && isBrowserEnvironment()) {
                        var I = true;
                        var J = true;
                        var K = "there was an error on our server.";
                        var L = [ "STATUS_PANEL_RELOAD_WEBAPP" ];
                        if (d.status === 503) {
                            K = "the Paperpile servers are currently unavailable.";
                            L = [ "STATUS_PANEL_VISIT_TWITTER" ];
                        } else if (d.responseText && d.responseText.match(/error/g)) {
                            var z = JSON.parse(d.responseText);
                            if (z && z.error) {
                                var M = z.error;
                                if (M && M.type && !M.type.match(/unknown/gi)) {
                                    K = 'The server responded with an error "' + M.msg + '"';
                                    if (M.actions) {
                                        L = z.error.actions;
                                    }
                                    J = false;
                                }
                            }
                        } else if (d.status === 0 && d.responseText == "") {
                            J = true;
                            I = false;
                            if (PP.Globals.isBackgroundPage() && !a.url.match(/ping/i)) {
                                PP.bg.LoginState.pingServer();
                            }
                        }
                        if (PP.Globals.isWebApp()) {
                            if (!a.url.match(/ping/i)) {
                                var N = Paperpile.Globals.grid();
                                if (N) {
                                    var O = N.store;
                                    if (O.updateFilterViewTimeout) {
                                        clearTimeout(O.updateFilterViewTimeout);
                                    }
                                }
                                if (I) {
                                    PP.Utils.createErrorStatus(K, L);
                                }
                                if (J) {
                                    PP.fg.ServerState.badResponseCheck();
                                }
                            }
                        } else {
                            if (I) {
                                PP.Utils.createErrorStatus(K, L);
                            }
                        }
                    }
                    PP.Utils.callback(f, a.scope || j, [ d.responseText, g, d ]);
                }
            };
            nodeRequest = function(a, c) {
                a.method = c.type;
                if (a.hasOwnProperty("beforeSend")) {
                    if (c.headers) {
                        for (var d in c.headers) {
                            if (c.headers.hasOwnProperty(d)) {
                                if (a.hasOwnProperty("headers")) {
                                    a.headers[d] = c.headers[d];
                                } else {
                                    a.headers = {
                                        key: c.headers[d]
                                    };
                                }
                            }
                        }
                    }
                }
                var e = new URI(c.url);
                var f = e.getQuery() || "";
                if ("params" in c) {
                    Object.keys(c.params).forEach(function(a) {
                        if (a == "action") return;
                        if (f.length) f += "&";
                        f += encodeURIComponent(a) + "=" + encodeURIComponent(c.params[a]);
                    });
                    e.setQuery(f);
                    c.url = e.toString();
                }
                var h = new XMLHttpRequest();
                h.open(a.type, c.url, true);
                if (c.headers) {
                    Object.keys(c.headers).forEach(function(a) {
                        h.replaceRequestHeader(a, c.headers[a]);
                    });
                }
                h.replaceRequestHeader("User-Agent", userAgent);
                h.onload = function() {
                    if (c.trackRedirects && c.url !== h.responseUrl) {
                        h.origUrl = c.url;
                        h.redirectUrl = h.responseUrl;
                        h.redirectHistory = [ c.url, h.responseUrl ];
                    } else if (c.trackRedirects) {
                        var a = b.getRedirectUrlFromBody(c.url, h.responseText, c.purpose);
                        if (a.length) {
                            h.origUrl = c.url;
                            h.redirectUrl = a[0];
                            h.redirectHistory = [ c.url, a[0] ];
                        }
                    }
                    if (h.status >= 200 && h.status < 400) {
                        var d = h.getResponseHeader("Content-Type");
                        if (d && d.indexOf("application/json") > -1) {
                            var e;
                            try {
                                e = JSON.parse(h.responseText);
                            } catch (a) {
                                e = false;
                            }
                            if (e) h.responseText = e;
                        }
                        if (c.hasOwnProperty("scope") && c.scope) {
                            g.bind(c.scope)(h.responseText, "success", h);
                        } else {
                            g(h.responseText, "success", h);
                        }
                    } else {
                        g(h, "error", null);
                    }
                };
                h.onerror = function() {
                    console.log("Request failed", h.statusText);
                    g(h, "error", null);
                };
                if (a.type == "POST" && f && c.url.indexOf("base-search.net") > -1) {
                    h.replaceRequestHeader("Content-Type", "application/x-www-form-urlencoded; charset=UTF-8");
                    h.send(f);
                } else {
                    h.send();
                }
            };
            if (isBrowserEnvironment()) {
                var j = $.ajax(d);
                j.always(g);
                return j;
            } else {
                return nodeRequest(d, a);
            }
        };
        if (g > 0) {
            var u = PP.Utils.defer(t, g);
            var v = {
                isFakeXhr: true,
                abort: function() {
                    clearTimeout(u);
                    var b = {
                        status: -1
                    };
                    PP.Utils.callback(f, a.scope, [ null, "aborted", b ]);
                }
            };
            return v;
        } else {
            return t();
        }
    },
    followRedirects: function(a, b) {
        var c = this;
        var d = {
            initiatingUrl: a,
            requestId: null,
            jqXhr: null,
            urls: []
        };
        var e = function(a) {
            var b = a.url;
            if (b === d.initiatingUrl) {
                d.requestId = a.requestId;
            } else {
                if (a.requestId !== d.requestId) {
                    return;
                }
            }
            d.urls.push(b);
            if (!PP.Ajax.isRedirectUrl(b)) {
                d.jqXhr.abort();
            }
        };
        var c = this;
        var f = function(a) {
            d.jqXhr = PP.Ajax.request({
                url: a,
                requestListenFn: e,
                callback: function(c, e, g) {
                    if (e === "success") {
                        var h = PP.Ajax.getRedirectUrlFromBody(a, c);
                        if (h.length > 0) {
                            d.initiatingUrl = h[0];
                            f(h[0]);
                        } else {
                            PP.Utils.callback(b, null, [ d.urls ]);
                        }
                    } else {
                        PP.Utils.callback(b, null, [ d.urls ]);
                    }
                }
            });
        };
        f(a);
    },
    isPaperpileAjax: function(a) {
        if (!a) {
            return false;
        }
        if (a.match(/ajax\/crud\/query/)) {
            return true;
        }
        if (a.match(/ajax/)) {
            return true;
        }
        return false;
    },
    getRedirectUrlFromBody: function(a, b, c) {
        var d = null;
        var e, f;
        if (a.match(/.*readcube.com\/articles\/(10\..*)/i)) {
            return [ "http://dx.doi.org/" + RegExp.$1 ];
        }
        if (b && PP.Utils.isString(b)) {
            if (a.match(/pt.wkhealth.com\/pt\/re\/lwwgateway\/landingpage/)) {
                d = b.match(/OvidAN\s*=\s*'([^\']+)'/);
                if (d && d[1]) {
                    var g = "http://ovidsp.ovid.com/ovidweb.cgi?T=JS&MODE=ovid&NEWS=n&PAGE=fulltext&D=ovft&SEARCH=" + d[1] + ".an.";
                    var h = "http://content.wkhealth.com/linkback/openurl?an=" + d[1];
                    return [ g, h ];
                }
            }
            if (b.match(/EZproxyCheckBack/)) {
                d = b.match(/location.href\s*=\s*"([^\"]+)"/);
                if (d && d[1]) {
                    return [ d[1] ];
                }
            }
            if (a.match(/fulltext\.do/i)) {
                if (b.match(/^http/)) {
                    return [ b ];
                }
            }
            if (a.match(/nature\.com\/doifinder/i)) {
                d = b.match(/href="([^\"]+)"\s+class="articletext"/);
                if (d && d[1]) {
                    return [ "http://www.nature.com" + d[1] ];
                }
            }
            if (a.match(/linkinghub\.elsevier\.com/)) {
                d = b.match(/name=\"urls\[\'sd\'\]\"\s+value=\"(http:\/\/www.sciencedirect.com\/[^\"]+)\"/);
                if (d && d[1]) {
                    return [ d[1] ];
                } else {
                    d = b.match(/name=\"redirectURL\"\s+value=\"([^\"]+)\"/);
                    if (d && d[1]) {
                        return [ d[1].replace(/\?_returnURL=.*/, "") ];
                    }
                }
            }
            if (b.match(/googleJavaScriptRedirect/i)) {
                d = b.match(/URL='(.*?)'/);
                if (d && d[1]) {
                    return [ d[1] ];
                }
            }
            if (b.match(/http-equiv="refresh"/i)) {
                d = b.match(/URL=(.*?)"/);
                if (d && d[1]) {
                    return [ d[1] ];
                }
            }
            if (a.match(/ebscohost\.com\/plink/i)) {
                d = b.match(/window\.location\.replace\('([^']+)'\)/);
                if (d && d[1]) {
                    e = new URI(d[1]);
                    return [ e.resolve(new URI(a)).toString() ];
                }
            }
            if (a.match(/heinonline\.org\/hol/i) || a.match(/heinonline\.org\/hol\/printrequest/i)) {
                d = b.match(/window\.location\s*=\s*"([^"]+)/);
                if (d && d[1]) {
                    e = new URI(d[1]);
                    return [ e.resolve(new URI(a)).toString() ];
                }
            }
            if (a.match(/ncbi\.nlm\.nih\.gov\/pubmed/i) && c === "PDF") {
                d = b.match(/Full text links[^=]+="([^"]+)"/i);
                if (d && d[1]) {
                    e = new URI(d[1].replace(/&amp;/g, "&"));
                    return [ e.resolve(new URI(a)).toString() ];
                }
            }
            if (a.match(/sfx\./i) || a.match(/sfxit\./i) || a.match(/sfxhosted\./i) || a.match(/exlibrisgroup\.com\S+openurl/i) || a.match(/exlibrisgroup\.com\S+uresolver/i)) {
                f = new PP.crawling.LinkResolver({
                    url: a,
                    text: b
                });
                return f.sfx();
            }
            if (a.match(/search\.serialssolutions\.com/i) && !a.match(/vb3lk7eb4t\./)) {
                f = new PP.crawling.LinkResolver({
                    url: a,
                    text: b
                });
                return f.serialsSolutions();
            }
            if (a.match(/\.on\.worldcat\.org/i)) {
                d = b.match(/a\s+class="fullTextLink"\s+href="([^"]+)/);
                if (d && d[1]) {
                    return [ d[1] ];
                }
            }
        }
        return [];
    },
    isRedirectUrl: function(a, b) {
        var c = [ "bit\\.ly/", "doi\\.wiley\\.com\\/", "doi\\.acm\\.org\\/", "doi\\.org\\/[a-z:]*10\\.", "dx\\.plos\\.org\\/", "entrez\\/eutils\\/elink\\.fcgi", "f1000r\\.es\\/", "feeds\\.plos\\.org\\/~r", "feeds\\.nature\\.com\\/~r", "ff\\.im\\/", "fulltext\\.do", "goo\\.gl\\/", "google\\.com\\/url\\?", "is\\.gd\\/", "agu\\.org\\/pubs\\/crossref", "japanlinkcenter\\.org", "worldscinet\\.com", "joi\\.jlc\\.jst\\.go\\.jp\\/jst\\.jstage\\/expanim\\/", "joi\\.jlc\\.jst\\.go\\.jp\\/dn", "linkinghub\\.elsevier\\.com\\/", "nature\\.com\\/doifinder\\/", "nyti\\.ms\\/", "ow\\.ly\\/", "shar\\.es\\/", "t\\.co\\/", "tinyurl\\.com\\/", "openurl\\.ingenta\\.com\\/", "\\/xflink\\?", "\\/cgi\\/doi\\/", "\\/cgi\\/pmidlookup\\?", "\\/lookup\\/", "\\/resolve\\/", "readcube\\.com\\/articles\\/", "nature\\.com\\/(embo|msb)", "ovidsp\\.tx\\.ovid\\.com.+pdflink=", "emeraldinsight\\.com.*(articleid|contentid|chapterid)=", "landesbioscience\\.com", "hdl\\.handle\\.net\\/", "springerlink\\.metapress\\.com\\/", "mendeley.com\\/files\\/.*", "opticsinfobase\\.org", "icevirtuallibrary\\.com\\/content\\/", "envplan\\.com", "perceptionweb\\.com", "hthpweb\\.com", "summon\\.serialssolutions\\.com\\/2\\.0\\.0\\/link", "maneyonline\\.com", "palgrave-journals\\.com\\/", "link\\.aps\\.org\\/", "ascopubs\\.org\\/content", "medphys\\.org", "asadl\\.org", "avspublications\\.org", "aip\\.org", "doi\\.emh\\.ch", "palgraveconnect\\.com", "oxfordjournals\\.org", "sfx\\.\\S+\\.\\S+\\?", "sfxit\\.\\S+\\.\\S+\\?", "sfxhosted\\.\\S+\\.\\S+\\?", "exlibrisgroup\\.com\\S+openurl", "exlibrisgroup\\.com\\S+uresolver", "search\\.serialssolutions\\.com", "on\\.worldcat\\.org", "linker2\\.worldcat\\.org", "ebscohost\\.com\\/plink", "heinonline\\.org\\/hol.*men_hide" ];
        var d = [];
        var e = [ "ncbi\\.nlm\\.nih\\.gov\\/pubmed" ];
        if (PP.crawling.Proxy.isLoginUrl(a)) return true;
        a = a.toLowerCase();
        for (var f = 0; f < c.length; f++) {
            if (a.match(c[f])) {
                return true;
            }
        }
        if (b === "PDF") {
            for (var f = 0; f < e.length; f++) {
                if (a.match(e[f])) {
                    return true;
                }
            }
        }
        if (b === "META") {
            for (var f = 0; f < d.length; f++) {
                if (a.match(d[f])) {
                    return true;
                }
            }
        }
        return false;
    }
};

(function() {
    var a = Array.prototype, b = a.slice, c = "forEach" in a, d = "map" in a, e = "indexOf" in a, f = "every" in a, g = "some" in a, h = "filter" in a;
    PP.Array = {
        remove: function(a, b) {
            for (var c = 0; c < a.length; c++) {
                if (a[c] === b) {
                    a.splice(c, 1);
                    return a;
                }
            }
        },
        pluck: function(a, b) {
            var c = [], d, e, f;
            for (d = 0, e = a.length; d < e; d++) {
                f = a[d];
                c.push(f[b]);
            }
            return c;
        },
        sort: function(a, b) {
            a.sort(b);
        },
        filter: function(a, b, c) {
            return a.filter(b, c);
        },
        each: function(a, b, c) {
            return a.forEach(b, c);
        },
        map: function(a, b, c) {
            return a.map(b, c);
        },
        contains: function(a, b) {
            return a.indexOf(b) !== -1;
        },
        indexOf: function(a, b, c) {
            return a.indexOf(b, c);
        },
        merge: function() {
            var a = b.call(arguments), c = [], d, e;
            for (d = 0, e = a.length; d < e; d++) {
                c = c.concat(a[d]);
            }
            return PP.Array.unique(c);
        },
        flatten: function(a) {
            var b = [];
            function c(a) {
                var d, e, f;
                for (d = 0, e = a.length; d < e; d++) {
                    f = a[d];
                    if (PP.Utils.isArray(f)) {
                        c(f);
                    } else {
                        b.push(f);
                    }
                }
                return b;
            }
            return c(a);
        },
        stringUnique: function(a) {
            var b = {};
            var c = [];
            a.forEach(function(a) {
                if (b[a] === undefined) {
                    c.push(a);
                    b[a] = true;
                }
            });
            return c;
        },
        unique: function(a) {
            var b = [], c = 0, d = a.length, e;
            for (;c < d; c++) {
                e = a[c];
                if (PP.Array.indexOf(b, e) === -1) {
                    b.push(e);
                }
            }
            return b;
        },
        mapCounts: function(a, b, c) {
            var d = {}, e = a.length, f = undefined, g = 0;
            if (!b) {
                while (e--) {
                    f = a[e];
                    g = d[f];
                    if (g === undefined) g = 0;
                    d[f] = g + 1;
                }
            } else if (typeof b === "string") {
                while (e--) {
                    f = a[e][b];
                    g = d[f];
                    if (g === undefined) g = 0;
                    d[f] = g + 1;
                }
            } else {
                while (e--) {
                    f = b.call(c, a[e]);
                    g = d[f];
                    if (g === undefined) g = 0;
                    d[f] = g + 1;
                }
            }
            return d;
        },
        mapBoolean: function(a, b, c) {
            var d = {}, e = a.length;
            if (!b) {
                while (e--) {
                    d[a[e]] = true;
                }
            } else if (typeof b === "string") {
                while (e--) {
                    d[a[e][b]] = true;
                }
            } else {
                while (e--) {
                    d[b.call(c, a[e])] = true;
                }
            }
            return d;
        },
        toMap: function(a, b, c) {
            var d = {};
            if (a === undefined || a === null) {
                return d;
            }
            var e = a.length;
            if (!b) {
                console.log("toMap requires a getKey argument");
                return {};
            } else if (typeof b === "string") {
                while (e--) {
                    d[a[e][b]] = a[e];
                }
            } else {
                while (e--) {
                    d[b.call(c, a[e])] = a[e];
                }
            }
            return d;
        },
        batch: function(a, b) {
            var c = [];
            while (1) {
                var d = [];
                for (var e = 0; e < b; e++) {
                    var f = a.pop();
                    if (f) {
                        d.push(f);
                    } else {
                        break;
                    }
                }
                c.push(d);
                if (a.length === 0) break;
            }
            return c;
        }
    };
})();

(function() {
    var a = Object.prototype, b = a.toString, c = function() {}, d;
    PP.Utils = {
        languages: {
            aa: {
                n: [ "Afar" ],
                a3: "aar"
            },
            ab: {
                n: [ "Abkhazian" ],
                a3: "abk"
            },
            af: {
                n: [ "Afrikaans" ],
                a3: "afr"
            },
            ak: {
                n: [ "Akan" ],
                a3: "aka"
            },
            sq: {
                n: [ "Albanian" ],
                a3: "alb"
            },
            am: {
                n: [ "Amharic" ],
                a3: "amh"
            },
            ar: {
                n: [ "Arabic" ],
                a3: "ara"
            },
            an: {
                n: [ "Aragonese" ],
                a3: "arg"
            },
            hy: {
                n: [ "Armenian" ],
                a3: "arm"
            },
            as: {
                n: [ "Assamese" ],
                a3: "asm"
            },
            av: {
                n: [ "Avaric" ],
                a3: "ava"
            },
            ae: {
                n: [ "Avestan" ],
                a3: "ave"
            },
            ay: {
                n: [ "Aymara" ],
                a3: "aym"
            },
            az: {
                n: [ "Azerbaijani" ],
                a3: "aze"
            },
            ba: {
                n: [ "Bashkir" ],
                a3: "bak"
            },
            bm: {
                n: [ "Bambara" ],
                a3: "bam"
            },
            eu: {
                n: [ "Basque" ],
                a3: "baq"
            },
            be: {
                n: [ "Belarusian" ],
                a3: "bel"
            },
            bn: {
                n: [ "Bengali" ],
                a3: "ben"
            },
            bh: {
                n: [ "Bihari languages" ],
                a3: "bih"
            },
            bi: {
                n: [ "Bislama" ],
                a3: "bis"
            },
            bs: {
                n: [ "Bosnian" ],
                a3: "bos"
            },
            br: {
                n: [ "Breton" ],
                a3: "bre"
            },
            bg: {
                n: [ "Bulgarian" ],
                a3: "bul"
            },
            my: {
                n: [ "Burmese" ],
                a3: "bur"
            },
            ca: {
                n: [ "Catalan", "Valencian" ],
                a3: "cat"
            },
            ch: {
                n: [ "Chamorro" ],
                a3: "cha"
            },
            ce: {
                n: [ "Chechen" ],
                a3: "che"
            },
            zh: {
                n: [ "Chinese" ],
                a3: "chi"
            },
            cu: {
                n: [ "Church Slavic", "Old Slavonic", "Church Slavonic", "Old Bulgarian", "Old Church Slavonic" ],
                a3: "chu"
            },
            cv: {
                n: [ "Chuvash" ],
                a3: "chv"
            },
            kw: {
                n: [ "Cornish" ],
                a3: "cor"
            },
            co: {
                n: [ "Corsican" ],
                a3: "cos"
            },
            cr: {
                n: [ "Cree" ],
                a3: "cre"
            },
            cs: {
                n: [ "Czech" ],
                a3: "cze"
            },
            da: {
                n: [ "Danish" ],
                a3: "dan"
            },
            dv: {
                n: [ "Divehi", "Dhivehi", "Maldivian" ],
                a3: "div"
            },
            nl: {
                n: [ "Dutch", "Flemish" ],
                a3: "dut"
            },
            dz: {
                n: [ "Dzongkha" ],
                a3: "dzo"
            },
            en: {
                n: [ "English", "Englisch", "Inglese", "Anglais" ],
                a3: "eng"
            },
            eo: {
                n: [ "Esperanto" ],
                a3: "epo"
            },
            et: {
                n: [ "Estonian" ],
                a3: "est"
            },
            ee: {
                n: [ "Ewe" ],
                a3: "ewe"
            },
            fo: {
                n: [ "Faroese" ],
                a3: "fao"
            },
            fj: {
                n: [ "Fijian" ],
                a3: "fij"
            },
            fi: {
                n: [ "Finnish" ],
                a3: "fin"
            },
            fr: {
                n: [ "French", "Fran\xe7ais" ],
                a3: "fre"
            },
            fy: {
                n: [ "Western Frisian" ],
                a3: "fry"
            },
            ff: {
                n: [ "Fulah" ],
                a3: "ful"
            },
            ka: {
                n: [ "Georgian" ],
                a3: "geo"
            },
            de: {
                n: [ "German" ],
                a3: [ "ger", "deu" ]
            },
            gd: {
                n: [ "Gaelic", "Scottish Gaelic" ],
                a3: "gla"
            },
            ga: {
                n: [ "Irish" ],
                a3: "gle"
            },
            gl: {
                n: [ "Galician" ],
                a3: "glg"
            },
            gv: {
                n: [ "Manx" ],
                a3: "glv"
            },
            el: {
                n: [ "Greek" ],
                a3: "gre"
            },
            gn: {
                n: [ "Guarani" ],
                a3: "grn"
            },
            gu: {
                n: [ "Gujarati" ],
                a3: "guj"
            },
            ht: {
                n: [ "Haitian", "Haitian Creole" ],
                a3: "hat"
            },
            ha: {
                n: [ "Hausa" ],
                a3: "hau"
            },
            he: {
                n: [ "Hebrew" ],
                a3: "heb"
            },
            hz: {
                n: [ "Herero" ],
                a3: "her"
            },
            hi: {
                n: [ "Hindi" ],
                a3: "hin"
            },
            ho: {
                n: [ "Hiri Motu" ],
                a3: "hmo"
            },
            hr: {
                n: [ "Croatian" ],
                a3: "hrv"
            },
            hu: {
                n: [ "Hungarian" ],
                a3: "hun"
            },
            ig: {
                n: [ "Igbo" ],
                a3: "ibo"
            },
            is: {
                n: [ "Icelandic" ],
                a3: "ice"
            },
            io: {
                n: [ "Ido" ],
                a3: "ido"
            },
            ii: {
                n: [ "Sichuan Yi", "Nuosu" ],
                a3: "iii"
            },
            iu: {
                n: [ "Inuktitut" ],
                a3: "iku"
            },
            ie: {
                n: [ "Interlingue", "Occidental" ],
                a3: "ile"
            },
            id: {
                n: [ "Indonesian" ],
                a3: "ind"
            },
            ik: {
                n: [ "Inupiaq" ],
                a3: "ipk"
            },
            it: {
                n: [ "Italian", "Italiano" ],
                a3: "ita"
            },
            jv: {
                n: [ "Javanese" ],
                a3: "jav"
            },
            ja: {
                n: [ "Japanese" ],
                a3: "jpn"
            },
            kl: {
                n: [ "Kalaallisut", "Greenlandic" ],
                a3: "kal"
            },
            kn: {
                n: [ "Kannada" ],
                a3: "kan"
            },
            ks: {
                n: [ "Kashmiri" ],
                a3: "kas"
            },
            kr: {
                n: [ "Kanuri" ],
                a3: "kau"
            },
            kk: {
                n: [ "Kazakh" ],
                a3: "kaz"
            },
            km: {
                n: [ "Central Khmer" ],
                a3: "khm"
            },
            ki: {
                n: [ "Kikuyu", "Gikuyu" ],
                a3: "kik"
            },
            rw: {
                n: [ "Kinyarwanda" ],
                a3: "kin"
            },
            ky: {
                n: [ "Kirghiz", "Kyrgyz" ],
                a3: "kir"
            },
            kv: {
                n: [ "Komi" ],
                a3: "kom"
            },
            kg: {
                n: [ "Kongo" ],
                a3: "kon"
            },
            ko: {
                n: [ "Korean" ],
                a3: "kor"
            },
            kj: {
                n: [ "Kuanyama", "Kwanyama" ],
                a3: "kua"
            },
            ku: {
                n: [ "Kurdish" ],
                a3: "kur"
            },
            lo: {
                n: [ "Lao" ],
                a3: "lao"
            },
            la: {
                n: [ "Latin" ],
                a3: "lat"
            },
            lv: {
                n: [ "Latvian" ],
                a3: "lav"
            },
            li: {
                n: [ "Limburgan", "Limburger", "Limburgish" ],
                a3: "lim"
            },
            ln: {
                n: [ "Lingala" ],
                a3: "lin"
            },
            lt: {
                n: [ "Lithuanian" ],
                a3: "lit"
            },
            lb: {
                n: [ "Luxembourgish", "Letzeburgesch" ],
                a3: "ltz"
            },
            lu: {
                n: [ "Luba-Katanga" ],
                a3: "lub"
            },
            lg: {
                n: [ "Ganda" ],
                a3: "lug"
            },
            mk: {
                n: [ "Macedonian" ],
                a3: "mac"
            },
            mh: {
                n: [ "Marshallese" ],
                a3: "mah"
            },
            ml: {
                n: [ "Malayalam" ],
                a3: "mal"
            },
            mi: {
                n: [ "Maori" ],
                a3: "mao"
            },
            mr: {
                n: [ "Marathi" ],
                a3: "mar"
            },
            ms: {
                n: [ "Malay" ],
                a3: "may"
            },
            mg: {
                n: [ "Malagasy" ],
                a3: "mlg"
            },
            mt: {
                n: [ "Maltese" ],
                a3: "mlt"
            },
            mn: {
                n: [ "Mongolian" ],
                a3: "mon"
            },
            na: {
                n: [ "Nauru" ],
                a3: "nau"
            },
            nv: {
                n: [ "Navajo", "Navaho" ],
                a3: "nav"
            },
            nr: {
                n: [ "Ndebele, South", "South Ndebele" ],
                a3: "nbl"
            },
            nd: {
                n: [ "Ndebele, North", "North Ndebele" ],
                a3: "nde"
            },
            ng: {
                n: [ "Ndonga" ],
                a3: "ndo"
            },
            ne: {
                n: [ "Nepali" ],
                a3: "nep"
            },
            nn: {
                n: [ "Norwegian Nynorsk", "Nynorsk, Norwegian" ],
                a3: "nno"
            },
            nb: {
                n: [ "Bokm\xe5l, Norwegian", "Norwegian Bokm\xe5l" ],
                a3: "nob"
            },
            no: {
                n: [ "Norwegian" ],
                a3: "nor"
            },
            ny: {
                n: [ "Chichewa", "Chewa", "Nyanja" ],
                a3: "nya"
            },
            oc: {
                n: [ "Occitan", "Proven\xe7al" ],
                a3: "oci"
            },
            oj: {
                n: [ "Ojibwa" ],
                a3: "oji"
            },
            or: {
                n: [ "Oriya" ],
                a3: "ori"
            },
            om: {
                n: [ "Oromo" ],
                a3: "orm"
            },
            os: {
                n: [ "Ossetian", "Ossetic" ],
                a3: "oss"
            },
            pa: {
                n: [ "Panjabi", "Punjabi" ],
                a3: "pan"
            },
            fa: {
                n: [ "Persian" ],
                a3: "per"
            },
            pi: {
                n: [ "Pali" ],
                a3: "pli"
            },
            pl: {
                n: [ "Polish" ],
                a3: "pol"
            },
            pt: {
                n: [ "Portuguese" ],
                a3: "por"
            },
            ps: {
                n: [ "Pushto", "Pashto" ],
                a3: "pus"
            },
            qu: {
                n: [ "Quechua" ],
                a3: "que"
            },
            rm: {
                n: [ "Romansh" ],
                a3: "roh"
            },
            ro: {
                n: [ "Romanian", "Moldavian", "Moldovan" ],
                a3: "rum"
            },
            rn: {
                n: [ "Rundi" ],
                a3: "run"
            },
            ru: {
                n: [ "Russian" ],
                a3: "rus"
            },
            sg: {
                n: [ "Sango" ],
                a3: "sag"
            },
            sa: {
                n: [ "Sanskrit" ],
                a3: "san"
            },
            si: {
                n: [ "Sinhala", "Sinhalese" ],
                a3: "sin"
            },
            sk: {
                n: [ "Slovak" ],
                a3: "slo"
            },
            sl: {
                n: [ "Slovenian" ],
                a3: "slv"
            },
            se: {
                n: [ "Northern Sami" ],
                a3: "sme"
            },
            sm: {
                n: [ "Samoan" ],
                a3: "smo"
            },
            sn: {
                n: [ "Shona" ],
                a3: "sna"
            },
            sd: {
                n: [ "Sindhi" ],
                a3: "snd"
            },
            so: {
                n: [ "Somali" ],
                a3: "som"
            },
            st: {
                n: [ "Sotho, Southern" ],
                a3: "sot"
            },
            es: {
                n: [ "Spanish", "Castilian" ],
                a3: "spa"
            },
            sc: {
                n: [ "Sardinian" ],
                a3: "srd"
            },
            sr: {
                n: [ "Serbian" ],
                a3: "srp"
            },
            ss: {
                n: [ "Swati" ],
                a3: "ssw"
            },
            su: {
                n: [ "Sundanese" ],
                a3: "sun"
            },
            sw: {
                n: [ "Swahili" ],
                a3: "swa"
            },
            sv: {
                n: [ "Swedish" ],
                a3: "swe"
            },
            ty: {
                n: [ "Tahitian" ],
                a3: "tah"
            },
            ta: {
                n: [ "Tamil" ],
                a3: "tam"
            },
            tt: {
                n: [ "Tatar" ],
                a3: "tat"
            },
            te: {
                n: [ "Telugu" ],
                a3: "tel"
            },
            tg: {
                n: [ "Tajik" ],
                a3: "tgk"
            },
            tl: {
                n: [ "Tagalog" ],
                a3: "tgl"
            },
            th: {
                n: [ "Thai" ],
                a3: "tha"
            },
            bo: {
                n: [ "Tibetan" ],
                a3: "tib"
            },
            ti: {
                n: [ "Tigrinya" ],
                a3: "tir"
            },
            to: {
                n: [ "Tonga" ],
                a3: "ton"
            },
            tn: {
                n: [ "Tswana" ],
                a3: "tsn"
            },
            ts: {
                n: [ "Tsonga" ],
                a3: "tso"
            },
            tk: {
                n: [ "Turkmen" ],
                a3: "tuk"
            },
            tr: {
                n: [ "Turkish" ],
                a3: "tur"
            },
            tw: {
                n: [ "Twi" ],
                a3: "twi"
            },
            ug: {
                n: [ "Uighur", "Uyghur" ],
                a3: "uig"
            },
            uk: {
                n: [ "Ukrainian" ],
                a3: "ukr"
            },
            ur: {
                n: [ "Urdu" ],
                a3: "urd"
            },
            uz: {
                n: [ "Uzbek" ],
                a3: "uzb"
            },
            ve: {
                n: [ "Venda" ],
                a3: "ven"
            },
            vi: {
                n: [ "Vietnamese" ],
                a3: "vie"
            },
            vo: {
                n: [ "Volap\xfck" ],
                a3: "vol"
            },
            cy: {
                n: [ "Welsh" ],
                a3: "wel"
            },
            wa: {
                n: [ "Walloon" ],
                a3: "wln"
            },
            wo: {
                n: [ "Wolof" ],
                a3: "wol"
            },
            xh: {
                n: [ "Xhosa" ],
                a3: "xho"
            },
            yi: {
                n: [ "Yiddish" ],
                a3: "yid"
            },
            yo: {
                n: [ "Yoruba" ],
                a3: "yor"
            },
            za: {
                n: [ "Zhuang", "Chuang" ],
                a3: "zha"
            },
            zu: {
                n: [ "Zulu" ],
                a3: "zul"
            }
        },
        diacriticsMap: {
            A: "A",
            "\u24b6": "A",
            "\uff21": "A",
            "\xc0": "A",
            "\xc1": "A",
            "\xc2": "A",
            "\u1ea6": "A",
            "\u1ea4": "A",
            "\u1eaa": "A",
            "\u1ea8": "A",
            "\xc3": "A",
            "\u0100": "A",
            "\u0102": "A",
            "\u1eb0": "A",
            "\u1eae": "A",
            "\u1eb4": "A",
            "\u1eb2": "A",
            "\u0226": "A",
            "\u01e0": "A",
            "\xc4": "A",
            "\u01de": "A",
            "\u1ea2": "A",
            "\xc5": "A",
            "\u01fa": "A",
            "\u01cd": "A",
            "\u0200": "A",
            "\u0202": "A",
            "\u1ea0": "A",
            "\u1eac": "A",
            "\u1eb6": "A",
            "\u1e00": "A",
            "\u0104": "A",
            "\u023a": "A",
            "\u2c6f": "A",
            "\ua732": "AA",
            "\xc6": "AE",
            "\u01fc": "AE",
            "\u01e2": "AE",
            "\ua734": "AO",
            "\ua736": "AU",
            "\ua738": "AV",
            "\ua73a": "AV",
            "\ua73c": "AY",
            B: "B",
            "\u24b7": "B",
            "\uff22": "B",
            "\u1e02": "B",
            "\u1e04": "B",
            "\u1e06": "B",
            "\u0243": "B",
            "\u0182": "B",
            "\u0181": "B",
            C: "C",
            "\u24b8": "C",
            "\uff23": "C",
            "\u0106": "C",
            "\u0108": "C",
            "\u010a": "C",
            "\u010c": "C",
            "\xc7": "C",
            "\u1e08": "C",
            "\u0187": "C",
            "\u023b": "C",
            "\ua73e": "C",
            D: "D",
            "\u24b9": "D",
            "\uff24": "D",
            "\u1e0a": "D",
            "\u010e": "D",
            "\u1e0c": "D",
            "\u1e10": "D",
            "\u1e12": "D",
            "\u1e0e": "D",
            "\u0110": "D",
            "\u018b": "D",
            "\u018a": "D",
            "\u0189": "D",
            "\ua779": "D",
            "\u01f1": "DZ",
            "\u01c4": "DZ",
            "\u01f2": "Dz",
            "\u01c5": "Dz",
            E: "E",
            "\u24ba": "E",
            "\uff25": "E",
            "\xc8": "E",
            "\xc9": "E",
            "\xca": "E",
            "\u1ec0": "E",
            "\u1ebe": "E",
            "\u1ec4": "E",
            "\u1ec2": "E",
            "\u1ebc": "E",
            "\u0112": "E",
            "\u1e14": "E",
            "\u1e16": "E",
            "\u0114": "E",
            "\u0116": "E",
            "\xcb": "E",
            "\u1eba": "E",
            "\u011a": "E",
            "\u0204": "E",
            "\u0206": "E",
            "\u1eb8": "E",
            "\u1ec6": "E",
            "\u0228": "E",
            "\u1e1c": "E",
            "\u0118": "E",
            "\u1e18": "E",
            "\u1e1a": "E",
            "\u0190": "E",
            "\u018e": "E",
            F: "F",
            "\u24bb": "F",
            "\uff26": "F",
            "\u1e1e": "F",
            "\u0191": "F",
            "\ua77b": "F",
            G: "G",
            "\u24bc": "G",
            "\uff27": "G",
            "\u01f4": "G",
            "\u011c": "G",
            "\u1e20": "G",
            "\u011e": "G",
            "\u0120": "G",
            "\u01e6": "G",
            "\u0122": "G",
            "\u01e4": "G",
            "\u0193": "G",
            "\ua7a0": "G",
            "\ua77d": "G",
            "\ua77e": "G",
            H: "H",
            "\u24bd": "H",
            "\uff28": "H",
            "\u0124": "H",
            "\u1e22": "H",
            "\u1e26": "H",
            "\u021e": "H",
            "\u1e24": "H",
            "\u1e28": "H",
            "\u1e2a": "H",
            "\u0126": "H",
            "\u2c67": "H",
            "\u2c75": "H",
            "\ua78d": "H",
            I: "I",
            "\u24be": "I",
            "\uff29": "I",
            "\xcc": "I",
            "\xcd": "I",
            "\xce": "I",
            "\u0128": "I",
            "\u012a": "I",
            "\u012c": "I",
            "\u0130": "I",
            "\xcf": "I",
            "\u1e2e": "I",
            "\u1ec8": "I",
            "\u01cf": "I",
            "\u0208": "I",
            "\u020a": "I",
            "\u1eca": "I",
            "\u012e": "I",
            "\u1e2c": "I",
            "\u0197": "I",
            J: "J",
            "\u24bf": "J",
            "\uff2a": "J",
            "\u0134": "J",
            "\u0248": "J",
            K: "K",
            "\u24c0": "K",
            "\uff2b": "K",
            "\u1e30": "K",
            "\u01e8": "K",
            "\u1e32": "K",
            "\u0136": "K",
            "\u1e34": "K",
            "\u0198": "K",
            "\u2c69": "K",
            "\ua740": "K",
            "\ua742": "K",
            "\ua744": "K",
            "\ua7a2": "K",
            L: "L",
            "\u24c1": "L",
            "\uff2c": "L",
            "\u013f": "L",
            "\u0139": "L",
            "\u013d": "L",
            "\u1e36": "L",
            "\u1e38": "L",
            "\u013b": "L",
            "\u1e3c": "L",
            "\u1e3a": "L",
            "\u0141": "L",
            "\u023d": "L",
            "\u2c62": "L",
            "\u2c60": "L",
            "\ua748": "L",
            "\ua746": "L",
            "\ua780": "L",
            "\u01c7": "LJ",
            "\u01c8": "Lj",
            M: "M",
            "\u24c2": "M",
            "\uff2d": "M",
            "\u1e3e": "M",
            "\u1e40": "M",
            "\u1e42": "M",
            "\u2c6e": "M",
            "\u019c": "M",
            N: "N",
            "\u24c3": "N",
            "\uff2e": "N",
            "\u01f8": "N",
            "\u0143": "N",
            "\xd1": "N",
            "\u1e44": "N",
            "\u0147": "N",
            "\u1e46": "N",
            "\u0145": "N",
            "\u1e4a": "N",
            "\u1e48": "N",
            "\u0220": "N",
            "\u019d": "N",
            "\ua790": "N",
            "\ua7a4": "N",
            "\u01ca": "NJ",
            "\u01cb": "Nj",
            O: "O",
            "\u24c4": "O",
            "\uff2f": "O",
            "\xd2": "O",
            "\xd3": "O",
            "\xd4": "O",
            "\u1ed2": "O",
            "\u1ed0": "O",
            "\u1ed6": "O",
            "\u1ed4": "O",
            "\xd5": "O",
            "\u1e4c": "O",
            "\u022c": "O",
            "\u1e4e": "O",
            "\u014c": "O",
            "\u1e50": "O",
            "\u1e52": "O",
            "\u014e": "O",
            "\u022e": "O",
            "\u0230": "O",
            "\xd6": "O",
            "\u022a": "O",
            "\u1ece": "O",
            "\u0150": "O",
            "\u01d1": "O",
            "\u020c": "O",
            "\u020e": "O",
            "\u01a0": "O",
            "\u1edc": "O",
            "\u1eda": "O",
            "\u1ee0": "O",
            "\u1ede": "O",
            "\u1ee2": "O",
            "\u1ecc": "O",
            "\u1ed8": "O",
            "\u01ea": "O",
            "\u01ec": "O",
            "\xd8": "O",
            "\u01fe": "O",
            "\u0186": "O",
            "\u019f": "O",
            "\ua74a": "O",
            "\ua74c": "O",
            "\u01a2": "OI",
            "\ua74e": "OO",
            "\u0222": "OU",
            P: "P",
            "\u24c5": "P",
            "\uff30": "P",
            "\u1e54": "P",
            "\u1e56": "P",
            "\u01a4": "P",
            "\u2c63": "P",
            "\ua750": "P",
            "\ua752": "P",
            "\ua754": "P",
            Q: "Q",
            "\u24c6": "Q",
            "\uff31": "Q",
            "\ua756": "Q",
            "\ua758": "Q",
            "\u024a": "Q",
            R: "R",
            "\u24c7": "R",
            "\uff32": "R",
            "\u0154": "R",
            "\u1e58": "R",
            "\u0158": "R",
            "\u0210": "R",
            "\u0212": "R",
            "\u1e5a": "R",
            "\u1e5c": "R",
            "\u0156": "R",
            "\u1e5e": "R",
            "\u024c": "R",
            "\u2c64": "R",
            "\ua75a": "R",
            "\ua7a6": "R",
            "\ua782": "R",
            S: "S",
            "\u24c8": "S",
            "\uff33": "S",
            "\u1e9e": "S",
            "\u015a": "S",
            "\u1e64": "S",
            "\u015c": "S",
            "\u1e60": "S",
            "\u0160": "S",
            "\u1e66": "S",
            "\u1e62": "S",
            "\u1e68": "S",
            "\u0218": "S",
            "\u015e": "S",
            "\u2c7e": "S",
            "\ua7a8": "S",
            "\ua784": "S",
            T: "T",
            "\u24c9": "T",
            "\uff34": "T",
            "\u1e6a": "T",
            "\u0164": "T",
            "\u1e6c": "T",
            "\u021a": "T",
            "\u0162": "T",
            "\u1e70": "T",
            "\u1e6e": "T",
            "\u0166": "T",
            "\u01ac": "T",
            "\u01ae": "T",
            "\u023e": "T",
            "\ua786": "T",
            "\ua728": "TZ",
            U: "U",
            "\u24ca": "U",
            "\uff35": "U",
            "\xd9": "U",
            "\xda": "U",
            "\xdb": "U",
            "\u0168": "U",
            "\u1e78": "U",
            "\u016a": "U",
            "\u1e7a": "U",
            "\u016c": "U",
            "\xdc": "U",
            "\u01db": "U",
            "\u01d7": "U",
            "\u01d5": "U",
            "\u01d9": "U",
            "\u1ee6": "U",
            "\u016e": "U",
            "\u0170": "U",
            "\u01d3": "U",
            "\u0214": "U",
            "\u0216": "U",
            "\u01af": "U",
            "\u1eea": "U",
            "\u1ee8": "U",
            "\u1eee": "U",
            "\u1eec": "U",
            "\u1ef0": "U",
            "\u1ee4": "U",
            "\u1e72": "U",
            "\u0172": "U",
            "\u1e76": "U",
            "\u1e74": "U",
            "\u0244": "U",
            V: "V",
            "\u24cb": "V",
            "\uff36": "V",
            "\u1e7c": "V",
            "\u1e7e": "V",
            "\u01b2": "V",
            "\ua75e": "V",
            "\u0245": "V",
            "\ua760": "VY",
            W: "W",
            "\u24cc": "W",
            "\uff37": "W",
            "\u1e80": "W",
            "\u1e82": "W",
            "\u0174": "W",
            "\u1e86": "W",
            "\u1e84": "W",
            "\u1e88": "W",
            "\u2c72": "W",
            X: "X",
            "\u24cd": "X",
            "\uff38": "X",
            "\u1e8a": "X",
            "\u1e8c": "X",
            Y: "Y",
            "\u24ce": "Y",
            "\uff39": "Y",
            "\u1ef2": "Y",
            "\xdd": "Y",
            "\u0176": "Y",
            "\u1ef8": "Y",
            "\u0232": "Y",
            "\u1e8e": "Y",
            "\u0178": "Y",
            "\u1ef6": "Y",
            "\u1ef4": "Y",
            "\u01b3": "Y",
            "\u024e": "Y",
            "\u1efe": "Y",
            Z: "Z",
            "\u24cf": "Z",
            "\uff3a": "Z",
            "\u0179": "Z",
            "\u1e90": "Z",
            "\u017b": "Z",
            "\u017d": "Z",
            "\u1e92": "Z",
            "\u1e94": "Z",
            "\u01b5": "Z",
            "\u0224": "Z",
            "\u2c7f": "Z",
            "\u2c6b": "Z",
            "\ua762": "Z",
            a: "a",
            "\u24d0": "a",
            "\uff41": "a",
            "\u1e9a": "a",
            "\xe0": "a",
            "\xe1": "a",
            "\xe2": "a",
            "\u1ea7": "a",
            "\u1ea5": "a",
            "\u1eab": "a",
            "\u1ea9": "a",
            "\xe3": "a",
            "\u0101": "a",
            "\u0103": "a",
            "\u1eb1": "a",
            "\u1eaf": "a",
            "\u1eb5": "a",
            "\u1eb3": "a",
            "\u0227": "a",
            "\u01e1": "a",
            "\xe4": "a",
            "\u01df": "a",
            "\u1ea3": "a",
            "\xe5": "a",
            "\u01fb": "a",
            "\u01ce": "a",
            "\u0201": "a",
            "\u0203": "a",
            "\u1ea1": "a",
            "\u1ead": "a",
            "\u1eb7": "a",
            "\u1e01": "a",
            "\u0105": "a",
            "\u2c65": "a",
            "\u0250": "a",
            "\ua733": "aa",
            "\xe6": "ae",
            "\u01fd": "ae",
            "\u01e3": "ae",
            "\ua735": "ao",
            "\ua737": "au",
            "\ua739": "av",
            "\ua73b": "av",
            "\ua73d": "ay",
            b: "b",
            "\u24d1": "b",
            "\uff42": "b",
            "\u1e03": "b",
            "\u1e05": "b",
            "\u1e07": "b",
            "\u0180": "b",
            "\u0183": "b",
            "\u0253": "b",
            c: "c",
            "\u24d2": "c",
            "\uff43": "c",
            "\u0107": "c",
            "\u0109": "c",
            "\u010b": "c",
            "\u010d": "c",
            "\xe7": "c",
            "\u1e09": "c",
            "\u0188": "c",
            "\u023c": "c",
            "\ua73f": "c",
            "\u2184": "c",
            d: "d",
            "\u24d3": "d",
            "\uff44": "d",
            "\u1e0b": "d",
            "\u010f": "d",
            "\u1e0d": "d",
            "\u1e11": "d",
            "\u1e13": "d",
            "\u1e0f": "d",
            "\u0111": "d",
            "\u018c": "d",
            "\u0256": "d",
            "\u0257": "d",
            "\ua77a": "d",
            "\u01f3": "dz",
            "\u01c6": "dz",
            e: "e",
            "\u24d4": "e",
            "\uff45": "e",
            "\xe8": "e",
            "\xe9": "e",
            "\xea": "e",
            "\u1ec1": "e",
            "\u1ebf": "e",
            "\u1ec5": "e",
            "\u1ec3": "e",
            "\u1ebd": "e",
            "\u0113": "e",
            "\u1e15": "e",
            "\u1e17": "e",
            "\u0115": "e",
            "\u0117": "e",
            "\xeb": "e",
            "\u1ebb": "e",
            "\u011b": "e",
            "\u0205": "e",
            "\u0207": "e",
            "\u1eb9": "e",
            "\u1ec7": "e",
            "\u0229": "e",
            "\u1e1d": "e",
            "\u0119": "e",
            "\u1e19": "e",
            "\u1e1b": "e",
            "\u0247": "e",
            "\u025b": "e",
            "\u01dd": "e",
            f: "f",
            "\u24d5": "f",
            "\uff46": "f",
            "\u1e1f": "f",
            "\u0192": "f",
            "\ua77c": "f",
            g: "g",
            "\u24d6": "g",
            "\uff47": "g",
            "\u01f5": "g",
            "\u011d": "g",
            "\u1e21": "g",
            "\u011f": "g",
            "\u0121": "g",
            "\u01e7": "g",
            "\u0123": "g",
            "\u01e5": "g",
            "\u0260": "g",
            "\ua7a1": "g",
            "\u1d79": "g",
            "\ua77f": "g",
            h: "h",
            "\u24d7": "h",
            "\uff48": "h",
            "\u0125": "h",
            "\u1e23": "h",
            "\u1e27": "h",
            "\u021f": "h",
            "\u1e25": "h",
            "\u1e29": "h",
            "\u1e2b": "h",
            "\u1e96": "h",
            "\u0127": "h",
            "\u2c68": "h",
            "\u2c76": "h",
            "\u0265": "h",
            "\u0195": "hv",
            i: "i",
            "\u24d8": "i",
            "\uff49": "i",
            "\xec": "i",
            "\xed": "i",
            "\xee": "i",
            "\u0129": "i",
            "\u012b": "i",
            "\u012d": "i",
            "\xef": "i",
            "\u1e2f": "i",
            "\u1ec9": "i",
            "\u01d0": "i",
            "\u0209": "i",
            "\u020b": "i",
            "\u1ecb": "i",
            "\u012f": "i",
            "\u1e2d": "i",
            "\u0268": "i",
            "\u0131": "i",
            j: "j",
            "\u24d9": "j",
            "\uff4a": "j",
            "\u0135": "j",
            "\u01f0": "j",
            "\u0249": "j",
            k: "k",
            "\u24da": "k",
            "\uff4b": "k",
            "\u1e31": "k",
            "\u01e9": "k",
            "\u1e33": "k",
            "\u0137": "k",
            "\u1e35": "k",
            "\u0199": "k",
            "\u2c6a": "k",
            "\ua741": "k",
            "\ua743": "k",
            "\ua745": "k",
            "\ua7a3": "k",
            l: "l",
            "\u24db": "l",
            "\uff4c": "l",
            "\u0140": "l",
            "\u013a": "l",
            "\u013e": "l",
            "\u1e37": "l",
            "\u1e39": "l",
            "\u013c": "l",
            "\u1e3d": "l",
            "\u1e3b": "l",
            "\u017f": "l",
            "\u0142": "l",
            "\u019a": "l",
            "\u026b": "l",
            "\u2c61": "l",
            "\ua749": "l",
            "\ua781": "l",
            "\ua747": "l",
            "\u01c9": "lj",
            m: "m",
            "\u24dc": "m",
            "\uff4d": "m",
            "\u1e3f": "m",
            "\u1e41": "m",
            "\u1e43": "m",
            "\u0271": "m",
            "\u026f": "m",
            n: "n",
            "\u24dd": "n",
            "\uff4e": "n",
            "\u01f9": "n",
            "\u0144": "n",
            "\xf1": "n",
            "\u1e45": "n",
            "\u0148": "n",
            "\u1e47": "n",
            "\u0146": "n",
            "\u1e4b": "n",
            "\u1e49": "n",
            "\u019e": "n",
            "\u0272": "n",
            "\u0149": "n",
            "\ua791": "n",
            "\ua7a5": "n",
            "\u01cc": "nj",
            o: "o",
            "\u24de": "o",
            "\uff4f": "o",
            "\xf2": "o",
            "\xf3": "o",
            "\xf4": "o",
            "\u1ed3": "o",
            "\u1ed1": "o",
            "\u1ed7": "o",
            "\u1ed5": "o",
            "\xf5": "o",
            "\u1e4d": "o",
            "\u022d": "o",
            "\u1e4f": "o",
            "\u014d": "o",
            "\u1e51": "o",
            "\u1e53": "o",
            "\u014f": "o",
            "\u022f": "o",
            "\u0231": "o",
            "\xf6": "o",
            "\u022b": "o",
            "\u1ecf": "o",
            "\u0151": "o",
            "\u01d2": "o",
            "\u020d": "o",
            "\u020f": "o",
            "\u01a1": "o",
            "\u1edd": "o",
            "\u1edb": "o",
            "\u1ee1": "o",
            "\u1edf": "o",
            "\u1ee3": "o",
            "\u1ecd": "o",
            "\u1ed9": "o",
            "\u01eb": "o",
            "\u01ed": "o",
            "\xf8": "o",
            "\u01ff": "o",
            "\u0254": "o",
            "\ua74b": "o",
            "\ua74d": "o",
            "\u0275": "o",
            "\u01a3": "oi",
            "\u0223": "ou",
            "\ua74f": "oo",
            p: "p",
            "\u24df": "p",
            "\uff50": "p",
            "\u1e55": "p",
            "\u1e57": "p",
            "\u01a5": "p",
            "\u1d7d": "p",
            "\ua751": "p",
            "\ua753": "p",
            "\ua755": "p",
            q: "q",
            "\u24e0": "q",
            "\uff51": "q",
            "\u024b": "q",
            "\ua757": "q",
            "\ua759": "q",
            r: "r",
            "\u24e1": "r",
            "\uff52": "r",
            "\u0155": "r",
            "\u1e59": "r",
            "\u0159": "r",
            "\u0211": "r",
            "\u0213": "r",
            "\u1e5b": "r",
            "\u1e5d": "r",
            "\u0157": "r",
            "\u1e5f": "r",
            "\u024d": "r",
            "\u027d": "r",
            "\ua75b": "r",
            "\ua7a7": "r",
            "\ua783": "r",
            s: "s",
            "\u24e2": "s",
            "\uff53": "s",
            "\xdf": "s",
            "\u015b": "s",
            "\u1e65": "s",
            "\u015d": "s",
            "\u1e61": "s",
            "\u0161": "s",
            "\u1e67": "s",
            "\u1e63": "s",
            "\u1e69": "s",
            "\u0219": "s",
            "\u015f": "s",
            "\u023f": "s",
            "\ua7a9": "s",
            "\ua785": "s",
            "\u1e9b": "s",
            t: "t",
            "\u24e3": "t",
            "\uff54": "t",
            "\u1e6b": "t",
            "\u1e97": "t",
            "\u0165": "t",
            "\u1e6d": "t",
            "\u021b": "t",
            "\u0163": "t",
            "\u1e71": "t",
            "\u1e6f": "t",
            "\u0167": "t",
            "\u01ad": "t",
            "\u0288": "t",
            "\u2c66": "t",
            "\ua787": "t",
            "\ua729": "tz",
            u: "u",
            "\u24e4": "u",
            "\uff55": "u",
            "\xf9": "u",
            "\xfa": "u",
            "\xfb": "u",
            "\u0169": "u",
            "\u1e79": "u",
            "\u016b": "u",
            "\u1e7b": "u",
            "\u016d": "u",
            "\xfc": "u",
            "\u01dc": "u",
            "\u01d8": "u",
            "\u01d6": "u",
            "\u01da": "u",
            "\u1ee7": "u",
            "\u016f": "u",
            "\u0171": "u",
            "\u01d4": "u",
            "\u0215": "u",
            "\u0217": "u",
            "\u01b0": "u",
            "\u1eeb": "u",
            "\u1ee9": "u",
            "\u1eef": "u",
            "\u1eed": "u",
            "\u1ef1": "u",
            "\u1ee5": "u",
            "\u1e73": "u",
            "\u0173": "u",
            "\u1e77": "u",
            "\u1e75": "u",
            "\u0289": "u",
            v: "v",
            "\u24e5": "v",
            "\uff56": "v",
            "\u1e7d": "v",
            "\u1e7f": "v",
            "\u028b": "v",
            "\ua75f": "v",
            "\u028c": "v",
            "\ua761": "vy",
            w: "w",
            "\u24e6": "w",
            "\uff57": "w",
            "\u1e81": "w",
            "\u1e83": "w",
            "\u0175": "w",
            "\u1e87": "w",
            "\u1e85": "w",
            "\u1e98": "w",
            "\u1e89": "w",
            "\u2c73": "w",
            x: "x",
            "\u24e7": "x",
            "\uff58": "x",
            "\u1e8b": "x",
            "\u1e8d": "x",
            y: "y",
            "\u24e8": "y",
            "\uff59": "y",
            "\u1ef3": "y",
            "\xfd": "y",
            "\u0177": "y",
            "\u1ef9": "y",
            "\u0233": "y",
            "\u1e8f": "y",
            "\xff": "y",
            "\u1ef7": "y",
            "\u1e99": "y",
            "\u1ef5": "y",
            "\u01b4": "y",
            "\u024f": "y",
            "\u1eff": "y",
            z: "z",
            "\u24e9": "z",
            "\uff5a": "z",
            "\u017a": "z",
            "\u1e91": "z",
            "\u017c": "z",
            "\u017e": "z",
            "\u1e93": "z",
            "\u1e95": "z",
            "\u01b6": "z",
            "\u0225": "z",
            "\u0240": "z",
            "\u2c6c": "z",
            "\ua763": "z"
        },
        stopwords: {
            about: 1,
            again: 1,
            all: 1,
            almost: 1,
            also: 1,
            although: 1,
            always: 1,
            among: 1,
            and: 1,
            another: 1,
            any: 1,
            are: 1,
            because: 1,
            been: 1,
            before: 1,
            being: 1,
            between: 1,
            both: 1,
            but: 1,
            can: 1,
            could: 1,
            did: 1,
            does: 1,
            done: 1,
            due: 1,
            during: 1,
            each: 1,
            either: 1,
            enough: 1,
            especially: 1,
            etc: 1,
            for: 1,
            found: 1,
            from: 1,
            further: 1,
            had: 1,
            has: 1,
            have: 1,
            having: 1,
            here: 1,
            how: 1,
            however: 1,
            into: 1,
            its: 1,
            itself: 1,
            just: 1,
            made: 1,
            mainly: 1,
            make: 1,
            may: 1,
            might: 1,
            most: 1,
            mostly: 1,
            must: 1,
            nearly: 1,
            neither: 1,
            nor: 1,
            not: 1,
            obtained: 1,
            often: 1,
            our: 1,
            overall: 1,
            perhaps: 1,
            quite: 1,
            rather: 1,
            really: 1,
            regarding: 1,
            seem: 1,
            seen: 1,
            several: 1,
            should: 1,
            show: 1,
            showed: 1,
            shown: 1,
            shows: 1,
            since: 1,
            some: 1,
            such: 1,
            than: 1,
            that: 1,
            the: 1,
            their: 1,
            theirs: 1,
            them: 1,
            then: 1,
            there: 1,
            therefore: 1,
            these: 1,
            they: 1,
            this: 1,
            those: 1,
            through: 1,
            thus: 1,
            upon: 1,
            use: 1,
            used: 1,
            using: 1,
            various: 1,
            very: 1,
            was: 1,
            were: 1,
            what: 1,
            when: 1,
            which: 1,
            while: 1,
            with: 1,
            within: 1,
            without: 1,
            would: 1,
            "[": 1,
            "]": 1,
            "{": 1,
            "}": 1,
            "(": 1,
            ")": 1,
            _: 1,
            $: 1,
            "!": 1,
            "#": 1,
            "^": 1,
            "&": 1,
            "*": 1,
            "'": 1,
            '"': 1,
            ":": 1,
            "?": 1,
            ".": 1,
            ",": 1,
            ";": 1,
            "%": 1,
            "|": 1,
            "@": 1
        },
        decode: function(a) {
            try {
                var b = JSON.parse(a);
            } catch (b) {
                PP.log({
                    type: "exception",
                    subtype: "Follow up: Invalid JSON",
                    msg: "Could not decode JSON string in Utils.decode ",
                    str: PP.Utils.escape(a),
                    stack: PP.Utils.stackTrace(),
                    error: b
                });
                throw b;
            }
            return b;
        },
        encode: function(a) {
            return JSON.stringify(a);
        },
        convertHtmlEntitiesToUnicode: function(a) {
            var b = a.split(/(&[^;]+;)/);
            for (var c = 0; c < b.length; c++) {
                if (b[c].match(/^&[^;]+;$/)) {
                    if (typeof document != "undefined") {
                        var d = document.createElement("div");
                        d.innerHTML = b[c];
                        b[c] = d.textContent;
                    } else {
                        b[c] = $("<textarea />").html(b[c]).text();
                    }
                }
            }
            return b.join("");
        },
        escapeXML: function(a) {
            if (PP.Utils.isString(a)) {
                var b = a || "";
                return b.replace(/\&/g, "&amp;").replace(/\</g, "&lt;").replace(/\>/g, "&gt;").replace(/\"/g, "&quot;").replace(/\'/g, "&apos;");
            } else {
                return a;
            }
        },
        escape: function(a, b) {
            var c = {
                exclude: []
            };
            PP.Utils.apply(c, b || {});
            a = a.replace(/&lt;/g, "<");
            a = a.replace(/&gt;/g, ">");
            a = a.replace(/&amp;/g, "&");
            var d = document.createElement("div");
            d.appendChild(document.createTextNode(a));
            var e = d.innerHTML;
            for (var f = 0; f < c.exclude.length; f++) {
                var g = new RegExp("&lt;" + c.exclude[f] + "&gt;", "g");
                e = e.replace(g, "<" + c.exclude[f] + ">");
                g = new RegExp("&lt;\\/" + c.exclude[f] + "&gt;", "g");
                e = e.replace(g, "</" + c.exclude[f] + ">");
            }
            return e;
        },
        escapeAttributeValue: function(a) {
            var b = {
                "&": "&amp;",
                "<": "&lt;",
                ">": "&gt;",
                '"': "&quot;",
                "'": "&#39;",
                "/": "&#x2F;"
            };
            return String(a).replace(/[&<>"'\/]/g, function(a) {
                return b[a];
            });
        },
        addAllDiacritics: function(a) {
            var b = this;
            if (!b.reversedDiacriticsMap) {
                b.reversedDiacriticsMap = {};
                for (var c in b.diacriticsMap) {
                    if (!(b.diacriticsMap[c] in b.reversedDiacriticsMap)) {
                        b.reversedDiacriticsMap[b.diacriticsMap[c]] = [];
                    }
                    b.reversedDiacriticsMap[b.diacriticsMap[c]].push(c);
                }
                for (var c in b.reversedDiacriticsMap) {
                    b.reversedDiacriticsMap[c] = "[" + b.reversedDiacriticsMap[c].join("") + "]";
                }
            }
            var d = a.split("");
            var e = "";
            for (var f = 0; f < d.length; f++) {
                e += d[f] in b.reversedDiacriticsMap ? b.reversedDiacriticsMap[d[f]] : d[f];
            }
            return e;
        },
        replaceDiacritics: function(a) {
            var b = this;
            var c = a.split("");
            var d = "";
            for (var e = 0; e < c.length; e++) {
                d += c[e] in b.diacriticsMap ? b.diacriticsMap[c[e]] : c[e];
            }
            return d;
        },
        replaceU0308: function(a) {
            if (!a) return a;
            if (!a.match(/\u0308/)) return a;
            var b = new RegExp("(.*)([AEIOUaeiouy])(\u0308)(.*)", "g");
            var c;
            var d = 0;
            var e = {
                a: "\xe4",
                e: "\xeb",
                i: "\xef",
                o: "\xf6",
                u: "\xfc",
                y: "\xff",
                A: "\xc4",
                E: "\xcb",
                I: "\xcf",
                O: "\xd6",
                U: "\xdc"
            };
            while ((c = b.exec(a)) !== null) {
                if (d++ > 50) break;
                a = c[1] + e[c[2]] + c[4];
                b.lastIndex = 0;
            }
            a = a.replace(/\u0308/g, "");
            return a;
        },
        replaceControlChars: function(a) {
            if (!a) return a;
            a = a.replace(/[\u0000-\u0008\u000B-\u001F]/g, "");
            return a;
        },
        addWbrs: function(a) {
            if (!a) return a;
            var b, c, d;
            var e = [];
            var f = 0;
            var g = {};
            var h = 30;
            var i = new RegExp("(.{" + h + "})");
            a += "";
            d = a.replace(/\s+$/g, "").replace(/^\s+/g, "").split(/(<\/?(?:span|i|sub|sup)[^>]*>)/);
            d.forEach(function(a) {
                if (a.match(/^<\/?(?:span|i|sub|sup)[^>]*>$/)) {
                    e.push({
                        str: a,
                        type: "html"
                    });
                } else {
                    a.split(/(\s+)/).forEach(function(a) {
                        if (a.match(/^\s+$/)) {
                            e.push({
                                str: " <wbr>",
                                type: "space"
                            });
                            f++;
                        } else {
                            if (a != "") {
                                e.push({
                                    str: a,
                                    type: "text",
                                    wbrs: []
                                });
                                if (!(f in g)) g[f] = [];
                                g[f].push(e.length - 1);
                            }
                        }
                    });
                }
            });
            for (var j in g) {
                var k = "";
                g[j].forEach(function(a) {
                    k += e[a].str;
                });
                if (k.length >= h) {
                    d = k.split(/([_\/\-]+)/);
                    for (c = 0; c < d.length; c++) {
                        if (d[c].match(/^[_\/\-]+$/)) {
                            d[c] = d[c] + "<wbr>";
                        } else if (d[c].length >= h) {
                            d[c] = d[c].split(i).join("<wbr>").replace(/^<wbr>/, "");
                        }
                    }
                    var l = 0;
                    d.join("").split(/(<wbr>)/).forEach(function(a) {
                        if (a == "<wbr>") {
                            var b = 0;
                            g[j].forEach(function(a) {
                                if (l > b && l <= b + e[a].str.length) {
                                    e[a].wbrs.push(l - b - 1);
                                }
                                b += e[a].str.length;
                            });
                        } else {
                            l += a.length;
                        }
                    });
                }
            }
            a = [];
            e.forEach(function(b) {
                if (b.type == "text" && b.wbrs.length) {
                    d = b.str.split("");
                    b.wbrs.forEach(function(a) {
                        d[a] += "<wbr>";
                    });
                    b.str = d.join("");
                }
                a.push(b.str);
            });
            return a.join("");
        },
        escapeRegex: function(a) {
            if (!a) return a;
            a = a.replace(/\\/g, "\\\\");
            a = a.replace(/\^/g, "\\^");
            a = a.replace(/\|/g, "\\|");
            a = a.replace(/\$/g, "\\$");
            a = a.replace(/\?/g, "\\?");
            a = a.replace(/\+/g, "\\+");
            a = a.replace(/\(/g, "\\(");
            a = a.replace(/\)/g, "\\)");
            a = a.replace(/\[/g, "\\[");
            a = a.replace(/\]/g, "\\]");
            a = a.replace(/\*/g, "\\*");
            return a;
        },
        removeQuotationMarksAndPunctation: function(a) {
            if (!a) return "";
            var b = "[\u2018\u2019\u201b\u201c\u201d\u201e\u201f\xa8\"'`\\-\\(\\[\\{\\)\\]\\}\\.,;:\\?\\!]+";
            return a.replace(new RegExp("^" + b, "i"), "").replace(new RegExp(b + "$", "i"), "");
        },
        normalizeIdsForSearch: function(a) {
            if (!a) return a;
            a = this.removeQuotationMarksAndPunctation(a);
            if (a.match(/^(pmid|doi|pmc|arxivid|isbn):/i)) {
                return a;
            }
            if (a.match(/^10\.[^\/]+\/[^\s\>\<]+/)) {
                return "doi:" + a;
            }
            if (a.match(/^\d{7,8}$/)) {
                return "pmid:" + a;
            }
            if (a.match(/PMC\d+/i)) {
                return "pmc:" + a;
            }
            if (a.match(/\d{4}\.\d{4}/)) {
                return "arxivid:" + a;
            }
            var b = a.replace(/[-\s\.]/g, "");
            if (b.match(/^\d{10}$/) || b.match(/^\d{13}$/) || b.match(/^\d{9}X$/i) || b.match(/^\d{12}X$/i)) {
                return "isbn:" + a;
            }
            if (a.toLowerCase() in this.stopwords) a = "";
            return a;
        },
        pp: function(a) {
            console.warn(this.prettyPrint(a));
        },
        prettyPrint: function(a) {
            return JSON.stringify(PP.Utils.clone(a), null, 4);
        },
        getPath: function(a, b) {
            var c = b.split(".");
            var d = a;
            var e;
            for (var f = 0; f < c.length; f++) {
                var g = c[f];
                if (d[g] !== undefined) {
                    e = d[g];
                    d = e;
                } else {
                    return d[g];
                }
            }
            return e;
        },
        setPath: function(a, b, c) {
            var d = b.split(".");
            var e = a;
            var f;
            var g;
            for (var h = 0; h < d.length; h++) {
                g = d[h];
                if (h == d.length - 1) {
                    e[g] = c;
                    break;
                }
                if (e[g]) {
                    f = e[g];
                    e = f;
                } else {
                    e[g] = {};
                    f = e[g];
                    e = f;
                }
            }
        },
        getCslLocales: function() {
            var a = [ {
                abbr: "default",
                name: "Language: Default"
            }, {
                abbr: "af-ZA",
                name: "Afrikaans"
            }, {
                abbr: "ar",
                name: "\u0627\u0644\u0639\u0631\u0628\u064a\u0629"
            }, {
                abbr: "bg-BG",
                name: "\u0411\u044a\u043b\u0433\u0430\u0440\u0441\u043a\u0438"
            }, {
                abbr: "ca-AD",
                name: "Catal\xe0"
            }, {
                abbr: "cs-CZ",
                name: "\u010ce\u0161tina"
            }, {
                abbr: "cy-GB",
                name: "Cymraeg"
            }, {
                abbr: "da-DK",
                name: "Dansk"
            }, {
                abbr: "de-AT",
                name: "Deutsch (\xd6sterreich)"
            }, {
                abbr: "de-CH",
                name: "Deutsch (Schweiz)"
            }, {
                abbr: "de-DE",
                name: "Deutsch (Deutschland)"
            }, {
                abbr: "el-GR",
                name: "\u0395\u03bb\u03bb\u03b7\u03bd\u03b9\u03ba\u03ac"
            }, {
                abbr: "en-GB",
                name: "English (UK)"
            }, {
                abbr: "en-US",
                name: "English (US)"
            }, {
                abbr: "es-CL",
                name: "Espa\xf1ol (Chile)"
            }, {
                abbr: "es-ES",
                name: "Espa\xf1ol (Espa\xf1a)"
            }, {
                abbr: "es-MX",
                name: "Espa\xf1ol (M\xe9xico)"
            }, {
                abbr: "et-EE",
                name: "Eesti"
            }, {
                abbr: "eu",
                name: "Euskara"
            }, {
                abbr: "fa-IR",
                name: "\u0641\u0627\u0631\u0633\u06cc"
            }, {
                abbr: "fi-FI",
                name: "Suomi"
            }, {
                abbr: "fr-CA",
                name: "Fran\xe7ais (Canada)"
            }, {
                abbr: "fr-FR",
                name: "Fran\xe7ais (France)"
            }, {
                abbr: "he-IL",
                name: "\u05e2\u05d1\u05e8\u05d9\u05ea"
            }, {
                abbr: "hr-HR",
                name: "Hrvatski"
            }, {
                abbr: "hu-HU",
                name: "Magyar"
            }, {
                abbr: "id-ID",
                name: "Bahasa Indonesia"
            }, {
                abbr: "is-IS",
                name: "\xcdslenska"
            }, {
                abbr: "it-IT",
                name: "Italiano"
            }, {
                abbr: "ja-JP",
                name: "\u65e5\u672c\u8a9e"
            }, {
                abbr: "km-KH",
                name: "\u1797\u17b6\u179f\u17b6\u1781\u17d2\u1798\u17c2\u179a"
            }, {
                abbr: "ko-KR",
                name: "\ud55c\uad6d\uc5b4"
            }, {
                abbr: "lt-LT",
                name: "Lietuvi\u0173"
            }, {
                abbr: "lv-LV",
                name: "Latvie\u0161u"
            }, {
                abbr: "mn-MN",
                name: "\u041c\u043e\u043d\u0433\u043e\u043b"
            }, {
                abbr: "nb-NO",
                name: "Norsk bokm\xe5l"
            }, {
                abbr: "nl-NL",
                name: "Nederlands"
            }, {
                abbr: "nn-NO",
                name: "Norsk nynorsk"
            }, {
                abbr: "pl-PL",
                name: "Polski"
            }, {
                abbr: "pt-BR",
                name: "Portugu\xeas (Brasil)"
            }, {
                abbr: "pt-PT",
                name: "Portugu\xeas (Portugal)"
            }, {
                abbr: "ro-RO",
                name: "Rom\xe2n\u0103"
            }, {
                abbr: "ru-RU",
                name: "\u0420\u0443\u0441\u0441\u043a\u0438\u0439"
            }, {
                abbr: "sk-SK",
                name: "Sloven\u010dina"
            }, {
                abbr: "sl-SI",
                name: "Sloven\u0161\u010dina"
            }, {
                abbr: "sr-RS",
                name: "\u0421\u0440\u043f\u0441\u043a\u0438 / Srpski"
            }, {
                abbr: "sv-SE",
                name: "Svenska"
            }, {
                abbr: "th-TH",
                name: "\u0e44\u0e17\u0e22"
            }, {
                abbr: "tr-TR",
                name: "T\xfcrk\xe7e"
            }, {
                abbr: "uk-UA",
                name: "\u0423\u043a\u0440\u0430\u0457\u043d\u0441\u044c\u043a\u0430"
            }, {
                abbr: "vi-VN",
                name: "Ti\u1ebfng Vi\u1ec7t"
            }, {
                abbr: "zh-CN",
                name: "\u4e2d\u6587 (\u4e2d\u56fd\u5927\u9646)"
            }, {
                abbr: "zh-TW",
                name: "\u4e2d\u6587 (\u53f0\u7063)"
            } ];
            return a;
        },
        merge: function(a, b) {
            var c = Object.keys(b);
            for (var d = 0; d < c.length; d++) {
                var e = c[d];
                if (a[e] && b[e] && this.isObject(a[e]) && this.isObject(b[e])) {
                    this.merge(a[e], b[e]);
                } else if (b[e] !== undefined) {
                    a[e] = b[e];
                }
            }
        },
        extend: function(a) {
            var b = Array.prototype.slice.call(arguments, 1);
            for (var c = 0, d = b.length, e; c < d; c++) {
                e = b[c] || {};
                for (var f in e) {
                    if (e.hasOwnProperty(f)) {
                        a[f] = e[f];
                    }
                }
            }
            return a;
        },
        extendIf: function(a, b) {
            var c;
            if (a) {
                for (c in b) {
                    if (a[c] === undefined) {
                        a[c] = b[c];
                    }
                }
            }
            return a;
        },
        objectEach: function(a, b, c) {
            for (var d in a) {
                if (a.hasOwnProperty(d)) {
                    if (b.call(c || a, d, a[d], a) === false) {
                        return;
                    }
                }
            }
        },
        bind: function(a, b, c, d) {
            if (arguments.length === 2) {
                return function() {
                    return a.apply(b, arguments);
                };
            }
            if (d === undefined) {
                d = true;
            }
            var e = a, f = Array.prototype.slice;
            return function() {
                var a = c || arguments;
                if (d === true && c !== undefined) {
                    a = f.call(arguments, 0);
                    a = a.concat(c);
                }
                return e.apply(b, a);
            };
        },
        strip: function(a) {
            a = a.replace(/^\s*/, "");
            a = a.replace(/\s*$/, "");
            return a;
        },
        normalizeString: function(a) {
            if (a) {
                a = a.replace(/[\t\n\s\r]+/g, " ").replace(/^\s+/, "").replace(/\s+$/, "");
            } else {
                a = "";
            }
            return a;
        },
        isPdfRestricted: function(a) {
            var b = false;
            if (a === "restricted") {
                b = true;
            } else if (a === "loginrequired") {
                b = true;
            } else if (a === "proxyrestricted") {
                b = true;
            }
            return b;
        },
        ellipsis: function(a, b, c, d) {
            if (c === undefined) {
                c = false;
            }
            if (d === undefined) {
                d = "&hellip;";
            }
            var e = Math.abs(b);
            if (a && a.length > e) {
                if (c && b > 0) {
                    var f = a.substr(0, e - 2), g = Math.max(f.lastIndexOf(" "), f.lastIndexOf("."), f.lastIndexOf("!"), f.lastIndexOf("?"));
                    if (g !== -1 && g >= e - 15) {
                        return f.substr(0, g) + d;
                    }
                } else if (c && b < 0) {
                    var f = a.substr(2);
                    var h = [ " ", ".", "!", "?" ];
                    var i = a.length;
                    for (var j = 0; j < h.length; j++) {
                        if (f.indexOf(h[j]) !== -1) {
                            i = Math.min(i, f.indexOf(h[j]));
                        }
                    }
                    if (i < 15) {
                        return d + f.substr(i + 1);
                    }
                }
                if (b > 0) {
                    return a.substr(0, b - 3) + d;
                } else {
                    return d + a.substr(a.length - e);
                }
            }
            return a;
        },
        midEllipsis: function(a, b, c) {
            if (!a) return a;
            if (b < 1) return a;
            a = a + "";
            if (a.length <= b) return a;
            if (c === undefined) {
                c = false;
            }
            var d = c ? 0 : 1;
            var e = [];
            var f = [];
            var g;
            if (c) {
                g = a.split("");
            } else {
                g = a.split(/\s/);
            }
            var h = 0;
            for (var i = 0; i < g.length; i++) {
                if (h > a.length / 2) {
                    break;
                }
                e.push(g[i]);
                h += g[i].length + d;
            }
            f = f.concat(g.slice(e.length));
            var j = e.join(" ").length;
            var k = f.join(" ").length;
            var l = a.length;
            var m = k > j;
            var n;
            while (l > b) {
                if (m) {
                    n = f.shift();
                    k -= n.length + d;
                } else {
                    n = e.pop();
                    j -= n.length + d;
                }
                l -= n.length + d;
                m = k > j;
            }
            if (c) {
                return e.join("") + " ... " + f.join("");
            } else {
                return e.join(" ") + " ... " + f.join(" ");
            }
        },
        getFilenameFromUrl: function(a, b) {
            var c = a.split("/");
            var d = "";
            if (c.length > 1) {
                var e = c[c.length - 1];
                d = e;
                if (e.match(/\./)) {
                    if (!e.match(/[&\?"']/)) {
                        return e;
                    }
                }
            }
            if (b) {
                return d;
            } else {
                return null;
            }
        },
        getDomainSuffix: function(a) {
            if (!a) {
                return "";
            }
            a = a.replace(/^(http|https|ftp):\/\//g, "");
            a = a.replace(/^www\./g, "");
            a = a.split("/")[0];
            a = this.ellipsis(a, -20, true);
            a = a.replace(/\.\.\./, "");
            a = a.replace("&hellip;", "");
            return a;
        },
        isArray: "isArray" in Array ? Array.isArray : function(a) {
            return b.call(a) === "[object Array]";
        },
        isObject: b.call(null) === "[object Object]" ? function(a) {
            return a !== null && a !== undefined && b.call(a) === "[object Object]" && a.ownerDocument === undefined;
        } : function(a) {
            return b.call(a) === "[object Object]";
        },
        isString: function(a) {
            return typeof a === "string";
        },
        isFunction: typeof document !== "undefined" && typeof document.getElementsByTagName("body") === "function" ? function(a) {
            return b.call(a) === "[object Function]";
        } : function(a) {
            return typeof a === "function";
        },
        isNumeric: function(a) {
            return !isNaN(parseFloat(a)) && isFinite(a);
        },
        isUrlLike: function(a) {
            if (!a || !this.isString(a)) {
                return false;
            }
            var b = /^(www|http|ftp|file|evernote)/i;
            var c = /\.(com|org|net|gov|edu|uk|de)/i;
            if (a.match(b) || a.match(c)) {
                return true;
            } else {
                return false;
            }
        },
        clone: function(a) {
            var c, d, e, f, g, h;
            if (a === null || a === undefined) {
                return a;
            }
            if (a.nodeType && a.cloneNode) {
                return a.cloneNode(true);
            }
            c = b.call(a);
            if (c === "[object Date]") {
                return new Date(a.getTime());
            }
            if (c === "[object Array]") {
                d = a.length;
                g = [];
                while (d--) {
                    g[d] = PP.Utils.clone(a[d]);
                }
            } else if (c === "[object Object]" && a.constructor === Object) {
                g = {};
                for (h in a) {
                    if (a[h] !== undefined) {
                        g[h] = PP.Utils.clone(a[h]);
                    }
                }
            }
            return g || a;
        },
        stamp: function() {
            var a = 0, b = "_leaflet_id";
            return function(c) {
                c[b] = c[b] || ++a;
                return c[b];
            };
        }(),
        limitExecByInterval: function(a, b, c) {
            var d, e;
            return function f() {
                var g = arguments;
                if (d) {
                    e = true;
                    return;
                }
                d = true;
                setTimeout(function() {
                    d = false;
                    if (e) {
                        f.apply(c, g);
                        e = false;
                    }
                }, b);
                a.apply(c, g);
            };
        },
        throttle: function(a, b, c, d) {
            var e, f = 0;
            if (typeof c !== "boolean") {
                d = a;
                a = c;
                c = undefined;
            }
            function g() {
                var g = this, h = +new Date() - f, i = arguments;
                function j() {
                    f = +new Date();
                    a.apply(g, i);
                }
                function k() {
                    e = undefined;
                }
                if (d && !e) {
                    j();
                }
                e && clearTimeout(e);
                if (d === undefined && h > b) {
                    j();
                } else if (c !== true) {
                    e = setTimeout(d ? k : j, d === undefined ? b - h : b);
                }
            }
            return g;
        },
        debounce: function(a, b, c) {
            var d;
            return function() {
                var e = this, f = arguments;
                var g = function() {
                    d = null;
                    if (!c) a.apply(e, f);
                };
                var h = c && !d;
                clearTimeout(d);
                d = setTimeout(g, b);
                if (h) a.apply(e, f);
            };
        },
        falseFn: function() {
            return false;
        },
        formatNum: function(a, b) {
            var c = Math.pow(10, b || 5);
            return Math.round(a * c) / c;
        },
        splitWords: function(a) {
            return a.replace(/^\s+|\s+$/g, "").split(/\s+/);
        },
        setOptions: function(a, b) {
            a.options = PP.Utils.extend({}, a.options, b);
            return a.options;
        },
        getParamString: function(a) {
            var b = [];
            for (var c in a) {
                if (a.hasOwnProperty(c)) {
                    b.push(c + "=" + a[c]);
                }
            }
            return "?" + b.join("&");
        },
        template: function(a, b) {
            return a.replace(/\{ *([\w_]+) *\}/g, function(a, c) {
                var d = b[c];
                if (!b.hasOwnProperty(c)) {
                    throw new Error("No value provided for variable " + a);
                }
                return d;
            });
        },
        callback: function(a, b, c) {
            if (a === undefined) {
                return;
            }
            if (!PP.Utils.isFunction(a)) {
                return;
            }
            a.apply(b, c);
        },
        getRegex: function(a) {
            if (a instanceof RegExp) {
                return a;
            }
            a = a.replace(/^!/, "");
            a = a.replace(/!$/, "");
            a = a.replace(/&quot;/g, '"');
            a = a.replace(/&amp;/g, "&");
            a = a.replace(/\//g, "\\/");
            return new RegExp(a);
        },
        defer: function(a, b, c, d) {
            d = d || [];
            c = c || {};
            a = PP.Utils.bind(a, c, d, true);
            var e = setTimeout(a, b);
            return e;
        },
        emptyImageUrl: "data:image/gif;base64,R0lGODlhAQABAAD/ACwAAAAAAQABAAACADs=",
        objectToHtml: function(a) {
            var b = JSON.stringify(a, null, 4);
            b = b.replace(/^\s+/gm, function(a) {
                return new Array(a.length + 1).join("&nbsp;");
            });
            b = b.replace(/\n/g, "<br/>");
            return b;
        },
        ensureAbsoluteUrl: function(a, b) {
            if (b && !b.match(/^(http|www|ftp)/gi)) {
                var c = new URI(b);
                var d = c.resolve(new URI(a)).toString();
                return d;
            } else {
                return b;
            }
        },
        keySummary: function(a) {
            var b = Object.keys(a);
            var c = "[" + PP.Utils.ellipsis(b.join(", "), 150, null, "") + "]";
            return c;
        },
        progressModulus: function(a, b) {
            if (a < 100) {
                return 1;
            } else if (a < 500) {
                return 5;
            } else if (a < 1e3) {
                return 10;
            } else if (a < 2e3) {
                return 20;
            } else {
                return Math.floor(Math.round(a / 100 / 10) * 10);
            }
        },
        extractISBNs: function(a, b) {
            var c = this;
            var d = [];
            b = b || {};
            if (!("convert" in b)) b.convert = false;
            if (!("unique" in b)) b.unique = false;
            if (a && PP.Utils.isString(a)) {
                a.split(/[^\dxX\-]/).forEach(function(a) {
                    if (a.length > 1) {
                        if (c.isISBN10(a)) {
                            d.push(a);
                        } else if (c.isISBN13(a)) {
                            d.push(a);
                        }
                    }
                });
            }
            if (b.convert) {
                var e = [];
                d.forEach(function(a) {
                    if (a.length == 10) {
                        e.push(c.isbn10To13(a));
                    } else {
                        e.push(a);
                    }
                });
                d = e;
            }
            if (b.unique) {
                d = PP.Array.unique(d);
            }
            return d;
        },
        isISBN10: function(a) {
            var b = false;
            if (a && PP.Utils.isString(a)) {
                a = a.toUpperCase().replace(/[\n\r\t\s\-]+/g, "");
                if (a.match(/^\d{9}[\dX]$/)) {
                    var c = parseInt(a.charAt(0)) * 1;
                    c += parseInt(a.charAt(1)) * 2;
                    c += parseInt(a.charAt(2)) * 3;
                    c += parseInt(a.charAt(3)) * 4;
                    c += parseInt(a.charAt(4)) * 5;
                    c += parseInt(a.charAt(5)) * 6;
                    c += parseInt(a.charAt(6)) * 7;
                    c += parseInt(a.charAt(7)) * 8;
                    c += parseInt(a.charAt(8)) * 9;
                    var d = a.charAt(9) == "X" ? 10 : parseInt(a.charAt(9));
                    c += d * 10;
                    c = c % 11;
                    if (c === 0) b = true;
                }
            }
            return b;
        },
        isISBN13: function(a) {
            var b = false;
            if (a && PP.Utils.isString(a)) {
                a = a.toUpperCase().replace(/[\n\r\t\s\-]+/g, "");
                if (a.match(/^978\d{10}$/)) {
                    var c = parseInt(a.charAt(0));
                    c += parseInt(a.charAt(1)) * 3;
                    c += parseInt(a.charAt(2));
                    c += parseInt(a.charAt(3)) * 3;
                    c += parseInt(a.charAt(4));
                    c += parseInt(a.charAt(5)) * 3;
                    c += parseInt(a.charAt(6));
                    c += parseInt(a.charAt(7)) * 3;
                    c += parseInt(a.charAt(8));
                    c += parseInt(a.charAt(9)) * 3;
                    c += parseInt(a.charAt(10));
                    c += parseInt(a.charAt(11)) * 3;
                    c = (10 - c % 10) % 10;
                    if (parseInt(a.charAt(12)) == c) b = true;
                }
            }
            return b;
        },
        isbn10To13: function(a) {
            if (!PP.Utils.isString(a)) {
                return "";
            }
            if (a.length != 10) {
                return "";
            }
            var b = 38 + 3 * (parseInt(a[0]) + parseInt(a[2]) + parseInt(a[4]) + parseInt(a[6]) + parseInt(a[8])) + parseInt(a[1]) + parseInt(a[3]) + parseInt(a[5]) + parseInt(a[7]);
            var c = (10 - b % 10) % 10;
            return "978" + a.substring(0, 9) + c;
        },
        normalizeLanguage: function(a) {
            if (!PP.Utils.isString(a)) {
                return "";
            }
            a = PP.Utils.normalizeString(a);
            if (a.toLowerCase() in PP.Utils.languages) {
                return a.toLowerCase();
            }
            if (!PP.Utils.languagesHelper) {
                PP.Utils.languagesHelper = {};
                for (var b in PP.Utils.languages) {
                    if (PP.Utils.languages[b].a3) {
                        if (PP.Utils.isString(PP.Utils.languages[b].a3)) {
                            PP.Utils.languagesHelper[PP.Utils.languages[b].a3] = b;
                        } else {
                            PP.Utils.languages[b].a3.forEach(function(a) {
                                PP.Utils.languagesHelper[a] = b;
                            });
                        }
                    }
                    if (PP.Utils.languages[b].n) {
                        PP.Utils.languages[b].n.forEach(function(a) {
                            PP.Utils.languagesHelper[a.toLowerCase()] = b;
                        });
                    }
                }
            }
            if (a.toLowerCase() in PP.Utils.languagesHelper) {
                return PP.Utils.languagesHelper[a.toLowerCase()];
            }
            return "";
        },
        formatFileSize: function(a) {
            var b = 1024 * 1024 * 1024;
            var c = 1024 * 1024;
            var d = 1024;
            var e = a;
            var f = "KB";
            if (e > b) {
                a = e / b;
                f = "GB";
            } else if (e > c) {
                a = e / c;
                f = "MB";
            } else {
                a = e / d;
                f = "KB";
            }
            return Math.round(a * 10) / 10 + " " + f;
        },
        createErrorStatus: function(a, b) {
            var c = {
                cls: "error",
                text: "Something went wrong &mdash; " + a
            };
            if (b) {
                c.links = b;
            }
            this.createStatus(c);
        },
        createStatus: function(a) {
            if (PP.Globals.isWebApp() && typeof Paperpile !== "undefined" && Paperpile.Utils) {
                return Paperpile.Utils.createStatus(a);
            } else {
                PP.Msg.sendMessage({
                    fn: "createStatus",
                    args: [ a ]
                });
            }
        },
        createErrorWindow: function(a) {
            PP.Msg.sendMessage({
                fn: "createErrorWindow",
                args: [ {
                    type: a
                } ]
            });
        },
        callSerially: function(a, b) {
            if (a.length === 0) {
                PP.Utils.callback(b);
            } else {
                var c = a.shift();
                c(function(c, d) {
                    if (d) {
                        PP.Utils.callback(b, null, [ null, d ]);
                    } else {
                        PP.Utils.callSerially(a, b);
                    }
                });
            }
        },
        cleanFileName: function(a) {
            a = a.replace(/[\/\\?:|]/g, " - ");
            a = a.replace(/[<>*]/g, " ");
            a = a.replace(/(\w)(\.\.)(\w)/g, function(a, b, c, d) {
                return b + "." + d;
            });
            a = a.replace(/"/g, "'");
            a = a.replace(/\s*-\s*$/g, "");
            a = a.replace(/\s*-\s*\./g, ".");
            a = a.replace(/(\s*\.)([^\.])/g, function(a, b, c) {
                return "." + c;
            });
            a = a.replace(/-[- ]*-/g, "-");
            a = a.replace(/-+/g, "-");
            a = a.replace(/ +/g, " ");
            a = a.replace(/^\s*/, "");
            a = a.replace(/\s*$/, "");
            if (a.length > 150) {
                a = PP.Utils.midEllipsis(a, 145, true);
            }
            return a;
        },
        createLogLevel: function(a) {
            return function() {
                return a;
            };
        },
        verifyPubResult: function(a, b) {
            var c = [];
            for (var d in a) {
                if (d.match(/^test_/g)) {
                    continue;
                }
                var e = a[d];
                var f = PP.Utils.getPath(b, d);
                e = "" + e;
                f = "" + f;
                var g = false;
                if (e.match(/!.+!/)) {
                    var h = PP.Utils.getRegex(e);
                    if (f && f.match(h)) {
                        g = true;
                    }
                } else {
                    g = e === f;
                }
                if (e === "__require_set__") {
                    if (!f) {
                        c.push(d + " not set");
                    }
                } else if (!g) {
                    c.push(d + " does not match (WANTED: " + e + " GOT: " + f + ")");
                }
            }
            return c;
        },
        deepEquals: function(a, b) {
            var c;
            for (c in a) {
                if (typeof b[c] == "undefined") {
                    return false;
                }
            }
            for (c in a) {
                if (a[c]) {
                    switch (typeof a[c]) {
                      case "object":
                        if (!this.deepEquals(a[c], b[c])) {
                            return false;
                        }
                        break;

                      case "function":
                        if (typeof b[c] == "undefined" || c != "equals" && a[c].toString() != b[c].toString()) return false;
                        break;

                      default:
                        if (a[c] != b[c]) {
                            return false;
                        }
                    }
                } else {
                    if (b[c]) return false;
                }
            }
            for (c in b) {
                if (typeof a[c] == "undefined") {
                    return false;
                }
            }
            return true;
        },
        getTabId: function(a) {
            if (a && a.tab && a.tab.id !== -1) {
                return a.tab.id;
            } else if (a) {
                return a.tabId;
            } else {
                return undefined;
            }
        },
        logToBg: function(a) {
            if (!PP.Globals.isBackgroundPage()) {
                PP.Msg.sendMessage({
                    fn: "logToBg",
                    args: [ a ]
                });
            }
        },
        decodeProxyString: function(a) {
            var b = [];
            if (a && PP.Utils.isString(a)) {
                a.split(/\^/).forEach(function(a) {
                    var c = a.split(/\|/);
                    if (c && c.length == 3) {
                        var d = {
                            name: c[0],
                            url: c[1],
                            active: false
                        };
                        if (c[2] == "1") d.active = true;
                        b.push(d);
                    }
                });
            }
            return b;
        },
        getProxyLoginUrl: function() {
            var a = PP.backend.Settings.getSetting("proxy_list");
            if (!a) return;
            var b = PP.Utils.decodeProxyString(a);
            if (b.length) {
                var c = b[0].url;
                return c;
            }
        },
        getPermalink: function(a) {
            var b = PP.Globals.getUrlBase();
            return b + "/app/p/" + a._id;
        },
        encodeProxyString: function(a) {
            var b = [];
            a.forEach(function(a) {
                b.push([ a.name, a.url, a.active ? "1" : "0" ].join("|"));
            });
            return b.join("^");
        },
        encode64: function(a) {
            var b = "", c = 0, d = a.length, e = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=", f, g, h, i, j, k, l;
            while (c < d) {
                f = a.charCodeAt(c++);
                g = a.charCodeAt(c++);
                h = a.charCodeAt(c++);
                i = f >> 2;
                j = (f & 3) << 4 | g >> 4;
                k = (g & 15) << 2 | h >> 6;
                l = h & 63;
                if (isNaN(g)) k = l = 64; else if (isNaN(h)) l = 64;
                b = b + e.charAt(i) + e.charAt(j) + e.charAt(k) + e.charAt(l);
            }
            return b;
        },
        stackTrace: function() {
            var a = new Error("Custom");
            var b = "";
            if (a && a.stack) {
                b = a.stack;
            }
            return b;
        },
        getCookie: function(a) {
            if (!a) {
                return null;
            }
            return decodeURIComponent(document.cookie.replace(new RegExp("(?:(?:^|.*;)\\s*" + encodeURIComponent(a).replace(/[\-\.\+\*]/g, "\\$&") + "\\s*\\=\\s*([^;]*).*$)|^.*$"), "$1")) || null;
        },
        makeAlphaNumericID: function(a) {
            var b = "";
            var c = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789";
            for (var d = 0; d < a; d++) {
                b += c.charAt(Math.floor(Math.random() * c.length));
            }
            return b;
        },
        convertInlineLatexToHtml: function(a) {
            var b = function(a) {
                var b = 0;
                var c = [];
                var d = "";
                var e = 0;
                if (a.indexOf("{") == -1) {
                    return [ {
                        level: 0,
                        pre: "",
                        value: a,
                        close: false
                    } ];
                }
                while (a.indexOf("{") != -1 | a.indexOf("}") != -1 && e < 100) {
                    e += 1;
                    var f = "", d = "";
                    if (a.indexOf("{") != -1 && a.indexOf("{") < a.indexOf("}")) {
                        b += 1;
                        d = a.substring(0, a.indexOf("{"));
                        a = a.substring(a.indexOf("{") + 1);
                        if (a.indexOf("{") != -1 && a.indexOf("{") < a.indexOf("}")) {
                            c.push({
                                level: b,
                                pre: d,
                                value: f,
                                close: false
                            });
                        } else if (a.indexOf("}") != -1) {
                            f = a.substring(0, a.indexOf("}"));
                            c.push({
                                level: b,
                                pre: d,
                                value: f,
                                close: true
                            });
                            a = a.substring(a.indexOf("}") + 1);
                            b -= 1;
                        } else {
                            c.push({
                                level: b,
                                pre: d,
                                value: a,
                                close: false
                            });
                            a = "";
                            b -= 1;
                        }
                    } else if (a.indexOf("}") != -1) {
                        f = a.substring(0, a.indexOf("}"));
                        c.push({
                            level: b,
                            pre: d,
                            value: f,
                            close: true
                        });
                        a = a.substring(a.indexOf("}") + 1);
                        b -= 1;
                    } else {
                        c.push({
                            level: b,
                            pre: d,
                            value: a,
                            close: false
                        });
                        a = "";
                        b -= 1;
                    }
                }
                return c;
            };
            var c = a.split("$");
            var d = "";
            for (var e = 0; e < c.length; e++) {
                if (c[e].length) {
                    var f = b(c[e]);
                    var g = 0;
                    var h = [];
                    for (var i = 0; i < f.length; i++) {
                        if (f[i].level >= g) {
                            g = f[i].level;
                            switch (f[i].pre) {
                              case "_":
                                h.push("sub");
                                d += "<sub>";
                                d += f[i].value;
                                if (f[i].close) {
                                    d += "</" + h.pop() + ">";
                                }
                                break;

                              case "^":
                                h.push("sup");
                                d += "<sup>";
                                d += f[i].value;
                                if (f[i].close) {
                                    d += "</" + h.pop() + ">";
                                }
                                break;

                              case "\\emph":
                                h.push("i");
                                d += "<i>";
                                d += f[i].value;
                                if (f[i].close) {
                                    d += "</" + h.pop() + ">";
                                }
                                break;

                              case "\\textit":
                                h.push("i");
                                d += "<i>";
                                d += f[i].value;
                                if (f[i].close) {
                                    d += "</" + h.pop() + ">";
                                }
                                break;

                              case "\\textbf":
                                h.push("b");
                                d += "<b>";
                                d += f[i].value;
                                if (f[i].close) {
                                    d += "</" + h.pop() + ">";
                                }
                                break;

                              case "\\text":
                                d += f[i].value;
                                break;

                              default:
                                d += f[i].value;
                                if (f[i].close && h.length) {
                                    d += "</" + h.pop() + ">";
                                }
                                break;
                            }
                        } else {
                            g -= 1;
                            d += f[i].value;
                            if (f[i].close && h.length) {
                                d += "</" + h.pop() + ">";
                            }
                        }
                    }
                    while (h.length) {
                        pre = h.pop();
                        if (pre !== "") d += "</" + pre + ">";
                    }
                }
            }
            return d;
        },
        getHtmlAttribute: function(a, b) {
            var c;
            if ("attribs" in a) {
                if (b in a.attribs) c = a.attribs[b];
            } else {
                c = a.getAttribute(b);
            }
            return c;
        }
    };
    function e(a) {
        var b, c, d = [ "webkit", "moz", "o", "ms" ];
        for (b = 0; b < d.length && !c; b++) {
            c = window[d[b] + a];
        }
        return c;
    }
    function f(a) {
        return window.setTimeout(a, 1e3 / 60);
    }
})();

PP.Utils.apply = PP.Utils.extend;

PP.Utils.applyIf = PP.Utils.extendIf;

PP.pp = PP.Utils.prettyPrint;

var l1 = PP.Utils.createLogLevel([ "font-weight: bold;", "color: rgb(50, 50, 100)" ].join(""));

var l2 = PP.Utils.createLogLevel([ "color: rgb(50, 50, 50);", "margin-left: 2em;" ].join(""));

var l3 = PP.Utils.createLogLevel([ "color: rgb(150, 150, 150);", "margin-left: 4em;" ].join(""));

var l4 = PP.Utils.createLogLevel([ "font-style: italic;", "color: rgb(150, 150, 150);", "margin-left: 6em;" ].join(""));

var e1 = PP.Utils.createLogLevel([ "font-weight: bold;", "color: rgb(255, 50, 50);" ].join(""));

PP.Class = function() {};

PP.Class.extend = function(a) {
    var b = function(a) {
        if (a && PP.Utils.isObject(a)) {
            PP.Utils.apply(this, a);
        }
        if (this.debug === true) {
            this.c = console;
        } else {
            this.c = {
                log: function() {},
                warn: function() {},
                error: function() {
                    console.error(arguments);
                }
            };
        }
        if (this.initialize) {
            this.initialize.apply(this, arguments);
            if (this.debug === true) {
                this.c = console;
            }
        }
    };
    var c = function() {};
    c.prototype = this.prototype;
    var d = new c();
    d.constructor = b;
    b.prototype = d;
    for (var e in this) {
        if (this.hasOwnProperty(e) && e !== "prototype") {
            b[e] = this[e];
        }
    }
    if (a.statics) {
        PP.Utils.extend(b, a.statics);
        delete a.statics;
    }
    if (a.includes) {
        PP.Utils.extend.apply(null, [ d ].concat(a.includes));
        delete a.includes;
    }
    if (a.options && d.options) {
        a.options = PP.Utils.extend({}, d.options, a.options);
    }
    PP.Utils.extend(d, a);
    return b;
};

PP.Data = {
    hasKey: function(a) {
        for (var b = 0; b < this.fields.length; b++) {
            if (this.fields[b].name === a) {
                return true;
            }
        }
        return false;
    },
    getId: function() {
        return this.get("id");
    },
    get: function(a) {
        if (!this.hasKey(a) && this.allowNonFieldValues !== true) {
            console.error("get() error: no key " + a + " in data object!");
            console.error(this);
        } else {
            return this[a];
        }
    },
    set: function(a, b) {
        if (!this.hasKey(a) && this.allowNonFieldValues !== true) {
            console.error("set() error: no key " + a + " in data object!");
            console.error(this);
        } else {
            this[a] = b;
        }
    },
    serialize: function(a) {
        var b = this.fields;
        var c = {};
        for (var d = 0; d < b.length; d++) {
            var e = b[d].name;
            if (b[d].persist !== false || a === true) {
                if (this.get(e) !== undefined) {
                    c[e] = this.get(e);
                }
            }
        }
        return c;
    },
    getDefaults: function() {
        var a = this.fields;
        var b = {};
        for (var c = 0; c < a.length; c++) {
            var d = a[c].name;
            if (a[c].defaultValue === undefined) {
                console.error("No default value for field", a[c]);
                return null;
            } else {
                b[d] = a[c].defaultValue;
            }
        }
        return b;
    },
    isMissingFields: function() {
        var a = this.fields;
        for (var b = 0; b < a.length; b++) {
            var c = a[b].name;
            if (this[c] === undefined) {
                return true;
            }
        }
        return false;
    },
    apply: function(a) {
        for (var b in a) {
            this.set(b, a[b]);
        }
    },
    saveToChromeStorage: function(a) {
        if (window.chrome && window.chrome.storage) {
            var b = {};
            var c = this.getStorageKey();
            if (c === null) {
                console.log("data NOT saved -- storage key is null!");
                return;
            }
            b[c] = this.serialize();
            chrome.storage.local.set(b, function() {
                if (chrome.runtime.lastError) {
                    PP.Utils.callback(a, null, [ null, chrome.runtime.lastError ]);
                } else {
                    PP.Utils.callback(a, null, [ true, null ]);
                }
            });
        }
    },
    loadFromChromeStorage: function(a) {
        var b = this;
        if (window.chrome && window.chrome.storage) {
            var c = this.getStorageKey();
            if (c === null) {
                console.log("data NOT loaded -- storage key is null!");
                PP.Utils.callback(a, null, [ null, "Storage key is null" ]);
                return;
            }
            chrome.storage.local.get(c, function(d) {
                if (chrome.runtime.lastError) {
                    PP.Utils.callback(a, null, [ null, chrome.runtime.lastError ]);
                } else {
                    var e = d[c];
                    b.apply(e);
                    PP.Utils.callback(a, null, [ e, null ]);
                }
            });
        }
    },
    saveToLocalStorage: function(a) {
        var b = this.getStorageKey();
        if (b === null) {
            console.log("data NOT saved -- storage key is null!");
            return;
        }
        if (a !== true) {
            this.c.log("Saving", b, "to localStorage");
        }
        window.localStorage[b] = PP.Utils.encode(this.serialize());
    },
    clearLocalStorage: function() {
        var a = this.getStorageKey();
        if (a === null) {
            console.log("data NOT cleared -- storage key is null!");
        }
        delete window.localStorage[a];
    },
    loadFromLocalStorage: function() {
        var a = this.getStorageKey();
        if (a === null) {
            console.log("data NOT loaded -- storage key is null!");
            return;
        }
        if (this.debug) {
            console.log("Loading", a, "from localStorage");
        }
        var b = window.localStorage[a] || "{}";
        if (b.match(/object object/i)) {
            b = "{}";
        }
        var c = PP.Utils.decode(b);
        var d = Object.keys(c).length;
        if (d > 0) {
            this.apply(c);
        } else {
            console.log("  no localStorage for", a);
        }
    }
};

PP._Errors = PP.Class.extend({
    includes: [ PP.Events ],
    debug: false,
    listeningForErrors: false,
    errorCount: 0,
    startListeningForErrors: function() {
        this.listeningForErrors = true;
        if (!this.addedListener) {
            window.onerror = PP.Utils.bind(this.onError, this);
            this.addedListener = true;
        }
        if (window && window["jQuery"]) {
            jQuery.find.error = function(a) {
                PP.log({
                    type: "error",
                    subtype: "JQuery Sizzle",
                    msg: "Sizzle syntax error: " + a
                });
                throw new Error("Sizzle error: " + a);
            };
        }
    },
    stopListeningForErrors: function() {
        this.listeningForErrors = false;
    },
    onError: function(a, b, c, d, e) {
        var f = PP.Globals.getWindowId();
        if (!this.listeningForErrors) {
            console.log("Ignoring uncaught error: ", a);
            return;
        }
        if (c === 0) {
            console.log("Caught a non-Paperpile error. Not logging...");
            console.log(a);
            return false;
        }
        if (a === "Script error.") {
            console.log("Caught a non-paperpile error. Not logging...");
            console.log(a);
            return false;
        }
        var g;
        if (e) {
            g = e.stack;
        } else {
            g = d;
            d = undefined;
        }
        if (f === "cs" && b && b.match(/http/)) {
            console.log("Caught a non-paperpile error. Not logging...");
            console.log(a);
            return false;
        }
        if (a && PP.Utils.isString(a) && a["match"] && a.match(/error connecting to extension/i)) {
            var h = [ "ohdohjbmdpjmodcjkknnepbnbbmkmkcb", "bomfdkbfpdhijjbeoicnfhjbdhncfhig" ];
            var i = false;
            h.forEach(function(b) {
                if (a.match(b)) {
                    i = true;
                }
            });
            if (i) {
                PP.log({
                    type: "error",
                    subtype: "Error connecting to Paperpile extension",
                    msg: a
                });
            } else {
                console.log("Chrome error connecting to extension (error msg: '" + a + "')");
            }
            return false;
        }
        console.log("PP caught an error: \n msg:", a, "\n fileLocation:", b, "\n lineNumber:", c, "\n colNumber:", d, "\n stack:", g, "\n errorObject:", e);
        if (PP.Globals.isBackgroundPage()) {
            PP.Utils.createErrorWindow("BACKGROUND_PAGE");
            PP.log({
                type: "exception",
                subtype: "Extension Javascript",
                msg: a,
                fileLocation: b,
                lineNumber: c,
                colNumber: d,
                stack: g
            });
        } else if (PP.Globals.isWebApp()) {
            var j = true;
            var k = true;
            if (a && PP.Utils.isString(a) && a.match(/installation is already pending/i)) {
                j = false;
                k = false;
            }
            if (b && PP.Utils.isString(b) && b.match(/webstore/i)) {
                j = false;
                k = false;
            }
            if (j) {
                PP.Utils.createErrorStatus("Paperpile encountered an error", [ "STATUS_PANEL_RELOAD_WEBAPP" ]);
            }
            if (k) {
                PP.log({
                    type: "exception",
                    subtype: "Webapp Javascript",
                    msg: a,
                    fileLocation: b,
                    windowLocation: window.location.href,
                    lineNumber: c,
                    colNumber: d,
                    stack: g,
                    showedErrorStatusPanel: j
                });
            }
        } else if (PP.Globals.isDocsPlugin()) {
            if (b && PP.Utils.isString(b) && b.match(/docs\.google\.com\/static/i)) {
                console.log("Ignoring docs.google.com JS error!");
                return false;
            }
            if (b && PP.Utils.isString(b) && b.match(/searcho is not defined/i)) {
                console.log("Ignoring searcho error!");
                return false;
            }
            if (c == 1) {
                console.log("Ignoring lineNumber == 1 error!");
                return false;
            }
            PP.log({
                type: "exception",
                subtype: "Google Docs Javascript",
                msg: a,
                fileLocation: b,
                lineNumber: c,
                colNumber: d,
                windowId: window.PP_WINDOW_ID,
                windowLocation: window.location.href,
                stack: g
            });
        } else {
            var l = true;
            if (a && a.match(/cannot call method .(match|appendchild). of undefined/i)) {
                l = false;
            }
            if (a && a.match(/Cannot set property .display. of null/i)) {
                l = false;
            }
            if (l) {
                var m = window.location.href;
                if (PP.crawling && PP.crawling.MetaDriver) {
                    var n = PP.crawling.MetaDriver.getSupportingDriver(m);
                    var o;
                    if (n) {
                        o = n.name;
                    }
                    var p = PP.webimport.Utils.getSupportingWebImportPlugins(m);
                    var q = p.map(function(a) {
                        return a.getName();
                    });
                    if (!n && !p.length) {
                        m = window.location.host + " (logging domain only)";
                    } else if (!n && p.length) {
                        if (PP.Array.contains(q, "Google")) {
                            m = window.location.host + " (logging domain only)";
                        }
                    }
                }
                PP.log({
                    type: "exception",
                    subtype: "Content script Javascript",
                    msg: a,
                    fileLocation: b,
                    lineNumber: c,
                    windowId: window.PP_WINDOW_ID,
                    windowLocation: m,
                    webimportPlugins: q,
                    crawlerDrivers: o,
                    stack: g
                });
            }
        }
        PP.Errors.errorCount++;
        return false;
    },
    logErrorObject: function(a) {
        if (!this.listeningForErrors) {
            return;
        }
        var b = a.name + " " + a.message;
        var c = a.stack;
        var d, e;
        var f = /(at) (\S+) \((\S+)\)/;
        if (c) {
            var g = c.split("\n");
            var h = g[1];
            var i = h.match(f);
            if (i) {
                var j = i[3];
                var k = j.split(":");
                e = k[k.length - 2];
                var l = k.slice(0, k.length - 2);
                d = l.join("");
            }
        }
        this.onError(b, d, e, c);
    }
});

createSingleton(PP, "_Errors", "Errors");

var PP_EVENTS_KEY = "_pp_events";

var protectErrors = function(a) {
    var b = this;
    return function() {
        try {
            a.apply(b, arguments);
        } catch (a) {
            logError(a);
        }
    };
};

PP.Events = {
    addEventListener: function(a, b, c) {
        var d = this[PP_EVENTS_KEY] = this[PP_EVENTS_KEY] || {}, e, f, g;
        if (typeof a === "object") {
            for (e in a) {
                if (a.hasOwnProperty(e)) {
                    this.addEventListener(e, a[e], b);
                }
            }
            return;
        }
        a = PP.Utils.splitWords(a);
        for (f = 0, g = a.length; f < g; f++) {
            d[a[f]] = d[a[f]] || [];
            d[a[f]].push({
                action: b,
                context: c || this
            });
        }
        return;
    },
    hasEventListeners: function(a) {
        return PP_EVENTS_KEY in this && a in this[PP_EVENTS_KEY] && this[PP_EVENTS_KEY][a].length > 0;
    },
    removeEventListener: function(a, b, c) {
        var d = this[PP_EVENTS_KEY], e, f, g, h, i;
        if (typeof a === "object") {
            for (e in a) {
                if (a.hasOwnProperty(e)) {
                    this.removeEventListener(e, a[e], b);
                }
            }
            return this;
        }
        a = PP.Utils.splitWords(a);
        for (f = 0, g = a.length; f < g; f++) {
            if (this.hasEventListeners(a[f])) {
                h = d[a[f]];
                for (i = h.length - 1; i >= 0; i--) {
                    if ((!b || h[i].action === b) && (!c || h[i].context === c)) {
                        h.splice(i, 1);
                    }
                }
            }
        }
        return this;
    },
    fireEvent: function(a, b) {
        if (!this.hasEventListeners(a)) {
            return this;
        }
        var c = PP.Utils.extend({
            type: a,
            target: this
        }, b);
        var d = this[PP_EVENTS_KEY][a].slice();
        for (var e = 0, f = d.length; e < f; e++) {
            try {
                d[e].action.call(d[e].context || this, c);
            } catch (a) {
                if (PP.Errors) {
                    PP.Errors.logErrorObject(a);
                } else {
                    throw new Error("Error calling listener", a);
                }
            }
        }
        return this;
    },
    clearListeners: function() {
        var a = this[PP_EVENTS_KEY], b;
        for (var b in a) {
            if (a.hasOwnProperty(b)) {
                delete a[b];
            }
        }
    },
    removeAllListeners: function() {
        this.clearListeners();
    }
};

PP.Events.on = PP.Events.addEventListener;

PP.Events.un = PP.Events.removeEventListener;

PP.Events.fire = PP.Events.fireEvent;

PP._Features = PP.Class.extend({
    getPaperReferences: function() {
        return false;
    },
    mobileView: function() {
        return false;
    }
});

PP.Features = new PP._Features();

PP._Globals = PP.Class.extend({
    flags: {
        noPdfSupport: true
    },
    getMaxSyncFileSize: function() {
        return 1024 * 1024 * 20;
    },
    getWindowId: function() {
        return window.PP_WINDOW_ID;
    },
    hasNoUserInfo: function() {
        var a = PP.Session.get("user_id");
        return !a;
    },
    isTestEnvironment: function() {
        return this.getWindowId() === "test";
    },
    isContentScript: function() {
        return this.getWindowId() === "cs";
    },
    isAttachmentContentScript: function() {
        return this.getWindowId() === "attach";
    },
    isPopupView: function() {
        return this.getWindowId() === "pop";
    },
    isBackgroundPage: function() {
        return this.getWindowId() === "bg";
    },
    isDocAddOn: function() {
        return this.getWindowId() === "addon";
    },
    isWebApp: function() {
        return this.getWindowId() === "webapp";
    },
    isDocsPlugin: function() {
        return this.getWindowId() === "write";
    },
    isUploadIframe: function() {
        return this.getWindowId() === "upload";
    },
    isPdfIframe: function() {
        return this.getWindowId() === "pdfIframe";
    },
    isDev: function() {
        if (window.PP_EXTENSION_VERSION == "0") {
            return true;
        } else {
            return false;
        }
    },
    isStaging: function() {
        var a = this.getUrlBase();
        if (!this.isDev() && a.match(/stage/i)) {
            return true;
        } else {
            return false;
        }
    },
    isProduction: function() {
        return !this.isDev() && !this.isStaging();
    },
    isChrome: function() {
        var a = navigator.userAgent;
        var b = this.getOS();
        if (a.match(/chrome/i) && b !== "Android") {
            return true;
        } else {
            return false;
        }
    },
    getOS: function() {
        var a = "Unknown OS";
        if (navigator.appVersion.indexOf("Win") != -1) {
            a = "Windows";
        }
        if (navigator.appVersion.indexOf("Mac") != -1) {
            a = "MacOS";
        }
        if (navigator.appVersion.indexOf("CrOS") != -1) {
            a = "ChromeOS";
        } else if (navigator.appVersion.indexOf("X11") != -1) {
            a = "UNIX";
        }
        if (navigator.appVersion.indexOf("Linux") != -1) {
            a = "Linux";
        }
        if (navigator.appVersion.indexOf("Android") != -1) {
            a = "Android";
        }
        return a;
    },
    isLinux: function() {
        var a = this.getOS();
        return a === "Linux";
    },
    isMac: function() {
        var a = this.getOS();
        return a === "MacOS";
    },
    isWindows: function() {
        var a = this.getOS();
        return a === "Windows";
    },
    isChromeOS: function() {
        var a = this.getOS();
        return a === "ChromeOS";
    },
    getUrlBase: function() {
        var a = "https://stage.paperpile.com";
        if (window.location && window.location.href) {
            var b = window.location.href;
            if (b.match(/stage\.paperpile\.com/i)) {
                return a;
            }
        }
        if (window.chrome && window.chrome.extension) {
            var c = chrome.extension.getURL("");
            if (c.match(/ohdohjbmdpjmodcjkknnepbnbbmkmkcb/i)) {
                return a;
            }
        }
        return window.PP_URL_BASE;
    },
    url: function(a) {
        a = a.replace(/^\//, "");
        var b = this.getUrlBase();
        if (!b) {
            console.error("  Error: no server URL base!");
            return null;
        }
        a = b + "/" + a;
        return a;
    },
    getSharedFolderLink: function(a) {
        var b = a.alias;
        if (!b) {
            b = a._id;
        }
        var c = PP.Globals.getUrlBase();
        return c + "/shared/" + b;
    },
    getPubViewAttachmentUrl: function(a) {
        return PP.library.Attachment.getPubViewAttachmentUrl(a);
    },
    getSharedAttachmentUrl: function(a, b) {
        return PP.library.Attachment.getSharedAttachmentUrl(a, b);
    }
});

createSingleton(PP, "_Globals", "Globals");

PP._Licensing = PP.Class.extend({
    licenseTrialDaysLeft: function(a) {
        if (!a.license_trial_ends) {
            a.license_trial_ends = Date.now() / 1e3;
        }
        var b = new Date();
        var c = new Date(a.license_trial_ends * 1e3);
        var d = c.getTime() - b.getTime();
        var e = Math.ceil(d / (1e3 * 60 * 60 * 24));
        return e;
    },
    licenseStatus: function(a) {
        if (PP.TestFlags.testExpiredLicense()) {
            return "trial-expired";
        }
        if (a.license_forever_free) {
            return "active";
        }
        if (a.site !== "personal" && a.site_verified_date > 0) {
            return "active";
        }
        if (a.license_grace_period_ends) {
            if (a.license_grace_period_ends * 1e3 > Date.now()) {
                return "active";
            }
        }
        if (a.license_id) {
            if (a.license_seat_type === "free") {
                return "active";
            }
            if (a.subscription && a.subscription.status === "active") {
                return "active";
            }
            if (a.subscription && a.subscription.current_period_end) {
                if (a.subscription.current_period_end * 1e3 > Date.now()) {
                    return "active";
                }
            }
            return "inactive";
        } else {
            if (this.licenseTrialDaysLeft(a) <= 0) {
                return "trial-expired";
            } else {
                return "trial-active";
            }
        }
    },
    getShortStatusString: function(a) {
        if (PP.TestFlags.testExpiredLicense()) {
            return "Your trial has expired";
        }
        var b = this.licenseStatus(a);
        if (b == "trial-active") {
            var c = this.licenseTrialDaysLeft(a);
            return "Your trial has " + c + " day(s) remaining";
        } else if (b == "trial-expired") {
            return "Your trial has expired";
        } else if (b == "inactive") {
            return "Your license has expired";
        } else if (b == "active") {
            return "You have an active license";
        }
    },
    isInGoodStanding: function(a) {
        if (PP.TestFlags.testExpiredLicense()) {
            return false;
        }
        var b = this.licenseStatus(a);
        if (b == "active" || b == "trial-active") {
            return true;
        } else {
            return false;
        }
    }
});

createSingleton(PP, "_Licensing", "Licensing");

PP.Messenger = PP.Class.extend({
    includes: [ PP.Events ],
    passSelfMessages: false,
    logMessages: false,
    debug: false,
    disabled: false,
    initialize: function() {
        this.ports = {};
        this.portsTimesReconnected = {};
        this.callbacks = {};
        this.receiptExpected = {};
        this.receiptTimeout = {};
        this.timeouts = {};
        this.persistentPorts = {};
        this.listening = false;
        this.listenForCallbacks = true;
    },
    disableAllMessaging: function() {
        this.disabled = true;
    },
    handleAppFunctionMessages: function(a) {
        var b = this;
        b.on("message", function(c) {
            var d = c.msg;
            if (d.fn) {
                if (!a[d.fn]) {
                    b.c.log([ "No app function", d.fn ]);
                } else {
                    if (d.args === undefined) {
                        d.args = [];
                    } else if (!PP.Utils.isArray(d.args)) {
                        d.args = [ d.args ];
                    }
                    var e = PP.Utils.clone(d.args);
                    delete d.args;
                    e.push(d);
                    b.c.log("Calling fn", d.fn, "with args", e);
                    PP.Utils.callback(a[d.fn], a, e);
                }
            }
        });
    },
    getId: function() {
        return window.PP_WINDOW_ID;
    },
    connectPort: function(a, b) {
        if (this.ports[a]) {
            console.error("  already have a port by the name " + a + " - not connecting!");
            return;
        }
        this.c.log("Trying to connect to port " + a);
        if (typeof window.chrome !== "undefined" && chrome.runtime && chrome.runtime.onConnect) {
            var c;
            try {
                c = chrome.runtime.connect(chrome.runtime.id, {
                    name: a
                });
            } catch (a) {
                this.c.log(a);
            }
            if (c) {
                this._listenConnect(c);
                if (b === true) {
                    this.persistentPorts[a] = true;
                }
                return true;
            } else {
                this.c.log("Failed to connect to port ", a);
            }
        } else {
            this.c.error("Can't connect port: not running as a Chrome extension!");
        }
        return false;
    },
    listen: function() {
        if (typeof window.chrome !== "undefined" && chrome.runtime && chrome.runtime.onConnect && !this.listening) {
            this.listening = true;
            chrome.runtime.onConnect.addListener(PP.Utils.bind(this._listenConnect, this));
        }
    },
    listenPost: function() {
        var a = new Date().getTime();
        window._postListener = PP.Utils.bind(this.onPostMessage, this, [ a ]);
        window.addEventListener("message", window._postListener, false);
    },
    stopListenPost: function() {
        window.removeEventListener("message", window._postListener, false);
    },
    listenForSingleMessages: function() {
        var a = this;
        chrome.runtime.onMessage.addListener(function(b, c, d) {
            var e = {};
            console.log("Heard one-off message", b, c);
            PP.Utils.apply(e, b);
            e.tab = c.tab;
            a._onMessage(e);
        });
    },
    onPostMessage: function(a, b) {
        if (this.destroyed) {
            return;
        }
        var c = a.data;
        this._onMessage(c);
    },
    _onMessage: function(a) {
        if (a.targetId !== undefined) {
            if (a.targetId !== this.getId()) {
                return;
            }
        }
        if (a.fromOutsideExtension && !a.tab) {
            if (!this.passSelfMessages) {
                return;
            }
        } else {}
        if (!PP.Utils.isObject(a)) {
            console.log("Extension message is not an object", a);
            return;
        }
        var b = Object.keys(a);
        var c = "[" + PP.Utils.ellipsis(b.join(", "), 150, null, "") + "]";
        if (a.fn) {
            c += ', app function "' + a.fn + '"';
        }
        if (this.logMessages) {
            if (a.crudResponse) {}
            console.log("<\tmsg " + c + " from " + a.source);
        }
        if (this.listenForCallbacks && a.isCallbackResponse) {
            var d = a.callbackId;
            var e = a.callbackArgs;
            if (this.callbacks[d]) {
                PP.Utils.callback(this.callbacks[d], this, e);
                delete this.callbacks[d];
                var f = this.timeouts[d];
                if (f) {
                    window.clearTimeout(f);
                    delete this.timeouts[a.callbackId];
                }
                this.clearLoadingMessage();
            } else {
                this.c.log("CALLBACK NOT FOUND", d);
            }
            return;
        }
        this.fire("message", {
            msg: a
        });
    },
    clearLoadingMessage: function() {
        if (this.loadingMessageTimeout) {
            window.clearTimeout(this.loadingMessageTimeout);
            delete this.loadingMessageTimeout;
        }
        if (this.loadingMessageObject) {
            PP.backend.Utils.clearLoadingMessage(this.loadingMessageObject);
            delete this.loadingMessageObject;
        }
    },
    onMessage: function(a, b) {
        if (this.destroyed) {
            return;
        }
        if (a) {
            var c = b.name;
            if (a.requestReceipt) {
                this.c.log("Got message with requested receipt", a.requestReceipt);
                b.postMessage({
                    sendReceipt: a.requestReceipt
                });
            }
            if (a.sendReceipt) {
                this.c.log("Got receipt with id and clear timeout", a.sendReceipt, this.receiptExpected[c]);
                if (a.sendReceipt === this.receiptExpected[c]) {
                    this.c.log("Clearing receipt timeout", this.receiptTimeout[c]);
                    window.clearTimeout(this.receiptTimeout[c]);
                    this.receiptExpected[c] = null;
                    this.receiptTimeout[c] = null;
                }
            }
        }
        if (b.sender) {
            a.tab = b.sender.tab;
        }
        this._onMessage(a);
    },
    callback: function(a, b) {
        if (!PP.Utils.isArray(b)) {
            b = [ b ];
        }
        var c = {
            isCallbackResponse: true,
            callbackId: a.callbackId,
            callbackArgs: b
        };
        this.sendMessage(c);
    },
    sendMessage: function(a) {
        var b = this;
        if (this.destroyed) {
            return;
        }
        if (this.disabled === true) {
            return;
        }
        if (!a.source) {
            a.source = this.getId();
        }
        a.isFromPaperpile = true;
        if (!this.guid) {
            this.guid = PP.UUID.generate();
        }
        a.source_guid = this.guid;
        if (a.callback) {
            if (a.loadingMessage) {
                var b = this;
                var c = a.loadingMessageDelay || 1e3;
                this.loadingMessageTimeout = window.setTimeout(function() {
                    b.loadingMessageObject = PP.backend.Utils.showLoadingMessage(a.loadingMessage);
                }, c);
            }
            var d = PP.UUID.generate();
            var e = a.callback;
            this.callbacks[d] = e;
            delete a.callback;
            a.callbackId = d;
            if (a.timeout) {
                var f = PP.Utils.bind(function() {
                    this.clearLoadingMessage();
                    PP.Utils.callback(e, this, [ null, "Callback timed out." ]);
                }, this);
                var g = window.setTimeout(f, a.timeout);
                delete a.timeout;
                this.timeouts[d] = g;
            }
        }
        if (typeof window.chrome === "undefined" || !chrome.runtime || !chrome.runtime.getManifest) {
            a.fromOutsideExtension = true;
            this.sendPostMessage(a);
            var h = Object.keys(a);
            if (a.crudResponse) {}
            var i = "[" + PP.Utils.ellipsis(h.join(", "), 150, null, "") + "]";
            if (this.logMessages) {}
            return;
        }
        if (a.targetTab !== undefined) {
            for (var j in this.ports) {
                if (this.ports.hasOwnProperty(j)) {
                    var k = this.ports[j];
                    if (k.sender && k.sender.tab && k.sender.tab.id === a.targetTab) {
                        this.c.log("--> Sending msg", a, "to target tab: ", a.targetTab);
                        this._addReceiptTimeout(k, a);
                        k.postMessage(a);
                    }
                }
            }
        } else {
            var l = false;
            for (var j in this.ports) {
                if (this.ports.hasOwnProperty(j)) {
                    l = true;
                    var k = this.ports[j];
                    j = PP.Utils.ellipsis(j, -30, null, "");
                    var h = Object.keys(a);
                    var i = "[" + PP.Utils.ellipsis(h.join(", "), 150, null, "") + "]";
                    if (a.fn) {
                        i += ', app function "' + a.fn + '"';
                    }
                    if (this.logMessages) {
                        console.log(" >\tmsg " + i + " to port " + j);
                    }
                    this._addReceiptTimeout(k, a);
                    k.postMessage(a);
                }
            }
        }
        if (!l) {
            if (a.source && a.source == "webapp") {
                if (!a.backgroundPing) {
                    b.fire("disconnect", {
                        portName: "background-dummy",
                        info: "port disconnected; no ports available"
                    });
                }
            }
        }
    },
    _addReceiptTimeout: function(a, b) {
        var c = this;
        var d = a.name;
        if (!this.receiptExpected[d] && PP.Msg.getId() !== "bg") {
            c.receiptExpected[d] = PP.UUID.generate();
            c.receiptTimeout[d] = window.setTimeout(function() {
                c.c.log("Did not get response for", c.receiptExpected[d], b, d);
                c.reconnect(d, b);
                c.receiptExpected[d] = null;
                c.receiptTimeout[d] = null;
            }, 1e3);
            b.requestReceipt = c.receiptExpected[d];
            c.c.log("Setting up receipt timeout", c.receiptTimeout[d], b.requestReceipt);
        }
    },
    sendPostMessage: function(a) {
        if (!a.source) {
            a.source = this.getId();
        }
        a.isFromPaperpile = true;
        if (window.isWorker) {
            postMessage(a);
        } else {
            window.postMessage(a, "*");
        }
    },
    _listenConnect: function(a) {
        var b = this;
        this.ports[a.name] = a;
        if (!(a.name in b.portsTimesReconnected)) {
            b.portsTimesReconnected[a.name] = 0;
        }
        for (var c in this.ports) {
            this.c.log("  [port summary ]" + c);
        }
        var d = PP.Utils.bind(this.onMessage, this, [ a ]);
        var e = a.name;
        var f = function(a) {
            delete b.ports[e];
            b.c.log("Port disconnected ", e);
            if (window._postListener) {}
            var c = true;
            if (b.persistentPorts[e]) {
                if (e in b.portsTimesReconnected && b.portsTimesReconnected[e] < 3) {
                    c = false;
                    b.portsTimesReconnected[e]++;
                    console.log("Disconnect from port received. Trying to reconnect persistent port " + e + " for the " + b.portsTimesReconnected[e] + " time");
                    b.reconnect(e, null, 500);
                }
            }
            if (c) {
                b.fire("disconnect", {
                    portName: e,
                    info: "port disconnected; tried 3 times to reconnect"
                });
            }
        };
        a.onMessage.addListener(d);
        a.onDisconnect.addListener(f);
        this.fire("connect", {
            port: a
        });
        this.c.log("Port successfully connected ", e);
    },
    reconnect: function(a, b, c) {
        if (c === null || c === undefined) {
            c = 100;
        }
        var d = this;
        delete this.ports[a];
        PP.Utils.defer(function() {
            var c = d.connectPort(a, true);
            if (!c) {
                d.fire("lost_connection", {
                    portName: a
                });
            } else {
                d.c.log("Connected again to port", a);
                d.fire("reconnected", {
                    portName: a
                });
                if (b) {
                    d.sendMessage(b);
                }
            }
        }, c);
    },
    old_reconnect: function(a, b) {
        var c = this;
        if (b === undefined) {
            b = {
                retryCount: 0,
                delay: 250
            };
        }
        if (c.ports[a]) {
            c.c.log("  reconnected to port ", a, " -- stopping reconnect loop!");
            return;
        }
        if (b.retryCount === 5) {
            c.fire("lost_connection", {
                portName: a
            });
        }
        if (b.retryCount > 10) {
            c.c.log("  taking a long time to reconnect... maybe it's really gone");
        } else {
            c.c.log("  reconnection try #", b.retryCount);
        }
        PP.Utils.defer(function() {
            b.retryCount += 1;
            b.delay *= 2;
            var d = c.connectPort(a, true);
            if (!d) {
                c.reconnect(a, b);
            } else {
                c.c.log("  Connected again to port", a);
            }
        }, b.delay);
    },
    destroy: function() {
        this.destroyed = true;
    }
});

createSingleton(PP, "Messenger", "Msg");

PP._Session = PP.Class.extend({
    includes: [ PP.Data, PP.Events ],
    debug: false,
    fields: [ {
        name: "user_id"
    }, {
        name: "google_id"
    }, {
        name: "google_name"
    }, {
        name: "google_email"
    }, {
        name: "google_access_token"
    }, {
        name: "server_url_base"
    } ],
    get: function(a) {
        var b = PP.Data.get.call(this, a);
        if (a === "user_id" && !b) {}
        return b;
    },
    isLoaded: function() {
        return this.hasUserId();
    },
    load: function() {
        if (!this.isLoaded()) {
            this.loadFromDom();
            if (!this.isLoaded()) {
                if (!this.isLoaded()) {
                    this.loadFromServer();
                    if (!this.isLoaded()) {
                        PP.Utils.defer(function() {
                            PP.Msg.sendMessage({
                                sessionInfoRequest: true
                            });
                            if (PP.bg && PP.bg.LoginState) {
                                PP.bg.LoginState.pingServer();
                            }
                        }, 1e3);
                    } else {
                        this.c.log("  loaded session from server!");
                    }
                } else {
                    this.c.log("  loaded session from localStorage!");
                }
            } else {
                this.c.log("  loaded session from DOM!");
            }
        }
    },
    loadFromDom: function() {
        (function(a) {
            a.fn.getAttributes = function() {
                var b = {};
                if (!this.length) return this;
                a.each(this[0].attributes, function(a, c) {
                    b[c.name] = c.value;
                });
                return b;
            };
        })(jQuery);
        $(PP.Utils.bind(function() {
            var a = $("#pp-session");
            if (a.length === 1) {
                var b = a.getAttributes();
                delete b["id"];
                this.apply(b);
            }
        }, this));
    },
    loadFromServer: function() {
        var a = this;
        PP.Ajax.request({
            url: PP.Globals.url("/ajax/app/ping"),
            callback: function(b, c, d) {
                if (b.session) {
                    a.apply(b.session);
                    a.fire("update");
                }
            }
        });
    },
    initialize: function() {
        PP.Msg.on("message", this.onMessage, this);
    },
    broadcastSession: function() {
        var a = this.serialize();
        PP.Msg.sendMessage({
            session: a
        });
    },
    onMessage: function(a) {
        var b = a.msg;
        if (b.session) {
            this.c.log("  loading session from message!");
            this.loadFromMessage(b);
        }
        if (b.clearSession) {
            this.c.log("  Clearing session from message!");
            this.clear();
        }
        if (b.sessionInfoRequest) {
            if (this.hasUserId()) {
                PP.Msg.sendMessage({
                    targetId: b.source,
                    session: this.serialize()
                });
            }
        }
    },
    doWhenReady: function(a) {
        if (this.isLoaded()) {
            a.call(this);
        } else {
            this.on("ready", a);
            this.load();
        }
    },
    getStorageKey: function() {
        return "PP.Session";
    },
    hasUserId: function() {
        return this["user_id"] !== undefined;
    },
    loadFromMessage: function(a) {
        this.apply(a.session);
        this.fire("update");
    },
    clear: function() {
        this.clearLocalStorage();
        var a = this.fields;
        for (var b = 0; b < a.length; b++) {
            var c = a[b].name;
            this.set(c, null);
        }
        this.c.log("  cleared Session:", this.serialize());
        this.fire("clear");
    },
    apply: function(a) {
        var b = this["user_id"];
        PP.Data.apply.call(this, a);
        var c = this["user_id"];
        if (b === undefined && c !== undefined) {
            this.fire("ready");
        } else if (b && c && b !== c) {
            this.fire("newid");
            this.c.log("  new session user ID!");
        } else if (c === undefined) {}
        if (c !== undefined) {
            this.saveToLocalStorage();
        }
    }
});

createSingleton(PP, "_Session", "Session");

PP._String = PP.Class.extend({
    truncate: function(a, b, c) {
        var d = {}, e = "", f = [ "img" ], g = [], h = 0, i = e, j = '(\\w+\\s*=\\s*"[^"]*"\\s*)*', k = "\\s*\\/?\\s*", l = "\\s*\\/\\s*", m = new RegExp("<\\/?\\w+\\s*" + j + l + ">"), n = new RegExp("<\\/?\\w+\\s*" + j + k + ">"), o = new RegExp("<img\\s*" + j + k + ">"), p = true, q, r, s, t, u;
        var v = function(a) {
            var b = o.exec(a), c, d;
            if (!b) {
                return a;
            }
            c = b.index;
            d = b[0].length;
            return a.substring(0, c) + a.substring(c + d);
        };
        var w = function(a) {
            var b = "";
            a.reverse().forEach(function(a, c) {
                if (-1 === f.indexOf(a)) {
                    b += "</" + a + ">";
                }
            });
            return b;
        };
        var x = function(a) {
            var b = a.indexOf(" ");
            if (-1 === b) {
                b = a.indexOf(">");
                if (-1 === b) {
                    console.log("HTML tag is not well-formed : " + a);
                }
            }
            return a.substring(1, b);
        };
        c = c || d;
        c.ellipsis = c.ellipsis || "...";
        while (p) {
            p = n.exec(a);
            if (!p) {
                if (h < b) {
                    i += a.substring(0, b - h);
                }
                break;
            }
            q = p[0];
            r = p.index;
            if (h + r > b) {
                i += a.substring(0, b - h);
                break;
            } else {
                h += r;
                i += a.substring(0, r);
            }
            if ("/" === q[1]) {
                g.pop();
            } else {
                u = m.exec(q);
                if (!u) {
                    t = x(q);
                    g.push(t);
                }
            }
            if (u) {
                i += u[0];
            } else {
                i += q;
            }
            a = a.substring(r + q.length);
        }
        if (a.length > b && c.ellipsis) {
            i += c.ellipsis;
        }
        i += w(g);
        if (!c.keepImageTag) {
            i = v(i);
        }
        return i;
    },
    stripHtml: function(a, b) {
        if (a === undefined) return "";
        var c = {
            replacement: "",
            exclude: []
        };
        PP.Utils.apply(c, b || {});
        var d = [ a ];
        if (c.exclude.length > 0) {
            d = [];
            for (var e = 0; e < c.exclude.length; e++) {
                d.push("<" + c.exclude[e] + "[^>]*>");
                d.push("<\\/" + c.exclude[e] + "[^>]*>");
            }
            var f = "(" + d.join("|") + ")";
            d = a.split(new RegExp(f, ""));
        }
        for (var e = 0; e < d.length; e += 2) {
            d[e] = d[e].replace(/<(?:.|\n)*?>/gm, c.replacement);
        }
        return d.join("");
    },
    escapeBraces: function(a) {
        a = a || "";
        var b = a.split("");
        for (var c = 0; c < b.length; c++) {
            if (b[c] === "{" || b[c] === "}") {
                if (c > 0) {
                    if (b[c - 1] !== "\\") {
                        b[c] = "\\" + b[c];
                    }
                } else {
                    b[c] = "\\" + b[c];
                }
            }
        }
        return b.join("");
    },
    htmlToPlainText: function(a) {
        if (a === undefined) return "";
        a = a.replace(/<br\/>/g, "\n");
        a = this.stripHtml(a, {
            replacement: "",
            exclude: []
        });
        a = $("<div/>").html(a).text();
        return a;
    },
    upperFirst: function(a) {
        a = a.charAt(0).toUpperCase() + a.substr(1);
        return a;
    },
    _stripBracesMarkup: function(a) {
        var b = a.split("");
        for (var c = 0; c < b.length; c++) {
            if (b[c] === "{" || b[c] === "}") {
                if (c > 0) {
                    if (b[c - 1] === "\\") {
                        b[c - 1] = "";
                    } else {
                        b[c] = "";
                    }
                } else {
                    b[c] = "";
                }
            }
        }
        return b.join("");
    },
    toTitleCase: function(a) {
        if (!a) return "";
        var b = [];
        b = b.concat([ "the", "a", "an", "some" ]);
        b = b.concat([ "as", "because", "for", "and", "nor", "but", "or", "yet", "so" ]);
        b = b.concat([ "a", "abaft", "aboard", "about", "above", "absent", "across", "afore", "after", "against", "along", "alongside", "amid", "amidst", "among", "amongst", "an", "apropos", "apud", "around", "as", "aside", "astride", "at", "athwart", "atop", "barring", "before", "behind", "below", "beneath", "beside", "besides", "between", "beyond", "but", "by", "circa", "concerning", "despite", "down", "during", "except", "excluding", "failing", "following", "for", "forenenst", "from", "given", "in", "including", "inside", "into", "like", "mid", "midst", "minus", "modulo", "near", "next", "notwithstanding", "o'", "of", "off", "on", "onto", "opposite", "out", "outside", "over", "pace", "past", "per", "plus", "pro", "qua", "regarding", "round", "sans", "save", "since", "than", "through", "throughout", "thru", "thruout", "till", "times", "to", "toward", "towards", "under", "underneath", "unlike", "until", "unto", "up", "upon", "versus", "via", "vice", "vis-\xe0-vis", "with", "within", "without", "worth" ]);
        a = a.split(/([\t\r\n\s])+/);
        for (var c = 0; c < a.length; c++) {
            if (!a[c].match(/[\t\r\n\s]/)) {
                a[c] = a[c].toLowerCase();
                if (b.indexOf(a[c]) == -1 || c === 0) {
                    var d = a[c].split(/(-)/);
                    for (var e = 0; e < d.length; e++) {
                        d[e] = d[e].charAt(0).toUpperCase() + d[e].substr(1).toLowerCase();
                    }
                    a[c] = d.join("");
                }
            }
        }
        a = a.join("");
        a = a.replace(/\b(rna|dna|usa|hiv)/gi, function(a) {
            return a.toUpperCase();
        });
        return a;
    },
    interconvertString: function(a, b) {
        var c = this;
        var d = {
            format: "plain"
        };
        PP.Utils.apply(d, b || {});
        var e = a || "";
        if (d.format === "nomarkup") {
            e = this._stripBracesMarkup(e);
            e = e.replace(/\\(textit|textbf|emph)/g, "");
            e = e.replace(/<(i|b|sub|sup)>/g, "");
            e = e.replace(/<\/(i|b|sub|sup)>/g, "");
        } else if (d.format === "html") {
            var f = new RegExp("(.*)(\\\\(?:textit|textbf|emph)\\{)(.*)", "g");
            var g;
            var h = 0;
            while ((g = f.exec(e)) !== null) {
                if (h++ > 100) break;
                if (g[3]) {
                    var i = g[2].match(/(textit|emph)/) ? "i" : "b";
                    var j = g[3].split("");
                    var k = 1;
                    var l = 0;
                    var m = 0;
                    for (var n = 0; n < j.length; n++) {
                        if (j[n] === "{") k++;
                        if (j[n] === "}") {
                            l++;
                            if (l == k) {
                                j[n] = "</" + i + ">";
                                g[2] = "<" + i + ">";
                                m = 1;
                                break;
                            }
                        }
                    }
                    if (m == 0) {
                        g[2] = "";
                    }
                    g[3] = j.join("");
                    e = g[1] + g[2] + g[3];
                    f.lastIndex = 0;
                }
            }
            var j = e.split(/(\$)/);
            for (var o = 0; o < j.length; o++) {
                if (j[o] == "$") {
                    if (j[o + 2] == "$") {
                        if (j[o + 1].match(/^_\{([^\}\{]+)\}$/)) {
                            j[o] = "<sub>";
                            j[o + 1] = RegExp.$1;
                            j[o + 2] = "</sub>";
                        } else if (j[o + 1].match(/^_(.)$/)) {
                            j[o] = "<sub>";
                            j[o + 1] = RegExp.$1;
                            j[o + 2] = "</sub>";
                        } else if (j[o + 1].match(/^\^\{([^\}\{]+)\}$/)) {
                            j[o] = "<sup>";
                            j[o + 1] = RegExp.$1;
                            j[o + 2] = "</sup>";
                        } else if (j[o + 1].match(/^\^(.)$/)) {
                            j[o] = "<sup>";
                            j[o + 1] = RegExp.$1;
                            j[o + 2] = "</sup>";
                        } else if (j[o + 1].match(/^(\\[a-z]+)$/i)) {
                            if (RegExp.$1 in c.latexUnicodeMath) {
                                j[o] = "";
                                j[o + 1] = c.latexUnicodeMath[RegExp.$1];
                                j[o + 2] = "";
                            }
                        } else if (j[o + 1].match(/^[^\\]+$/i)) {
                            j[o] = "";
                            j[o + 2] = "";
                        }
                    }
                }
            }
            e = j.join("");
            e = this._stripBracesMarkup(e);
        } else if (d.format === "bibtex") {
            var f = new RegExp("(.*)(<\\/?(?:i|b|sub|sup)>)(.*)", "g");
            var g;
            var h = 0;
            while ((g = f.exec(e)) !== null) {
                if (h++ > 100) break;
                if (g[2]) {
                    if (g[2].match(/\//)) {
                        if (g[2].match(/(sub|sup)/)) {
                            g[2] = "}$";
                        } else {
                            g[2] = "}";
                        }
                    } else {
                        if (g[2].match(/<\s*b\s*>/)) {
                            g[2] = "\\textbf{";
                        } else if (g[2].match(/<\s*i\s*>/)) {
                            g[2] = "\\textit{";
                        } else if (g[2].match(/sub/)) {
                            g[2] = "$_{";
                        } else if (g[2].match(/sup/)) {
                            g[2] = "$^{";
                        }
                    }
                }
                e = g[1] + g[2];
                if (g[3]) e += g[3];
                f.lastIndex = 0;
            }
            e = e.replace(/&lt;/g, "<");
            e = e.replace(/&gt;/g, ">");
            e = e.replace(/&amp;/g, "&");
        }
        return e;
    },
    removeControlChars: function(a) {
        a = a || "";
        a = a.replace(/\r\n/g, "\n");
        a = a.replace(/\r/g, "\n");
        a = a.replace(/[\x00-\x08\x0B-\x1F\x7F]/g, "");
        return a;
    },
    latexUnicodeASCII_1: {
        "'": {
            A: "\xc1",
            C: "\u0106",
            E: "\xc9",
            I: "\xcd",
            L: "\u0139",
            N: "\u0143",
            O: "\xd3",
            R: "\u0154",
            S: "\u015a",
            U: "\xda",
            Y: "\xdd",
            Z: "\u0179",
            a: "\xe1",
            c: "\u0107",
            e: "\xe9",
            g: "\u01f5",
            "\\i": "\xed",
            l: "\u013a",
            n: "\u0144",
            o: "\xf3",
            r: "\u0155",
            s: "\u015b",
            u: "\xfa",
            y: "\xfd",
            z: "\u017a"
        },
        "`": {
            A: "\xc0",
            E: "\xc8",
            I: "\xcc",
            O: "\xd2",
            U: "\xd9",
            a: "\xe0",
            e: "\xe8",
            "\\i": "\xec",
            o: "\xf2",
            u: "\xf9"
        },
        '"': {
            A: "\xc4",
            E: "\xcb",
            I: "\xcf",
            O: "\xd6",
            U: "\xdc",
            Y: "\u0178",
            a: "\xe4",
            e: "\xeb",
            "\\i": "\xef",
            o: "\xf6",
            u: "\xfc",
            y: "\xff"
        },
        "^": {
            A: "\xc2",
            C: "\u0108",
            E: "\xca",
            G: "\u011c",
            H: "\u0124",
            I: "\xce",
            J: "\u0134",
            O: "\xd4",
            S: "\u015c",
            U: "\xdb",
            W: "\u0174",
            Y: "\u0176",
            a: "\xe2",
            c: "\u0109",
            e: "\xea",
            g: "\u011d",
            h: "\u0125",
            "\\i": "\xee",
            "\\j": "\u0135",
            o: "\xf4",
            s: "\u015d",
            u: "\xfb",
            w: "\u0175",
            y: "\u0177"
        },
        "~": {
            A: "\xc3",
            I: "\u0128",
            N: "\xd1",
            O: "\xd5",
            U: "\u0168",
            a: "\xe3",
            "\\i": "\u0129",
            n: "\xf1",
            o: "\xf5",
            u: "\u0169"
        },
        "=": {
            A: "\u0100",
            E: "\u0112",
            I: "\u012a",
            O: "\u014c",
            U: "\u016a",
            a: "\u0101",
            e: "\u0113",
            "\\i": "\u012b",
            o: "\u014d",
            u: "\u016b"
        },
        ".": {
            C: "\u010a",
            E: "\u0116",
            G: "\u0120",
            I: "\u0130",
            L: "\u013f",
            Z: "\u017b",
            c: "\u010b",
            e: "\u0117",
            g: "\u0121",
            l: "\u0140",
            z: "\u017c"
        },
        H: {
            O: "\u0150",
            U: "\u0170",
            o: "\u0151",
            u: "\u0171"
        },
        c: {
            C: "\xc7",
            G: "\u0122",
            K: "\u0136",
            L: "\u013b",
            N: "\u0145",
            R: "\u0156",
            S: "\u015e",
            T: "\u0162",
            c: "\xe7",
            g: "\u0123",
            k: "\u0137",
            l: "\u013c",
            n: "\u0146",
            r: "\u0157",
            s: "\u015f",
            t: "\u0163"
        },
        k: {
            A: "\u0104",
            E: "\u0118",
            I: "\u012e",
            U: "\u0172",
            a: "\u0105",
            e: "\u0119",
            i: "\u012f",
            u: "\u0173"
        },
        r: {
            U: "\u016e",
            u: "\u016f"
        },
        u: {
            A: "\u0102",
            E: "\u0114",
            G: "\u011e",
            I: "\u012c",
            O: "\u014e",
            U: "\u016c",
            a: "\u0103",
            e: "\u0115",
            g: "\u011f",
            "\\i": "\u012d",
            o: "\u014f",
            u: "\u016d"
        },
        v: {
            C: "\u010c",
            D: "\u010e",
            E: "\u011a",
            L: "\u013d",
            N: "\u0147",
            R: "\u0158",
            S: "\u0160",
            T: "\u0164",
            Z: "\u017d",
            c: "\u010d",
            d: "\u010f",
            e: "\u011b",
            l: "\u013e",
            n: "\u0148",
            r: "\u0159",
            s: "\u0161",
            t: "\u0165",
            z: "\u017e"
        }
    },
    latexUnicodeASCII_2: {
        AA: "\xc5",
        AE: "\xc6",
        DH: "\xd0",
        DJ: "\u0110",
        L: "\u0141",
        NG: "\u014a",
        O: "\xd8",
        OE: "\u0152",
        TH: "\xde",
        aa: "\xe5",
        ae: "\xe6",
        dh: "\xf0",
        dj: "\u0111",
        i: "\u0131",
        l: "\u0142",
        ng: "\u014b",
        o: "\xf8",
        oe: "\u0153",
        ss: "\xdf",
        th: "\xfe"
    },
    latexUnicodeASCII_3: {
        "\\pounds": "\xa3",
        "\\texttimes": "\xd7",
        "\\copyright": "\xa9",
        "\\textasciimacron": "\xaf",
        "\\textcent": "\xa2",
        "\\textregistered": "\xae",
        "\\?\\`": "\xbf",
        "\\!\\`": "\xa1",
        "--": "\u2013",
        "---": "\u2014"
    },
    latexUnicodeASCII_4: {
        "\\texttildelow": "~",
        "\\textdollar": "$",
        "\\textunderscore": "_",
        "\\textbackslash": "\\",
        "\\backslash": "\\",
        "\\%": "%",
        "\\$": "$",
        "\\&": "&",
        "\\#": "#",
        "\\_": "_"
    },
    latexUnicodeMath: {
        A: "\u0391",
        B: "\u0392",
        "\\Gamma": "\u0393",
        "\\Delta": "\u0394",
        E: "\u0395",
        Z: "\u0396",
        H: "\u0397",
        "\\Theta": "\u0398",
        I: "\u0399",
        K: "\u039a",
        "\\Lambda": "\u039b",
        M: "\u039c",
        N: "\u039d",
        "\\Xi": "\u039e",
        O: "\u039f",
        "\\Pi": "\u03a0",
        P: "\u03a1",
        "\\Sigma": "\u03a3",
        T: "\u03a4",
        "\\Upsilon": "\u03a5",
        "\\Phi": "\u03a6",
        X: "\u03a7",
        "\\Psi": "\u03a8",
        "\\Omega": "\u03a9",
        "\\alpha": "\u03b1",
        "\\beta": "\u03b2",
        "\\gamma": "\u03b3",
        "\\delta": "\u03b4",
        "\\varepsilon": "\u03b5",
        "\\epsilon": "\u03b5",
        "\\zeta": "\u03b6",
        "\\eta": "\u03b7",
        "\\theta": "\u03b8",
        "\\vartheta": "\u03b8",
        "\\iota": "\u03b9",
        "\\kappa": "\u03ba",
        "\\lambda": "\u03bb",
        "\\mu": "\u03bc",
        "\\nu": "\u03bd",
        "\\xi": "\u03be",
        o: "\u03bf",
        "\\pi": "\u03c0",
        "\\varpi": "\u03d6",
        "\\rho": "\u03c1",
        "\\varrho": "\u03f1",
        "\\sigma": "\u03c3",
        "\\varsigma": "\u03c2",
        "\\tau": "\u03c4",
        "\\upsilon": "\u03c5",
        "\\phi": "\u03c6",
        "\\varphi": "\u03c6",
        "\\chi": "\u03c7",
        "\\psi": "\u03c8",
        "\\omega": "\u03c9",
        "\\leq": "\u2264",
        "\\geq": "\u2265",
        "\\in": "\u2208",
        "\\infty": "\u221e",
        "\\int": "\u222b",
        "\\exists": "\u2203",
        "\\forall": "\u2200",
        "\\partial": "\u2202",
        "\\pm": "\xb1",
        "\\prod": "\u220f",
        "\\neg": "\xac",
        "\\neq": "\u2260",
        "\\not\\in": "\u2209",
        "\\times": "\xd7",
        "\\subset": "\u2282",
        "\\sum": "\u2211",
        "\\supset": "\u2283",
        "\\surd": "\u221a",
        "\\approx": "\u2248",
        "\\bot": "\u22a5",
        "\\cap": "\u2229",
        "\\cdot": "\u22c5",
        "\\cup": "\u222a",
        "\\div": "\xf7",
        "\\emptyset": "\u2205",
        "\\equiv": "\u2261",
        "\\to": "\u2192",
        "\\vee": "\u2228",
        "\\wedge": "\u2227",
        "\\Leftrightarrow": "\u21d4",
        "\\Rightarrow": "\u21d2",
        "\\rightarrow": "\u2192"
    },
    _latex2Unicode: function(a) {
        var b;
        var c = this;
        if (a) {
            var d = a.match(/\\(['"\.=H\^`ckruv~])\s*\{*(\\?[A-Z])/i);
            if (d && d.length == 3) {
                if (c.latexUnicodeASCII_1[d[1]] && c.latexUnicodeASCII_1[d[1]][d[2]]) {
                    b = c.latexUnicodeASCII_1[d[1]][d[2]];
                }
            }
            if (!b) {
                d = a.match(/\\([A-Z])\{?([A-Z]?)\}?/i);
                if (d && d.length == 3) {
                    b = c.latexUnicodeASCII_2[d[1] + d[2]];
                }
            }
            if (!b) {
                if (c.latexUnicodeASCII_3[a]) b = c.latexUnicodeASCII_3[a];
            }
            if (!b) {
                if (c.latexUnicodeASCII_4[a]) b = c.latexUnicodeASCII_4[a];
            }
        }
        return b;
    },
    _latexMarkBraces: function(a) {
        var b = {};
        var c;
        if (a) {
            var d = 0;
            var e = 0;
            var f = {};
            var g = a.split(/([\{\}])/);
            var h = -1;
            for (var i = 0; i < g.length; i++) {
                h += g[i].length;
                if (g[i] == "{") {
                    d++;
                    c = true;
                    if (i > 0 && g[i - 1] == "\\") c = false;
                    if (c) {
                        e++;
                        f[e] = d;
                        b[h] = d;
                    }
                } else if (g[i] == "}") {
                    c = true;
                    if (i > 0 && g[i - 1] == "\\") c = false;
                    if (c) {
                        b[h] = f[e];
                        e--;
                        if (e == 0) f = {};
                    }
                }
            }
        }
        return b;
    },
    _latexRemoveBraces: function(a, b) {
        var c = this;
        var d = c._latexMarkBraces(a);
        var e = [];
        var f;
        if (b[1].match(/\{\s*$/) && b[3].match(/^\s*\}/)) {
            var g = -1;
            var h = a.length + 1;
            for (var i in d) {
                f = parseInt(i);
                if (f > g && f < b[1].length) g = f;
                if (f < h && f >= b[1].length + b[2].length) h = f;
            }
            if (g > -1 && d[g] == d[h]) {
                e.push(g);
                e.push(h);
            }
        }
        if (b[2].match(/[\{\}]/)) {
            for (var i in d) {
                f = parseInt(i);
                if (f > b[1].length && f < b[1].length + b[2].length) {
                    for (var j in d) {
                        if (d[j] == d[i]) e.push(parseInt(j));
                    }
                }
            }
        }
        var k = b[1].length;
        var l = b[2].length;
        e.forEach(function(a) {
            if (a >= 0 && a < k) {
                b[1] = b[1].substring(0, a) + b[1].substring(a + 1, k);
            } else if (a >= b[1].length + b[2].length) {
                a = a - b[1].length - b[2].length - 1;
                b[3] = b[3].substring(0, a) + b[3].substring(a + 1, b[3].length);
            }
        });
    },
    _latexSplitByMathEnvironment: function(a) {
        var b = a.split(/(\$[^\$]*\$)/);
        return b;
    },
    _initializeReverseMapping: function() {
        var a = this;
        a.unicodeLatexASCII = {};
        for (var b in a.latexUnicodeASCII_1) {
            for (var c in a.latexUnicodeASCII_1[b]) {
                var d = b.match(/[a-z]/i) ? " " : "";
                a.unicodeLatexASCII[a.latexUnicodeASCII_1[b][c]] = "{\\" + b + d + c + "}";
            }
        }
        for (var b in a.latexUnicodeASCII_2) {
            a.unicodeLatexASCII[a.latexUnicodeASCII_2[b]] = "{\\" + b + "}";
        }
        for (var b in a.latexUnicodeASCII_3) {
            a.unicodeLatexASCII[a.latexUnicodeASCII_3[b]] = b;
            if (b.match(/[a-z]+/)) a.unicodeLatexASCII[a.latexUnicodeASCII_3[b]] += "{}";
        }
        for (var b in a.latexUnicodeMath) {
            a.unicodeLatexASCII[a.latexUnicodeMath[b]] = "$" + b + "$";
        }
    },
    unicode2Latex: function(a) {
        var b = this;
        if (!a) return "";
        if (!b.unicodeLatexASCII) {
            b._initializeReverseMapping();
        }
        var c = b._latexSplitByMathEnvironment(a);
        for (var d = 0; d < c.length; d++) {
            var e = c[d].match(/^\$.*\$$/) ? true : false;
            var f = c[d].split("");
            for (var g = 0; g < f.length; g++) {
                if (f[g] in b.unicodeLatexASCII) {
                    f[g] = b.unicodeLatexASCII[f[g]];
                    if (e) {
                        f[g] = f[g].replace(/\$/g, "");
                        if (g + 1 < f.length) {
                            if (!f[g + 1].match(/[\/\s\$\}\{]/)) {
                                f[g] += "{}";
                            }
                        }
                    }
                }
            }
            c[d] = f.join("");
        }
        a = c.join("");
        return a;
    },
    latex2Unicode: function(a) {
        var b = this;
        if (!a) return "";
        var c = "\\\\['\"\\.=H\\^`ckruv~]\\s*";
        var d = [ new RegExp("(.*)(\\\\(?:%|\\$|&|#|_|\\?\\`|\\!\\`))(.*)", "g"), new RegExp("(.*)(\\\\[a-z][a-z]+)(.*)", "g"), new RegExp("(.*)(" + c + "\\{(?:[A-Za-z]|\\\\i|\\\\j)\\})(.*)", "g"), new RegExp("(.*)(" + c + "(?:[A-Za-z]|\\\\i|\\\\j))(.*)", "g"), new RegExp("(.*)(\\\\(?:A{?A}?|A{?E}?|D{?H}?|D{?J}?|L|N{?G}?|O|O{?E}?|T{?H}?|S{?S}?|a{?a}?|a{?e}?|d{?h}?|d{?j}?|i|j|l|n{?g}?|o|o{?e}?|s{?s}?|t{?h}?|P|S))(.*)", "g") ];
        a = a.replace(/\\\$/g, "\\textdollar");
        var e = b._latexSplitByMathEnvironment(a);
        for (var f = 0; f < e.length; f++) {
            if (e[f].match(/^\$.*\$$/)) continue;
            e[f] = e[f].replace(/\\\'i/g, "\\'\\i{}");
            e[f] = e[f].replace(/\\\'\{i\}/g, "\\'{\\i}");
            var g = {};
            var h = 0;
            d.forEach(function(a) {
                var c = null;
                var d = 0;
                while ((c = a.exec(e[f])) !== null) {
                    d++;
                    if (d > 500) {
                        break;
                    }
                    var i = b._latex2Unicode(c[2]);
                    if (i) {
                        b._latexRemoveBraces(e[f], c);
                    } else {
                        h++;
                        var j = "__82650A8ABPppP__" + h + "__";
                        g[j] = c[2];
                        i = j;
                    }
                    e[f] = c[1] + i + c[3];
                    a.lastIndex = 0;
                }
            });
            for (var i in g) {
                e[f] = e[f].replace(new RegExp(i), g[i]);
            }
            e[f] = e[f].replace(/\{\s*\}/g, "");
        }
        a = e.join("");
        return a;
    }
});

PP.String = new PP._String();

PP._TestFlags = PP.Class.extend({
    failWebImport: function() {
        return false;
    },
    timeoutWebImport: function() {
        return false;
    },
    skipAllGuides: function() {
        return false;
    },
    alwaysShowGuides: function() {
        return false;
    },
    alwaysLoggedOut: function() {
        return false;
    },
    failAttachByUrlDownload: function() {
        return false;
    },
    testExtensionInstallWindow: function() {
        return false;
    },
    testExtensionUpdateWindow: function() {
        return false;
    },
    testNotChromeWindow: function() {
        return false;
    },
    testStatusPanel: function() {
        return false;
    },
    alwaysShowAnnouncements: function() {
        return false;
    },
    triggerExtensionJavascriptErrors: function() {
        return false;
    },
    triggerWebappJavascriptErrors: function() {
        return false;
    },
    triggerContentScriptJavascriptErrors: function() {
        return false;
    },
    testNewUser: function() {
        return false;
    },
    docsTestNotAllowedResponse: function() {
        return false;
    },
    docsTestServerTimeoutResponse: function() {
        return false;
    },
    docsTestFormattingErrorResponse: function() {
        return false;
    },
    filesystemUseLegacyLocalAttachments: function() {
        return false;
    },
    filesystemTestFailedLegacyRemoval: function() {
        return false;
    },
    testContactsAuth: function() {
        return false;
    },
    clearContacts: function() {
        return false;
    },
    testExpiredLicense: function() {
        return false;
    },
    testReadOnlyWebapp: function() {
        return false;
    },
    testMobileWebapp: function() {
        return false;
    },
    testTablet: function() {
        return false;
    },
    testPhone: function() {
        return false;
    },
    testWizardTaskFailures: function() {
        return false;
    },
    testWizardDupsFailure: function() {
        return false;
    },
    testWizardRefreshToken: function() {
        return false;
    },
    testLocalAttachmentNotFoundErrors: function() {
        return false;
    },
    testLocalAttachmentDriveDownloadFailure: function() {
        return false;
    }
});

PP.TestFlags = new PP._TestFlags();

PP.UUID = {
    parts: [],
    salt: {},
    timestamp: {}
};

(function() {
    var a = Math.pow(2, 14), b = Math.pow(2, 16), c = Math.pow(2, 28), d = Math.pow(2, 32);
    function e(a, b, c) {
        var d = String(a);
        c = c || " ";
        while (d.length < b) {
            d = c + d;
        }
        return d;
    }
    function f(a, b) {
        var c = a.toString(16);
        if (c.length > b) {
            c = c.substring(c.length - b);
        } else if (c.length < b) {
            c = e(c, b, "0");
        }
        return c;
    }
    function g(a, b) {
        var c = Math.random() * (b - a + 1);
        return Math.floor(c) + a;
    }
    function h(a) {
        if (typeof a === "number") {
            var b = Math.floor(a / d);
            return {
                lo: Math.floor(a - b * d),
                hi: b
            };
        }
        return a;
    }
    PP.UUID.init = function() {
        var e = this, f, h;
        e.clockSeq = g(0, a - 1);
        f = e.salt || (e.salt = {});
        h = e.timestamp || (e.timestamp = {});
        f.lo = g(0, d - 1);
        f.hi = g(0, b - 1);
        h.lo = g(0, d - 1);
        h.hi = g(0, c - 1);
    };
    PP.UUID.generate = function() {
        var a = this, b = a.parts, c = a.timestamp;
        b[0] = f(c.lo, 8);
        b[1] = f(c.hi & 65535, 4);
        b[2] = f(c.hi >>> 16 & 4095 | a.version << 12, 4);
        b[3] = f(128 | a.clockSeq >>> 8 & 63, 2) + f(a.clockSeq & 255, 2);
        b[4] = f(a.salt.hi, 4) + f(a.salt.lo, 8);
        a.init();
        return b.join("-").toLowerCase();
    };
})();

PP.UUID.init();

PP._Versioning = PP.Class.extend({
    includes: [ PP.Events ],
    debug: false,
    initialize: function() {
        PP.Msg.on("message", this.onMessage, this);
    },
    checkVersions: function(a) {
        var b = a.version_info;
        this.c.log("  incoming version info");
        this.c.log(PP.pp(b));
        var c = this.getInfo();
        var d = window.PP_WINDOW_ID;
        if (d === "bg") {
            if (c.PP_WEBAPP_VERSION == "0" || c.PP_EXTENSION_VERSION == "0" || b.PP_WEBAPP_VERSION == "0" || b.PP_EXTENSION_VERSION == "0") {
                this.c.log("Webapp or extension version is 0 --- must be dev mode!");
                return;
            }
            if (parseInt(c.PP_WEBAPP_VERSION) > parseInt(b.PP_WEBAPP_VERSION)) {
                this.fire("webapp_needsupdate", {
                    latestVersion: c.PP_WEBAPP_VERSION,
                    myInfo: c,
                    incomingInfo: b
                });
            }
            if (parseInt(c.PP_EXTENSION_VERSION) < parseInt(b.PP_EXTENSION_VERSION)) {
                this.fire("extension_needsupdate", {
                    latestVersion: b.PP_EXTENSION_VERSION,
                    myInfo: c,
                    incomingInfo: b
                });
            }
        } else {
            console.error("Shouldn't get here from a non-bg tab!");
        }
    },
    onMessage: function(a) {
        var b = a.msg;
        if (b.version_info) {
            this.checkVersions(b);
        }
    },
    getInfo: function() {
        return {
            PP_EXTENSION_VERSION: window.PP_EXTENSION_VERSION,
            PP_WEBAPP_VERSION: window.PP_WEBAPP_VERSION
        };
    }
});

createSingleton(PP, "_Versioning", "Versioning");

PP.library._Attachment = PP.Class.extend({
    getFields: function() {
        var a = [ {
            name: "_id",
            description: "Internal GUID"
        }, {
            name: "owner",
            description: "User_id of the attachment owner (internal use)"
        }, {
            name: "deleted",
            description: 'flag for deleted / "hanging" attachments.'
        }, {
            name: "filename",
            description: "File name (including extension, i.e. my_file.pdf)"
        }, {
            name: "mimeType",
            description: "MIME type of the file"
        }, {
            name: "source_filename",
            description: 'The "source" filename, i.e. the original filename of the attached or downloaded file.'
        }, {
            name: "article_pdf",
            description: "Flags an attachment as the article PDF. 1 if yes, otherwise 0."
        }, {
            name: "pub_id",
            description: "The Paperpile GUID of the associated publication object."
        }, {
            name: "pub_trashed",
            description: "1 if the associated pub is trashed."
        }, {
            name: "filesize",
            description: "File size (in bytes)"
        }, {
            name: "md5",
            description: "MD5 checksum of the file contents"
        }, {
            name: "description",
            description: "Description of the attachment (if any)"
        }, {
            name: "gdrive_id",
            description: "ID of the cloud backup of the file (if any)"
        }, {
            name: "gdrive_needs_sync",
            description: "Flag indicating whether google drive still needs to be synced."
        }, {
            name: "gdrive_trashed",
            description: "ID of the cloud backup of the file (if any)"
        }, {
            name: "gdrive_deleted",
            description: "ID of the cloud backup of the file (if any)"
        }, {
            name: "subfolders",
            description: "List of subfolders this article should be stored in Google Drive."
        }, {
            name: "web_url",
            description: "Online URL of the file (if any)"
        }, {
            name: "download_progress",
            description: "The current download progress (if attachment is being downloaded)"
        }, {
            name: "download_status",
            description: "The download state of the attachment (if being downloaded)"
        } ];
        return a;
    },
    autoClean: function(a, b) {
        if (!b._id) {
            b._id = PP.UUID.generate();
        }
        var c = PP.Utils.clone(b);
        b.pub_id = a._id;
        b.owner = a.owner;
        if (b.owner === undefined) {}
        if (b.pub_id === undefined) {
            throw new Error("Attachment pub_id cannot be undefined!");
        }
        if (b.gdrive_needs_sync === undefined) {
            b.gdrive_needs_sync = 1;
        }
        if (b.pub_trashed === undefined) {
            b.pub_trashed = 0;
        }
        b.subfolders = a.subfolders || [];
        if (!b.filename) {
            b.filename = this.getDefaultFilename(a, b);
        } else {
            b.filename = this.ensureFilenameContainsAuthorYear(a, b);
        }
        b.filename = this.removeFilenameDoubleSuffix(b);
        b.filename = PP.Utils.cleanFileName(b.filename);
        var d = b.mimeType;
        if (this.couldBePdf(b)) {
            var e = PP.library.Publication.getPdfAttachment(a);
            if (!e) {
                b.article_pdf = 1;
                b.source_filename = "[article_pdf].pdf";
                b.filename = this.getDefaultFilename(a, b);
                b.filename = PP.Utils.cleanFileName(b.filename);
            }
        }
        if (this.couldBePdf(b)) {
            b.filename = this.ensureFilenameHasPdfSuffix(b);
        }
        if (!PP.Utils.deepEquals(c, b)) {
            b.hasUpdates = true;
        }
    },
    removeFilenameDoubleSuffix: function(a) {
        var b = a.filename;
        var c = /\.([^\.]{1,5})\.(\1)$/;
        if (b && b.match(c)) {
            var d = "." + RegExp.$1 + "." + RegExp.$2;
            var e = "." + RegExp.$1;
            b = b.replace(d, e);
        }
        return b;
    },
    ensureFilenameHasPdfSuffix: function(a) {
        var b = a.filename;
        if (b && !b.match(/\.pdf$/i)) {
            b = b + ".pdf";
        }
        return b;
    },
    ensureFilenameContainsAuthorYear: function(a, b) {
        var c = b.filename;
        if (b.source_filename === "[article_pdf].pdf" && b.article_pdf == 1) {
            return this.getDefaultFilename(a, b);
        }
        var d = PP.library.Publication.formatAuthorYear(a);
        var e = new RegExp(PP.Utils.escapeRegex(d) + " - ", "i");
        if (!c.match(e)) {
            if (c.match(/^(\w+\s+){1,4}- /)) {
                c = c.replace(/^(\w+\s+){1,4}- /, "");
            }
            c = d + " - " + c;
        }
        return c;
    },
    getDefaultFilename: function(a, b) {
        var c = b.source_filename;
        var d = /(?:\.([^.]+))?$/;
        var e = d.exec(c)[1];
        var f = PP.library.Publication.formatAuthorYear(a);
        var g;
        if (!a.title) {
            g = "[No title]";
        } else {
            g = PP.Utils.ellipsis(a.title, 200, false, "[...]");
        }
        var h;
        if (c === "[article_pdf].pdf") {
            g = g.replace(/\.pdf$/i, "");
            h = f + " - " + g + "." + e;
        } else {
            h = f + " - " + c;
        }
        h = PP.String.interconvertString(h, {
            format: "nomarkup"
        });
        return h;
    },
    couldBePdf: function(a) {
        var b = false;
        if (a.filename && a.filename.match(/\.pdf/gi)) {
            b = true;
        }
        if (a.mimeType && a.mimeType.match(/application.pdf/i)) {
            b = true;
        }
        return b;
    },
    getSyncServiceLink: function(a, b) {
        if (b !== "gdrive") {
            console.error("Only support gdrive for now!");
        }
        if (b === "gdrive") {
            var c = [];
            a.forEach(function(a) {
                if (a.gdrive_id) {
                    c.push(a.filename);
                }
            });
            var d = "https://drive.google.com/#search/";
            var e = [];
            c.forEach(function(a) {
                e.push('title:"' + a + '"');
            });
            query = e.join(" OR ");
            query = encodeURIComponent(query);
            d += query;
            return {
                n_links: c.length,
                url: d
            };
        }
    },
    openAttachment: function(a, b) {
        var c = a.pub;
        var d;
        if (a.attachment) {
            d = a.attachment;
        } else if (a.attachment_id) {
            d = PP.library.Publication.getAttachment(c, a.attachment_id);
        } else {
            throw new Error("No attachment or attachment_id!");
        }
        var e = a.preferredViewer;
        if (!e) {
            e = PP.backend.Settings.get("pubview_preferredViewer");
        }
        if (window && window.UAParser) {
            var f = new UAParser();
            var g = f.getResult();
            if (g && g.browser && "major" in g.browser) {
                if (e == "pubview" && g.browser.major == "55") {
                    e = "raw";
                }
            }
        }
        if (e == "drive" && this.isSynced(d)) {
            b.openDrive(a);
        } else if (e == "raw") {
            b.openRaw(a);
        } else if (e == "saveToDisk") {
            b.saveToDisk(a);
        } else if (e == "metapdf" && PP.backend.Attachments.canShowInPubView(d)) {
            b.openMetaPDF(a);
        } else {
            if (this.isSynced(d) && this.worksBestInDriveViewer(d)) {
                b.openDrive(a);
            } else if (PP.backend.Attachments.canShowInPubView(d)) {
                b.openPubView(a);
            } else {
                b.openRaw(a);
            }
        }
    },
    canShowInPubView: function(a) {
        return this.isPdfAttachment(a);
    },
    isPdfAttachment: function(a) {
        return a.article_pdf == 1 || a.mimeType && a.mimeType.match(/pdf/i) || a.filename && a.filename.match(/\.pdf$/i);
    },
    worksBestInDriveViewer: function(a) {
        var b = [ "doc", "docx", "eps", "odt", "svg", "xls", "xlsx" ];
        var c = false;
        b.forEach(function(b) {
            var d = new RegExp("." + b + "$", "i");
            if (a.filename && a.filename.match(d)) {
                c = true;
            }
        });
        return c;
    },
    isSynced: function(a) {
        return a.gdrive_id ? true : false;
    },
    getPubViewUrl: function(a) {
        var b;
        if (a.article_pdf == 1) {
            b = PP.Globals.url("/view/" + a.pub_id);
        } else {
            b = PP.Globals.url("/view/file/" + a._id);
        }
        return b;
    },
    getDriveDesktopWebUrl: function(a) {
        if (!this.isSynced(a)) {
            return null;
        }
        var b = "https://docs.google.com/file/d/" + a.gdrive_id + "/edit";
        return b;
    },
    getDriveMobileWebUrl: function(a) {
        if (!this.isSynced(a)) {
            return null;
        }
        var b = "https://docs.google.com/viewer?a=v&pid=explorer&srcid=" + a.gdrive_id;
        return b;
    },
    getDriveDownloadUrl: function(a) {
        if (!this.isSynced(a)) {
            return null;
        }
        var b = "https://drive.google.com/uc?export=download&id=" + a.gdrive_id;
        return b;
    },
    getDriveRawContentUrl: function(a) {
        if (!this.isSynced(a)) {
            return null;
        }
        var b = "https://drive.google.com/uc?id=" + a.gdrive_id;
        return b;
    },
    addViewDrivePermissions: function(a, b) {
        if (this.isSynced(a)) {
            PP.Utils.callback(b, null, [ null, "Attachment is not synced!" ]);
            return;
        }
        var c = this.getSharedAttachmentUrl(a);
        c += "?no_redirect=1";
        var d = PP.Ajax.request({
            url: c,
            trackRedirects: true,
            progress: function(a) {
                d.abort();
            },
            callback: function(a, c, d) {
                if (c !== "success") {
                    PP.Utils.callback(b, null, [ null, d.status ]);
                } else {
                    PP.Utils.callback(b, null, [ a, null ]);
                }
            }
        });
    },
    getPubViewAttachmentUrl: function(a) {
        return this.getSharedAttachmentUrl(a, "pubview");
    },
    getSharedAttachmentUrl: function(a, b) {
        var c = PP.Globals.getUrlBase();
        if (!b) {
            b = "internal";
        }
        var d = a._id;
        return c + "/shared/" + b + "/download/" + d;
    }
});

PP.library.Attachment = new PP.library._Attachment();

PP.library._Author = PP.Class.extend({
    getFields: function() {
        var a = [ {
            name: "last"
        }, {
            name: "first"
        }, {
            name: "jr"
        }, {
            name: "initials"
        }, {
            name: "collective"
        }, {
            name: "bak"
        }, {
            name: "formatted"
        }, {
            name: "_id"
        } ];
        return a;
    },
    toBibtex: function(a) {
        if (a.collective === "others") {
            return "{" + a.collective + "}";
        } else if (a.collective) {
            return "{" + a.collective + "}";
        } else {
            var b = [];
            if (a.last && a.first) {
                b.push(a.last);
                if (a.jr) b.push(a.jr);
                b.push(a.first);
                return b.join(", ");
            } else if (a.last && a.initials) {
                b.push(a.last);
                if (a.jr) b.push(a.jr);
                b.push(a.initials);
                return b.join(", ");
            } else if (a.last) {
                return "{" + a.last + "}";
            } else if (a.first) {
                return "{" + a.first + "}";
            } else if (a.initials) {
                return "{" + a.initials + "}";
            }
        }
        return "";
    },
    toRis: function(a) {
        if (a.collective === "others") {
            return a.collective;
        } else if (a.collective) {
            return a.collective;
        } else {
            var b = [];
            if (a.last && a.first) {
                b.push(a.last);
                b.push(a.first);
                if (a.jr) b.push(a.jr);
                return b.join(", ");
            } else if (a.last && a.initials) {
                b.push(a.last);
                b.push(a.initials);
                if (a.jr) b.push(a.jr);
                return b.join(", ");
            } else if (a.last) {
                return a.last + ", ";
            } else if (a.first) {
                return ", " + a.first;
            } else if (a.initials) {
                return ", " + a.initials;
            }
        }
        return "";
    },
    toCSL: function(a) {
        var b = {};
        if (a.collective && a.collective === "others") {
            return null;
        } else if (a.collective) {
            b.family = PP.String.removeControlChars(a.collective);
            return b;
        }
        if (a.first && a.first != "") {
            b.given = PP.String.removeControlChars(a.first);
        }
        if (a.last && a.last != "") {
            b.family = PP.String.removeControlChars(a.last);
        }
        if (a.jr) {
            b.suffix = PP.String.removeControlChars(a.jr);
        }
        if (!b.given && a.initials != "") {
            b.given = PP.String.removeControlChars(a.initials);
        }
        if (b.given && !b.family) {
            b.family = b.given;
            delete b.given;
        }
        this.removeCommas(b, "given");
        this.removeCommas(b, "family");
        this.addPeriods(b);
        return b;
    },
    addPeriods: function(a) {
        if (!a.given) return;
        var b = a.given.split(/\s+/);
        for (var c = 0; c < b.length; c++) {
            if (b[c].match(/^.$/)) {
                b[c] += ".";
            }
        }
        a.given = b.join(" ");
    },
    removeCommas: function(a, b) {
        if (a[b] && a[b].match(/,/g)) {
            a[b] = a[b].replace(/,/g, "");
        }
    },
    toString: function(a, b) {
        var c = {
            prefixWrap: "",
            suffixWrap: "",
            prefix: "",
            suffix: "",
            delim: ",",
            includeItalics: true,
            output: "display",
            etAl: false,
            othersString: "et al."
        };
        if (b === undefined) {
            b = c;
        } else {
            PP.Utils.applyIf(b, c);
        }
        if (!a) {
            return "";
        }
        if (PP.Utils.isArray(a)) {
            if (b.etAl) {
                var d;
                if (a.length > 2) {
                    var e = this.toString(a[0], b);
                    if (b.includeItalics) {
                        e += " <i>et al.</i>";
                    } else {
                        e += " et al.";
                    }
                    return e;
                } else {
                    d = PP.Array.map(a, function(a) {
                        return this.toString(a, b);
                    }, this);
                    return d.join(" and ");
                }
            } else {
                var d = PP.Array.map(a, function(a) {
                    return this.toString(a, b);
                }, this);
                if (b.prefixWrap != "") {
                    var e = "";
                    for (var f = 0; f < d.length; f++) {
                        if (f < d.length - 1) {
                            e += b.prefixWrap + d[f] + b.delim + b.suffixWrap + " ";
                        } else {
                            e += b.prefixWrap + d[f] + b.suffixWrap;
                        }
                    }
                    return e;
                } else {
                    return d.join(b.delim);
                }
            }
        }
        var g = a.first, h = a.collective, i = a.last, j = a.initials, k = a.jr, l = a._id;
        var m = [];
        if (h) {
            if (b.output === "serialize" || b.output === "forDiff") {
                m.push("{" + h + "}");
            } else if (h === "others") {
                m.push(b.othersString);
            } else {
                m.push(h);
            }
        } else {
            if (b.output === "serialize") {
                if (i) {
                    m.push(i);
                }
                if (k) {
                    m.push(" " + k);
                }
                if (g || j) {
                    m.push(", ");
                    m.push(g || j);
                }
            }
            if (b.output === "full") {
                if (g) {
                    m.push(g);
                }
                if (!g && j) {
                    m.push(j);
                }
                if (i) {
                    m.push(i);
                }
                if (k) {
                    m.push(k);
                }
            } else if (b.output === "forDiff") {
                if (g) {
                    m.push(g);
                }
                if (!g && j) {
                    m.push(j);
                }
                m.push(",");
                if (i) {
                    m.push(i);
                }
                m.push(",");
                if (k) {
                    m.push(k);
                }
            } else if (b.output === "display") {
                if (i) {
                    m.push(i);
                }
                if (k) {
                    m.push(k);
                }
                if (j) {
                    m.push(j);
                }
            } else if (b.output === "last") {
                if (h) {
                    m.push(h);
                } else if (i) {
                    m.push(i);
                }
            } else if (b.output === "firstlast") {
                if (g) {
                    m.push(g);
                }
                if (i) {
                    m.push(i);
                }
            }
        }
        var n;
        if (b.output === "serialize") {
            n = m.join("");
        } else {
            n = m.join(" ");
        }
        if (h === "others" && b.othersString === "et al." && b.prefix && b.prefix.match(/span/i)) {
            n = " <i>" + n + "</i>";
        } else {
            if (b.prefix) {
                n = b.prefix + n;
            }
            if (b.suffix) {
                n = n + b.suffix;
            }
        }
        n = n.replace(/{_id}/g, l);
        return n;
    },
    hasValue: function(a) {
        return PP.Utils.isArray(a) && a.length > 0;
    },
    parseAuthorList: function(a, b) {
        var c = {
            delimiter: ",",
            commasWithinNames: false,
            familyNameFirst: true,
            auto: false
        };
        b = PP.Utils.apply(c, b);
        var d = [];
        a = a.replace(/\s+/g, " ");
        a = a.replace(/[,;:]\s*$/, "");
        if (b.auto) {
            var e = {};
            var f = a.split("");
            for (var g = 0; g < f.length; g++) {
                if (!f[g].match(/[,;:]/)) continue;
                if (!e[f[g]]) e[f[g]] = 0;
                e[f[g]]++;
            }
            var h = [];
            for (var i in e) {
                h.push({
                    key: i,
                    cnt: e[i]
                });
            }
            if (h.length > 0) {
                h = h.sort(function(a, b) {
                    return b.cnt - a.cnt;
                });
                b.delimiter = h[0].key;
                if (h.length > 1) {
                    if (h[0].key == "," && h[1].key == ";") {
                        if (h[1].cnt / h[0].cnt >= .5) {
                            b.delimiter = ";";
                        }
                    }
                }
            }
            var j = new RegExp("(?:" + b.delimiter + "|\\s+and\\s+|\\s+&\\s+)");
            f = a.split(j);
            var k = [];
            for (var g = 0; g < f.length; g++) {
                if (f[g] === "") continue;
                if (f[g].match(/^\s+$/)) continue;
                if (!f[g].match(/[A-Z]/i)) continue;
                f[g] = f[g].replace(/^\s+/, "");
                f[g] = f[g].replace(/\s+$/, "");
                var l = {
                    text: f[g],
                    anno: "N"
                };
                if (l.text.match(/^([A-Z]{1,2}\.?\s*)+$/)) {
                    l.anno = "I";
                } else if (l.text.match(/^([A-Z]{1,2}\.?\s*)+\s/)) {
                    if (l.text.match(/[A-Z][a-z]+/) || l.text.match(/[a-z]+\s/)) {
                        l.anno = "B";
                    }
                }
                if (l.anno == "N") {
                    if (l.text.match(/\s+([A-Z]{1,2}\.?\s*)+$/)) {
                        if (l.text.match(/[A-Z][a-z]+/) || l.text.match(/[a-z]+\s/)) {
                            l.anno = "A";
                        }
                    } else {
                        if (l.text.match(/[A-Z][a-z]+/) || l.text.match(/[a-z]+\s/)) {
                            l.anno = "L";
                        }
                    }
                }
                if (l.anno == "L") {
                    var m = 0;
                    var n = 0;
                    l.text.split(/\s+/).forEach(function(a) {
                        if (a.match(/^[A-Z][a-z]/)) m++;
                        if (a.match(/^[A-Z]\.?$/)) n++;
                    });
                    if (m > 1 && m <= 3 && n <= 1) {
                        l.anno = "D";
                    }
                }
                if (l.text.match(/^The\s/)) {
                    l.anno = "C";
                }
                if (l.text.match(/(consortium|group|ENCODE|FANTOM|ATLAS)/i)) {
                    l.anno = "C";
                }
                k.push(l);
            }
            while (k.length > 0) {
                var o = k.shift();
                if (o.anno === "C") {
                    d.push({
                        collective: o.text
                    });
                } else if (o.anno === "B" || o.anno === "D") {
                    d.push(this.parseAuthor(o.text, {
                        familyNameFirst: false
                    }));
                } else if (o.anno === "A") {
                    d.push(this.parseAuthor(o.text, {
                        familyNameFirst: true
                    }));
                } else if (o.anno === "I") {
                    if (k[0] && k[0].anno === "L") {
                        var p = k.shift();
                        d.push({
                            last: p.text,
                            first: o.text
                        });
                    }
                } else if (o.anno === "L") {
                    if (k[0] && k[0].anno === "I") {
                        var p = k.shift();
                        d.push({
                            last: o.text,
                            first: p.text
                        });
                    }
                }
            }
        } else {
            var f = a.split(b.delimiter);
            if (b.delimiter === "," && b.commasWithinNames === true) {
                var q = [];
                for (var g = 1; g < f.length; g++) {
                    if ((g + 1) % 2 === 0) {
                        q.push(f[g - 1] + f[g]);
                    }
                }
                f = q;
            }
            for (var g = 0; g < f.length; g++) {
                d.push(this.parseAuthor(f[g], b));
            }
        }
        return d;
    },
    parseAuthor: function(a, b) {
        var c, d;
        var e = {
            familyNameFirst: true
        };
        b = PP.Utils.apply(e, b);
        if (PP.Utils.isArray(a)) {
            var f = PP.Array.map(a, function(a) {
                return this.parseAuthor(a, b);
            }, this);
            return f;
        }
        var g = this._parseAuthorStringHelper(a, b);
        if (g.level === undefined) {
            g.collective = g.bak;
        }
        this.autoClean(g);
        return g;
    },
    getFirstNameStopRegex: function() {
        return /^(aus|auf|da|das|de|del|der|do|dos|la|las|van|von|von|zu|)$/i;
    },
    autoClean: function(a) {
        var b = this.getFields();
        for (var c = 0; c < b.length; c++) {
            var d = b[c].name;
            if (a[d]) {
                a[d] = a[d].replace(/^\s*/, "");
                a[d] = a[d].replace(/\s*$/, "");
                a[d] = PP.Utils.replaceU0308(a[d]);
                a[d] = PP.Utils.replaceControlChars(a[d]);
            }
        }
        if (a.first !== undefined) {
            var e = a.first;
            e = e.replace(/\./g, " ");
            e = e.replace(/\s+$/, "");
            if (!a.initials && e.length > 0 && e.length < 4 && e.toUpperCase() === e) {
                a.initials = e;
                a.initials = a.initials.replace(/-/g, "");
                a.first = e;
            } else {
                var f = a.first.replace(/\./g, ". ");
                f = f.replace(/\s+$/, "");
                var g = f.split(/\s+/);
                for (c = 0; c < g.length; c++) {
                    g[c] = g[c].replace(/\.$/, "");
                    if (g[c].length <= 2) {
                        continue;
                    }
                    var h = g[c].split(/\s*-\s*/);
                    for (var i = 0; i < h.length; i++) {
                        if (h[i].match(this.getFirstNameStopRegex())) {} else {
                            h[i] = this.wordToLowerCase(h[i]);
                        }
                    }
                    g[c] = h.join("-");
                }
                a.first = g.join(" ");
                a.first = a.first.replace(/(.+)\s+(-\S.*)/g, "$1$2");
            }
        }
        if (a.first === undefined && a.initials !== undefined && PP.Utils.isString(a.initials)) {
            a.first = a.initials;
        }
        if (a.first !== undefined && PP.Utils.isString(a.first)) {
            var h = a.first.split(/\s+/);
            for (var i = 0; i < h.length; i++) {
                if (h[i].match(/^[A-Z]{1,2}$/)) {
                    h[i] = h[i].split("").join(" ");
                }
            }
            a.first = h.join(" ");
        }
        if (a.last !== undefined && PP.Utils.isString(a.last)) {
            if (a.last.match(/^[A-Z\u00C0-\u00D6\u00D8-\u00DD\xdf\s\-]+$/) || a.last.toUpperCase() === a.last) {
                g = [ a.last ];
                if (a.last.match(/-/)) {
                    g = a.last.split(/\s*-\s*/);
                }
                for (c = 0; c < g.length; c++) {
                    h = [ g[c] ];
                    if (g[c].match(/\s/)) {
                        h = g[c].split(/\s+/);
                    }
                    for (i = 0; i < h.length; i++) {
                        if (h[i].match(/^(del|de\sla|de|da|do)$/i)) {
                            h[i] = h[i].toLowerCase();
                        } else {
                            h[i] = this.wordToLowerCase(h[i]);
                        }
                    }
                    g[c] = h.join(" ");
                }
                a.last = g.join("-");
            }
            if (a.last.match(/^[a-z\s]+$/)) {
                a.last = PP.String.upperFirst(a.last);
            }
        }
        if (a.first !== undefined && PP.Utils.isString(a.first)) {
            if (a.first.match(/^[a-z\s]+$/)) {
                a.first = PP.String.upperFirst(a.first);
            }
        }
        if (a.last) {
            var j = a.last.match(/(.*)(\sJr\.?|\sV|\sIV|\sIII|\s3rd|\sII|\s2nd)$/i);
            if (j !== null && j.length >= 3) {
                a.jr = j[2];
                a.jr = PP.Utils.strip(a.jr);
                a.last = j[1];
                a.last = a.last.replace(/,?\s*$/, "");
            }
        }
        if (!a.initials) {
            this.loadInitials(a);
        } else {
            this.cleanInitials(a);
        }
        if (!a.formatted) {
            this.loadFormatted(a);
        }
        if (!a._id) {
            a._id = PP.UUID.generate();
        }
    },
    isInitials: function(a) {
        return a.match(/^([A-Z]\.?){1,4}$/);
    },
    loadFormatted: function(a) {
        a.formatted = this.toString(a, {
            output: "display"
        });
    },
    loadInitials: function(a) {
        var b = this;
        var c = "";
        var d = a.first;
        if (d && this.isInitials(d)) {
            c = d.replace(/[\.\s\-]/g, "");
            a.initials = c;
            return;
        }
        var e = [];
        if (d) {
            var f = d.replace(/-/g, " ");
            e = f.split(/\s+/g);
        }
        e = e.filter(function(a) {
            if (a.match(b.getFirstNameStopRegex())) {
                return false;
            } else {
                return true;
            }
        });
        if (e.length > 2) {
            e = [ e[0], e[1] ];
        }
        c = "";
        var g = /([A-Z\u00C0-\u00DF]+)/;
        var h = /(\w)\w+/;
        for (var i = 0; i < e.length; i++) {
            var j = e[i];
            var k = g.exec(j);
            var l = h.exec(j);
            if (k && k.length > 0) {
                c += k[0];
            } else if (l && l.length > 0) {
                c += l[0];
            }
        }
        c = c.replace(/[\.\s\-]/g, "");
        a.initials = c;
    },
    cleanInitials: function(a) {
        var b = a.initials;
        b = b.replace(/\./g, "");
        b = b.replace(/\s/g, "");
        a.initials = b;
    },
    _parseAuthorStringHelper: function(a, b) {
        var c = {
            first: undefined,
            last: undefined,
            collective: undefined,
            jr: undefined,
            level: undefined,
            bak: undefined
        };
        if (a && a.match(/\{(.*?)\}/i)) {
            c.collective = RegExp.$1;
            c.level = "collective";
            c.bak = a;
            return c;
        }
        if (b.collective) {
            c.collective = a;
            c.level = "collective";
            c.bak = a;
            return c;
        }
        var d = [ "Op\\sde", "van\\sder", "von\\sder", "von\\szu", "van\\sde", "van\\sden", "auf\\sden", "de\\sla", "de\\slas" ];
        var e = [ "al", "au", "af", "el", "do", "del", "della", "dello", "des", "da", "de", "di", "dos", "du", "la", "le", "lo", "les", "Mc", "lou", "pietro", "st.", "st", "ter", "vanden", "van", "vel", "ver", "vere", "vom", "von", "zur", "ten", "te", "den", "sir" ];
        var f = {
            Andreas: 1,
            Bruno: 1
        };
        var g = "([A-Z\x80-\u017f\u0400-\u042f]\\.?)";
        var h = new RegExp([ "^", g, "{1,3}", "$" ].join(""), "");
        var i = new RegExp("^[A-Z\x80-\u017f\u0400-\u042f]\\.?$", "");
        var j = new RegExp("(.+)\\s(" + d.join("|") + ")\\s(.+)", "i");
        var k = new RegExp("^(" + d.join("|") + ")\\s(.+)\\s([A-Z]{1,3})$", "");
        var l = new RegExp("(.+)\\s(" + e.join("|") + ")\\s(.+)", "i");
        var m = new RegExp("^(" + e.join("|") + ")\\s(.+)\\s([A-Z]{1,3})$", "i");
        var n = new RegExp("^[A-Z-]*$");
        var o = 0;
        while (a.match(/\d\s*$/)) {
            a = a.replace(/(.*)(\s*,\s*\d+\s*)$/g, "$1");
            a = a.replace(/(.*)(\s*\d+\s*)$/g, "$1");
            o++;
            if (o > 10) break;
        }
        a = a.replace(/^\s+/, "");
        a = a.replace(/\s+$/, "");
        a = a.replace(/\s+/g, " ");
        a = a.replace(/\s-\s/, "-");
        a = a.replace(/^Prof\.\s*/, "");
        a = a.replace(/^Dr\.\s*/, "");
        a = a.replace(/,?\s?Ph\.?\s?D\.?$/i, "");
        a = a.replace(/,?\s?D.?\s?Phil\.?$/i, "");
        a = a.replace(/,?\s?M\.?D\.?$/i, "");
        a = a.replace(/,?\s?Pharm\.?\s?D\.$/i, "");
        a = a.replace(/,\s?Dr\.?$/, "");
        a = a.replace(/,\s?Professor$/i, "");
        c.bak = a;
        var p = a.match(/(.*)(\sJr\.?|\sSr\.?|\sII|\sIII|\sIV|\s1st|\s2nd|\s3rd|\s4th|\s5th)$/i);
        if (p !== null) {
            var q = 0;
            var r = d.concat(e);
            p[1].split(/\s+/).forEach(function(a) {
                var b = 1;
                d.concat(e).forEach(function(c) {
                    if (c.toUpperCase() == a.toUpperCase()) {
                        b = 0;
                    }
                });
                if (b) q++;
            });
            var s = 0;
            if (p[2].match(/I/)) {
                if (p[1].match(/.*,.*,.*/)) {
                    s = 1;
                }
            } else {
                if (q >= 2) {
                    s = 1;
                }
            }
            if (s) {
                c.jr = p[2];
                a = p[1];
                a = a.replace(/,?\s*$/, "");
            }
        }
        p = a.match(/(.+),\s*(Jr\.?|Sr\.?|II|III|IV|1st|2nd|3rd|4th|5th)\s*,\s*(.+)/i);
        if (p !== null && p.length == 4) {
            c.jr = p[2];
            a = p[1] + ", " + p[3];
        }
        var t = [ "Consortium", "Group", "Member", "Network", "Cancer", "Association", "American", "Committee", "Initiative", "Investigators", "Society", "Collaborators", "Cohort", "Clinical", "Supreme Court", "Court of", "Canadian", "Centers for", "Team", "Working Party", "Editorial", "European", "College", "Task Force", "Grupo", "Gruppo", "International", "National", "Council", "Platform", "U\\.S\\.", "United", "Organization", "Institute", "Corporation" ];
        var u = new RegExp("\\b(" + t.join("|") + ")\\b", "i");
        if (a.match(u)) {
            c.collective = a;
            c.level = "9.0";
            return c;
        }
        var v;
        if (a === "et al." || a === "et al") {
            c.collective = "others";
            c.level = "0.0 <et al.>";
            return c;
        }
        if (a.match(/,/)) {
            v = a.split(/,/);
            if (v.length === 2) {
                c.first = v[1];
                c.last = v[0];
                c.level = "0.0";
                return c;
            }
        }
        v = a.split(/\s+/);
        if (v.length === 2) {
            if (v[1].match(h) && !v[0].match(h) && !v[0].match(n)) {
                c.first = v[1];
                c.last = v[0];
                c.level = "0.9 <Last FM>";
                return c;
            }
            if (v[0].match(h) && !v[1].match(h) && !v[1].match(n)) {
                c.first = v[0];
                c.last = v[1];
                c.level = "0.9 <FM Last>";
                return c;
            }
            if (b.familyNameFirst === true) {
                c.first = v[1];
                c.last = v[0];
                c.level = "1.0 familyFirst";
            } else {
                c.first = v[0];
                c.last = v[1];
                c.level = "1.0 familyLast";
            }
            return c;
        }
        var w = a.match(j);
        var x = a.match(k);
        var y = a.match(l);
        var z = a.match(m);
        if (w !== null) {
            c.first = w[1];
            c.last = w[2] + " " + w[3];
            c.level = "1.1";
            return c;
        }
        if (x !== null) {
            c.first = x[3];
            c.last = x[1] + " " + x[2];
            c.level = "1.1a";
            return c;
        }
        if (y !== null) {
            c.first = y[1];
            c.last = y[2] + " " + y[3];
            c.level = "1.2";
            return c;
        }
        if (z !== null) {
            c.first = z[3];
            c.last = z[1] + " " + z[2];
            c.level = "1.2a";
            return c;
        }
        if (v.length === 3) {
            if (v[0].match(i) && !v[1].match(i)) {
                if (f[v[1]]) {
                    c.first = v[0] + " " + v[1];
                    c.last = v[2];
                } else {
                    c.first = v[0];
                    c.last = v[1] + " " + v[2];
                }
                c.level = "2.0";
                return c;
            }
            if (v[1].match(i) && v[2].match(i)) {
                c.first = v[1] + " " + v[2];
                c.last = v[0];
                c.level = "2.0.5";
                return c;
            }
            if (!v[0].match(i) && v[1].match(i)) {
                c.first = v[0] + " " + v[1];
                c.last = v[2];
                c.level = "2.1";
                return c;
            }
            if (v[0].match(i) && v[1].match(i)) {
                c.first = v[0] + " " + v[1];
                c.last = v[2];
                c.level = "2.2";
                return c;
            }
            if (!v[0].match(i) && !v[1].match(i)) {
                if (v[1] === "Ben" || v[1] === "Castro") {
                    c.first = v[0];
                    c.last = v[1] + " " + v[2];
                } else {
                    c.first = v[0] + " " + v[1];
                    c.last = v[2];
                }
                c.level = "2.3";
                return c;
            }
            if (v[1].match(/^[a-z]+$/)) {
                c.first = v[0] + " " + v[1];
                c.last = v[2];
                c.level = "2.4";
                return c;
            }
        }
        if (v.length === 4) {
            if (v[2].match(i)) {
                c.first = v[0] + " " + v[1] + " " + v[2];
                c.last = v[3];
                c.level = "3.1";
                return c;
            }
            if (v[1].match(i)) {
                if (f[v[2]]) {
                    c.first = v[0] + " " + v[1] + " " + v[2];
                    c.last = v[3];
                } else {
                    c.first = v[0] + " " + v[1];
                    c.last = v[2] + " " + v[3];
                }
                c.level = "3.1";
                return c;
            }
            if (v[0].match(i)) {
                if (f[v[1]] && f[v[2]]) {
                    c.first = v[0] + " " + v[1] + " " + v[2];
                    c.last = v[3];
                } else if (f[v[1]] && !f[v[2]]) {
                    c.first = v[0] + " " + v[1];
                    c.last = v[2] + " " + v[3];
                } else {
                    c.first = v[0];
                    c.last = v[1] + " " + v[2] + " " + v[3];
                }
                c.level = "3.2";
                return c;
            }
            if (!v[0].match(i)) {
                c.first = v[0] + " " + v[1] + " " + v[2];
                c.last = v[3];
                c.level = "3.3";
                return c;
            }
        }
        if (v.length > 4 && v.length <= 6) {
            var A;
            for (var B = v.length - 1; B >= 0; B--) {
                if (v[B].match(i)) {
                    A = B;
                    break;
                }
            }
            if (A) {
                c.first = v.slice(0, A).join(" ");
                c.last = v.slice(A + 1, v.length - 1).join(" ");
                c.level = "4.0";
                return c;
            } else {
                c.first = v.slice(0, v.length - 2).join(" ");
                c.last = v.slice(v.length - 1, v.length - 1).join(" ");
                c.level = "4.1";
                return c;
            }
        }
        return c;
    },
    wordToLowerCase: function(a) {
        var b = a.charAt(0).toUpperCase();
        var c = a.substring(1, a.length).toLowerCase();
        return b + c;
    }
});

PP.library.Author = new PP.library._Author();

PP.library._BibliographicData = PP.Class.extend({
    rules: [ "_journal_ _monthNum_ \\/ _year_ _volume_ \\( _issue_ \\) : _pages_", "_journal_ _monthNum_ \\/ _year_ _volume_ : _pages_", "_journal_ _monthNum_ \\/ _year_ _volume_ \\( _issue_ \\)", "_journal_ _period_ _year_ _month_ _day_ ; _volume_ _issueParens_ : _pages_ _any_", "_journal_ _period_ _year_ _month_ _day_ _period_ _any_", "_journal_ _period_ _year_ _month_ _day_ ; _volume_ : _pages_ _any_", "_journal_ _period_ _volume_ _issueParens_ _seperator_ _pages_ _seperator_ _year_", "_journal_ _period_ _volume_ _issueParens_ _seperator_ _pages_ _seperator_ _month_ _year_", "_journal_ _period_ _volume_ _issueParens_ _seperator_ _pages_ _seperator_ _month_ _day_ _seperator_ _year_", "_journal_ _period_ _volume_ _seperator_ _pagesSingle_ _seperator_ _month_ _day_ _seperator_ _year_", "_journal_ _VOL_ _volume_ _PP_ _pagesSingle_ _yearAny_", "_journal_ _VOL_ _volume_ _PP_ _pages_ _yearAny_", "_journal_ _VOL_ _volume_ _NO_ _issue_ _PP_ _pages_ _yearAny_", "_journal_ _yearParens_ _volume_ _pages_", "_journal_ _volumeParens_ _pages_ _year_", "_journal_ _volume_ _issueParens_ _yearAny_ _pages_", "_journal_ _volume_ _issueParens_ _pages_ _yearAny_", "_journal_ _volume_ _issueParens_ _pagesSingle_ _yearAny_", "_journal_ _volume_ _yearParens_ _pages_", "_journal_ _volume_ _yearParens_ _pagesSingle_", "_journal_ _volume_ _pages_ _yearAny_", "_journal_ _volume_ _seperator_ _pagesSingle_ _seperator_ _yearAny_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ \\( _any_ _year_ \\) , pp\\. _pages_", "_journal_ _VOL_ _volume_ _NO_ _issue_ _year_ _pages_", "_journal_ , _any_ _year_ _seperator_ _PP_ _pages_ _VOL_ _volume_ _seperator_ _NO_ _issue_", ".* University Press _journal_ _seperator_ _year_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _pages_", "_journal_ VOL _volume_ \\S+ \\S+ _year_", ".* _year_ _VOL_ _volume_ _journal_", "_journal_ _VOL_ _volume_ _NO_ _issue_ \\S+ \\S+ _year_", ".* \\| _journal_ \\| _VOL_ _volume_ \\| .* _year_", "_journal_ _volume_ _seperator_ _pages_ Published .* _year_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ \\S+ _year_", "_journal_ _yearParens_ _volume_ _seperator_ _pages_", "_journal_ _yearParens_ _seperator_ _volume_ _seperator_ _pages_", "_journal_ _yearParens_ _volume_ _issueParens_ _seperator_ _pages_", "_journal_ _year_ _seperator_ _volume_ _issueParens_ _seperator_ _pages_", "_journal_ _year_ _month_ _seperator_ _volume_ _seperator_ _pages_", "_journal_ \\s _year_ _seperator_ _volume_ _seperator_ _pages_", "_journal_ _seperator_ _any_ _year_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _pages_", "_journal_ _seperator_ _year_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _pages_", "_journal_ _seperator_ _year_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _PP_ _pages_", "_journal_  _volume_ _seperator_ _month_ _year_ _seperator_ _PP_ _pages_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ \\S+ _year_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _year_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _pages_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _PP_ _pages_ _seperator_ _year_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ _pages_ _seperator_ [^,]+ _seperator_ _year_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ _pages_ _seperator_ \\S+ _year_", "_journal_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _any_ _seperator_ _PP_ _pages_ _seperator_ _year_", "_journal_ _volume_ _seperator_ _issue_ _seperator_ _pages_ _seperator_ .+\\/.+ _year_", "_journal_ _volume_ _issueParens_ _seperator_ _pages_ _seperator_ _year_", "_journal_ _volume_ _seperator_ _pages_ . _year_", "_journal_ _volume_ _seperator_ _pages_ _seperator_ [^,]+ _seperator_ _year_", "_journal_ _year_ , _volume_ : _pagesSingle_ $", "_journal_ _period_ _year_ _month_ _seperator_ _volume_ _issueParens_ _seperator_ _pages_", "_journal_ _month_ _year_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _pages_", "_journal_ _seperator_ _VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _PP_ _pages_ _seperator_ _month_ _year_", "_journal_ _seperator_ _volume_ _issueParens_ _seperator_ _pages_ _seperator_ _month_ .* _year_", "_journal_ _seperator_ _any_ _year_ _seperator_ _VOL_ _volume_ _issueParens_ _seperator_ _PP_ _pages_", "_journal_ _seperator_  _VOL_ _volume_ _issueParens_ _seperator_ _month_ _day_ _seperator_ _year_", "_journal_ _seperator_  _VOL_ _volume_ _seperator_ _NO_ _issue_ \\( _month_  _seperator_ _year_ \\) _seperator_ _pages_", "_journal_ _period_ _year_ _month_ _day_ _period_ _volume_ _issueParens_ p _period_ _pages_", "_place_ _colon_ _institution_ , _year_ _period_ _journal_ _semicolon_ _NO_ _number_", "_journal_ _period_ _PP_ _pages_ _period_ _period_", "_journal_ _period_ _any_ _VOL_ _volume_ , _issueParens_ _PP_ _pages_ _period_ _period_", "_journal_ _period_ _VOL_ _volume_ n _issue_ _PP_ _pages_ _month_ _year_", "_journal_ _period_ _VOL_ _volume_ n _issue_ p _any_ _month_ - _month_ _year_", "_journal_ _period_ _volume_ _issueParens_ \\( _PP_ _pages_ \\), _year_ _period_ _any_", "_journal_ _period_ Conference: _conference_ _year_ _period_ _conferenceLocation_ , _any_ _period_ Conference Start: _conferenceDate_ Conference End: _any_", "_journal_ _period_ _VOL_ _volume_ _issueParens_ _seperator_ _month_ _year_ _seperator_ _PP_ _pages_ _seperator_", "_journal_ _period_ _any_ _year_ _period_ Article Number: _number_ _period_ Date of Publication: _day_ _month_ _year_ _period_", "_journal_ _period_ _year_ _day_ _month_ _seperator_ _volume_ _issueParens_ _seperator_ _pages_", "_editor_ _period_ _yearParens_ _journal_ _period_ \\( _PP_ _pages_ \\) _any_ \\. _place_ _colon_ _institution_ _semicolon_ _any_", "_editor_ _semicolon_ _editor_ _period_ _yearParens_ _journal_ _period_ \\( _PP_ _pages_ \\) _any_ \\. _place_ _colon_ _institution_ _semicolon_ _any_", "_editor_ _semicolon_ _editor_ _semicolon_ _editor_ _period_ _yearParens_ _journal_ _period_ \\( _PP_ _pages_ \\) _any_ \\. _place_ _colon_ _institution_ _semicolon_ _any_", "_editor_ _semicolon_ _editor_ _semicolon_ _editor_ _semicolon_ _editor_ _period_ _yearParens_ _journal_ _period_ \\( _PP_ _pages_ \\) _any_ \\. _place_ _colon_ _institution_ _semicolon_ _any_", "_editor_ _semicolon_ _editor_ _semicolon_ _editor_ _semicolon_ _editor_ _semicolon_ _editor_ _period_ _yearParens_ _journal_ _period_ \\( _PP_ _pages_ \\) _any_ \\. _place_ _colon_ _institution_ _semicolon_ _any_", "_journal_ _period_ _volume_ _issueParens_ \\( _any_ _colon_ _any_ \\) _colon_ _pages_ , _month_ _year_", "_journal_ _period_ _volume_ _issueParens_ _colon_ _pagesSingle_ , _month_ _year_", "_journal_ _period_ _volume_ \\( _any_ \\) _colon_ _pages_ , _month_ _year_", "_journal_ _period_ _volume_ _issueParens_ _colon_ _pagesSingle_ , _month_ _day_ , _year_", "_journal_ _period_ _volume_ _issueParens_ \\( _any_ \\) _colon_ _pages_ , _month_ _year_", "_journal_ _period_ _volume_ _any_ _colon_ _pages_ , _month_ _any_ _year_", "_any_ \\. _title_ \\. _journal_ \\. _volume_ _issueParens_ _colon_ _pages_", "_journal_ _year_ Issue _NO_  , _any_ \\. _any_ \\. .*", "_any_ : _authors_ \\. _title_ \\. _journal_ \\. _pagesSingle_ _PP_ _year_", "_editor_ \\. \\( _any_ \\) \\. _journal_ \\. \\( _PP_ _pages_ \\) \\. _any_ _PP_ _place_ : _publisher_", "_journal_ _volume_ _issueParens_ _colon_ _pages_ , _any_ _year_", "_journal_ \\. _volume_ \\( _any_ \\) \\( _any_ \\) _colon_ _pagesSingle_ , _month_ _year_ .*", "_journal_ \\. _volume_ \\( _any_ \\) _colon_ _any_ , _month_ _year_ .*", "_journal_ \\. _volume_ \\( _any_ \\) _colon_ _pages_ , _any_ _year_", "_journal_ \\. _VOL_ _volume_ _issueParens_ \\. _PP_ _pages_ \\. _month_ _year_", "_publisher_ , Inc, _journal_ _colon_ _number_ \\. _year_", "_journal_ \\. _VOL_ _volume_ _issueParens_ \\. _PP_ _pages_ \\. _any_ _year_", "_journal_ \\. _volume_ , _year_", "_journal_ _VOL_ _volume_ _NO_ _issue_ _month_ _year_", "_authors_ _yearParens_ \\. _title_ \\. _journal_ , _volume_ _issueParens_ , _pages_", "_journal_ \\. _volume_ _any_ _colon_ _pages_ , _year_ _month_", "_journal_ \\[ _any_ \\] \\. _volume_ _issueParens_ _colon_ _pagesSingle_ , _year_", "_authors_ _yearParens_ \\. _title_ \\. In _editor_ , _journal_ \\( _PP_ _pagesSingle_ \\) \\. _place_ _colon_ _publisher_", "_journal _VOL_ _volume_ _NO_ _issue_ _PP_ _pages_ _month_ _year_", "_journal_ _VOL_ _volume_ _PP_ _pages_ _month_ _year_", "_journal_ _VOL_ _volume_ _PP_ _pages_ _year_", "_authors_ _year_ _title_", "_authors_ _year_ _title_ _pages_", "_journal_ _seperator_ _VOL_ _volume_ _issueParens_ _seperator_ _month_ _year_ _seperator_ _pages_", "_VOL_ _volume_ _seperator_ _NO_ _number_ _issueParens_ _seperator_ _year_ _month_ _day_ _seperator_ _PP_ _pages_ \\.", "_VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _year_ _month_ _seperator_ _PP_ _pagesSingle_", "_VOL_ _volume_ _seperator_ _NO_ _issue_ _seperator_ _pages_ _journal_" ],
    patterns: {
        any: "(.*)",
        year: "(\\d{4}[a-z]?)",
        yearParens: "\\((\\s?\\d{4}[a-z]?\\s?)\\)",
        yearAny: "\\(?(\\s?\\d{4}[a-z]?\\s?)\\)?",
        colon: ":",
        semicolon: ";",
        period: "\\.",
        seperator: "[\\.;,:\\|\u2013\u2014\\-]",
        stop: "[\\.\\?\\!:]",
        journal: "([^\\d\\|]+)",
        volume: "(\\d+[A-Z]?)",
        volumeParens: "\\((\\d+[A-Z]?)\\)",
        VOL: "([Vv]olume|VOLUME|VOL|[Vv]ol|v)\\.?",
        NO: "([Ii]ssue|ISSUE|[Nn]umber|NUMBER|NO|[Nn]o|n)\\.?",
        month: "(Jan|JAN|January|Feb|FEB|February|Mar|MAR|March|Apr|APR|April|May|MAY|June?|JUN|July?|JUL|Aug|AUG|August|Sep|SEP|September|Oct|OCT|October|Nov|NOV|November|Dec|DEC|December)\\.?",
        monthNum: "(0?1|0?2|0?3|0?4|0?5|0?6|0?7|0?8|0?9|10|11|12)",
        day: "(\\d+)",
        PP: "(p{1,2}\\.?|[Pp]ages?)",
        issue: "(\\d+[c]?)",
        issueParens: "\\((\\d+[c]?|\\d\\s*-\\s*\\d+)\\)",
        pages: "([RrEeSsNnAa]?\\d+[^\\/,]{1,3}[RrEeSsNn]?\\d+|e\\d+)",
        pagesSingle: "([RrEeSsNnAa]\\d+|\\d+)",
        title: "([^\\.]*?)",
        authors: "([\\w,\\.\\; \\n]+?)",
        place: "(.*)",
        institution: "(.*)",
        publisher: "(.*)",
        number: "([0-9]*)",
        conference: "(.*)",
        conferenceLocation: "(.*)",
        conferenceDate: "(.*)",
        editor: "(.+?)(?:\\[Ed\\]|\\(Ed.\\))"
    },
    getExtractors: function(a) {
        if (this._extractors) {
            return this._extractors;
        }
        this.extractors = [];
        for (var b = 0; b < this.rules.length; b++) {
            this.extractors.push(this.buildReferenceExtractor(b, this.rules[b], a));
        }
        return this.extractors;
    },
    buildReferenceExtractor: function(a, b, c) {
        var d = this;
        var e = b.split(/\s+/);
        var f = 1;
        var g = {};
        var h = [];
        if (c === undefined) {
            c = {
                authorParseParams: {
                    familyNameFirst: true,
                    commasWithinNames: false
                }
            };
        }
        e.forEach(function(a) {
            var b = a.replace(/_/g, "");
            if (d.patterns[b]) {
                var c = d.patterns[b];
                var e = false;
                if (c.match(/\(/)) {
                    e = true;
                }
                if (e) {
                    g[b] = f++;
                }
                h.push(c);
            } else {
                h.push(b);
            }
        });
        var i = new RegExp(h.join("\\s?"), "g");
        var j = {
            name: a,
            captureMap: g,
            regexp: i,
            params: c,
            getCount: function(a) {
                var b = 0, c = null;
                while ((c = this.regexp.exec(a)) !== null) {
                    b++;
                }
                return b;
            },
            getRefs: function(a, b) {
                var c = [], d = null;
                while ((d = this.regexp.exec(a)) !== null) {
                    var e = this.getData(d, b);
                    c.push(e);
                }
                return c;
            },
            getData: function(a, b) {
                var c = {};
                c._origText = a[0];
                c._extractor = this.name;
                var d = PP.Utils.apply(this.params.authorParseParams, b.authorParseParams);
                for (var e in this.captureMap) {
                    if (!e.match(/^(NO|VOL)$/)) {
                        var f = this.captureMap[e];
                        var g = a[f];
                        g = PP.Utils.strip(g);
                        var h = e;
                        switch (e) {
                          case "authors":
                            h = "author";
                            g = PP.library.Author.parseAuthorList(g, d);
                            break;

                          case "yearParens":
                            h = "year";
                            break;

                          case "yearAny":
                            h = "year";
                            break;

                          case "issueParens":
                            h = "issue";
                            break;

                          case "volumeParens":
                            h = "volume";
                            break;

                          case "pagesSingle":
                            h = "pages";
                            break;

                          case "monthNum":
                            h = "month";
                            break;

                          case "conferenceLocation":
                            h = "conference_location";
                            break;

                          case "conferenceDate":
                            h = "conference_date";
                            break;

                          default:
                            break;
                        }
                        c[h] = g;
                    }
                }
                return c;
            }
        };
        return j;
    },
    addExtractor: function(a, b, c) {
        this.extractors.push(this.buildReferenceExtractor(a, b, c));
    },
    parse: function(a, b) {
        var c = this;
        if (b === undefined) b = {};
        a = a.replace(/[\n\t\s]+/g, " ");
        a = a.replace(/^\s+/, "").replace(/\s+\.$/, "");
        a = a.replace(/^Source:\s*/, "");
        a = a.replace(/\s*www\.[a-z]+\.(org|com)\s*/, "");
        var d = null;
        if (a.match(/(.+)(10\.\d{4,5}\/[^\s]+)(.*)/)) {
            d = RegExp.$2;
            a = RegExp.$1 + RegExp.$3;
            a = a.replace(/\s+/g, " ");
        }
        var e = {};
        var f = 0;
        c.getExtractors(b).forEach(function(b) {
            var d = b.getRefs(a, {});
            if (d && d.length == 1) {
                var f = c.rateData(d[0]);
                if (f > 0 && f > c.rateData(e)) {
                    e = d[0];
                }
            }
        });
        if (d) {
            e.doi = d.replace(/[\.\s]*$/, "");
        }
        if (e.journal) {
            e.journal = e.journal.replace(/.*et\s+al\s+\.?\s+/, "");
            e.journal = e.journal.replace(/^[^A-Z]\s+/i, "");
            e.journal = e.journal.replace(/\s*[,;]+\s*$/, "");
            e.journal = e.journal.replace(/,\s+Vol[\.\s]*$/, "");
        }
        if (e.pages) {
            e.pages = e.pages.replace(/^(e\d+)\s.*/, "$1");
        }
        return e;
    },
    rateData: function(a) {
        var b = 0;
        if (a.journal) {
            if (!a.journal.match(/[A-Z]/i)) {
                return 0;
            }
            if (a.journal.length == 1) {
                return 0;
            }
            b += 3;
        }
        if (a.volume) b += 2;
        if (a.year) {
            var c = new Date();
            var d = parseInt(c.getFullYear());
            if (parseInt(a.year) > d + 2) {
                return 0;
            }
            b += 2;
        }
        if (a.pages) {
            if (a.pages.match(/(\d+)\s*[-\u2013]\s*(\d+)/)) {
                var e = RegExp.$1;
                var f = RegExp.$2;
                if (parseInt(f) - parseInt(e) > 1e3) {
                    return 0;
                }
                if (f.length < e.length) {
                    var g = e.slice(f.length * -1);
                    if (parseInt(g) > parseInt(f)) {
                        return 0;
                    }
                }
                b += 3;
            } else if (a.pages.match(/\d+\:\d+/)) {
                return 0;
            }
            if (a.year) {
                if (a.pages == a.year) {
                    return 0;
                }
            }
            b += 2;
        }
        if (a.month) b += 1;
        if (a.issue) {
            if (a.issue.match(/(\d+)\s*-\s*(\d+)/)) {
                var h = RegExp.$1;
                var i = RegExp.$2;
                if (parseInt(i) < parseInt(h)) {
                    return 0;
                }
            }
            b += 1;
        }
        if (a.doi) b += 1;
        return b;
    }
});

PP.library.BibliographicData = new PP.library._BibliographicData();

PP.library._BibliographicInferer = PP.Class.extend({
    parse: function(a) {
        var b = this;
        b.c = {
            str: a,
            pub: {
                pubtype: "PP_ARTICLE"
            },
            got: {},
            claimed: [],
            matches: {}
        };
        b.parseNumbers();
        b.parseStrings();
        b.useLastNumbers();
        b.postProcess();
        PP.library.Publication.autoClean(b.c.pub);
        return b.c.pub;
    },
    parseNumbers: function() {
        var a = this;
        a.c.matches.dashNumbers = a.matchAll(a.c.str, /\w?\d+\s?[\-\u2013]\s?\w?\d+/);
        a.c.matches.slashNumbers = a.matchAll(a.c.str, /\d+\/\d+/);
        a.c.matches.parensNumbers = a.matchAll(a.c.str, /\(\d+[\-\u2013\d]*\)/);
        a.c.matches.allNumbers = a.matchAll(a.c.str, /\d+[A-Z]?/);
        a.c.matches.yearNumbers = a.matchAll(a.c.str, /\d{4}/);
        a.c.matches.allNumberSegments = a.matchAll(a.c.str, /[\d\s\:\-\u2013\,\.\/\(\)]+/);
        a.c.matches.pagesP = a.matchAll(a.c.str, /[\(\s]p+a?g?e?s?\.?\s*\d+[\-\u2013]*\d*/i);
        a.c.matches.numPages = a.matchAll(a.c.str, /\d+\s?p+a?g?e?s?\.?/i);
        a.c.matches.yearMonthDays = a.matchAll(a.c.str, a.constructMonthRegEx("\\d{4}\\s", "\\.?\\s\\d{1,2}"));
        a.c.matches.monthDayYears = a.matchAll(a.c.str, a.constructMonthRegEx("", "\\.?\\s\\d{1,2},?\\s\\d{4}"));
        a.c.matches.dayMonthYears = a.matchAll(a.c.str, a.constructMonthRegEx("\\d{1,2}\\s", "\\.?,?\\s\\d{4}"));
        a.c.matches.yearDayMonths = a.matchAll(a.c.str, a.constructMonthRegEx("\\d{4}\\s\\d{1,2}\\s", "\\.?"));
        a.c.matches.monthYears = a.matchAll(a.c.str, a.constructMonthRegEx("", "\\.?,?\\s\\d{4}"));
        a.c.matches.yearMonths = a.matchAll(a.c.str, a.constructMonthRegEx("\\d{4},?\\s", ""));
        a.c.matches.monthDays = a.matchAll(a.c.str, a.constructMonthRegEx("", "\\.?\\s\\d{1,2}"));
        a.c.matches.plosPages = a.matchAll(a.c.str, /[ae]\d+/i);
        a.c.matches.volumeNumbers = a.matchAll(a.c.str, /\Wvo?l?u?m?e?\.?\s?\d+|^vo?l?u?m?e?\.?\s?\d+/i);
        a.c.matches.issueNumbers = a.matchAll(a.c.str, /\Wis?s?u?e?\.?\s?\d+|no?\.?\s?\d+|numb?e?r?\.?\:?\s\d+/i);
        a.getPages();
        a.getYears();
        a.getVolumeIssue();
    },
    parseStrings: function() {
        var a = this;
        a.c.matches.quotes = a.matchAll(a.c.str, /"[^"]+"/);
        a.c.matches.nonNumbers = a.matchAll(a.c.str, /[^\W\d][^\d]*[^\W\d]\.?\??\)?\]?/);
        a.c.matches.wordsAndSuch = a.matchAll(a.c.str, /[\w\.\,\s]+/);
        a.c.matches.dois = a.matchAll(a.c.str, /10\.\S+/);
        a.c.matches.publishers = a.matchAll(a.c.str, /published by [\w\.\,\s]+/i);
        a.getAuthorTitleJournal();
        a.getEditors();
        a.getPublisher();
        a.getJournal();
        a.getDoi();
    },
    useLastNumbers: function() {
        var a = this;
        var b = a.c.matches;
        var c = a.unused(b.yearNumbers);
        if (c.length === 1) {
            a.useSegment(c[0], "year", c[0][0]);
            d = a.unused(b.allNumbers);
        } else if (c.length > 1) {
            console.log("MORE THAN ONE UNUSED YEAR");
        }
        var d = a.unused(b.allNumbers);
        if (!a.c.pub.volume && a.c.pub.journal) {
            for (var e = 0; e < d.length; e++) {
                if (d[e].index === a.c.got.journal.index + a.c.got.journal[0].length + 1) {
                    a.useSegment(d[e], "volume", d[e][0]);
                    e = d.length;
                    d = a.unused(b.allNumbers);
                }
            }
        }
        if (a.c.pub.volume && !a.c.pub.issue) {
            for (var e = 0; e < d.length; e++) {
                if (d[e].index === a.c.got.volume.index + a.c.got.volume[0].length + 1 && a.c.str.charAt(a.c.got.volume.index + a.c.got.volume[0].length) !== ":") {
                    a.useSegment(d[e], "issue", d[e][0]);
                    e = d.length;
                    d = a.unused(b.allNumbers);
                }
            }
        }
        if (!a.c.pub.volume && d.length && a.c.pub.pubtype !== "PP_BOOK") {
            a.useSegment(d[0], "volume", d[0][0]);
            d = a.unused(b.allNumbers);
        }
        if ((a.c.pub.volume || a.c.pub.pubtype === "PP_BOOK") && !a.c.pub.pages && d.length) {
            a.useSegment(d[0], "pages", d[0][0]);
        }
    },
    postProcess: function() {
        var a = this;
        var b = a.c.pub;
        if (b.issue && !b.volume) {
            b.volume = b.issue;
            delete b.issue;
        }
        if (b.editor && b.editor.length && b.address && b.publisher) {
            b.pubtype = "PP_BOOK";
            delete b.volume;
            b.booktitle = b.journal;
            delete b.journal;
        }
        a.c.pub = b;
    },
    constructMonthRegEx: function(a, b) {
        var c = [ "january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december", "jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec" ];
        var d = "";
        for (var e = 0; e < c.length; e++) {
            d += a + c[e] + b;
            if (e != c.length - 1) d += "|";
        }
        return new RegExp(d, "i");
    },
    matchAll: function(a, b) {
        var c = a + "";
        var d = 0;
        var e = [];
        var f = c.match(b);
        while (f) {
            f.index += d;
            if (f[0].trim() !== "") e.push(f);
            c = a.substring(f.index + f[0].length);
            if (c && c.length) {
                d = f.index + f[0].length;
                f = c.match(b);
            } else {
                f = null;
            }
        }
        return e;
    },
    removePresses: function(a) {
        return a.replace(/^.*university press /i, "").trim();
    },
    removeHyperlinks: function(a) {
        return a.replace(/h?t?t?p?:?\/?\/?www\S+/i, "").trim();
    },
    removeAbbreviatedAuthors: function(a) {
        return a.replace(/^.*\set\.?\sal[\.\s]+/i, "").trim();
    },
    countInstances: function(a, b) {
        var c = 0;
        var d = a.match(new Regex(b, "g"));
        if (d) c = d.length;
        return c;
    },
    unused: function(a) {
        var b = this.c.claimed;
        var c = [];
        for (var d = 0; d < a.length; d++) {
            if (b.indexOf(a[d].index) < 0 && b.indexOf(a[d].index + a[d][0].length - 1) < 0) {
                c.push(a[d]);
            }
        }
        return c;
    },
    useSegment: function(a, b, c) {
        var d = this;
        if (d.c.pub[b]) {
            console.log("KEY:", b, "ALREDY SET");
            return;
        }
        d.c.pub[b] = c;
        d.c.got[b] = a;
        d.claimSegment(a);
    },
    claimSegment: function(a) {
        var b = this;
        for (var c = a.index; c < a.index + a[0].length; c++) {
            b.c.claimed.push(c);
        }
    },
    unclaimedString: function(a) {
        var b = this;
        var c = "";
        for (var d = 0; d < a[0].length; d++) {
            if (b.c.claimed.indexOf(d + a.index) < 0) {
                c += a[0][d];
            }
        }
        return c;
    },
    parseAuthor: function(a) {
        var b = [];
        a = a.replace(/^[^\w]+/, "").replace(/[^\w\.\)]+$/, "").replace(/[\+\*\[\(\d].*$/g, "").replace(/\s*(MD|PhD|MSc)\s*,?\s*/g, "").replace(/[0-9]{4}-[0-9]{4}/g, "").replace(/[0-9]{4}-/g, "");
        auSplit = a.split(/,\s*/);
        if (auSplit.length >= 2) {
            b.push({
                last: auSplit[0].trim(),
                first: auSplit[1].trim()
            });
        }
        return b;
    },
    removeExtraCharacters: function(a) {
        a = a.replace(/^[^\w]+/, "").replace(/[^\w\.\)]+$/, "");
        var b = a.split(" ").length;
        var c = 0;
        var d = a.match(/\./g);
        if (d) c = d.length;
        if ((c <= b / 2 || c === 1) && a.charAt(a.length - 1) === ".") {
            a = a.substring(0, a.length - 1);
        }
        if (a.charAt(a.length - 1) === ",") {
            a = a.substring(0, a.length - 1);
        }
        a = a.replace(/^\s*\|\s*/g, "");
        a = a.replace(/\|.*/g, "");
        a = a.replace(/\[.*/g, "");
        return a.trim();
    },
    getAuthorTitleJournal: function() {
        var a = this;
        var b = a.c.matches;
        var c = false;
        if (b.nonNumbers.length > 1) {
            var d = a.c.str.substring(b.nonNumbers[0].index + b.nonNumbers[0][0].length, b.nonNumbers[1].index);
            if (d && d.match(/\(?\d{4}\)?/)) {
                c = true;
            }
        }
        for (var e = 0; e < 1; e++) {
            var f = b.nonNumbers[e][0].split(".");
            if (c && b.nonNumbers[e + 1]) {
                f = [ b.nonNumbers[e][0] ].concat(b.nonNumbers[e + 1][0].split("."));
            }
            if (f.length === 3 || f.length === 4 && f[3] === "" || f.length === 2 && b.nonNumbers.length === 2 && c) {
                if (f[0].length < 8 || f[1].length < 8 || f[2] && f[2].length < 8) continue;
                var g = f[0];
                g = g.replace(/original article: /i, "");
                var h = a.splitAuthors([], [ g ], ",", false);
                if (h && h.length) {
                    if (g.indexOf("[Ed]") >= 0) {
                        a.c.pub.editor = h;
                        a.c.pub.booktitle = f[1];
                        a.c.pub.pubtype = "PP_BOOK";
                    } else if (f.length === 2) {
                        a.c.pub.author = h;
                        a.c.pub.booktitle = f[1].trim();
                        a.c.pub.pubtype = "PP_BOOK";
                    } else {
                        a.c.pub.author = h;
                        a.c.pub.title = f[1].trim();
                        a.c.pub.journal = f[2].trim();
                    }
                    a.claimSegment(b.nonNumbers[e]);
                    if (c) a.claimSegment(b.nonNumbers[e + 1]);
                }
            }
        }
    },
    splitAuthors: function(a, b, c, d, e) {
        var f = this;
        var g = b[0].split(c);
        var h = a.length;
        var i = a.concat([]);
        var j = false;
        for (var k = 0; k < g.length; k++) {
            if (g[k].match(/\w/)) {
                var l = g[k];
                if (c === "," && g[k + 1]) {
                    l += "," + g[k + 1];
                    k++;
                } else if (c === " " && e) {
                    while (g[k + 1] && g[k + 1].match(/^[A-Z\s\.,]+$/)) {
                        l += g[k + 1];
                        k++;
                    }
                }
                var m = f.parseAuthor(l);
                if (m[0] && m[0].first && m[0].last || m[0] && m[0].collective) {
                    if (m[0].last && m[0].last.indexOf(" ") >= 0) {
                        j = true;
                    }
                    a.push(m[0]);
                }
            }
        }
        if (j) a = f.splitAuthors(i, b, " ", false, true);
        if (d && a.length > h) f.claimSegment(b);
        return a;
    },
    getPublisher: function() {
        var a = this;
        var b = a.c.matches;
        for (var c = 0; c < b.publishers.length; c++) {
            var d = a.unclaimedString(b.publishers[c]).trim().replace(/published by /i, "");
            a.useSegment(b.publishers[c], "publisher", d);
        }
        var e = a.unused(b.nonNumbers);
        for (var c = 0; c < e.length; c++) {
            if (e[c][0].toLowerCase().indexOf("journal") >= 0) continue;
            if (e.indexOf(":") > 0) ;
            var f = e[c][0].split(/[ -]/);
            var g = "";
            f.map(function(b) {
                if (g) return;
                if (b.replace(/\W/g, "") in a.publisherCities) g = b;
            });
            if (g) {
                var h = e[c][0].split("Ltd.");
                if (h.length > 1) {
                    h[0] = h[0] + "Ltd.";
                } else {
                    h = e[c][0].split(":");
                }
                if (h.length > 1) {
                    if (h[0].indexOf(g) >= 0) {
                        a.c.pub.address = h[0].replace(/^[^\w]+/, "").replace(/[^\w\.\)]+$/, "").replace(/^p+\.\s+/i, "");
                        a.c.pub.publisher = h[1].replace(/^[^\w]+/, "").replace(/[^\w\.\)]+$/, "");
                    } else {
                        a.c.pub.address = h[1].replace(/^[^\w]+/, "").replace(/[^\w\.\)]+$/, "");
                        a.c.pub.publisher = h[0].replace(/^[^\w]+/, "").replace(/[^\w\.\)]+$/, "");
                    }
                    a.claimSegment(e[c]);
                }
            }
        }
    },
    getDoi: function() {
        var a = this;
        var b = a.c.matches;
        var c;
        if (b.dois.length === 1) {
            c = b.dois[0][0];
            if (c.charAt(c.length - 1) === ".") c = c.substring(0, c.length - 1);
            a.useSegment(b.dois[0], "doi", c);
        }
    },
    getJournal: function() {
        var a = this;
        var b = a.c.matches;
        var c = b.nonNumbers;
        for (var d = 0; d < c.length; d++) {
            var e = a.unclaimedString(c[d]).trim();
            if (e.indexOf("ublished") >= 0) continue;
            e = e.replace(/^source:\s*/i, "");
            if (e.charAt(e.length - 1) === "(") e = e.substring(0, e.length - 1);
            e = a.removeExtraCharacters(e);
            e = a.removePresses(e);
            e = a.removeHyperlinks(e);
            e = a.removeAbbreviatedAuthors(e);
            e = e.replace(/^[^\w]+/, "").replace(/[^\w\.\)]+$/, "");
            if (e === "reprinted") continue;
            if (e && e.length) {
                a.useSegment(c[0], "journal", e);
                return;
            }
        }
    },
    getEditors: function() {
        var a = this;
        var b = a.c.matches;
        var c = b.nonNumbers[0];
        var d = c[0].toLowerCase();
        var e = [];
        if (c[0].indexOf("[Ed]") >= 0) {
            e = a.splitAuthors(e, c, "[Ed]", true);
        }
        if (e && e.length) {
            a.c.pub.editor = e;
        }
    },
    getPages: function() {
        var a = this;
        var b = a.c.matches;
        for (var c = 0; c < b.dashNumbers.length; c++) {
            if (!a.overlapping(b.dashNumbers[c], b.parensNumbers)) {
                var d = b.dashNumbers[c][0].replace(/\s/g, "").replace(/\u2013/g, "-");
                var e = a.overlapping(b.dashNumbers[c], b.pagesP);
                if (e) {
                    a.useSegment(b.pagesP[e - 1], "pages", d);
                } else {
                    a.useSegment(b.dashNumbers[c], "pages", d);
                }
                return;
            }
        }
        if (b.plosPages.length) {
            for (var c = 0; c < b.plosPages.length; c++) {
                if (a.c.str.charAt(b.plosPages[c].index - 1) === ":" || a.c.str.charAt(b.plosPages[c].index - 1) === " ") {
                    a.useSegment(b.plosPages[c], "pages", b.plosPages[c][0]);
                    return;
                }
            }
        }
        if (b.pagesP.length) {
            var f = a.unused(b.allNumbers);
            for (var c = 0; c < f.length; c++) {
                var e = a.overlapping(f[c], b.pagesP);
                if (e) {
                    var d = b.pagesP[e - 1][0].replace(/[\(\s]p+a?g?e?s?\.?\s*/, "").replace(/\s/g, "").replace(/\u2013/g, "-");
                    a.useSegment(b.pagesP[e - 1], "pages", d);
                    return;
                }
            }
        }
    },
    getYears: function() {
        var a = this;
        var b = a.c.matches;
        if (a.c.pub.year) return;
        var c = [ "jan", "feb", "mar", "apr", "may", "jun", "jul", "aug", "sep", "oct", "nov", "dec", "january", "february", "march", "april", "may", "june", "july", "august", "september", "october", "november", "december" ];
        var d, e, f;
        for (var g = 0; g < b.yearMonthDays.length; g++) {
            d = b.yearMonthDays[g][0].replace(".", "").match(/(\d{4})\s(\w+)\s(\d+)/);
            e = d[2].toLowerCase();
            f = c.indexOf(e);
            if (f >= 0) {
                f++;
                if (f > 12) f = f - 12;
                a.c.pub.year = d[1];
                a.c.pub.month = f;
                a.c.pub.day = d[3];
                a.claimSegment(b.yearMonthDays[g]);
                return;
            }
        }
        for (var g = 0; g < b.monthDayYears.length; g++) {
            d = b.monthDayYears[g][0].replace(".", "").replace(",", "").match(/(\w+)\s(\d+)\s(\d{4})/);
            e = d[1].toLowerCase();
            f = c.indexOf(e);
            if (f >= 0) {
                f++;
                if (f > 12) f = f - 12;
                a.c.pub.year = d[3];
                a.c.pub.month = f;
                a.c.pub.day = d[2];
                a.claimSegment(b.monthDayYears[g]);
                return;
            }
        }
        for (var g = 0; g < b.dayMonthYears.length; g++) {
            if (a.overlapping(b.dayMonthYears[g], b.volumeNumbers)) continue;
            if (a.overlapping(b.dayMonthYears[g], b.issueNumbers)) continue;
            d = b.dayMonthYears[g][0].replace(".", "").replace(",", "").match(/(\d+)\s(\w+)\s(\d{4})/);
            e = d[2].toLowerCase();
            f = c.indexOf(e);
            if (f >= 0) {
                f++;
                if (f > 12) f = f - 12;
                a.c.pub.year = d[3];
                a.c.pub.month = f;
                a.c.pub.day = d[1];
                a.claimSegment(b.dayMonthYears[g]);
                return;
            }
        }
        for (var g = 0; g < b.yearDayMonths.length; g++) {
            if (a.overlapping(b.yearDayMonths[g], b.volumeNumbers)) continue;
            if (a.overlapping(b.yearDayMonths[g], b.issueNumbers)) continue;
            d = b.yearDayMonths[g][0].replace(".", "").replace(",", "").match(/(\d{4})\s(\d{1,2})\s(\w+)/);
            e = d[3].toLowerCase();
            f = c.indexOf(e);
            if (f >= 0) {
                f++;
                if (f > 12) f = f - 12;
                a.c.pub.year = d[1];
                a.c.pub.month = f;
                a.c.pub.day = d[2];
                a.claimSegment(b.yearDayMonths[g]);
                return;
            }
        }
        var h = [];
        var i = [];
        for (var j = 0; j < b.yearNumbers.length; j++) {
            if (a.overlapping(b.yearNumbers[j], b.dashNumbers)) h.push(j);
            if (a.overlapping(b.yearNumbers[j], b.volumeNumbers)) h.push(j);
            if (a.overlapping(b.yearNumbers[j], b.issueNumbers)) h.push(j);
            if (a.c.claimed.indexOf(b.yearNumbers[j].index) >= 0) h.push(j);
            if (a.c.str.charAt(b.yearNumbers[j].index + b.yearNumbers[j][0].length) === "(") h.push(j);
            if (a.c.str.charAt(b.yearNumbers[j].index + b.yearNumbers[j][0].length) === ":") h.push(j);
            if (a.c.str.charAt(b.yearNumbers[j].index - 1) === ".") h.push(j);
            if (a.c.str.charAt(b.yearNumbers[j].index + b.yearNumbers[j][0].length).match(/\d/)) h.push(j);
            if (a.c.str.charAt(b.yearNumbers[j].index - 1).match(/\d/)) h.push(j);
            if (a.c.str.charAt(b.yearNumbers[j].index + b.yearNumbers[j][0].length).match(/[a-zA-Z]/)) h.push(j);
            if (a.c.str.charAt(b.yearNumbers[j].index - 1).match(/[a-zA-Z]/)) h.push(j);
            if (a.c.str.substring(b.yearNumbers[j].index - 10, b.yearNumbers[j].index).match(/reprinted/i)) h.push(j);
            if (h.indexOf(j) < 0) i.push(j);
        }
        var k = true;
        for (var j = 0; j < i.length - 1; j++) {
            if (b.yearNumbers[i[j]][0] !== b.yearNumbers[i[j + 1]][0]) k = false;
        }
        if (k && i.length > 1) {
            var l = [];
            for (var j = 0; j < i.length; j++) {
                var m = false;
                if (a.overlapping(b.yearNumbers[i[j]], b.monthYears)) m = true;
                if (a.overlapping(b.yearNumbers[i[j]], b.yearMonths)) m = true;
                if (m) {
                    l.push(i[j]);
                } else {
                    a.claimSegment(b.yearNumbers[i[j]]);
                }
            }
            if (l.length === 0) l.push(i[0]);
            i = l;
        }
        if (i.length === 1) {
            a.useSegment(b.yearNumbers[i[0]], "year", b.yearNumbers[i[0]][0]);
            var n = a.overlapping(b.yearNumbers[i[0]], b.slashNumbers);
            if (n) {
                var o = b.slashNumbers[n - 1];
                var p = o[0].match(/(\d{2})\/\d{4}/);
                if (!p || !p[1]) p = o[0].match(/\d{4}\/(\d{2})/);
                if (p && p[1]) {
                    a.useSegment(o, "month", p[1]);
                }
            }
            var q = a.overlapping(b.yearNumbers[i[0]], b.monthYears);
            if (q) {
                var r = b.monthYears[q - 1];
                d = r[0].replace(".", "").replace(",", "").match(/(\w+)\s(\d{4})/);
                e = d[1].toLowerCase();
                f = c.indexOf(e);
                if (f >= 0) {
                    f++;
                    if (f > 12) f = f - 12;
                    a.useSegment(r, "month", f);
                    return;
                }
            }
            var s = a.overlapping(b.yearNumbers[i[0]], b.yearMonths);
            if (s) {
                var t = b.yearMonths[s - 1];
                d = t[0].replace(".", "").replace(",", "").match(/(\d{4})\s(\w+)/);
                e = d[2].toLowerCase();
                f = c.indexOf(e);
                if (f >= 0) {
                    f++;
                    if (f > 12) f = f - 12;
                    a.useSegment(t, "month", f);
                    return;
                }
            }
        } else {
            console.log("MORE THAN ONE LIKELY YEAR");
        }
        var u = a.unused(b.monthDays);
        for (var j = 0; j < u.length; j++) {
            if (a.c.pub.month) continue;
            var v = u[j];
            d = v[0].replace(".", "").replace(",", "").match(/(\w+)\s(\d{1,2})/);
            e = d[1].toLowerCase();
            f = c.indexOf(e);
            if (f >= 0) {
                f++;
                if (f > 12) f = f - 12;
                a.c.pub.day = d[2];
                a.useSegment(v, "month", f);
            }
        }
    },
    getVolumeIssue: function() {
        var a = this;
        var b = a.c.matches;
        var c = a.unused(b.allNumbers);
        for (var d = 0; d < c.length - 1; d++) {
            var e = a.c.str.substring(c[d].index + c[d][0].length);
            if (e.match(/^\s?\(?suppl/i)) {
                a.useSegment(c[d], "volume", c[d][0]);
                c = a.unused(b.allNumbers);
            }
        }
        for (var d = 0; d < c.length; d++) {
            var f = a.overlapping(c[d], b.volumeNumbers);
            if (f) {
                a.useSegment(b.volumeNumbers[f - 1], "volume", c[d][0]);
                c = a.unused(b.allNumbers);
            }
        }
        for (var d = 0; d < c.length - 1; d++) {
            if (a.c.pub.volume) continue;
            var g = a.overlapping(c[d + 1], b.parensNumbers);
            if (g && (c[d].index + c[d][0].length === b.parensNumbers[g - 1].index || c[d].index + c[d][0].length + 1 === b.parensNumbers[g - 1].index)) {
                var f = a.overlapping(c[d], b.volumeNumbers);
                if (f) {
                    a.useSegment(b.volumeNumbers[f - 1], "volume", c[d][0]);
                } else {
                    a.useSegment(c[d], "volume", c[d][0]);
                }
                var h = b.parensNumbers[g - 1][0].replace("(", "").replace(")", "");
                a.useSegment(b.parensNumbers[g - 1], "issue", h);
                return;
            }
        }
        for (var d = 0; d < c.length; d++) {
            if (a.c.str.charAt(c[d].index + c[d][0].length) === ":") {
                a.useSegment(c[d], "volume", c[d][0]);
                c = a.unused(b.allNumbers);
            }
        }
        for (var d = 0; d < c.length; d++) {
            var i = a.overlapping(c[d], b.issueNumbers);
            if (i) {
                a.useSegment(b.issueNumbers[i - 1], "issue", c[d][0]);
                c = a.unused(b.allNumbers);
            }
        }
        for (var d = 0; d < c.length; d++) {
            var j = a.overlapping(c[d], b.parensNumbers);
            if (j) {
                a.useSegment(b.parensNumbers[j - 1], "issue", c[d][0]);
                c = a.unused(b.allNumbers);
            }
        }
        if (!a.c.pub.volume && c.length === 1) {
            a.useSegment(c[0], "volume", c[0][0]);
            c = a.unused(b.allNumbers);
        }
        if (a.c.pub.volume && a.c.pub.pages && !a.c.pub.issue && c.length === 1) {
            a.useSegment(c[0], "issue", c[0][0]);
            c = a.unused(b.allNumbers);
        }
    },
    overlapping: function(a, b) {
        var c = 0;
        for (var d = 0; d < b.length; d++) {
            if (a.index >= b[d].index && a.index < b[d].index + b[d][0].length) {
                c = d + 1;
            }
        }
        return c;
    },
    publisherCities: {
        Aberdeen: 1,
        Abilene: 1,
        Abingdon: 1,
        Acton: 1,
        Adelaide: 1,
        Aignan: 1,
        Akron: 1,
        Alabama: 1,
        Albans: 1,
        Albany: 1,
        Alberquerque: 1,
        Alessandria: 1,
        Alexandria: 1,
        Alresford: 1,
        Alto: 1,
        Amenia: 1,
        Amherst: 1,
        Amsterdam: 1,
        Andover: 1,
        Angeles: 1,
        Angers: 1,
        Annandale: 1,
        Annapolis: 1,
        Antonio: 1,
        Antwerp: 1,
        Arbor: 1,
        Argyll: 1,
        Arlington: 1,
        Armidale: 1,
        Armonk: 1,
        Artamon: 1,
        Artarmon: 1,
        Ashcroft: 1,
        Asheville: 1,
        Ashfield: 1,
        Ashland: 1,
        Athens: 1,
        Atlanta: 1,
        Auckland: 1,
        Austin: 1,
        Baltimore: 1,
        Banff: 1,
        Barbara: 1,
        Barmenda: 1,
        Barrytown: 1,
        Basingstoke: 1,
        Bath: 1,
        Baton: 1,
        Bayreuth: 1,
        Bayswater: 1,
        Beach: 1,
        Belfast: 1,
        Bellatera: 1,
        Berkeley: 1,
        Berks: 1,
        Berlin: 1,
        Bern: 1,
        Bielefeld: 1,
        Binghampton: 1,
        Bingley: 1,
        Birkenhead: 1,
        Birmingham: 1,
        Blackrock: 1,
        Bloomington: 1,
        "Boca Raton": 1,
        Boise: 1,
        Bologna: 1,
        Bondi: 1,
        Borehamwood: 1,
        Boston: 1,
        Boulder: 1,
        Bridgewater: 1,
        Brisbane: 1,
        Bristol: 1,
        Brixton: 1,
        Broadway: 1,
        Bronx: 1,
        Brooklyn: 1,
        Broomall: 1,
        Brouzils: 1,
        Brussels: 1,
        Buckingham: 1,
        Buckinghamshire: 1,
        Budapest: 1,
        Calcutta: 1,
        Calgary: 1,
        Camberwell: 1,
        Cambridge: 1,
        Cambridgeshire: 1,
        Campbell: 1,
        Canberra: 1,
        Carbondale: 1,
        Cardiff: 1,
        Carlton: 1,
        Carnforth: 1,
        Carolina: 1,
        Castle: 1,
        Cedar: 1,
        Champaign: 1,
        Charleston: 1,
        Charlotte: 1,
        Charlottenlund: 1,
        Charlottesville: 1,
        Charnwood: 1,
        Cheltenham: 1,
        Chester: 1,
        Chicago: 1,
        Chichester: 1,
        Christchurch: 1,
        Cincinatti: 1,
        Clark: 1,
        Clayton: 1,
        Clemson: 1,
        Clifton: 1,
        Colchester: 1,
        Collingwood: 1,
        Collins: 1,
        Colombo: 1,
        Columbia: 1,
        Columbus: 1,
        Conway: 1,
        Copenhagen: 1,
        Cornwall: 1,
        Corvallis: 1,
        County: 1,
        "Covent Garden": 1,
        Cranbury: 1,
        Cresskill: 1,
        Cruz: 1,
        Dallas: 1,
        Dame: 1,
        Darmstadt: 1,
        DeKalb: 1,
        Delaware: 1,
        Delhi: 1,
        Denver: 1,
        Derbyshire: 1,
        Detroit: 1,
        Devon: 1,
        Diego: 1,
        Dijon: 1,
        Dingwall: 1,
        Dorset: 1,
        Dublin: 1,
        Dunedin: 1,
        Durban: 1,
        Durham: 1,
        Easthampton: 1,
        Edinburgh: 1,
        Edison: 1,
        Edmonton: 1,
        Enfield: 1,
        Escondido: 1,
        Essex: 1,
        Eugene: 1,
        Evanston: 1,
        Ewing: 1,
        Exeter: 1,
        Fairview: 1,
        Faisalabad: 1,
        Farmington: 1,
        Fayetteville: 1,
        Fishponds: 1,
        Fitzroy: 1,
        Florence: 1,
        Francisco: 1,
        Frankfurt: 1,
        Freeport: 1,
        Fremantle: 1,
        Frenchs: 1,
        Gainesville: 1,
        Gendale: 1,
        Geneva: 1,
        "Gen\xe8ve": 1,
        Gent: 1,
        Georgetown: 1,
        Ghaziabad: 1,
        Glasgow: 1,
        Gloucester: 1,
        Gloucestershire: 1,
        Gosford: 1,
        Goteborg: 1,
        Gottingen: 1,
        "G\xf6ttingen": 1,
        Grahamstown: 1,
        "Grand Rapids": 1,
        Green: 1,
        Greensboro: 1,
        Grenoble: 1,
        Hackney: 1,
        Hadley: 1,
        Hague: 1,
        Halifax: 1,
        Hamburg: 1,
        Hamilton: 1,
        Hampshire: 1,
        Handsowrth: 1,
        Hants: 1,
        Haren: 1,
        Harrogate: 1,
        Harrow: 1,
        Hastings: 1,
        Hauppauge: 1,
        Haven: 1,
        Heidelberg: 1,
        Helsinki: 1,
        Herefordshire: 1,
        Herts: 1,
        Hexham: 1,
        Hildesheim: 1,
        Hillsdale: 1,
        Hiroshima: 1,
        Hoboken: 1,
        Honolulu: 1,
        Houston: 1,
        Houten: 1,
        Huddersfield: 1,
        Hueva: 1,
        Huntington: 1,
        Huntsville: 1,
        Iceland: 1,
        Idaho: 1,
        Illinois: 1,
        Indianapolis: 1,
        Inverness: 1,
        Iowa: 1,
        Ireland: 1,
        Ithaca: 1,
        Jaipur: 1,
        Johannesburg: 1,
        Jyvaskyla: 1,
        Kalamazoo: 1,
        Kansas: 1,
        "Kansas City": 1,
        Kassel: 1,
        Kemptville: 1,
        Kensington: 1,
        Kent: 1,
        Kenthurst: 1,
        Keswick: 1,
        Keynes: 1,
        Kilda: 1,
        Kildare: 1,
        Kingsbury: 1,
        Kingston: 1,
        Kirksville: 1,
        Knoxville: 1,
        Krakow: 1,
        "Krak\xf3w": 1,
        Lancaster: 1,
        Lanham: 1,
        Lansing: 1,
        Laurent: 1,
        Lausanne: 1,
        Lawrence: 1,
        Lebanon: 1,
        Leeds: 1,
        Leicester: 1,
        Leicestershire: 1,
        Leichardt: 1,
        Leiden: 1,
        Lerwick: 1,
        Leuven: 1,
        Lewisburg: 1,
        Lewiston: 1,
        Lexington: 1,
        Lincoln: 1,
        Lincolnshire: 1,
        Liverpool: 1,
        Llandysul: 1,
        Lleida: 1,
        London: 1,
        Lothian: 1,
        Louis: 1,
        Louisville: 1,
        Louvain: 1,
        Loveland: 1,
        Lubbock: 1,
        Lucia: 1,
        Lumpur: 1,
        Lund: 1,
        Luton: 1,
        Macon: 1,
        Madison: 1,
        Madrid: 1,
        Manchester: 1,
        Manila: 1,
        Manningtree: 1,
        Mansfield: 1,
        Marino: 1,
        Markham: 1,
        Maryland: 1,
        Marylebone: 1,
        Meath: 1,
        Melbourne: 1,
        Middlesex: 1,
        Middleton: 1,
        Middletown: 1,
        Milan: 1,
        Milsons: 1,
        "Milton Keynes": 1,
        Mineola: 1,
        Minneapolis: 1,
        Mississippi: 1,
        Montpellier: 1,
        Montreal: 1,
        "Montr\xe9al": 1,
        Monza: 1,
        Morgantown: 1,
        Moro: 1,
        Msida: 1,
        Mulgrave: 1,
        Munchen: 1,
        Munich: 1,
        Munster: 1,
        Nanterre: 1,
        Nashville: 1,
        Nedlands: 1,
        Neuilly: 1,
        Nevada: 1,
        "New South Wales": 1,
        "New York": 1,
        Newark: 1,
        Newcastle: 1,
        "Newcastle-upon-tyne": 1,
        Norfolk: 1,
        Norman: 1,
        Northam: 1,
        Northampton: 1,
        Northumberland: 1,
        Norwich: 1,
        Norwood: 1,
        Nottingham: 1,
        Novato: 1,
        NSW: 1,
        Oakland: 1,
        Oakville: 1,
        Odense: 1,
        Okayama: 1,
        Ontario: 1,
        Orchard: 1,
        Oslo: 1,
        Ottawa: 1,
        Oxford: 1,
        Oxfordshire: 1,
        Oxon: 1,
        Paderborn: 1,
        Pahrump: 1,
        Paris: 1,
        Park: 1,
        Parker: 1,
        Parkville: 1,
        Pasadena: 1,
        Pathumthani: 1,
        Paul: 1,
        Penrith: 1,
        Philadelphia: 1,
        Pietermaritzburg: 1,
        Piscataway: 1,
        Pittsburg: 1,
        Pittsburgh: 1,
        Plymouth: 1,
        Pokfulam: 1,
        Pomfret: 1,
        Pontefract: 1,
        Portland: 1,
        Portsmouth: 1,
        Potsdam: 1,
        Pradesh: 1,
        Praha: 1,
        Pretoria: 1,
        Princeton: 1,
        Providence: 1,
        Provo: 1,
        Pullman: 1,
        Pymble: 1,
        Quebec: 1,
        "Qu\xe9bec": 1,
        Queensland: 1,
        Rajasthan: 1,
        Raleigh: 1,
        Rapids: 1,
        Raton: 1,
        Raynaud: 1,
        Reading: 1,
        Redwood: 1,
        Regina: 1,
        Rennes: 1,
        Reno: 1,
        "Richland Hills": 1,
        Ridgewood: 1,
        Ringwood: 1,
        Riverside: 1,
        Roanoke: 1,
        Rochester: 1,
        Rockaway: 1,
        Rockville: 1,
        Roma: 1,
        Rondebosch: 1,
        "Rose Bay": 1,
        Rossshire: 1,
        Rouge: 1,
        Rushcutters: 1,
        Saarbrucken: 1,
        Sacranebti: 1,
        "Saint-denis": 1,
        Etienne: 1,
        Sakai: 1,
        Salem: 1,
        Sandpoint: 1,
        Scotia: 1,
        Scotsville: 1,
        Seattle: 1,
        Selinsgrove: 1,
        Seoul: 1,
        Sevitengasse: 1,
        Sewanee: 1,
        Sheffield: 1,
        Shropshire: 1,
        Sioux: 1,
        "S\xf6dert\xe4lje": 1,
        Soignies: 1,
        Somerset: 1,
        Somerville: 1,
        Southport: 1,
        Southville: 1,
        Staffs: 1,
        Stanford: 1,
        Stirling: 1,
        Stockbridge: 1,
        Stockholm: 1,
        Stocksfield: 1,
        Street: 1,
        Stroud: 1,
        Stuttgart: 1,
        Suffolk: 1,
        Surrey: 1,
        Sussex: 1,
        Sydney: 1,
        Tampa: 1,
        Tasmania: 1,
        Temecula: 1,
        Tempe: 1,
        Texas: 1,
        Tokyo: 1,
        Toronto: 1,
        Toulouse: 1,
        Townsend: 1,
        Trenton: 1,
        Trier: 1,
        Tubingen: 1,
        "T\xfcbingen": 1,
        Tucson: 1,
        Turku: 1,
        Turnhout: 1,
        Tuscaloosa: 1,
        Tuscon: 1,
        Udine: 1,
        Uppsala: 1,
        Urbana: 1,
        Utah: 1,
        Utrecht: 1,
        Vancouver: 1,
        Vaxjo: 1,
        Venice: 1,
        Vergne: 1,
        Victoria: 1,
        Waco: 1,
        Wales: 1,
        Warwickshire: 1,
        Washington: 1,
        Waterloo: 1,
        Weinheim: 1,
        Wellington: 1,
        Wells: 1,
        Westport: 1,
        Whitefish: 1,
        Willowdale: 1,
        Wilmington: 1,
        Winchester: 1,
        Winfield: 1,
        Winnipeg: 1,
        Woodstock: 1,
        Woollongong: 1,
        Wurzburg: 1,
        Yarra: 1,
        York: 1,
        Yorkshire: 1,
        Zollikofen: 1,
        Zurich: 1
    }
});

PP.library.BibliographicInferer = new PP.library._BibliographicInferer();

PP.library._Date = PP.Class.extend({
    getFields: function() {
        var a = [ {
            name: "year"
        }, {
            name: "month"
        }, {
            name: "day"
        }, {
            name: "unparsed"
        }, {
            name: "literal"
        }, {
            name: "season"
        } ];
        return a;
    },
    autoClean: function(a) {
        var b = this.getFields();
        if (PP.Utils.isNumeric(a)) {
            a = this.format(a, "MMM DD, YYYY");
        }
        if (PP.Utils.isString(a)) {
            a = this.parseDate(a);
        }
        for (var c = 0; c < b.length; c++) {
            var d = b[c].name;
            if (a[d] && PP.Utils.isString(a[d])) {
                a[d] = a[d].replace(/^\s*/, "");
                a[d] = a[d].replace(/\s*$/, "");
                if (d == "year" || d == "day" || d == "month") {
                    if (a[d].match(/^\d+$/)) a[d] = a[d];
                }
            }
        }
        if (a.month && PP.Utils.isString(a.month)) {
            var e = this.monthMap();
            var f = a.month.toUpperCase();
            if (e[f]) {
                a.month = e[f];
            }
        }
        return a;
    },
    yearString: function(a) {
        return a.year || "";
    },
    toString: function(a, b) {
        if (!a) {
            return "";
        }
        b = b || {};
        if (this.isTimestamp(a)) {
            var c = new Date(a * 1e3);
            return this.format(c, "MMM DD, YYYY, h:mm:ss a");
        }
        var d = a.unparsed;
        var e = false;
        if (d !== "" && d !== null && d !== undefined) {
            e = true;
        }
        var f = a.year;
        var g = false;
        if (f !== "" && f !== null && f !== undefined) {
            g = true;
        }
        var h = a.month;
        var i = false;
        if (h !== "" && h !== null && h !== undefined) {
            i = true;
        }
        var j = a.day;
        var k = false;
        if (j !== "" && j !== null && j !== undefined) {
            k = true;
        }
        var l = a.season;
        var m = false;
        if (l !== "" && l !== null && l !== undefined) {
            m = true;
        }
        var n = a.literal;
        var o = false;
        if (n !== "" && n !== null && n !== undefined) {
            o = true;
        }
        f = f || 0;
        h = h || 1;
        if (!PP.Utils.isNumeric(h)) {
            h = 1;
        }
        j = j || 1;
        if (!PP.Utils.isNumeric(j)) {
            j = 1;
        }
        var c = new Date(f, h - 1, j);
        if (g && i && k) {
            return b && b.dashed ? this.format(c, "YYYY-MM-DD") : this.format(c, "MMM DD, YYYY");
        } else if (g && i) {
            return b && b.dashed ? this.format(c, "YYYY-MM") : this.format(c, "MMMM YYYY");
        } else if (i && k) {
            return b && b.dashed ? this.format(c, "MM-DD") : this.format(c, "MMMM DD");
        } else if (g && m) {
            return b && b.dashed ? this.format(c, "YYYY") : l + " " + f;
        } else if (o) {
            if (b && b.escape) {
                n = "{" + n + "}";
            }
            return n;
        } else if (g) {
            return this.format(c, "YYYY");
        } else if (e) {
            return a.unparsed;
        } else {
            return "";
        }
    },
    toCSL: function(a) {
        var b = {};
        var c = [];
        if (a.year && a.month && a.day) {
            c.push(a.year + "");
            c.push(a.month + "");
            c.push(a.day + "");
        } else if (a.year && a.month) {
            c.push(a.year + "");
            c.push(a.month + "");
        } else if (a.year) {
            c.push(a.year + "");
        }
        if (a.literal) {
            b.literal = a.literal;
        } else if (c.length) {
            b["date-parts"] = [ c ];
            if (a.season) {
                if (a.season == "Spring") {
                    b.season = 1;
                } else if (a.season == "Summer") {
                    b.season = 2;
                } else if (a.season == "Autumn" || a.season == "Fall") {
                    b.season = 3;
                } else if (a.season == "Winter") {
                    b.season = 4;
                } else {
                    b.season = a.season;
                }
            }
        }
        return b;
    },
    format: function(a, b) {
        var c = moment(a);
        return c.format(b);
    },
    isTimestamp: function(a) {
        if (PP.Utils.isNumeric(a)) {
            return true;
        }
    },
    hasValue: function(a) {
        if (a === undefined) {
            return false;
        } else {
            if (a.year !== undefined || a.month !== undefined || a.day !== undefined || a.literal !== undefined) {
                return true;
            } else if (this.isTimestamp(a)) {
                return true;
            } else {
                return false;
            }
        }
    },
    extractDate: function(a, b, c) {
        var d = b + "year";
        var e = b + "month";
        var f = b + "day";
        var g = b + "season";
        if (a[d]) {
            a[d] = a[d] + "";
            a[d] = a[d].replace(/^0+/, "");
            a[d] = a[d].replace(/\s/g, "");
            if (!a[d].match(/^\d+$/)) {
                delete a[d];
            }
        }
        var h = this.monthMap();
        if (a[e]) {
            a[e] = a[e] + "";
            a[e] = a[e].replace(/^0+/, "");
            a[e] = a[e].replace(/\s/g, "");
            a[e] = a[e].replace(/\.$/, "");
            if (h[a[e].toUpperCase()]) {
                a[e] = h[a[e].toUpperCase()];
            }
            if (!a[e].match(/^\d+$/)) {
                delete a[e];
            }
        }
        if (a[f]) {
            a[f] = a[f] + "";
            a[f] = a[f].replace(/^0+/, "");
            a[f] = a[f].replace(/\s/g, "");
            if (!a[f].match(/^\d+$/)) {
                delete a[f];
            } else {
                if (a[f] < 1 || a[f] > 31) {
                    delete a[f];
                }
            }
        }
        if (a[g]) {
            a[g] = a[g] + "";
            a[g] = a[g].replace(/^\s+/, "").replace(/\s+$/g, "");
        }
        if (a[d] || a[e] || a[f] || a[g]) {
            if (a[d] && PP.Utils.isString(a[d])) a[d] = a[d];
            if (a[e] && PP.Utils.isString(a[e])) a[e] = a[e];
            if (a[f] && PP.Utils.isString(a[f])) a[f] = a[f];
            a[c] = {
                year: a[d],
                month: a[e],
                day: a[f]
            };
            if (a[g]) {
                a[c].season = a[g];
                delete a[g];
            }
            delete a[d];
            delete a[e];
            delete a[f];
        }
    },
    parseDate: function(a) {
        var b, c, d, e, f, g, h, i;
        var j = this.monthMapAbbr();
        f = [];
        for (g in j) {
            if (!j.hasOwnProperty(g)) continue;
            f.push(g);
        }
        var k = "(" + f.join("|") + ")";
        j = this.monthMap();
        f = [];
        for (g in j) {
            if (!j.hasOwnProperty(g)) continue;
            f.push(g);
        }
        var l = "(" + f.join("|") + ")";
        a = a.replace(/^\s+/, "").replace(/\s+$/, "").replace(/\s+/g, " ");
        g = new RegExp("^\\{(.+)\\}$", "");
        f = a.match(g);
        if (f && f[1]) {
            var m = this.parseLiteral(f[1]);
            if (m.year && PP.Utils.isString(m.year) && m.year.match(/^\d+$/)) {
                m.year = m.year;
            }
            return m;
        }
        i = this.seasonsMap();
        f = [];
        for (g in i) {
            if (!i.hasOwnProperty(g)) continue;
            f.push(g);
        }
        var n = "\\b(" + f.join("|") + ")\\b";
        g = new RegExp("(.*)" + n + "(.*)", "i");
        f = a.match(g);
        if (f && f[0]) {
            f.shift();
            for (g = 0; g < f.length; g++) {
                if (i[f[g].toUpperCase()]) {
                    h = i[f[g].toUpperCase()];
                    f[g] = "";
                }
            }
            a = f.join("");
        }
        a = a.replace(/\d\d:\d\d:\d\d\s+(GMT|EDT|EST|UTC)[^\s]*/, "");
        a = a.replace(/\d\d:\d\d\s+(GMT|EDT|EST|UTC).+/, "");
        a = a.replace(/T?\d\d:\d\d:\d\d.*/, "");
        a = a.replace(/,*\s+(at)?\s*\d\d?:\d\d\s*[ap]m.*/i, "");
        a = a.replace(/^\d?\d:\d\d\s+[AP]M\s+/i, "");
        a = a.replace(/^\s+/, "").replace(/\s+$/, "").replace(/\s+/g, " ");
        a = a.replace(/^(Monday|Tuesday|Wednesday|Thursday|Friday|Saturday|Sunday),?\s*/i, "");
        a = a.replace(/^(Mon|Tue|Wed|Thu|Fri|Sat|Sun),?\s*/i, "");
        a = a.replace(/(\d+)(th|rd|nd|st)/, "$1");
        a = a.replace(/\/+$/, "");
        g = new RegExp("(.*)" + k + "\\.(.*)", "i");
        a = a.replace(g, "$1$2$3");
        a = a.replace(/Sept\b\.?/i, "Sep");
        a = a.replace(/JAN\b/, "Jan");
        a = a.replace(/FEB\b/, "Feb");
        a = a.replace(/MAR\b/, "Mar");
        a = a.replace(/APR\b/, "Apr");
        a = a.replace(/MAY\b/, "May");
        a = a.replace(/JUN\b/, "Jun");
        a = a.replace(/JUL\b/, "Jul");
        a = a.replace(/AUG\b/, "Aug");
        a = a.replace(/SEP\b/, "Sep");
        a = a.replace(/OCT\b/, "Oct");
        a = a.replace(/NOV\b/, "Nov");
        a = a.replace(/DEC\b/, "Dec");
        var o = [];
        b = [ "MM", "M" ];
        c = [ "DD", "D" ];
        var p = [ "YYYY", "YY" ];
        d = [ "-" ];
        b.forEach(function(a) {
            c.forEach(function(b) {
                p.forEach(function(c) {
                    d.forEach(function(d) {
                        var e = c + d + a + d + b;
                        o.push(e);
                        var f = a + d + b + d + c;
                        o.push(f);
                        var g = b + d + a + d + c;
                        o.push(g);
                    });
                });
            });
        });
        b = [ "MMM", "MMMM" ];
        c = [ "D", "DD" ];
        d = [ ",", "" ];
        c.forEach(function(a) {
            b.forEach(function(b) {
                d.forEach(function(c) {
                    var d = b + " " + a + c + " " + "YYYY";
                    o.push(d);
                    var e = b + c + " YYYY";
                    o.push(e);
                });
            });
        });
        o.push("YYYY");
        o.push("D MMM, YYYY");
        var q;
        for (var r in o) {
            if (o[r]) {
                var s = o[r];
                q = moment(a, s);
                if (q) {
                    var t = q.format(s);
                    t = t.replace(/[^a-z0-9]/gi, "-");
                    var u = a;
                    u = u.replace(/[^a-z0-9]/gi, "-");
                    if (t !== u) {
                        continue;
                    } else {
                        var v = {};
                        if (s.match(/(m|n|f)/i)) {
                            v.month = q.month() + 1;
                            v.month = v.month + "";
                        }
                        if (s.match(/y/i)) {
                            v.year = q.year() + "";
                        }
                        if (s.match(/(d|j)/i)) {
                            v.day = q.date() + "";
                        }
                        if (h) {
                            v.season = h;
                        }
                        return v;
                    }
                }
            }
        }
        e = {
            year: null,
            month: null,
            day: null,
            unparsed: a
        };
        if (h) {
            e.season = h;
        }
        if (a.match(/^(\d{4})[\-\/](\d\d)$/)) {
            if (!e.year && !e.month) {
                e.year = RegExp.$1;
                e.month = RegExp.$2;
            }
        }
        if (a.match(/^(\d{4})[\-\/](\d{1,2})[\-\/](\d{1,2})/)) {
            if (!e.day && !e.month && !e.year) {
                e.day = RegExp.$3;
                e.month = RegExp.$2;
                e.year = RegExp.$1;
            }
        }
        if (a.match(/^(\d{1,2})[\-\/](\d{1,2})[\-\/](\d{4})/)) {
            if (!e.day && !e.month && !e.year) {
                e.day = RegExp.$1;
                e.month = RegExp.$2;
                e.year = RegExp.$3;
            }
        }
        g = new RegExp("^" + l + "\\s+(\\d{4})$", "i");
        if (a.match(g)) {
            if (!e.month && !e.year) {
                e.month = RegExp.$1;
                e.year = RegExp.$2;
            }
        }
        g = new RegExp("^" + l + "$", "i");
        if (a.match(g)) {
            if (!e.month && !e.year) {
                e.month = RegExp.$1;
            }
        }
        g = new RegExp("^(\\d+)\\s+" + l + "\\s+(\\d{4})$", "i");
        if (a.match(g)) {
            if (!e.day && !e.month && !e.year) {
                e.day = RegExp.$1;
                e.month = RegExp.$2;
                e.year = RegExp.$3;
            }
        }
        g = new RegExp("^(\\d\\d?)\\s+" + l + "$", "i");
        if (a.match(g)) {
            if (!e.day && !e.month && !e.year) {
                e.day = RegExp.$1;
                e.month = RegExp.$2;
            }
        }
        g = new RegExp("^(\\d{4})\\s+" + l + "$", "i");
        if (a.match(g)) {
            if (!e.month && !e.year) {
                e.year = RegExp.$1;
                e.month = RegExp.$2;
            }
        }
        g = new RegExp("^(\\d{4})\\s+" + l + "\\s*-\\s*" + l + "$", "i");
        if (a.match(g)) {
            if (!e.month && !e.year) {
                e.year = RegExp.$1;
                e.month = RegExp.$2;
            }
        }
        g = new RegExp("^(\\d{4})\\s+" + l + "\\s+(\\d+)$", "i");
        if (a.match(g)) {
            if (!e.day && !e.month && !e.year) {
                e.year = RegExp.$1;
                e.month = RegExp.$2;
                e.day = RegExp.$3;
            }
        }
        if (a.match(/^\d{4}\s[A-Z].*/)) {
            f = a.split(/\s+/);
            if (!e.year) {
                e.year = f[0];
            }
        }
        if (e.month) {
            var w = this.monthMap();
            var x = e.month.toUpperCase();
            if (w[x]) {
                e.month = w[x];
            }
            if (e.month.match(/^\d+$/)) {
                if (parseInt(e.month) < 1 || parseInt(e.month) > 12) {
                    e.month = null;
                    e.day = null;
                }
            } else {
                e.month = null;
            }
        }
        if (!e.year) {
            var y = false;
            if (a.match(l)) y = true;
            if (a.match(/\b(BC|AD|CENTURY)\b/i)) y = true;
            if (a.match(/^\d\d\d\d/)) y = true;
            if (a.match(/\d\d\d\d$/)) y = true;
            if (y) {
                e = this.parseLiteral(a);
            }
        }
        if (e.month) {
            e.month = e.month.replace(/^0/, "");
            if (PP.Utils.isString(e.month) && e.month.match(/^\d+$/)) {
                e.month = parseInt(e.month) + "";
            }
        }
        if (e.day) {
            e.day = e.day.replace(/^0/, "");
            if (PP.Utils.isString(e.day) && e.day.match(/^\d+$/)) {
                e.day = parseInt(e.day) + "";
            }
        }
        if (e.year) {
            if (PP.Utils.isString(e.year) && e.year.match(/^\d+$/)) {
                e.year = parseInt(e.year) + "";
            }
        }
        return e;
    },
    parseLiteral: function(a) {
        var b = {
            literal: a
        };
        var c = new RegExp("(\\d{4})", "i");
        var d = a.match(c);
        if (d && d[1]) {
            b.year = d[1];
        }
        return b;
    },
    monthMapAbbr: function() {
        return {
            JAN: "1",
            FEB: "2",
            MAR: "3",
            APR: "4",
            MAY: "5",
            JUN: "6",
            JUL: "7",
            AUG: "8",
            SEP: "9",
            OCT: "10",
            NOV: "11",
            DEC: "12"
        };
    },
    monthMapFull: function() {
        return {
            JANUARY: "1",
            JANVIER: "1",
            JANUAR: "1",
            ENERO: "1",
            GENNAIO: "1",
            FEBRUARY: "2",
            "F\xc9VRIER": "2",
            FEBRUAR: "2",
            FEBRERO: "2",
            FEBBRAIO: "2",
            MARCH: "3",
            MARS: "3",
            "M\xc4RZ": "3",
            MARZO: "3",
            APRIL: "4",
            AVRIL: "4",
            ABRIL: "4",
            APRILE: "4",
            MAY: "5",
            MAI: "5",
            MAYO: "5",
            MAGGIO: "5",
            JUNE: "6",
            JUIN: "6",
            JUNI: "6",
            JUNIO: "6",
            GIUGNO: "6",
            JULY: "7",
            JUILLET: "7",
            JULI: "7",
            JULIO: "7",
            LUGLIO: "7",
            AUGUST: "8",
            "AO\xdbT": "8",
            AGOSTO: "8",
            SEPTEMBER: "9",
            SEPTEMBRE: "9",
            SEPTIEMBRE: "9",
            SETTEMBRE: "9",
            OCTOBER: "10",
            OCTOBRE: "10",
            OKTOBER: "10",
            OCTUBRE: "10",
            OTTOBRE: "10",
            NOVEMBER: "11",
            NOVEMBRE: "11",
            NOVIEMBRE: "11",
            DECEMBER: "12",
            DECEMBRE: "12",
            "D\xc9CEMBRE": "12",
            DEZEMBER: "12",
            DICIEMBRE: "12",
            DICEMBRE: "12"
        };
    },
    seasonsMap: function() {
        var a = {
            Spring: [ "Fr\xfchling", "primavera", "udaberria" ],
            Summer: [ "Sommer", "estate", "uda" ],
            Autumn: [ "Herbst", "autunno", "udazkena" ],
            Winter: [ "Winter", "inverno", "negua" ]
        };
        var b = {};
        for (var c in a) {
            if (!a.hasOwnProperty(c)) continue;
            b[c.toUpperCase()] = c;
            a[c].forEach(function(a) {
                b[a.toUpperCase()] = c;
            });
        }
        return b;
    },
    monthMap: function() {
        var a = {}, b;
        var c = this.monthMapAbbr();
        for (b in c) {
            if (!c.hasOwnProperty(b)) continue;
            a[b] = c[b];
        }
        c = this.monthMapFull();
        for (b in c) {
            if (!c.hasOwnProperty(b)) continue;
            a[b] = c[b];
        }
        return a;
    }
});

PP.library.Date = new PP.library._Date();

PP.library._Diff = PP.Class.extend({
    diff: function(a, b, c) {
        a = PP.library.Publication.getPersistentData(a);
        b = PP.library.Publication.getPersistentData(b);
        var d = [];
        var e = b.pubtype;
        var f = PP.library.PublicationFields.getFields();
        var g = this.getExcludedFields();
        var h = PP.Array.mapBoolean(g);
        if (c !== undefined) {
            for (var i = 0; i < c.length; i++) {
                h[c[i]] = false;
            }
        }
        var j = 0;
        var k = 0;
        var l = 0;
        for (var i = 0; i < f.length; i++) {
            var m = f[i].name;
            if (h[m] === true) {
                continue;
            }
            var n = this.getFieldValueString(a, m);
            var o = this.getFieldValueString(b, m);
            if (m === "journal" && n && o) {
                n = n.replace(/\./g, "");
                o = o.replace(/\./g, "");
            }
            if (n === null && o === null) {
                continue;
            } else if (n === null) {
                j++;
                d.push({
                    field: m,
                    type: "add",
                    old: n,
                    new: o
                });
            } else if (o === null) {
                k++;
                d.push({
                    field: m,
                    type: "delete",
                    old: n,
                    new: o
                });
            } else if (n !== o) {
                l++;
                d.push({
                    field: m,
                    type: "mod",
                    old: n,
                    new: o
                });
            } else if (n === o) {} else {
                console.log("Weird diff", m, n, o);
            }
        }
        var p = PP.library.Publication.formatAuthorYear(b);
        var q = {
            pubId: b._id,
            pubLabel: p,
            pubType: e,
            pubDiffs: d,
            nAdded: j,
            nRemoved: k,
            nChanged: l
        };
        return q;
    },
    hasValue: function(a, b) {
        var c = PP.library.PublicationFields.getField(b);
        var d = b.fieldType;
        if (c.dataType === "author") {
            return PP.library.Author.hasValue(a[b]);
        } else if (c.dataType === "date") {
            return PP.library.Date.hasValue(a[b]);
        } else if (c.dataType === "array") {
            return PP.Utils.isArray(a[b]) && a[b].length > 0;
        } else {
            return a[b] !== "" && a[b] !== undefined;
        }
    },
    getFieldValueString: function(a, b) {
        var c = PP.library.PublicationFields.getField(b);
        var d = c.fieldType;
        if (!this.hasValue(a, b)) {
            return null;
        }
        if (c.dataType === "author") {
            return PP.library.Author.toString(a[b], {
                output: "forDiff"
            });
        } else if (c.dataType === "date") {
            return PP.library.Date.toString(a[b]);
        } else if (c.dataType === "array") {
            return a[b].join("\n");
        } else {
            return a[b];
        }
    },
    getExcludedFields: function() {
        var a = [ "autocompleted", "collection_timestamps", "crawl_urls", "dup_sha1", "duplicates", "id_list", "sha1", "source", "subfolders", "journal_checked", "xref" ];
        return a;
    },
    formatDiffHtml: function(a) {
        if (!PP.Utils.isArray(a)) {
            a = [ a ];
        }
        var b = new diff_match_patch();
        var c = [];
        for (var d = 0; d < a.length; d++) {
            var e = [];
            var f = a[d];
            var g = f.pubId;
            var h = f.pubLabel;
            var i = f.pubType;
            var j = PP.library.PublicationFields.getFieldsForPubType(i);
            var k = PP.Array.toMap(j, "name");
            e.push('<div class="pp-pub-diff-item">');
            e.push([ '<div class="pp-pub-diff-header">', h, "</div>" ].join(""));
            var l = f.pubDiffs;
            if (l.length === 0) {
                e.push([ '<div class="pp-pub-diff-nochanges">', "No changes made.", "</div>" ].join(""));
            }
            var m = [];
            var n = [];
            var o = [];
            for (var p = 0; p < l.length; p++) {
                var q = "";
                var r = l[p];
                var s = r.field;
                var t = s;
                if (k[s]) {
                    var u = k[s];
                    t = u.label;
                }
                if (s == "pubtype") {
                    t = "Type of item";
                }
                q += '<div class="pp-pub-diff-field">';
                q += [ '<div class="pp-pub-diff-fieldlabel">', t, "</div>" ].join("");
                if (r.type === "add") {
                    q += [ '<div class="pp-pub-diff-fieldvalue">', PP.Utils.midEllipsis(r["new"], 80), "</div>" ].join("");
                } else if (r.type === "mod") {
                    var v = r["old"] + "";
                    var w = r["new"] + "";
                    if (s == "pubtype") {
                        v = PP.library.PublicationTypes.getPubType(r["old"]).label;
                        w = PP.library.PublicationTypes.getPubType(r["new"]).label;
                    }
                    var x = b.diff_main(v, w);
                    b.diff_cleanupSemantic(x);
                    diffHtml = b.diff_prettyHtml(x);
                    if (s !== "url") {
                        diffHtml = PP.String.truncate(diffHtml, 200);
                    }
                    q += [ '<div class="pp-pub-diff-fieldvalue">', diffHtml, "</div>" ].join("");
                } else if (r.type === "remove") {}
                q += "</div>";
                if (r.type === "add") {
                    m.push(q);
                } else if (r.type === "mod") {
                    n.push(q);
                } else {
                    o.push(q);
                }
            }
            if (m.length > 0) {
                e.push('<div class="pp-pub-diff-type">Fields added</div>');
                e.push(m.join(""));
            }
            if (n.length > 0) {
                e.push('<div class="pp-pub-diff-type">Fields updated</div>');
                e.push(n.join(""));
            }
            if (o.length > 0) {
                e.push('<div class="pp-pub-diff-type">Fields removed</div>');
                e.push(o.join(""));
            }
            e.push("</div>");
            c.push(e.join(""));
        }
        return c.join("\n");
    }
});

PP.library.Diff = new PP.library._Diff();

PP.library._Jurisdictions = PP.Class.extend({
    jurisdictions: {
        us: {
            name: "United States",
            abbr: [ {
                name: "SCOTUS",
                court: "Supreme Court"
            }, {
                name: "U.S.",
                court: "Supreme Court",
                default: true
            } ]
        },
        "us:ak": {
            name: "US|Alaska",
            abbr: [ {
                name: "Alaska",
                court: "Supreme Court"
            }, {
                name: "Alaska Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:al": {
            name: "US|Alabama",
            abbr: [ {
                name: "Ala.",
                court: "Supreme Court"
            }, {
                name: "Ala. Civ. App.",
                court: "Court of Civil Appeals"
            }, {
                name: "Ala. Crim. App.",
                court: "Court of Criminal Appeals"
            }, {
                name: "Ala. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:ar": {
            name: "US|Arkansas",
            abbr: [ {
                name: "Ark.",
                court: "Supreme Court"
            }, {
                name: "Ark. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:as": {
            name: "US|American Samoa",
            abbr: []
        },
        "us:az": {
            name: "US|Arizona",
            abbr: [ {
                name: "Ariz.",
                court: "Supreme Court"
            }, {
                name: "Ariz. Ct. App.",
                court: "Court of Appeals"
            }, {
                name: "Ariz. T.C.",
                court: "Tax Court"
            } ]
        },
        "us:c": {
            name: "US|Federal Circuit",
            abbr: [ {
                name: "Federal Circuit",
                court: "Court of Appeals"
            }, {
                name: "Fed. Cir.",
                court: "Court of Appeals",
                default: true
            }, {
                name: "Vet. App.",
                court: "Court of Appeals for Veterans Claims"
            }, {
                name: "Ct. Cl.",
                court: "Court of Claims"
            }, {
                name: "C.C.P.A.",
                court: "Court of Customs and Patent Appeals"
            }, {
                name: "Ct. Intl. Trade",
                court: "Court of International Trade"
            }, {
                name: "Comm. Ct.",
                court: "Commerce Court"
            }, {
                name: "Cust. Ct.",
                court: "Customs Court"
            }, {
                name: "Emer. Ct. App.",
                court: "Emergency Court of Appeals"
            }, {
                name: "FISA Ct.",
                court: "Foreign Intelligence Surveillance Court"
            }, {
                name: "FISA Ct. Rev.",
                court: "Foreign Intelligence Surveillance Court of Review"
            }, {
                name: "J.P.M.L.",
                court: "Judicial Panel on Multidistrict Litigation"
            }, {
                name: "M.C.",
                court: "Court of Military Commission Review"
            }, {
                name: "Tax Ct.",
                court: "Tax Court"
            }, {
                name: "Temp. Emerg. Ct. App.",
                court: "Temporary Emergency Court of Appeals"
            }, {
                name: "Test.",
                court: "Testing Supreme Court"
            }, {
                name: "Fed. Cl.",
                court: "Court of Federal Claims"
            }, {
                name: "U.S.J.C.",
                court: "Judicial Conference Committee"
            }, {
                name: "C.A.A.F.",
                court: "Court of Appeals for the Armed Forces"
            } ]
        },
        "us:c0": {
            name: "US|D.C. Circuit",
            abbr: [ {
                name: "D.C. Cir.",
                court: "Court of Appeals",
                default: true
            }, {
                name: "Dist. of Columbia Circuit",
                court: "Court of Appeals"
            } ]
        },
        "us:c0:dc.d": {
            name: "US|D.C. Circuit|D. District of Columbia",
            abbr: [ {
                name: "Bankr. D.C.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c1": {
            name: "US|First Circuit",
            abbr: [ {
                name: "1st Circuit",
                court: "Court of Appeals"
            }, {
                name: "1st Cir.",
                court: "Court of Appeals",
                default: true
            }, {
                name: "1st Cir. BAP",
                court: "Bankruptcy Appellate Panel"
            } ]
        },
        "us:c10": {
            name: "US|Tenth Circuit",
            abbr: [ {
                name: "10th Circuit",
                court: "Court of Appeals"
            }, {
                name: "10th Cir.",
                court: "Court of Appeals",
                default: true
            }, {
                name: "10th Cir. BAP",
                court: "Bankruptcy Appellate Panel"
            } ]
        },
        "us:c10:co.d": {
            name: "US|Tenth Circuit|D. Colorado",
            abbr: [ {
                name: "D. Colorado",
                court: "District Court"
            }, {
                name: "D. Colo.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Colo.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c10:ks.d": {
            name: "US|Tenth Circuit|D. Kansas",
            abbr: [ {
                name: "D. Kansas"
            }, {
                name: "Bankr. D. Kan.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c10:nm.d": {
            name: "US|Tenth Circuit|D. New Mexico",
            abbr: [ {
                name: "D. New Mexico",
                court: "District Court"
            }, {
                name: "D.N.M.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.N.M.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c10:ok.ed": {
            name: "US|Tenth Circuit|E.D. Oklahoma",
            abbr: [ {
                name: "E.D. Oklahoma",
                court: "District Court"
            }, {
                name: "E.D. Okla.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Okla.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c10:ok.nd": {
            name: "US|Tenth Circuit|N.D. Oklahoma",
            abbr: [ {
                name: "N.D. Oklahoma",
                court: "District Court"
            }, {
                name: "N.D. Okla.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Okla",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c10:ok.wd": {
            name: "US|Tenth Circuit|W.D. Oklahoma",
            abbr: [ {
                name: "W.D. Oklahoma",
                court: "District Court"
            }, {
                name: "W.D. Okla.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Okla.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c10:ut.d": {
            name: "US|Tenth Circuit|D. Utah",
            abbr: [ {
                name: "D. Utah",
                court: "United States District Court"
            }, {
                name: "Bankr. D. Utah",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c10:wy.d": {
            name: "US|Tenth Circuit|D. Wyoming",
            abbr: [ {
                name: "D. Wyoming",
                court: "District Court"
            }, {
                name: "Bankr. D. Wyo.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c11": {
            name: "US|Eleventh Circuit",
            abbr: [ {
                name: "11th Circuit",
                court: "Court of Appeals"
            }, {
                name: "11th Cir.",
                court: "Court of Appeals",
                default: true
            } ]
        },
        "us:c11:al.md": {
            name: "US|Eleventh Circuit|M.D. Alabama",
            abbr: [ {
                name: "MD Alabama",
                court: "District Court"
            }, {
                name: "M.D. Ala.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. M.D. Ala.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c11:al.nd": {
            name: "US|Eleventh Circuit|N.D. Alabama",
            abbr: [ {
                name: "N.D. Alabama",
                court: "District Court"
            }, {
                name: "N.D. Ala.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Ala.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c11:al.sd": {
            name: "US|Eleventh Circuit|S.D. Alabama",
            abbr: [ {
                name: "S.D. Alabama",
                court: "District Court"
            }, {
                name: "S.D. Ala.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D. Ala.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c11:fl.md": {
            name: "US|Eleventh Circuit|M.D. Florida",
            abbr: [ {
                name: "MD Florida",
                court: "District Court"
            }, {
                name: "M.D. Fla.",
                court: "District Court",
                default: true
            } ]
        },
        "us:c11:fl.nd": {
            name: "US|Eleventh Circuit|N.D. Florida",
            abbr: [ {
                name: "N.D. Florida",
                court: "District Court"
            }, {
                name: "N.D. Fla.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Fla.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c11:fl.sd": {
            name: "US|Eleventh Circuit|S.D. Florida",
            abbr: [ {
                name: "S.D. Florida",
                court: "District Court"
            }, {
                name: "S.D. Fla.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D. Florida",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c11:ga.md": {
            name: "US|Eleventh Circuit|M.D. Georgia",
            abbr: [ {
                name: "MD Georgia"
            }, {
                name: "Bankr. M.D. Ga.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c11:ga.nd": {
            name: "US|Eleventh Circuit|N.D. Georgia",
            abbr: [ {
                name: "N.D. Georgia",
                court: "District Court"
            }, {
                name: "N.D. Ga.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Ga.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c11:ga.sd": {
            name: "US|Eleventh Circuit|S.D. Georgia",
            abbr: [ {
                name: "S.D. Georgia",
                court: "District Court"
            }, {
                name: "S.D. Ga.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D. Ga.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c1:ma.d": {
            name: "US|First Circuit|D. Massachusetts",
            abbr: [ {
                name: "D. Massachusetts",
                court: "District Court"
            }, {
                name: "D. Mass.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Mass.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c1:me.d": {
            name: "US|First Circuit|D. Maine",
            abbr: [ {
                name: "D. Maine",
                court: "District Court"
            }, {
                name: "D. Me.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Me.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c1:nh.d": {
            name: "US|First Circuit|D. New Hampshire",
            abbr: [ {
                name: "D. New Hampshire",
                court: "District Court"
            }, {
                name: "D.N.H.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.N.H.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c1:pr.d": {
            name: "US|First Circuit|D. Puerto Rico",
            abbr: [ {
                name: "D. Puerto Rico",
                court: "District Court"
            }, {
                name: "D.P.R.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.P.R.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c1:ri.d": {
            name: "US|First Circuit|D. Rhode Island",
            abbr: [ {
                name: "D. Rhode Island",
                court: "District Court"
            }, {
                name: "D.R.I.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.R.I.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c2": {
            name: "US|Second Circuit",
            abbr: [ {
                name: "2nd Circuit",
                court: "Court of Appeals"
            }, {
                name: "2d Cir.",
                court: "Court of Appeals",
                default: true
            }, {
                name: "2d Cir. BAP",
                court: "Bankruptcy Appellate Panel"
            } ]
        },
        "us:c2:ct.d": {
            name: "US|Second Circuit|D. Connecticut",
            abbr: [ {
                name: "D. Connecticut",
                court: "District Court"
            }, {
                name: "D. Conn.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Conn.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c2:ny.ed": {
            name: "US|Second Circuit|E.D. New York",
            abbr: [ {
                name: "E.D. New York",
                court: "District Court"
            }, {
                name: "E.D.N.Y",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D.N.Y.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c2:ny.nd": {
            name: "US|Second Circuit|N.D. New York",
            abbr: [ {
                name: "N.D. New York",
                court: "District Court"
            }, {
                name: "Bankr. N.D.N.Y.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c2:ny.sd": {
            name: "US|Second Circuit|S.D. New York",
            abbr: [ {
                name: "S.D. New York",
                court: "District Court"
            }, {
                name: "S.D.N.Y.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D.N.Y.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c2:ny.wd": {
            name: "US|Second Circuit|W.D. New York",
            abbr: [ {
                name: "W.D. New York",
                court: "District Court"
            }, {
                name: "W.D.N.Y.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D.N.Y.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c2:vt.d": {
            name: "US|Second Circuit|D. Vermont",
            abbr: [ {
                name: "D. Vermont",
                court: "District Court"
            }, {
                name: "D. Vt.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Vt.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c3": {
            name: "US|Third Circuit",
            abbr: [ {
                name: "3rd Circuit",
                court: "Court of Appeals"
            }, {
                name: "3rd Cir.",
                court: "Court of Appeals",
                default: true
            } ]
        },
        "us:c3:de.d": {
            name: "US|Third Circuit|D. Delaware",
            abbr: [ {
                name: "D. Delaware",
                court: "District Court"
            }, {
                name: "D. Del.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Del.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c3:nj.d": {
            name: "US|Third Circuit|D. New Jersey",
            abbr: [ {
                name: "D. New Jersey",
                court: "District Court"
            }, {
                name: "D.N.J.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.N.J.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c3:pa.d": {
            name: "US|Third Circuit|D. Pennsylvania",
            abbr: [ {
                name: "D. Pa.",
                court: "District Court"
            } ]
        },
        "us:c3:pa.ed": {
            name: "US|Third Circuit|E.D. Pennsylvania",
            abbr: [ {
                name: "E.D. Pennsylvania",
                court: "District Court"
            }, {
                name: "E.D. Pa.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Pa.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c3:pa.md": {
            name: "US|Third Circuit|M.D. Pennsylvania",
            abbr: [ {
                name: "MD Pennsylvania",
                court: "District Court"
            }, {
                name: "M.D. Penn.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. M.D. Penn.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c3:pa.wd": {
            name: "US|Third Circuit|W.D. Pennsylvania",
            abbr: [ {
                name: "W.D. Pennsylvania",
                court: "District Court"
            }, {
                name: "W.D. Pa.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Pa.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c3:vi.d": {
            name: "US|Third Circuit|D. U.S. Virgin Islands",
            abbr: [ {
                name: "D. Virgin Islands",
                court: "District Court"
            }, {
                name: "D.V.I.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.V.I.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4": {
            name: "US|Fourth Circuit",
            abbr: [ {
                name: "4th Circuit",
                court: "Court of Appeals"
            }, {
                name: "4th Cir.",
                court: "Court of Appeals",
                default: true
            } ]
        },
        "us:c4:md.d": {
            name: "US|Fourth Circuit|D. Maryland",
            abbr: [ {
                name: "D. Maryland",
                court: "District Court"
            }, {
                name: "Bankr. D. Md.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4:nc.ed": {
            name: "US|Fourth Circuit|E.D. North Carolina",
            abbr: [ {
                name: "E.D. North Carolina",
                court: "District Court"
            }, {
                name: "E.D.N.C.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D.N.C.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4:nc.md": {
            name: "US|Fourth Circuit|M.D. North Carolina",
            abbr: [ {
                name: "MD North Carolina",
                court: "District Court"
            }, {
                name: "M.D.N.C.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. M.D.N.C.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4:nc.wd": {
            name: "US|Fourth Circuit|W.D. North Carolina",
            abbr: [ {
                name: "W.D. North Carolina",
                court: "District Court"
            }, {
                name: "W.D.N.C.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D.N.C.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4:sc.ed": {
            name: "US|Fourth Circuit|E.D. South Carolina",
            abbr: [ {
                name: "E.D. South Carolina",
                court: "District Court"
            }, {
                name: "E.D.S.C.",
                court: "District Court",
                default: true
            } ]
        },
        "us:c4:sc.wd": {
            name: "US|Fourth Circuit|W.D. South Carolina",
            abbr: [ {
                name: "W.D. South Carolina",
                court: "District Court"
            }, {
                name: "W.D.S.C.",
                court: "District Court",
                default: true
            } ]
        },
        "us:c4:sc.d": {
            name: "US|Fourth Circuit|D. South Carolina",
            abbr: [ {
                name: "D. South Carolina",
                court: "District Court"
            }, {
                name: "D.S.C.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.S.C.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4:va.ed": {
            name: "US|Fourth Circuit|E.D. Virginia",
            abbr: [ {
                name: "E.D. Virginia",
                court: "District Court"
            }, {
                name: "E.D. Va.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Va.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4:va.wd": {
            name: "US|Fourth Circuit|W.D. Virginia",
            abbr: [ {
                name: "W.D. Virginia",
                court: "District Court"
            }, {
                name: "W.D. Va.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Va.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4:wv.nd": {
            name: "US|Fourth Circuit|N.D. West Virginia",
            abbr: [ {
                name: "N.D. West Virginia",
                court: "District Court"
            }, {
                name: "N.D.W. Va.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D.W. Va.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c4:wv.sd": {
            name: "US|Fourth Circuit|S.D. West Virginia",
            abbr: [ {
                name: "S.D. West Virginia",
                court: "District Court"
            }, {
                name: "S.D.W. Va",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D.W. Va.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5": {
            name: "US|Fifth Circuit",
            abbr: [ {
                name: "5th Circuit",
                court: "Court of Appeals"
            }, {
                name: "5th Cir.",
                court: "Court of Appeals",
                default: true
            } ]
        },
        "us:c5:la.ed": {
            name: "US|Fifth Circuit|E.D. Louisiana",
            abbr: [ {
                name: "E.D. Louisiana",
                court: "District Court"
            }, {
                name: "E.D. La.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. La.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5:la.md": {
            name: "US|Fifth Circuit|M.D. Louisiana",
            abbr: [ {
                name: "MD Louisiana",
                court: "District Court"
            }, {
                name: "M.D. La.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. M.D. La.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5:la.wd": {
            name: "US|Fifth Circuit|W.D. Louisiana",
            abbr: [ {
                name: "W.D. Louisiana",
                court: "District Court"
            }, {
                name: "W.D. La.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. La.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5:ms.nd": {
            name: "US|Fifth Circuit|N.D. Mississippi",
            abbr: [ {
                name: "N.D. Mississippi",
                court: "District Court"
            }, {
                name: "N.D. Miss.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Miss.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5:ms.sd": {
            name: "US|Fifth Circuit|S.D. Mississippi",
            abbr: [ {
                name: "S.D. Mississippi",
                court: "District Court"
            }, {
                name: "S.D. Miss.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D. Miss.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5:pz.d": {
            name: "US|Fifth Circuit|D. Panama Canal Zone",
            abbr: []
        },
        "us:c5:tx.ed": {
            name: "US|Fifth Circuit|E.D. Texas",
            abbr: [ {
                name: "E.D. Texas",
                court: "District Court"
            }, {
                name: "E.D. Tex.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Tex.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5:tx.nd": {
            name: "US|Fifth Circuit|N.D. Texas",
            abbr: [ {
                name: "N.D. Texas",
                court: "District Court"
            }, {
                name: "N.D. Tex.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Tex.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5:tx.sd": {
            name: "US|Fifth Circuit|S.D. Texas",
            abbr: [ {
                name: "S.D. Texas",
                court: "District Court"
            }, {
                name: "S.D. Tex.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D. Tex.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c5:tx.wd": {
            name: "US|Fifth Circuit|W.D. Texas",
            abbr: [ {
                name: "W.D. Texas",
                court: "District Court"
            }, {
                name: "W.D. Tex.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Tex.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6": {
            name: "US|Sixth Circuit",
            abbr: [ {
                name: "6th Circuit",
                court: "Court of Appeals"
            }, {
                name: "6th Cir.",
                court: "Court of Appeals",
                default: true
            }, {
                name: "6th Cir. BAP",
                court: "Bankruptcy Appellate Panel"
            } ]
        },
        "us:c6:ky.ed": {
            name: "US|Sixth Circuit|E.D. Kentucky",
            abbr: [ {
                name: "E.D. Kentucky",
                court: "District Court"
            }, {
                name: "E.D. Ky.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Ky.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:ky.wd": {
            name: "US|Sixth Circuit|W.D. Kentucky",
            abbr: [ {
                name: "W.D. Kentucky",
                court: "District Court"
            }, {
                name: "W.D. Ky.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Ky.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:mi.ed": {
            name: "US|Sixth Circuit|E.D. Michigan",
            abbr: [ {
                name: "E.D. Michigan",
                court: "District Court"
            }, {
                name: "E.D. Mich.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Mich.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:mi.wd": {
            name: "US|Sixth Circuit|W.D. Michigan",
            abbr: [ {
                name: "W.D. Michigan"
            }, {
                name: "Bankr. W.D. Mich.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:oh.d": {
            name: "US|Sixth Circuit|D. Ohio",
            abbr: [ {
                name: "D. Ohio",
                court: "District Court"
            } ]
        },
        "us:c6:oh.nd": {
            name: "US|Sixth Circuit|N.D. Ohio",
            abbr: [ {
                name: "N.D. Ohio",
                court: "District Court"
            }, {
                name: "Bankr. N.D. Ohio",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:oh.sd": {
            name: "US|Sixth Circuit|S.D. Ohio",
            abbr: [ {
                name: "S.D. Ohio",
                court: "District Court"
            }, {
                name: "Bankr. S.D. Ohio",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:tn.d": {
            name: "US|Sixth Circuit|D. Tennessee",
            abbr: [ {
                name: "D. Tenn.",
                court: "District Court"
            }, {
                name: "Bankr. D. Tenn.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:tn.ed": {
            name: "US|Sixth Circuit|E.D. Tennessee",
            abbr: [ {
                name: "E.D. Tennessee",
                court: "District Court"
            }, {
                name: "E.D. Tenn.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Tenn.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:tn.md": {
            name: "US|Sixth Circuit|M.D. Tennessee",
            abbr: [ {
                name: "MD Tennessee",
                court: "District Court"
            }, {
                name: "M.D. Tenn.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. M.D. Tenn.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c6:tn.wd": {
            name: "US|Sixth Circuit|W.D. Tennessee",
            abbr: [ {
                name: "W.D. Tennessee",
                court: "District Court"
            }, {
                name: "W.D. Tenn.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Tenn.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c7": {
            name: "US|Seventh Circuit",
            abbr: [ {
                name: "7th Circuit",
                court: "Court of Appeals"
            }, {
                name: "7th Cir.",
                court: "Court of Appeals",
                default: true
            } ]
        },
        "us:c7:il.cd": {
            name: "US|Seventh Circuit|C.D. Illinois",
            abbr: [ {
                name: "CD Illinois",
                court: "District Court"
            }, {
                name: "C.D. Ill.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. C.D. Ill.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c7:il.d": {
            name: "US|Seventh Circuit|D. Illinois",
            abbr: [ {
                name: "D. Ill.",
                court: "District Court"
            } ]
        },
        "us:c7:il.ed": {
            name: "US|Seventh Circuit|E.D. Illinois",
            abbr: [ {
                name: "E.D. Ill.",
                court: "District Court"
            } ]
        },
        "us:c7:il.nd": {
            name: "US|Seventh Circuit|N.D. Illinois",
            abbr: [ {
                name: "N.D. Illinois",
                court: "District Court"
            }, {
                name: "N.D. Ill.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Ill.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c7:il.sd": {
            name: "US|Seventh Circuit|S.D. Illinois",
            abbr: [ {
                name: "S.D. Illinois",
                court: "District Court"
            }, {
                name: "S.D. Ill.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D. Ill.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c7:in.d": {
            name: "US|Seventh Circuit|D. Indiana",
            abbr: [ {
                name: "D. Ind.",
                court: "District Court"
            } ]
        },
        "us:c7:in.nd": {
            name: "US|Seventh Circuit|N.D. Indiana",
            abbr: [ {
                name: "N.D. Indiana",
                court: "District Court"
            }, {
                name: "N.D. Ind.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Ind.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c7:in.sd": {
            name: "US|Seventh Circuit|S.D. Indiana",
            abbr: [ {
                name: "S.D. Indiana",
                court: "District Court"
            }, {
                name: "S.D. Ind.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D. Ind.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c7:wi.ed": {
            name: "US|Seventh Circuit|E.D. Wisconsin",
            abbr: [ {
                name: "E.D. Wisconsin",
                court: "District Court"
            }, {
                name: "E.D. Wis.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Wis.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c7:wi.wd": {
            name: "US|Seventh Circuit|W.D. Wisconsin",
            abbr: [ {
                name: "W.D. Wisconsin",
                court: "District Court"
            }, {
                name: "W.D. Wis.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Wis.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8": {
            name: "US|Eighth Circuit",
            abbr: [ {
                name: "8th Circuit",
                court: "Court of Appeals"
            }, {
                name: "8th Cir.",
                court: "Court of Appeals",
                default: true
            }, {
                name: "8th Cir. BAP",
                court: "United States Bankruptcy Appellate Panel"
            } ]
        },
        "us:c8:ar.ed": {
            name: "US|Eighth Circuit|E.D. Arkansas",
            abbr: [ {
                name: "E.D. Arkansas",
                court: "District Court"
            }, {
                name: "E.D. Ark.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Ark.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:ar.wd": {
            name: "US|Eighth Circuit|W.D. Arkansas",
            abbr: [ {
                name: "W.D. Arkansas",
                court: "District Court"
            }, {
                name: "W.D. Ark.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Ark.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:ia.nd": {
            name: "US|Eighth Circuit|N.D. Iowa",
            abbr: [ {
                name: "N.D. Iowa",
                court: "District Court"
            }, {
                name: "Bankr. N.D. Iowa",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:ia.sd": {
            name: "US|Eighth Circuit|S.D. Iowa",
            abbr: [ {
                name: "S.D. Iowa",
                court: "District Court"
            }, {
                name: "Bankr. S.D. Iowa",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:mn.d": {
            name: "US|Eighth Circuit|D. Minnesota",
            abbr: [ {
                name: "Minnesota",
                court: "District Court"
            }, {
                name: "D. Minnesota",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Minn.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:mo.cd": {
            name: "US|Eighth Circuit|C.D. Missouri",
            abbr: [ {
                name: "C.D. Mo.",
                court: "District Court"
            } ]
        },
        "us:c8:mo.ed": {
            name: "US|Eighth Circuit|E.D. Missouri",
            abbr: [ {
                name: "E.D. Missouri",
                court: "District Court"
            }, {
                name: "E.D. Mo.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Mo.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:mo.sd": {
            name: "US|Eighth Circuit|S.D. Missouri",
            abbr: [ {
                name: "Mo. S.D.",
                court: "District Court"
            } ]
        },
        "us:c8:mo.wd": {
            name: "US|Eighth Circuit|W.D. Missouri",
            abbr: [ {
                name: "W.D. Missouri",
                court: "District Court"
            }, {
                name: "W.D. Mo.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Mo.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:nd.d": {
            name: "US|Eighth Circuit|D. North Dakota",
            abbr: [ {
                name: "D. North Dakota",
                court: "District Court"
            }, {
                name: "D.N.D.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.N.D.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:ne.d": {
            name: "US|Eighth Circuit|D. Nebraska",
            abbr: [ {
                name: "D. Nebraska",
                court: "District Court"
            }, {
                name: "D. Neb.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Neb.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c8:sd.d": {
            name: "US|Eighth Circuit|D. South Dakota",
            abbr: [ {
                name: "D. South Dakota",
                court: "District Court"
            }, {
                name: "D.S.D.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D.S.D.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9": {
            name: "US|Ninth Circuit",
            abbr: [ {
                name: "9th Circuit",
                court: "Court of Appeals"
            }, {
                name: "9th Cir.",
                court: "Court of Appeals",
                default: true
            }, {
                name: "9th Cir. BAP",
                court: "United States Bankruptcy Appellate Panel"
            } ]
        },
        "us:c9:ak.d": {
            name: "US|Ninth Circuit|D. Alaska",
            abbr: [ {
                name: "D. Alaska",
                court: "District Court"
            }, {
                name: "Bankr. D. Alaska",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:az.d": {
            name: "US|Ninth Circuit|D. Arizona",
            abbr: [ {
                name: "D. Arizona",
                court: "District Court"
            }, {
                name: "D. Ariz.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Ariz.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:ca.cd": {
            name: "US|Ninth Circuit|C.D. California",
            abbr: [ {
                name: "CD California",
                court: "District Court"
            }, {
                name: "C.D. Cal.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. C.D. Cal.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:ca.d": {
            name: "US|Ninth Circuit|D. California",
            abbr: [ {
                name: "D. Cal.",
                court: "District Court"
            } ]
        },
        "us:c9:ca.ed": {
            name: "US|Ninth Circuit|E.D. California",
            abbr: [ {
                name: "E.D. California",
                court: "District Court"
            }, {
                name: "E.D. Cal.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Cal.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:ca.nd": {
            name: "US|Ninth Circuit|N.D. California",
            abbr: [ {
                name: "N.D. California",
                court: "District Court"
            }, {
                name: "N.D. Cal.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. N.D. Cal.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:ca.sd": {
            name: "US|Ninth Circuit|S.D. California",
            abbr: [ {
                name: "S.D. California",
                court: "District Court"
            }, {
                name: "S.D. Cal.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. S.D. Cal.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:gu.d": {
            name: "US|Ninth Circuit|D. Guam",
            abbr: [ {
                name: "D. Guam",
                court: "District Court"
            }, {
                name: "Bankr. D. Guam",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:hi.d": {
            name: "US|Ninth Circuit|D. Hawaii",
            abbr: [ {
                name: "D. Hawaii",
                court: "District Court"
            }, {
                name: "D. Haw.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Haw.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:id.d": {
            name: "US|Ninth Circuit|D. Idaho",
            abbr: [ {
                name: "D. Idaho",
                court: "District Court"
            }, {
                name: "Bankr. D. Idaho",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:mp.d": {
            name: "US|Ninth Circuit|D. Northern Mariana Islands",
            abbr: [ {
                name: "N. Mar. I.",
                court: "District Court"
            }, {
                name: "Bankr. N. Mar. I.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:mt.d": {
            name: "US|Ninth Circuit|D. Montana",
            abbr: [ {
                name: "D. Montana",
                court: "District Court"
            }, {
                name: "D. Mont.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Mont.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:nv.d": {
            name: "US|Ninth Circuit|D. Nevada",
            abbr: [ {
                name: "D. Nevada",
                court: "District Court"
            }, {
                name: "D. Nev.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Nev.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:or.d": {
            name: "US|Ninth Circuit|D. Oregon",
            abbr: [ {
                name: "D. Oregon",
                court: "District Court"
            }, {
                name: "D. Or.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. D. Or.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:wa.ed": {
            name: "US|Ninth Circuit|E.D. Washington",
            abbr: [ {
                name: "E.D. Washington",
                court: "District Court"
            }, {
                name: "E.D. Wash.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. E.D. Wash.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:c9:wa.wd": {
            name: "US|Ninth Circuit|W.D. Washington",
            abbr: [ {
                name: "W.D. Washington",
                court: "District Court"
            }, {
                name: "W.D. Wash.",
                court: "District Court",
                default: true
            }, {
                name: "Bankr. W.D. Wash.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:ca": {
            name: "US|California",
            abbr: [ {
                name: "Cal.",
                court: "Supreme Court"
            }, {
                name: "Cal. Ct. App.",
                court: "Court of Appeal"
            } ]
        },
        "us:co": {
            name: "US|Colorado",
            abbr: [ {
                name: "Colo.",
                court: "Supreme Court"
            }, {
                name: "Colo. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:ct": {
            name: "US|Connecticut",
            abbr: [ {
                name: "Conn.",
                court: "Supreme Court"
            }, {
                name: "Conn. App. Ct.",
                court: "Appellate Court"
            }, {
                name: "Conn. Super. Ct.",
                court: "Superior Court"
            } ]
        },
        "us:dc": {
            name: "US|District of Columbia",
            abbr: []
        },
        "us:de": {
            name: "US|Delaware",
            abbr: [ {
                name: "Del.",
                court: "Supreme Court"
            }, {
                name: "Del. Ch.",
                court: "Court of Chancery"
            }, {
                name: "Del. Fm. Ct.",
                court: "Family Court"
            }, {
                name: "Ct. Jud. Del.",
                court: "Court on the Judiciary"
            }, {
                name: "Del. Super. Ct.",
                court: "Superior Court"
            } ]
        },
        "us:fl": {
            name: "US|Florida",
            abbr: [ {
                name: "Fla.",
                court: "Supreme Court"
            }, {
                name: "Fla. Dist. Ct. App.",
                court: "District Court of Appeal"
            }, {
                name: "Bankr. M.D. Fla.",
                court: "Bankruptcy Court"
            } ]
        },
        "us:ga": {
            name: "US|Georgia",
            abbr: [ {
                name: "Ga",
                court: "Supreme Court"
            }, {
                name: "Ga. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:gu": {
            name: "US|Guam",
            abbr: []
        },
        "us:hi": {
            name: "US|Hawaii",
            abbr: [ {
                name: "Haw.",
                court: "Supreme Court"
            }, {
                name: "Haw. App.",
                court: "Intermediate Court of Appeals"
            } ]
        },
        "us:ia": {
            name: "US|Iowa",
            abbr: [ {
                name: "Iowa",
                court: "Supreme Court"
            }, {
                name: "Iowa Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:id": {
            name: "US|Idaho",
            abbr: [ {
                name: "Idaho",
                court: "Supreme Court"
            }, {
                name: "Idaho Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:il": {
            name: "US|Illinois",
            abbr: [ {
                name: "Ill.",
                court: "Supreme Court"
            }, {
                name: "Ill. App. Ct.",
                court: "Appellate Court"
            } ]
        },
        "us:in": {
            name: "US|Indiana",
            abbr: [ {
                name: "Ind.",
                court: "Supreme Court"
            }, {
                name: "Ind. Ct. App.",
                court: "Court of Appeals"
            }, {
                name: "Ind. T.C.",
                court: "Tax Court"
            } ]
        },
        "us:ks": {
            name: "US|Kansas",
            abbr: [ {
                name: "Kan.",
                court: "Supreme Court"
            }, {
                name: "Kan. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:ky": {
            name: "US|Kentucky",
            abbr: [ {
                name: "Ky.",
                court: "Supreme Court"
            }, {
                name: "Ky. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:la": {
            name: "US|Louisiana",
            abbr: [ {
                name: "La.",
                court: "Supreme Court"
            }, {
                name: "La. Ct. App.",
                court: "Court of Appeal"
            } ]
        },
        "us:ma": {
            name: "US|Massachusetts",
            abbr: [ {
                name: "Mass.",
                court: "Supreme Judicial Court"
            }, {
                name: "Mass. App. Ct.",
                court: "Appeals Court"
            } ]
        },
        "us:md": {
            name: "US|Maryland",
            abbr: [ {
                name: "Md.",
                court: "Court of Appeals"
            }, {
                name: "Md. Ct. Spec. App.",
                court: "Court of Special Appeals"
            } ]
        },
        "us:me": {
            name: "US|Maine",
            abbr: [ {
                name: "Me.",
                court: "Supreme Judicial Court"
            } ]
        },
        "us:mi": {
            name: "US|Michigan",
            abbr: [ {
                name: "Mich.",
                court: "Supreme Court"
            }, {
                name: "Mich. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:mn": {
            name: "US|Minnesota",
            abbr: [ {
                name: "Minn.",
                court: "Supreme Court"
            }, {
                name: "Minn. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:mo": {
            name: "US|Missouri",
            abbr: [ {
                name: "Mo.",
                court: "Supreme Court"
            }, {
                name: "Mo. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:mp": {
            name: "US|Northern Mariana Islands",
            abbr: []
        },
        "us:ms": {
            name: "US|Mississippi",
            abbr: [ {
                name: "Miss.",
                court: "Supreme Court"
            }, {
                name: "Miss. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:mt": {
            name: "US|Montana",
            abbr: [ {
                name: "Mont.",
                court: "Supreme Court"
            } ]
        },
        "us:navajo": {
            name: "US|Navajo Nation",
            abbr: [ {
                name: "Navajo",
                court: "Supreme Court"
            } ]
        },
        "us:nc": {
            name: "US|North Carolina",
            abbr: [ {
                name: "N.C.",
                court: "Supreme Court"
            }, {
                name: "N.C. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:nd": {
            name: "US|North Dakota",
            abbr: [ {
                name: "N.D.",
                court: "Supreme Court"
            }, {
                name: "N.D. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:ne": {
            name: "US|Nebraska",
            abbr: [ {
                name: "Neb.",
                court: "Supreme Court"
            }, {
                name: "Neb. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:nh": {
            name: "US|New Hampshire",
            abbr: [ {
                name: "N.H.",
                court: "Supreme Court"
            } ]
        },
        "us:nj": {
            name: "US|New Jersey",
            abbr: [ {
                name: "N.J.",
                court: "Supreme Court"
            }, {
                name: "N.J. Super. Ct. App. Div.",
                court: "Superior Court"
            }, {
                name: "N.J. Tax Ct.",
                court: "Tax Court"
            } ]
        },
        "us:nm": {
            name: "US|New Mexico",
            abbr: [ {
                name: "N.M.",
                court: "Supreme Court"
            }, {
                name: "N.M. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:nv": {
            name: "US|Nevada",
            abbr: [ {
                name: "Nev.",
                court: "Supreme Court"
            } ]
        },
        "us:ny": {
            name: "US|New York",
            abbr: [ {
                name: "N.Y.",
                court: "Court of Appeals"
            }, {
                name: "N.Y. App. Div.",
                court: "Appellate Division of the Supreme Court"
            }, {
                name: "N.Y. Fam. Ct.",
                court: "Family Court"
            }, {
                name: "N.Y. Sur. Ct.",
                court: "Surrogate 's Court"
            } ]
        },
        "us:oh": {
            name: "US|Ohio",
            abbr: [ {
                name: "Ohio",
                court: "Supreme Court"
            } ]
        },
        "us:ok": {
            name: "US|Oklahoma",
            abbr: [ {
                name: "Okla.",
                court: "Supreme Court"
            }, {
                name: "Okla. Civ. App.",
                court: "Court of Civil Appeals"
            }, {
                name: "Okla. C.O.J.",
                court: "Court on the Judiciary"
            }, {
                name: "Okla. Crim. App.",
                court: "Court of Criminal Appeals"
            }, {
                name: "Okla. J.E.A.P.",
                court: "Judicial Ethics Advisory Panel"
            } ]
        },
        "us:or": {
            name: "US|Oregon",
            abbr: [ {
                name: "Or.",
                court: "Supreme Court"
            }, {
                name: "Or. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:pa": {
            name: "US|Pennsylvania",
            abbr: [ {
                name: "Pa.",
                court: "Supreme Court"
            }, {
                name: "Pa. Commw. Ct.",
                court: "Commonwealth Court"
            }, {
                name: "Special Tribunal of Pa.",
                court: "Special Tribunal"
            }, {
                name: "Pa. Super. Ct.",
                court: "Superior Court"
            }, {
                name: "Ct. Jud. Disc. Pa",
                court: "Court of Judicial Discipline"
            } ]
        },
        "us:pr": {
            name: "US|Puerto Rico",
            abbr: [ {
                name: "P.R.",
                court: "Supreme Court"
            } ]
        },
        "us:ri": {
            name: "US|Rhode Island",
            abbr: [ {
                name: "R.I.",
                court: "Supreme Court"
            } ]
        },
        "us:sc": {
            name: "US|South Carolina",
            abbr: [ {
                name: "S.C.",
                court: "Supreme Court"
            }, {
                name: "S.C. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:sd": {
            name: "US|South Dakota",
            abbr: [ {
                name: "S.D.",
                court: "Supreme Court"
            } ]
        },
        "us:tn": {
            name: "US|Tennessee",
            abbr: [ {
                name: "Tenn.",
                court: "Supreme Court"
            }, {
                name: "Tenn. Crim. App.",
                court: "Court of Criminal Appeals"
            }, {
                name: "Tenn. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:tx": {
            name: "US|Texas",
            abbr: [ {
                name: "Tex.",
                court: "Supreme Court"
            }, {
                name: "Tex. App.",
                court: "Court of Appeals"
            }, {
                name: "Tex. Crim. App.",
                court: "Court of Criminal Appeals"
            }, {
                name: "Tex. Rev.",
                court: "Special Court of Review"
            } ]
        },
        "us:ut": {
            name: "US|Utah",
            abbr: [ {
                name: "Utah",
                court: "Supreme Court"
            }, {
                name: "Utah Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:va": {
            name: "US|Virginia",
            abbr: [ {
                name: "Va.",
                court: "Supreme Court"
            }, {
                name: "Va. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:vi": {
            name: "US|U.S. Virgin Islands",
            abbr: []
        },
        "us:vt": {
            name: "US|Vermont",
            abbr: [ {
                name: "Vt.",
                court: "Supreme Court of Vermont"
            } ]
        },
        "us:wa": {
            name: "US|Washington",
            abbr: [ {
                name: "Wash.",
                court: "Supreme Court"
            }, {
                name: "Wash. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:wi": {
            name: "US|Wisconsin",
            abbr: [ {
                name: "Wis.",
                court: "Supreme Court"
            }, {
                name: "Wis. Ct. App.",
                court: "Court of Appeals"
            } ]
        },
        "us:wv": {
            name: "US|West Virginia",
            abbr: [ {
                name: "W. Va.",
                court: "Supreme Court"
            } ]
        },
        "us:wy": {
            name: "US|Wyoming",
            abbr: [ {
                name: "Wyo.",
                court: "Supreme Court"
            } ]
        }
    },
    getJurisdiction: function(a) {
        var b = this.jurisdictions;
        var c = 0;
        var d = {
            jurisdiction: undefined,
            court: undefined
        };
        if (a === undefined || a === null) {
            return d;
        }
        a = a.toUpperCase().replace(/[\.\s]/g, "");
        for (var e in b) {
            if (b[e].abbr && PP.Utils.isArray(b[e].abbr)) {
                b[e].abbr.forEach(function(f) {
                    if (f.name) {
                        var g = f.name.toUpperCase().replace(/[\.\s]/g, "");
                        if (g == a) {
                            d.jurisdiction = b[e].name;
                            d.court = f.court;
                            c++;
                        }
                    }
                });
            }
        }
        if (c > 1) {
            d = {
                jurisdiction: undefined,
                court: undefined
            };
        }
        return d;
    },
    getJurisdictionCSL: function(a) {
        var b = this.jurisdictions;
        var c = "";
        a = a.toUpperCase().replace(/[\.\s]/g, "");
        for (var d in b) {
            if (b[d].name) {
                var e = b[d].name.toUpperCase().replace(/[\.\s]/g, "");
                if (e == a) {
                    c = d;
                }
            }
        }
        return c;
    },
    getCourtAbbreviation: function(a, b) {
        var c = a || "";
        if (b) {
            var d = this.jurisdictions[b];
            if (d && d.abbr) {
                a = a.toUpperCase().replace(/\s/g, "");
                if (a == "DIST.COURT") a = "DISTRICTCOURT";
                var e = {};
                d.abbr.forEach(function(a) {
                    if (a["default"]) {
                        if (a.court) {
                            var b = a.court.toUpperCase().replace(/\s/g, "");
                            e[b] = a.name;
                        }
                    }
                });
                d.abbr.forEach(function(a) {
                    if (a.court) {
                        var b = a.court.toUpperCase().replace(/\s/g, "");
                        if (!(b in e)) {
                            e[b] = a.name;
                        }
                    }
                });
                if (a in e) c = e[a];
            }
        }
        return c;
    }
});

PP.library.Jurisdictions = new PP.library._Jurisdictions();

PP.library._LegalAbbreviations = PP.Class.extend({
    abbr: {
        us: {
            classic: {},
            "collection-title": {},
            "container-phrase": {},
            "container-title": {
                "A. 2d": "A.2d",
                "A. 3d": "A.3d",
                "Atlantic Reporter": "A.",
                "Atlantic Reporter 2d": "A.2d",
                "Atlantic Reporter 3d": "A.3d",
                "B. R.": "B.R.",
                BR: "B.R.",
                "Bankruptcy Reporter": "B.R.",
                Black: "Black",
                "Board of Tax Appeals Memorandum Decisions": "B.T.A.M. (P-H)",
                "Court Martial Reports": "C.M.R.",
                "Court of Claims Reports": "Ct. Cl.",
                "Court of Customs Appeals Reports": "Ct. Cust.",
                "Court of Customs and Patent Appeals Reports": "C.C.P.A.",
                "Court of International Trade Reports": "Ct. Int\u2019l Trade",
                Cranch: "Cranch",
                "Ct.Cl.": "Ct. Cl.",
                "Ct.Int'l Trade": "Ct. Int\u2019l Trade",
                "Customs Bulletin and Decisions": "Cust. B. & Dec.",
                "Customs Court Reports": "Cust. Ct.",
                Dallas: "Dall.",
                "Decisions of the United States Court of Military Appeals": "C.M.A.",
                "F. 2d": "F.2d",
                "F. 3d": "F.3d",
                "F. Supp.2d": "F. Supp. 2d",
                "F.2d": "F.2d",
                "F.3d": "F.3d",
                "F.Supp.": "F. Supp.",
                "F.Supp. 2d": "F. Supp. 2d",
                "F.Supp.2d": "F. Supp. 2d",
                "Fed.Cl.": "Fed. Cl.",
                "Federal Appendix": "F. App\u2019x",
                "Federal Cases": "F. Cas.",
                "Federal Claims Reporter": "Fed. Cl.",
                "Federal Reporter": "F.",
                "Federal Reporter 2d": "F.2d",
                "Federal Reporter 3d": "F.3d",
                "Federal Rules Decisions": "F.R.D.",
                "Federal Rules Service": "Fed. R. Serv. (Callaghan)",
                "Federal Rules Service 2d": "Fed. R. Serv. 2d (Callaghan)",
                "Federal Rules Service 3d": "Fed. R. Serv. 3d (West)",
                "Federal Supplement": "F. Supp.",
                "Federal Supplement 2d": "F. Supp. 2d",
                Howard: "How.",
                "International Trade Reporter Decisions": "I.T.R.D. (BNA)",
                "Kan.App.": "Kan. App.",
                "Kansas Court of Appeals Reports": "Kan. App.",
                "L. Ed.2d": "L. Ed. 2d",
                "L.Ed.": "L. Ed.",
                "L.Ed. 2d": "L. Ed. 2d",
                "L.Ed.2d": "L. Ed. 2d",
                "Lawyers' Edition": "L. Ed.",
                "Lawyers' Edition 2d": "L. Ed. 2d",
                "M. J.": "M.J.",
                "N. E.": "N.E.",
                "N. E. 2d": "N.E.2d",
                "N. E.2d": "N.E.2d",
                "N. W.": "N.W.",
                "N. W. 2d": "N.W.2d",
                "N. W.2d": "N.W.2d",
                "N.E. 2d": "N.E.2d",
                "N.W. 2d": "N.W.2d",
                "NE 2d": "N.E.2d",
                "NW 2d": "N.W.2d",
                "North Eastern Reporter": "N.E.",
                "North Eastern Reporter 2d": "N.E.2d",
                "North Western Reporter": "N.W.",
                "North Western Reporter 2d": "N.W.2d",
                "Northwest Reporter Second": "N.W.2d",
                "Ohio St.3d": "Ohio St. 3d",
                "P. 2d": "P.2d",
                "P. 3d": "P.3d",
                "Pacific Reporter": "P.",
                "Pacific Reporter 2d": "P.2d",
                "Pacific Reporter 3d": "P.3d",
                "Pennsylvania Statutes Annotated": "Pa. Stat. Ann.",
                Peters: "Pet.",
                "Reports of the United States Board of Tax Appeals": "B.T.A.",
                "S. E.": "S.E.",
                "S. E. 2d": "S.E.2d",
                "S. E.2d": "S.E.2d",
                "S. W.": "S.W.",
                "S. W. 2d": "S.W.2d",
                "S. W. 3d": "S.W.3d",
                "S. W.2d": "S.W.2d",
                "S. W.3d": "S.W.3d",
                "S.Ct": "S. Ct.",
                "S.E. 2d": "S.E.2d",
                "S.W. 2d": "S.W.2d",
                "S.W. 3d": "S.W.3d",
                "SE 2d": "S.E.2d",
                "SW 3d": "S.W.3d",
                "So.2d": "So. 2d",
                "So.3d": "So. 3d",
                "South Eastern Reporter": "S.E.",
                "South Eastern Reporter 2d": "S.E.2d",
                "South Eastern Reporter.": "S.E.",
                "South Eastern Reporter. 2d": "S.E.2d",
                "South Western": "S.W.",
                "South Western 2d": "S.W.2d",
                "South Western 3d": "S.W.3d",
                "South Western Reporter": "S.W.",
                "South Western Reporter 2d": "S.W.2d",
                "South Western Reporter 3d": "S.W.3d",
                "Southern Reporter": "So.",
                "Southern Reporter 2d": "So. 2d",
                "Southern Reporter 3d": "So. 3d",
                "Statutes at Large": "Stat.",
                "Supreme Court": "Wall.",
                "Supreme Court Reporter": "!authority>>>S. Ct.",
                "T. C.": "T.C.",
                "Tax Court Memorandum Decisions": "T.C.M. (CCH)",
                "U. S.": "!authority>>>U.S.",
                "US Code": "U.S.C.",
                "United States Claims Court Reporter": "Cl. Ct.",
                "United States Claims Reporter": "Ct. Cl.",
                "United States Law Week": "U.S.L.W.",
                "United States Reports": "!authority>>>U.S.",
                "United States Supreme Court Reports": "!authority>>>L. Ed.",
                "United States Supreme Court Reports 2d": "!authority>>>L. Ed. 2d",
                "United States Supreme Court Reports, Lawyer's Edition": "!authority>>>L. Ed.",
                "United States Supreme Court Reports, Lawyer's Edition 2d": "!authority>>>L. Ed. 2d",
                "United States Supreme Court Reports, Lawyers' Edition": "!authority>>>L. Ed.",
                "United States Supreme Court Reports, Lawyers' Edition 2d": "!authority>>>L. Ed. 2d",
                "United States Tax Court Reports": "T.C.",
                "Vet.App.": "Vet. App.",
                Wallace: "Wall.",
                "West's Bankruptcy Reporter": "B.R.",
                "West's Military Justice Reporter": "M.J.",
                "West's Veterans Appeals Reporter": "Vet. App.",
                Wheaton: "Wheat.",
                "Wn. Terr.": "Wash. Terr."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {
                Congress: "Cong.",
                "Court of Appeals for the Eighth Circuit": "8th Cir.",
                "House Committee on the Judiciary": "H. Comm. on the Judiciary",
                "House of Representatives": "H.R.",
                Legislature: "Leg.",
                "Second Circuit Court of Appeals": "2d Cir.",
                "Supreme Court": "Sup. Ct.",
                "U.S. Congress": "Cong."
            },
            nickname: {},
            number: {},
            place: {},
            title: {
                "House of Representatives Joint Resolution": "H.R.J. Res.",
                "Senate Joint Resolution": "S.J. Res.",
                "Special Session": "Spec. Sess."
            },
            "title-phrase": {}
        },
        "us;ak": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Alaska Federal Reports": "Alaska Fed.",
                "Alaska Reports": "Alaska",
                "Federal Cases": "F. Cas."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;al": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Alabama Appellate Courts Reports": "Ala. App.",
                "Alabama Reports": "Ala."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ar": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Arkansas Appellate Reports": "Ark. App.",
                "Arkansas Reports": "Ark."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;az": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Arizona Appeals Reports": "Ariz. App.",
                "Arizona Reports": "Ariz."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ca": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Cal. App.2d": "Cal. App. 2d",
                "Cal. App.3d": "Cal. App. 3d",
                "Cal. App.4th": "Cal. App. 4th",
                "Cal. Rptr.2d": "Cal. Rptr. 2d",
                "Cal. Rptr.3d": "Cal. Rptr. 3d",
                "Cal.2d": "Cal. 2d",
                "Cal.3d": "Cal. 3d",
                "Cal.4th": "Cal. 4th",
                "Cal.App.": "Cal. App.",
                "Cal.App. 2d": "Cal. App. 2d",
                "Cal.App. 2d Supp.": "Cal. App. 2d Supp.",
                "Cal.App. 3d": "Cal. App. 3d",
                "Cal.App. 3d Supp.": "Cal. App. 3d Supp.",
                "Cal.App. 4th": "Cal. App. 4th",
                "Cal.App. Supp. 2d": "Cal. App. 2d Supp.",
                "Cal.App. Supp. 3d": "Cal. App. 3d Supp.",
                "Cal.App. Supp.2d": "Cal. App. 2d Supp.",
                "Cal.App. Supp.3d": "Cal. App. 3d Supp.",
                "Cal.App.2d": "Cal. App. 2d",
                "Cal.App.2d Supp.": "Cal. App. 2d Supp.",
                "Cal.App.3d": "Cal. App. 3d",
                "Cal.App.3d Supp.": "Cal. App. 3d Supp.",
                "Cal.App.4th": "Cal. App. 4th",
                "Cal.App.Supp.": "Cal. App. Supp.",
                "Cal.Rptr.": "Cal. Rptr.",
                "Cal.Rptr. 2d": "Cal. Rptr. 2d",
                "Cal.Rptr. 3d": "Cal. Rptr. 3d",
                "Cal.Rptr.2d": "Cal. Rptr. 2d",
                "Cal.Rptr.3d": "Cal. Rptr. 3d",
                "California Appellate Reports": "Cal. App.",
                "California Appellate Reports 2d": "Cal. App. 2d",
                "California Appellate Reports 3d": "Cal. App. 3d",
                "California Appellate Reports 4th": "Cal. App. 4th",
                "California Appellate Reports Supplement": "Cal. App. Supp.",
                "California Appellate Reports Supplement 2d": "Cal. App. 2d Supp.",
                "California Appellate Reports Supplement 3d": "Cal. App. 3d Supp.",
                "California Appellate Reports Supplement 4th": "Cal. App. 4th Supp.",
                "California Reports": "Cal.",
                "California Reports 2d": "Cal. 2d",
                "California Reports 3d": "Cal. 3d",
                "California Reports 4th": "Cal. 4th",
                "California Unreported Cases": "Cal. Unrep.",
                "West's California Reporter": "Cal. Rptr.",
                "West's California Reporter 2d": "Cal. Rptr. 2d",
                "West's California Reporter 3d": "Cal. Rptr. 3d",
                "West\u2019s California Reporter": "Cal. Rptr.",
                "West\u2019s California Reporter 2d": "Cal. Rptr. 2d",
                "West\u2019s California Reporter 3d": "Cal. Rptr. 3d"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;co": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Brief Times Reporter": "Brief Times Rptr.",
                "Colorado Court of Appeals Reports": "Colo. App.",
                "Colorado Journal": "Colo. J.",
                "Colorado Lawyer": "Colo. Law.",
                "Colorado Reports": "Colo.",
                "Law Week Colorado": "L. Week Colo."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ct": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Connecticut Appellate Reports": "Conn. App.",
                "Connecticut Circuit Court Reports": "Conn. Cir. Ct.",
                "Connecticut Law Reporter": "Conn. L. Rptr.",
                "Connecticut Reports": "Conn.",
                "Connecticut Superior Court Reports": "Conn. Super. Ct.",
                "Connecticut Supplement": "Conn. Supp."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;dc": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Appeal Cases, District of Columbia": "App. D.C.",
                "Federal Reporter 3d": "F.3d",
                "United States Court of Appeals Reports": "U.S. App. D.C."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;de": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Delaware Cases": "Del. Cas.",
                "Delaware Chancery Reports": "Del. Ch.",
                "Delaware Reports": "Del."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;federal": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {
                "Bankruptcy Court": "Bankr.",
                Congress: "Cong.",
                "Court of Appeals for the Eighth Circuit": "8th Cir.",
                "District Court": "!here>>>",
                "Eighth Circuit Court of Appeals": "8th Cir.",
                "Eleventh Circuit Court of Appeals": "11th Cir.",
                "Fifth Circuit Court of Appeals": "5th Cir.",
                "First Circuit Court of Appeals": "1st Cir.",
                "Fourth Circuit Court of Appeals": "4th Cir.",
                "House Committee on the Judiciary": "H. Comm. on the Judiciary",
                "House of Representatives": "H.R.",
                Legislature: "Leg.",
                "Ninth Circuit Court of Appeals": "9th Cir.",
                "Second Circuit Court of Appeals": "2d Cir.",
                "Seventh Circuit Court of Appeals": "7th Cir.",
                "Sixth Circuit Court of Appeals": "6th Cir.",
                "Supreme Court": "Sup. Ct.",
                "Tenth Circuit Court of Appeals": "10th Cir.",
                "Third Circuit Court of Appeals": "3rd Cir.",
                "U.S. Congress": "Cong."
            },
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;federal;dc": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "District of Columbia Reports": "D.C."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;fl": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Florida Law Weekly": "Fla. L. Weekly",
                "Florida Law Weekly Supplement": "Fla. L. Weekly Supp.",
                "Florida Reports": "Fla.",
                "Florida Supplement": "Fla. Supp.",
                "Florida Supplement 2d": "Fla. Supp. 2d"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ga": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Georgia Appeals Reports": "Ga. App.",
                "Georgia Reports": "Ga."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;gu": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Federal Supplement 2d": "F. Supp. 2d",
                "Guam Reports": "Guam"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;hi": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Hawaii Appellate Reports": "Haw. App.",
                "Hawaii Reports(ends with vol. 75)": "Haw.",
                "West's Hawaii Reports": "Haw.",
                "West's Hawaii Reports (begins with vol. 76)": "Haw.",
                "West\u2019s Hawaii Reports": "Haw."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ia": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Iowa Reports": "Iowa",
                "Iowa Reports (Cite to edition published by Clarke for vols. 1-8.)": "Iowa"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;id": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Idaho Reports": "Idaho"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;il": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Ill. App.2d": "Ill. App. 2d",
                "Ill. App.3d": "Ill. App. 3d",
                "Ill.Dec.": "Ill. Dec.",
                "Illinois Court of Claims Reports": "Ill. Ct. Cl.",
                "West's Illinois Decisions": "Ill. Dec.",
                "West\u2019s Illinois Decisions": "Ill. Dec.",
                "lllinois Appellate Court Reports": "Ill. App.",
                "lllinois Appellate Court Reports 2d": "Ill. App. 2d",
                "lllinois Appellate Court Reports 3d": "Ill. App. 3d",
                "lllinois Reports": "Ill."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;in": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Indiana Court of Appeals Reports (prior to 1972, Indiana Appellate Court Reports)": "Ind. App.",
                "Indiana Reports": "Ind."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ks": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Kan. App.2d": "Kan. App. 2d",
                "Kan.App. 2d": "Kan. App. 2d",
                "Kan.App.2d": "Kan. App. 2d",
                "Kansas Court of Appeals Reports": "Kan. App.",
                "Kansas Court of Appeals Reports 2d": "Kan. App. 2d",
                "Kansas Reports": "Kan."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ky": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Kentucky Appellate Reporter": "Ky. App.",
                "Kentucky Attorney's Memo": "Ky. Att\u2019y Memo",
                "Kentucky Law Reporter": "Ky. L. Rptr.",
                "Kentucky Law Summary": "Ky. L. Summ.",
                "Kentucky Opinions": "Ky. Op.",
                "Kentucky Reports": "Ky."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;la": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Gunby's Reports": "Gunby",
                "Louisiana Annual Reports": "La. Ann.",
                "Louisiana Court of Appeals Reports": "La. App.",
                "Louisiana Reports": "La.",
                "Peltier's Decisions, Parish at Orleans": "Pelt.",
                "Teissier, Orleans Court of Appeals": "Teiss."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ma": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Appellate Division Advance Sheets": "Mass. App. Div. Adv. Sh.",
                "Massachusetts Appeals Court Reports": "Mass. App. Ct.",
                "Massachusetts Appellate Decisions": "Mass. App. Dec.",
                "Massachusetts Reports": "Mass.",
                "Massachusetts Reports Supplement": "Mass. Supp. 246",
                "Reports of MassachusettsAppellate Division": "Mass. App. Div."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;md": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Maryland Appellate Reports": "Md. App.",
                "Maryland Reports": "Md."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;me": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Maine Reports": "Me."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;mi": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Michigan Appeals Reports": "Mich. App.",
                "Michigan Court of Claims Reports": "Mich. Ct. CL",
                "Michigan Reports": "Mich."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;mn": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Minnesota Reports": "Minn."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;mo": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Missouri Appeals Reports": "Mo. App.",
                "Missouri Reports": "Mo."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ms": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Mississippi Reports": "Miss."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;mt": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Montana Reports": "Mont.",
                "State Reporter": "State Rptr."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;nc": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "North Carolina Court of Appeals Reports": "N.C. App.",
                "North Carolina Reports": "N.C.",
                "North Carolina Reports (63 N.C. to date)": "N.C."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;nd": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Dakota Reports": "Dakota",
                "North Dakota Reports": "N.D.",
                "Northwestern Reporter 2d": "N.W.2d"
            },
            hereinafter: {},
            "institution-entire": {
                "Court of Appeals": "ND App",
                "Supreme Court": "ND"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ne": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Nebraska Court of Appeals Reports": "Neb. App.",
                "Nebraska Reports": "Neb."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;nh": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "New Hampshire Reports": "N.H."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;nj": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "New Jersey Administrative Reports": "N.J. Admin.",
                "New Jersey Administrative Reports 2d": "N.J. Admin. 2d",
                "New Jersey Equity Reports": "N.J. Eq.",
                "New Jersey Law Reports": "N.J.L.",
                "New Jersey Miscellaneous Reports": "N.J. Misc.",
                "New Jersey Reports": "N.J.",
                "New Jersey Superior Court Reports": "N.J. Super.",
                "New Jersey Tax Court Reports": "N.J. Tax"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;nm": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "New Mexico Reports": "N.M."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;nv": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Nevada Report": "Nev.",
                "Nevada Reports": "Nev."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ny": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "A.D. 2d": "A.D.2d",
                "A.D. 3d": "A.D.3d",
                "AD 2d": "A.D.2d",
                "AD 3d": "A.D.3d",
                "Abbott's New Cases": "Abb. N. Cas.",
                "Abbott's Practice Reports": "Abb. Pr.",
                "Anthon's Nisi Prius Cases": "Ant. N.P. Cas.",
                "Appellate Division Reports": "A.D.",
                "Appellate Division Reports 2d": "A.D.2d",
                "Appellate Division Reports 3d": "A.D.3d",
                "Barbour's Chancery Reports": "Barb. Ch.",
                "Barbour's Supreme Court Reports": "Barb.",
                "Caines' Cases": "Cai. Cas.",
                "Caines' Reports": "Cai.",
                "Clarke's Chancery Reports": "Cl. Ch.",
                "Coleman & Caines' Cases": "Cole. & Cai. Cas.",
                "Coleman's Cases": "Cole. Cas.",
                "Cowen's Reports": "Cow.",
                "Denio's Reports": "Denio",
                "Edmond's Select Cases": "Edm. Sel. Cas.",
                "Edwards' Chancery Reports": "Edw. Ch.",
                "Hill and Denio Supplement (Lalor)": "Hill & Den.",
                "Hill's Reports": "Hill",
                "Hoffman's Chancery Reports": "Hoff. Ch.",
                "Hopkins' Chancery Reports": "Hopk. Ch.",
                "Howard's Practice Reports": "How. Pr.",
                "Johnson's Cases": "Johns. Cas.",
                "Johnson's Chancery Reports": "Johns. Ch.",
                "Johnson's Reports": "Johns.",
                "Lansing's Chancery Reports": "Lans. Ch.",
                "Lansing's Reports": "Lans.",
                "Lockwood's Reversed Cases": "Lock. Rev. Cas.",
                "Misc 2d": "Misc. 2d",
                "Misc 3d": "Misc. 3d",
                "Misc.2d": "Misc. 2d",
                "Misc.3d": "Misc. 3d",
                "N. Y.": "N.Y.",
                "N.Y. 2d": "N.Y.2d",
                "N.Y. 3d": "N.Y.3d",
                "N.Y.S. 2d": "N.Y.S.2d",
                "N.Y.S. 3d": "N.Y.S.3d",
                "NY 2d": "N.Y.2d",
                "NY 3d": "N.Y.3d",
                "NYS 2d": "N.Y.S.2d",
                "NYS 3d": "N.Y.S.3d",
                "New York Chancery Reports Annotated": "N.Y. Ch. Ann.",
                "New York Miscellaneous Reports": "Misc.",
                "New York Miscellaneous Reports 2d": "Misc. 2d",
                "New York Miscellaneous Reports 3d": "Misc. 3d",
                "New York Reports": "N.Y.",
                "New York Reports 2d": "N.Y.2d",
                "New York Reports 3d": "N.Y.3d",
                "Paige's Chancery Reports": "Paige Ch.",
                "Sandford's Chancery Reports": "Sand. Ch.",
                "Saratoga Chancery Sentinel": "Sarat. Ch. Sent.",
                "Supreme Court Reports": "N.Y. Sup. Ct.",
                "Wendell's Reports": "Wend.",
                "West's New York Supplement": "N.Y.S.",
                "West's New York Supplement 2d": "N.Y.S.2d",
                "West's New York Supplement 3d": "N.Y.S.3d",
                "West\u2019s New York Supplement": "N.Y.S.",
                "West\u2019s New York Supplement 2d": "N.Y.S.2d",
                "West\u2019s New York Supplement 3d": "N.Y.S.3d",
                "Yates' Select Cases": "Yates Sel. Cas."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;oh": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Anderson's Unreported Ohio Appellate Cases": "Ohio App. Unrep.",
                "Baldwin's Ohio Monthly Record": "Ohio Monthly Rec.",
                "Ohio Appellate Reports": "Ohio App.",
                "Ohio Appellate Reports 2d": "Ohio App. 2d",
                "Ohio Appellate Reports 3d": "Ohio App. 3d",
                "Ohio Bar Reports": "Ohio B.",
                "Ohio Circuit Court Decisions": "13-23 Ohio C.C. Dec.",
                "Ohio Circuit Court Reports": "Ohio C.C.",
                "Ohio Circuit Court Reports, New Series": "Ohio C.C. (n.s.)",
                "Ohio Circuit Decisions": "Ohio Cir. Dec.",
                "Ohio Courts of Appeals Reports": "Ohio Ct. App.",
                "Ohio Decisions": "Ohio Dec.",
                "Ohio Decisions, Reprint": "Ohio Dec. Reprint",
                "Ohio Department Reports": "Ohio Dep\u2019t",
                "Ohio Government Reports": "Ohio Gov\u2019t",
                "Ohio Law Abstract": "Ohio Law Abs.",
                "Ohio Law Bulletin": "Ohio L. Bull.",
                "Ohio Law Reporter": "Ohio L.R.",
                "Ohio Miscellaneous": "Ohio Misc.",
                "Ohio Miscellaneous 2d": "Ohio Misc. 2d",
                "Ohio Nisi Prius Reports": "Ohio N.P.",
                "Ohio Opinions": "Ohio Op.",
                "Ohio Opinions 2d": "Ohio Op. 2d",
                "Ohio Opinions 3d": "Ohio Op. 3d",
                "Ohio Reports": "Ohio",
                "Ohio St.3d": "Ohio St. 3d",
                "Ohio State Reports": "Ohio St.",
                "Ohio State Reports 2d": "Ohio St. 2d",
                "Ohio State Reports 3d": "Ohio St. 3d",
                "Ohio Unreported Cases": "Ohio Unrep. Cas.",
                "Tappen's Reports": "Tapp. Rep.",
                "Wilcox's Condensed Reports": "Wilc. Cond. Rep."
            },
            hereinafter: {},
            "institution-entire": {
                Ohio: "Ohio"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ok": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Indian Territory Reports": "Indian Terr.",
                "Oklahoma Criminal Reports": "Okla. Crim.",
                "Oklahoma Reports": "Okla."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;or": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Oregon Reports": "Or.",
                "Oregon Reports, Court of Appeals": "Or. App.",
                "Oregon Tax Reports": "Or. Tax"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;pa": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Pa. Commonwealth Ct.": "Pa. Commw.",
                "Pa. Superior Ct.": "Pa. Super.",
                "Pennsylvania Commonwealth Court Reports": "Pa. Commw.",
                "Pennsylvania County Court Reports": "Pa. C.",
                "Pennsylvania District Reports": "Pa. D.",
                "Pennsylvania District and County Reports": "Pa. D. & C",
                "Pennsylvania District and County Reports 2d": "Pa. D. & C.2d",
                "Pennsylvania District and County Reports 3d": "Pa. D. & C.3d",
                "Pennsylvania State Reports": "Pa.",
                "Pennsylvania Superior Court Reports": "Pa. Super."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;pr": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Decisiones de Puerto Rico": "P.R. Dec.",
                "Decisiones del Tribunal de Circuito de Apelaciones de Puerto Rico": "T.C.A.",
                "Official Translations of the Opinions of the Supreme Court of Puerto Rico": "P.R. Offic. Trans.",
                "Puerto Rico": "P.R.",
                "Puerto Rico Reports": "P.R.",
                "Sentencias del Tribunal Supremo de Puerto Rico": "P.R. Sent."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ri": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Rhode Island Reports": "R.I."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;sc": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "South Carolina Reports": "S.C."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;sd": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "South Dakota Reports": "S.D."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;tn": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Tennessee Appeals Reports": "Tenn. App.",
                "Tennessee Criminal Appeals Reports": "Tenn. Crim. App.",
                "Tennessee Reports": "Tenn."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;tx": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Condensed Reports of Decisions in Civil Causes in the Court of Appeals (White & Willson)": "White & W. Willson",
                "Condensed Reports of Decisions in Civil Causes in the Court of Appeals (Willson)": "White & W. Willson",
                "Dallam's Opinions": "Dallam",
                "Digest of the Laws of Texas": "Dallam",
                Robards: "Robards",
                "Synopses of the Decisions of the Supreme Court of Texas Arising from Restraints by Conscript and Other Military Authorities": "Robards",
                "Texas Civil Appeals Reports": "Tex. Civ. App.",
                "Texas Court of Appeals Reports": "Tex. Ct. App.",
                "Texas Criminal Reports": "Tex. Crim.",
                "Texas Reports": "Tex.",
                "Texas Supreme Court Journal": "Tex. Sup. Ct. J.",
                "Texas Unreported Cases (Posey)": "Posey"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;ut": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Utah Reports": "Utah",
                "Utah Reports 2d": "Utah 2d",
                "Vermont Reports": "Vt."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;va": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Virginia Circuit Court Opinions": "Va. Cir.",
                "Virginia Court of Appeals Reports": "Va. App.",
                "Virginia Reports": "Va."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;vi": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Virgin Islands Reports": "V.I."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;vt": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Vermont Reports": "Vt."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;wa": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Washington Appellate Reports": "Wash. App.",
                "Washington Reports": "Wash.",
                "Washington Reports 2d": "Wash. 2d",
                "Washington Territory Reports": "Wash. Terr.",
                Wn: "Wash.",
                "Wn. 2d": "Wash. 2d",
                "Wn. App.": "Wash. App.",
                "Wn. Terr.": "Wash. Terr.",
                "Wn.2d": "Wash. 2d",
                "Wn.App.": "Wash. App."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;wi": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Wis.2d": "Wis. 2d",
                "Wisconsin Reports": "Wis.",
                "Wisconsin Reports 2d": "Wis. 2d"
            },
            hereinafter: {},
            "institution-entire": {
                "Court of Appeals": "WI App",
                "Supreme Court": "WI"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;wv": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "West Virginia Reports": "W. Va."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "us;wy": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Wyoming Reports": "Wyo."
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        au: {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Australian Capital Territory|Supreme Court": "AUTSC",
                "Australian Federal Police Disciplinary Tribunal": "AFPDT",
                "Competition Tribunal": "ACompT",
                "Copyright Tribunal": "ACopyT",
                "Defence Forces Discipline Appeal Tribunal": "ADFDAT",
                "Family Court": "FamCA",
                "Federal Court": "FCA",
                "Federal Court|Full Court": "FCAFC",
                "Federal Magistrate's Court": "FMCA",
                "High Court": "HCA",
                "Industrial Relations Commission": "AIRComm",
                "Industrial Relations Court of Australia": "IRCA",
                "National Native Title Tribunal": "NNTTA",
                "Native Appeal Tribunal": "AATA",
                "Refugee Review Tribunal": "RRTA",
                "Supreme Court": "AUTSC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "au;nsw": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Administrative Law Decisions": "ALD",
                "Commonwealth Law Reports": "CLR",
                "Family Law Reports": "Fam LR",
                "Federal Court Reports": "FC",
                "New South Wales Law Reports": "NSWLR",
                "Northern Territory Law Reports": "NTLR",
                "Northern Territory Reports": "NTR",
                "Queensland Reports": "QR",
                "Queensland State Reports": "St R Qd",
                "South Australia Law Reports": "SALR",
                "South Australia State Reports": "SASR",
                "State Reports New South Wales": "SR (NSW)",
                "State Reports South Australia": "SRSA",
                "State Reports Tasmania": "Tas SR",
                "Tasmanian Law Reports": "TLR",
                "Tasmanian Reports": "Tas R",
                "Victorian Law Reports": "VLR",
                "Victorian Reports": "VR",
                "Western Australia Law Reports": "WALR",
                "Western Australian Reports": "WAR"
            },
            hereinafter: {},
            "institution-entire": {
                "Administrative Decisions Tribunal": "NSWADT",
                "Administrative Decisions Tribunal| Appeal Panel": "NSWADTAP",
                "Community Services Appeals Tribunal": "NSWCSAT",
                "Compensation Court": "NSWCC",
                "Consumer, Trader and Tenancy Tribunal": "NSWCTTT",
                "Court of Appeal": "NSWCA",
                "Court of Criminal Appeal": "NSWCCA",
                "District Court": "NSWDC",
                "Drug Court": "NSWDRGC",
                "Dust Diseases Tribunal": "NSWDDT",
                "Industrial Relations Commission": "NSWIRComm",
                "Land and Environment Court": "NSALEEC",
                "Local Government & Pecuniary Interest & Disciplinary Tribunal": "NSWPIDT",
                "Residential Tenancies Tribunal of NSW": "NSWRTT",
                "Supreme Court": "NSWSC",
                "Transport Appeal Board": "NSWTAB",
                "Workers Compensation Commission": "NSW WCC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "au;nt": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Anti-Discrimination Commission": "NTADDComm",
                "Supreme Court": "NTSC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "au;qld": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Anti-Discrimination Tribunal": "QADT",
                "Building Tribunal": "QBT",
                "Court of Appeal": "QCA",
                "District Court of Queensland": "QDC",
                "Industrial Court": "QIC",
                "Land Appeal Court": "QLAC",
                "Land Court": "QLC",
                "Medical Assessment Tribunal": "QMAT",
                "Planning & Environment Court": "QPEC",
                "Queensland Industrial Relations Commission": "QIRComm",
                "Supreme Court": "QSC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "au;sa": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "District Court": "SADC",
                "Environment Resources and Development Court": "SAERDC",
                "Industrial Relations Commission": "SAIRComm",
                "Industrial Relations Court": "SAIRC",
                "Supreme Court": "SASC",
                "Workers Compensation Appeal Tribunal": "SAWCAT"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "au;tas": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Resource Management and Planning Appeal Tribunal": "TASRMPAT",
                "Supreme Court": "TASSC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "au;vic": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Civil and Administrative Tribunal": "VCAT",
                "County Court": "VCC",
                "Court of Appeal": "VSCA",
                "Supreme Court": "VSC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "au;wa": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Children\u2019s Court": "WACC",
                "District Court": "WADC",
                "Family Court": "FamCWA",
                "State Administrative Tribunal": "WASAT",
                "State Administrative Tribunal|Equal Opportunity Tribunal": "WAEOT",
                "State Administrative Tribunal|Guardianship and Administration Board": "WAGAB",
                "State Administrative Tribunal|Office of the Strata Titles Referee": "WASTR",
                "State Administrative Tribunal|Town Planning Appeal Tribunal": "WATPAT",
                "Supreme Court": "WASC",
                "Supreme Court|Criminal Appeal": "WASCA"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        ca: {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Alberta Law Reports": "Alta LR",
                "Alberta Reports": "AR",
                "British Columbia Reports": "BCR",
                "Canada Law Reports: Supreme Court of Canada": "!authority>>>SCR",
                "Canada Rederal Court Reports": "FC",
                "Canada Supreme Court Reports": "!authority>>>SCR",
                "Exchequer Court of Canada Reports": "Ex CR",
                "Federal Court Reports": "FC",
                "Manitoba Reports": "Man R",
                "New Brunswick Reports": "NBR",
                "New Brunswick Reports (2d)": "NBR (2d)",
                "Newfoundland & Prince Edward Island Reports": "Nfld & PEIR",
                "Northwest Territories Reports": "NZTR",
                "Nova Scotia Reports": "NSR",
                "Nova Scotia Reports (2d)": "NSR (2d)",
                "Ontario Law Reports": "OLR",
                "Ontario Reports (2d)": "OR (2d)",
                "Ontario Reports (3d)": "OR (3d)",
                "Ontario Reports Second": "OR (2d)",
                "Ontario Weekly Notes": "OWN",
                "Rapports judiciaries officiels de Qu\xe9bec: Cour du Banc de la Reine/du Roi": "BR",
                "Rapports judiciaries officiels de Qu\xe9bec: Cour sup\xe9rieure": "CS",
                "Recueils de jurisprudence du Qu\xe9bec: Cour d'appel": "CA",
                "Recueils de jurisprudence du Qu\xe9bec: Cour des Sessions de la paix": "CSP",
                "Recueils de jurisprudence du Qu\xe9bec: Cour du Banc de la Reine/du Roi": "BR",
                "Recueils de jurisprudence du Qu\xe9bec: Cour du bein-\xeatre social": "CBES",
                "Recueils de jurisprudence du Qu\xe9bec: Cour provinciale": "CP",
                "Recueils de jurisprudence du Qu\xe9bec: Tribunal de la jeunesse": "TJ",
                "Recueils du jurisprudence du Qu\xe9bec: Cour sup\xe9rieure": "CS",
                "Supreme Court Reports": "!authority>>>S.C.R.",
                "Territories Law Reports": "Terr LR",
                "Yukon Reports": "YR"
            },
            hereinafter: {},
            "institution-entire": {
                "Federal Court": "!authority,jurisdiction>>>FC",
                "Federal Court of Appeal": "!authority,jurisdiction>>>FCA",
                "Supreme Court": "!authority>>>SCC"
            },
            "institution-part": {
                "Court of Appeal": "CA",
                "District Court": "DC",
                "High Court": "HC",
                "High Court of Justice": "High Ct J",
                "House of Lords": "HL",
                "Privy Council": "PC",
                "Supreme Court": "SC"
            },
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;ab": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>ABCA",
                "Court of Queen's Bench": "!authority,jurisdiction>>>ABQB",
                "Provincial Court": "!authority,jurisdiction>>>ABPC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;bc": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>BCCA",
                "Provincial Court": "!authority,jurisdiction>>>BCPC",
                "Supreme Court": "!authority,jurisdiction>>>BCSC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;mb": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>MBCA",
                "Court of Queen's Bench": "!authority,jurisdiction>>>MBQB",
                "Provincial Court": "!authority,jurisdiction>>>MBPC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;nb": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>NBCA",
                "Court of Queen's Bench": "!authority,jurisdiction>>>NBQC",
                "Provincial Court": "!authority,jurisdiction>>>NBPC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;nl": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Supreme Court|Court of Appeal": "!authority,jurisdiction>>>NFCA",
                "Supreme Court|Trial Division": "!authority,jurisdiction>>>NFSCTD"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;ns": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>NSCA",
                "Provincial Court": "!authority,jurisdiction>>>NSPC",
                "Supreme Court": "!authority,jurisdiction>>>NSSC",
                "Supreme Court|Family Division": "!authority,jurisdiction>>>NSSF"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;nt": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>NWTCA",
                "North West Territories|Territorial Court": "!authority,jurisdiction>>>NWTTC",
                "Supreme Court": "!authority,jurisdiction>>>NWTSC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;nu": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>NUCA",
                "Court of Justice": "!authority,jurisdiction>>>NUCJ"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;on": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Ontario Reports Second": "OR (2d)"
            },
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>ONCA",
                "Court of Justice": "!authority,jurisdiction>>>ONCJ"
            },
            "institution-part": {
                "High Court of Justice": "H Ct J"
            },
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;pe": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Supreme Court|Appeal Division": "!authority,jurisdiction>>>PESCAD",
                "Supreme Court|Trial Division": "!authority,jurisdiction>>>PESCTD"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;qc": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>QCCA",
                "Court of Qu\xe9bec": "!authority,jurisdiction>>>QCCP",
                "Superior Court": "!authority,jurisdiction>>>QCCS"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;sk": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>SKCA",
                "Court of Queen's Bench": "!authority,jurisdiction>>>SKQB",
                "Provincial Court": "!authority,jurisdiction>>>SKPC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "ca;yt": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "!authority,jurisdiction>>>YKCA",
                "Supreme Court": "!authority,jurisdiction>>>YKSC",
                "Territorial Court": "!authority,jurisdiction>>>YKTC"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        default: {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Administrative Law Decisions": "ALD",
                "Alberta Law Reports": "Alta LR",
                "Alberta Reports": "AR",
                "All England Law Reports": "All ER",
                "All England Reports": "All E.R.",
                "Appeal Cases": "AC",
                "British Columbia Reports": "BCR",
                "British Company Law Cases": "BCC",
                "Butterworths Medico-Legal Reports": "B.M.L.R.",
                "Canada Law Reports: Supreme Court of Canada": "!authority>>>SCR",
                "Canada Rederal Court Reports": "FC",
                "Canada Supreme Court Reports": "!authority>>>SCR",
                Chancery: "Ch",
                "Common Market Law Reports": "CMLR",
                "Commonwealth Law Reports": "CLR",
                "Criminal Appeal Reports": "Cr App R",
                "Criminal Appeal Reports (Sentencing)": "Cr App R (S)",
                "Criminal Reports of New Zealand": "CRNZ",
                "Current Law Yearbook": "CLY",
                "District Court Reports": "DCR",
                "Employment Reports of New Zealand": "ERNZ",
                "English Reports": "ER",
                "Environmental Law Reporter": "NZELR",
                "Environmental Law Reports of New Zealand": "ELRNZ",
                "Estates Gazette": "EG",
                "Estates Gazette Law Reports": "EGLR",
                "European Court Reports": "ECR",
                "European Human Rights Reports": "E.H.R.R.",
                "Exchequer Court of Canada Reports": "Ex CR",
                Family: "Fam",
                "Family Law Reports": "Fam LR",
                "Family Reports of New Zealand": "FRNZ",
                "Federal Court Reports": "FC",
                "Financial Times Law Reports": "FTLR",
                "Fleet Street Reports": "FSR",
                "Gazette Law Reports": "GLR",
                "Harvard Law Review": "Harv. L. Rev.",
                "Housing Law Reports": "HLR",
                "Human Rights Reports of New Zealand": "HRNZ",
                "Industrial Cases Reports": "ICR",
                "Industrial Relations Law Reports": "IRLR",
                "Justice of the Peace Reports": "JP",
                "Land Valuation Casebook": "Land Valuation Casebook",
                "Land Valuation Cases": "Land Valuation Cases",
                "Landlord and Tenant Reports": "L & TR",
                "Law Society Gazette": "LS Gaz",
                "Lloyd's Law Reports": "Lloyd's Rep",
                "Local Government Reports": "LGR",
                "Macassey's Reports": "Mac",
                "Magistrates' Court Reports": "MCR",
                "Magistrates' Courts Decisions": "MCD",
                "Manitoba Reports": "Man R",
                "Maori Law Review": "Maori LR",
                "Matrimonial Property Act Cases": "MPC",
                "Morison's Company Law Reports": "MCLR",
                "New Brunswick Reports": "NBR",
                "New Brunswick Reports (2d)": "NBR (2d)",
                "New Property Cases": "NPC",
                "New South Wales Law Reports": "NSWLR",
                "New Zealand Accident Compensation Reports": "NZACR",
                "New Zealand Administrative Reports": "NZAR",
                "New Zealand Arbitation Court Judgments": "ACJ",
                "New Zealand Armed Forces Law Review": "NZAFLR",
                "New Zealand Bill of Rights Reports": "NZBORR",
                "New Zealand Business Law Cases": "NZBLC",
                "New Zealand Business Law Cases Commerce Commission Decisions": "NZBLC (Com)",
                "New Zealand Company Law Cases": "NZCLC",
                "New Zealand Company and Commercial Law Reports": "NZCCLR",
                "New Zealand Conveyancing Cases": "NZ ConvC",
                "New Zealand Conveyancing and Property Reports": "NZCPR",
                "New Zealand Courts Martial Appeal Reports": "NZCMAR",
                "New Zealand Current Taxation": "New Zealand Current Taxation",
                "New Zealand Customs Cases": "NZCC",
                "New Zealand Employment Law Cases": "NZELC",
                "New Zealand Employment Law Reports": "NZELR",
                "New Zealand Environmental Law Reporter": "NZELR",
                "New Zealand Family Law Reports": "NZFLR",
                "New Zealand Industrial Court Judgments": "ICJ",
                "New Zealand Industrial Law Reports": "NZILR",
                "New Zealand Intellectual Property Reports": "NZIPR",
                "New Zealand Jurist Reports (New Series)": "NZ Jur (NS)",
                "New Zealand Law Reports": "NZLR",
                "New Zealand Law Reports Leading Cases": "NZLRLC",
                "New Zealand Parliamentary Debates": "NZPD",
                "New Zealand Privy Council Cases": "NZPCC",
                "New Zealand Procedural Cases": "NZPC",
                "New Zealand Resource Management Appeals": "NZRMA",
                "New Zealand Superannuation cases": "NZSC",
                "New Zealand Tax Cases": "NZTC",
                "New Zealand Taxation Board of Review Decisions": "NZTBR",
                "New Zealand Town Planning Appeals": "NZTPA",
                "New Zealand Town and Country Planning Appeals": "NZTCPA",
                "Newfoundland & Prince Edward Island Reports": "Nfld & PEIR",
                "Northern Territory Law Reports": "NTLR",
                "Northern Territory Reports": "NTR",
                "Northwest Territories Reports": "NZTR",
                "Nova Scotia Reports": "NSR",
                "Nova Scotia Reports (2d)": "NSR (2d)",
                "Ollivier, Bell & Fitzgerald's Reports of Cases": "OB&F",
                "Ontario Law Reports": "OLR",
                "Ontario Reports (2d)": "OR (2d)",
                "Ontario Reports (3d)": "OR (3d)",
                "Ontario Weekly Notes": "OWN",
                "Privy Council": "P",
                "Procedure Reports of New Zealand": "PRNZ",
                "Property and Compensation Reports": "P&CR",
                "Public and Third Sector Law Reports": "PTSLR",
                "Queen's Bench": "QB",
                "Queensland Reports": "QR",
                "Queensland State Reports": "St R Qd",
                "Rapports judiciaries officiels de Qu\xe9bec: Cour du Banc de la Reine/du Roi": "BR",
                "Rapports judiciaries officiels de Qu\xe9bec: Cour sup\xe9rieure": "CS",
                "Rating and Valuation Reporter": "RVR",
                "Recueils de jurisprudence du Qu\xe9bec: Cour d'appel": "CA",
                "Recueils de jurisprudence du Qu\xe9bec: Cour des Sessions de la paix": "CSP",
                "Recueils de jurisprudence du Qu\xe9bec: Cour du Banc de la Reine/du Roi": "BR",
                "Recueils de jurisprudence du Qu\xe9bec: Cour du bein-\xeatre social": "CBES",
                "Recueils de jurisprudence du Qu\xe9bec: Cour provinciale": "CP",
                "Recueils de jurisprudence du Qu\xe9bec: Tribunal de la jeunesse": "TJ",
                "Recueils du jurisprudence du Qu\xe9bec: Cour sup\xe9rieure": "CS",
                "Reports of Patent Cases": "RPC",
                "Road Traffic Reports": "RTR",
                "Scots Law Times": "SLT",
                "Scottish Civil Law Reports": "SCLR",
                "Scottish Criminal Case Reports ": "SCCR",
                "Session Cases": "SC",
                "Simon's Tax Cases": "STC",
                "Simon's Tax Intelligence": "STI",
                "South Australia Law Reports": "SALR",
                "South Australia State Reports": "SASR",
                "State Reports New South Wales": "SR (NSW)",
                "State Reports South Australia": "SRSA",
                "State Reports Tasmania": "Tas SR",
                "Tasmanian Law Reports": "TLR",
                "Tasmanian Reports": "Tas R",
                "Tax Cases": "TC",
                "Tax Reports New Zealand": "Tax Reports New Zealand",
                "Territories Law Reports": "Terr LR",
                "Trade and Competition Law Reports": "TCLR",
                "Victorian Law Reports": "VLR",
                "Victorian Reports": "VR",
                "Weekly Law Reports": "WLR",
                "Western Australia Law Reports": "WALR",
                "Western Australian Reports": "WAR",
                "Wills & Trusts Law Reports": "WTLR",
                "Yukon Reports": "YR"
            },
            hereinafter: {},
            "institution-entire": {},
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        gb: {
            classic: {},
            "collection-title": {
                "Command Papers 1987-present": "Cm"
            },
            "container-title": {
                "All England Law Reports": "All E.R.",
                "All England Reports": "All E.R.",
                "Appeal Cases": "AC",
                "British Company Law Cases": "BCC",
                "Butterworths Medico-Legal Reports": "B.M.L.R.",
                Chancery: "Ch",
                "Common Market Law Reports": "CMLR",
                "Criminal Appeal Reports": "Cr App R",
                "Criminal Appeal Reports (Sentencing)": "Cr App R (S)",
                "Current Law Yearbook": "CLY",
                "English Reports": "ER",
                "Estates Gazette": "EG",
                "Estates Gazette Law Reports": "EGLR",
                "European Court Reports": "ECR",
                "European Human Rights Reports": "EHRR",
                Family: "Fam",
                "Family Law Reports": "FLR",
                "Financial Times Law Reports": "FTLR",
                "Fleet Street Reports": "FSR",
                "Housing Law Reports": "HLR",
                "Industrial Cases Reports": "ICR",
                "Industrial Relations Law Reports": "IRLR",
                "Justice of the Peace Reports": "JP",
                "Landlord and Tenant Reports": "L & TR",
                "Law Society Gazette": "LS Gaz",
                "Lloyd's Law Reports": "Lloyd's Rep",
                "Local Government Reports": "LGR",
                "New Property Cases": "NPC",
                "Property and Compensation Reports": "P&CR",
                "Public and Third Sector Law Reports": "PTSLR",
                "Queen's Bench": "QB",
                "Rating and Valuation Reporter": "RVR",
                "Reports of Patent Cases": "RPC",
                "Road Traffic Reports": "RTR",
                "Scots Law Times": "SLT",
                "Scottish Civil Law Reports": "SCLR",
                "Scottish Criminal Case Reports ": "SCCR",
                "Session Cases": "SC",
                "Simon's Tax Cases": "STC",
                "Simon's Tax Intelligence": "STI",
                "Tax Cases": "TC",
                "The Times": "The Times",
                "Weekly Law Reports": "WLR",
                "Wills & Trusts Law Reports": "WTLR"
            },
            hereinafter: {},
            "institution-entire": {
                "Administrative Appeals Chamber": "AAC",
                "Asylum and Immigration Tribunal": "United Kingdom Asylum and Immigration Tribunal",
                "Competition Appeals Tribunal": "United Kingdom Competition Appeals Tribunal",
                "Employment Appeal Tribunal": "UKEAT",
                "Financial Services and Markets Tribunals": "United Kingdom Financial Services and Markets Tribunals Decisions",
                "First-tier Tribunal": "UKFTT",
                "First-tier Tribunal|General Regulatory Chamber": "First-tier Tribunal (General Regulatory Chamber)",
                "First-tier Tribunal|Tax": "First-tier Tribunal (Tax)",
                "Health Education and Social Care Chamber": "HESC",
                "High Court|Chancery": "UKHC",
                "House of Lords": "UKHL",
                "Information Tribunal and National Security Appeals Panel": "United Kingdom Information Tribunal including the National Security Appeals Panel",
                "Nominet Dispute Resolution Service": "Nominet UK Dispute Resolution Service",
                "Privy Council": "UKPC",
                "Social Security and Child Support Commissioners": "UK Social Security and Child Support Commissioners' Decisions",
                "Special Commissioners of Income Tax": "United Kingdom Special Commissioners of Income Tax Decisions",
                "Special Immigrations Appeals Commission": "UKSIAC",
                "Supreme Court": "UKSC",
                "Upper Tribunal|Administrative Appeals Chamber": "UKUT",
                "Upper Tribunal|Immigration and Asylum Chamber": "Upper Tribunal (Immigration and Asylum Chamber)",
                "Upper Tribunal|Lands Chamber": "Upper Tribunal (Lands Chamber)",
                "Upper Tribunal|Tax and Chancery Chamber": "Upper Tribunal (Tax and Chancery Chamber)",
                "VAT and Duties Tribunals": "United Kingdom VAT & Duties Tribunals Decisions",
                "VAT and Duties Tribunals|Customs": "United Kingdom VAT & Duties Tribunals (Customs) Decisions",
                "VAT and Duties Tribunals|Excise": "United Kingdom VAT & Duties Tribunals (Excise) Decisions",
                "VAT and Duties Tribunals|Insurance Premium Tax": "United Kingdom VAT & Duties Tribunals (Insurance Premium Tax) Decisions",
                "VAT and Duties Tribunals|Landfill Tax": "United Kingdom VAT & Duties Tribunals (Landfill Tax) Decisions"
            },
            "institution-part": {
                Chancery: "Ch",
                "House of Lords": "HL",
                "King's Bench": "KB",
                "Queen's Bench": "QB"
            },
            nickname: {},
            number: {},
            place: {},
            title: {
                "George III": "Geo 3"
            }
        },
        "gb;england.and.wales": {
            classic: {},
            "collection-title": {},
            "container-title": {
                "All England Reports": "All ER"
            },
            hereinafter: {},
            "institution-entire": {
                "Administrative Court": "Admin",
                "Care Standards Tribunal": "England and Wales Care Standards Tribunal Decisions",
                "Chancery Division": "Ch",
                "Commercial Court": "Comm",
                "County Court|Family": "England and Wales County Court (Family)",
                "County Court|Patents": "England and Wales Patents County Court Decisions",
                "Court of Appeal|Civil Division": "EWCA Civ",
                "Court of Appeal|Criminal Division": "EWCA Crim",
                "England and Wales|Admiralty Division": "Admlty",
                "Family Division": "Fam",
                "High Court": "EWHC",
                "High Court|Chancery": "EWHC",
                "Lands Tribunal": "England and Wales Lands Tribunal",
                "Magistrates' Court|Family": "England and Wales Magistrates' Court (Family)",
                "Patents Court": "Pat",
                "Queen's Bench Division": "QB",
                "Technology and Construction Court": "TCC"
            },
            "institution-part": {
                Chancery: "Ch",
                "Court of Appeal": "CA",
                "Queen's Bench": "QB"
            },
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "gb;northern.ireland": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "NICA",
                "Crown Court": "NICC",
                "Fair Employment Tribunal": "Fair Employment Tribunal Northern Ireland Decisions",
                "High Court|Chancery Division": "High Court of Justice in Northern Ireland Chancery Division Decisions",
                "High Court|Family Division": "High Court of Justice in Northern Ireland Family Division Decisions",
                "High Court|Masters": "High Court of Justice in Northern Ireland Master's Decisions",
                "High Court|Queen's Bench Division": "NIQB",
                "Industrial Tribunals": "Industrial Tribunals Northern Ireland Decisions",
                "Social Security and Child Support Commissioners": "Northern Ireland - Social Security and Child Support Commissioners' Decisions"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        "gb;scotland": {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Court of Session|Inner House": "CSIH",
                "Court of Session|Outer House": "CSOH",
                "High Court": "HCJT",
                "Sheriff Court": "Scottish Sheriff Court Decisions"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        ie: {
            classic: {},
            "collection-title": {},
            "container-title": {},
            hereinafter: {},
            "institution-entire": {
                "Competition Authority": "Irish Competition Authority Decisions",
                "Court of Criminal Appeal": "Irish Court of Criminal Appeal",
                "Data Protection Commission": "Irish Data Protection Commission Case Studies",
                "High Court": "High Court of Ireland Decisions",
                "Information Commissioner": "Irish Information Commissioner's Decisions",
                "Supreme Court": "Supreme Court of Ireland Decisions"
            },
            "institution-part": {},
            nickname: {},
            number: {},
            place: {},
            title: {}
        },
        nz: {
            classic: {},
            "collection-title": {},
            "container-title": {
                "Criminal Reports of New Zealand": "CRNZ",
                "District Court Reports": "DCR",
                "Employment Reports of New Zealand": "ERNZ",
                "Environmental Law Reporter": "NZELR",
                "Environmental Law Reports of New Zealand": "ELRNZ",
                "Family Reports of New Zealand": "FRNZ",
                "Gazette Law Reports": "GLR",
                "Human Rights Reports of New Zealand": "HRNZ",
                "Land Valuation Casebook": "Land Valuation Casebook",
                "Land Valuation Cases": "Land Valuation Cases",
                "Macassey's Reports": "Mac",
                "Magistrates' Court Reports": "MCR",
                "Magistrates' Courts Decisions": "MCD",
                "Maori Law Review": "Maori LR",
                "Matrimonial Property Act Cases": "MPC",
                "Morison's Company Law Reports": "MCLR",
                "New Zealand Accident Compensation Reports": "NZACR",
                "New Zealand Administrative Reports": "NZAR",
                "New Zealand Arbitation Court Judgments": "ACJ",
                "New Zealand Armed Forces Law Review": "NZAFLR",
                "New Zealand Bill of Rights Reports": "NZBORR",
                "New Zealand Business Law Cases": "NZBLC",
                "New Zealand Business Law Cases Commerce Commission Decisions": "NZBLC (Com)",
                "New Zealand Company Law Cases": "NZCLC",
                "New Zealand Company and Commercial Law Reports": "NZCCLR",
                "New Zealand Conveyancing Cases": "NZ ConvC",
                "New Zealand Conveyancing and Property Reports": "NZCPR",
                "New Zealand Courts Martial Appeal Reports": "NZCMAR",
                "New Zealand Current Taxation": "New Zealand Current Taxation",
                "New Zealand Customs Cases": "NZCC",
                "New Zealand Employment Law Cases": "NZELC",
                "New Zealand Employment Law Reports": "NZELR",
                "New Zealand Environmental Law Reporter": "NZELR",
                "New Zealand Family Law Reports": "NZFLR",
                "New Zealand Industrial Court Judgments": "ICJ",
                "New Zealand Industrial Law Reports": "NZILR",
                "New Zealand Intellectual Property Reports": "NZIPR",
                "New Zealand Jurist Reports (New Series)": "NZ Jur (NS)",
                "New Zealand Law Reports": "NZLR",
                "New Zealand Law Reports Leading Cases": "NZLRLC",
                "New Zealand Parliamentary Debates": "NZPD",
                "New Zealand Privy Council Cases": "NZPCC",
                "New Zealand Procedural Cases": "NZPC",
                "New Zealand Resource Management Appeals": "NZRMA",
                "New Zealand Superannuation cases": "NZSC",
                "New Zealand Tax Cases": "NZTC",
                "New Zealand Taxation Board of Review Decisions": "NZTBR",
                "New Zealand Town Planning Appeals": "NZTPA",
                "New Zealand Town and Country Planning Appeals": "NZTCPA",
                "Ollivier, Bell & Fitzgerald's Reports of Cases": "OB&F",
                "Procedure Reports of New Zealand": "PRNZ",
                "Tax Reports New Zealand": "Tax Reports New Zealand",
                "Trade and Competition Law Reports": "TCLR"
            },
            hereinafter: {},
            "institution-entire": {
                "Court of Appeal": "NZCA",
                "District Court": "NZDC",
                "High Court": "NZHC",
                "Supreme Court": "NZSC"
            },
            "institution-part": {
                "Court of Appeal": "CA",
                "District Court": "DC",
                "High Court": "HC",
                "House of Lords": "HL",
                "Privy Council": "PC",
                "Supreme Court": "SC"
            },
            nickname: {},
            number: {},
            place: {},
            title: {}
        }
    },
    getAbbreviation: function(a) {
        for (var b in this.abbr) {
            if ("container-title" in this.abbr[b]) {
                var c = this.abbr[b]["container-title"];
                var d = c[a];
                if (d) {
                    d = d.replace(/!authority>>>/, "");
                    return d;
                }
            }
        }
        return "";
    },
    getAbbreviations: function(a) {
        var b = {
            default: {
                classic: {},
                "collection-title": {},
                "container-phrase": {},
                "container-title": {},
                hereinafter: {},
                "institution-entire": {},
                "institution-part": {},
                nickname: {},
                number: {},
                place: {},
                title: {},
                "title-phrase": {}
            }
        };
        b["institution-part"] = this.abbr.ca["institution-part"];
        return b;
    },
    getReporterMap: function(a) {
        var b = {};
        for (var c in this.abbr) {
            if ("container-title" in this.abbr[c]) {
                var d = this.abbr[c]["container-title"];
                for (var e in d) {
                    var f = d[e];
                    if (a) {
                        f = f.toUpperCase().replace(/[\s\.]+/g, "");
                        f = f.replace(/\!authority>>>/i, "");
                    }
                    if (!(f in b)) {
                        b[f] = e;
                    } else {
                        if (e.length > b[f].length) {
                            b[f] = e;
                        }
                    }
                }
            }
        }
        b["US"] = "United States Reports";
        return b;
    }
});

PP.library.LegalAbbreviations = new PP.library._LegalAbbreviations();

PP.library._Merge = PP.Class.extend({
    merge: function(a, b) {
        var c = this;
        a = PP.Utils.clone(a);
        b = PP.Utils.clone(b);
        var d = {};
        d._id = PP.UUID.generate();
        var e = PP.library.PublicationFields.getFields();
        e.forEach(function(e) {
            c.fillInField(d, a, b, e);
        });
        PP.library.Publication.autoClean(d);
        return d;
    },
    fillInField: function(a, b, c, d) {
        var e = d.name;
        var f = {
            _id: true,
            _keywords: true,
            subfolders: true
        };
        if (f[e]) {
            return;
        }
        var g = b[e];
        var h = c[e];
        var i = g === undefined || g === null || g === "";
        var j = h === undefined || h === null || h === "";
        if (i && j) {
            return;
        }
        if (i && !j) {
            a[e] = h;
            return;
        }
        if (j && !i) {
            a[e] = g;
            return;
        }
        if (d.fieldType === "author") {
            if (g && h) {
                if (g.length != h.length) {
                    var k = g.length > h.length ? g : h;
                    a[e] = k;
                    return;
                } else {
                    var l = this.authorCharLength(g);
                    var m = this.authorCharLength(h);
                    var k = l >= m ? g : h;
                    a[e] = k;
                    return;
                }
            }
        } else if (d.fieldType === "date") {
            if (g && h) {
                var n = this.getDateSpecificity(g);
                var o = this.getDateSpecificity(h);
                var k = n >= o ? g : h;
                a[e] = k;
                return;
            }
        } else if (d.dataType === "object") {
            var p = {};
            PP.Utils.merge(p, g);
            PP.Utils.merge(p, h);
            a[e] = p;
        } else if (d.dataType === "array") {
            var q = g.concat(h);
            q = PP.Array.unique(q);
            a[e] = q;
            return;
        } else {
            g = "" + g;
            h = "" + h;
            var l = g.length;
            var m = h.length;
            var k = l >= m ? g : h;
            a[e] = k;
            return;
        }
    },
    getDateSpecificity: function(a) {
        var b = 0;
        var c = [ "year", "month", "day" ];
        c.forEach(function(c) {
            if (a[c]) {
                b++;
            }
        });
        return b;
    },
    authorCharLength: function(a) {
        var b = 0;
        a.forEach(function(a) {
            b += a.last ? a.last.length : 0;
            b += a.first ? a.first.length : 0;
            b += a.collective ? a.collective.length : 0;
        });
        return b;
    },
    runTests: function() {
        var a = {
            pubtype: "PP_ARTICLE",
            author: [ {
                last: "Jordan",
                first: "GE",
                initials: "GE"
            } ],
            published: {
                year: 2007
            },
            title: "Testing testing one two three",
            url: [ "http://www.google.com/" ],
            source: {
                pdf_crawl_status: "complete"
            }
        };
        var b = PP.Utils.clone(a);
        b.author = [ {
            last: "Jordan",
            first: "Gregory Eric",
            initials: "GE"
        } ];
        b.published = {
            year: 2007,
            month: 10,
            day: 12
        };
        b.url = [ "http://www.yahoo.com/" ];
        b.source = {
            webimport_status: "success",
            plugin: "pubmed"
        };
        PP.library.Publication.autoClean(a);
        PP.library.Publication.autoClean(b);
        var c = PP.library.Merge.merge(a, b);
        console.log(PP.pp(c));
    }
});

createSingleton(PP.library, "_Merge", "Merge");

PP.library.Patterns = PP.Class.extend({
    statics: {
        applyPattern: function(a, b) {
            var c = PP.library.Publication.getAuthorType(b);
            var d = b[c];
            if (d === undefined) {
                d = [];
            }
            var e = [];
            for (var f = 0; f < d.length; f++) {
                e.push(PP.library.Author.toString(d[f], {
                    output: "last"
                }));
            }
            if (e.length === 0) {
                e = [ "_noauthor_" ];
            }
            var g = e[0];
            var h = e[e.length - 1];
            if (g === h) {
                h = "";
            }
            var i, j;
            if (b.published && b.published.year) {
                i = b.published.year + "";
                j = i.substring(2, 4);
            } else {
                j = i = "_undated_";
            }
            g = g.replace(/\s+/g, "_");
            h = h.replace(/\s+/g, "_");
            if (e.length > 0) {
                if (g === g.toUpperCase()) {
                    g = g.toLowerCase();
                }
                g = PP.String.upperFirst(g);
                if (h === h.toUpperCase()) {
                    h = h.toLowerCase();
                }
                h = PP.String.upperFirst(h);
            }
            var k = "";
            for (var f = 0; f < 2; f++) {
                k += this.getRandomChar();
            }
            var l = g.substr(0, 1).toUpperCase();
            var m = {
                firstAuthor: g,
                lastAuthor: h,
                initial: l,
                year: i,
                randomChars: k
            };
            a = PP.Utils.template(a, m);
            a = a.replace(/\[/g, "");
            a = a.replace(/\]/g, "");
            if (!PP.Globals.isDocAddOn() && typeof "Unidecode" === "object") {
                a = Unidecode.decode(a);
            }
            a = PP.Utils.replaceDiacritics(a);
            a = a.replace(/[^\w-]/g, "");
            a = a.replace(/_-/g, "-");
            a = a.replace(/_+/g, "_");
            a = a.replace(/^_/g, "");
            a = a.replace(/_$/g, "");
            return a;
        },
        getRandomChar: function() {
            var a = "abcdefghijklmnopqrstuvwxyz";
            var b = Math.floor(Math.random() * a.length);
            var c = a.charAt(b);
            return c;
        }
    }
});

PP.library._PublicationTypes = PP.Class.extend({
    getBibtexMap: function() {
        var a = this.getPubTypes();
        var b = {};
        for (var c = 0; c < a.length; c++) {
            var d = a[c].bibtex_types;
            for (var e = 0; e < d.length; e++) {
                var f = d[e];
                if (!b[f]) {
                    b[f] = [ a[c].id ];
                } else {
                    b[f].push(a[c].id);
                }
            }
        }
        return b;
    },
    getPubTypeMap: function() {
        if (this._map) {
            return this._map;
        }
        var a = this.getPubTypes();
        var b = {};
        for (var c = 0; c < a.length; c++) {
            var d = a[c].id;
            b[d] = a[c];
        }
        this._map = b;
        return b;
    },
    getPubType: function(a) {
        var b = this.getPubTypes();
        for (var c in b) {
            if (b[c]) {
                var d = b[c];
                if (d.id === a) {
                    return d;
                }
            }
        }
        return null;
    },
    getSortOrder: function() {
        var a = [ "PP_ARTICLE", "PP_BOOK", "PP_BOOK_CHAPTER", "PP_CONFERENCE_PAPER", "PP_THESIS", "PP_PREPRINT", "PP_MANUSCRIPT", "PP_WEBSITE", "PP_NEWS_ARTICLE", "PP_PATENT", "PP_PRESENTATION", "PP_COMPUTER_PROGRAM", "PP_MANUAL", "PP_DATASET", "PP_REPORT", "PP_PERSONAL_COMMUNICATION", "PP_UNPUBLISHED", "PP_MISC", "PP_BROADCAST", "PP_AUDIO", "PP_VIDEO", "PP_FIGURE", "PP_ARTWORK", "PP_SCORE", "PP_GRANT", "PP_STANDARD", "PP_MAP", "PP_LETTER", "PP_INTERVIEW", "PP_REVIEW", "PP_ENCYCLOPEDIA_ARTICLE", "PP_CASE", "PP_STATUTE", "PP_BILL", "PP_TREATY", "PP_PERIODICAL" ];
        return a;
    },
    getTitleHelp: function() {
        return "<p>Italics: &lt;i&gt<i>Homo sapiens</i>&lt;/i&gt <br>Superscript: Ca&lt;sup&gt<sup>2+</sup>&lt;/sup&gt <br>Subscript: H&lt;sub&gt<sub>2</sub>&lt;/sub&gt;O</p>";
    },
    getAuthorHelp: function() {
        return ", separated by semicolons <p><i>Last, First Middle</i> <p>e.g. Knuth, Donald E; Moore, Ronald W</p><p><i>Collective names in braces</i><p>e.g. {1000 Genomes Consortium}</p>";
    },
    getDateHelp: function() {
        return "<p>'2002' <i>or</i> 'June 2002' <i>or</i> 'June 24, 2002' <br/> <i>or free-form date in braces<i><br> '{May-June 1876}'</p>";
    },
    getEditWindowPubTypes: function() {
        var a = PP.Utils.clone(this.getPubTypes());
        a = PP.Array.filter(a, function(a) {
            return a.hideFromEditWindow !== true;
        });
        var b = PP.Array.toMap(a, "id");
        var c = [];
        var d = [ "PP_ARTICLE", "PP_BOOK", "PP_BOOK_CHAPTER", "PP_CONFERENCE_PAPER", "PP_THESIS", "PP_NEWS_ARTICLE", "PP_WEBSITE", "PP_MISC" ];
        var e = [ "PP_MANUSCRIPT", "PP_ARTWORK", "PP_AUDIO", "PP_BILL", "PP_REVIEW", "PP_BROADCAST", "PP_CASE", "PP_COMPUTER_PROGRAM", "PP_DATASET", "PP_ENCYCLOPEDIA_ARTICLE", "PP_FIGURE", "PP_GRANT", "PP_INTERVIEW", "PP_LETTER", "PP_MANUAL", "PP_MAP", "PP_SCORE", "PP_PATENT", "PP_PERSONAL_COMMUNICATION", "PP_PREPRINT", "PP_PRESENTATION", "PP_REPORT", "PP_STANDARD", "PP_STATUTE", "PP_TREATY", "PP_VIDEO", "PP_UNPUBLISHED", "PP_PERIODICAL" ];
        c.push({
            isHeader: true,
            name: "Main reference types"
        });
        for (var f = 0; f < d.length; f++) {
            c.push(b[d[f]]);
        }
        c.push({
            isHeader: true,
            name: "More reference types"
        });
        for (var f = 0; f < e.length; f++) {
            c.push(b[e[f]]);
        }
        return c;
    },
    getPubTypes: function() {
        if (this._types) {
            return this._types;
        }
        var a = {
            patent: [ "issuing_authority", "application_number", "class", "international_class", "search_class", "states", "priority_numbers", "patent_number", "assignee", "foreign_patents", "patent_publication_type" ],
            legal: [ "jurisdiction", "history", "section", "legislative_body", "session", "court" ],
            issn: [ "issn", "issn_alt" ],
            isbn: [ "isbn", "isbn_alt" ],
            pubmed: [ "pmc", "pmid" ],
            arxiv: [ "archivePrefix", "arxivid", "primaryClass", "eprint" ],
            misc: [ "running_time", "medium", "scale", "ismn" ],
            conference: [ "conference", "conference_location", "conference_date" ],
            journal: [ "journal", "journalfull", "issue" ],
            book: [ "booktitle", "chapter" ],
            math: [ "mr", "zbl" ],
            pages: [ "pages", "num_pages" ],
            volume: [ "volume", "num_volumes" ],
            publisher: [ "publisher", "address", "original_publisher", "original_address" ],
            series: [ "series", "series_number", "series_editor" ],
            thesis: [ "school", "department" ],
            archive: [ "archive", "archive_location", "archive_place" ]
        };
        var b = [ {
            id: "PP_BOOK",
            name: "Book",
            label: "Book",
            description: "A whole book",
            bibtex_types: [ "BOOK" ],
            zotero_type: "BOOK",
            mendeley_type: "BOOK",
            endnote_type: [ {
                name: "BOOK",
                default: true
            }, {
                name: "CONFERENCE PROCEEDINGS",
                subtype: "Proceedings"
            }, {
                name: "ELECTRONIC BOOK",
                subtype: "Electronic Book"
            }, {
                name: "EDITED BOOK"
            }, {
                name: "ANCIENT TEXT",
                subtype: "Ancient Text"
            }, {
                name: "CLASSICAL WORK",
                subtype: "Classical Work"
            }, {
                name: "DICTIONARY",
                subtype: "Dictionary"
            } ],
            csl_type: "book",
            ris_type: [ {
                name: "BOOK",
                default: true
            }, {
                subtype: "Proceedings",
                name: "CONF"
            }, {
                subtype: "Ancient Text",
                name: "ANCIENT"
            }, {
                subtype: "Dictionary",
                name: "DICT"
            }, {
                name: "EBOOK"
            } ],
            field_labels: {
                pages: "Pages cited"
            },
            field_ris: {
                isbn: "SN",
                series: "T2",
                num_pages: "SP",
                pages: "SE",
                series_editor: "A2",
                editor: "A3",
                original_title: "OP",
                translator: "A4"
            },
            field_ris_additional: {
                ED: "editor"
            },
            field_endnote: {
                series_number: "%N",
                num_pages: "%P",
                pages: "%&"
            },
            field_zotero: {},
            field_help: {
                title: "Title of the book." + this.getTitleHelp(),
                pages: "<p>The range or starting page, e.g. <p>'210-213' or '210'</p>"
            },
            subtypes: [ {
                name: "Monograph"
            }, {
                name: "Textbook"
            }, {
                name: "Booklet"
            }, {
                name: "Proceedings"
            }, {
                name: "Encyclopedia"
            }, {
                name: "Dictionary"
            }, {
                name: "Classical Work"
            }, {
                name: "Ancient Text"
            }, {
                name: "Fiction"
            }, {
                name: "Electronic Book"
            } ],
            mandatory_fields: [ "title", "author", "editor", "published", [ "publisher", "address" ], [ "series", "volume" ] ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.journal, a.thesis, a.arxiv, a.pubmed, [ "booktitle", "howpublished", "institution", "version", "filed", "number" ])
        }, {
            id: "PP_REVIEW",
            name: "Book or Film Review",
            label: "Book or Film Review",
            description: "A published review of a book or film",
            bibtex_types: [ "MISC" ],
            zotero_type: [],
            mendeley_type: [],
            endnote_type: [],
            csl_type: "review-book",
            ris_type: [],
            field_labels: {
                contributor: "Reviewed author",
                booktitle: "Title of the reviewed item"
            },
            field_ris: {
                isbn: "SN",
                series: "T2",
                num_pages: "SP",
                pages: "SE",
                series_editor: "A2",
                editor: "A3",
                original_title: "OP",
                translator: "A4"
            },
            field_ris_additional: {
                ED: "editor"
            },
            field_endnote: {},
            field_zotero: {},
            field_csl: {
                booktitle: "reviewed-title",
                contributor: "reviewed-author"
            },
            field_help: {
                title: "Title of the book" + this.getTitleHelp(),
                booktitle: "The title of the reviewed item" + this.getTitleHelp(),
                contributor: "The author(s) of the reviewed item" + this.getAuthorHelp()
            },
            subtypes: [],
            mandatory_fields: [ "title", "author", "booktitle", "contributor", [ "journal:2", "published" ], [ "volume", "issue", "pages" ], "url" ],
            excluded_fields: PP.Array.merge(a.patent, a.conference, a.misc, a.legal, a.thesis, a.arxiv, a.pubmed, [ "howpublished", "institution", "number", "version", "filed" ])
        }, {
            id: "PP_BOOK_CHAPTER",
            name: "Book Chapter",
            label: "Book Chapter",
            description: "Book chapter, with its own title and authors",
            bibtex_types: [ "INCOLLECTION", "INBOOK" ],
            csl_type: "chapter",
            endnote_type: [ {
                name: "BOOK SECTION"
            }, {
                name: "ELECTRONIC BOOK SECTION"
            } ],
            zotero_type: "BOOKSECTION",
            mendeley_type: "BOOK_SECTION",
            ris_type: [ {
                name: "CHAP",
                default: true
            }, {
                name: "CHAPTER"
            }, {
                name: "ECHAP"
            }, {
                name: "SER"
            }, {
                name: "EDBOOK"
            } ],
            field_labels: {
                editor: "Book editors",
                author: "Chapter authors",
                title: "Chapter title",
                pages: "Chapter pages"
            },
            field_ris: {
                isbn: "SN",
                booktitle: "T2",
                series: "T3",
                pages: "SP",
                series_editor: "A3",
                editor: "A2",
                original_title: "OP",
                num_volumes: "IS",
                translator: "A4"
            },
            field_ris_additional: {
                ED: "editor",
                SE: "series",
                NV: "num_volumes",
                BT: "booktitle"
            },
            field_mendeley: {
                booktitle: "source"
            },
            field_endnote: {
                chapter: "%&",
                journal: null
            },
            field_zotero: {},
            field_help: {
                title: "Title of the chapter." + this.getTitleHelp(),
                booktitle: "Title of the book." + this.getTitleHelp(),
                editor: "The book editor(s)" + this.getAuthorHelp(),
                author: "Te chapter author(s)" + this.getAuthorHelp(),
                pages: "<p>The range or starting page, e.g. <p>'210-213' or '210'</p>"
            },
            mandatory_fields: [ "booktitle", "editor", "title", [ "pages" ], "author", "abstract", "published", [ "publisher", "address" ], [ "series", "volume" ] ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.journal, a.arxiv, a.thesis, [ "howpublished", "institution", "number", "version", "num_pages", "filed" ]),
            subtypes: [ {
                name: "Monograph"
            }, {
                name: "Textbook"
            }, {
                name: "Dictionary"
            }, {
                name: "Classical Work"
            }, {
                name: "Ancient Text"
            }, {
                name: "Fiction"
            }, {
                name: "Electronic Book"
            }, {
                name: "Appendix"
            } ]
        }, {
            id: "PP_ENCYCLOPEDIA_ARTICLE",
            name: "Encyclopedia Article",
            label: "Encyclopedia Article",
            description: "An article in an encyclopedia",
            bibtex_types: [ "INBOOK" ],
            csl_type: "entry-encyclopedia",
            endnote_type: "ENCYCLOPEDIA",
            zotero_type: "ENCYCLOPEDIAARTICLE",
            mendeley_type: "ENCYCLOPEDIA_ARTICLE",
            ris_type: [ {
                name: "ENCYC",
                default: true
            } ],
            field_labels: {
                booktitle: "Encyclopedia title"
            },
            field_ris: {
                isbn: "SN",
                booktitle: "T2",
                pages: "SP",
                editor: "A2",
                original_title: "OP",
                translator: "A4"
            },
            field_ris_additional: {
                ED: "editor",
                NV: "num_volumes",
                BT: "booktitle"
            },
            field_mendeley: {
                booktitle: "source"
            },
            field_endnote: {},
            field_zotero: {
                booktitle: "encyclopediatitle"
            },
            field_help: {
                title: "Title of the article." + this.getTitleHelp(),
                booktitle: "Title of the encyclopedia." + this.getTitleHelp()
            },
            mandatory_fields: [ "title", "booktitle", [ "pages" ], "author", "abstract", "published", [ "publisher", "address" ] ],
            excluded_fields: PP.Array.merge(a.pubmed, a.patent, a.series, a.misc, a.legal, a.journal, a.arxiv, a.thesis, [ "howpublished", "institution", "number", "version", "num_pages", "filed" ]),
            subtypes: []
        }, {
            id: "PP_ARTICLE",
            name: "Journal Article",
            label: "Journal Article",
            description: "Article in a scholarly journal",
            field_help: {
                title: "Title of the article" + this.getTitleHelp(),
                series: "The series the article was published in ('Recent Advances in Medical Genetics')",
                series_number: "Number of the series the article was published in"
            },
            subtypes: [ {
                name: "Research Article"
            }, {
                name: "Review"
            }, {
                name: "Editorial"
            }, {
                name: "Commentary"
            }, {
                name: "Letter to the Editor"
            }, {
                name: "Opinion"
            }, {
                name: "News"
            }, {
                name: "Erratum"
            }, {
                name: "Retracted"
            } ],
            labelFn: function(a) {
                if (!a.kind) {
                    return "Journal Article";
                } else {
                    if (a.kind === "Research Article") {
                        return "Journal Article";
                    } else {
                        return a.kind;
                    }
                }
            },
            bibtex_types: [ "ARTICLE" ],
            mendeley_type: "JOURNAL",
            zotero_type: "JOURNALARTICLE",
            endnote_type: [ {
                name: "JOURNAL ARTICLE"
            }, {
                name: "ELECTRONIC ARTICLE"
            } ],
            csl_type: "article-journal",
            ris_type: [ {
                name: "JOUR",
                default: true
            }, {
                name: "ABST"
            }, {
                name: "EJOUR"
            }, {
                name: "JFULL"
            } ],
            field_ris: {
                issn: "SN",
                pages: "SP",
                pmc: "C2",
                author: "AU",
                journal: "T2",
                original_title: "OP",
                translator: "A4"
            },
            field_ris_additional: {
                JF: "journalfull",
                JO: "journal",
                JA: "journal"
            },
            field_endnote: {
                issn: "%@"
            },
            field_zotero: {},
            mandatory_fields: [ "title", "author", [ "journal:2", "published" ], "abstract", [ "volume", "issue", "pages" ], "url", [ "doi:2", "pmid" ] ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.legal, a.isbn, a.book, a.thesis, [ "edition", "howpublished", "institution", "version", "num_pages", "num_volumes", "filed", "number" ])
        }, {
            id: "PP_NEWS_ARTICLE",
            name: "News Article",
            label: "News Article",
            description: "Article in a newspaper, magazine, or other periodical",
            bibtex_types: [ "ARTICLE" ],
            zotero_type: [ {
                subtype: "Newspaper Article",
                name: "NEWSPAPERARTICLE"
            }, {
                subtype: "Magazine Article",
                name: "MAGAZINEARTICLE"
            } ],
            endnote_type: [ {
                subtype: "Newspaper Article",
                name: "NEWSPAPER ARTICLE"
            }, {
                subtype: "Magazine Article",
                name: "MAGAZINE ARTICLE"
            } ],
            mendeley_type: [ {
                subtype: "Newspaper Article",
                name: "NEWSPAPER_ARTICLE"
            }, {
                subtype: "Magazine Article",
                name: "MAGAZINE_ARTICLE"
            } ],
            csl_type: [ {
                subtype: "Newspaper Article",
                name: "article-newspaper",
                default: true
            }, {
                subtype: "Magazine Article",
                name: "article-magazine"
            } ],
            ris_type: [ {
                subtype: "Newspaper Article",
                name: "NEWS",
                default: true
            }, {
                subtype: "Magazine Article",
                name: "MGZN"
            } ],
            ris: {
                input: {},
                output: {}
            },
            field_ris: {
                pages: "SP",
                issue: "C2",
                issn: "SN"
            },
            field_ris_additional: {
                JF: "journalfull",
                JO: "journal",
                JA: "journal",
                M1: "issue"
            },
            field_endnote: {
                journal: "%B"
            },
            field_zotero: {},
            field_help: {
                title: "Title of the article" + this.getTitleHelp(),
                journal: "Title of the magazine or newspaper in its standardized abbreviation if available",
                journalfull: "Full title of the magazine or newspaper",
                edition: "The edition of the magazine or newspaper<p>'European edition'</p>"
            },
            subtypes: [ {
                name: "Newspaper Article"
            }, {
                name: "Magazine Article"
            } ],
            mandatory_fields: [ "title", "author", "abstract", "journal", "pages", "volume", "issue", "edition", "published" ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.legal, a.pubmed, a.arxiv, a.math, a.isbn, a.book, a.series, a.thesis, [ "associated_doi", "howpublished", "institution", "version", "number", "contributor", "filed", "status" ])
        }, {
            id: "PP_CONFERENCE_PAPER",
            name: "Conference Paper",
            label: "Conference Paper",
            description: "Paper published in the proceedings of a conference",
            bibtex_types: [ "INPROCEEDINGS", "CONFERENCE" ],
            csl_type: "paper-conference",
            mendeley_type: "CONFERENCE_PROCEEDINGS",
            endnote_type: "CONFERENCE PAPER",
            zotero_type: "CONFERENCEPAPER",
            ris_type: "CPAPER",
            field_labels: {
                booktitle: "Proceedings title"
            },
            field_ris: {
                booktitle: "T2",
                series: "J2",
                address: "C1",
                pages: "SP",
                editor: "A2"
            },
            field_ris_additional: {},
            field_endnote: {
                conference: "%B",
                conference_location: "%C",
                conference_date: "%8",
                number: "%N"
            },
            field_zotero: {
                booktitle: "proceedingstitle"
            },
            field_mendeley: {
                booktitle: "source"
            },
            field_help: {
                title: "Title of the paper." + this.getTitleHelp(),
                booktitle: "Title of the conference proceedings",
                series: "Conference proceedings series"
            },
            mandatory_fields: [ "title", "booktitle", "author", "editor", "pages", "published", [ "institution", "series" ], [ "publisher", "address" ], "conference", "conference_location", "conference_date" ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.arxiv, a.journal, a.thesis, [ "chapter", "edition", "howpublished", "version", "filed", "num_pages", "num_volumes" ])
        }, {
            id: "PP_THESIS",
            name: "Thesis",
            label: "Thesis",
            description: "Thesis for a Ph.D. or other degree",
            subtypes: [ {
                name: "Ph.D. Thesis",
                default: true
            }, {
                name: "Masters Thesis"
            }, {
                name: "Bachelor's Thesis"
            }, {
                name: "Undergraduate Thesis"
            }, {
                name: "Habilitation"
            } ],
            labelFn: function(a) {
                if (!a.kind) {
                    return "Thesis";
                } else {
                    return a.kind;
                }
            },
            bibtex_types: [ "MASTERSTHESIS", "PHDTHESIS" ],
            csl_type: "thesis",
            endnote_type: "THESIS",
            mendeley_type: "THESIS",
            zotero_type: "THESIS",
            ris_type: [ {
                name: "THES",
                default: true
            }, {
                name: "PHDT",
                subtype: "Ph.D. Thesis",
                output: false
            }, {
                name: "MAST",
                subtype: "Masters Thesis",
                output: false
            } ],
            field_labels: {
                genre: "Degree",
                editor: "Advisor"
            },
            field_ris: {
                editor: "A3",
                kind: "M3",
                school: "PB",
                address: "CY",
                genre: "VL",
                department: "T2"
            },
            field_ris_additional: {},
            field_endnote: {
                department: "%B",
                num_pages: "%P",
                school: "%I",
                genre: "%V",
                editor: "%Y"
            },
            field_mendeley: {
                school: "institution"
            },
            field_zotero: {},
            field_help: {
                editor: "The advisor(s) of the thesis " + this.getAuthorHelp(),
                genre: "Awarded degree (e.g. BSc, MSc, Phd)",
                title: "Title of the thesis." + this.getTitleHelp(),
                num_pages: "The total number of pages of the thesis"
            },
            mandatory_fields: [ "title", "author", "editor", "school", "department", "genre", "published" ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.math, a.legal, a.issn, a.pubmed, a.arxiv, a.series, a.journal, a.book, a.volume, [ "associated_doi", "number", "edition", "howpublished", "institution", "version", "filed", "pages" ])
        }, {
            id: "PP_PREPRINT",
            name: "Preprint Manuscript",
            label: "Preprint Manuscript",
            description: "Preprint version of a manuscript or working paper",
            bibtex_types: [ "UNPUBLISHED", "MISC", "ARTICLE" ],
            csl_type: "manuscript",
            mendeley_type: "WORKING_PAPER",
            endnote_type: "UNPUBLISHED WORK",
            ris_type: [ {
                name: "INPR",
                default: true
            } ],
            field_ris: {
                eprint: "SN",
                archivePrefix: "DP",
                translator: "A4"
            },
            field_endnote: {
                institution: [ "%I", "%S" ]
            },
            field_labels: {
                journal: "Source"
            },
            field_help: {
                title: "Title of the manuscript" + this.getTitleHelp(),
                num_pages: "The total number of pages of the manuscript",
                journal: "Database or archive where the preprint manuscript was deposited",
                series: "The series the working paper was published in <br>'Working Paper Series'",
                number: "Number of the working paper"
            },
            mandatory_fields: [ "title", "author", "journal", "institution", "series", "number", "published", "url" ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.book, a.volume, a.publisher, a.thesis, a.pubmed, a.math, a.issn, a.isbn, [ "series_number", "series_editor", "edition", "version", "filed", "originally_published", "lccn", "journalfull" ])
        }, {
            id: "PP_MANUSCRIPT",
            name: "Archival Material",
            label: "Archival Material",
            description: "Documents stored in an archive",
            bibtex_types: [ "MISC" ],
            csl_type: "manuscript",
            endnote_type: "MANUSCRIPT",
            zotero_type: "MANUSCRIPT",
            ris_type: [ {
                name: "MANSCPT",
                default: true
            } ],
            field_labels: {
                series: "Collection",
                series_editor: "Editor of the collection",
                series_number: "Collection number"
            },
            field_ris: {
                eprint: "SN",
                archivePrefix: "DP",
                translator: "A4",
                howpublished: "T2"
            },
            field_mendeley: {
                howpublished: "source"
            },
            field_endnote: {
                series: "%B",
                series_number: "%N",
                original_title: "%(",
                archive: "%I",
                publisher: null
            },
            field_zotero: {
                howpublished: "journalabbreviation"
            },
            field_csl: {
                howpublished: "container-title"
            },
            field_help: {
                title: "Title of the manuscript" + this.getTitleHelp(),
                series: "Name of the collection<p>'William H. Sager China Marines Photograph Collection'</p>",
                series_number: "Number of the collection",
                series_editor: "Collection editor(s)" + this.getAuthorHelp()
            },
            mandatory_fields: [ "title", "author", "series", "archive", "archive_location", "archive_place", "url", "published" ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.book, a.journal, a.thesis, a.issn, a.pubmed, a.arxiv, a.math, a.conference, [ "institution", "number", "edition", "version", "filed" ])
        }, {
            id: "PP_REPORT",
            name: "Report",
            label: "Report",
            description: "Report published by a university or organization",
            bibtex_types: [ "TECHREPORT" ],
            subtypes: [ {
                name: "Technical Report"
            }, {
                name: "Government Report"
            }, {
                name: "White Paper"
            }, {
                name: "Guideline"
            } ],
            csl_type: "report",
            mendeley_type: "REPORT",
            zotero_type: "REPORT",
            endnote_type: [ {
                name: "REPORT"
            }, {
                name: "GOVERNMENT DOCUMENT",
                subtype: "Government Report"
            } ],
            ris_type: [ {
                name: "RPRT",
                default: true
            }, {
                name: "GOVDOC",
                subtype: "Government Report"
            } ],
            field_ris: {
                publisher: "A3",
                issue: "C6",
                kind: "M3",
                institution: "PB",
                number: "SN",
                num_pages: "SP",
                series: "T2",
                series_editor: "A2"
            },
            field_endnote: {
                number: "%@",
                institution: [ "%I", "%1", "%?", "%E" ],
                series_editor: "%E",
                publisher: "%Y",
                series: "%B",
                translator: null,
                editor: null,
                series_editor: null,
                series_volume: "%6"
            },
            field_zotero: {
                number: "reportnumber",
                series: "seriestitle"
            },
            field_mendeley: {
                number: "revision"
            },
            field_ris_additional: {},
            field_help: {
                title: "Title of the report." + this.getTitleHelp(),
                series: "The series the report was published in ('Recent Advances in Medical Genetics')",
                series_number: "Number of the series the report was published in",
                conference: "Event where the report was presented",
                conference_location: "Location where the event was held",
                conference_date: "Date of the event",
                pages: "<p>The range or starting page, e.g. <p>'210-213' or '210'</p>"
            },
            field_labels: {
                pages: "Pages cited",
                conference: "Event name",
                conference_location: "Event place",
                conference_date: "Date of the event"
            },
            mandatory_fields: [ "title", "author", [ "number", "institution" ], "published", "num_pages" ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.book, a.journal, a.pubmed, a.math, a.arxiv, a.thesis, [ "associated_doi", "howpublished", "version", "num_volumes", "filed" ])
        }, {
            id: "PP_STANDARD",
            name: "Standard",
            label: "Standard",
            description: "A standard issued by ISO, ANSI,\u2026",
            bibtex_types: [ "TECHREPORT" ],
            subtypes: [],
            csl_type: "report",
            ris_type: [ {
                name: "STAND",
                default: true
            } ],
            endnote_type: "STANDARD",
            field_ris: {
                number: "SN",
                num_pages: "SP"
            },
            field_endnote: {
                number: [ "%V", "%S", "%@" ],
                genre: "%B"
            },
            field_zotero: {},
            field_help: {
                title: "Title of the standard." + this.getTitleHelp(),
                author: "The name of the issuing agency in braces <p>'{International Organization for Standardization}'</p>",
                pages: "<p>The range or starting page, e.g. <p>'210-213' or '210'</p>"
            },
            field_labels: {
                pages: "Pages cited",
                author: "Issuing Agency"
            },
            mandatory_fields: [ "title", "author", "number", "published", "num_pages", "publisher", "address" ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.legal, a.pubmed, a.arxiv, a.series, a.volume, a.journal, a.book, a.thesis, a.isbn, a.issn, a.math, a.archive, [ "associated_doi", "howpublished", "version", "filed", "affiliation", "institution", "editor", "contributor", "lccn" ])
        }, {
            id: "PP_PATENT",
            name: "Patent",
            label: "Patent",
            description: "Published patent",
            bibtex_types: [ "PATENT" ],
            csl_type: "patent",
            mendeley_type: "PATENT",
            endnote_type: "PATENT",
            zotero_type: "PATENT",
            ris_type: "PAT",
            subtypes: [ {
                name: "Patent Application"
            }, {
                name: "Utility Patent"
            }, {
                name: "Design Patent"
            }, {
                name: "Plant Patent"
            }, {
                name: "Reissue Patent"
            }, {
                name: "Defensive Publication"
            }, {
                name: "Statutory Invention Registration"
            } ],
            field_labels: {
                title: "Patent title",
                author: "Inventors",
                journal: "Type of patent",
                journalfull: "Issuing office full name"
            },
            field_ris: {
                patent_publication_type: "M3",
                assignee: "PB",
                states: "C3",
                class: "NV",
                international_class: "ET",
                issuing_authority: "A2"
            },
            field_endnote: {
                patent_number: "%@",
                assignee: "%I",
                international_class: "%7",
                states: "%3",
                priority_numbers: "%(",
                class: "%6",
                application_number: "%N",
                issuing_authority: "%E",
                filed: "%2",
                genre: "%9"
            },
            field_zotero: {
                published: "issuedate"
            },
            field_mendeley: {
                patent_number: "revision",
                issuing_authority: "publisher"
            },
            field_help: {
                title: "Title of the patent." + this.getTitleHelp(),
                journal: "Type of patent (e.g. US Patent, International Patent)",
                journalfull: "The full name of the authority / office issuing the patent (e.g., 'United States Patent and Trademark Office')",
                author: "The inventor(s)" + this.getAuthorHelp()
            },
            mandatory_fields: [ "title", "author", "assignee", "issuing_authority", "patent_number", "filed", "published", "abstract" ],
            excluded_fields: PP.Array.merge(a.conference, a.misc, a.legal, a.book, a.series, a.volume, a.pages, a.arxiv, a.pubmed, a.math, a.thesis, a.isbn, a.archive, [ "associated_doi", "number", "issue", "edition", "howpublished", "publisher", "original_publisher", "version", "editor", "lccn" ])
        }, {
            id: "PP_UNPUBLISHED",
            name: "Unpublished Item",
            label: "Unpublished",
            description: "Work that has not been formally published",
            bibtex_types: [ "UNPUBLISHED" ],
            csl_type: "article",
            ris_type: "UNPB",
            field_labels: {
                published: "Date",
                conference: "Event name",
                conference_location: "Event place",
                conference_date: "Date of the event"
            },
            field_ris: {},
            field_ris_additional: {},
            field_endnote: {},
            field_zotero: {},
            field_help: {
                title: "Title of the document." + this.getTitleHelp(),
                conference: "Event where the interview was conducted",
                conference_location: "Location where the event was held",
                conference_date: "Date of the event" + this.getDateHelp(),
                published: "Date when the document was created" + this.getDateHelp()
            },
            mandatory_fields: [ "title", "author", "published" ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.isbn, a.issn, a.pubmed, a.book, a.journal, a.arxiv, a.publisher, a.series, a.volume, a.thesis, a.math, [ "associated_doi", "doi", "edition", "pages", "howpublished", "institution", "version", "num_pages", "editor", "originally_published", "lccn", "filed" ])
        }, {
            id: "PP_LETTER",
            name: "Letter",
            label: "Letter",
            description: "A letter with sender and recipient",
            bibtex_types: [ "MISC" ],
            csl_type: "personal_communication",
            zotero_type: [ {
                name: "LETTER"
            } ],
            subtypes: [],
            field_ris: {
                pages: "SP"
            },
            field_ris_additional: {},
            field_endnote: {},
            field_zotero: {},
            field_labels: {
                author: "Sender",
                published: "Date",
                editor: "Recipient",
                series: "Collection",
                series_number: "Collection number",
                series_editor: "Collection editor"
            },
            field_csl: {
                editor: "recipient"
            },
            field_help: {
                series: "Name of the collection<p>'William H. Sager China Marines Photograph Collection'</p>",
                series_number: "Number of the collection",
                series_editor: "The collection editor(s)" + this.getAuthorHelp(),
                editor: "The recipient(s)" + this.getAuthorHelp(),
                author: "The sender(s)" + this.getAuthorHelp(),
                published: "Date when the letter was written" + this.getDateHelp()
            },
            mandatory_fields: [ "author", "published", "editor", "abstract", "series", "archive", "archive_location", "archive_place", "url" ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.journal, a.pubmed, a.math, a.arxiv, a.thesis, a.issn, a.isbn, a.book, [ "edition", "pages", "howpublished", "institution", "version", "contributor", "status", "filed" ])
        }, {
            id: "PP_INTERVIEW",
            name: "Interview",
            label: "Interview",
            description: "A published or personal interview",
            bibtex_types: [ "MISC" ],
            csl_type: "interview",
            zotero_type: [ {
                name: "INTERVIEW"
            } ],
            ris_type: [ {
                name: "INTV",
                default: true
            } ],
            endnote_type: [ {
                name: "INTERVIEW"
            } ],
            subtypes: [],
            field_ris: {
                pages: "SP",
                editor: "A2"
            },
            field_ris_additional: {},
            field_zotero: {
                editor: "interviewer",
                author: "interviewee"
            },
            field_endnote: {
                journal: "%B",
                original_title: "%("
            },
            field_labels: {
                author: "Interview with",
                published: "Date",
                editor: "Interviewer",
                conference: "Event name",
                conference_location: "Event place",
                conference_date: "Date of the event",
                journal: "Magazine",
                genre: "Type"
            },
            field_csl: {
                editor: "interviewer"
            },
            field_help: {
                genre: "Type of interview <p>'Personal Interview', Phone Interview', 'Skype Interview'",
                published: "Date when the interview was conducted or published",
                conference: "Event where the interview was conducted",
                conference_location: "Location where the event was held",
                conference_date: "Date of the event" + this.getDateHelp(),
                author: "Name of the person that is interviewed" + this.getAuthorHelp(),
                editor: "The interviewer(s)" + this.getAuthorHelp(),
                journal: "Title of the magazine in its standardized abbreviation if available"
            },
            mandatory_fields: [ "author", "editor", "published", "abstract", "conference", "conference_location", "conference_date", "genre", "url" ],
            excluded_fields: PP.Array.merge(a.series, a.patent, a.misc, a.legal, a.pubmed, a.math, a.arxiv, a.thesis, a.issn, a.isbn, a.book, [ "edition", "howpublished", "institution", "version", "contributor", "status", "filed" ])
        }, {
            id: "PP_PERSONAL_COMMUNICATION",
            name: "Personal Communication",
            label: "Personal Communication",
            description: "Information or data received via personal communication",
            bibtex_types: [ "MISC" ],
            csl_type: "personal_communication",
            endnote_type: "PERSONAL COMMUNICATION",
            zotero_type: [ {
                subtype: "Message",
                name: "INSTANTMESSAGE"
            }, {
                subtype: "E-mail",
                name: "EMAIL"
            } ],
            ris_type: [ {
                name: "PCOMM",
                default: true
            }, {
                name: "ICOMM"
            } ],
            subtypes: [ {
                name: "E-mail"
            }, {
                name: "Letter"
            }, {
                name: "Conversation"
            }, {
                name: "Message"
            } ],
            field_ris: {
                pages: "SP",
                editor: "A2"
            },
            field_ris_additional: {},
            field_endnote: {},
            field_zotero: {},
            field_labels: {
                author: "Author or source",
                published: "Date",
                editor: "Recipient"
            },
            field_csl: {
                editor: "recipient"
            },
            field_help: {
                conference: "Event where the communication took place",
                conference_location: "Location where the event was held",
                conference_date: "Date of the event" + this.getDateHelp(),
                editor: "The recipient(s)" + this.getAuthorHelp(),
                author: "The author(s)" + this.getAuthorHelp(),
                published: "Date when the communication took place" + this.getDateHelp()
            },
            mandatory_fields: [ "author", "published", "editor", "abstract" ],
            excluded_fields: PP.Array.merge(a.series, a.patent, a.misc, a.legal, a.journal, a.pubmed, a.math, a.arxiv, a.thesis, a.issn, a.isbn, a.book, [ "edition", "pages", "howpublished", "institution", "version", "contributor", "status", "genre", "filed", "num_pages", "num_volumes" ])
        }, {
            id: "PP_WEBSITE",
            name: "Website",
            label: "Website",
            description: "Website accessed online",
            bibtex_types: [ "ONLINE", "MISC" ],
            csl_type: "webpage",
            mendeley_type: "WEB_PAGE",
            endnote_type: [ {
                name: "WEB PAGE"
            }, {
                name: "BLOG",
                subtype: "Blog post"
            }, {
                name: "ONLINE DATABASE",
                subtype: "Database"
            }, {
                name: "ELECTRONIC SOURCE"
            } ],
            zotero_type: [ {
                name: "WEBPAGE"
            }, {
                name: "BLOGPOST",
                subtype: "Blog post"
            }, {
                name: "FORUMPOST",
                subtype: "Forum post"
            } ],
            ris_type: [ {
                name: "ELEC",
                default: true
            }, {
                subtype: "Database",
                name: "DBASE"
            }, {
                subtype: "Blog post",
                name: "BLOG"
            }, {
                subtype: "Wikipedia",
                name: "ENCYC"
            }, {
                name: "WEB"
            }, {
                name: "WEBP"
            }, {
                name: "MULTI"
            } ],
            field_labels: {
                booktitle: "Website name"
            },
            subtypes: [ {
                name: "Article"
            }, {
                name: "Database"
            }, {
                name: "Blog post"
            }, {
                name: "Forum post"
            }, {
                name: "Wikipedia"
            }, {
                name: "Tweet"
            } ],
            field_ris: {
                isbn: "SN",
                accessed: "M1"
            },
            field_ris_additional: {},
            field_endnote: {
                accessed: [ "%V", "%N" ],
                affiliation: [ "%1", "%+" ]
            },
            field_mendeley: {
                booktitle: "source"
            },
            field_zotero: {
                booktitle: "websitetitle"
            },
            field_zotero_additional: {
                blogtitle: "booktitle",
                forumtitle: "booktitle"
            },
            field_help: {
                title: "Title of the page." + this.getTitleHelp(),
                booktitle: "Title of the website."
            },
            mandatory_fields: [ "title", "booktitle", "url", "author", "accessed", "published" ],
            excluded_fields: PP.Array.merge(a.archive, a.conference, a.patent, a.misc, a.legal, a.journal, a.pages, a.volume, a.arxiv, a.issn, a.pubmed, a.math, a.thesis, a.series, a.isbn, [ "chapter", "number", "edition", "howpublished", "institution", "version", "editor", "filed", "lccn", "status" ])
        }, {
            id: "PP_COMPUTER_PROGRAM",
            name: "Computer Program",
            label: "Computer Program",
            description: "Software run on a computer",
            subtypes: [ {
                name: "Scientific software"
            }, {
                name: "Statistics software"
            }, {
                name: "Graphics software"
            }, {
                name: "Business software"
            }, {
                name: "System software"
            }, {
                name: "Programming language"
            }, {
                name: "Database"
            }, {
                name: "Script"
            }, {
                name: "Utility"
            }, {
                name: "Video game"
            } ],
            bibtex_types: [ "MISC" ],
            csl_type: "book",
            endnote_type: "COMPUTER PROGRAM",
            mendeley_type: "COMPUTER_PROGRAM",
            zotero_type: "COMPUTERPROGRAM",
            ris_type: [ {
                name: "COMP",
                default: true
            }, {
                subtype: "Database",
                name: "DBASE"
            } ],
            field_ris: {
                version: "ET"
            },
            field_ris_additional: {},
            field_mendeley: {
                version: "revision"
            },
            field_endnote: {
                version: "%V"
            },
            field_zotero: {
                series: "seriestitle"
            },
            field_zotero_additional: {
                versionnumber: "version"
            },
            field_help: {
                title: "Name of the program" + this.getTitleHelp()
            },
            mandatory_fields: [ "title", "version", "author", "published", "url" ],
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.journal, a.book, a.pages, a.volume, a.series, a.thesis, a.arxiv, a.isbn, a.issn, a.pubmed, a.conference, a.math, a.archive, [ "number", "edition", "howpublished", "editor", "filed", "lccn" ])
        }, {
            id: "PP_MANUAL",
            name: "Manual or Documentation",
            label: "Manual or Documentation",
            description: "Instruction manual or other type of documentation",
            bibtex_types: [ "MANUAL" ],
            csl_type: "report",
            ris_type: "MANU",
            field_ris: {
                number: "IS",
                num_pages: "SP"
            },
            field_ris_additional: {},
            field_help: {
                title: "Title of the document" + this.getTitleHelp(),
                version: "Version of the product this manual is about",
                institution: "The organization or institution that publishes the manual"
            },
            mandatory_fields: [ "title", "version", "author", "institution", "published", "url" ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.legal, a.issn, a.book, a.journal, a.series, a.thesis, a.volume, a.arxiv, a.pubmed, a.math, a.archive, [ "howpublished", "filed", "lccn" ])
        }, {
            id: "PP_DATASET",
            name: "Dataset",
            label: "Dataset",
            description: "A dataset with its own DOI or webpage",
            bibtex_types: [ "MISC" ],
            csl_type: "dataset",
            ris_type: "DATA",
            endnote_type: [ {
                name: "AGGREGATED DATABASE"
            }, {
                name: "DATASET",
                default: true
            } ],
            mandatory_fields: [ "title", "author", "url", "doi", [ "published", "accessed" ], "booktitle", "associated_doi" ],
            field_help: {
                title: "Title of the dataset" + this.getTitleHelp(),
                booktitle: "The title of the publication associated with this dataset",
                associated_doi: "The DOI of the publication with which this dataset is associated",
                url: "A list of URLs where this item can be accessed online (one per line)",
                author: "The dataset author(s)" + this.getAuthorHelp(),
                doi: "A generic identifier for digital objects. Some datasets have a unique DOI assigned on publication."
            },
            field_labels: {
                title: "Dataset name",
                author: "Dataset author(s)",
                doi: "Dataset DOI",
                url: "Dataset URL",
                booktitle: "Publication title",
                associated_doi: "Publication DOI"
            },
            field_ris: {},
            field_ris_additional: {},
            field_endnote: {
                version: "%7"
            },
            field_zotero: {},
            excluded_fields: PP.Array.merge(a.patent, a.misc, a.legal, a.journal, a.pages, a.conference, a.issn, a.isbn, a.volume, a.thesis, a.series, a.pubmed, a.arxiv, a.math, [ "chapter", "number", "howpublished", "institution", "filed", "lccn" ])
        }, {
            id: "PP_PRESENTATION",
            name: "Presentation",
            label: "Presentation",
            description: "Talk or other presentation",
            bibtex_types: [ "MISC" ],
            csl_type: "speech",
            zotero_type: "PRESENTATION",
            ris_type: [ {
                name: "SLIDE",
                default: true
            } ],
            field_labels: {
                author: "Presenter",
                published: "Date",
                conference: "Event name",
                conference_location: "Event place",
                conference_date: "Date of the event"
            },
            field_ris: {},
            field_ris_additional: {
                A2: "editor"
            },
            field_endnote: {},
            field_zotero: {},
            field_csl: {
                journal: "event"
            },
            field_help: {
                title: "Title of the presentation" + this.getTitleHelp(),
                journal: "Event where the presentation took place",
                conference: "Event where the presentation took place",
                conference_location: "Location where the event was held",
                conference_date: "Date when the event took place",
                author: "The presenter(s)" + this.getAuthorHelp(),
                published: "Date when the presentation was held" + this.getDateHelp()
            },
            mandatory_fields: [ "title", "conference", "conference_location", "author", "abstract", "published", "url" ],
            excluded_fields: PP.Array.merge(a.archive, a.patent, a.misc, a.legal, a.issn, a.isbn, a.math, a.pubmed, a.arxiv, a.volume, a.book, a.thesis, [ "number", "num_pages", "version", "journalfull", "volume", "issue", "edition", "pages", "institution", "editor", "howpublished", "filed", "series", "series_number", "series_editor" ]),
            subtypes: [ {
                name: "Conference talk"
            }, {
                name: "Seminar"
            }, {
                name: "Lecture"
            }, {
                name: "Reading"
            }, {
                name: "Poster presentation"
            }, {
                name: "Workshop"
            } ]
        }, {
            id: "PP_MISC",
            name: "Miscellaneous",
            label: "Miscellaneous",
            description: "Miscellaneous reference or resource",
            bibtex_types: [ "MISC" ],
            csl_type: "article",
            ris_type: "MISC",
            mandatory_fields: [ "title", "author", "howpublished", "url", "published" ],
            excluded_fields: PP.Array.merge(a.patent, a.legal, [ "filed" ]),
            field_ris: {
                pages: "SP"
            },
            field_ris_additional: {
                JF: "journalfull",
                JO: "journal"
            },
            field_endnote: {},
            field_zotero: {},
            field_help: {
                title: "Title of the item"
            }
        }, {
            id: "PP_BROADCAST",
            name: "Broadcast",
            label: "Broadcast",
            description: "Radio or TV broadcast",
            bibtex_types: [ "MISC" ],
            mendeley_type: [ {
                name: "TELEVISION_BROADCAST",
                subtype: "TV broadcast"
            } ],
            csl_type: "broadcast",
            zotero_type: [ {
                subtype: "TV broadcast",
                name: "TVBROADCAST"
            }, {
                subtype: "Radio broadcast",
                name: "RADIOBROADCAST"
            } ],
            ris_type: [ {
                name: "MPCT",
                import: false,
                default: true
            } ],
            mandatory_fields: [ "title", "booktitle", "author", "publisher", "address", "number", "url", "published", "medium", "running_time" ],
            excluded_fields: PP.Array.merge(a.arxiv, a.pages, a.patent, a.legal, a.journal, a.pubmed, a.math, a.arxivid, a.issn, a.isbn, a.thesis, [ "filed", "institution", , "scale", "howpublished", "version", "ismn", "associated_doi", "chapter", "lccn" ]),
            csl_excluded_fields: [ "editor", "series_editor" ],
            subtypes: [ {
                name: "TV broadcast"
            }, {
                name: "Radio broadcast"
            } ],
            field_labels: {
                booktitle: "Program Title",
                publisher: "Network",
                number: "Episode Number",
                author: "Directors",
                editor: "Cast members",
                series_editor: "Producers",
                published: "Broadcast date",
                conference: "Event name",
                conference_location: "Event place",
                conference_date: "Date of the event",
                medium: "Format"
            },
            field_ris: {
                editor: "C1",
                series_editor: "A3",
                running_time: "SP",
                medium: "M3",
                booktitle: "T2"
            },
            field_endnote: {},
            field_zotero: {
                booktitle: "programtitle",
                number: "episodenumber",
                publisher: "network",
                medium: "videorecordingformat"
            },
            field_ris_additional: {},
            field_zotero_additional: {
                audiorecordingformat: "medium"
            },
            field_help: {
                title: "Title of the broadcast" + this.getTitleHelp(),
                publisher: "The network's name <p>'BBC' or 'HBO'</p>",
                booktitle: "Title of the program",
                number: "Number of the current episode",
                author: "The director(s)" + this.getAuthorHelp(),
                editor: "The cast member(s) or reporter(s)" + this.getAuthorHelp(),
                series_editor: "The producer(s)" + this.getAuthorHelp(),
                medium: "e.g. 'Radio broadcast' or 'TV broadcast'",
                address: "Address of the network",
                conference: "Event where the broadcast was recorded",
                conference_location: "Location where the event was held",
                conference_date: "Date of the event",
                published: "Date when the broadcast was aired" + this.getDateHelp()
            }
        }, {
            id: "PP_AUDIO",
            name: "Audio",
            label: "Audio",
            description: "Published audio recording",
            bibtex_types: [ "MISC" ],
            csl_type: "song",
            zotero_type: [ {
                subtype: "Podcast",
                name: "PODCAST"
            }, {
                subtype: "Audio recording",
                name: "AUDIORECORDING"
            } ],
            ris_type: [ {
                name: "SOUND",
                default: true
            }, {
                name: "MUSIC"
            } ],
            mandatory_fields: [ "title", "author", "publisher", "url", "published", "medium", "running_time" ],
            excluded_fields: PP.Array.merge(a.pages, a.patent, a.legal, a.journal, a.isbn, a.issn, a.pubmed, a.arxiv, a.math, a.thesis, [ "chapter", "filed", "scale", "institution", "ismn", "howpublished", "associated_doi" ]),
            csl_excluded_fields: [ "series_editor" ],
            subtypes: [ {
                name: "Song"
            }, {
                name: "Concert"
            }, {
                name: "Podcast"
            } ],
            field_labels: {
                publisher: "Label or publisher",
                author: "Performers",
                editor: "Composers",
                series_editor: "Producers",
                number: "Episode Number",
                published: "Date released",
                conference: "Event name",
                conference_location: "Event place",
                conference_date: "Date of the event",
                booktitle: "Album name"
            },
            field_shortlabels: {
                published: "Released"
            },
            field_ris: {
                editor: "C1",
                series_editor: "A3",
                running_time: "SP",
                medium: "M3"
            },
            field_ris_additional: {
                C5: "medium",
                A2: "author",
                AU: "editor"
            },
            field_endnote: {},
            field_zotero: {
                medium: "audiorecordingformat",
                publisher: "label",
                series: "seriestitle"
            },
            field_csl: {
                editor: "composer"
            },
            field_help: {
                publisher: "The name of the label <p>'Universal Music Group' or 'Warner Music Group'</p>",
                number: "Number of the episode",
                author: "The performer(s), the band, or the podcaster(s)" + this.getAuthorHelp(),
                editor: "The composer(s)" + this.getAuthorHelp(),
                series_editor: "The producer(s)" + this.getAuthorHelp(),
                booktitle: "Name of the album",
                conference: "Event where the item was recorded",
                conference_location: "Location where the event was held",
                conference_date: "Date of the event",
                published: "Date when the item was released" + this.getDateHelp()
            }
        }, {
            id: "PP_VIDEO",
            name: "Video or Film",
            label: "Video or Film",
            description: "Published video recording or film",
            bibtex_types: [ "MISC" ],
            mendeley_type: "FILM",
            endnote_type: [ {
                name: "ONLINE MULTIMEDIA"
            }, {
                name: "AUDIOVISUAL MATERIAL"
            }, {
                name: "FILM OR BROADCAST"
            } ],
            csl_type: "motion_picture",
            zotero_type: [ {
                subtype: "Film",
                name: "FILM"
            }, {
                subtype: "Video",
                name: "VIDEORECORDING"
            } ],
            ris_type: [ {
                name: "VIDEO",
                default: true
            }, {
                name: "ADVS"
            }, {
                name: "MPCT"
            } ],
            mandatory_fields: [ "title", "author", "publisher", "address", "url", "published", "medium", "running_time" ],
            excluded_fields: PP.Array.merge(a.pages, a.patent, a.journal, a.legal, a.math, a.pubmed, a.isbn, a.issn, a.arxiv, a.book, a.thesis, [ "scale", "institution", "ismn", "howpublished", "filed", "associated_doi" ]),
            csl_excluded_fields: [ "editor", "series_editor", "contributor" ],
            subtypes: [ {
                name: "Video"
            }, {
                name: "Online Video"
            }, {
                name: "Film"
            }, {
                name: "TV Series"
            } ],
            field_labels: {
                publisher: "Studio or distributor",
                author: "Directors",
                editor: "Cast members",
                series_editor: "Producers",
                published: "Date released",
                conference: "Event name",
                conference_location: "Event place",
                conference_date: "Date of the event",
                address: "Country"
            },
            field_shortlabels: {
                published: "Released"
            },
            field_ris: {
                editor: "C1",
                series_editor: "A3",
                running_time: "SP",
                medium: "M3",
                genre: "C4",
                series: "T2"
            },
            field_endnote: {
                number: "%N",
                running_time: [ "%3", "%P" ],
                genre: "%4",
                series: "%B",
                editor: "%?"
            },
            field_zotero: {
                publisher: "studio",
                medium: "videorecordingformat",
                series: "seriestitle"
            },
            field_ris_additional: {
                A2: "editor"
            },
            field_help: {
                title: "Title of film or video",
                publisher: "The name of the studio or distributor<p>'Walt Disney Pictures', '20th Century Fox', 'YouTube'</p>",
                author: "The director(s)" + this.getAuthorHelp(),
                editor: "The cast member(s)" + this.getAuthorHelp(),
                series_editor: "The producer(s)" + this.getAuthorHelp(),
                conference: "Event where the item was recorded",
                conference_location: "Location where the event was held",
                conference_date: "Date of the event",
                published: "Date when the item was released" + this.getDateHelp(),
                address: "Country where the movie or film was produced"
            }
        }, {
            id: "PP_CASE",
            name: "Case",
            label: "Case",
            description: "Legal case",
            bibtex_types: [ "MISC" ],
            csl_type: "legal_case",
            mendeley_type: "CASE",
            endnote_type: "CASE",
            zotero_type: "CASE",
            ris_type: "CASE",
            mandatory_fields: [ "title", "journal", "court", "volume", "pages", "jurisdiction", "url", "published", "number" ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.math, a.thesis, a.archive, a.pubmed, a.arxiv, [ "issue", "isbn", "isbn_alt", "issn", "issn_alt", "eprint", "num_pages", "conference", "institution", "chapter", "session", "legislative_body", "status", "series", "num_volumes", "booktitle", "author", "address", "publisher", "original_publisher", "howpublished", "original_address", "originally_published", "version", "editor", "series_editor" ]),
            subtypes: [],
            field_labels: {
                journal: "Reporter",
                journalfull: "Full reporter name",
                title: "Case name",
                volume: "Reporter volume",
                pages: "First page",
                filed: "Filing date",
                series_number: "Year as volume",
                number: "Docket number",
                published: "Date decided"
            },
            field_ris: {
                journal: "T2",
                pages: "SP",
                filed: "SE",
                history: "OP",
                court: "PB"
            },
            field_zotero: {
                title: "casename",
                journal: "reporter",
                volume: "reportervolume",
                court: "court",
                pages: "firstpage",
                number: "docketnumber"
            },
            field_endnote: {
                journal: "%B",
                history: "%(",
                number: "%N",
                court: "%I",
                filed: "%&",
                edition: null,
                kind: null,
                translator: null,
                original_title: null,
                contributor: null
            },
            field_mendeley: {
                journal: "authors"
            },
            field_ris_additional: {},
            field_csl: {},
            field_help: {
                title: "Case name",
                journal: "Abbreviation of the reporter (publication containing the opinions of a particular court or jurisdiction)",
                journalfull: "The reporter fully spelled out",
                volume: "Volume number",
                pages: "First page of the case in the given volume",
                series_number: "The year used as volume number",
                number: "Docket number",
                filed: "Date when the case was filed" + this.getDateHelp(),
                published: "Date of decision" + this.getDateHelp()
            }
        }, {
            id: "PP_STATUTE",
            name: "Statute",
            label: "Statute",
            description: "Statute",
            bibtex_types: [ "MISC" ],
            csl_type: "legislation",
            mendeley_type: "STATUTE",
            endnote_type: "STATUTE",
            zotero_type: "STATUTE",
            ris_type: "STAT",
            mandatory_fields: [ "title", "journal", "volume", "pages", "section", "number", "history", "jurisdiction", "url", "published", "filed" ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.math, a.thesis, a.archive, a.pubmed, a.arxiv, [ "issue", "isbn", "isbn_alt", "issn", "issn_alt", "num_pages", "institution", "status", "series", "num_volumes", "booktitle", "edition", "genre", "publisher", "original_publisher", "affiliation", "address", "original_address", "originally_published", "author", "editor", "series_editor", "version", "howpublished", "court" ]),
            subtypes: [],
            field_labels: {
                published: "Date enacted",
                filed: "Date amended",
                title: "Name of act",
                volume: "Code number",
                series_number: "Regnal year",
                journal: "Code",
                journalfull: "Full name of the Code",
                number: "Public Law Number"
            },
            field_ris: {
                number: "M1",
                history: "OP",
                section: "SE",
                pages: "SP",
                journal: "T2",
                session: "ET"
            },
            field_endnote: {
                section: "%&",
                journal: "%B",
                history: "%(",
                number: "%N",
                author: "%?",
                session: "%7",
                original_title: null
            },
            field_ris_additional: {},
            field_csl: {
                filed: "event-date"
            },
            field_zotero: {
                title: "nameofact",
                volume: "codenumber",
                journal: "code",
                number: "publiclawnumber"
            },
            field_mendeley: {
                journal: "code"
            },
            field_help: {
                journal: "The official source for statutes (e.g. U.S.C.)",
                journalfull: "The official source for statutes (e.g. United States Code)",
                published: "Date when the statute was enacted" + this.getDateHelp(),
                filed: "Date when the statute was amended" + this.getDateHelp(),
                title: "Name of act",
                volume: "Code number",
                series_number: "Regnal year",
                number: "Public Law Number"
            }
        }, {
            id: "PP_BILL",
            name: "Bill",
            label: "Bill",
            description: "Bill",
            bibtex_types: [ "MISC" ],
            csl_type: "bill",
            mendeley_type: "BILL",
            endnote_type: "BILL",
            zotero_type: "BILL",
            ris_type: [ {
                name: "BILL",
                default: true
            }, {
                name: "UNBILL"
            } ],
            mandatory_fields: [ "title", "author", "legislative_body", "session", "number", "section", "jurisdiction", "url", "published" ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.math, a.thesis, a.archive, a.pubmed, a.arxiv, a.series, [ "issue", "isbn", "isbn_alt", "issn", "issn_alt", "num_pages", "institution", "chapter", "journalfull", "num_volumes", "booktitle", "edition", "genre", "publisher", "original_publisher", "affiliation", "address", "original_address", "howpublished", "originally_published", "editor", "series_editor", "version", "filed", "court" ]),
            subtypes: [],
            field_labels: {
                published: "Date",
                journal: "Code",
                volume: "Code volume",
                pages: "Code pages",
                author: "Sponsor",
                number: "Bill number"
            },
            field_ris: {
                author: "A2",
                number: "M1",
                history: "OP",
                section: "SE",
                pages: "SP",
                journal: "T2",
                legislative_body: "T3",
                session: "ET"
            },
            field_ris_additional: {},
            field_endnote: {
                section: "%&",
                legislative_body: "%S",
                journal: "%B",
                history: "%(",
                number: "%N",
                author: "%?",
                session: "%7",
                original_title: null
            },
            field_zotero: {
                pages: "codepages",
                volume: "codevolume",
                number: "billnumber",
                journal: "code"
            },
            field_help: {
                journal: "The official source for the bill (e.g. the United States Code or U.S.C.)",
                published: "Date" + this.getDateHelp(),
                volume: "Code volume",
                pages: "Code pages",
                author: "Sponsor",
                number: "Bill number"
            }
        }, {
            id: "PP_TREATY",
            name: "Treaty",
            label: "Treaty",
            description: "Treaty (International law)",
            bibtex_types: [ "MISC" ],
            csl_type: "treaty",
            zotero_type: "TREATY",
            mandatory_fields: [ "title", "author", "journal", "volume", "pages", "number", "url", "published" ],
            excluded_fields: PP.Array.merge(a.conference, a.patent, a.misc, a.math, a.thesis, a.archive, a.pubmed, a.arxiv, a.series, [ "issue", "isbn", "isbn_alt", "issn", "issn_alt", "num_pages", "institution", "chapter", "status", "num_volumes", "booktitle", "edition", "genre", "original_publisher", "affiliation", "address", "original_address", "originally_published", "editor", "version", "howpublished", "jurisdiction", "legislative_body", "history", "session", "court" ]),
            subtypes: [],
            field_labels: {
                title: "Title of the agreement",
                author: "Names of the parties",
                published: "Date in force",
                filed: "Date signed",
                journal: "Source",
                journalfull: "Full name source"
            },
            field_ris: {},
            field_ris_additional: {},
            field_zotero: {},
            field_help: {
                title: "Title of the agreement (e.g. Kyoto Protocol to the United Nations Framework Convention on Climate Change)",
                author: "Names of the signing parties " + this.getAuthorHelp(),
                published: "Date in force" + this.getDateHelp(),
                filed: "Date signed" + this.getDateHelp(),
                journal: "Name of the source that published the text of the treaty",
                journalfull: "Full name of the source (e.g. United Nations Treaty Series)"
            }
        }, {
            id: "PP_FIGURE",
            name: "Figure",
            label: "Figure",
            description: "Published graph, chart,\u2026",
            bibtex_types: [ "MISC" ],
            csl_type: "figure",
            endnote_type: [ {
                name: "CHART OR TABLE"
            }, {
                name: "EQUATION"
            }, {
                name: "FIGURE"
            } ],
            ris_type: [ {
                name: "FIGURE",
                default: true
            }, {
                name: "CHART"
            } ],
            mandatory_fields: [ "title", "author", "publisher", "url", "published", "medium", "number" ],
            excluded_fields: PP.Array.merge(a.legal, a.patent, a.pages, a.volume, a.journal, a.book, a.math, a.thesis, a.isbn, a.arxiv, a.pubmed, a.issn, a.series, [ "institution", "howpublished", "status", "editor", "filed", "associated_doi", "running_time", "scale", "ismn" ]),
            subtypes: [ {
                name: "Image"
            }, {
                name: "Graph"
            }, {
                name: "Chart"
            }, {
                name: "Drawing"
            }, {
                name: "Photography"
            } ],
            field_labels: {
                conference: "Event name",
                conference_location: "Event place",
                conference_date: "Date of the event",
                medium: "Format"
            },
            field_ris: {
                version: "ET",
                number: "M1"
            },
            field_ris_additional: {},
            field_endnote: {
                version: "%7",
                abstract: [ "%X", "%P" ],
                archive: "%E",
                archive_location: "%B",
                number: "%N",
                medium: "%V"
            },
            field_help: {
                medium: "e.g. 'Online image'",
                conference: "Event where the item was presented",
                conference_location: "Location where the event was held",
                conference_date: "Date of the event",
                title: "Figure title" + this.getTitleHelp()
            }
        }, {
            id: "PP_ARTWORK",
            name: "Artwork",
            label: "Artwork",
            description: "Painting, drawing, sculpture,\u2026",
            bibtex_types: [ "MISC" ],
            csl_type: "graphic",
            endnote_type: [ {
                name: "ARTWORK"
            } ],
            ris_type: [ {
                name: "ART",
                default: true
            } ],
            zotero_type: [ {
                name: "ARTWORK"
            } ],
            mandatory_fields: [ "title", "author", "url", "institution", "address", "published", "medium" ],
            excluded_fields: PP.Array.merge(a.legal, a.conference, a.patent, a.pubmed, a.math, a.arxiv, a.isbn, a.journal, a.book, a.issn, a.pages, a.volume, a.math, a.thesis, [ "status", "editor", "edition", "filed", "running_time", "publisher", "original_publisher", "howpublished", "series_editor", "ismn", "associated_doi" ]),
            subtypes: [ {
                name: "Painting"
            }, {
                name: "Drawing"
            }, {
                name: "Sculpture"
            }, {
                name: "Calligraphy"
            }, {
                name: "Photography"
            } ],
            field_labels: {
                author: "Artist",
                published: "Date",
                scale: "Size"
            },
            field_ris: {
                genre: "M3"
            },
            field_endnote: {
                scale: "%3"
            },
            field_zotero: {
                medium: "artworkmedium",
                scale: "artworksize"
            },
            field_csl: {
                scale: "dimensions"
            },
            field_ris_additional: {},
            field_help: {
                title: "Title of the artwork",
                institution: "The institution or individual who owns the work",
                address: "The city where the work resides",
                medium: "e.g. 'Oil on canvas'",
                scale: "Size of the artwork",
                author: "The artist(s)" + this.getAuthorHelp(),
                published: "Date the artwork was created" + this.getDateHelp()
            }
        }, {
            id: "PP_MAP",
            name: "Map",
            label: "Map",
            description: "Published map",
            bibtex_types: [ "MISC" ],
            csl_type: "map",
            endnote_type: [],
            ris_type: [ {
                name: "MAP",
                default: true
            } ],
            zotero_type: [ {
                name: "MAP"
            } ],
            mandatory_fields: [ "title", "author", "url", "scale", "publisher", "address", "published" ],
            excluded_fields: PP.Array.merge(a.series, a.legal, a.conference, a.patent, a.thesis, a.pubmed, a.journal, a.book, a.math, a.arxiv, a.pages, a.volume, a.issn, a.isbn, [ "ismn", "running_time", "medium", "institution", "status", "filed", "howpublished", "associated_doi" ]),
            subtypes: [],
            field_labels: {
                author: "Cartographer"
            },
            field_ris: {
                genre: "M3"
            },
            field_ris_additional: {},
            field_endnote: {},
            field_zotero: {
                genre: "maptype",
                series: "seriestitle"
            },
            field_help: {
                author: "The cartographer(s)" + this.getAuthorHelp()
            }
        }, {
            id: "PP_SCORE",
            name: "Musical Score",
            label: "Musical Score",
            description: "Sheet music",
            bibtex_types: [ "MISC" ],
            csl_type: "musical_score",
            ris_type: [ {
                name: "MUSIC",
                default: true
            } ],
            mandatory_fields: [ "title", "author", "number", "publisher", "address", "published", "ismn" ],
            excluded_fields: PP.Array.merge(a.legal, a.conference, a.patent, a.pubmed, a.math, a.book, a.journal, a.issn, a.isbn, a.arxiv, a.thesis, [ "institution", "status", "edition", "running_time", "scale", "medium", "pages", "howpublished", "associated_doi" ]),
            subtypes: [],
            field_labels: {
                author: "Composer",
                filed: "Composition date"
            },
            field_ris: {
                genre: "M3",
                ismn: "SN"
            },
            field_ris_additional: {},
            field_endnote: {},
            field_zotero: {},
            field_help: {
                title: "Title of the composition, e.g. 'Sonate in Es'",
                author: "The composer(s)" + this.getAuthorHelp(),
                filed: "The date of the composition" + this.getDateHelp(),
                number: "Number of composition, e.g. 'KV 216'"
            }
        }, {
            id: "PP_GRANT",
            name: "Grant",
            label: "Grant",
            description: "Grant application",
            bibtex_types: [ "MISC" ],
            subtypes: [],
            csl_type: "report",
            endnote_type: [ {
                name: "GRANT",
                default: true
            } ],
            ris_type: [ {
                name: "GRANT",
                default: true
            } ],
            field_ris: {},
            field_ris_additional: {},
            field_endnote: {
                number: "%N",
                genre: "%9",
                original_title: "%("
            },
            field_zotero: {},
            field_mendeley: {},
            field_help: {
                title: "Title of the grant" + this.getTitleHelp(),
                publisher: "The sponsoring agency the grant was submitted to",
                published: "Date when the grant was approved" + this.getDateHelp(),
                filed: "Date when the grant was submitted" + this.getDateHelp()
            },
            field_labels: {
                publisher: "Sponsoring agency",
                published: "Date granted",
                filed: "Date submitted"
            },
            mandatory_fields: [ "title", "author", "number", "publisher", "published", "num_pages" ],
            excluded_fields: PP.Array.merge(a.series, a.conference, a.patent, a.misc, a.legal, a.pubmed, a.math, a.book, a.journal, a.volume, a.thesis, a.issn, a.isbn, a.archive, a.arxiv, [ "howpublished", "version", "original_publisher", "original_address", "institution", "pages", "originally_published", "lccn", "associated_doi" ])
        }, {
            id: "PP_PERIODICAL",
            name: "Periodical",
            label: "Periodical",
            description: "Journal, Magazine, or Newspaper",
            bibtex_types: [ "MISC" ],
            subtypes: [ {
                name: "Journal"
            }, {
                name: "Magazine"
            }, {
                name: "Newspaper"
            } ],
            csl_type: "book",
            endnote_type: [],
            ris_type: [],
            field_ris: {},
            field_ris_additional: {},
            field_endnote: {},
            field_zotero: {},
            field_mendeley: {},
            field_help: {
                published: "Date or date range the periodical was published " + this.getDateHelp(),
                howpublished: "Frequency (monthly, weekly, daily)"
            },
            field_labels: {
                howpublished: "Frequency",
                genre: "Issue title"
            },
            mandatory_fields: [ "title", "editor", "publisher", [ "volume", "num_volumes" ], "issue", [ "issn", "issn_alt" ], "published" ],
            excluded_fields: PP.Array.merge(a.series, a.conference, a.patent, a.legal, a.pubmed, a.math, a.book, a.thesis, a.archive, a.arxiv, a.misc, [ "journal", "journalfull", "filed", "author", "version", "institution", "pages", "num_pages", "originally_published", "associated_doi" ])
        } ];
        var c = this.getSortOrder();
        b.sort(function(a, b) {
            return c.indexOf(a.id) - c.indexOf(b.id);
        });
        for (var d = 0; d < b.length; d++) {
            b[d].defaultSortOrder = d;
        }
        this._types = b;
        return b;
    },
    getTypeForPub: function(a) {
        var b = a.pubtype;
        var c = this.getPubTypeMap();
        var d = c[a.pubtype];
        return d;
    },
    getDummyPubForPubtype: function(a) {
        var b = {
            pubtype: a
        };
        var c = {
            doi: "10.1000/1",
            pmc: "PMC1234",
            pmid: "1234567",
            issn: "1825-411X",
            issn_alt: "1530-6984",
            isbn: "9780195122213",
            isbn_alt: "9788479195045",
            arxivid: "1211.7025",
            archivePrefix: "arXiv",
            primaryClass: "math.DS",
            pages: "12-22",
            ismn: "979-0-2306-7118-7"
        };
        var d = 2e3;
        PP.library.PublicationFields.getFieldsForPubType(a).forEach(function(e) {
            var f = e.name;
            var g = e.label;
            if (f in c) {
                g = c[f];
            } else {
                if (f == "title") {
                    g += " for " + a;
                } else if (e.dataType == "author") {
                    g = [ {
                        last: g,
                        first: "AR"
                    } ];
                } else if (e.dataType == "date") {
                    d++;
                    g = {
                        year: d,
                        month: 6,
                        day: 30
                    };
                }
            }
            b[f] = g;
        });
        PP.library.Publication.autoClean(b);
        var e = [ "incomplete", "citedByLink", "sha1", "dup_sha1", "id_list", "subfolders", "source_id", "owner_email", "owner_name", "_id", "created", "updated", "autoCleaned", "id_list", "citekey", "xref", "source" ];
        e.forEach(function(a) {
            delete b[a];
        });
        for (var f in b) {
            if (PP.Utils.isArray(b[f])) {
                b[f].forEach(function(a) {
                    if (PP.Utils.isObject(a)) {
                        delete a["_id"];
                        delete a["formatted"];
                    }
                });
            }
        }
        return b;
    },
    getInputTypeForPub: function(a, b) {
        var c = {
            pubtype: "PP_MISC",
            kind: undefined
        };
        if (b === undefined) return c;
        var d = undefined;
        this.getPubTypes().forEach(function(d) {
            var e = undefined;
            if (b == "ris") {
                e = d.ris_type;
            } else if (b == "mendeley") {
                e = d.mendeley_type;
            } else if (b == "zotero") {
                e = d.zotero_type;
            } else if (b == "endnote") {
                e = d.endnote_type;
            } else if (b == "csl") {
                e = d.csl_type;
            }
            if (PP.Utils.isArray(e)) {
                e.forEach(function(b) {
                    if (b.name) {
                        var e = true;
                        if ("import" in b) {
                            e = b["import"];
                        }
                        if (b.name == a && e) {
                            c.pubtype = d.id;
                            c.kind = b.subtype;
                        }
                    }
                });
            } else {
                if (e == a && c.pubtype == "PP_MISC") c.pubtype = d.id;
            }
        });
        return c;
    },
    getOutputTypeForPub: function(a, b) {
        if (b === undefined) {
            return undefinded;
        }
        var c = undefined;
        var d = this.getPubTypeMap();
        var e = d[a.pubtype];
        var f = undefined;
        if (b == "csl") {
            c = e.csl_type;
        } else if (b == "ris") {
            c = e.ris_type;
        }
        if (PP.Utils.isArray(c)) {
            var g;
            c.forEach(function(a) {
                if (a["default"]) {
                    g = a.name;
                }
            });
            if (a.kind) {
                c.forEach(function(b) {
                    var c = true;
                    if ("output" in b) {
                        c = b.output;
                    }
                    if (c) {
                        if (b.subtype == a.kind) {
                            f = b.name;
                        }
                    }
                });
            }
            if (f === undefined) {
                f = g;
            }
        } else {
            f = c;
        }
        return f;
    },
    getLabel: function(a) {
        var b = this.getTypeForPub(a);
        if (!b) {
            return "BAD PUBTYPE: " + a.pubtype;
        } else {
            if (b.labelFn) {
                return b.labelFn.call(null, a);
            } else {
                return b.label;
            }
        }
    },
    getFullLabel: function(a) {
        var b = this.getTypeForPub(a);
        if (!b) {
            return "BAD PUBTYPE: " + a.pubtype;
        } else {
            var c = b.label;
            if (a.kind) {
                c = c + " / " + a.kind;
            }
            return c;
        }
    }
});

PP.library.PublicationTypes = new PP.library._PublicationTypes();

PP.library._PublicationFields = PP.Class.extend({
    decorate: function(a, b) {
        for (var c = 0; c < a.length; c++) {
            if (b) {
                PP.Utils.applyIf(a[c], b);
            }
        }
        return a;
    },
    generalFields: function() {
        return this.decorate([ {
            name: "pubtype",
            label: "Publication Type",
            bibtex_persist: false
        }, {
            name: "title",
            label: "Title",
            csl: "title",
            ris: "TI",
            zotero: "title",
            mendeley: "title",
            endnote: "%T"
        }, {
            name: "original_title",
            label: "Original title",
            help: "Title of the original item, e.g. for translated books",
            csl: "original-title",
            bibtex_support: false,
            endnote: "%O"
        }, {
            name: "titleshort",
            label: "Short title",
            help: "Short version of the title",
            csl: "shortTitle",
            zotero: "shorttitle",
            mendeley: "short_title",
            bibtex_support: false,
            endnote: "%!"
        }, {
            name: "status",
            label: "Status",
            help: "Publication status, such as 'in preparation', 'submitted', 'in revision', 'in press'",
            bibtex_support: true,
            bibtex_name: "note",
            csl: "status"
        }, {
            name: "abstract",
            label: "Abstract",
            csl: "abstract",
            ris: "AB",
            zotero: "abstractnote",
            mendeley: "abstract",
            endnote: "%X"
        }, {
            name: "keywords",
            label: "Keywords",
            ris: "KW",
            help: "Index terms added by the authors",
            mendeley: "keywords",
            csl: "keyword",
            endnote: "%K"
        }, {
            name: "note",
            label: "Notes",
            bibtex_name: "annote",
            csl: "annote",
            hideFromEditWindow: 1,
            ris: "N1",
            endnote: "%Z"
        }, {
            name: "copyright",
            label: "Copyright",
            help: "Copyright statement for the content"
        }, {
            name: "affiliation",
            label: "Affiliation",
            ris: "AD",
            help: "The organization the authors are affilated with, typically a university, research institute or company",
            endnote: "%+"
        }, {
            name: "language",
            defaultWidth: "67%",
            label: "Language",
            help: "Language of the item as two letter ISO-code (e.g., en, de, fr, es, it). To avoid automatic title casing for Non-English citations set this field to another language.",
            csl: "language",
            ris: "LA",
            zotero: "language",
            mendeley: "language",
            endnote: "%G"
        }, {
            name: "kind",
            defaultWidth: "67%",
            label: "Sub-type",
            hideFromEditWindow: 1,
            bibtex_support: false,
            mendeley: "source_type",
            endnote: "%9"
        }, {
            name: "booktitle",
            label: "Book title",
            help: "The title of the book that this item appears in",
            csl: "container-title",
            zotero: "booktitle",
            endnote: "%B"
        }, {
            name: "series",
            label: "Series",
            help: "The series the book was published in <br>'Lecture Notes in Computer Science'",
            csl: "collection-title",
            zotero: "series",
            mendeley: "series",
            endnote: "%S"
        }, {
            name: "series_number",
            defaultWidth: "67%",
            label: "Series number",
            help: "Number of the series the book was published in",
            bibtex_support: false,
            csl: "collection-number",
            zotero: "seriesnumber"
        }, {
            name: "journal",
            label: "Journal",
            defaultWidth: "67%",
            help: "Title of the journal in its standardized abbreviation if available",
            csl: "container-title",
            ris: "T2",
            zotero: "journalabbreviation",
            mendeley: "source",
            endnote: "%J"
        }, {
            name: "journalfull",
            label: "Full journal",
            bibtex_persist: false,
            help: "Full title of the journal",
            zotero: "publicationtitle"
        }, {
            name: "chapter",
            label: "Chapter",
            defaultWidth: "67%",
            help: "The chapter number",
            csl: "chapter-number",
            mendeley: "chapter"
        }, {
            name: "volume",
            label: "Volume",
            defaultWidth: "67%",
            help: "The volume number",
            csl: "volume",
            ris: "VL",
            zotero: "volume",
            mendeley: "volume",
            endnote: "%V"
        }, {
            name: "number",
            defaultWidth: "33%",
            label: "Number",
            csl: "number",
            mendeley: "revision"
        }, {
            name: "issue",
            label: "Issue",
            defaultWidth: "33%",
            help: "The issue number",
            bibtex_name: "number",
            csl: "issue",
            ris: "IS",
            zotero: "issue",
            mendeley: "issue",
            endnote: "%N"
        }, {
            name: "edition",
            label: "Edition",
            help: "The book edition <p>('first' or 'second')</p>",
            csl: "edition",
            ris: "ET",
            zotero: "edition",
            mendeley: "edition",
            endnote: "%7"
        }, {
            name: "pages",
            label: "Pages",
            defaultWidth: "33%",
            help: "<p>The range or starting page, e.g. <p>'210-213' or '210'</p><p>The article number of an electronic article, e.g. e10233</p>",
            csl: "page",
            zotero: "pages",
            mendeley: "pages",
            endnote: "%P"
        }, {
            name: "url",
            label: "URLs",
            defaultValue: [],
            help: "A list of URLs where this item can be accessed online (one per line)",
            bibtex_name: "url",
            dataType: "array",
            csl: "URL",
            ris: "UR",
            zotero: "url",
            mendeley: "websites",
            endnote: "%U"
        }, {
            name: "howpublished",
            label: "How published",
            help: "How it was published, if the publishing method is nonstandard"
        }, {
            name: "publisher",
            label: "Publisher",
            defaultWidth: "67%",
            help: "The publisher's name <p>'MIT Press'</p>",
            csl: "publisher",
            ris: "PB",
            zotero: "publisher",
            mendeley: "publisher",
            endnote: "%I"
        }, {
            name: "original_publisher",
            label: "Original publisher",
            defaultWidth: "67%",
            help: "The original publisher's name, for items that have been republished by a different publisher",
            csl: "original-publisher",
            bibtex_support: false
        }, {
            name: "institution",
            label: "Institution",
            help: "The institution that was involved in the publishing, but not necessarily the publisher",
            csl: "publisher",
            zotero: "institution",
            mendeley: "institution"
        }, {
            name: "school",
            label: "School",
            help: "The degree-awarding institution <p>'University of Cambridge'</p>",
            csl: "publisher",
            zotero: "university"
        }, {
            name: "department",
            label: "Department",
            help: "The department at the university where the degree was awarded <p>'Computer Science'</p>",
            mendeley: "department",
            csl: "department",
            bibtex_support: false
        }, {
            name: "address",
            label: "Address",
            help: "The publisher's address (usually just the city) <p>'Cambridge'</p>",
            csl: "publisher-place",
            ris: "CY",
            zotero: "place",
            mendeley: "city",
            endnote: "%C"
        }, {
            name: "original_address",
            label: "Original address",
            help: "The original publisher's address (usually just the city) <p>'Cambridge'</p>",
            csl: "original-publisher-place",
            bibtex_support: false
        }, {
            name: "version",
            label: "Version",
            help: "The software or device version <p>'2.1.0'</p>",
            bibtex_support: false,
            csl: "version",
            zotero: "version"
        }, {
            name: "scale",
            label: "Scale",
            help: "The scale of a map e.g. 1:50.000",
            bibtex_support: false,
            csl: "scale",
            zotero: "scale",
            ris: "C1"
        }, {
            name: "conference",
            label: "Conference",
            help: "The name of the conference where this work was presented <p>'Biology of Genomes'</p>",
            csl: "event",
            zotero: "conferencename"
        }, {
            name: "conference_location",
            label: "Conference location",
            help: "Location where the conference was held",
            csl: "event-place",
            bibtex_support: false
        }, {
            name: "issuing_authority",
            label: "Issuing authority",
            help: "The patent issuing authority (e.g. US, Japan, Germany, EC)",
            bibtex_support: false,
            csl: "authority",
            zotero: "issuingauthority"
        }, {
            name: "patent_publication_type",
            label: "Patent publication type",
            help: "The type of patent publication (e.g., 'patent' or 'application')",
            bibtex_support: false
        }, {
            name: "application_number",
            label: "Application number",
            help: "The number assigned to the initial patent application (e.g., '09/458811')",
            bibtex_support: false,
            csl: "call-number",
            ris: "M1",
            zotero: "applicationnumber",
            mendeley: "patent_application_number",
            endnote: "%N"
        }, {
            name: "class",
            label: "Class",
            help: "The category / class of the invention (within the issuing authority's classification system)",
            bibtex_support: false
        }, {
            name: "international_class",
            label: "International class",
            help: "The category / class of the invention within the International Patent Classification (IPC) scheme",
            bibtex_support: false
        }, {
            name: "search_class",
            label: "Field of search",
            help: "An extended list of classes covering the invention categories relevant to this patent",
            bibtex_support: false
        }, {
            name: "states",
            label: "Designated states",
            help: "A list of states specified by the inventor when filed with WIPO or EPO",
            bibtex_support: false,
            zotero: "country"
        }, {
            name: "priority_numbers",
            label: "Priority numbers",
            help: "A list of patent application numbers for which priority is claimed",
            csl: "issue",
            zotero: "prioritynumbers",
            bibtex_support: false
        }, {
            name: "patent_number",
            label: "Patent number",
            help: "The patent number without the preceding country / authority code (e.g., '3990438' NOT 'US3990438')",
            bibtex_name: "number",
            csl: "number",
            ris: "SN",
            zotero: "patentnumber"
        }, {
            name: "assignee",
            label: "Assignee",
            help: "The individual or organization to which the patent was assigned",
            bibtex_support: false,
            zotero: "assignee",
            mendeley: "patent_owner"
        }, {
            name: "foreign_patents",
            label: "Foreign references",
            help: "A list of patent numbers for any associated foreign patents",
            bibtex_support: false
        }, {
            name: "call_number",
            label: "Call number",
            help: "Location in the library where the item can be found",
            bibtex_support: false,
            csl: "call-number",
            zotero: "callnumber",
            endnote: "%L"
        }, {
            name: "num_pages",
            label: "Page count",
            help: "The total number of pages in the book",
            bibtex_support: false,
            csl: "number-of-pages",
            zotero: "numpages",
            endnote: "%&"
        }, {
            name: "num_volumes",
            label: "Volume count",
            help: "The total number of volumes in the book series",
            bibtex_support: false,
            csl: "number-of-volumes",
            ris: "NV",
            zotero: "numberofvolumes",
            endnote: "%6"
        }, {
            name: "archivePrefix",
            label: "Archive prefix",
            help: "Name of the preprint archive<p>arXiv, bioRxiv</p>",
            csl: "archive",
            zotero: "archive"
        }, {
            name: "archive",
            label: "Archive",
            help: "Name of the archive where this document can be found<p>American Heritage Center</p>",
            csl: "archive",
            zotero: "archive",
            bibtex_support: false
        }, {
            name: "archive_location",
            label: "Archive location",
            help: "Storage location within an archive (e.g. a box and folder number)",
            csl: "archive_location",
            zotero: "archivelocation",
            bibtex_support: false
        }, {
            name: "archive_place",
            label: "Archive place",
            help: "Geographic location of the archive<p>West Lafayette, Indiana</p>",
            csl: "archive-place",
            bibtex_support: false
        }, {
            name: "eprint",
            label: "Eprint ID",
            help: "Identifier for the e-print article (e.g. 0707.3168)"
        }, {
            name: "primaryClass",
            label: "Primary class",
            help: "Primary arXiv category (e.g. hep-th)"
        }, {
            name: "running_time",
            label: "Running time",
            help: "Running time e.g. 142 min",
            bibtex_support: false,
            csl: "dimensions",
            zotero: "runningtime",
            endnote: "%runningtime"
        }, {
            name: "medium",
            label: "Medium",
            help: "Medium of the media type (e.g. CD, DVD, VHS)",
            bibtex_support: false,
            csl: "medium",
            mendeley: "medium",
            endnote: "%#"
        }, {
            name: "genre",
            label: "Custom sub-type",
            help: "Class, type or genre of the item",
            bibtex_support: false,
            csl: "genre",
            mendeley: "genre"
        }, {
            name: "jurisdiction",
            label: "Jurisdiction",
            help: "Jurisdiction (e.g. United States, United Kingdom)",
            bibtex_support: false,
            csl: "jurisdiction"
        }, {
            name: "court",
            label: "Court",
            help: "Court (e.g. Supreme Court or Court of Appeals)",
            bibtex_support: false,
            csl: "authority",
            zotero: "court"
        }, {
            name: "history",
            label: "History",
            help: "Legal history: this explains what happened to the case on appeal to a higher appellate court",
            bibtex_support: false,
            csl: "references",
            zotero: "history"
        }, {
            name: "section",
            label: "Section",
            help: "Section number of the statute or bill",
            bibtex_support: false,
            csl: "section",
            zotero: "section"
        }, {
            name: "session",
            label: "Session",
            help: "Session of the Congress",
            bibtex_support: false,
            zotero: "session",
            csl: "chapter-number"
        }, {
            name: "legislative_body",
            label: "Legislative Body",
            help: "Legislative body who made, amended or repealed the bill (e.g. Senate)",
            bibtex_support: false,
            zotero: "legislativebody",
            csl: "authority"
        } ], {
            fieldType: "general",
            defaultValue: undefined
        });
    },
    identifierFields: function() {
        return this.decorate([ {
            name: "user_citekey",
            label: "BibTeX key",
            help: "Citation key for use with LaTeX/BibTeX. If not set Paperpile will assign a key automatically. If you set this field make sure it is unique in your library."
        }, {
            name: "issn",
            label: "ISSN",
            defaultWidth: "67%",
            help: "An identifier for periodicals (journals, magazines)",
            csl: "ISSN",
            zotero: "issn",
            mendeley: "identifiers.issn"
        }, {
            name: "issn_alt",
            label: "ISSN (alt.)",
            defaultWidth: "67%",
            help: "A secondary or alternate ISSN (e.g. online version of the journal)",
            bibtex_name: "issn"
        }, {
            name: "isbn",
            label: "ISBN",
            defaultWidth: "67%",
            help: "An international identifier for books",
            csl: "ISBN",
            zotero: "isbn",
            mendeley: "identifiers.isbn",
            endnote: "%@"
        }, {
            name: "isbn_alt",
            label: "ISBN (alt.)",
            defaultWidth: "67%",
            help: "A secondary or alternate ISBN (e.g. electronic or re-issued version)",
            bibtex_name: "isbn"
        }, {
            name: "ismn",
            label: "ISMN",
            defaultWidth: "67%",
            help: "An international identifier for notated music",
            bibtex_support: false
        }, {
            name: "pmid",
            label: "PMID",
            defaultWidth: "67%",
            help: "An identifier for articles in the PubMed database",
            csl: "PMID",
            mendeley: "identifiers.pmid"
        }, {
            name: "lccn",
            label: "LCCN",
            defaultWidth: "67%",
            help: "An identifier for books published in the United States, managed by the Library of Congress"
        }, {
            name: "mr",
            label: "MR Number",
            defaultWidth: "67%",
            help: "An identifier to locate a specific record in the Mathematical Reviews (MR) database",
            bibtex_name: "mrnumber"
        }, {
            name: "zbl",
            label: "Zbl Number",
            defaultWidth: "67%",
            help: "An identifier to locate a specific record in the Zentralblatt MATH database",
            bibtex_name: "zbl"
        }, {
            name: "arxivid",
            label: "Arxiv ID",
            defaultWidth: "67%",
            help: "An identifier for e-print articles published on arXiv.org",
            mendeley: "identifiers.arxiv"
        }, {
            name: "doi",
            label: "DOI",
            defaultWidth: "67%",
            help: "A generic identifier for digital objects. Most journal articles have a unique DOI assigned on publication.",
            csl: "DOI",
            ris: "DO",
            zotero: "doi",
            mendeley: "identifiers.doi",
            endnote: "%R"
        }, {
            name: "associated_doi",
            label: "Associated DOI",
            defaultWidth: "67%",
            help: "One or more DOIs for the item with which this entry is associated."
        }, {
            name: "pmc",
            label: "PMC ID",
            defaultWidth: "67%",
            help: "An identifier for articles deposited in the PubMed Central open access repository",
            csl: "PMCID",
            endnote: "%]"
        } ], {
            fieldType: "identifier",
            defaultValue: undefined
        });
    },
    dateFields: function() {
        return this.decorate([ {
            name: "published",
            label: "Date published",
            shortLabel: "Published",
            help: "Date when the item was published <p>'2002' <i>or</i> 'June 2002' <i>or</i> 'June 24, 2002' <br/> <i>or free-form date in braces<i><br> '{May-June 1876}'</p>",
            csl: "issued",
            ris: "DA",
            zotero: "date",
            endnote: "%8"
        }, {
            name: "accessed",
            label: "Date accessed",
            shortLabel: "Accessed",
            help: "Date when the item was accessed <p>'May 1, 2012'</p>",
            csl: "accessed",
            ris: "Y2",
            zotero: "accessdate",
            endnote: "%["
        }, {
            name: "filed",
            label: "Date filed",
            shortLabel: "Filed",
            help: "Date when the patent was filed",
            csl: "submitted",
            ris: "C2",
            zotero: "filingdate"
        }, {
            name: "originally_published",
            label: "Date of the original publication",
            shortLabel: "Originally published",
            help: "Date when the item was originally published <p>'2002' <br/> 'June 2002' <br/> 'June 24, 2002' <br/> '{May-June 1876}'</p>",
            csl: "original-date",
            bibtex_support: false
        }, {
            name: "conference_date",
            label: "Conference date",
            shortLabel: "Conference date",
            help: "Date when the conference was held",
            csl: "event-date"
        } ], {
            fieldType: "date",
            dataType: "date",
            defaultValue: undefined
        });
    },
    libraryFields: function() {
        return this.decorate([ {
            name: "imported",
            type: "int",
            defaultValue: 0,
            note: "Either 0 (if the pub hasn't been stored in the DB yet) or 1 (if it has been)"
        }, {
            name: "_id",
            label: "GUID",
            note: "Paperpile GUID for this reference.",
            bibtex_name: "pp_guid",
            export_persist: true,
            csl: "id"
        }, {
            name: "original_id",
            label: "Source ID",
            note: "GUID of the original item from which this item was copied.",
            export_persist: true
        }, {
            name: "owner",
            label: "Owner",
            note: "Paperpile user who owns this reference",
            export_persist: true
        }, {
            name: "id_list",
            label: "ID list",
            dataType: "array",
            note: "Internal array of unique IDs (i.e. doi, pmid, patent_number, etc.)"
        }, {
            name: "_keywords",
            label: "Keywords",
            dataType: "array",
            note: "Internal array of keywords for indexing",
            persist: false,
            endnote: "%K"
        }, {
            name: "collection_timestamps",
            label: "Collection Timestamps",
            defaultValue: {},
            note: "A hash of collection IDs and timestamps, tracking when this item was added to each collection.",
            dataType: "object"
        }, {
            name: "sha1",
            label: "Sha1 hash",
            note: "A sha1 hash of the main contents of the reference."
        }, {
            name: "dup_sha1",
            label: "Sha1 hash (Duplicates)",
            note: "A simpler sha1 hash, for detecting duplicate references."
        }, {
            name: "duplicates",
            label: "Duplicates",
            note: "A list of the IDs of any duplicate publications in the library.",
            dataType: "array"
        }, {
            name: "ignore_duplicates",
            label: "Ignored Duplicates",
            note: "A list of publications that have been manually flagged as NOT duplicates of this item.",
            dataType: "array"
        }, {
            name: "created",
            label: "Created",
            note: "A Unix timestamp, storing the date and time that this reference was created in our database",
            dataType: "date",
            showInExpandedView: true
        }, {
            name: "updated",
            label: "Last modified",
            note: "A Unix timestamp, storing the date and time that this reference was last modified",
            dataType: "date",
            showInExpandedView: true
        }, {
            name: "trashed",
            label: "Trashed",
            note: "Either 0 or 1, indicating whether or not the pub is currently trashed"
        }, {
            name: "starred",
            label: "Starred",
            note: "Either 0 or 1, indicating whether or not the pub is currently starred"
        }, {
            name: "labels",
            label: "Labels",
            defaultValue: [],
            note: "An array of collection GUIDs corresponding to the assigned labels",
            dataType: "array"
        }, {
            name: "folders",
            label: "Folders",
            defaultValue: [],
            note: "An array of collection GUIDs corresponding to the assigned folders",
            dataType: "array"
        }, {
            name: "shared_folders",
            label: "Shared Folders",
            defaultValue: [],
            note: "An array of collection GUIDs corresponding to the assigned shared folders",
            dataType: "array"
        }, {
            name: "crawl_urls",
            label: "URLs",
            defaultValue: [],
            help: "An internal array of ALL the URLs that were encountered during crawling.",
            dataType: "array"
        }, {
            name: "webimport_sha1s",
            label: "Webimport sha1s",
            defaultValue: [],
            help: "An internal array of webimport Sha1s (for identifying webimport pubs)",
            dataType: "array"
        }, {
            name: "attachments",
            label: "Attachments",
            defaultValue: [],
            help: "An internal array of file attachment objects.",
            dataType: "array",
            bibtex_name: "file",
            export_persist: true
        }, {
            name: "xref",
            label: "Associated items",
            help: "An internal array of objects containing data about associated items.",
            dataType: "array"
        }, {
            name: "pdf",
            label: "PDF file ID",
            help: "An internal PDF file ID"
        }, {
            name: "source",
            label: "Data source",
            defaultValue: {},
            help: "Information about the source of this article's metadata.",
            dataType: "object"
        }, {
            name: "masid",
            label: "Microsoft Academic Search ID",
            defaultWidth: "67%",
            help: "The ID for this article within Microsoft Academic Search (unstable)"
        }, {
            name: "mendeleyid",
            label: "Mendeley UUID",
            help: "The canonical Mendeley ID for this article"
        }, {
            name: "scopusid",
            label: "Scopus ID",
            help: "The scopus ID for this article"
        }, {
            name: "gs_related_articles",
            label: 'Link to Google Scholar "related articles"'
        }, {
            name: "gs_all_versions",
            label: 'Link to Google Scholar "all versions"'
        }, {
            name: "gs_cluster_id",
            label: 'Google Scholar "cluster" ID'
        }, {
            name: "gs_cited_by_count",
            label: "Google Scholar cited by count"
        }, {
            name: "pubmed_cited_by_count",
            label: "PubMed / PMC cited by count"
        }, {
            name: "gs_cited_by_link",
            label: 'Link to Google Scholar "cited by"'
        }, {
            name: "gs_bibtex",
            label: 'Link to Google Scholar "details" bibtex link'
        }, {
            name: "citedByLink",
            label: '"Cited by" link',
            help: "URL of a page listing articles that cite this article"
        }, {
            name: "referencesLink",
            label: "References link",
            help: "URL of a page where the article's references can be found"
        }, {
            name: "external_pdf_filename",
            label: "External PDF Filename",
            help: "The PDF filename found during RIS import"
        }, {
            name: "subfolders",
            label: "Subfolder",
            defaultValue: [],
            note: "List of subfolders this article should be stored in Google Drive.",
            dataType: "array"
        }, {
            name: "count_index",
            label: "Count Index",
            defaultValue: [],
            note: "List of keywords used for collecting faceted counts.",
            dataType: "array"
        }, {
            name: "citekey",
            label: "Citation key",
            export_persists: true,
            help: "Citation key for use with LaTeX/BibTeX. If you change it, make sure the key remains unique in your library."
        }, {
            name: "autocompleted",
            label: "Autocompleted",
            note: "Whether the article was autocompleted or not"
        }, {
            name: "locked_citation",
            label: "Locked citation",
            note: 'Flags items in the "Citations" database as modified externally so they are not ovewritten by changes in the original from "Library"'
        }, {
            name: "journal_checked",
            label: "Journal checked",
            note: "Whether the article has had its journal checked against our db or not"
        }, {
            name: "force_complete",
            label: "Force Complete",
            note: "Flag to force the data to NOT be considered incomplete."
        }, {
            name: "incomplete",
            label: "Incomplete",
            note: '1 if the article has "incomplete" data, i.e. missing crucial information for the given pubtype. 0 otherwise.'
        }, {
            name: "pdf_restricted",
            label: "PDF restricted",
            note: "1 if the article hit a paywall when downloading an article PDF."
        }, {
            name: "original_citekey",
            label: "Original BibTeX key",
            help: "Original key (if any) loaded via BibTeX import."
        } ], {
            fieldType: "library",
            defaultValue: undefined,
            export_persist: false
        });
    },
    authorFields: function() {
        var a = ", separated by semicolons <p><i>Last, First Middle</i> <p>e.g. Knuth, Donald E; Moore, Ronald W</p><p><i>Collective names in braces</i><p>e.g. {1000 Genomes Consortium}</p>";
        return this.decorate([ {
            name: "author",
            label: "Authors",
            help: "The author(s)" + a,
            csl: "author",
            ris: "AU",
            mendeley: "authors",
            endnote: "%A"
        }, {
            name: "editor",
            label: "Editors",
            help: "The editor(s)" + a,
            csl: "editor",
            mendeley: "editors",
            endnote: "%E"
        }, {
            name: "series_editor",
            label: "Series editors",
            help: "The series editor(s)" + a,
            csl: "collection-editor",
            mendeley: "series_editor",
            bibtex_support: false
        }, {
            name: "contributor",
            label: "Contributors",
            help: "Additional contributor(s)" + a,
            bibtex_support: false,
            endnote: "%Y"
        }, {
            name: "translator",
            label: "Translators",
            help: "The translator(s) " + a,
            csl: "translator",
            mendeley: "translators",
            bibtex_support: false,
            endnote: "%?"
        } ], {
            fieldType: "author",
            dataType: "author",
            defaultValue: undefined
        });
    },
    temporaryFields: function() {
        return this.decorate([ {
            name: "view_expanded",
            type: "int",
            defaultValue: 0
        }, {
            name: "view_state"
        }, {
            name: "editing_note",
            type: "int",
            defaultValue: 0
        }, {
            name: "view_context_open",
            type: "int",
            defaultValue: 0
        }, {
            name: "dup_group",
            type: "int",
            note: "The current duplicate group, if the view is showing duplicate articles",
            defaultValue: 0
        }, {
            name: "dup_group_first",
            type: "int",
            note: "1 if the current article is first in its group, 0 otherwise",
            defaultValue: 0
        }, {
            name: "dup_group_last",
            type: "int",
            note: "1 if the current article is last in its group, 0 otherwise",
            defaultValue: 0
        }, {
            name: "_imported",
            type: "int",
            defaultValue: 0,
            note: "0 or 1, used to indicate whether an equivalent pub exists in the user's personal library when viewing a shared folder."
        }, {
            name: "_imported_id",
            type: "string",
            defaultValue: "",
            note: "the _id of the equivalent item from the user's library."
        }, {
            name: "_owner_google_email",
            type: "string",
            defaultValue: "",
            note: "Email of the user who owns this item"
        }, {
            name: "_owner_google_name",
            type: "string",
            defaultValue: "",
            note: "Full name of the user who owns this item"
        }, {
            name: "pdf_crawl_status"
        } ], {
            fieldType: "temporary",
            defaultValue: undefined,
            persist: false,
            export_persist: false
        });
    },
    citationFields: function() {
        return this.decorate([ {
            name: "cite_alias",
            label: "Cite Alias",
            ris: "LB"
        }, {
            name: "source_id",
            label: "Source ID"
        }, {
            name: "owner_email",
            label: "Owner's email"
        }, {
            name: "owner_name",
            label: "Owner's name"
        } ], {
            fieldType: "citation",
            persist: false,
            export_persist: false
        });
    },
    getField: function(a) {
        var b = this.getFieldsMap();
        if (b[a]) {
            return b[a];
        } else {
            return null;
        }
    },
    getFieldType: function(a) {
        var b = this.getFieldsMap();
        if (b[a]) {
            return b[a].fieldType;
        }
        return null;
    },
    getDataType: function(a) {
        var b = this.getFieldsMap();
        if (b[a]) {
            return b[a].dataType;
        }
        return null;
    },
    isFieldMandatory: function(a, b) {
        var c = PP.library.PublicationTypes.getPubType(b);
        var d = c.mandatory_fields || [];
        d = PP.Array.flatten(d);
        d = PP.Array.unique(d);
        if (PP.Array.contains(d, a)) {
            return true;
        }
        return false;
    },
    getInputMapForPubType: function(a, b) {
        var c = PP.library.PublicationTypes.getPubType(a);
        var d = [ "ris", "zotero", "mendeley", "endnote", "csl" ];
        var e = {};
        if (d.indexOf(b) == -1) {
            return e;
        }
        this.getFieldsForPubType(a).forEach(function(a) {
            if (b in a) {
                if (b == "ris") {
                    e[a.ris] = a.name;
                }
                if (b == "zotero") {
                    e[a.zotero] = a.name;
                }
                if (b == "mendeley") {
                    e[a.mendeley] = a.name;
                }
                if (b == "csl") {
                    e[a.csl] = a.name;
                }
                if (b == "endnote") {
                    if (PP.Utils.isArray(a.endnote)) {
                        a.endnote.forEach(function(b) {
                            e[b] = a.name;
                        });
                    } else {
                        e[a.endnote] = a.name;
                    }
                }
            }
        });
        if (b == "ris") {
            if (c.field_ris_additional) {
                for (var f in c.field_ris_additional) {
                    e[f] = c.field_ris_additional[f];
                }
            }
            e["PY"] = "published";
            e["Y1"] = "published";
            e["DA"] = "published";
            e["PG"] = "pages";
            e["A1"] = "author";
            e["T1"] = "title";
            e["ID"] = "doi";
            e["DOI"] = "doi";
            e["L3"] = "doi";
            e["N2"] = "abstract";
            e["L1"] = "url";
            e["L2"] = "url";
            e["L4"] = "url";
            e["RN"] = "note";
            e["U2"] = "pmid";
            e["IB"] = "isbn";
        } else if (b == "zotero") {
            if (c.field_zotero_additional) {
                for (var f in c.field_zotero_additional) {
                    e[f] = c.field_zotero_additional[f];
                }
            }
            e["creators"] = "creators";
            e["tags"] = "zotero_tags";
        } else if (b == "mendeley") {
            e["id"] = "source.mendeley_id";
            e["day"] = "published.day";
            e["month"] = "published.month";
            e["year"] = "published.year";
        } else if (b == "csl") {
            e["note"] = "annote";
        } else if (b == "endnote") {
            e["%\xc4"] = "url";
            e["%\xcb"] = "journal";
        }
        return e;
    },
    getOutputMapForPubType: function(a, b, c) {
        var d = c || {};
        var e = PP.library.PublicationTypes.getPubType(a);
        var f = [ "csl", "ris" ];
        var g = {};
        if (f.indexOf(b) == -1) {
            return g;
        }
        var h = {};
        if (b == "csl") {
            var i = e.csl_excluded_fields || [];
            i.forEach(function(a) {
                var b = true;
                if ("csl_excluded_fields" in d) {
                    if (d.csl_excluded_fields.indexOf(a) == -1) {
                        b = false;
                    }
                }
                if (b) {
                    h[a] = 1;
                }
            });
            g["_id"] = "id";
        }
        this.getFieldsForPubType(a).forEach(function(a) {
            if (b in a) {
                if (!h[a.name]) {
                    if (b == "csl") {
                        g[a.name] = a.csl;
                    } else if (b == "ris") {
                        g[a.ris] = a.name;
                    }
                }
            }
        });
        return g;
    },
    getFieldsForPubType: function(a, b) {
        var c = b || {};
        if (!("includeAll" in c)) {
            c.includeAll = false;
        }
        var d = PP.library.PublicationTypes.getPubType(a);
        var e = d.excluded_fields || [];
        var f = d.field_labels || {};
        var g = d.field_shortlabels || {};
        var h = d.field_help || {};
        var i = d.field_csl || {};
        var j = d.field_ris || {};
        var k = d.field_zotero || {};
        var l = d.field_mendeley || {};
        var m = d.field_endnote || {};
        var n = d.mandatory_fields || [];
        n = PP.Array.flatten(n);
        n = PP.Array.filter(n, function(a) {
            if (!a) {
                return false;
            } else {
                return true;
            }
        });
        n = PP.Array.map(n, function(a) {
            return a.replace(/:\d/, "");
        });
        var o = PP.Array.map(n, function(a) {
            var b = PP.library.PublicationFields.getField(a);
            b.mandatory = true;
            return b;
        });
        var p = PP.Utils.clone(this.getFields());
        p = PP.Array.filter(p, function(a) {
            if (a.fieldType === "temporary" || a.fieldType === "library" && !a.showInExpandedView || a.name === "pubtype") {
                if (c.includeAll) {
                    return true;
                } else {
                    return false;
                }
            } else if (PP.Array.contains(e, a.name) || PP.Array.contains(n, a.name)) {
                return false;
            } else {
                return true;
            }
        });
        p = PP.Array.map(p, function(a) {
            a.mandatory = false;
            return a;
        });
        p = o.concat(p);
        var q = {};
        for (var r in m) {
            if (PP.Utils.isArray(m[r])) {
                m[r].forEach(function(a) {
                    q["endnote:" + a] = 1;
                });
            } else {
                q["endnote:" + m[r]] = 1;
            }
        }
        for (var r in j) {
            q["ris:" + j[r]] = 1;
        }
        for (var s = 0; s < p.length; s++) {
            var t = PP.Utils.clone(p[s]);
            var u = t.name;
            if (t.endnote) {
                if ("endnote:" + t.endnote in q) delete t.endnote;
            }
            if (t.ris) {
                if ("ris:" + t.ris in q) delete t.ris;
            }
            if (f[u]) {
                t.label = f[u];
            }
            if (g[u]) {
                t.shortLabel = g[u];
            }
            if (h[u]) {
                t.help = h[u];
            }
            if (i[u]) {
                t.csl = i[u];
            }
            if (u in j) {
                if (j[u] === null) {
                    delete t.ris;
                } else {
                    t.ris = j[u];
                }
            }
            if (k[u]) {
                t.zotero = k[u];
            }
            if (l[u]) {
                t.mendeley = l[u];
            }
            if (u in m) {
                if (m[u] === null) {
                    delete t.endnote;
                } else {
                    t.endnote = m[u];
                }
            }
            p[s] = t;
        }
        return p;
    },
    getFieldHelp: function(a, b) {
        var c = PP.library.PublicationTypes.getPubType(b);
        var d = c.field_help || {};
        if (d[a]) {
            return d[a];
        } else {
            var e = this.getFieldsMap();
            var f = e[a];
            if (f) {
                return f.help || "";
            }
        }
        return null;
    },
    getFieldLabel: function(a, b) {
        var c = PP.library.PublicationTypes.getPubType(b);
        var d = c.field_labels || {};
        if (a == "title") {}
        if (d[a]) {
            return d[a];
        } else {
            var e = this.getFieldsMap();
            var f = e[a];
            if (f) {
                return f.label;
            }
        }
        return null;
    },
    getFieldsMap: function() {
        if (this._fieldsMap) {
            return this._fieldsMap;
        }
        var a = this.getFields();
        var b = {};
        a.forEach(function(a) {
            b[a.name] = a;
        });
        this._fieldsMap = b;
        return this._fieldsMap;
    },
    getFields: function() {
        if (this._fields) {
            return this._fields;
        }
        var a = this.generalFields();
        var b = this.authorFields();
        var c = this.dateFields();
        var d = this.identifierFields();
        var e = this.libraryFields();
        var f = this.temporaryFields();
        var g = this.citationFields();
        this._fields = a.concat(b, c, d, e, f, g);
        for (var h = 0; h < this._fields.length; h++) {
            this._fields[h].defaultSortOrder = h;
        }
        return this._fields;
    },
    getDateFieldNames: function() {
        var a = [];
        this.dateFields().forEach(function(b) {
            a.push(b.name);
        });
        return a;
    },
    getAuthorFieldNames: function() {
        var a = [];
        this.authorFields().forEach(function(b) {
            a.push(b.name);
        });
        return a;
    }
});

PP.library.PublicationFields = new PP.library._PublicationFields();

(function() {
    var a = 0;
    var b = "";
    var c = 8;
    function d(a) {
        return s(k(q(a), a.length * c));
    }
    function e(a) {
        return t(k(q(a), a.length * c));
    }
    function f(a) {
        return r(k(q(a), a.length * c));
    }
    function g(a, b) {
        return s(n(a, b));
    }
    function h(a, b) {
        return t(n(a, b));
    }
    function i(a, b) {
        return r(n(a, b));
    }
    function j() {
        return d("abc") === "a9993e364706816aba3e25717850c26c9cd0d89d";
    }
    function k(a, b) {
        a[b >> 5] |= 128 << 24 - b % 32;
        a[(b + 64 >> 9 << 4) + 15] = b;
        var c = new Array(80);
        var d = 1732584193;
        var e = -271733879;
        var f = -1732584194;
        var g = 271733878;
        var h = -1009589776;
        for (var i = 0; i < a.length; i += 16) {
            var j = d;
            var k = e;
            var n = f;
            var q = g;
            var r = h;
            for (var s = 0; s < 80; s++) {
                if (s < 16) {
                    c[s] = a[i + s];
                } else {
                    c[s] = p(c[s - 3] ^ c[s - 8] ^ c[s - 14] ^ c[s - 16], 1);
                }
                var t = o(o(p(d, 5), l(s, e, f, g)), o(o(h, c[s]), m(s)));
                h = g;
                g = f;
                f = p(e, 30);
                e = d;
                d = t;
            }
            d = o(d, j);
            e = o(e, k);
            f = o(f, n);
            g = o(g, q);
            h = o(h, r);
        }
        return new Array(d, e, f, g, h);
    }
    function l(a, b, c, d) {
        if (a < 20) {
            return b & c | ~b & d;
        }
        if (a < 40) {
            return b ^ c ^ d;
        }
        if (a < 60) {
            return b & c | b & d | c & d;
        }
        return b ^ c ^ d;
    }
    function m(a) {
        return a < 20 ? 1518500249 : a < 40 ? 1859775393 : a < 60 ? -1894007588 : -899497514;
    }
    function n(a, b) {
        var d = q(a);
        if (d.length > 16) {
            d = k(d, a.length * c);
        }
        var e = new Array(16), f = new Array(16);
        for (var g = 0; g < 16; g++) {
            e[g] = d[g] ^ 909522486;
            f[g] = d[g] ^ 1549556828;
        }
        var h = k(e.concat(q(b)), 512 + b.length * c);
        return k(f.concat(h), 512 + 160);
    }
    function o(a, b) {
        var c = (a & 65535) + (b & 65535);
        var d = (a >> 16) + (b >> 16) + (c >> 16);
        return d << 16 | c & 65535;
    }
    function p(a, b) {
        return a << b | a >>> 32 - b;
    }
    function q(a) {
        var b = [];
        var d = (1 << c) - 1;
        for (var e = 0; e < a.length * c; e += c) {
            b[e >> 5] |= (a.charCodeAt(e / c) & d) << 32 - c - e % 32;
        }
        return b;
    }
    function r(a) {
        var b = "";
        var d = (1 << c) - 1;
        for (var e = 0; e < a.length * 32; e += c) {
            b += String.fromCharCode(a[e >> 5] >>> 32 - c - e % 32 & d);
        }
        return b;
    }
    function s(b) {
        var c = a ? "0123456789ABCDEF" : "0123456789abcdef";
        var d = "";
        for (var e = 0; e < b.length * 4; e++) {
            d += c.charAt(b[e >> 2] >> (3 - e % 4) * 8 + 4 & 15) + c.charAt(b[e >> 2] >> (3 - e % 4) * 8 & 15);
        }
        return d;
    }
    function t(a) {
        var c = "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/";
        var d = "";
        for (var e = 0; e < a.length * 4; e += 3) {
            var f = (a[e >> 2] >> 8 * (3 - e % 4) & 255) << 16 | (a[e + 1 >> 2] >> 8 * (3 - (e + 1) % 4) & 255) << 8 | a[e + 2 >> 2] >> 8 * (3 - (e + 2) % 4) & 255;
            for (var g = 0; g < 4; g++) {
                if (e * 8 + g * 6 > a.length * 32) {
                    d += b;
                } else {
                    d += c.charAt(f >> 6 * (3 - g) & 63);
                }
            }
        }
        return d;
    }
    PP.library.Crypto = {};
    PP.library.Crypto.sha1 = function(a) {
        return d(a);
    };
})();

PP.library._Publication = PP.Class.extend({
    links: function(a) {
        var b = [];
        if (a.doi) {
            b.push(this.getDoiLink(a));
        }
        if (a.url) {
            var c;
            if (PP.Utils.isArray(a.url)) {
                c = a.url;
            } else {
                c = [ a.url ];
            }
            var d = [];
            for (var e = 0; e < c.length; e++) {
                if (c[e] && typeof c[e] === "string") {
                    c[e] = c[e].replace(/\s*$/, "").replace(/^\s*/, "");
                    d.push(c[e]);
                }
            }
            c = d;
            if (!a.doi) {
                PP.Array.each(c, function(a) {
                    if (a.match(/doi\.org/)) {
                        b.push(a);
                    }
                });
            }
            PP.Array.each(c, function(a) {
                if (a.match(/fulltext/i)) {
                    b.push(a);
                }
            });
            PP.Array.each(c, function(a) {
                if (a.match(/full/i)) {
                    b.push(a);
                }
            });
            PP.Array.each(c, function(a) {
                if (!a.match(/pdf/i)) {
                    b.push(a);
                }
            });
            PP.Array.each(c, function(a) {
                b.push(a);
            });
        }
        if (a.pmid) {
            var f = this.getPubMedLink(a).replace(/https/, "http");
            b = PP.Array.filter(b, function(a) {
                if (a == f) {
                    return false;
                }
                return true;
            });
            b.push(this.getPubMedLink(a));
        }
        if (a.pmc) {
            var f = this.getPMCLink(a).replace(/https/, "http");
            b = PP.Array.filter(b, function(a) {
                if (a == f) {
                    return false;
                }
                return true;
            });
            b.push(this.getPMCLink(a));
        }
        if (a.arxivid) {
            b = PP.Array.filter(b, function(a) {
                if (a.match(/arxiv\.org/i)) {
                    return false;
                }
                return true;
            });
            b.push(this.getArxivLink(a));
        }
        if (a.scopusid) {
            b.push(this.getScopusLink(a));
        }
        if (a.zbl) {
            b.push(this.getZBLLink(a));
        }
        if (a.mr) {
            b.push(this.getMRLink(a));
        }
        b = PP.Array.stringUnique(b);
        b = PP.Array.filter(b, function(a) {
            if (a.match(/^\//)) {
                return false;
            }
            if (a.match(/mail-attachment.googleusercontent.com/i)) {
                return false;
            }
            if (!PP.Utils.isUrlLike(a)) {
                return false;
            }
            return true;
        });
        return b;
    },
    getDoiLink: function(a) {
        return "http://dx.doi.org/" + a.doi;
    },
    getPubMedLink: function(a) {
        return "https://www.ncbi.nlm.nih.gov/pubmed/" + a.pmid;
    },
    getPMCLink: function(a) {
        return "https://www.ncbi.nlm.nih.gov/pmc/articles/" + a.pmc;
    },
    getArxivLink: function(a) {
        return "http://arxiv.org/abs/" + a.arxivid;
    },
    getLCCNLink: function(a) {
        return "http://lccn.loc.gov/" + a.lccn;
    },
    getMRLink: function(a) {
        return "http://www.ams.org/mathscinet-getitem?mr=" + a.mr;
    },
    getZBLLink: function(a) {
        return "https://zbmath.org/?q=an:" + a.zbl;
    },
    getScopusLink: function(a) {
        var b = "https://www.reaxys.com/reaxys/secured/fulltext.do?performed=true&citationNumber=" + a.scopusid;
        return b;
    },
    hasPublisherLink: function(a) {
        var b = this.links(a);
        var c = PP.crawling.PdfDriver.getUrlRegexes();
        var d = false;
        PP.Array.each(b, function(a) {
            if (a.match(/doi\.org/i)) {
                d = true;
            }
            for (var b = 0; b < c.length; b++) {
                if (a.match(c[b])) {
                    d = true;
                }
            }
        });
        return d;
    },
    getCitedByCount: function(a) {
        if (a.gs_cited_by_count !== undefined) {
            return a.gs_cited_by_count;
        } else if (a.pubmed_cited_by_count !== undefined) {
            return a.pubmed_cited_by_count;
        } else {
            return null;
        }
    },
    getCitedByLink: function(a) {
        var b = a.doi;
        if (b) {
            var c = "http://dx.doi.org/" + b;
            var d = "http://scholar.google.com";
            var e = "/scholar?hl=en&lr=&num=30&cites=";
            var f = d + e + c;
            return f;
        } else if (a.gs_cluster_id) {
            var d = "http://scholar.google.com";
            var e = "/scholar?hl=en&lr=&num=30&cites=";
            var f = d + e + a.gs_cluster_id;
            return f;
        } else if (a.patent_number) {
            var g = a.patent_number;
            var h = a.issuing_authority;
            g = g.replace(h, "");
            var i = "http://www.freepatentsonline.com/" + g + ".html";
            var d = "http://scholar.google.com";
            var e = "/scholar?cites=";
            var f = d + e + i;
            return f;
        } else {
            return null;
        }
    },
    crawlUrlsContainDoi: function(a) {
        if (!a.crawl_urls) {
            return false;
        }
        var b = false;
        if (a.crawl_urls && PP.Utils.isArray(a.crawl_urls)) {
            a.crawl_urls.forEach(function(a) {
                if (a && a.match(/doi\.org/i)) {
                    b = true;
                }
            });
        }
        return b;
    },
    getSupportedRefDriver: function(a) {
        var b = this.links(a);
        if (a.crawl_urls) {
            b = a.crawl_urls.reverse().concat(b);
        }
        b = PP.Array.stringUnique(b);
        var c, d;
        for (var e = 0; e < b.length; e++) {
            var f = b[e];
            var g = PP.crawling.RefDriver.getSupportingDriver(f);
            if (g) {
                c = g;
                d = f;
                break;
            }
        }
        if (c !== undefined) {
            return {
                driver: c,
                url: d
            };
        } else {
            return undefined;
        }
    },
    addUrl: function(a, b) {
        if (!b) {
            return;
        }
        if (!a.url) {
            a.url = [];
        }
        a.url.push(b);
    },
    addCrawlUrls: function(a, b) {
        if (!b) {
            return;
        }
        if (!a.crawl_urls) {
            a.crawl_urls = [];
        }
        a.crawl_urls = a.crawl_urls.concat(b);
        a.crawl_urls = PP.Array.stringUnique(a.crawl_urls);
    },
    addWebimportSha1: function(a, b) {
        if (!a.webimport_sha1s) {
            a.webimport_sha1s = [];
        }
        a.webimport_sha1s.push(b);
    },
    addXref: function(a, b) {
        if (!a.xref) {
            a.xref = [];
        }
        var c = true;
        a.xref.forEach(function(a) {
            if ("pmid" in b && "pmid" in a) {
                if (b.pmid == a.pmid) c = false;
            }
            if ("doi" in b && "doi" in a) {
                if (b.doi == a.doi) c = false;
            }
        });
        if (c) a.xref.push(b);
    },
    getAttachment: function(a, b) {
        var c = null;
        a.attachments.forEach(function(a) {
            if (a._id === b) {
                c = a;
            }
        });
        return c;
    },
    addAttachment: function(a, b) {
        if (!a.attachments) {
            a.attachments = [];
        }
        PP.library.Attachment.autoClean(a, b);
        a.attachments.push(b);
    },
    removeAttachment: function(a, b) {
        var c;
        a.attachments.forEach(function(a) {
            if (a._id === b) {
                c = a;
            }
        });
        if (c) {
            PP.Array.remove(a.attachments, c);
        }
    },
    getPdfAttachment: function(a) {
        if (!a.attachments) {
            return null;
        }
        var b = null;
        a.attachments.forEach(function(a) {
            if (a.article_pdf === 1) {
                b = a;
            }
        });
        return b;
    },
    getPersistentData: function(a) {
        var b = PP.Utils.clone(a);
        var c = {};
        var d = PP.library.PublicationFields.getFields();
        for (var e = 0; e < d.length; e++) {
            var f = d[e].name;
            if (d[e].persist !== false && b[f] !== undefined) {
                if (PP.Utils.isArray(b[f]) && b[f].length == 0) {
                    continue;
                }
                c[f] = b[f];
            }
        }
        c._id = b._id;
        return c;
    },
    getAllData: function(a) {
        var b = PP.Utils.clone(a);
        var c = {};
        var d = PP.library.PublicationFields.getFields();
        for (var e = 0; e < d.length; e++) {
            var f = d[e].name;
            if (b[f] !== undefined) {
                if (PP.Utils.isArray(b[f]) && b[f].length == 0) {
                    continue;
                }
                c[f] = b[f];
            }
        }
        c._id = b._id;
        return c;
    },
    stripNonBibtexFields: function(a) {
        var b = PP.library.PublicationFields.getFields();
        for (var c = 0; c < b.length; c++) {
            var d = b[c].name;
            if (b[c].persist_bibtex === false && a[d]) {
                delete a[d];
            }
        }
        return a;
    },
    clearEmptyValues: function(a) {
        var b = PP.library.PublicationFields.getFields();
        for (var c = 0; c < b.length; c++) {
            var d = b[c].name;
            var e = b[c].fieldType;
            var f = a[d];
            var g = false;
            if (e === "array" || e === "author") {
                g = f === "" || f === undefined || f === null || PP.Utils.isArray(f) && f.length === 0;
            } else if (e === "date") {
                g = f === "" || f === undefined || f === null || PP.Utils.isArray(f) && f.length === 0;
            } else {
                g = f === "" || f === undefined || f === null;
            }
            if (g) {
                delete a[d];
            }
        }
    },
    autoClean: function(a, b) {
        var c, d, e;
        var f = b || {};
        if (!("updateUrls" in f)) {
            f.updateUrls = true;
        }
        if (a.autoCleaned) {}
        for (c in a) {
            if (a[c] === undefined) {
                delete a[c];
                continue;
            }
            if (a[c] === null) {
                delete a[c];
                continue;
            }
            if (PP.Utils.isString(a[c])) {
                a[c] = PP.Utils.replaceU0308(a[c]);
                a[c] = PP.Utils.replaceControlChars(a[c]);
            }
        }
        this.convertHtmlEntitiesToUnicode(a);
        if (!a._id) {
            a._id = PP.UUID.generate();
        }
        if (!a.owner) {
            if (PP.Session.hasKey("user_id")) {
                a.owner = PP.Session.get("user_id");
            }
            if (!a.owner) {}
        }
        var g = a.pubtype;
        var h = PP.library.PublicationTypes.getPubTypeMap();
        if (!h[g]) {
            console.log("BAD PUBTYPE: " + g);
        }
        for (c in a) {
            if (c.match(/arxiv/i)) {
                var i = a[c];
                i = i.replace(/arxiv:?\s*/i, "");
                delete a[c];
                a.arxivid = i;
            }
        }
        if (!a.journal && a.archivePrefix && a.primaryClass) {
            a.journal = a.archivePrefix + " [" + a.primaryClass + "]";
        }
        if (!a.source) {
            a.source = {};
        }
        if (a.url) {
            if (PP.Utils.isString(a.url) && a.url !== "") {
                a.url = [ a.url ];
            }
            if (PP.Utils.isArray(a.url)) {}
        } else {
            a.url = [];
        }
        var j = PP.Array.mapBoolean(a.url);
        if (a.crawl_urls) {
            var k = false;
            for (var c = 0; c < a.crawl_urls.length; c++) {
                if (j[a.crawl_urls[c]]) {
                    k = true;
                    break;
                }
            }
            if (!k) {
                a.crawl_urls = [];
            }
        }
        var l = this.links(a);
        if (l.length > 0 && !a.doi) {
            for (c = 0; c < l.length; c++) {
                if (l[c].match(/^(http:\/\/)?dx\.doi\.org/)) {
                    a.doi = l[c];
                }
            }
        }
        if (a.doi) {
            a.doi = a.doi.replace(/^info:doi\//i, "");
            a.doi = a.doi.replace(/^doi:\s*/i, "");
            a.doi = a.doi.replace(/^(https?:\/\/)?dx\.doi\.org[^\/]*\//i, "");
            a.doi = a.doi.replace(/^(https?:\/\/)?doi\.org\//i, "");
            a.doi = a.doi.replace(/^(https?:\/\/)?doi\.acm\.org\//i, "");
            a.doi = a.doi.replace(/^(https?:\/\/)?doi\.ieeecomputersociety\.org\//i, "");
            a.doi = a.doi.replace(/^(https?:\/\/)?doi\.org[^\/]*\//i, "");
            a.doi = a.doi.replace(/\?locatt=mode:legacy/i, "");
            try {
                a.doi = decodeURIComponent(a.doi);
            } catch (a) {}
        }
        if (a.associated_doi) {
            var m = {
                type: "article",
                doi: a.associated_doi
            };
            this.addXref(a, m);
        }
        if (a.pmid) {
            a.pmid = a.pmid.replace(/^pmid:?\s*/i, "");
        } else {
            l = this.links(a);
            l.forEach(function(b) {
                if (b.match(/ncbi\.nlm\.nih\.gov\/pubmed\/(\d+)/i)) {
                    a.pmid = RegExp.$1;
                }
            });
        }
        if (!a.pmc) {
            l = this.links(a);
            l.forEach(function(b) {
                if (b.match(/ncbi\.nlm\.nih\.gov\/pmc\/articles\/(PMC\d+)/i)) {
                    a.pmc = RegExp.$1;
                }
            });
        }
        if (a.zbl) {
            a.zbl = a.zbl.replace(/\s*zbl\s*/i, "");
        } else {
            l = this.links(a);
            l.forEach(function(b) {
                if (b.match(/zbmath\.org\/\?q=an:(.+)/i)) {
                    a.zbl = RegExp.$1;
                }
            });
        }
        if (!a.mr) {
            l = this.links(a);
            l.forEach(function(b) {
                if (b.match(/ams\.org\/mathscinet-getitem\?mr=(.+)/i)) {
                    a.mr = RegExp.$1;
                }
            });
        }
        if (f.updateUrls) {
            var n = this.links(a);
            var o = [];
            a.url.forEach(function(a) {
                for (var b = 0; b < n.length; b++) {
                    n[b] = n[b].replace(/\s*$/, "").replace(/^\s*/, "");
                    if (a == n[b]) {
                        o.push(a);
                        n.splice(b, 1);
                    }
                }
            });
            a.url = o.concat(n);
            if (a.url.length === 0) {
                delete a.url;
            }
        }
        var p = this.getCitedByLink(a);
        if (p !== null) {
            a.citedByLink = p;
        }
        if (PP.Features.getPaperReferences()) {
            var q = this.getSupportedRefDriver(a);
            if (q) {
                var r = q.url;
                a.referencesLink = r;
            }
        }
        var s = [ "issn", "isbn", "issn_alt", "isbn_alt" ];
        s.forEach(function(b) {
            var c = a[b];
            if (c) {
                if ((b == "issn" || b == "isbn") && PP.Utils.isArray(c)) {
                    if (c.length > 1) {
                        a[b] = c[0];
                        if (!a[b + "_alt"]) {
                            a[b + "_alt"] = c[1];
                        }
                    } else if (c.length > 0) {
                        a[b] = c[0];
                    } else {
                        delete a[b];
                    }
                }
                if (!PP.Utils.isString(a[b])) {
                    delete a[b];
                    return;
                }
                if (b == "issn" || b == "issn_alt") {
                    a[b] = a[b].replace(/\s/g, "");
                    if (a[b].match(/^(\d{4})(\d{3}[X\d])$/)) {
                        a[b] = RegExp.$1 + "-" + RegExp.$2;
                    }
                }
                if (b == "isbn" || b == "isbn_alt") {
                    a[b] = a[b].toUpperCase();
                    a[b] = a[b].replace(/-/g, "");
                    a[b] = a[b].replace(/\s/g, "");
                    if (!a[b].match(/^[X\d]+$/)) {
                        if (a[b].match(/([X\d]{13})/)) {
                            a[b] = RegExp.$1;
                        } else if (a[b].match(/([X\d]{10})/)) {
                            a[b] = RegExp.$1;
                        } else {
                            delete a[b];
                        }
                    }
                    if (a[b] && a[b].length == 10) {
                        a[b] = PP.Utils.isbn10To13(a[b]);
                    }
                }
            } else {
                delete a[b];
            }
        });
        if (a.startpage && a.endpage) {
            a.pages = a.startpage + "-" + a.endpage;
            delete a.startpage;
            delete a.endpage;
        } else if (a.startpage) {
            a.pages = a.startpage;
            delete a.startpage;
        } else if (a.endpage) {
            a.pages = a.endpage;
            delete a.endpage;
        }
        if (a.pages) {
            a.pages = a.pages.replace(/\s*-\s*/, "-");
            a.pages = a.pages.replace(/^\s*/, "");
            a.pages = a.pages.replace(/\s$/, "");
            a.pages = a.pages.replace(/--/, "-");
            a.pages = a.pages.replace(/^pp?\.?\s*/, "");
            if (a.pages) {
                var t = a.pages.match(/^(\d+)-(\d+)$/);
                if (t) {
                    var u = t[1];
                    var v = t[2];
                    if (u.length > v.length) {
                        v = u.substring(0, u.length - v.length) + v;
                        a.pages = u + "-" + v;
                    }
                }
            }
            if (a.pages.match(/n\/a/gi)) {
                delete a.pages;
            }
        }
        if (a.volume && PP.Utils.isString(a.volume)) {
            if (a.volume.match(/\d/)) {
                a.volume = a.volume.replace(/\s*([Vv]olume|VOLUME|VOL|[Vv]ol|v)\s*\.?\s*/, "");
            }
        }
        if (a.issue && PP.Utils.isString(a.issue)) {
            if (a.issue.match(/\d/)) {
                a.issue = a.issue.replace(/\s*([Ii]ssue|ISSUE|[Nn]umber|NUMBER|NO|[Nn]o)\.?\s*/, "");
            }
        }
        PP.library.Date.extractDate(a, "", "published");
        PP.library.Date.extractDate(a, "acc", "accessed");
        PP.library.Date.extractDate(a, "filed", "filed");
        var w = PP.library.PublicationFields.authorFields();
        for (c = 0; c < w.length; c++) {
            e = w[c].name;
            if (a[e] && PP.Utils.isArray(a[e])) {
                var x = a[e];
                var y = [];
                for (d = 0; d < x.length; d++) {
                    if (PP.Utils.isString(x[d])) {
                        x[d] = PP.library.Author.parseAuthor(x[d]);
                    }
                    PP.library.Author.autoClean(x[d]);
                    if (PP.library.Author.toString(x[d]) !== "") {
                        y.push(x[d]);
                    }
                }
                a[e] = y;
            } else if (a[e] && PP.Utils.isString(a[e])) {
                var x = [];
                var z = a[e];
                var A = z.split(/[,;]/g);
                A.forEach(function(a) {
                    var b = PP.library.Author.parseAuthor(a);
                    if (PP.library.Author.toString(b) !== "") {
                        x.push(b);
                    }
                });
                a[e] = x;
            }
        }
        var B = PP.library.PublicationFields.dateFields();
        for (c = 0; c < B.length; c++) {
            e = B[c].name;
            if (a[e]) {
                a[e] = PP.library.Date.autoClean(a[e]);
            }
        }
        if (a.journalfull && !a.journal) {
            a.journal = a.journalfull;
        }
        if (a.journal) {
            var z = a.journal;
            a.journal = z;
        }
        var C = [ "title", "booktitle", "journal", "abstract", "publisher" ];
        for (var c = 0; c < C.length; c++) {
            var e = C[c];
            var D = {
                replacement: "",
                exclude: []
            };
            if (c <= 1) {
                D.exclude = [ "i", "b", "sup", "sub" ];
            }
            if (a[e] !== undefined) {
                a[e] = this.strip(a[e]);
                a[e] = PP.String.stripHtml(a[e], D);
            }
        }
        if (a.title) {
            a.title = a.title.replace(/\.$/, "");
            a.title = a.title.replace(/\s+/g, " ");
        }
        if (a.booktitle) {
            a.booktitle = a.booktitle.replace(/\s+/g, " ");
        }
        if (a["abstract"]) {
            a["abstract"] = a["abstract"].replace(/\s+/g, " ");
            var E = /(\\){10,}/g;
            if (a["abstract"].match(E)) {
                a["abstract"] = a["abstract"].replace(E, "");
            }
        }
        if (a["pubtype"] === "PP_ARTICLE") {
            if (a.number && !a.issue) {
                a.issue = a.number;
                delete a.number;
            }
        }
        if (a.keywords && PP.Utils.isArray(a.keywords)) {
            a.keywords = a.keywords.join("; ");
        }
        if (a.kind) {
            if (!this.checkKindField(a)) a.kind = "";
        } else {
            var F = PP.library.PublicationTypes.getTypeForPub(a);
            if (F && F.subtypes) {
                a.kind = F.defaultSubtype;
            }
        }
        if (a.pubtype === "PP_PATENT") {
            if (a.patent_number && a.patent_number.match(/^us\s*:?(.+)/i)) {
                a.patent_number = RegExp.$1;
                a.issuing_authority = "USPTO";
                a.journal = "US Patent";
                a.journalfull = "United States Patent and Trademark Office";
            } else if (a.patent_number && a.patent_number.match(/^WO\s*:?(.+)/i)) {
                a.patent_number = RegExp.$1;
                a.issuing_authority = "WIPO";
                a.journal = "World Patent";
                a.journalfull = "World Intellectual Property Organization";
            } else if (a.patent_number && a.patent_number.match(/^EP\s*:?(.+)/i)) {
                a.patent_number = RegExp.$1;
                a.issuing_authority = "EPO";
                a.journal = "European Patent";
                a.journalfull = "European Patent Office";
            }
            if (a.application_number) {
                a.application_number = a.application_number.replace(/,/g, "");
            }
            if (!a.journal) {
                a.journal = "Patent";
            }
        }
        var G = PP.library.Patterns.applyPattern("{initial}", a);
        if (!G.match(/[A-Z]/)) {
            G = "Other";
        }
        var H = [ "All Papers" + "/" + G ];
        if (a.starred) {
            H.push("Starred Papers");
        }
        a.subfolders = H;
        var I = a.attachments || [];
        I.forEach(function(b) {
            PP.library.Attachment.autoClean(a, b);
        });
        var J = this.isIncomplete(a);
        var K = a.force_complete == 1;
        if (J && !K) {
            a.incomplete = 1;
        } else {
            a.incomplete = 0;
        }
        if (!this.isEmptyPub(a)) {
            a.sha1 = this.sha1(a);
            a.dup_sha1 = this.dupSha1(a);
        } else {
            delete a.sha1;
            delete a.dup_sha1;
        }
        var L = PP.library.Patterns.applyPattern("{firstAuthor}{year}-{randomChars}", a);
        if (a.citekey) {
            var M = a.citekey;
            var N = M.replace(/-\S{2,3}$/, "");
            var O;
            if (M.match(/(\S{2,3})$/)) {
                O = RegExp.$1;
            }
            var P = L.replace(/-\S{2,3}$/, "");
            var Q;
            if (L.match(/(\S{2,3})$/)) {
                Q = RegExp.$1;
            }
            if (P !== N) {
                if (O) {
                    a.citekey = P + O;
                } else {
                    a.citekey = L;
                }
            }
        } else {
            a.citekey = L;
        }
        a.id_list = this.collectIdList(a);
        this.clearEmptyValues(a);
        a.autoCleaned = true;
    },
    removeNonPubtypeSpecificFields: function(a) {
        var b = this;
        var c = [];
        var d = [ "general", "date", "identifier", "author" ];
        PP.library.PublicationFields.getFields().forEach(function(a) {
            if (a.fieldType) {
                if (d.indexOf(a.fieldType) > -1) {
                    c.push(a.name);
                }
            }
        });
        if (a && a.pubtype && a.pubtype.match(/^PP_/)) {
            var e = {
                pubtype: 1
            };
            PP.library.PublicationFields.getFieldsForPubType(a.pubtype).forEach(function(a) {
                e[a.name] = 1;
            });
            for (var f in a) {
                if (c.indexOf(f) > -1) {
                    if (!e[f]) {
                        b.setEmpty(a, f);
                    }
                }
            }
        }
    },
    autoCleanLegalDocs: function(a) {
        if (a.journal) {
            var b = PP.library.LegalAbbreviations.getReporterMap(true);
            var c = a.journal.toUpperCase().replace(/[\s\.]+/g, "");
            if (c in b) {
                a.journalfull = b[c];
                a.journal = PP.library.LegalAbbreviations.getAbbreviation(a.journalfull);
            }
        }
    },
    isEmptyPub: function(a) {
        if (!a.title) {
            return true;
        }
        var b = PP.library.Publication.getAuthorType(a);
        var c = a[b];
        if (!c) {
            return true;
        }
        return;
    },
    checkValidityOfISSN: function(a) {
        if (!a) {
            return "";
        }
        var b = a.toUpperCase().replace(/-/g, "");
        b = b.replace(/\s+\(.+/, "");
        b = b.replace(/^\s+/, "");
        if (b.match(/^\d{7}[\dX]$/)) {
            var c = b.split("");
            if (c[7].toUpperCase() == "X") {
                c[7] = 10;
            }
            var d = 0;
            for (var e = 0; e < c.length; e++) {
                d += (8 - e) * parseInt(c[e]);
            }
            if (d % 11 == 0) {
                if (c[7] == 10) {
                    c[7] = "X";
                }
                var f = c.slice(0, 4).join("") + "-" + c.slice(4, 8).join("");
                return f;
            }
        }
        return "";
    },
    getAuthorArray: function(a) {
        var b = PP.library.Publication.getAuthorType(a);
        if (a[b]) {
            return a[b];
        } else {
            return [];
        }
    },
    getIdentifierFieldNames: function() {
        return [ "arxivid", "isbn", "doi", "patent_number", "pmc", "pmid", "zbl", "mr" ];
    },
    hasIdentifier: function(a) {
        var b = this.getIdentifierFieldNames();
        var c = false;
        b.forEach(function(b) {
            if (a[b]) {
                c = true;
            }
        });
        return c;
    },
    collectIdList: function(a) {
        var b = [ "sha1", "dup_sha1" ];
        b = b.concat(this.getIdentifierFieldNames());
        if (a.pubtype != "PP_BOOK") {
            b = PP.Array.remove(b, "isbn");
        }
        var c = [];
        for (var d = 0; d < b.length; d++) {
            var e = b[d];
            if (a[e]) {
                c.push(e + ":" + a[e]);
            }
        }
        var f = this.links(a);
        var g = a.crawl_urls || [];
        var h = [];
        g.forEach(function(a) {
            if (PP.crawling.Proxy.isLoginUrl(a)) {} else if (PP.crawling.Proxy.isProxied(a)) {
                var b = PP.crawling.Proxy.deproxify(a);
                if (b && b.cleanUrl) h.push(b.cleanUrl);
            } else {
                h.push(a);
            }
        });
        f = f.concat(h);
        f = PP.Array.filter(f, function(a) {
            if (a.length > 500) {
                return false;
            }
            if (!PP.Utils.isString(a)) {
                return false;
            }
            if (a.match(/scopus\.com\/scopus\/inward/i)) {
                return false;
            }
            if (!a.match(/\d+/)) {
                return false;
            }
            return true;
        });
        for (var d = 0; d < f.length; d++) {
            c.push("url:" + f[d]);
        }
        var i = a.webimport_sha1s || [];
        for (var d = 0; d < i.length; d++) {
            c.push("webimport_sha1:" + i[d]);
        }
        if (a.original_id) {
            c.push("original_id:" + a.original_id);
        }
        c = PP.Array.stringUnique(c);
        return c;
    },
    dupSha1: function(a) {
        var b = [];
        var c = [ "title", "booktitle", "author" ];
        var d;
        for (var e in c) {
            if (c[e]) {
                d = c[e];
                var f = PP.library.PublicationFields.getFieldType(d);
                var g;
                if (f === "date") {
                    g = PP.library.Date.toString(a[d]);
                } else if (f === "author") {
                    var h = [];
                    if (a[d] && a[d].length >= 2) {
                        h = a[d].slice(0, 2);
                    } else if (a[d] && a[d].length > 0) {
                        h = a[d];
                    }
                    g = PP.library.Author.toString(h, {
                        output: "last",
                        delim: " "
                    });
                } else {
                    g = a[d];
                }
                if (g) {
                    g = g.toLowerCase();
                    g = g.replace(/[\.,-\/#!$%\^&\*;:{}=\-_`~()]/g, "");
                    g = g.replace(/\s{2,}/g, "");
                    b.push(g);
                }
            }
        }
        var i = b.join(" ");
        var j = PP.library.Crypto.sha1(i);
        return j;
    },
    sha1: function(a) {
        var b = [ "title", "booktitle", "journal", "author", "editor", "publisher", "published" ];
        var c = [];
        var d;
        for (var e in b) {
            if (b[e]) {
                d = b[e];
                var f = PP.library.PublicationFields.getFieldType(d);
                var g;
                if (f === "date") {
                    g = PP.library.Date.toString(a[d]);
                } else if (f === "author") {
                    g = PP.library.Author.toString(a[d]);
                } else {
                    g = a[d];
                }
                if (g) {
                    c.push(g);
                }
            }
        }
        var h = c.join(" ");
        var i = PP.library.Crypto.sha1(h);
        return i;
    },
    strip: function(a) {
        a = a.replace(/^\s*/, "");
        a = a.replace(/\s*$/, "");
        return a;
    },
    setEmpty: function(a, b) {
        var c = PP.library.PublicationFields.getField(b);
        var d = c.dataType;
        if (d === "array" || d === "author") {
            a[b] = [];
        } else if (d === "object" || d === "date") {
            a[b] = {};
        } else {
            a[b] = "";
        }
    },
    getAuthorType: function(a) {
        var b = [ "author", "editor", "series_editor", "contributor", "translator" ];
        var c;
        for (var d = 0; d < b.length; d++) {
            var e = a[b[d]];
            if (e && e.length > 0) {
                c = b[d];
                break;
            }
        }
        return c;
    },
    getAuthorById: function(a, b) {
        var c = PP.library.PublicationFields.getFields();
        for (var d = 0; d < c.length; d++) {
            var e = c[d].name;
            var f = c[d].dataType;
            if (f === "author") {
                var g = a[e];
                if (g && PP.Utils.isArray(g)) {
                    for (var h = 0; h < g.length; h++) {
                        var i = g[h];
                        if (i._id === b) {
                            return i;
                        }
                    }
                }
            }
        }
    },
    getJournalString: function(a) {
        var b = this.getJournalField(a);
        var c = "";
        if (b && a[b]) {
            c = a[b];
        }
        return c;
    },
    getJournalField: function(a) {
        if (a.pubtype == "PP_CONFERENCE_PAPER") {
            return "booktitle";
        } else if (a.pubtype == "PP_BOOK_CHAPTER") {
            return "booktitle";
        } else if (a.pubtype == "PP_WEBSITE") {
            return "booktitle";
        } else {
            return "journal";
        }
    },
    formatAuthors: function(a, b) {
        var c = this.getAuthorType(a);
        if (c) {
            var d = a[c];
            if (d) {
                var e = PP.library.Author.toString(d, b);
                return e;
            } else {
                return "";
            }
        } else {
            return "[No author]";
        }
    },
    formatAuthorYearJournal: function(a, b) {
        if (b === undefined) {
            b = false;
        }
        var c = this.formatAuthorYear(a);
        var d = this.getJournalString(a);
        var e = c;
        if (d) {
            if (!b) {
                d = '<span style="font-style:italic;">' + d + "</span>";
            }
            e += " - " + d;
        }
        return e;
    },
    formatAuthorYear: function(a, b) {
        b = b || {};
        var c = this.getAuthorType(a);
        if (c) {
            var d = this.formatAuthors(a, {
                etAl: true,
                output: "last",
                includeItalics: false
            });
        } else {
            d = a.title || "[untitled item]";
            d = PP.String.interconvertString(d, {
                format: "nomarkup"
            });
        }
        var e = a.published || {};
        var f = PP.library.Date.yearString(e);
        var g = d + " " + f;
        var h = b.maxLength || 40;
        return PP.Utils.ellipsis(g, h, false, "...");
    },
    formatYear: function(a) {
        var b = a.published || {};
        var c = PP.library.Date.yearString(b);
        if (c == "") {
            return "[no date]";
        } else {
            return c;
        }
    },
    formatAuthorYearLink: function(a) {
        var b = this.formatAuthorYear(a);
        var c = this.links(a);
        if (c.length > 0) {
            var d = c[0];
            return b + " " + d;
        } else {
            return b;
        }
    },
    formatYearTitle: function(a) {
        var b = PP.library.Date.yearString(a.published || {});
        var c = a.title || "";
        return b + " &mdash; " + c;
    },
    findAuthorById: function(a, b) {
        var c = PP.library.PublicationFields.authorFields();
        for (var d = 0; d < c.length; d++) {
            var e = c[d].name;
            if (a[e]) {
                var f = a[e];
                for (var g = 0; g < f.length; g++) {
                    var h = f[g];
                    if (h._id === b) {
                        return h;
                    }
                }
            }
        }
        return null;
    },
    toText: function(a) {
        if (PP.Utils.isArray(a)) {
            var b = [];
            for (var c = 0; c < a.length; c++) {
                b.push(PP.library.Publication.toText(a[c]));
            }
            return b.join("\n");
        }
        if (a && a.$className) {
            a = a.serialize();
        }
        var d = "";
        d += a._plugin !== undefined ? "[" + a._plugin + "]" : "";
        d += PP.Utils.ellipsis(a.title || "", 40, true, "...");
        d += " - ";
        d += PP.Utils.ellipsis(PP.library.Publication.formatAuthors(a), 20, null, "...");
        d += " - ";
        d += PP.library.Date.toString(a.published || "");
        d += ", ";
        d += a.journal;
        return d;
    },
    convertHtmlEntitiesToUnicode: function(a) {
        if (!PP.Utils.isObject(a)) return;
        for (var b in a) {
            if (a[b] === undefined) continue;
            if (a[b] === null) continue;
            if (PP.Utils.isString(a[b])) {
                a[b] = PP.Utils.convertHtmlEntitiesToUnicode(a[b]);
            } else if (PP.Utils.isArray(a[b])) {
                for (var c = 0; c < a[b].length; c++) {
                    if (PP.Utils.isObject(a[b][c])) {
                        for (var d in a[b][c]) {
                            if (a[b][c][d] === undefined) continue;
                            if (a[b][c][d] === null) continue;
                            if (PP.Utils.isString(a[b][c][d])) {
                                a[b][c][d] = PP.Utils.convertHtmlEntitiesToUnicode(a[b][c][d]);
                            }
                        }
                    }
                }
            }
        }
    },
    checkKindField: function(a) {
        if (a) {
            if (!("kind" in a)) {
                return true;
            } else if (!("pubtype" in a)) {
                return true;
            } else {
                var b = PP.library.PublicationTypes.getTypeForPub(a);
                var c = [];
                if ("subtypes" in b) {
                    c = b.subtypes;
                }
                if (c.length === 0) {
                    return false;
                } else {
                    var d = false;
                    c.forEach(function(b) {
                        if ("name" in b) {
                            if (b.name === a.kind) {
                                d = true;
                            }
                        }
                    });
                    return d;
                }
            }
        } else {
            return true;
        }
    },
    _collectLink: function(a, b, c) {
        return {
            url: a,
            name: b,
            type: c
        };
    },
    collectLinks: function(a) {
        var b = [];
        var c = this.links(a);
        var d = false;
        var e = "nih.gov/pubmed";
        var f = "arxiv.org";
        var g = "nih.gov/pmc";
        var h = "mendeley.com";
        var i = "citeulike.org";
        var j = "inspirehep.net";
        var k = "evernote";
        var l = "dx.doi.org";
        var m;
        var n;
        for (var o = 0; o < c.length; o++) {
            var p = c[o];
            if (p.match(l)) {
                b.push(this._collectLink(p, "Website", "website"));
                d = true;
            } else if (p.match(e)) {
                n = this._collectLink(p, "PubMed", "db");
                b.push(n);
            } else if (p.match(f)) {
                b.push(this._collectLink(p, "arXiv", "db"));
            } else if (p.match(g)) {
                m = this._collectLink(p, "PMC", "db");
            } else if (p.match(h)) {
                b.push(this._collectLink(p, "Mendeley", "db"));
            } else if (p.match(i)) {
                b.push(this._collectLink(p, "CiteULike", "db"));
            } else if (p.match(j)) {
                b.push(this._collectLink(p, "INSPIRE", "db"));
            } else if (p.match(k)) {
                b.push(this._collectLink(p, "Evernote", "db"));
            }
        }
        if (!n && m) {
            b.push(m);
        }
        if (!d) {
            for (var o = 0; o < c.length; o++) {
                var p = c[o];
                if (p.match(l) || p.match(e) || p.match(f) || p.match(g) || p.match(h) || p.match(i) || p.match(j) || p.match(k)) {} else {
                    b.push(this._collectLink(p, "Website", "website"));
                    break;
                }
            }
        }
        if (a.source.pdf_web_url) {
            var q = "PDF";
            if (PP.Utils.isPdfRestricted(a.source.pdf_crawl_status)) {
                q = "PDF";
            }
            b.push(this._collectLink(a.source.pdf_web_url, q, "pdf"));
        }
        if (a.citedByLink) {
            b.push(this._collectLink(a.citedByLink, "Cited By", "citedby"));
        }
        if (PP.Features.getPaperReferences()) {
            if (a.referencesLink) {
                b.push(this._collectLink(a.referencesLink, "References", "refs"));
            }
        }
        if (a.patent_number) {
            var r = a.patent_number;
            var s = a.issuing_authority;
            r = r.replace(s, "");
            if (s === "US") {
                var t = a.patent_number;
                t = t.replace(/\s\S+$/, "");
                var u = "http://www.google.com/patents/" + t;
                b.push(this._collectLink(u, "Google Patents", "website"));
            }
        }
        if (a.xref) {
            var v = {};
            for (var o = 0; o < a.xref.length; o++) {
                var w = a.xref[o];
                if (!(w.doi || w.pmid || w.url)) {
                    console.error("Xref without a good ID", w);
                    continue;
                }
                var q = "";
                var x = true;
                if (w.type === "article") {
                    q = "Associated Paper";
                } else if (w.type.toLowerCase() === "commentin") {
                    q = "Commentary";
                    x = false;
                } else if (w.type.toLowerCase() === "erratumin") {
                    q = "Erratum";
                } else if (w.type.toLowerCase() === "commenton") {
                    q = "Associated Paper";
                    x = false;
                } else if (w.type.toLowerCase() === "cites") {
                    continue;
                } else if (w.type.toLowerCase() === "data") {
                    q = "Associated Data";
                } else {
                    continue;
                }
                if (v[q]) {
                    v[q].push(w);
                } else {
                    v[q] = [ w ];
                }
                var y = this.links(w);
                if (y.length > 0) {
                    var p = y[0];
                    if (x) {
                        b.push(this._collectLink(p, q, "xref"));
                    }
                } else {
                    console.error("No link for xref", w);
                }
            }
            var z = v["Commentary"];
            if (z) {
                var A = PP.Array.pluck(z, "pmid");
                A = PP.Array.map(A, function(a) {
                    return a + "[PMID]";
                });
                var B = A.join(" OR ");
                var C = "https://www.ncbi.nlm.nih.gov/pubmed?term=" + B;
                var q = "Commentary";
                if (z.length > 1) {
                    q += " (" + z.length + ")";
                }
                b.push(this._collectLink(C, q, "xref"));
            }
            var D = v["Associated Paper"];
            if (D) {
                D = PP.Array.filter(D, function(a) {
                    return a.pmid != undefined;
                });
                if (D.length > 0) {
                    var A = PP.Array.pluck(D, "pmid");
                    A = PP.Array.map(A, function(a) {
                        return a + "[PMID]";
                    });
                    var B = A.join(" OR ");
                    var C = "https://www.ncbi.nlm.nih.gov/pubmed?term=" + B;
                    var q = "Associated Paper";
                    if (D.length > 1) {
                        q += " (" + D.length + ")";
                    }
                    b.push(this._collectLink(C, q, "xref"));
                }
            }
        }
        var E = false;
        var F = false;
        b = PP.Array.filter(b, function(a) {
            if (a.name == "Website" && E) {
                return false;
            } else if (a.name == "PubMed" && F) {
                return false;
            } else if (a.name == "Website") {
                E = true;
            } else if (a.name == "PubMed") {
                F = true;
            }
            return true;
        });
        b.sort(function(a, b) {
            var c = {
                website: 0,
                db: 1,
                citedby: 2,
                refs: 3,
                pdf: 4,
                xref: 5
            };
            var d = c[a.type];
            var e = c[b.type];
            return d > e;
        });
        return b;
    },
    hasAnyUsefulMetadata: function(a) {
        var b = PP.library.Publication.getAuthorType(a);
        var c = false;
        var d = a.published || {};
        var e = PP.library.Date.yearString(d);
        var f = a.title;
        var g = a[b];
        var h = a.journal;
        return f || g || h || e;
    },
    isIncomplete: function(a) {
        var b = PP.library.Publication.getAuthorType(a);
        var c = false;
        var d = a.published || {};
        var e = PP.library.Date.yearString(d);
        var f = a.title;
        var g = a[b];
        var h = a.editor;
        var i = a.journal;
        var j = a.court;
        var k = a.kind;
        var l = a.legislative_body;
        if (a.pubtype === "PP_ARTICLE") {
            if (!f || !g || !i || !e) {
                c = true;
            }
            if (k) {
                if (k == "Editorial") {
                    c = false;
                    if (!f || !i || !e) c = true;
                }
            }
        } else if (a.pubtype === "PP_WEBSITE") {
            if (!f) {
                c = true;
            }
        } else if (a.pubtype === "PP_CASE") {
            if (!f || !i || !j) {
                c = true;
            }
        } else if (a.pubtype === "PP_PERIODICAL") {
            if (!f) {
                c = true;
            }
        } else if (a.pubtype === "PP_STATUTE" || a.pubtype === "PP_TREATY") {
            if (!f || !i) {
                c = true;
            }
        } else if (a.pubtype === "PP_BILL") {
            if (!f || !l) {
                c = true;
            }
        } else if (a.pubtype === "PP_LETTER" || a.pubtype === "PP_INTERVIEW" || a.pubtype === "PP_PERSONAL_COMMUNICATION") {
            if (!g || !h) {
                c = true;
            }
        } else {
            if (!f || !g) {
                c = true;
            }
        }
        return c;
    },
    extractDoi: function(a) {
        if (a.match(/(10\.\d\d\d\d\S+)/)) {
            return this.cleanDoi(RegExp.$1);
        } else {
            return null;
        }
    },
    cleanDoi: function(a) {
        a = a.replace(/\/$/, "");
        return a;
    },
    getMissingFields: function(a) {
        var b = a.pubtype;
        var c = [];
        if (b === "PP_ARTICLE") {
            c = [ "title", "author", "journal", "year" ];
        } else {
            c = [ "title", "author" ];
        }
        var d = [];
        c.forEach(function(b) {
            if (b === "author") {
                var c = PP.library.Publication.getAuthorType(a);
                if (!a[c]) {
                    d.push(b);
                }
            } else if (b === "year") {
                var e = a.published || {};
                var f = PP.library.Date.yearString(e);
                if (!f) {
                    d.push("published");
                }
            } else {
                if (!a[b]) {
                    d.push(b);
                }
            }
        });
        return d;
    },
    isAutocompleted: function(a) {
        return a.autocompleted === 1;
    },
    hasWebsiteLink: function(a) {
        var b = this.collectLinks(a);
        var c = this.getWebsiteLink(a);
        if (c) {
            return true;
        } else {
            return false;
        }
    },
    getWebsiteLink: function(a) {
        var b = this.collectLinks(a);
        var c;
        b.forEach(function(a) {
            if (a.name === "Website" && !c) {
                c = a;
            }
        });
        return c;
    },
    getBibTeXkey: function(a) {
        var b = a.citekey;
        if (a.user_citekey) {
            b = a.user_citekey;
        }
        if (b === undefined) {
            b = "dummy_key";
        }
        return b;
    },
    getEndNoteCitation: function(a) {
        var b = this.getAuthorType(a);
        if (b) {
            var c = this.formatAuthors(a, {
                etAl: false,
                output: "last",
                includeItalics: false
            });
        } else {
            c = a.title || "[untitled item]";
            c = PP.String.interconvertString(c, {
                format: "nomarkup"
            });
        }
        c = c.split(",")[0];
        var d = a.published || {};
        var e = PP.library.Date.yearString(d);
        var f = c + ", " + e + ", " + a.cite_alias;
        return f;
    },
    hasPdf: function(a) {
        var b = this.getPdfAttachment(a);
        if (b) {
            return true;
        }
    },
    applyIdentifiersToNewPub: function(a, b) {
        if (a._id) {
            b._id = a._id;
        }
        if (a.citekey) {
            b.citekey = a.citekey;
        }
        if (a.gs_cluster_id) {
            b.gs_cluster_id = a.gs_cluster_id;
        }
        if (a.crawl_urls) {
            PP.library.Publication.addCrawlUrls(b, a.crawl_urls);
        }
        if (a.url) {
            for (var c = 0; c < a.url.length; c++) {
                this.addUrl(b, a.url[c]);
            }
        }
        if (a.source) {
            PP.Utils.merge(b.source, a.source);
            if (a.source.pdf_web_url) {
                this.addCrawlUrls(b, [ a.source.pdf_web_url ]);
                this.addUrl(b, a.source.pdf_web_url);
            }
        }
        if (a.starred !== undefined) {
            b.starred = a.starred;
        }
        if (a.attachments) {
            b.attachments = PP.Utils.clone(a.attachments);
        }
        this.autoClean(b);
    },
    applyTitleToNewPub: function(a, b) {
        var c = [ "title", "booktitle" ];
        c.forEach(function(c) {
            var d = a[c] || "";
            var e = b[c] || "";
            if (d && d != e) {
                var f = PP.String.interconvertString(d, {
                    format: "nomarkup"
                });
                var g = PP.String.interconvertString(e, {
                    format: "nomarkup"
                });
                if (f == g) {
                    if (c in b) {
                        b[c] = a[c];
                    }
                }
            }
        });
    },
    applyKeywordsToNewPub: function(a, b) {
        if (a.keywords) {
            var c = "";
            if (b.keywords) {
                var d = {};
                a.keywords.split(/[;,]/).forEach(function(a) {
                    a = a.replace(/^[\t\n\s]+/g, "");
                    a = a.replace(/[\t\n\s]+$/g, "");
                    d[a.toUpperCase()] = a;
                });
                var e = [];
                b.keywords.split(/[;,]/).forEach(function(a) {
                    a = a.replace(/^[\t\n\s]+/g, "");
                    a = a.replace(/[\t\n\s]+$/g, "");
                    if (!d[a.toUpperCase()]) {
                        d[a.toUpperCase()] = a;
                        e.push(a);
                    }
                });
                if (e.length > 0) {
                    c = "; " + e.join("; ");
                }
            }
            b.keywords = a.keywords + c;
        }
    },
    applyAllOtherAttributesToNewPub: function(a, b) {
        if (a && b) {
            if (a.pubtype == b.pubtype) {
                PP.library.PublicationFields.getFieldsForPubType(a.pubtype).forEach(function(c) {
                    if (c.fieldType == "general" || c.fieldType == "author") {
                        if (c.name in a && !(c.name in b)) {
                            if (a[c.name]) {
                                b[c.name] = PP.Utils.clone(a[c.name]);
                            }
                        }
                    }
                });
            }
        }
    },
    getXML: function() {
        var a = this;
        var b = '<?xml version="1.0" encoding="UTF-8"?>\n';
        b += "<pubtypes>\n";
        PP.library.PublicationTypes.getPubTypes().forEach(function(c) {
            b += "  <pubtype " + a.formatXMLattr({
                id: c.id,
                label: c.label,
                description: c.description
            }) + ">\n";
            b += "    <subtypes>\n";
            if (c.subtypes) {
                c.subtypes.forEach(function(a) {
                    b += '      <subtype name="' + PP.Utils.escapeXML(a.name) + '" />\n';
                });
            }
            b += "    </subtypes>\n";
            b += "    <fields>\n";
            PP.library.PublicationFields.getFieldsForPubType(c.id, {
                includeAll: true
            }).forEach(function(c) {
                b += "    <field " + a.formatXMLattr({
                    name: c.name,
                    label: c.label || "",
                    help: c.help || "",
                    type: c.fieldType,
                    mandatory: c.mandatory
                }) + "/>\n";
            });
            b += "    </fields>\n";
            b += "  </pubtype>\n";
        });
        b += "</pubtypes>\n";
        return b;
    },
    formatXMLattr: function(a) {
        var b = [];
        for (var c in a) {
            b.push(c + '="' + PP.Utils.escapeXML(a[c]) + '"');
        }
        return b.join(" ");
    }
});

PP.library.Publication = new PP.library._Publication();

PP.library._Render = PP.Class.extend({
    renderPub: function(a, b) {
        var c = {
            renderType: "autocomplete",
            searchTerms: ""
        };
        b = PP.Utils.apply(c, b);
        var d = b.renderType;
        if (d === "autocomplete") {
            return this.renderAutocomplete(a, b);
        } else if (d === "citation-grid-view") {
            return this.renderCitationGridView(a, b);
        } else if (d === "citation-details") {
            return this.renderCitationDetails(a, b);
        } else if (d === "pubview-error") {
            return this.renderPubViewError(a, b);
        } else if (d === "addon") {
            return this.renderAddon(a, b);
        } else if (d === "pubmed") {
            return this.renderPubMed(a, b);
        } else if (d === "word") {
            return this.renderWord(a, b);
        } else if (d === "bibguru") {
            return this.renderBibguru(a, b);
        } else {
            return this.renderAuthorYearJournal(a, b);
        }
    },
    renderAutocomplete: function(a, b) {
        var c = [ '<div class="pp-paper-panel-item pp-cite-autocomplete">', '  <div class="pp-paper-panel-title">', this.formatTitle(a, b), "  </div>", '  <div class="pp-paper-panel-authors">', this.formatAuthors(a, b), "  </div>", '  <div class="pp-paper-panel-reference">', this.formatReferenceLine(a, b), "  </div>", this.formatSnippets(a, b), "</div>" ].join("");
        return c;
    },
    renderAddon: function(a, b) {
        var c = [ '<div class="pp-paper-panel-item pp-cite-autocomplete">', '  <div class="pp-paper-panel-title">', this.formatTitle(a, b), "  </div>", '  <div class="pp-paper-panel-authors">', this.formatAuthors(a, b), "  </div>", '  <div class="pp-paper-panel-reference">', this.formatReferenceLine(a, b), this.getAddonEditLink(a, b), "  </div>", this.formatSnippets(a, b), '<div class="pp-search-item-button"></div><div class="dot-spinner"><div class="bounce1"></div><div class="bounce2"></div> <div class="bounce3"></div></div>', "</div>" ].join("");
        return c;
    },
    renderWord: function(a, b) {
        var c = [ '<div class="pp-title">', this.formatTitle(a, b), "  </div>", '  <div class="pp-authors">', this.formatAuthors(a, b), "  </div>", '  <div class="pp-reference">', this.formatReferenceLine(a, b), "  </div>", this.formatSnippets(a, b) ].join("");
        return c;
    },
    renderBibguru: function(a, b) {
        var c = [ '<div class="pp-title">', this.formatTitle(a, b), "  </div>", '  <div class="pp-authors">', this.formatAuthors(a, b), "  </div>", '  <div class="pp-reference">', this.formatReferenceLine(a, b), "  </div>", this.formatSnippets(a, b) ].join("");
        return c;
    },
    renderPubMed: function(a, b) {
        var c = a.titleDisplay || a.title || "Untitled Item";
        c = PP.String.interconvertString(c, {
            format: "html"
        });
        var d = "";
        if (a.abstractDisplay) {
            d = '<div class="pp-pubview-abstract">' + a.abstractDisplay + "</div>";
        }
        var e = [ '<div class="pp-paper-panel-item pp-cite-autocomplete">', '  <div class="pp-paper-panel-title">', '<div class="pp-grid-title"><span class="pp-grid-titletext">' + c + "</span></div>", "  </div>", '  <div class="pp-paper-panel-authors">', this.formatAuthors(a, b), "  </div>", '  <div class="pp-paper-panel-reference">', this.formatReferenceLine(a, b), "  </div>", d, "</div>" ].join("");
        return e;
    },
    renderCitationGridView: function(a, b) {
        var c = [ '<div class="' + this.getClasses(a, b) + '">', '  <div class="pp-grid-cursorblock"></div>', '  <div class="pp-grid-content pp-grid-collapsed">', "    <div>", this.formatTitle(a, b), '        <div class="pp-grid-authors">', this.formatAuthors(a, b), "        </div>", '        <div class="pp-grid-reference">', this.formatReferenceLine(a, b), "        </div>", '        <div class="pp-paper-panel-library-info">', this.getOwnerMessage(a, b), this.getEditLink(a, b), this.getLinkToPaperpile(a, b), "      </div>", "    </div>", "  </div>", "</div>" ].join("");
        return c;
    },
    renderCitationDetails: function(a, b) {
        var c = [ '<div class="pp-paper-panel-item">', '  <div class="pp-paper-panel-title">', this.formatTitle(a, b), "  </div>", '  <div class="pp-paper-panel-authors">', this.formatAuthors(a, b), "  </div>", '  <div class="pp-paper-panel-reference">', this.formatReferenceLine(a, b), "  </div>", '  <div class="pp-paper-panel-library-info">', this.getOwnerMessage(a, b), this.getCiteDetailsLinkToPaperpile(a, b), "  </div>", "</div>" ].join("");
        return c;
    },
    renderPubViewError: function(a, b) {
        var c = "";
        if (a) {
            c = [ '<div class="pp-pubview-pub">', '  <div class="pp-paper-panel-item">', '    <div class="pp-paper-panel-title">', this.formatTitle(a, b), "    </div>", '    <div class="pp-paper-panel-authors">', this.formatAuthors(a, b), "    </div>", '    <div class="pp-paper-panel-reference">', this.formatReferenceLine(a, b), "    </div>", "  </div>", this.formatPubViewAbstract(a, b), "</div>" ].join("");
        }
        var d = false;
        if (a && PP.Session.get("user_id")) {
            if (a.owner == PP.Session.get("user_id")) {
                d = true;
            }
        }
        var e = "try again";
        var f = PP.Globals.url("/troubleshooting#opening-attachments");
        var g = 'visit <a class="pp-link" href="' + f + '" target="_blank">Troubleshooting</a> for help.';
        var h = 'contact <a class="pp-link" fn="contactSupport">Paperpile support</a>';
        var i = "contact the item's owner";
        var j;
        if (d === true && b.isExtensionAvailable === true) {
            j = "Please " + e + ", " + h + " or " + g;
        } else if (d) {
            j = "Please " + e + " or " + g;
        } else {
            j = "Please " + e + ", " + i + " or " + g;
        }
        var k = [ '<div class="pp-pubview-error">', "  <p>" + b.errorMessage + "</p>", "  <p>" + j + "</p>", "</div>", c ].join("");
        return k;
    },
    renderAuthorYearJournal: function(a, b) {
        var c = PP.library.Publication.formatAuthorYear(a);
        var d = a.journal;
        var e = [ c, d ].join(", ");
        return e;
    },
    getClasses: function(a, b) {
        var c = [ "pp-grid-item" ];
        if (a.view_context_open === 1) {
            c.push("pp-grid-context-open");
        }
        if (a.view_pdf_context_open === 1) {
            c.push("pp-grid-pdf-context-open");
        }
        if (a.view_state.open_panel || a.view_state.search_open_panel) {
            c.push("pp-grid-panel-open");
            if (a.view_state.open_panel) {
                c.push("pp-grid-panel-open-" + a.view_state.open_panel);
            }
            if (a.view_state.search_open_panel) {
                c.push("pp-grid-panel-open-" + a.view_state.search_open_panel);
            }
        }
        if (PP.library.Publication.isIncomplete(a)) {
            c.push("pp-grid-incomplete");
        }
        if (b.extraClasses) {
            c = c.concat(b.extraClasses);
        }
        return c.join(" ");
    },
    formatAddToCitationSection: function(a, b) {
        var c = "pp-paper-panel-add";
        var d = "ADD_TO_CITATION";
        if (a.addedToCitation) {
            c = "pp-paper-panel-add pp-paper-panel-added";
        } else if (a.addingToCitation) {
            c = "pp-paper-panel-add pp-paper-panel-adding";
        }
        return [ '  <div class="' + c + '" ', d ? 'action="' + d + '"' : "", "></div>" ].join("");
    },
    getOwnerMessage: function(a, b) {
        var c = PP.Session.get("user_id");
        var d = a.owner;
        var e = a.owner_email;
        var f = a.owner_name;
        var g = "";
        if (c === d) {
            g = "Added by you";
        } else {
            if (f) {
                g = "Added by " + f;
            } else if (e) {
                if (e === "anonymous@example.com") {
                    g = "Added by an anonymous collaborator";
                } else {
                    g = "Added by " + e;
                }
            } else {
                g = "Added by another user";
            }
        }
        var h = "";
        var i = a.created;
        if (i) {
            var j = new Date(i * 1e3);
            var k = moment(j);
            h = "Added " + k.fromNow();
        }
        return [ '<div class="pp-cite-details-user" ppTip="' + h + '">', g, "</div>" ].join("");
    },
    getTweetStyleTime: function(a, b) {
        var b = b || new Date(), a = moment(a).valueOf(), b = moment(b).valueOf(), c = Math.round(Math.abs(b - a) / 60 / 1e3), d = Math.round(Math.abs(b - a) / 1e3);
        var e = Math.round(Math.abs(b - a) / 60 / 1e3 / 60);
        var f = Math.round(Math.abs(b - a) / 60 / 1e3 / 60 / 24);
        if (c < 2) {
            return d < 60 ? d + "s" : "1m";
        } else if (c < 60) {
            return c + "m";
        } else if (c < 1440) {
            return Math.round(c / 60) + "h";
        } else if (e < 48) {
            return Math.round(e) + "h";
        } else if (f < 7) {
            return Math.round(f) + "d";
        } else {
            var g = new Date().getYear() == new Date(a).getYear();
            return moment(a).format(g ? "D MMM" : "D MMM YY");
        }
    },
    getEditLink: function(a, b) {
        return [ '<div class="pp-action-container">', '<span class="pp-link pp-action" action="EDIT">Edit</span>', " / ", '<span class="pp-link pp-action" action="CITEVIEW_DELETE">Delete</span>', "</div>" ].join("");
    },
    getCiteDetailsLinkToPaperpile: function(a, b) {
        var c = PP.Session.get("user_id");
        var d = a.owner;
        var e = c && c === d;
        if (e) {
            return [ '<div class="pp-cite-details-linkout">', '<a class="pp-link" ', 'cite_alias="' + a.cite_alias + '" source_id="' + a.source_id + '" ', 'action="OPEN_CITATION_IN_PAPERPILE"', ">Open in Paperpile</a>", "</div>" ].join("");
        } else {
            var f = PP.write.CitationStore.documentSettings;
            if (f) {
                var g = PP.Globals.getUrlBase();
                var h = g + "/c/" + f.doc_alias + "/" + a.cite_alias;
                return [ '<div class="pp-cite-details-linkout">', '<a target="_blank" class="pp-link" href="' + h + '">View / edit reference</a>', "</div>" ].join("");
            } else {
                return "";
            }
        }
    },
    getAddonEditLink: function(a, b) {
        var c = PP.Session.get("user_id");
        var d = a.owner;
        var e = c && c === d;
        var f;
        if (a && a.source) {
            f = a.source.quick_result_plugin;
        }
        if (f && !(a._searchSource === "local")) {
            return '<div class="pp-webresult-byline"><span class="pp-paper-panel-source">From ' + f + ' </span> <div class="pp-details-link-container"><span class="pp-details-link" forid="' + a._id + '" id="info-panel-toggle-' + a._id + '" >&hellip;</span></div></div>';
        } else {
            return '<div class="pp-details-link-container"><span class="pp-details-link" forid="' + a._id + '" id="info-panel-toggle-' + a._id + '" >&hellip;</span></div>';
        }
    },
    getLinkToPaperpile: function(a, b) {
        var c = PP.Session.get("user_id");
        var d = PP.Globals.isChrome();
        var e = true;
        var f;
        var g;
        if (a.source) {
            f = a.source.quick_result_status;
            g = a.source._existing_pub_data != undefined;
        }
        var h = a.owner;
        var i = c && c === h;
        var j, k, l, m;
        if (!c || !d) {
            e = false;
            j = "pp-ready";
            k = "SHOW_MARKETING_DIALOG";
            l = "Add to My Library";
            m = "Get Paperpile to add papers<br/>to your personal web library";
        } else if (i) {
            j = "pp-exists";
            k = "OPEN_CITATION_IN_PAPERPILE";
            l = "Open in Paperpile";
            m = "You cited this paper.<br/>Click to open in Paperpile";
        } else if (g) {
            j = "pp-exists";
            k = "OPEN_CITATION_IN_PAPERPILE";
            l = "Open in Paperpile";
            m = "You have this paper in your library.<br/>Click to open in Paperpile";
        } else if (c && c !== h) {
            var n = a.source.quick_result_status;
            if (n && n.match(/ready/i)) {
                j = "pp-ready";
                k = "ADD_CITATION_TO_PAPERPILE";
                l = "Add to Library";
                m = "Click to copy this paper to your library";
            } else if (n && n.match(/working/i)) {
                j = "pp-working";
                k = "";
                l = "Adding...";
                m = "";
            } else if (n && n.match(/error/i)) {
                j = "pp-error";
                k = "REPORT_CITATION_ADD_ERROR";
                l = "Error";
                m = "Something went wrong &mdash; click to report this error.";
            } else if (n && n.match(/success/i)) {
                j = "pp-success";
                k = "OPEN_CITATION_IN_PAPERPILE";
                l = "Added to Library";
                m = "Added successfully.<br/>Click to open in Paperpile";
            }
        }
        if (!e) {
            return "";
        }
        var o = 'ppTip="' + m + '"';
        return [ '<div class="pp-citations-container ' + j + '" style="display:inline-block">', '  <div class="pp-citations-button ' + j + '" ' + o + ' action="' + k + '">', l, "  </div>", "</div>" ].join("");
    },
    selectionTickOnly: function(a) {
        return [ '<div class="pp-grid-grabstar-wrap">', this.selectionTickRegion(a), "</div>" ].join("");
    },
    grabRegion: function(a) {
        return '<div class="pp-grid-grab"><span class="icon" ppTip="Drag to add a folder or label"></span></div>';
    },
    starRegion: function(a) {
        if (a.starred) {
            return '<span class="pp-grid-star pp-star-filled pp-grid-button" action="TOGGLE_STAR"><span class="icon"></span></span>';
        } else {
            return '<span class="pp-grid-star pp-grid-button" action="TOGGLE_STAR"><span class="icon"></span></span>';
        }
    },
    selectionTickRegion: function(a) {
        return '<div class="pp-grid-selection-tick pp-grid-button" action="TOGGLE_SELECTION"><span class="icon"></span></div>';
    },
    searchIconRegion: function(a) {
        if (a.view_state.search_open_panel === "snippets") {
            return [ '<div class="pp-grid-snippet">', "</div>" ].join("");
        }
    },
    formatSnippets: function(a, b) {
        PP.library.Snippets.createSnippets(a, b);
        var c = [];
        var d = "";
        if (a.snippets) {
            a.snippets.forEach(function(a) {
                var b = '<span class="pp-snippet-type">' + a.type + "</span>";
                var d = '<div class="raster-u-22-24 pp-snippet-text">' + b + a.text + "</div>";
                c.push([ '<div class="pp-snippet raster">', '<div class="raster-u-1-24"></div>', d, "</div>" ].join(""));
            });
            d = c.join("");
            return [ '<div class="pp-grid-snippet-container">', d, "</div>" ].join("");
        } else {
            return "";
        }
    },
    formatTitle: function(a, b) {
        var c = a.title || "Untitled Item";
        if (c == "Untitled Item") {
            var d;
            if (a.pubtype == "PP_LETTER" || a.pubtype == "PP_PERSONAL_COMMUNICATION") {
                if ("editor" in a && a.editor.length) d = a.editor[0];
            } else if (a.pubtype == "PP_INTERVIEW") {
                if ("author" in a && a.author.length) d = a.author[0];
            }
            if (d) {
                var e;
                if (d.first && d.last) {
                    e = d.first + " " + d.last;
                } else if (d.initials && d.last) {
                    e = d.initials + " " + d.last;
                } else if (d.collective) {
                    e = d.collective;
                } else if (d.last) {
                    e = d.last;
                }
                if (e) {
                    if (a.pubtype == "PP_LETTER") c = "Letter to ";
                    if (a.pubtype == "PP_PERSONAL_COMMUNICATION") c = "Personal communication with ";
                    if (a.pubtype == "PP_INTERVIEW") c = "Interview with ";
                    c += e;
                }
            }
        }
        c = PP.String.interconvertString(c, {
            format: "html"
        });
        c = this.highlight(c, b);
        var f = "";
        var g = "";
        if (b.includeActions) {
            if (a["abstract"]) {
                f = "pp-grid-clickable-title";
                var h = a.view_state || {};
                var i = h.open_panel;
                if (i === "abstract") {
                    g = 'onlyonclick="true" action="GRID_CLOSE_ABSTRACT"';
                } else {
                    g = 'onlyonclick="true" action="GRID_OPEN_ABSTRACT"';
                }
            }
        }
        var j = a.title ? "" : "pp-grid-no-title";
        if (a.pubtype == "PP_LETTER" || a.pubtype == "PP_PERSONAL_COMMUNICATION" || a.pubtype == "PP_INTERVIEW") {
            if (c != "Untitled Item") j = "";
        }
        return [ '<div class="pp-grid-title ' + j + '">', "<span " + g + ' class="pp-grid-titletext ' + f + '">' + c + "</span>", "</div>" ].join("").replace(/\s+/g, " ").replace(/\s+"/g, '"');
    },
    formatAuthors: function(a, b) {
        var c = 80;
        var d = {
            prefix: '<span class="pp-author">',
            suffix: "</span>",
            delim: ", ",
            output: "display",
            othersString: "&hellip;"
        };
        var e = {
            prefix: "",
            suffix: "",
            delim: ", ",
            output: "display",
            othersString: "..."
        };
        var f = parseInt(c / 6) + 1;
        var g = {
            author: [],
            editor: [],
            contributor: [],
            series_editor: [],
            translator: []
        };
        for (var h in g) {
            if (a[h]) {
                g[h] = a[h].slice(0, f > a[h].length ? a[h].length : f);
            }
        }
        var i = PP.library.Publication.formatAuthors(g, d);
        var j;
        var k = PP.library.Publication.getAuthorType(g);
        if (k) {
            var l = a[k];
            var m = [];
            for (var n = 0; n < l.length; n++) {
                var o = l[n];
                if (o.collective === "et al.") {
                    m.push(o);
                } else if (PP.library.Author.toString(o) === "") {
                    continue;
                } else {
                    m.push(o);
                }
            }
            l = m;
            j = PP.library.Author.toString(l, e);
            var p = l.length;
            var q = l.length;
            var r = 0;
            while (j.length > c) {
                q--;
                var s = l.slice(0, q);
                var t = l.slice(q, l.length);
                r = t.length;
                j = [ PP.library.Author.toString(s, e), r > 0 ? " et al." : "" ].join("");
                i = [ PP.library.Author.toString(s, d), r > 0 ? " <i>et al.</i>" : "" ].join("");
            }
        }
        if (i === "[No author]") {
            return "";
        }
        b.allowShortStrings = true;
        return this.highlight(i, b);
    },
    formatReferenceLine: function(a, b) {
        var c;
        if (a && a.source) {
            c = a.source.quick_result_plugin;
        }
        var d = "";
        if (c && b && !a.cite_alias && b.renderType !== "citation-grid-view" && b.renderType !== "addon" && !(a._searchSource == "local")) {
            d = [ '<span class="pp-paper-panel-source">', " from " + c, "</span>" ].join("");
        }
        var e = false;
        var f = this.formatJournal(a, b);
        if (!f && a.publisher) {
            f = a.publisher;
        } else if (!f) {
            if (a.pubtype === "PP_BOOK") {
                f = "No publisher";
                e = true;
            } else if (a.pubtype === "PP_WEBSITE") {
                if (a.url && a.url.length > 0) {
                    f = a.url[0].replace(/([\.\/_])/g, "$1<wbr>");
                }
            } else if (a.pubtype === "PP_LETTER" || a.pubtype === "PP_MAP" || a.pubtype === "PP_STANDARD" || a.pubtype === "PP_FIGURE" || a.pubtype == "PP_PRESENTATION" || a.pubtype == "PP_COMPUTER_PROGRAM" || a.pubtype == "PP_MANUAL" || a.pubtype == "PP_PERSONAL_COMMUNICATION" || a.pubtype == "PP_UNPUBLISHED" || a.pubtype == "PP_MISC") {
                f = "";
            } else if (a.pubtype == "PP_BILL") {
                f = a.legislative_body ? a.legislative_body : "";
            } else {
                f = "No journal";
                e = true;
            }
        }
        var g = e ? " pp-paper-panel-empty" : "";
        var h = this.surroundIf('<span class="pp-paper-panel-journal' + g + '">', f, "</span>");
        var i = this.surroundIf('<span class="pp-paper-panel-year' + g + '">', this.formatYear(a, b), "</span>");
        var j = this.surroundIf('<span class="pp-paper-panel-citedby">', this.formatCitedBy(a, b), "</span>");
        var k = [ h, i ];
        k = k.filter(function(a) {
            return a != "";
        });
        var l = k.join(", ");
        var m = [ d, j ];
        m = m.filter(function(a) {
            return a != "";
        });
        var n = m.join('<span class="pp-paper-panel-sep">|</span>');
        return [ l, n ].join(" ").replace(/\s+$/, "").replace(/\s+/g, " ");
    },
    formatEditLink: function(a, b) {
        if (a.cite_alias) {
            return a.cite_alias;
        } else {
            return "";
        }
    },
    formatPubViewAbstract: function(a, b) {
        if (a["abstract"]) {
            return [ '<div class="pp-pubview-abstract">', a["abstract"], "</div>" ].join("");
        } else {
            return "";
        }
    },
    surroundIf: function(a, b, c) {
        if (!b) {
            return "";
        } else {
            return a + b + c;
        }
    },
    formatCitedBy: function(a, b) {
        var c = "";
        if (a.gs_cited_by_count !== undefined) {
            return "cited by " + a.gs_cited_by_count;
        } else if (a.pubmed_cited_by_count !== undefined) {
            return "cited by " + a.pubmed_cited_by_count;
        } else {
            return "";
        }
    },
    formatYear: function(a, b) {
        var c = a.published || {};
        var d = PP.library.Date.yearString(c);
        d = this.highlight(d, b);
        return d;
    },
    formatJournal: function(a, b) {
        var c = "";
        if (a.pubtype == "PP_CONFERENCE_PAPER" || a.pubtype == "PP_WEBSITE") {
            c = a.booktitle;
        } else if (a.pubtype == "PP_BOOK_CHAPTER") {
            c = PP.String.interconvertString(a.booktitle, {
                format: "html"
            });
        } else if (a.pubtype == "PP_THESIS") {
            c = a.school;
        } else if (a.pubtype == "PP_MANUSCRIPT") {
            c = a.series;
        } else if (a.pubtype == "PP_ARTWORK" || a.pubtype == "PP_REPORT") {
            c = a.institution;
        } else if (a.pubtype == "PP_LETTER" || a.pubtype === "PP_MAP" || a.pubtype === "PP_STANDARD" || a.pubtype === "PP_FIGURE" || a.pubtype == "PP_PRESENTATION" || a.pubtype == "PP_COMPUTER_PROGRAM" || a.pubtype == "PP_MANUAL" || a.pubtype == "PP_PERSONAL_COMMUNICATION" || a.pubtype == "PP_UNPUBLISHED" || a.pubtype == "PP_MISC") {
            c = "";
        } else {
            c = a.journal;
        }
        c = this.highlight(c, b);
        return c;
    },
    highlight: function(a, b) {
        if (!a || a == "") {
            return a;
        }
        if (!b.searchTerms) {
            return a;
        }
        b = b || {};
        var c = b.searchTerms;
        var d = [];
        if (c) {
            d = c.split(/\s+/);
        }
        d = PP.Array.filter(d, function(a) {
            if (b.allowShortStrings !== true && a.length <= 2) {
                return false;
            } else if (a !== "") {
                return true;
            }
        });
        for (var e = 0; e < d.length; e++) {
            d[e] = PP.Utils.removeQuotationMarksAndPunctation(d[e]);
        }
        d = PP.Array.unique(d.sort(function(a, b) {
            return b.length - a.length;
        }));
        var f, g;
        for (var e = 0; e < d.length; e++) {
            g = d[e].replace(/[-[\]{}()*+?.,\\^$|#]/g, "\\$&");
            if (g.length <= 2) {
                f = new RegExp("(<\\/?\\w+(\\s+\\w+(\\s*=\\s*(\"[^\"]*\"|'[^']*'|\\S+))?)*>)" + "|\\b(" + g + ")\\b", "ig");
            } else {
                f = new RegExp("(<\\/?\\w+(\\s+\\w+(\\s*=\\s*(\"[^\"]*\"|'[^']*'|\\S+))?)*>)" + "|(" + g + ")", "ig");
            }
            a = this.replaceOutsideTags(a, f);
        }
        return a;
    },
    replaceOutsideTags: function(a, b) {
        a = a.replace(b, function(a, b, c, d, e, f) {
            if (b) {
                return b;
            } else {
                f = f.replace(/<\//g, "");
                return '<span class="pp-grid-highlight">' + f + "</span>";
            }
        });
        return a;
    }
});

PP.library.Render = new PP.library._Render();

PP.library._Serialization = PP.Class.extend({
    serialize: function(a, b) {
        var c = PP.library.PublicationFields.getFields();
        var d = {};
        for (var e = 0; e < c.length; e++) {
            var f = c[e];
            var g = c[e].name;
            var h = PP.library.PublicationFields.getFieldType(g);
            var i = PP.library.PublicationFields.getDataType(g);
            if (f.export_persist === false) {
                continue;
            }
            if (h === "author") {
                var j = a[g];
                if (j && j.length > 0) {
                    d[g] = PP.library.Author.toString(j, {
                        delim: "; ",
                        output: "serialize"
                    });
                    a[g + "_origString"] = d[g];
                }
            } else if (h === "date") {
                var k = a[g];
                if (k) {
                    d[g] = PP.library.Date.toString(k, b);
                    a[g + "_origString"] = d[g];
                }
            } else if (i === "array") {
                var l = a[g];
                if (l && PP.Utils.isArray(l) && l.length > 0) {
                    d[g] = l.join("\n");
                    a[g + "_origString"] = d[g];
                }
            } else {
                if (a[g] !== undefined) {
                    d[g] = a[g] + "";
                }
            }
        }
        for (var m in d) {
            if (!PP.Utils.isString(d[m])) {
                throw new Error("Key " + m + " in serialized pub is not a string!");
            }
        }
        return PP.Utils.clone(d);
    },
    unserializeField: function(a, b) {
        var c = PP.library.PublicationFields.getFieldsMap();
        var d = c[a];
        if (!d) {
            console.log("Field not found", a);
            return b;
        }
        parseOptions = {
            delimiter: ";",
            familyNameFirst: false
        };
        var e = d.fieldType;
        var f = d.dataType;
        if (f === "array" && b === "") {
            return undefined;
        }
        if (e === "author") {
            var g = PP.library.Author.parseAuthorList(b, parseOptions);
            return g;
        } else if (e === "date") {
            var g = PP.library.Date.parseDate(b);
            return g;
        } else if (f === "array") {
            var h = b;
            var i = h.split(/\n/g);
            return i;
        } else {
            return b;
        }
    },
    unserialize: function(a, b) {
        a = PP.Utils.clone(a);
        var c = {};
        if (b === undefined) {
            b = {
                delimiter: ";",
                familyNameFirst: false
            };
        }
        var d = PP.library.PublicationFields.getFields();
        for (var e = 0; e < d.length; e++) {
            var f = d[e].name;
            var g = d[e].fieldType;
            var h = d[e].dataType;
            if (a[f] !== undefined) {
                if (h === "array" && a[f] === "") {
                    c[f] = undefined;
                    continue;
                }
                if (g === "author") {
                    var i = PP.library.Author.parseAuthorList(a[f], b);
                    c[f] = i;
                } else if (g === "date") {
                    var i = PP.library.Date.parseDate(a[f]);
                    c[f] = i;
                } else if (h === "array") {
                    var j = a[f];
                    var k = j.split(/\n/g);
                    c[f] = k;
                } else {
                    c[f] = a[f];
                }
            }
        }
        return c;
    }
});

PP.library.Serialization = new PP.library._Serialization();

PP.library._Snippets = PP.Class.extend({
    createSnippets: function(a, b) {
        var c = b.searchTerms || "";
        var d = c.split(/\s+/);
        d = PP.Array.filter(d, function(a) {
            if (a !== "") {
                return true;
            }
        });
        if (d.length > 0) {
            var e = [];
            d.forEach(function(a) {
                a = PP.Utils.escapeRegex(a);
                e.push(new RegExp(a, "ig"));
            });
            var f = true;
            var g = {
                delim: ",",
                output: "display"
            };
            var h = PP.library.Publication.formatAuthors(a, g);
            for (var i = 0; i < e.length; i++) {
                var j = e[i];
                if (j.test(a["title"]) || j.test(a["journal"]) || j.test(h)) {
                    continue;
                } else {
                    f = false;
                    break;
                }
            }
            if (f === false) {
                var k = [];
                if (a["abstract"]) {
                    var l = a["abstract"];
                    l = l.replace(/(<([^>]+)>)/g, "&nbsp;");
                    l = l.replace(/&nbsp;/g, " ");
                    var m = this.getSnippet(e, l, b);
                    if (m) {
                        m.type = "Abstract";
                        k.push(m);
                    }
                }
                if (a["note"]) {
                    var l = a["note"];
                    l = l.replace(/(<([^>]+)>)/g, "&nbsp;");
                    l = l.replace(/&nbsp;/g, " ");
                    var m = this.getSnippet(e, l, b);
                    if (m) {
                        m.type = "Notes";
                        k.push(m);
                    }
                }
                if (k.length > 0) {
                    a.snippets = k;
                    if (a.view_state) {
                        a.view_state.search_open_panel = "snippets";
                    }
                }
            } else {
                if (a.view_state) {
                    delete a.view_state.search_open_panel;
                }
            }
        } else {
            if (a.view_state) {
                delete a.view_state.search_open_panel;
            }
        }
    },
    getSnippet: function(a, b, c) {
        var d = [];
        for (var e = 0; e < a.length; e++) {
            var f = a[e];
            var g = [];
            var h;
            while ((h = f.exec(b)) !== null) {
                var i = h.index;
                var j = h[0].length;
                var k = {};
                k[h[0]] = 1;
                var l = {
                    left: i,
                    right: i + j,
                    tokens: k
                };
                d.push(l);
            }
        }
        var m = 30;
        this.mergeMatches(d, m);
        d.sort(function(a, b) {
            var c = Object.keys(a.tokens).length;
            var d = Object.keys(b.tokens).length;
            return d - c;
        });
        var n = [];
        var o = {};
        var p = {};
        for (var e = 0; e < d.length; e++) {
            var q = d[e];
            var r = false;
            var s = Object.keys(q.tokens);
            for (var t = 0; t < s.length; t++) {
                if (!o[s[t]]) {
                    r = true;
                    break;
                }
            }
            if (r) {
                n.push(this.getTextRange(q, b));
                PP.Utils.apply(o, q.tokens);
                p[e] = 1;
            }
        }
        var u = 350;
        for (var e = 0; e < d.length; e++) {
            var q = d[e];
            if (p[e]) {
                continue;
            }
            var v = this.getTextRange(q, b);
            var w = v[1] - v[0];
            if (this.getCombinedLength(n) + w >= u) {
                break;
            } else {
                n.push(v);
            }
        }
        n.sort(function(a, b) {
            return a[0] - b[0];
        });
        this.mergeRanges(n);
        var x = [];
        n.forEach(function(a) {
            var d = b.substring(a[0], a[1]);
            d = PP.library.Render.highlight(d, c);
            x.push(d);
        });
        var y = '<span class="pp-snippet-ellipsis">&hellip;</span>';
        var z = y + " " + x.join(" " + y + " ") + "" + y;
        if (x.length > 0) {
            return {
                text: z
            };
        } else {
            return null;
        }
    },
    getCombinedLength: function(a) {
        var b = 0;
        a.forEach(function(a) {
            b += a[1] - a[0];
        });
        return b;
    },
    getTextRange: function(a, b) {
        var c = 15;
        var d = 2;
        var e, f;
        e = Math.max(0, a.left - 500);
        f = a.left;
        var g = b.substring(e, f);
        var h = g.split("").reverse().join("");
        var i = this.expandOnPunctuation(h, 5, 15);
        var j = a.left - i;
        e = a.right;
        f = Math.min(b.length, a.right + 500);
        var k = b.substr(e, f);
        var l = this.expandOnPunctuation(k, 5, 15);
        var m = a.right + l;
        return [ j, m ];
    },
    expandOnPunctuation: function(a, b, c) {
        var d = a.split(/[\.,;!\?]/);
        var e = 0;
        var f = 0;
        for (var g = 0; g < d.length; g++) {
            var h = d[g];
            var i = h.split(/\s+/);
            var j = e + i.length;
            for (var k = 0; k < i.length; k++) {
                if (e > b && j > c) {
                    return f - 1;
                } else if (e > c) {
                    return f - 1;
                }
                e++;
                f += i[k].length + 1;
            }
        }
        return f;
    },
    mergeRanges: function(a) {
        for (var b = 0; b < a.length; b++) {
            for (var c = b + 1; c < a.length; c++) {
                var d = a[b];
                var e = a[c];
                var f = false;
                if (this.rangesOverlap(d, e)) {
                    f = true;
                }
                if (f) {
                    a.splice(b, 1);
                    a.splice(c - 1, 1);
                    var g = [];
                    g[0] = Math.min(d[0], e[0]);
                    g[1] = Math.max(d[1], e[1]);
                    a.push(g);
                    this.mergeRanges(a);
                    return;
                }
            }
        }
    },
    rangesOverlap: function(a, b) {
        var c = 0;
        var d = a[0] - c;
        var e = a[1] + c;
        var f = b[0] - c;
        var g = b[1] + c;
        if (d > f && d < g) {
            return true;
        } else if (f > d && f < e) {
            return true;
        } else {
            return false;
        }
    },
    mergeMatches: function(a, b) {
        var c = a.length;
        for (var d = 0; d < a.length; d++) {
            for (var e = d + 1; e < a.length; e++) {
                var f = a[d];
                var g = a[e];
                var h = false;
                if (this.matchesOverlap(f, g, b)) {
                    h = true;
                }
                if (h) {
                    a.splice(d, 1);
                    a.splice(e - 1, 1);
                    var i = {};
                    PP.Utils.apply(i, f.tokens);
                    PP.Utils.apply(i, g.tokens);
                    a.push({
                        left: Math.min(f.left, g.left),
                        right: Math.max(f.right, g.right),
                        tokens: i
                    });
                    this.mergeMatches(a, b);
                    return;
                }
            }
        }
    },
    matchesOverlap: function(a, b, c) {
        var d = a.left - c;
        var e = a.right + c;
        var f = b.left - c;
        var g = b.right + c;
        if (d > f && d < g) {
            return true;
        } else if (f > d && f < e) {
            return true;
        } else {
            return false;
        }
    }
});

PP.library.Snippets = new PP.library._Snippets();

PP.format.AbstractReader = PP.Class.extend({
    includes: [ PP.Events ],
    debug: true,
    canRead: function() {
        return this["doRead"] !== undefined;
    },
    getName: function() {
        return "Abstract Reader";
    },
    doRead: undefined,
    isAsync: function() {
        return false;
    },
    getXMLParser: function(a) {
        var b;
        var c = false;
        if (window) {
            if (window.chrome) c = true;
            if (window.navigator && window.navigator.userAgent && window.navigator.userAgent.match(/PhantomJS/i)) c = true;
        }
        if (isBrowserEnvironment()) {
            var d = new DOMParser();
            b = d.parseFromString(a, "text/xml");
        } else {
            b = $xmlNodeJs(a);
        }
        return b;
    },
    _getAttribute: function(a, b) {
        return PP.Utils.getHtmlAttribute(a, b);
    },
    _setAttribute: function(a, b, c) {
        if ("attribs" in a) {
            a.attribs[b] = c;
        } else {
            a.setAttribute(b, c);
        }
    },
    syncRead: function(a, b) {
        var c = this;
        var d = c.doRead(a, b);
        for (var e = 0; e < d.length; e++) {
            PP.library.Publication.autoClean(d[e]);
            d[e].source.format = c.getName();
            if (!d[e].source.format.match(/bibtex/i)) {
                if (d[e].title) {
                    d[e].title = PP.String.escapeBraces(d[e].title);
                }
                if (d[e].booktitle) {
                    d[e].booktitle = PP.String.escapeBraces(d[e].booktitle);
                }
            }
        }
        return d;
    },
    read: function(a, b, c) {
        var d = new Date().getTime();
        var e = this;
        var f = function(a, c) {
            if (c) {
                PP.Utils.callback(b, null, [ null, c ]);
            } else {
                var f = new Date().getTime();
                var g = a ? a.length : 0;
                if (g > 10) {
                    PP.log({
                        type: "performance",
                        subtype: "Parsing file",
                        format: e.getName(),
                        pubCount: g,
                        start: d,
                        end: f,
                        duration: f - d
                    });
                }
                for (var h = 0; h < a.length; h++) {
                    PP.library.Publication.autoClean(a[h]);
                    a[h].source.format = e.getName();
                    if (!a[h].source.format.match(/bibtex/i)) {
                        if (a[h].title) {
                            a[h].title = PP.String.escapeBraces(a[h].title);
                        }
                        if (a[h].booktitle) {
                            a[h].booktitle = PP.String.escapeBraces(a[h].booktitle);
                        }
                    }
                }
                PP.Utils.callback(b, null, [ a, null ]);
            }
        };
        if (e.isAsync()) {
            e.doRead(a, f, c);
        } else {
            PP.Utils.defer(function() {
                try {
                    var b = e.doRead(a, c);
                    f.apply(e, [ b, null ]);
                } catch (a) {
                    var d = a.message;
                    PP.log({
                        type: "error",
                        subtype: 'Error parsing "' + e.getName() + '" string into a pub',
                        msg: "Encountered error: " + d
                    });
                    f.apply(e, [ null, d ]);
                }
            }, 20);
        }
    },
    canWrite: function() {
        return this["doWrite"] !== undefined;
    },
    doWrite: undefined,
    write: function(a, b) {
        return this.doWrite(a, b);
    },
    jsonMapToPaperpileFields: function(a, b) {
        var c = this;
        var d, e, f, g, h;
        var i = {};
        var j = undefined;
        if (c.getName().match(/mendeley/i)) {
            j = "mendeley";
        } else if (c.getName().match(/zotero/i)) {
            j = "zotero";
        }
        var k = PP.library.PublicationFields.getInputMapForPubType(b, j);
        for (d in a) {
            if (PP.Utils.isObject(a[d]) && !PP.Utils.isArray(a[d])) {
                for (f in a[d]) {
                    a[d + "." + f] = a[d][f];
                }
            }
        }
        for (d in a) {
            var l = d.toLowerCase();
            if (l in k) {
                h = k[l];
                g = a[d];
                if (!i[h]) i[h] = [];
                i[h].push(g);
            }
        }
        return i;
    },
    jsonIninitalizeValue: function(a) {
        var b = {};
        var c = a.split(/\./);
        if (c && c[1]) {
            b[c[0]] = {};
            b[c[0]][c[1]] = undefined;
        } else {
            b[c[0]] = undefined;
        }
        return b;
    },
    jsonGetPubtypeAndKind: function(a) {
        var b = this;
        var c = undefined;
        if (b.getName().match(/mendeley/i)) {
            c = "mendeley";
        } else if (b.getName().match(/zotero/i)) {
            c = "zotero";
        }
        return PP.library.PublicationTypes.getInputTypeForPub(a.toUpperCase(), c);
    },
    jsonCheckISSN: function(a) {
        var b = {};
        var c = a.split(/\s*[,;]\s*/);
        var d = PP.library.Publication.checkValidityOfISSN(c[0]);
        if (d !== "") {
            b["issn"] = d;
            if (c[1]) {
                d = PP.library.Publication.checkValidityOfISSN(c[1]);
                if (d !== "") b["issn_alt"] = d;
            }
        }
        return b;
    },
    jsonCheckISBN: function(a) {
        var b = {};
        var c = PP.Utils.extractISBNs(a, {
            convert: true,
            unique: true
        });
        if (c[0]) b.isbn = c[0];
        if (c[1]) b.isbn_alt = c[1];
        return b;
    },
    jsonSetValue: function(a, b, c) {
        if (b[a] === undefined) {
            b[a] = c;
        } else if (PP.Utils.isObject(b[a])) {
            var d = [];
            for (var e in b[a]) d.push(e);
            if (d.length === 1) {
                b[a][d[0]] = c + "";
            } else {
                b[a] = undefined;
            }
        }
    },
    jsonAssignValuesToPub: function(a, b) {
        for (var c in a) {
            if (a[c] === undefined) continue;
            if (PP.Utils.isString(a[c]) || PP.Utils.isArray(a[c])) {
                if (a[c].length === 0) continue;
            }
            if (c in b) {
                if (PP.Utils.isObject(a[c])) {
                    for (var d in a[c]) {
                        b[c][d] = a[c][d];
                    }
                } else {
                    b[c] = a[c];
                }
            } else {
                b[c] = a[c];
            }
        }
    },
    statics: {
        guessFormat: function(a, b) {
            b = b || "";
            var c = a.split(/[\n\r]/);
            var d = c.length < 50 ? c.length : 50;
            var e = {
                Bibtex: /\.bib$/i,
                Ris: /\.ris$/i,
                ISI: /\.ciw$/i,
                EndNote: /\.enw$/i,
                EndNote: /\.xml$/i
            };
            for (var f in i) {
                var g = i[f];
                var h = b.match(g);
                if (h) {
                    return f;
                }
            }
            var i = {
                Bibtex: /^\s*\@[A-Z]+\s*\{/i,
                Ris: /^\s*TY\s+-\s+/,
                EndNote: /^%0\s/,
                EndNote: /^<\?xml\sversion="1\.0"\sencoding="UTF-8"\s\?><xml><records>/,
                EndNote: /^<\?xml\sversion="1\.0"\sencoding="UTF-8"/,
                PubMedXML: /^<PubmedArticle/,
                ISI: /^PT\s+(J|S|P|R)\s*/,
                PaperpileJSON: /%%PAPERPILEJSONEXPORT%%/
            };
            for (var f in i) {
                var g = i[f];
                for (var j = 0; j < d; j++) {
                    var h = c[j].match(g);
                    if (h) {
                        return f;
                    }
                }
            }
            return null;
        },
        parseFromMessage: function(a, b) {
            var c = a.blobUrl;
            PP.Ajax.request({
                url: c,
                callback: function(a, c, d) {
                    if (c !== "success") {
                        console.log("ERROR GETTING TEXT");
                    } else {
                        var e = d.responseText;
                        var f = PP.format.AbstractReader.guessFormat(e);
                        if (!f) {
                            f = "References";
                        }
                        var g = PP.format[f];
                        var h = function(a) {
                            PP.Msg.sendMessage({
                                parseProgress: true,
                                progress: a.progress
                            });
                        };
                        var i = function(a, c) {
                            if (c) {
                                PP.Msg.callback(b, [ null, c ]);
                            } else {
                                a.forEach(function(a) {
                                    a.source.quick_result_type = "clipboard";
                                    a.source.quick_result_plugin = f;
                                    a.source.quick_result_status = "ready";
                                });
                                PP.Msg.callback(b, [ a, null ]);
                            }
                        };
                        g.on("progress", h);
                        var j = {};
                        g.read(e, i, j);
                    }
                }
            });
        }
    }
});

PP.format._Amazon = PP.format.AbstractReader.extend({
    doRead: function(a) {
        var b = this._readHTML(a);
        PP.library.Publication.autoClean(b);
        return [ b ];
    },
    _readHTML: function(a) {
        var b = {
            pubtype: "PP_BOOK"
        };
        var c = $(a);
        var d = c.find("div[class=bucket]:contains('Book Description') div.content");
        if (d.length > 0) {
            var e = $(d[0]).children()[0];
            if (e) b["abstract"] = $(e).text();
        }
        var f = c.find("#detail_bullets_id td[class=bucket] ul");
        if (!f.length) {
            f = c.find("#detail-bullets td[class=bucket] ul");
        }
        if (f[0]) {
            $(f[0]).find("li").each(function(a, c) {
                var d = PP.Utils.normalizeString($(c).text());
                if (d.match(/(ISBN|\u6761\u5f62\u7801)/)) {
                    var e = PP.Utils.extractISBNs(d, {
                        convert: true,
                        unique: true
                    });
                    if (e[0]) b.isbn = e[0];
                    if (e[1]) b.isbn_alt = e[1];
                }
                if (d.match(/^(?:Verlag|Publisher|Editor|Editora|Editeur|\xc9diteur|Editore|\u51fa\u7248\u793e)\s*:\s(.*)/i)) {
                    var f = RegExp.$1;
                    var g = f.split(/;/g);
                    if (g.length == 2) {
                        b.publisher = g[0];
                        var h = g[1];
                        var i = h;
                        i = i.replace(/\(.*?\)/, "");
                        i = i.replace(/\s+$/, "");
                        i = i.replace(/^\s+/, "");
                        b.edition = i.replace(/^(Edition|Auflage|\xc9dition)\s*:\s*/i, "");
                        if (h.match(/\((.*?,?\s\d{4})\)/i)) {
                            b.published = PP.library.Date.parseDate(RegExp.$1);
                        }
                    } else if (g.length == 1) {
                        b.publisher = g[0];
                    }
                    if (d.match(/\((.*?,\s+\d{4})\)/i)) {
                        b.published = PP.library.Date.parseDate(RegExp.$1);
                    }
                }
                if (d.match(/^(?:Language|Sprache|\u8bed\u79cd|\u8a00\u8a9e|Langue|Lingua|Idioma)\s*:\s(.*)/i)) {
                    b.language = PP.Utils.normalizeLanguage(RegExp.$1);
                }
                if (d.match(/^(?:Hardcover|Gebundene Ausgabe|\u7cbe\u88c5|\u30cf\u30fc\u30c9\u30ab\u30d0\u30fc|Reli\xe9|Copertina rigida|Tapa dura|Paperback|Taschenbuch|\u5e73\u88c5|\u30da\u30fc\u30d1\u30fc\u30d0\u30c3\u30af|Broch\xe9|Copertina flessibile|Tapa blanda|Print Length|Seitenzahl der Print-Ausgabe|\u7d19\u306e\u672c\u306e\u9577\u3055|Nombre de pages de l'\xe9dition imprim\xe9e|Longueur d'impression|Poche|Broch\xe9|Lunghezza stampa|Longitud de impresi\xf3n|N\xfamero de p\xe1ginas)\s*:\s(.*)/i)) {
                    b.num_pages = parseInt(RegExp.$1, 10);
                }
            });
        }
        if (b.edition) {
            b.edition = b.edition.replace(/edition\s+edition/i, "Edition");
        }
        var g = c.find("span[id=btAsinTitle]");
        if (g[0]) {
            b.title = $(g[0]).text();
            if (b.title && !b.title.match(/[A-Z]/i)) delete b.title;
        }
        if (!b.title) {
            g = c.find("span[id=ebooksProductTitle]");
            if (g[0]) {
                b.title = $(g[0]).text();
                if (!b.edition) b.edition = "Kindle";
                if (b.title && !b.title.match(/[A-Z]/i)) delete b.title;
            }
        }
        if (!b.title) {
            g = c.find("h1#title");
            if (g.length > 0) {
                var h = $(g[0]).contents().filter(function() {
                    if (typeof Node != "undefined") {
                        return this.nodeType === Node.TEXT_NODE;
                    } else {
                        return this.type === "text";
                    }
                });
                if (h.length > 0) {
                    b.title = h.text();
                } else {
                    b.title = $(g[0]).text();
                }
            }
            if (b.title && !b.title.match(/[A-Z]/i)) delete b.title;
        }
        if (!b.title) {
            g = c.find("span#productTitle");
            if (g.length > 0) {
                b.title = $(g[0]).text();
            }
        }
        if (b.title) {
            b.title = b.title.replace(/Hardcover/i, "");
            b.title = b.title.replace(/Paperback/i, "");
            b.title = b.title.replace(/\[.+\]\s*$/, "");
        }
        var i = c.find("span.author");
        if (i.length > 0) {
            i.each(function(a, c) {
                var d = $(c).find("> a, a.contributorNameID").text().replace(/\s*\(.+/, "");
                var e = $(c).find("span.contribution").text();
                var f = PP.library.Author.parseAuthor(d, {
                    familyNameFirst: false
                });
                var g = "author";
                if (e) {
                    if (e.match(/edit/i)) {
                        g = "editor";
                    } else if (e.match(/(Translator|\xdcbersetzer|Traduttore|Traductor|\u7ffb\u8a33)/i)) {
                        g = "translator";
                    } else if (e.match(/(Ill?ust|\u30a4\u30e9\u30b9\u30c8)/i)) {
                        g = null;
                    }
                }
                if (g) {
                    if (!(g in b)) b[g] = [];
                    b[g].push(f);
                }
            });
        }
        if (b.publisher && b.publisher.match(/^(.*)\((.*\d{4})\)/i)) {
            b.publisher = RegExp.$1;
            b.published = PP.library.Date.parseDate(RegExp.$2);
        }
        return b;
    },
    getName: function() {
        return "Amazon";
    }
});

PP.format.Amazon = new PP.format._Amazon();

PP.format._Bibtex = PP.format.AbstractReader.extend({
    debug: false,
    bibtex_pubtypes: [ "article", "book", "booklet", "conference", "inbook", "incollection", "inproceedings", "manual", "mastersthesis", "misc", "phdthesis", "proceedings", "techreport", "unpublished", "comment" ],
    biblatex_pubtypes: [ "mvbook", "bookinbook", "suppbook", "collection", "mvcollection", "suppcollection", "online", "patent", "periodical", "suppperiodical", "mvproceedings", "reference", "mvreference", "inreference", "report", "thesis", "electronic", "www" ],
    MapIn: {
        abstract: "abstract",
        abstracturl: "url",
        address: "address",
        affiliation: "affiliation",
        annote: "note",
        archiveprefix: "archivePrefix",
        author: "author",
        authors: "author",
        booktitle: "booktitle",
        chapter: "chapter",
        citekey: "citekey",
        "citeulike-linkout-0": "url",
        "citeulike-linkout-1": "url",
        "citeulike-linkout-2": "url",
        "citeulike-linkout-3": "url",
        "citeulike-linkout-4": "url",
        "citeulike-linkout-5": "url",
        "citeulike-linkout-6": "url",
        file: "external_pdf_filename",
        sentelink: "external_pdf_filename",
        conference: "conference",
        copyright: "copyright",
        day: "day",
        doi: "doi",
        edition: "edition",
        editor: "editor",
        editors: "editor",
        eprint: "eprint",
        ee: "url",
        howpublished: "howpublished",
        institution: "institution",
        isbn: "isbn",
        issn: "issn",
        journal: "journal",
        fjournal: "journalfull",
        jstor_formatteddate: "date",
        date: "date",
        keyword: "keywords",
        keywords: "keywords",
        kind: "kind",
        language: "language",
        lccn: "lccn",
        month: "month",
        mrnumber: "mr",
        note: "note",
        number: "issue",
        organization: "institution",
        pages: "pages",
        pdfurl: "url",
        "pdf-url": "url",
        pmid: "pmid",
        pmc: "pmc",
        pmcid: "pmc",
        primaryclass: "primaryClass",
        publisher: "publisher",
        pubmonth: "month",
        pubtype: "pubtype",
        pubyear: "year",
        school: "school",
        series: "series",
        title: "title",
        url: "url",
        urlpdf: "url",
        volume: "volume",
        volumes: "num_volumes",
        year: "year",
        subtype: "subtype",
        location: "conference_location",
        zbl: "zbl"
    },
    hierarchy: [ "citekey", "pubtype", "address", "annote", "author", "booktitle", "chapter", "edition", "editor", "howpublished", "institution", "journal", "note", "number", "pages", "publisher", "kind", "school", "series", "title", "url", "volume", "year", "month", "day", "doi", "pmid", "affiliation", "abstract", "copyright", "issn", "isbn", "lccn", "keywords", "keyword", "authors", "editors", "language", "citeulike-linkout-0", "citeulike-linkout-1", "citeulike-linkout-2", "citeulike-linkout-3", "citeulike-linkout-4", "citeulike-linkout-5", "citeulike-linkout-6", "conference", "journalabr", "pdfurl", "pdf-url", "urlpdf", "pubmonth", "pubyear", "abstracturl", "ee", "jstor_formatteddate", "date", "organization", "archiveprefix", "primaryclass", "eprint", "location", "volumes", "pmc", "pmcid", "fjournal", "mrnumber", "zbl", "sentelink", "file" ],
    getAllPubtypes: function() {
        var a = this.bibtex_pubtypes;
        var b = this.biblatex_pubtypes;
        return a.concat(b);
    },
    getName: function() {
        return "Bibtex";
    },
    doRead: function(a) {
        var b = this.readBibTeX(a, true);
        var c = [];
        for (var d = 0; d < b.length; d++) {
            if (!b[d].pubtype) {
                continue;
            }
            if (b[d].pubtype === "COMMENT") {
                continue;
            }
            if (b[d].pubtype === "STRING") {
                continue;
            }
            var e = {
                url: []
            };
            if (b[d]["location"] && !b[d]["address"]) {
                b[d]["address"] = b[d]["location"];
                delete b[d]["location"];
            }
            for (var f = 0; f < this.hierarchy.length; f++) {
                var g = this.hierarchy[f];
                if (!b[d][g]) continue;
                var h = this.MapIn[g];
                if (h === undefined) continue;
                if (PP.Utils.isString(b[d][g])) {
                    b[d][g] = b[d][g].replace(/\s+$/, "");
                    b[d][g] = b[d][g].replace(/^\s+/, "");
                }
                if (h === "url") {
                    if (!b[d][g].match(/\s/)) {
                        e[h].push(b[d][g]);
                    } else {
                        if (g === "ee") {
                            var i = b[d][g].split(/,\s+/);
                            for (var j = 0; j < i.length; j++) {
                                if (i[j].match(/^(https?|ftp)/)) {
                                    e[h].push(i[j]);
                                }
                            }
                        }
                    }
                } else if (h === "note") {
                    if (!e[h]) {
                        e[h] = "";
                    }
                    e[h] = e[h] + b[d][g] + "\n";
                } else if (h === "date") {
                    if (b[d][g].match(/(...)\.,\s(\d\d\d\d)/)) {
                        e.month = RegExp.$1;
                        e.year = RegExp.$2;
                    }
                    if (b[d][g].match(/^\d{4}$/) && !e["year"]) {
                        e["year"] = b[d][g];
                    }
                    if (b[d][g].match(/^(\d{4})-(\d\d)-(\d\d)$/) && !e["year"]) {
                        e["year"] = RegExp.$1;
                        e["month"] = RegExp.$2;
                        e["day"] = RegExp.$3;
                    }
                } else if (h === "year") {
                    if (b[d][g].match(/^(\d{4})-(\d\d)-(\d\d)$/)) {
                        e["year"] = RegExp.$1;
                        e["month"] = RegExp.$2;
                        e["day"] = RegExp.$3;
                    } else if (b[d][g].match(/^(\d{4})-(\d\d)-(\d\d)T\d+:\d+:\d+$/)) {
                        e["year"] = RegExp.$1;
                        e["month"] = RegExp.$2;
                        e["day"] = RegExp.$3;
                    } else {
                        e["year"] = b[d][g];
                    }
                } else if (h === "external_pdf_filename") {
                    var k = null;
                    var l = b[d][g].match(/^(file:\/\/.+),Sente,/);
                    if (l && l[1]) {
                        k = l[1];
                    }
                    if (!k) {
                        l = b[d][g].match(/(.*:)([^:]+)(:PDF|:application\/pdf)/i);
                        if (l && l[2]) {
                            k = l[2];
                        }
                    }
                    if (!k) {
                        l = b[d][g].match(/^(file:\/\/.+\S+\.pdf)$/i);
                        if (l && l[1]) {
                            k = l[1];
                        }
                    }
                    if (k && k.length > 3) {
                        if (k.match(/%/)) {
                            try {
                                k = decodeURIComponent(k);
                            } catch (a) {
                                try {
                                    k = decodeURI(k);
                                } catch (a) {}
                            }
                        }
                        e[h] = k;
                    }
                } else {
                    if (!e[h]) {
                        e[h] = b[d][g];
                    }
                }
            }
            if (e["note"]) {
                e["note"] = e["note"].replace(/\n$/, "");
            }
            if (e["isbn"]) {
                var m = PP.Utils.extractISBNs(e["isbn"], {
                    convert: true,
                    unique: true
                });
                delete e["isbn"];
                if (m[0]) e.isbn = m[0];
                if (m[1]) e.isbn_alt = m[1];
            }
            if (e["issn"]) {
                var n = e["issn"].split(/,/);
                var o = PP.library.Publication.checkValidityOfISSN(n[0]);
                if (o !== "") {
                    e["issn"] = o;
                    if (n[1]) {
                        o = PP.library.Publication.checkValidityOfISSN(n[1]);
                        if (o !== "") e["issn_alt"] = o;
                    }
                } else {
                    delete e["issn"];
                }
            }
            if (b[d].archiveprefix && b[d].eprint) {
                if (b[d].archiveprefix.toUpperCase() === "ARXIV") {
                    e.arxivid = b[d].eprint;
                }
            }
            if (b[d].arxiv) {
                if (!e.arxivid) {
                    e.arxivid = b[d].arxiv;
                }
            }
            if (e.doi && e.doi.match(/,\s+/gm)) {
                var p = e.doi.split(/,\s+/gm);
                if (p.length > 0) {
                    e.doi = p.shift();
                    p.forEach(function(a) {
                        var b = {
                            type: "article",
                            doi: a
                        };
                        PP.library.Publication.addXref(e, b);
                    });
                }
            }
            if (e.journal && e.journal.match(/\S\.\S/g)) {
                e.journal = e.journal.replace(/\./g, ". ");
            }
            if (e.howpublished) {
                if (e.howpublished.match(/^(ftp|https?):\/\/\S+\s*$/)) {
                    e["url"].push(e.howpublished);
                    delete e.howpublished;
                    if (!e.journal) {
                        e.pubtype = "PP_WEBSITE";
                    }
                }
            }
            if (e.note) {
                if (e.note.match(/^Accessed:\s(\d{4})-(\d\d?)-(\d\d?)$/)) {
                    e["accyear"] = RegExp.$1;
                    e["accmonth"] = RegExp.$2;
                    e["accday"] = RegExp.$3;
                    delete e.note;
                }
            }
            if (e.citekey) {
                e.original_citekey = e.citekey;
                delete e.citekey;
            }
            c.push(e);
        }
        return c;
    },
    readBibTeX: function(a, b) {
        var c, d, e, f, g, h;
        var i = a.split(/\n/);
        var j = [];
        var k = [];
        var l = new RegExp("^\\s*@(" + this.bibtex_pubtypes.join("|") + "|" + this.biblatex_pubtypes.join("|") + "|string)", "i");
        var m = 0;
        c = null;
        for (d = 0; d < i.length; d++) {
            if (i[d].match(/^\s*%/)) {
                continue;
            }
            if (i[d].match(/^$/)) {
                continue;
            }
            if (i[d].match(l)) {
                m = 1;
                if (k.length > 0) {
                    c = this.parseEntry(k);
                    if (c) {
                        j.push(c);
                    }
                    k = [];
                }
            }
            k.push(i[d]);
        }
        c = null;
        if (k.length > 0 && m === 1) {
            c = this.parseEntry(k);
            if (c) {
                j.push(c);
            }
        }
        h = j.length;
        var n = {
            jan: "January",
            feb: "February",
            mar: "March",
            apr: "April",
            may: "May",
            jun: "June",
            jul: "July",
            aug: "August",
            sep: "September",
            oct: "October",
            nov: "November",
            dec: "December"
        };
        var o = [];
        for (d = 0; d < j.length; d++) {
            if (d % 10 === 0) {
                this.fire("progress", {
                    progress: .1 * d / h,
                    totalCount: h
                });
            }
            try {
                if (j[d].pubtype === "STRING") {
                    for (f in j[d]) {
                        if (j[d].hasOwnProperty(f)) {
                            if (f === "citekey" || f === "pubtype") {
                                continue;
                            }
                            n[f.toUpperCase()] = j[d][f];
                        }
                    }
                } else {
                    o.push(j[d]);
                }
            } catch (a) {
                PP.log({
                    type: "exception",
                    subtype: "Parsing",
                    msg: "Caught error when parsing Bibtex: " + a.message
                });
            }
        }
        for (d = 0; d < o.length; d++) {
            if (d % 10 === 0) {
                this.fire("progress", {
                    progress: .1 + .9 * d / h,
                    totalCount: h
                });
            }
            try {
                for (f in o[d]) {
                    if (o[d].hasOwnProperty(f)) {
                        if (f === "citekey" || f === "pubtype") {
                            continue;
                        }
                        if (n[o[d][f].toUpperCase()]) {
                            o[d][f] = n[o[d][f].toUpperCase()];
                        }
                    }
                }
                if (o[d].author) {
                    o[d].author = this._splitAuthors(o[d].author);
                    for (e = 0; e < o[d].author.length; e++) {
                        o[d].author[e] = this.getNameParts(o[d].author[e]);
                    }
                }
                if (o[d].editor) {
                    o[d].editor = this._splitAuthors(o[d].editor);
                    for (e = 0; e < o[d].editor.length; e++) {
                        o[d].editor[e] = this.getNameParts(o[d].editor[e]);
                    }
                }
                if (b) {
                    for (f in o[d]) {
                        if (o[d].hasOwnProperty(f)) {
                            if (f === "citekey" || f === "pubtype") {
                                continue;
                            }
                            if (f === "author" || f === "editor") {
                                for (e = 0; e < o[d][f].length; e++) {
                                    for (g in o[d][f][e]) {
                                        if (o[d][f][e].hasOwnProperty(g)) {
                                            o[d][f][e][g] = this._interpretLaTeX(o[d][f][e][g], f);
                                        }
                                    }
                                }
                            } else {
                                o[d][f] = this._interpretLaTeX(o[d][f], f);
                            }
                        }
                    }
                }
            } catch (a) {
                PP.log({
                    type: "exception",
                    subtype: "Parsing",
                    msg: "Caught error when parsing Bibtex: " + a.message
                });
            }
        }
        return o;
    },
    _addValue: function(a, b, c) {},
    _getWriteOptions: function(a) {
        var b = {
            doubleDash: 1,
            escapeUTF8: 1,
            useFullJournalName: 0,
            exportAbstract: 1,
            exportKeywords: 1,
            exportIdentifiers: 0,
            exportNotes: 0,
            exportFilePath: 0,
            exportFoldersLabels: 0,
            exportUrls: 0,
            exportDay: 0,
            preserveTitles: 0,
            prettyPrint: 1,
            smartQuote: 1
        };
        PP.Utils.apply(b, a || {});
        return b;
    },
    _getFields: function(a) {
        var b = [ "pubtype", "address", "author", "booktitle", "chapter", "edition", "editor", "howpublished", "issue", "journal", "month", "number", "pages", "publisher", "school", "series", "title", "volume", "year" ];
        var c = [ "pp_guid", "owner", "user_citekey", "_id" ];
        if (!a.exportAbstract) {
            c.push("abstract");
        }
        if (!a.exportIdentifiers) {
            c = c.concat([ "arxivid", "doi", "eprint", "issn", "isbn", "pmc", "pmid", "lccn", "issn_alt", "isbn_alt", "mr", "zbl" ]);
        }
        if (!a.exportFilePath) {
            c.push("attachments");
        }
        if (!a.exportKeywords) {
            c.push("keywords");
        }
        var d = PP.Array.mapBoolean(c);
        var e = PP.library.PublicationFields.getFields();
        var f = PP.Array.pluck(e, "name");
        var g = PP.Array.merge(b, f);
        g = PP.Array.filter(g, function(a) {
            if (d[a]) {
                return false;
            }
            return true;
        });
        return g;
    },
    _preprocessPubs: function(a, b) {
        var c = [];
        var d = new RegExp("(\\\\){10,}", "g");
        for (var e = 0; e < a.length; e++) {
            var f = PP.Utils.clone(a[e]);
            delete f.associated_doi;
            PP.library.Publication.convertHtmlEntitiesToUnicode(f);
            if (b.exportFoldersLabels) {
                var g = [];
                if (f.keywords !== undefined && f.keywords !== null) {
                    if (f.keywords.match(/\S/)) {
                        g.push(f.keywords);
                    }
                }
                if (f.labelsNamed && PP.Utils.isArray(f.labelsNamed)) {
                    if (f.labelsNamed.length > 0) {
                        g.push(f.labelsNamed.join(";"));
                    }
                }
                if (f.foldersNamed && PP.Utils.isArray(f.foldersNamed)) {
                    if (f.foldersNamed.length > 0) {
                        g.push(f.foldersNamed.join(";"));
                    }
                }
                f.keywords = g.join(";");
                if (f.keywords === "" || f.keywords === ";") {
                    delete f.keywords;
                }
            }
            var h = PP.library.PublicationTypes.getPubType(f.pubtype);
            if (h.excluded_fields) {
                h.excluded_fields.forEach(function(a) {
                    if (a in f) delete f[a];
                });
            }
            if (f["abstract"] && f["abstract"].match(d)) {
                f["abstract"] = f["abstract"].replace(d, "");
            }
            c.push(f);
        }
        return c;
    },
    _getBibTeXPubType: function(a) {
        var b = a.pubtype;
        var c = PP.library.PublicationTypes.getPubType(b);
        var d;
        if (c) {
            d = c.bibtex_types;
        } else {
            d = [ "PP_MISC" ];
        }
        var e;
        if (b === "PP_THESIS") {
            if (!a.kind || a.kind.match(/ph.d./i)) {
                e = "PHDTHESIS";
            } else {
                e = "MASTERSTHESIS";
            }
        } else if (b === "PP_CONFERENCE_PAPER") {
            if (!a.author && a.editor) {
                e = "PROCEEDINGS";
            } else {
                e = d[0];
            }
        } else if (b === "PP_BOOK_CHAPTER") {
            if (!a.booktitle) {
                e = "INBOOK";
            } else {
                e = "INCOLLECTION";
            }
        } else if (b === "PP_WEBSITE") {
            e = "MISC";
        } else if (b === "PP_PERSONAL_COMMUNICATION") {
            e = "MISC";
        } else if (b === "PP_BOOK") {
            e = "BOOK";
            if (a.kind) {
                if (a.kind === "Booklet") {
                    e = "BOOKLET";
                } else if (a.kind === "Proceedings") {
                    e = "PROCEEDINGS";
                }
            }
        } else {
            e = d[0];
        }
        return e;
    },
    doWrite: function(a, b) {
        if (!PP.Utils.isArray(a)) {
            a = [ a ];
        }
        var c, d, e, f, g, h;
        var i = this._getWriteOptions(b);
        var j = this._getFields(i);
        var k = "";
        a = this._preprocessPubs(a, i);
        for (c = 0; c < a.length; c++) {
            this.c.log("  pub #", c, PP.Utils.ellipsis(a[c].title, 80));
            var l = a[c];
            var m = {
                note: []
            };
            var n = 0;
            var o = l.pubtype;
            var p = this._getBibTeXPubType(l);
            var q = PP.Utils.clone(j);
            if (p === "UNPUBLISHED" && l["arxivid"]) {
                p = "ARTICLE";
                if (!i.exportIdentifiers) {
                    if (!l["eprint"]) l["eprint"] = l["arxivid"];
                    q.push("eprint");
                }
                if (l["journal"] && l["journal"].match(/arXiv/i)) l["journal"] = undefined;
            }
            if (p === "MISC" && o === "PP_PERSONAL_COMMUNICATION") {
                if (!l["howpublished"]) m["howpublished"] = "personal communication";
            }
            var r = 0;
            var s = "";
            for (d = 0; d < q.length; d++) {
                var t = undefined;
                h = q[d];
                var u = PP.library.PublicationFields.getField(h) || {};
                if (u.name === "citekey") continue;
                if (u.export_persist === false || u.bibtex_persist === false) continue;
                if (u.bibtex_support === false) continue;
                if (o == "PP_THESIS" && u.name === "kind") continue;
                if (o == "PP_BOOK" && u.name === "kind") {
                    if (l[h] && l[h].match(/^(Booklet|Proceedings)$/)) continue;
                }
                var v = u.bibtex_name ? u.bibtex_name : h;
                if (v == "institution" && p == "MANUAL") v = "organization";
                if (v === "file") {
                    g = [];
                    if (l[h]) {
                        for (e = 0; e < l[h].length; e++) {
                            var w = l[h][e].article_pdf ? "Article PDF" : "Supplementary File";
                            var x = l[h][e].subfolders[0] ? l[h][e].subfolders[0] : "";
                            var y = x + "/" + l[h][e].filename;
                            var z = "Text";
                            if (l[h][e].mimeType) {
                                if (l[h][e].mimeType.match(/application\/(.+)/)) {
                                    z = RegExp.$1;
                                }
                            }
                            g.push(y);
                        }
                    }
                    t = g.sort().join(";");
                } else if (u.fieldType === "author" && l[h]) {
                    g = [];
                    for (e = 0; e < l[h].length; e++) {
                        g.push(PP.library.Author.toBibtex(l[h][e]));
                    }
                    t = g.join(" and ");
                } else if ([ "month", "year" ].indexOf(h) > -1) {
                    var A = l.published || {};
                    t = A[h];
                    if (t) t += "";
                    if (h === "month") {
                        moMap = {
                            1: "jan",
                            2: "feb",
                            3: "mar",
                            4: "apr",
                            5: "may",
                            6: "jun",
                            7: "jul",
                            8: "aug",
                            9: "sep",
                            10: "oct",
                            11: "nov",
                            12: "dec"
                        };
                        if (moMap[t]) {
                            t = moMap[t];
                            if (A["day"] && A["day"] !== undefined) {
                                if (i.exportDay === 1) {
                                    t = '"' + A["day"] + '~" # ' + t;
                                }
                            }
                        } else if (t !== undefined) {
                            console.warn("Bibtex warning: error mapping month", t);
                        }
                    }
                } else if (v === "isbn" || v === "issn") {
                    if (l[h]) {
                        if (m[v]) {
                            t = m[v] + ", " + l[h];
                        } else {
                            t = l[h];
                        }
                    }
                } else if (h === "url") {
                    if (i.exportUrls === 1) {
                        if (l[h] && l[h].length > 0) t = l[h][0];
                    }
                    if (o === "PP_WEBSITE") {
                        if (l[h] && l[h].length) {
                            m["howpublished"] = "\\url{" + l[h][0] + "}";
                        }
                        if (l["accessed"]) {
                            var B = l["accessed"]["year"] ? l["accessed"]["year"] : "NA";
                            var f = l["accessed"]["month"] ? l["accessed"]["month"] : "NA";
                            var C = l["accessed"]["day"] ? l["accessed"]["day"] : "NA";
                            m["note"].push("Accessed: " + B + "-" + f + "-" + C);
                        }
                    }
                } else if (v === "journal") {
                    if (o === "PP_PATENT") continue;
                    if (i.useFullJournalName === 1) {
                        if (l["journalfull"] && l["journalfull"].length > 0) {
                            t = l["journalfull"];
                        } else {
                            t = l[h];
                        }
                    } else {
                        t = l[h];
                    }
                } else if (v === "annote") {
                    if (i.exportNotes === 1) t = l[h];
                } else if (v === "issue") {
                    t = l[h];
                    if (p === "TECHREPORT") {
                        v = "number";
                    }
                } else if (v === "booktitle") {
                    t = PP.String.interconvertString(l[h], {
                        format: "bibtex"
                    });
                    if (o === "PP_DATASET") {
                        if (l[h] && l[h] !== undefined) {
                            m["note"].push("Title of the publication associated with this dataset: " + l[h]);
                        }
                        continue;
                    }
                } else if (h === "howpublished") {
                    if (l["howpublished"]) {
                        if (l["howpublished"].match(/^https?:\/\/\S+$/)) {
                            t = "\\url{" + l["howpublished"] + "}";
                        } else {
                            t = l["howpublished"];
                            n = 1;
                        }
                    }
                } else if (v === "note") {
                    if (l[h] === undefined) continue;
                    if (h === "status") {
                        m[v].push(l[h]);
                    }
                } else if (v === "title") {
                    t = PP.String.interconvertString(l[h], {
                        format: "bibtex"
                    });
                } else {
                    t = l[h];
                }
                if (t) {
                    if (t === undefined) continue;
                    if (v === "published") continue;
                    if (v === "filed") continue;
                    if (PP.Utils.isString(t)) {
                        t = t.replace(/\n+$/, "");
                        t = t.replace(/\s+$/, "");
                    }
                    m[v] = t;
                }
            }
            if (m["note"].length > 0) {
                m["note"] = m["note"].join("; ");
            } else {
                delete m["note"];
            }
            if (m.archivePrefix) {
                if (!m.eprint) {
                    delete m.archivePrefix;
                    delete m.primaryClass;
                }
            }
            var D = Object.keys(m);
            for (d = 0; d < D.length; d++) {
                if (D[d].length > r) {
                    r = D[d].length;
                }
            }
            for (d = 1; d <= r + 6; d++) {
                s += " ";
            }
            var E = [ "title", "booktitle", "author", "editor", "affiliation", "abstract", "journal", "publisher", "volume", "issue", "number", "pages", "chapter", "series", "edition", "institution", "day", "month", "year", "url", "howpublished", "note", "annote", "file" ];
            for (var F in m) {
                if (m.hasOwnProperty(F)) {
                    if (E.indexOf(F) === -1) E.push(F);
                }
            }
            var G = [];
            for (d = 0; d < E.length; d++) {
                var F = E[d];
                if (!m.hasOwnProperty(E[d])) continue;
                if (!PP.Utils.isString(m[F])) {
                    this.c.log("Cannot write non-string field to bibtex: ", F);
                    continue;
                }
                var H = '"';
                var I = '"';
                if (i.preserveTitles) {
                    if (F === "title" || F === "booktitle") {
                        H = '"{';
                        I = '}"';
                    }
                }
                var J = 0;
                if (F === "month") J = 1;
                var K = [ "year", "day", "volume", "number", "issue", "series", "edition", "chapter" ];
                for (var L = 0; L < K.length; L++) {
                    if (F === K[L] && m[F].match(/^\d+$/)) J = 1;
                }
                if (J === 1) {
                    H = " ";
                    I = "";
                }
                m[F] = m[F].replace(/[\u2012\u2015]/g, "-");
                var M = 1;
                if (F === "url") M = 0;
                if (F === "file") M = 0;
                if (F === "howpublished" && n === 0) M = 0;
                if (M === 1) {
                    var N = m[F].split(/(\$[^\$]*\$)/);
                    for (var O = 0; O < N.length; O++) {
                        if (!N[O].match(/^\$.*\$$/)) {
                            N[O] = N[O].replace(/\\/g, "\\textbackslash");
                        }
                    }
                    m[F] = N.join("");
                    m[F] = m[F].replace(/\\textbackslash(\$|&|#|%|\{|\}|~|^)/g, "\\$1");
                    if (F.match(/(title|booktitle)/)) {
                        m[F] = m[F].replace(/\\textbackslash(textit|textbf|emph|\{|\})/g, "\\$1");
                    }
                    if (!F.match(/(author|editor|title|booktitle)/)) {
                        m[F] = m[F].replace(/\{/g, "\\{");
                        m[F] = m[F].replace(/\\\\\{/g, "\\{");
                        m[F] = m[F].replace(/\}/g, "\\}");
                        m[F] = m[F].replace(/\\\\\}/g, "\\}");
                    }
                    m[F] = m[F].replace(/%/g, "\\%");
                    m[F] = m[F].replace(/\\\\%/g, "\\%");
                    m[F] = this._escapeDollars(m[F]);
                    m[F] = this._escapeUnderscores(m[F]);
                    m[F] = m[F].replace(/&/g, "\\&");
                    m[F] = m[F].replace(/\\\\&/g, "\\&");
                    if (F !== "month") {
                        m[F] = m[F].replace(/#/g, "\\#");
                        m[F] = m[F].replace(/\\\\#/g, "\\#");
                    }
                }
                M = i["escapeUTF8"] ? 1 : 0;
                if (F === "file") M = 0;
                if (M === 1) {
                    m[F] = PP.String.unicode2Latex(m[F]);
                }
                if (i.smartQuote && !i.preserveTitles) {
                    if (F === "title" || F === "booktitle") {
                        g = m[F].split(/\s+/);
                        for (e = 0; e < g.length; e++) {
                            var P = 0;
                            var Q = 0;
                            var R = g[e].split("");
                            for (f = 0; f < R.length; f++) {
                                if (R[f].match(/[A-Z]/)) {
                                    P++;
                                }
                                if (R[f] == "$") Q++;
                            }
                            var S = 0;
                            if (P > 1 && !g[e].match(/(\$|~)/)) {
                                S = 1;
                            }
                            if (P >= 1 && Q > 0 && Q % 2 == 0) {
                                S = 1;
                            }
                            if (P >= 1 && g[e].match(/^[A-Z\d\-]+$/)) {
                                S = 1;
                            }
                            if (g[e].match(/^\{.*\}$/)) {
                                S = 0;
                            }
                            if (!i.smartQuote) {
                                S = 0;
                            }
                            if (g[e] === "A") {
                                S = 0;
                            }
                            if (S === 1) {
                                var T = "";
                                var U = "";
                                var V;
                                if (V = g[e].match(/^(\(|\[|\")/)) {
                                    T = V[1];
                                    g[e] = g[e].replace(/^./, "");
                                }
                                if (V = g[e].match(/(\)|\]|\")$/)) {
                                    U = V[1];
                                    g[e] = g[e].replace(/.$/, "");
                                }
                                g[e] = "{" + g[e] + "}";
                                var W;
                                if ((W = /(.+)(;|:|\.|,|\?|\!)\}$/.exec(g[e])) !== null) {
                                    g[e] = W[1] + "}" + W[2];
                                }
                                if ((W = /^\{(;|:|\.|,|\?|\!)(.+)/.exec(g[e])) !== null) {
                                    g[e] = W[1] + "{" + W[2];
                                }
                                g[e] = T + g[e] + U;
                            }
                        }
                        m[F] = g.join(" ");
                    }
                }
                if (F === "pages") {
                    if (i.doubleDash) {
                        m[F] = m[F].replace(/-\s+-/g, "-");
                        m[F] = m[F].replace(/-+/g, "-");
                        m[F] = m[F].replace(/-/g, "--");
                    }
                }
                if (I === '"') {
                    var X = m[F].split(/(")/);
                    var Y = 0;
                    for (var Z = 0; Z < X.length; Z++) {
                        if (X[Z] == '"') {
                            if (!(Z > 0 && X[Z - 1].match(/\\$/))) {
                                Y++;
                                X[Z] = Y % 2 == 1 ? "``" : "''";
                            }
                        }
                    }
                    m[F] = X.join("");
                }
                m[F] = m[F].replace(/\u201C/g, "``");
                m[F] = m[F].replace(/\u201D/g, "''");
                if (i.prettyPrint) {
                    var $ = "  " + F;
                    for (e = F.length - 1; e < r; e++) {
                        $ += " ";
                    }
                    g = [ m[F] ];
                    if (F !== "file") {
                        if (m[F].match(/\s/)) {
                            g = this.wrapText(m[F], 80 - $.length - 4);
                        }
                    }
                    for (e = 1; e < g.length; e++) {
                        g[e] = s + g[e];
                    }
                    $ += "= " + H + g.join("\n") + I;
                    $ = $.replace(/\n\s*.$/, I);
                    G.push($);
                } else {
                    G.push(F + " = " + H + m[F] + I);
                }
            }
            var _ = PP.library.Publication.getBibTeXkey(l);
            if (M === 1) {
                var aa = 0;
                G.forEach(function(a) {
                    if (a.match(/[^\x00-\x7F]/)) aa = 1;
                });
                if (aa) {
                    k += "% The entry below contains non-ASCII chars that could not be converted\n";
                    k += "% to a LaTeX equivalent.\n";
                }
            }
            k += "@" + p + "{" + _ + "," + "\n";
            k += G.join(",\n");
            k += "\n" + "}" + "\n\n";
        }
        k = k.replace(/\n$/, "");
        return k;
    },
    wrapText: function(a, b) {
        var c = a.split(/\s+/);
        var d = [];
        var e = [];
        for (var f = 0; f < c.length; f++) {
            if (c[f].length >= b) {
                d.push(e.join(" "));
                e = [];
                e.push(c[f]);
            } else {
                if (e.join(" ").length + 1 + c[f].length > b) {
                    d.push(e.join(" "));
                    e = [];
                    e.push(c[f]);
                } else {
                    e.push(c[f]);
                }
            }
        }
        d.push(e.join(" "));
        return d;
    },
    getNameParts: function(a) {
        var b;
        var c = {
            first: undefined,
            last: undefined,
            collective: undefined,
            jr: undefined
        };
        if (!a) {
            return c;
        }
        if (a === undefined) {
            return c;
        }
        a = a.replace(/^\s*/, "");
        a = a.replace(/\s*$/, "");
        a = a.replace(/\s+\.\s+/g, " ");
        a = a.replace(/\s+/g, " ");
        var d = a.match(/^\{([^\{\}]+)\}$/);
        if (d !== null) {
            c.collective = d[1];
            return c;
        }
        var e = this._splitHelper(a, ",+");
        if (e.length === 0) {
            return c;
        } else if (e.length === 1) {
            var f = this._splitHelper(e[0], "\\s+");
            var g;
            for (b = 0; b < f.length; b++) {
                if (f[b].toLowerCase() === f[b]) {
                    g = b;
                }
            }
            if (g) {
                var h = [];
                var i = f.length;
                for (b = f.length; b > g; b--) {
                    h.unshift(f.pop());
                }
                c.last = h.join(" ");
                c.first = f.join(" ");
            } else {
                c.last = f.pop();
                c.first = f.join(" ");
            }
        } else if (e.length === 2) {
            c.last = e[0];
            c.first = e[1];
        } else if (e.length === 3) {
            c.last = e[0];
            c.jr = e[1];
            c.first = e[2];
        }
        return c;
    },
    _escapeDollars: function(a) {
        a = a || "";
        var b = a.split("");
        var c = 0;
        for (var d = 0; d < b.length; d++) {
            if (b[d] === "$") {
                if (d > 0) {
                    if (b[d - 1] !== "\\") c++;
                } else {
                    c++;
                }
            }
        }
        if (c % 2 === 1) {
            for (var d = 0; d < b.length; d++) {
                if (b[d] === "$") {
                    if (d > 0) {
                        if (b[d - 1] !== "\\") b[d] = "\\$";
                    } else {
                        b[d] = "\\$";
                    }
                }
            }
        }
        return b.join("");
    },
    _escapeUnderscores: function(a) {
        a = a || "";
        var b = a.split("");
        var c = 0;
        for (var d = 0; d < b.length; d++) {
            if (b[d] === "$") {
                if (d > 0) {
                    if (b[d - 1] !== "\\") {
                        c++;
                    }
                } else {
                    c++;
                }
            } else if (b[d] === "_") {
                if (c === 0) {
                    if (d > 0) {
                        if (b[d - 1] !== "\\") {
                            b[d] = "\\_";
                        }
                    } else {
                        b[d] = "\\_";
                    }
                }
            }
        }
        return b.join("");
    },
    _splitHelper: function(a, b) {
        var c;
        if (!a) {
            return [];
        }
        if (a === undefined) {
            return [];
        }
        var d = new RegExp(b, "g");
        var e = new RegExp(b + "$");
        var f;
        var g = [];
        var h = 0;
        var i = 0;
        while ((f = d.exec(a)) !== null) {
            if (i++ > 50) {
                console.log("splitHelper Bad latex loop", a);
                break;
            }
            c = a.substr(h, d.lastIndex - h - 1);
            var j = this._countBracesOpening(c);
            var k = this._countBracesClosing(c);
            if (j - k === 0) {
                c = c.replace(e, "");
                g.push(c);
                h = d.lastIndex;
            }
        }
        c = a.substr(h, a.length - h);
        g.push(c);
        return g;
    },
    _splitAuthors: function(a) {
        var b;
        if (!a) {
            return [];
        }
        if (a === undefined) {
            return [];
        }
        var c = [];
        a = a.replace(/\s+AND\s+/g, " and ");
        a = a.replace(/\s+and\s+ands\s+/g, " and ");
        var d = a.split(/\s+/);
        var e = 0;
        var f = 0;
        var g = [];
        for (b = 0; b < d.length; b++) {
            e += this._countBracesOpening(d[b]);
            f += this._countBracesClosing(d[b]);
            if (d[b] === "and" && f === e) {
                c.push(g.join(" "));
                g = [];
            } else {
                g.push(d[b]);
            }
        }
        if (g.length > 0) {
            c.push(g.join(" "));
        }
        return c;
    },
    _interpretLaTeX: function(a, b) {
        var c, d, e;
        var f = 0;
        if (!a) {
            return undefined;
        }
        if (a === undefined) {
            return undefined;
        }
        var g;
        a = PP.String.latex2Unicode(a);
        var h = a.split(/(\$[^\$]*\$)/);
        var i = 0;
        var j = {};
        for (var e = 0; e < h.length; e++) {
            if (h[e].match(/^\$/)) continue;
            var k = h[e].split(/(\{|\})/);
            for (var l = 0; l < k.length; l++) {
                if (k[l] == "{") {
                    if (l == 0) {
                        i++;
                    } else {
                        if (k[l - 1].match(/\\$/)) {} else if (b.match(/^(booktitle|title)$/i) && k[l - 1].match(/\\(textbf|textit|emph)$/)) {
                            i++;
                        } else if (k[l - 1].match(/^(.*)\\(textbf|textit|textrm|texttt|textsl|textem|textmd|textup|textnormal|mathrm|mathtt|mathit|mathbf|mathcal|mathbb|mathfrak|mathnormal|textin|textsu|textsi|textsf|mathsf|textsc|textln|textos|textdf|textsw|rm|cal|mbox|footnotesize|etalchar|newblock|url)$/)) {
                            i++;
                            j[i] = 1;
                            k[l - 1] = RegExp.$1;
                            k[l] = "";
                        } else {
                            i++;
                        }
                    }
                } else if (k[l] == "}") {
                    if (l == 0) {
                        if (j[i]) {
                            delete j[i];
                            k[l] = "";
                        }
                        i--;
                    } else {
                        if (k[l - 1].match(/\\$/)) {} else {
                            if (j[i]) {
                                delete j[i];
                                k[l] = "";
                            }
                            i--;
                        }
                    }
                }
            }
            h[e] = k.join("");
        }
        a = h.join("");
        if (!b.match(/^(booktitle|title)$/i)) {
            var m = /[\{\}]/g;
            f = 0;
            while (m.exec(a) !== null) {
                if (f++ > 50) {
                    console.log("Bad mapping", a);
                    break;
                }
                var n = a.substr(m.lastIndex - 2, 2);
                if (n === "\\{" || n === "\\}") {
                    continue;
                }
                a = a.substr(0, m.lastIndex - 1) + a.substr(m.lastIndex, a.length);
                m.lastIndex--;
            }
        }
        a = a.replace(/\\(smallskip|medskip|bigskip)/g, " ");
        a = a.replace(/\\(enskip|quad|qquad|thinspace|negthinspace)/g, " ");
        a = a.replace(/\\[,:;\\!\s]/g, " ");
        a = a.replace(/~/g, " ");
        a = a.replace(/\s+/g, " ");
        return a;
    },
    parseEntry: function(a) {
        var b = a.join(" ");
        b = b.replace(/\t+/g, " ");
        b = b.replace(/\s+/g, " ");
        var c = {
            citekey: "dummy"
        };
        var d = new RegExp("^\\s*@(" + this.bibtex_pubtypes.join("|") + "|" + this.biblatex_pubtypes.join("|") + ")\\s*\\{([^,]+),?\\s(.+)", "i");
        var e = "";
        if (b.match(d)) {
            c.pubtype = RegExp.$1.toUpperCase();
            c.citekey = RegExp.$2;
            e = RegExp.$3;
        } else if (b.match(/^\s*@string\{(.+)/i)) {
            c.pubtype = "STRING";
            e = RegExp.$1;
        } else {
            d = new RegExp("^\\s*@(" + this.bibtex_pubtypes.join("|") + "|" + this.biblatex_pubtypes.join("|") + ")\\{,(.+)", "i");
            if (b.match(d)) {
                c.pubtype = RegExp.$1;
                e = RegExp.$2;
            } else {
                return null;
            }
        }
        var f, g, h, i, j;
        var k = /([A-Z\d_\-:]+)\s*=\s*/gi;
        var l = 0;
        while ((f = k.exec(e)) !== null) {
            if (l++ > 50) {
                console.log("Bad mapping", e);
                break;
            }
            var m = /[\{\}]/g;
            g = e.substr(k.lastIndex, e.length);
            var n = f[1].toLowerCase();
            if (c.pubtype === "STRING") n = f[1];
            if (g.match(/^\"(.+)/)) {
                g = RegExp.$1;
                var o = /\"/g;
                var p = 0;
                while (o.exec(g) !== null) {
                    if (p++ > 50) {
                        console.log("Bad mapping", g);
                        break;
                    }
                    if (g.substr(o.lastIndex - 2, 2) === '\\"') {
                        continue;
                    }
                    h = g.substr(0, o.lastIndex - 1);
                    i = this._countBracesOpening(h);
                    j = this._countBracesClosing(h);
                    if (i - j === 0) {
                        if (n === "month") {
                            var q = g.indexOf('~"');
                            var r = g.indexOf("#");
                            var s = g.indexOf(",");
                            if (q && s && q < r && s > r) {
                                c["day"] = g.substring(0, q);
                                c["month"] = g.substring(r + 2, s);
                                k.lastIndex += s;
                                break;
                            } else {
                                c[n] = h;
                                k.lastIndex += c[n].length;
                                break;
                            }
                        } else {
                            c[n] = h;
                            k.lastIndex += c[n].length;
                            break;
                        }
                    }
                }
            } else if (g.match(/^\{(.+)/)) {
                g = RegExp.$1;
                var p = 0;
                while (m.exec(g) !== null) {
                    if (p++ > 50) {
                        console.log("Bad mapping", g);
                        break;
                    }
                    h = g.substr(0, m.lastIndex);
                    i = this._countBracesOpening(h) + 1;
                    j = this._countBracesClosing(h);
                    if (i - j === 0) {
                        c[n] = g.substr(0, m.lastIndex - 1);
                        k.lastIndex += c[n].length;
                        break;
                    }
                }
            } else if (g.match(/^([^\s,]+)\s*,/)) {
                c[n] = RegExp.$1;
                k.lastIndex += c[n].length;
            } else {
                var p = 0;
                while (m.exec(g) !== null) {
                    if (p++ > 50) {
                        console.log("Bad mapping", g);
                        break;
                    }
                    h = g.substr(0, m.lastIndex);
                    c[n] = h;
                }
            }
        }
        var t = c.pubtype;
        var u = PP.library.PublicationTypes.getPubTypeMap();
        if (!u[t]) {
            var v = "ERROR";
            switch (t) {
              case "COMMENT":
                v = "COMMENT";
                break;

              case "STRING":
                v = "STRING";
                break;

              case "ARTICLE":
                if (c.kind === "news") {
                    v = "PP_NEWS_ARTICLE";
                } else if (c.kind === "preprint") {
                    v = "PP_PREPRINT";
                } else {
                    v = "PP_ARTICLE";
                }
                if (c["journaltitle"] && !c["journal"]) {
                    c["journal"] = c["journaltitle"];
                    delete c["journaltitle"];
                }
                break;

              case "BOOK":
              case "MVBOOK":
                v = "PP_BOOK";
                break;

              case "COLLECTION":
              case "MVCOLLECTION":
              case "REFERENCE":
              case "MVREFERENCE":
              case "PERIODICAL":
                v = "PP_BOOK";
                if (c["booktitle"] && !c["title"]) {
                    c["title"] = c["booktitle"];
                }
                delete c["booktitle"];
                break;

              case "BOOKLET":
                v = "PP_BOOK";
                c.kind = "Booklet";
                break;

              case "ONLINE":
              case "WWW":
              case "ELECTRONIC":
                v = "PP_WEBSITE";
                break;

              case "INCOLLECTION":
              case "INBOOK":
              case "BOOKINBOOK":
              case "SUPPBOOK":
              case "SUPPCOLLECTION":
              case "INREFERENCE":
              case "SUPPPERIODICAL":
                v = "PP_BOOK_CHAPTER";
                break;

              case "CONFERENCE":
              case "INPROCEEDINGS":
                v = "PP_CONFERENCE_PAPER";
                break;

              case "PROCEEDINGS":
              case "MVPROCEEDINGS":
                v = "PP_BOOK";
                c.kind = "Proceedings";
                break;

              case "THESIS":
                c.kind = "Ph.D. Thesis";
                v = "PP_THESIS";
                if (c["type"]) {
                    if (c["type"].match(/(mathesis|master)/i)) {
                        c.kind = "Masters Thesis";
                    }
                    delete c["type"];
                }
                if (c["institution"] && !c["school"]) {
                    c["school"] = c["institution"];
                    delete c["institution"];
                }
                break;

              case "PHDTHESIS":
                c.kind = "Ph.D. Thesis";
                v = "PP_THESIS";
                break;

              case "MASTERSTHESIS":
                c.kind = "Masters Thesis";
                v = "PP_THESIS";
                break;

              case "UNPUBLISHED":
                v = "PP_UNPUBLISHED";
                break;

              case "MISC":
                v = "PP_MISC";
                break;

              case "REPORT":
              case "TECHREPORT":
                v = "PP_REPORT";
                break;

              case "PATENT":
                v = "PP_PATENT";
                break;

              case "MANUAL":
                v = "PP_MANUAL";
                break;

              default:
                PP.log({
                    type: "error",
                    subtype: "BibTex",
                    msg: "Error converting from BibTeX publication type",
                    badpubType: c.pubType
                });
                v = "PP_MISC";
                break;
            }
            c.pubtype = v;
        }
        return c;
    },
    _countBracesOpening: function(a) {
        var b = /\\\{/g;
        var c = a.match(b);
        var d = /\{/g;
        var e = a.match(d);
        var f = c ? c.length : 0;
        var g = e ? e.length : 0;
        return g - f;
    },
    _countBracesClosing: function(a) {
        var b = /\\\}/g;
        var c = a.match(b);
        var d = /\}/g;
        var e = a.match(d);
        var f = c ? c.length : 0;
        var g = e ? e.length : 0;
        return g - f;
    }
});

PP.format.Bibtex = new PP.format._Bibtex();

PP.format._CSL = PP.format.AbstractReader.extend({
    debug: false,
    doRead: function(a) {
        if (a) {
            if (PP.Utils.isString(a)) {
                a = PP.Utils.decode(a);
            } else {
                if (!PP.Utils.isArray(a)) {
                    a = [ a ];
                }
            }
        } else {
            return [];
        }
        var b = this._readCSL(a);
        b.forEach(function(a) {
            PP.library.Publication.autoClean(a);
        });
        return b;
    },
    _readCSL: function(a) {
        var b = [];
        var c;
        a.forEach(function(a) {
            var d = {
                url: []
            };
            c = PP.library.PublicationTypes.getInputTypeForPub(a.type.toLowerCase(), "csl");
            d.pubtype = c.pubtype;
            if (c.kind) d.kind = c.kind;
            var e = PP.library.PublicationFields.getInputMapForPubType(d.pubtype, "csl");
            var f = "";
            for (var g in a) {
                if (g == "journalAbbreviation") f = a[g];
                if (!(g in e)) continue;
                var h = e[g];
                var i = a[g];
                if (h == "author" || h == "editor" || h == "contributor" || h == "translator" || h == "series_editor") {
                    if (!(h in d)) d[h] = [];
                    if (PP.Utils.isArray(i)) {
                        i.forEach(function(a) {
                            var b = {};
                            if (a.given && a.family) {
                                b.first = a.given;
                                b.last = a.family;
                            } else if (a.family) {
                                b.collective = a.family;
                            }
                            if (b.last) {
                                if (a["non-dropping-particle"]) {
                                    b.last = a["non-dropping-particle"] + " " + b.last;
                                }
                                if (a["dropping-particle"]) {
                                    b.last = a["dropping-particle"] + " " + b.last;
                                }
                                if (a.suffix) {
                                    b.jr = a.suffix;
                                }
                            }
                            d[h].push(b);
                        });
                    }
                } else if (h == "published" || h == "accessed" || h == "originally_published") {
                    if ("date-parts" in i) {
                        if (PP.Utils.isArray(i["date-parts"]) && PP.Utils.isArray(i["date-parts"][0])) {
                            var j = {};
                            if (i["date-parts"][0][0]) j.year = i["date-parts"][0][0] + "";
                            if (i["date-parts"][0][1]) j.month = i["date-parts"][0][1] + "";
                            if (i["date-parts"][0][2]) j.day = i["date-parts"][0][2] + "";
                            d[h] = j;
                        }
                    }
                } else if (h == "annote") {
                    if (i.match(/PMID:\s*(\d+)/)) {
                        d.pmid = RegExp.$1;
                    }
                    d[h] = i;
                } else {
                    d[h] = i;
                }
            }
            if (d["language"]) d["language"] = PP.Utils.normalizeLanguage(d["language"]);
            if (d["journal"] && f) {
                d["journal_full"] = d["journal"];
                d["journal"] = f;
            }
            b.push(d);
        });
        return b;
    },
    doWrite: function(a, b) {
        if (a.length > 1) {
            console.log("Only one pub at a time is supported!");
        } else if (!PP.Utils.isArray(a)) {
            a = [ a ];
        }
        var c = PP.Utils.clone(a[0]);
        var d = PP.library.PublicationTypes.getPubType(c.pubtype);
        if (d.excluded_fields) {
            d.excluded_fields.forEach(function(a) {
                if (a in c) delete c[a];
            });
        }
        if (b && "style_conf" in b) {
            if (PP.Utils.isString(b.style_conf)) {
                b.style_conf = JSON.parse(b.style_conf);
            }
        }
        var e = this.toCSL(c, b);
        if (b.stringOutput) {
            delete e["pp-data"];
            return JSON.stringify(e, null, 2);
        } else {
            if (b.noDataBackup) delete e["pp-data"];
            return e;
        }
    },
    applyPreModifications: function(a, b) {
        if ("style_conf" in b && "pre" in b.style_conf) {
            b.style_conf.pre.forEach(function(b) {
                if ("req" in b && "act" in b) {
                    var c = true;
                    b.req.forEach(function(b) {
                        var d = true;
                        for (var e in b) {
                            if (e in a) {
                                if (!a[e].match(new RegExp("^" + b[e] + "$", "i"))) d = false;
                            } else {
                                d = false;
                            }
                        }
                        if (!d) c = false;
                    });
                    if (!c) return;
                    b.act.forEach(function(b) {
                        for (var c in b) {
                            if (a[c]) {
                                if (b[c]["delete"]) {
                                    delete a[c];
                                }
                            } else {
                                if (b[c].value) {
                                    var d = b[c].value.split(/(%%[a-z]+%%)/i);
                                    for (var e = 0; e < d.length; e++) {
                                        var f = d[e].match(/^%%([a-z]+)%%$/i);
                                        if (f && f.length === 2) {
                                            var g = f[1];
                                            if (g in a) {
                                                if (PP.Utils.isString(a[g])) {
                                                    d[e] = a[g];
                                                } else if (g == "author" || g == "editor" || g == "contributor" || g == "translator" || g == "series_editor") {
                                                    d[e] = PP.library.Author.toString(a[g], {
                                                        output: "firstlast"
                                                    }).replace(/\b([A-Z])\b/g, "$1.");
                                                }
                                            }
                                        }
                                    }
                                    b[c].value = d.join("");
                                    a[c] = b[c].value;
                                }
                            }
                        }
                    });
                }
            });
        }
    },
    applyPostModifications: function(a, b) {
        if ("style_conf" in b && "post" in b.style_conf) {
            b.style_conf.post.forEach(function(b) {
                if ("req" in b && "act" in b) {
                    var c = true;
                    b.req.forEach(function(b) {
                        var d = true;
                        for (var e in b) {
                            if (e in a) {
                                if (!a[e].match(new RegExp("^(" + b[e].join("|") + ")$", "i"))) d = false;
                            } else {
                                d = false;
                            }
                        }
                        if (!d) c = false;
                    });
                    if (!c) return;
                    b.act.forEach(function(b) {
                        for (var c in b) {
                            if (a[c]) {
                                if (b[c].rename) {
                                    a[b[c].rename] = a[c];
                                    delete a[c];
                                } else if (b[c].modify) {
                                    b[c].modify.forEach(function(b) {
                                        a[c] = a[c].replace(new RegExp(b[0], "i"), b[1]);
                                    });
                                }
                            }
                        }
                    });
                }
            });
        }
    },
    toCSL: function(a, b) {
        var c = {};
        var d = b.prefixSuffix;
        if (d === undefined) {
            d = "";
        }
        if (b.includeDOI === undefined) {
            b.includeDOI = 0;
        }
        if (b.includeURL === undefined) {
            b.includeURL = b.includeDOI;
        }
        this.applyPreModifications(a, b);
        c.type = PP.library.PublicationTypes.getOutputTypeForPub(a, "csl");
        if (!c.type) {
            PP.log({
                type: "error",
                subtype: "Citeproc Output: missing CSL type",
                msg: "No CSL type found when outputting to citeproc format",
                pub: a
            });
            return undefined;
        }
        var e = {};
        if (b.style_conf && b.style_conf.options) {
            e = b.style_conf.options;
        }
        var f = PP.library.PublicationFields.getOutputMapForPubType(a.pubtype, "csl", e);
        if (b.extraKeys) {
            b.extraKeys.forEach(function(a) {
                f[a] = a;
            });
        }
        this.applyMapping(a, c, f, d);
        this.checkUrlAndDOI(a, c, b);
        this.applyPostModifications(c, b);
        c["pp-data"] = PP.Utils.clone(a);
        return c;
    },
    applyMapping: function(a, b, c, d) {
        var e = [ "journal", "title" ];
        var f = PP.library.PublicationFields.getDateFieldNames();
        var g = PP.library.PublicationFields.getAuthorFieldNames();
        for (var h in c) {
            var i = c[h];
            var j = a[h];
            if (h === "url") {
                if (j && j.length > 0) {
                    j = j[0];
                } else {
                    var k = PP.library.Publication.links(a);
                    if (k && k.length > 0) {
                        j = k[0];
                    }
                }
            } else if (h in a) {
                if (f.indexOf(h) > -1) {
                    j = PP.library.Date.toCSL(j);
                } else if (g.indexOf(h) > -1) {
                    var l = [];
                    j.forEach(function(a) {
                        var b = PP.library.Author.toCSL(a);
                        if (b) l.push(b);
                    });
                    j = l;
                } else if (h == "jurisdiction") {
                    j = PP.library.Jurisdictions.getJurisdictionCSL(j);
                } else if (h == "court") {
                    var m;
                    if (a.jurisdiction) {
                        m = PP.library.Jurisdictions.getJurisdictionCSL(a.jurisdiction);
                    }
                    j = PP.library.Jurisdictions.getCourtAbbreviation(j, m);
                } else {
                    if (h === "title" || h === "booktitle") {
                        j = PP.String.interconvertString(j, {
                            format: "html"
                        });
                        j = j + d;
                    } else if (h === "journal") {
                        if (a.pubtype === "PP_ARTICLE" || a.pubtype === "PP_NEWS_ARTICLE") {
                            j = j + d;
                            if (a["journalfull"]) {
                                b["container-title-short"] = j;
                                b["journalAbbreviation"] = j;
                                this._add_citeproc_abbrev(b, a["journalfull"] + d, j, i);
                                j = a["journalfull"] + d;
                            }
                        }
                    }
                }
            } else {
                j = undefined;
            }
            var n = false;
            if (!(i in b)) {
                n = true;
            } else {
                if (b[i] === undefined) {
                    n = true;
                }
            }
            if (j === undefined) n = false;
            if (n) {
                if (PP.Utils.isString(j)) {
                    j = PP.String.removeControlChars(j);
                }
                b[i] = j;
            }
        }
        for (var o in b) {
            if (b[o] === undefined) delete b[o];
            if (b[o] == "undefined") delete b[o];
        }
    },
    checkUrlAndDOI: function(a, b, c) {
        var d = c.includeDOI;
        var e = c.includeDOI;
        if (a.pubtype && a.pubtype == "PP_WEBSITE") e = 1;
        if (a.pubtype && a.pubtype.match(/^(PP_BOOK|PP_BOOK_CHAPTER)$/i)) {
            if (a.kind && a.kind.match(/Electronic Book/i)) {
                d = 1;
                e = 1;
            }
        }
        if (a.pubtype) {
            if (a.pubtype.match(/(PP_ARTICLE|PP_NEWS_ARTICLE|PP_CONFERENCE_PAPER)/i)) {
                if (!a.pages) {
                    d = 1;
                    e = 1;
                } else {
                    if (a.pages == "") {
                        d = 1;
                        e = 1;
                    }
                }
            } else if (!a.pubtype.match(/^(PP_BOOK|PP_BOOK_CHAPTER)$/i)) {
                d = 1;
                e = 1;
            }
        }
        if (!d) delete b["DOI"];
        if (!e) delete b["URL"];
    },
    _add_citeproc_abbrev: function(a, b, c, d) {
        if (!a.abbreviations) {
            a.abbreviations = {};
        }
        if (!a.abbreviations[d]) {
            a.abbreviations[d] = {};
        }
        a.abbreviations[d][b] = c;
    }
});

PP.format.CSL = new PP.format._CSL();

PP.format._CSV = PP.format.AbstractReader.extend({
    debug: false,
    orderedOutput: [ "Item type", "Authors", "Editors", "Title", "Journal", "Full journal", "Publication year", "Volume", "Issue", "Pages", "Folders filed in", "Labels filed in", "Institution", "Number", "Edition", "Publisher", "Address", "Book title", "Website name", "Patent title", "Proceedings title", "Conference", "Conference location", "Conference date", "Date published", "Date accessed", "ISBN", "ISBN (alt.)", "ISSN", "ISSN (alt.)", "LCCN", "ISMN", "URLs", "Call number", "DOI", "PMID", "MR Number", "Zbl Number", "Arxiv ID", "Associated DOI", "PMC ID", "Abstract", "Keywords", "Notes", "Short title", "Status", "Copyright", "Affiliation", "Contributors", "Translators", "Language", "Sub-type", "Series", "Series number", "Series editors", "Original title", "Original publisher", "Original address", "Date of the original publication", "Archive prefix", "Archive", "Archive location", "Archive place", "Eprint ID", "Primary class", "Custom sub-type", "BibTeX key", "Chapter", "Pages cited", "Page count", "Volume count", "Advisor", "School", "Department", "Degree", "Source", "How published", "Collection editor", "Collection", "Collection number", "Inventors", "Assignee", "Issuing authority", "Patent number", "Date filed", "Type of patent", "Issuing office full name", "Patent publication type", "Application number", "Class", "International class", "Field of search", "Designated states", "Priority numbers", "Foreign references", "Event name", "Event place", "Presenter", "Date", "Date of the event", "Version", "Dataset name", "Dataset author(s)", "Dataset URL", "Dataset DOI", "Publication title", "Publication DOI", "Author or source", "Recipient", "Scale", "Running time", "Medium", "Program Title", "Directors", "Network", "Episode Number", "Broadcast date", "Format", "Cast members", "Producers", "Performers", "Label or publisher", "Date released", "Album name", "Composers", "Studio or distributor", "Country", "Artist", "Size", "Composer", "Composition date", "Sponsoring agency", "Date granted", "Date submitted", "Issuing Agency", "Cartographer", "Sender", "Interview with", "Interviewer", "Type", "Magazine", "Title of the reviewed item", "Reviewed author", "Encyclopedia title" ],
    getName: function() {
        return "CSV";
    },
    doWrite: function(a, b) {
        if (!PP.Utils.isArray(a)) {
            a = [ a ];
        }
        var c = [ "owner_name", "owner_email", "source_id", "cite_alias", "sha1", "folders", "labels", "autoCleaned", "dup_sha1", "shared_folders", "id_list", "incomplete", "count_index", "imported", "owner", "journal_checked", "subfolders", "updated", "collection_timestamps", "external_pdf_filename", "duplicates", "created" ];
        var d = {};
        var e = {};
        PP.library.PublicationTypes.getPubTypes().forEach(function(a) {
            d[a.id] = {
                pubtype: "Item type",
                year: "Publication year",
                foldersNamed: "Folders filed in",
                labelsNamed: "Labels filed in"
            };
            var b = PP.library.PublicationFields.getFieldsForPubType(a.id);
            b.forEach(function(b) {
                if (c.indexOf(b.name) == -1) {
                    var f = b.label;
                    if (f == "Chapter authors") {
                        f = "Authors";
                    } else if (f == "Book editors") {
                        f = "Editors";
                    } else if (f == "Chapter title") {
                        f = "Title";
                    } else if (f == "Editor of the collection") {
                        f = "Collection editor";
                    } else if (f == "Chapter pages") {
                        f = "Pages";
                    }
                    d[a.id][b.name] = f;
                    e[b.label] = 1;
                }
            });
        });
        var f = {};
        var g = [];
        a.forEach(function(a) {
            var b = {};
            for (var c in a) {
                if (c in d[a.pubtype]) {
                    if (a[c] !== undefined) {
                        var e = a[c];
                        var h = PP.library.PublicationFields.getFieldType(c);
                        if (h == "author") {
                            e = PP.library.Author.toString(e);
                        } else if (h == "date") {
                            if (c == "published") {
                                if ("year" in e) {
                                    b[d[a.pubtype]["year"]] = e.year;
                                    f[d[a.pubtype]["year"]] = 1;
                                }
                            }
                            e = PP.library.Date.toString(e, {
                                dashed: true
                            });
                        } else if (PP.Utils.isArray(e)) {
                            e = e.join(";");
                        } else if (c == "pubtype") {
                            e = PP.library.PublicationTypes.getLabel(a);
                        }
                        b[d[a.pubtype][c]] = e;
                        f[d[a.pubtype][c]] = 1;
                    }
                }
            }
            g.push(b);
        });
        var h = [];
        var i = Object.keys(f);
        this.orderedOutput.forEach(function(a) {
            if (i.indexOf(a) > -1) {
                h.push(a);
            }
        });
        i.forEach(function(a) {
            if (h.indexOf(a) == -1) {
                h.push(a);
            }
        });
        var j = '"' + h.join('","') + '"\n';
        g.forEach(function(a) {
            var b = [];
            h.forEach(function(c) {
                var d = "";
                if (a[c]) d = a[c];
                if (!PP.Utils.isString(d)) {
                    d = d.toString();
                }
                d = d.replace(/\"/g, '\\"');
                b.push(d);
            });
            j += '"' + b.join('","') + '"\n';
        });
        return j;
    }
});

PP.format.CSV = new PP.format._CSV();

PP.format._CNKI = PP.format.AbstractReader.extend({
    doRead: function(a) {
        var b = this._readHTML(a);
        PP.library.Publication.autoClean(b);
        return [ b ];
    },
    _readHTML: function(a) {
        var a = a.replace(/(\n|\r)/g, " ");
        var b = {
            url: [],
            pubtype: "PP_ARTICLE",
            keywords: []
        };
        var c = a.match(/<paperpileurl>(.*)<\/paperpileurl>/);
        if (c && c.length) {
            var d = c[1].match(/(\w\w\w\w)total/i);
            if (d && d.length > 0) {
                switch (d[1]) {
                  case "CLKM":
                    b.pubtype = "PP_THESIS";
                    break;

                  case "CPFD":
                    b.pubtype = "PP_CONFERENCE_PAPER";
                    break;

                  case "CCND":
                    b.pubtype = "PP_NEWS_ARTICLE";
                    break;

                  default:
                    break;
                }
            }
        }
        var e = $(a).find("div a b");
        b.journal = $(e).text().trim().replace(/(\u300a|\u300b)/g, "");
        var f = $(a).find("div a font");
        var g = $(f).text().trim();
        if (g) {
            b.published = {};
            var h = g.split("-");
            for (var i = 0; i < h.length; i++) {
                if (i == 0) {
                    b.published.year = h[i];
                } else if (i == 1) {
                    b.published.month = h[i];
                } else if (i == 2) {
                    b.published.day = h[i];
                }
            }
        }
        var j = $(a).find("div h2");
        b.title = $(j).text();
        var k = a.match(/<meta name="description" content="(.*)\.">/);
        if (k && k.length) {
            b.abstract = k[1];
        } else {
            var l = a.match(/<div style="text-indent:2em;text-align:left;word-break:break-all;line-height:20px;">(.*)<\/div>/);
            if (l && l.length) b.abstract = l[1];
        }
        var m = $(a).find("div strong");
        var n = $(m).text();
        var o = [];
        var p = n.split(";");
        p.forEach(function(a) {
            if (a.split(" ").length < 3) {
                o.push(a);
            }
        });
        b.author = this.parseAuthors(o);
        var q = a.match(/<meta name="keyWord" content="(.*),">/);
        if (q && q.length) b.keywords = q[1].split(",");
        return b;
    },
    normalizeStr: function(a) {
        var b = "";
        if (a) {
            b = a.replace(/^[\n\t\r\s]+/, "").replace(/[\n\t\r\s]+$/, "").replace(/[\t\r\n\s]+/g, " ");
        }
        return b;
    },
    parseAuthors: function(a) {
        var b = [];
        for (var c = 0; c < a.length; c++) {
            var d = a[c].split(" ");
            var e = {
                first: "",
                last: ""
            };
            for (var f = 0; f < d.length; f++) {
                if (f === 0) {
                    e.last += d[f];
                } else {
                    e.first += d[f];
                }
            }
            b.push(e);
        }
        return b;
    },
    getName: function() {
        return "CNKI";
    }
});

PP.format.CNKI = new PP.format._CNKI();

PP.format._ContextObject = PP.format.AbstractReader.extend({
    doRead: function(a) {
        if (typeof a == "string") {
            var b = this._readContextObject(a);
            PP.library.Publication.autoClean(b);
            return [ b ];
        } else {
            return [];
        }
    },
    _readContextObject: function(a) {
        var b = {
            author: [ {} ],
            url: []
        };
        var c = {
            "rft.atitle": "title",
            "rft.btitle": "title",
            "rft.title": "journal",
            "rft.jtitle": "journal",
            "rft.stitle": "journal",
            "rft.volume": "volume",
            "rft.issue": "issue",
            "rft.spage": "startpage",
            "rft.epage": "endpage",
            "rft.pages": "pages",
            "rft.tpages": "num_pages",
            "rft.issn": "issn",
            "rft.eissn": "issn",
            "rft.assignee": "assignee",
            "rft.aulast": "author",
            "rft.aufirst": "author",
            "rft.auinitm": "author",
            "rft.auinit1": "author",
            "rft.ausuffix": "author",
            "rft.aucorp": "author",
            "rft.au": "author",
            "rft.aucorp": "author",
            "rft.invlast": "author",
            "rft.invfirst": "author",
            "rft.creator": "author",
            "rft.contributor": "author",
            "rft.inventor": "author",
            "rft.edition": "edition",
            "rft.series": "series",
            "rft.isbn": "isbn",
            "rft.genre": "type",
            rft_val_fmt: "type",
            "rft.pub": "publisher",
            "rft.publisher": "publisher",
            "rft.date": "date",
            "rft.place": "address",
            rft_id: "ID",
            "rft.inst": "institution",
            issn: "issn",
            title: "journal",
            atitle: "title",
            volume: "volume",
            issue: "issue",
            aulast: "author",
            aufirst: "author",
            date: "date",
            spage: "startpage",
            epage: "endpage"
        };
        a = a.replace(/&amp;/g, "&");
        a = a.replace(/\n/g, "");
        var d = {};
        a.split("&").forEach(function(a) {
            var d = a.split("=");
            d[0] = d[0].toLowerCase();
            if (d[1] && c[d[0]]) {
                var e = decodeURIComponent(d[1]);
                if (c[d[0]] != "ID") {
                    e = e.replace(/\+/g, " ");
                }
                e = e.replace(/,\s*$/, "");
                if (c[d[0]] === "author") {
                    if (d[0] === "rft.aulast" || d[0] === "aulast" || d[0] === "rft.invlast") {
                        b["author"][0]["last"] = e;
                    }
                    if (d[0] === "rft.aufirst" || d[0] === "aufirst" || d[0] === "rft.invfirst") {
                        b["author"][0]["first"] = e;
                    }
                    if (d[0] === "rft.auinit1") {
                        b["author"][0]["auinit1"] = e;
                    }
                    if (d[0] === "rft.auinitm") {
                        b["author"][0]["auinitm"] = e;
                    }
                    if (d[0] === "rft.au") {
                        b["author"].push(PP.library.Author.parseAuthor(e, {
                            familyNameFirst: false
                        }));
                    }
                    if (d[0] === "rft.aucorp") {
                        b["author"].push({
                            collective: e
                        });
                    }
                } else if (c[d[0]] === "issn") {
                    if (b["issn"]) {
                        if (e != b["issn"]) {
                            b["issn_alt"] = e;
                        }
                    } else {
                        b["issn"] = e;
                    }
                } else if (c[d[0]] === "isbn") {
                    var f = PP.Utils.extractISBNs(e, {
                        convert: true,
                        unique: true
                    });
                    var g;
                    while (g = f.shift()) {
                        if (!b.isbn) {
                            b.isbn = g;
                        } else {
                            if (!b.isbn_alt) b.isbn_alt = g;
                        }
                    }
                } else if (c[d[0]] === "type") {
                    if (e.toUpperCase() === "BOOK") {
                        b["pubtype"] = "PP_BOOK";
                    }
                    if (e.toUpperCase() === "BOOKITEM") {
                        b["pubtype"] = "PP_BOOK_CHAPTER";
                    }
                    if (e.toUpperCase() === "PROCEEDING") {
                        b["pubtype"] = "PP_CONFERENCE_PAPER";
                    }
                    if (e.toUpperCase() === "REPORT") {
                        b["pubtype"] = "PP_REPORT";
                    }
                    if (e.toUpperCase() === "DOCUMENT") {
                        b["pubtype"] = "PP_MISC";
                    }
                    if (e.toUpperCase() === "UNKNOWN" && !b["pubtype"]) {
                        b["pubtype"] = "PP_MISC";
                    }
                    if (e.toUpperCase() === "DISSERTATION") {
                        b["pubtype"] = "PP_THESIS";
                    }
                    if (e.toUpperCase() === "INFO:OFI/FMT:KEV:MTX:PATENT") {
                        b["pubtype"] = "PP_PATENT";
                    }
                    if (e.toUpperCase() === "INFO:OFI/FMT:KEV:MTX:DC") {
                        b["pubtype"] = "PP_WEBSITE";
                    }
                    if (e.toUpperCase() === "INFO:OFI/FMT:KEV:MTX:BOOK") {
                        b["pubtype"] = "PP_BOOK";
                    }
                    if (e.toUpperCase() === "INFO:OFI/FMT:KEV:MTX:DISSERTATION") {
                        b["pubtype"] = "PP_THESIS";
                    }
                    if (e.toUpperCase() === "JOURNAL") {
                        b["pubtype"] = "PP_MISC";
                    }
                } else if (c[d[0]] === "date") {
                    var h = PP.library.Date.parseDate(e);
                    if (h["year"]) b["year"] = h["year"];
                    if (h["month"]) b["month"] = h["month"];
                    if (h["day"]) b["day"] = h["day"];
                } else if (c[d[0]] === "ID") {
                    if (e.match(/(10\.\d\d\d\d\d?\/\S+)/)) {
                        b["doi"] = RegExp.$1;
                    }
                    if (e.match(/info:pmc\/(\d+)/)) {
                        b["pmc"] = "PMC" + RegExp.$1;
                    }
                    if (e.match(/info:pmid\/(\d+)/)) {
                        b["pmid"] = RegExp.$1;
                    }
                    if (e.match(/^http/)) {
                        b["url"].push(e);
                    }
                    if (e.match(/urn:isbn:([\d-X]+)/)) {
                        if (b["isbn"]) {
                            if (RegExp.$1 != b["isbn"]) {
                                b["ibsn_alt"] = RegExp.$1;
                            }
                        } else {
                            b["isbn"] = RegExp.$1;
                        }
                    }
                } else {
                    b[c[d[0]]] = e;
                }
            }
        });
        if (b["address"]) {
            b["address"] = b["address"].replace(/\s*:\s*$/, "");
            b["address"] = b["address"].replace(/;+/g, ";");
        }
        if (b["author"][0]["auinit1"]) {
            if (!b["author"][0]["first"]) {
                b["author"][0]["first"] = b["author"][0]["auinit1"];
            }
            delete b["author"][0]["auinit1"];
        }
        if (b["author"][0]["auinitm"]) {
            if (b["author"][0]["first"]) {
                b["author"][0]["first"] += " " + b["author"][0]["auinitm"];
            } else {
                b["author"][0]["first"] = b["author"][0]["auinitm"];
            }
            delete b["author"][0]["auinitm"];
        }
        if (b["author"][0]) {
            PP.library.Author.autoClean(b["author"][0]);
            if (!b["author"][0]["last"] && !b["author"][0]["collective"]) {
                b["author"].shift();
            }
        }
        if (b["author"].length > 1) {
            if (b["author"][0].last == b["author"][1].last) {
                if (b["author"][0].first == b["author"][1].first) {
                    b["author"].shift();
                }
            }
        }
        if (!b["pubtype"]) {
            b["pubtype"] = "PP_ARTICLE";
        }
        if (b["pubtype"] === "PP_BOOK") {
            if (b["pages"]) {
                b["num_pages"] = b["pages"];
                delete b["pages"];
            }
            if (!b["title"] && b["journal"]) {
                b["title"] = b["journal"];
            }
            if (b["journal"]) delete b["journal"];
        }
        if (b["pubtype"] === "PP_BOOK_CHAPTER" || b["pubtype"] === "PP_CONFERENCE_PAPER") {
            if (b["journal"]) {
                if (!b["booktitle"]) {
                    b["booktitle"] = b["journal"];
                }
                delete b["journal"];
            }
        }
        if (b["pubtype"] === "PP_THESIS" || b["pubtype"] === "PP_MISC") {
            if (b["journal"] && !b["title"]) {
                b["title"] = b["journal"];
                delete b["journal"];
            }
        }
        return b;
    },
    getName: function() {
        return "ContextObject";
    }
});

PP.format.ContextObject = new PP.format._ContextObject();

PP.format._Datacite = PP.format.AbstractReader.extend({
    parsingRules: {
        title: [ "titles title" ],
        abstract: [ "descriptions description[descriptionType=Abstract]" ],
        publisher: [ "publisher" ],
        doi: [ "identifier[identifierType=DOI]" ],
        year: [ "publicationYear" ],
        author: [ "creators creator creatorName" ],
        resourceType: [ "resourceType" ],
        url: [ "alternateIdentifiers alternateIdentifier[alternateIdentifierType=URL]" ],
        isbn: [ "alternateIdentifiers alternateIdentifier[alternateIdentifierType=ISBN]" ]
    },
    doRead: function(a) {
        var b;
        if (typeof a == "string") {
            b = this.getXMLParser(a);
        } else if (typeof a == "object") {
            b = a;
        }
        var c = [];
        var d = $(b).find("record");
        if (d && d.length) {
            for (var e = 0; e < d.length; e++) {
                var f = $(d[e]).html();
                var g = this._readDatacite(f);
                if (g) {
                    PP.library.Publication.autoClean(g);
                    c.push(g);
                }
            }
        } else {
            var g = this._readDatacite(b);
            if (g) {
                PP.library.Publication.autoClean(g);
                c.push(g);
            }
        }
        return c;
    },
    _readDatacite: function(a) {
        var b = {
            author: [],
            editor: [],
            resourceTypeGeneral: "NA",
            resourceType: "NA",
            url: []
        };
        for (var c in this.parsingRules) {
            for (var d = 0; d < this.parsingRules[c].length; d++) {
                var e = $(a).find(this.parsingRules[c][d]);
                if (e) {
                    if (e[0]) {
                        if (c == "author") {
                            for (var f = 0; f < e.length; f++) {
                                if ($(e[f]).text() && !$(e[f]).text().match(/No Name Supplied/i)) {
                                    var g = PP.library.Author.parseAuthor($(e[f]).text(), {
                                        familyNameFirst: false
                                    });
                                    b["author"].push(g);
                                }
                            }
                        } else if (c == "resourceType") {
                            var h = this._getAttribute(e[0], "resourceTypeGeneral");
                            if (h) b.resourceTypeGeneral = h;
                            if ($(e[0]).text()) b.resourceType = $(e[0]).text();
                        } else if (c == "url") {
                            for (var f = 0; f < e.length; f++) {
                                if ($(e[f]).text().match(/^http/)) b.url.push($(e[f]).text());
                            }
                        } else if (c == "isbn") {
                            var i = PP.Utils.extractISBNs($(e[0]).text(), {
                                convert: true,
                                unique: true
                            });
                            if (i[0]) b.isbn = i[0];
                            if (i[1]) b.isbn_alt = i[1];
                        } else {
                            if (!b[c]) b[c] = $(e[0]).text();
                        }
                    }
                }
            }
        }
        b.pubtype = "PP_MISC";
        var j = {
            dissertation: "PP_THESIS",
            datasheet: "PP_DATASET",
            dataset: "PP_DATASET",
            article: "PP_ARTICLE",
            "^book$": "PP_BOOK",
            "conference[\\s-]*paper": "PP_CONFERENCE_PAPER",
            report: "PP_REPORT"
        };
        if (b.resourceTypeGeneral == "Software") {
            b.pubtype = "PP_COMPUTER_PROGRAM";
        } else if (b.resourceTypeGeneral == "Dataset") {
            b.pubtype = "PP_DATASET";
        } else if (b.resourceTypeGeneral == "Image") {
            b.pubtype = "PP_FIGURE";
        } else if (b.resourceTypeGeneral == "Audiovisual") {
            b.pubtype = "PP_VIDEO";
        } else if (b.resourceTypeGeneral == "Sound") {
            b.pubtype = "PP_AUDIO";
        }
        if (b.pubtype == "PP_MISC") {
            for (var k in j) {
                if (b.resourceType.match(new RegExp(k, "i"))) b.pubtype = j[k];
            }
        }
        delete b.resourceType;
        delete b.resourceTypeGeneral;
        if (b.publisher && b.publisher.match(/No Publisher Supplied/i)) {
            delete b.publisher;
        }
        if (!b.title) {
            if (b.doi) {
                b.title = b.doi;
                b.pubtype = "PP_MISC";
            }
        }
        return b;
    },
    getName: function() {
        return "Datacite";
    }
});

PP.format.Datacite = new PP.format._Datacite();

PP.format._EMail = PP.format.AbstractReader.extend({
    doRead: function(a) {
        var b = this;
        var c = [];
        var d = this.decideOnFormat(a);
        if (d == "GS") {
            c = this.googleScholarAlert(a);
        } else if (d == "RG") {
            c = this.researchGateAlert(a);
        } else if (d == "PM") {
            c = this.pubMedAlert(a);
        } else if (d == "EB") {
            c = this.easyBibEMail(a);
        } else if (d == "WoK") {
            c = this.webOfScienceAlert(a);
        } else if (d == "BMC") {
            c = this.BMCAlert(a);
        }
        c.forEach(function(a) {
            if (a.journal && a.pubtype != "PP_PATENT") {
                a.pubtype = "PP_ARTICLE";
            }
        });
        return c;
    },
    decideOnFormat: function(a) {
        if (a.match(/From: Google Scholar Alerts <scholaralerts-noreply/)) {
            return "GS";
        } else if (a.match(/From: ResearchGate <no-reply\@researchgate.net/)) {
            return "RG";
        } else if (a.match(/From: My NCBI <efback\@mail.nih.gov>/)) {
            return "PM";
        } else if (a.match(/Subject: EasyBib\.com Citation List/)) {
            return "EB";
        } else if (a.match(/Web of Science Alert/) && a.match(/noreply@isiknowledge.com/)) {
            return "WoK";
        } else if (a.match(/BioMed Central Article Alert/)) {
            return "BMC";
        }
        return "unkown";
    },
    easyBibEMail: function(a) {
        var b = [];
        var c = this;
        var d = {
            title: "title",
            year: "year",
            publisher: "publisher",
            city: "address"
        };
        $(a).find("p a").each(function(a, c) {
            if ($(c).attr("href").match(/.*form\?data=(.+)/)) {
                var e = JSON.parse(unescape(RegExp.$1));
                var f = {
                    pubtype: "PP_MISC",
                    author: [],
                    editor: []
                };
                if (e.pubnonperiodical) {
                    for (var g in d) {
                        if (e.pubnonperiodical[g]) {
                            f[d[g]] = e.pubnonperiodical[g].replace(/\+/g, " ");
                        }
                    }
                }
                if (e.contributors) {
                    e.contributors.forEach(function(a) {
                        var b = {
                            last: a.last,
                            first: a.first
                        };
                        if (a.middle) {
                            b.first += " " + a.middle;
                        }
                        if (a["function"]) {
                            if (a["function"] == "editor") {
                                f.editor.push(b);
                            } else {
                                f.author.push(b);
                            }
                        }
                    });
                }
                if (e.source && e.source == "book") {
                    f.pubtype = "PP_BOOK";
                }
                b.push(f);
            }
        });
        return b;
    },
    pubMedAlert: function(a) {
        var b = [];
        var c = this;
        $(a).find("div table a").closest("table").each(function(a, d) {
            var e = $(d).find("a").text();
            b.push({
                pubtype: "PP_MISC",
                title: e,
                url: []
            });
            var f = $(d).find("a").attr("href");
            if (f) {
                b[b.length - 1].url.push(f);
            }
            $(d).find("tr").each(function(a, d) {
                var e = $(d).text();
                if (a == 1) {
                    b[b.length - 1].author = [];
                    e.split(/\s*,\s*/).forEach(function(a) {
                        var c = PP.library.Author.parseAuthor(a, {
                            familyNameFirst: true
                        });
                        b[b.length - 1].author.push(c);
                    });
                } else if (a == 2) {
                    var f = PP.library.BibliographicData.parse(e);
                    if (f && f.journal) {
                        c.copyBiblioData(b[b.length - 1], f);
                    }
                    if (!b[b.length - 1].journal) {
                        b[b.length - 1].journal = e.replace(/\..*/, "");
                    }
                }
            });
        });
        return b;
    },
    BMCAlert: function(a) {
        var b = [];
        var c = this;
        $(a).find("table tr:contains(Abstract)").each(function(a, d) {
            var e = $(d).find("span.xcitationtitle").text();
            b.push({
                pubtype: "PP_MISC",
                title: e,
                url: [],
                author: []
            });
            var f = $(d).find("a:contains(Abstract)").attr("href");
            if (f) {
                b[b.length - 1].url.push(f);
            }
            var g = $(d).find("span.smalltext").last().html();
            if (g) {
                var h = g.split(/<br\/?>/);
                if (h && h.length == 3) {
                    PP.library.Author.parseAuthorList($("<div>" + h[0] + "</div>").text(), {
                        multiple: true,
                        auto: false,
                        delimiter: ","
                    }).forEach(function(a) {
                        b[b.length - 1].author.push(a);
                    });
                    var i = PP.library.BibliographicData.parse($("<div>" + h[1] + "</div>").text());
                    if (i) {
                        c.copyBiblioData(b[b.length - 1], i);
                    }
                }
            }
        });
        return b;
    },
    webOfScienceAlert: function(a) {
        var b = [];
        var c = this;
        $(a).find("table td:contains(Title)").closest("table").each(function(a, d) {
            b.push({
                pubtype: "PP_MISC",
                author: []
            });
            $(d).find("tr td").each(function(a, d) {
                var e = $(d).text().replace(/[\t\n\s]+/g, " ");
                e = e.replace(/^\s+/, "").replace(/\s+$/, "");
                if (e.match(/^Title:(.+)/)) {
                    b[b.length - 1].title = RegExp.$1;
                }
                if (e.match(/^Authors:(.+)/)) {
                    PP.library.Author.parseAuthorList(RegExp.$1, {
                        multiple: true,
                        auto: true
                    }).forEach(function(a) {
                        b[b.length - 1].author.push(a);
                    });
                }
                if (e.match(/^Source:(.+)/)) {
                    var f = PP.library.BibliographicData.parse(RegExp.$1);
                    if (f) {
                        c.copyBiblioData(b[b.length - 1], f);
                    }
                }
                if (e.match(/^ISSN:\s*(.+)/)) {
                    b[b.length - 1]["issn"] = RegExp.$1;
                }
                if (e.match(/^Abstract:(.+)/)) {
                    b[b.length - 1]["abstract"] = RegExp.$1;
                }
            });
        });
        return b;
    },
    researchGateAlert: function(a) {
        var b = [];
        var c = this;
        $(a).find("table a span").closest("table").each(function(a, d) {
            var e = $(d).find("a span").text().replace(/\s*$/, "");
            if (e.match(/\.\.\.$/)) {
                e += ".";
            }
            b.push({
                pubtype: "PP_MISC",
                title: e,
                url: []
            });
            var f = $(d).find("a").attr("href");
            if (f) {
                f = f.replace(/\?pli.*/, "");
                b[b.length - 1].url.push(f);
            }
            $(d).find("td p").each(function(a, d) {
                var e = $(d).text().replace(/\.+$/, "");
                if (a == 0) {
                    b[b.length - 1].author = [];
                    e.split(/\s*,\s*/).forEach(function(a) {
                        var c = PP.library.Author.parseAuthor(a, {
                            familyNameFirst: false
                        });
                        b[b.length - 1].author.push(c);
                    });
                } else if (a == 1) {
                    var f = PP.library.BibliographicData.parse(e);
                    if (f && f.journal) {
                        c.copyBiblioData(b[b.length - 1], f);
                    }
                    if (!b[b.length - 1].journal) {
                        b[b.length - 1].journal = e;
                    }
                }
            });
            if (b[b.length - 1].author) {
                if (b[b.length - 1].author.length == 0) {
                    b.pop();
                }
            } else {
                b.pop();
            }
        });
        return b;
    },
    googleScholarAlert: function(a) {
        var b = [];
        $(a).find("h3 a").each(function(a, c) {
            var d = $(c).text().replace(/\[(PDF|BOOK|BUCH|LIBRO|LIVRE|B|[ZC]ITATIONE?|CITAS|C|HTML)\]\s+/, "");
            b.push({
                pubtype: "PP_MISC",
                title: d,
                url: []
            });
            var e = $(c).attr("href");
            if (e) {
                e = e.replace(/(.+&q=)(.+)/, "$2");
                e = e.replace(/&sa=[A-Z]+/, "").replace(/&scisig=.+/, "");
                b[b.length - 1].url.push(e);
            }
        });
        $(a).find("font[color='#006621']").each(function(a, c) {
            var d = $(c).text().split(/\s+-\s+/);
            if (d[0]) {
                b[a].author = [];
                d[0].split(/\s*,\s+/).forEach(function(c) {
                    var d = c.split(/\s+/);
                    if (d[0] && d[0].match(/^\u2026$/)) {
                        b[a].author.push({
                            collective: "others"
                        });
                    } else {
                        if (d[0] && d[1]) {
                            if (d[1].match(/\u2026/)) {
                                d[1] = d[1].replace(/\u2026/, "");
                                b[a].author.push({
                                    last: d[1],
                                    first: d[0]
                                });
                                b[a].author.push({
                                    collective: "others"
                                });
                            } else {
                                b[a].author.push({
                                    last: d[1],
                                    first: d[0]
                                });
                            }
                        }
                    }
                });
            }
            if (d[1]) {
                d[1] = d[1].replace(/\u2026/, "");
                if (d[1].match(/(.+),\s+(\d\d\d\d)\s*$/)) {
                    b[a].journal = RegExp.$1;
                    b[a].year = RegExp.$2;
                } else if (d[1].match(/^\s*(\d\d\d\d)\s*$/)) {
                    b[a].year = RegExp.$1;
                } else {
                    b[a].journal = d[1];
                }
            }
            if (b[a].journal && b[a].journal.match(/^\s*(US\s+Patent)\s+(.+)/)) {
                b[a].pubtype = "PP_PATENT";
                b[a].patent_number = "US" + RegExp.$2.replace(/,/g, "");
                delete b[a].journal;
            }
        });
        $(a).find("font[color='#222222']").each(function(a, c) {
            if (a < b.length) {
                b[a]["abstract"] = $(c).text();
            }
        });
        return b;
    },
    copyBiblioData: function(a, b) {
        if (!b) return;
        if (b.journal) {
            a.journal = b.journal;
        }
        if (b.volume) {
            a.volume = b.volume;
        }
        if (b.pages) {
            a.pages = b.pages;
        }
        if (b.issue) {
            a.issue = b.issue;
        }
        if (b.year) {
            a.year = b.year;
        }
        if (b.month) {
            a.month = b.month;
        }
        if (b.doi && !a.doi) {
            a.doi = b.doi;
        }
    }
});

PP.format.EMail = new PP.format._EMail();

PP.format._EndNote = PP.format.AbstractReader.extend({
    debug: false,
    mapXML: {
        "%A": {
            rules: [ "contributors authors author" ]
        },
        "%B": {
            rules: [ "titles secondary-title" ]
        },
        "%J": {
            rules: [ "titles secondary-title" ]
        },
        "%C": {
            rules: [ "pub-location" ]
        },
        "%D": {
            rules: [ "dates year" ]
        },
        "%E": {
            rules: [ "contributors secondary-authors author" ]
        },
        "%F": {
            rules: [ "label" ]
        },
        "%G": {
            rules: [ "language" ]
        },
        "%I": {
            rules: [ "publisher" ]
        },
        "%K": {
            rules: [ "keywords keyword" ]
        },
        "%L": {
            rules: [ "call-num" ]
        },
        "%N": {
            rules: [ "number" ]
        },
        "%O": {
            rules: [ "alt-title", "orig-pub" ]
        },
        "%P": {
            rules: [ "pages" ]
        },
        "%R": {
            rules: [ "electronic-resource-num" ]
        },
        "%S": {
            rules: [ "tertiary-title" ]
        },
        "%T": {
            rules: [ "titles title" ],
            style: true
        },
        "%U": {
            rules: [ "urls related-urls url" ]
        },
        "%V": {
            rules: [ "volume", "edition" ]
        },
        "%W": {
            rules: [ "remote-database-provider" ]
        },
        "%X": {
            rules: [ "abstract" ]
        },
        "%Y": {
            rules: [ "contributors tertiary-authors author" ]
        },
        "%Z": {
            rules: [ "notes" ]
        },
        "%0": {
            rules: [ "ref-type" ]
        },
        "%4": {
            rules: [ "custom4" ]
        },
        "%6": {
            rules: [ "num-vols" ]
        },
        "%7": {
            rules: [ "edition" ]
        },
        "%8": {
            rules: [ "date" ]
        },
        "%9": {
            rules: [ "work-type" ]
        },
        "%@": {
            rules: [ "isbn" ]
        },
        "%+": {
            rules: [ "auth-address" ]
        },
        "%!": {
            rules: [ "short-title" ]
        },
        "%H": {
            rules: [ "translated-authors" ]
        },
        "%?": {
            rules: [ "subsidiary-authors" ]
        },
        "%(": {
            rules: [ "orig-pub" ]
        },
        "%1": {
            rules: [ "custom1" ]
        },
        "%2": {
            rules: [ "custom2" ]
        },
        "%3": {
            rules: [ "custom3" ]
        },
        "%[": {
            rules: [ "access-date" ]
        },
        "%#": {
            rules: [ "custom5" ]
        },
        "%&": {
            rules: [ "section" ]
        },
        "%>": {
            rules: [ "urls pdf-urls url" ]
        },
        "%\xc4": {
            rules: [ "urls web-urls" ]
        },
        "%\xcb": {
            rules: [ "periodical full-title" ]
        }
    },
    hierarchy: [ "%0", "%V", "%N", "%D", "%8", "%[", "%?", "%X", "%A", "%B", "%C", "%E", "%F", "%G", "%I", "%J", "%K", "%L", "%O", "%P", "%R", "%S", "%T", "%U", "%W", "%Y", "%Z", "%1", "%2", "%3", "%4", "%6", "%7", "%8", "%9", "%@", "%!", "%#", "%$", "%]", "%+", "%<", "%=", "%~", "%>", "%(", "%)", "%&", "%M", "%H", "%\xc4", "%\xcb" ],
    getName: function() {
        return "EndNote";
    },
    doRead: function(a) {
        var b = [];
        if (typeof a == "string") {
            if (a.indexOf("%[") >= 0 && a.indexOf("%[ ") < 0) {
                a = a.replace("%[", "%[ ");
            }
            if (a.indexOf("%(") >= 0 && a.indexOf("%( ") < 0) {
                a = a.replace("%(", "%( ");
            }
            var c = a.split(/\n+/);
            var d = 0;
            for (var e = 0; e < c.length; e++) {
                if (c[e].match(/^\s*%/)) d++;
            }
            if (d / c.length > .1) {
                b = this._parseENW(a);
            } else {
                var f = this.getXMLParser(a);
                b = this._parseXML(f);
            }
        }
        return b;
    },
    _parseXML: function(a) {
        if (this.debug) console.log("parsing xml");
        var b = this;
        var c = [];
        var d, e, f;
        $(a).find("record").each(function() {
            var a = {};
            for (var g in b.mapXML) {
                for (d = 0; d < b.mapXML[g].rules.length; d++) {
                    var h = $(this).find(b.mapXML[g].rules[d]);
                    if (h && h.length > 0) {
                        for (e = 0; e < h.length; e++) {
                            f = PP.Utils.normalizeString($(h[e]).text());
                            var i = "children";
                            var j = "name";
                            if (!(i in h[e])) {
                                i = "childNodes";
                                j = "tagName";
                            } else if (i in h[e] && "childNodes" in h[e] && h[e].childNodes.length >= h[e][i].length) {
                                i = "childNodes";
                                j = "tagName";
                            }
                            if (b.mapXML[g].style && h[e][i]) {
                                f = "";
                                for (var k = 0; k < h[e][i].length; k++) {
                                    if (h[e][i][k][j] == "style") {
                                        var l = b._getAttribute(h[e][i][k], "face");
                                        var m = $(h[e][i][k]).text();
                                        if (l == "italic") {
                                            m = "<i>" + m + "</i>";
                                        } else if (l == "superscript") {
                                            m = "<sup>" + m + "</sup>";
                                        } else if (l == "subscript") {
                                            m = "<sub>" + m + "</sub>";
                                        }
                                        f += m;
                                    } else if (k == 0 && h[e][i].length == 1) {
                                        if ("type" in h[e][i][k] && h[e][i][k].type == "cdata") {
                                            f += h[e][i][k].children[0].data;
                                        } else {
                                            f += $(h[e][i][k]).text();
                                        }
                                    }
                                }
                            }
                            var n = b._getAttribute(h[e], "name");
                            if (!(g in a)) a[g] = [];
                            if (g == "%0" && n) {
                                a[g].push(n);
                            } else {
                                a[g].push(f);
                            }
                        }
                    }
                }
            }
            c.push(a);
        });
        return this._processEntries(c);
    },
    _parseENW: function(a) {
        if (this.debug) console.log("parsing enw");
        var b = a.split(/\n+/);
        var c = [];
        var d = [];
        var e;
        var f = 0;
        for (e in b) {
            if (b[e].match(/^\s*%0\s/)) f++;
        }
        if (f == 1) {
            c.push(b);
        } else if (f > 1) {
            for (e in b) {
                if (b[e].match(/^\s*%0\s/)) {
                    if (d.length > 0) {
                        c.push(d);
                    }
                    d = [];
                }
                d.push(b[e]);
            }
            c.push(d);
        }
        d = [];
        for (e = 0; e < c.length; e++) {
            var g = {};
            var h = "empty";
            for (var i in c[e]) {
                if (c[e][i].match(/^\s*(%.)\s+(.*)/)) {
                    h = RegExp.$1;
                    var j = RegExp.$2;
                    j = j.replace(/\r/g, "");
                    if (!g[h]) g[h] = [];
                    g[h].push(j);
                } else if (c[e][i] == "" || c[e][i].match(/^\s+$/)) {} else {
                    if (!g[h]) g[h] = [];
                    g[h].push(c[e][i]);
                }
            }
            d.push(g);
        }
        return this._processEntries(d);
    },
    _processEntries: function(a) {
        var b = [];
        for (var c = 0; c < a.length; c++) {
            this.fire("progress", {
                progress: c / a.length,
                totalCount: a.length
            });
            var d = a[c];
            if (this.debug) console.log(JSON.stringify(d, null, 2));
            var e = {
                pubtype: "PP_MISC"
            };
            if (d["%0"] && d["%0"][0]) {
                var f = PP.library.PublicationTypes.getInputTypeForPub(d["%0"][0].toUpperCase(), "endnote");
                e["pubtype"] = f.pubtype;
                if (f.kind) {
                    e["kind"] = f.kind;
                }
                if (e["pubtype"] == "PP_MISC") {
                    e["kind"] = d["%0"][0];
                }
            }
            d = this._modifyFieldsByReferenceType(d, e);
            var g = PP.library.PublicationFields.getInputMapForPubType(e.pubtype, "endnote");
            if (this.debug) {
                var h = Object.keys(d);
                var i = {};
                for (var j = 0; j < h.length; j++) {
                    if (typeof g[h[j]] == "undefined") {
                        i[h[j]] = PP.Utils.clone(d[h[j]]);
                    }
                }
                console.log("not in map:", JSON.stringify(i, null, 2));
                var k = Object.keys(g);
                var l = {};
                for (j = 0; j < k.length; j++) {
                    if (typeof d[k[j]] == "undefined") {
                        l[k[j]] = g[k[j]];
                    }
                }
                console.log("unused:", JSON.stringify(l, null, 2));
            }
            g["%D"] = "published";
            g["%8"] = "published";
            g["%>"] = "external_pdf_filename";
            if (this.debug) console.log("map:", JSON.stringify(g, null, 2));
            for (var m in this.hierarchy) {
                var n = d[this.hierarchy[m]];
                if (n) {
                    for (var o = 0; o < n.length; o++) {
                        n[o] = n[o].replace(/^\s+/, "").replace(/\s+$/, "");
                        n[o] = n[o].replace(/\s+/g, " ");
                    }
                    var p = g[this.hierarchy[m]];
                    if (!p) continue;
                    if (p == "author" || p == "editor" || p == "contributor" || p == "translator" || p == "series_editor") {
                        for (var j in n) {
                            var q = PP.library.Author.parseAuthor(n[j], {
                                familyNameFirst: false
                            });
                            if (!e[p]) e[p] = [];
                            e[p].push(q);
                        }
                    } else if (p == "published" || p == "accessed" || p == "filed") {
                        var r = PP.library.Date.parseDate(n[0]);
                        if (!(p in e)) {
                            if (r.year) e[p] = r;
                        } else {
                            if (e[p].year && r.year) {
                                if (r.year == e[p].year && r.month) {
                                    e[p] = r;
                                }
                            } else if (e[p].year && !e[p].month && !e[p].day && !r.year) {
                                if (r.month) {
                                    e[p].month = r.month;
                                    if (r.day) e[p].day = r.day;
                                }
                            }
                        }
                    } else if (p == "url") {
                        if (!e[p]) e[p] = [];
                        for (var s = 0; s < n.length; s++) {
                            n[s].split(/[\n\t\r\s]+/).forEach(function(a) {
                                if (a.match(/^(http|ftp)/)) e[p].push(a);
                            });
                        }
                    } else if (p == "note") {
                        e[p] = n.join(" ");
                    } else if (p == "isbn") {
                        var t = PP.Utils.extractISBNs(n.join(" "), {
                            convert: true,
                            unique: true
                        });
                        if (t[0]) e.isbn = t[0];
                        if (t[1]) e.isbn_alt = t[1];
                    } else if (p == "issn") {
                        if (!e[p]) e[p] = [];
                        var u = n[0].split(/(\d{4}-[X\d]{4})/);
                        u.forEach(function(a) {
                            if (a.match(/(\d{4}-[X\d]{4})/)) e[p].push(a);
                        });
                    } else if (p == "external_pdf_filename") {
                        if (n[0].match(/^internal-pdf/)) {
                            e[p] = n[0].replace(/internal-pdf:\/\//, "");
                        } else if (n[0].match(/^https?:\/\//)) {
                            e.url.push(n[0]);
                        }
                    } else if (p == "keywords") {
                        e[p] = n.join("; ");
                    } else {
                        if (!e[p]) e[p] = n[0];
                    }
                }
            }
            if (e["pubtype"] === "PP_ARTICLE") {
                if (e["booktitle"] && !e["journal"]) {
                    e["journal"] = e["booktitle"];
                    delete e["booktitle"];
                }
            }
            if (e["pubtype"] === "PP_BOOK") {
                if (e["booktitle"] && e["title"]) {
                    if (e["kind"] && e["kind"] === "Proceedings") {
                        e["pubtype"] = "PP_CONFERENCE_PAPER";
                    } else if (e["pages"] && e["pages"].match(/\s*\d+\s*-\s*\d+\s*/)) {
                        e["pubtype"] = "PP_BOOK_CHAPTER";
                    }
                }
            }
            if (e["pubtype"] === "PP_THESIS") {
                if (e["publisher"] && !e["school"]) {
                    e["school"] = e["publisher"];
                    delete e["publisher"];
                }
                if (e["contributor"] && !e["editor"]) {
                    e["editor"] = e["contributor"];
                    delete e["contributor"];
                }
            }
            if (e["pubtype"] === "PP_VIDEO") {
                if (e["translator"] && !e["contributor"]) {
                    e["contributor"] = e["translator"];
                    delete e["translator"];
                }
            }
            if (d["%0"]) {
                if (d["%0"][0] == "Conference Proceedings" || d["%0"][0] == "Dataset") {
                    delete e.translator;
                    delete e.journal;
                }
                if (d["%0"][0] == "Equation" || d["%0"][0] == "Figure" || d["%0"][0] == "Pamphlet") {
                    delete e.editor;
                    delete e.journal;
                }
                if (d["%0"][0] == "Map" || d["%0"][0] == "Music") {
                    delete e.journal;
                    delete e.translator;
                }
            } else {
                e.pubtype = "PP_ARTICLE";
            }
            if (e["language"]) {
                var v = PP.Utils.normalizeLanguage(e["language"]);
                if (v && v.length == 2) e["language"] = v;
            }
            b.push(e);
        }
        if (this.debug) console.log("returning:", JSON.stringify(b, null, 2));
        return b;
    },
    _modifyFieldsByReferenceType: function(a, b) {
        if (b.pubtype == "PP_BOOK" || b.pubtype == "PP_BOOK_CHAPTER" || b.pubtype == "PP_MISC") {
            a["%O"] = a["%("];
            delete a["%("];
        }
        if (b.pubtype == "PP_PATENT") {
            delete a["%Y"];
            delete a["%B"];
        }
        if (b.pubtype == "PP_BOOK") {
            if (a["%B"] && !a["%S"]) {
                a["%S"] = a["%B"];
                delete a["%B"];
            }
        }
        if (b.pubtype == "PP_ARTICLE") {
            if (a["%B"] && !a["%J"]) {
                a["%J"] = a["%B"];
                delete a["%B"];
            }
        }
        if (a["%0"] && a["%0"][0] == "Electronic Article") {
            a["%]"] = a["%3"];
            delete a["%3"];
        }
        if (a["%M"] && !a["%R"]) {
            if (a["%M"][0].match(/10\.\d\d\d\d\/.+/)) {
                a["%R"] = a["%M"];
                delete a["%M"];
            }
        }
        return a;
    }
});

PP.format.EndNote = new PP.format._EndNote();

PP.format._FederalRegister = PP.format.AbstractReader.extend({
    getName: function() {
        return "FederalRegister";
    },
    doRead: function(a) {
        var b = this._readHTML(a);
        PP.library.Publication.autoClean(b);
        return [ b ];
    },
    _readHTML: function(a) {
        var b = {
            pubtype: "PP_MISC",
            journal: "Federal Register"
        };
        var c = $(a).find("#metadata_content_area > h1").text();
        b.title = c;
        var d = $(a).find(".agencies a").text();
        b.author = [ {
            collective: d
        } ];
        var e = $(a).find(".date").text();
        var f = e.split(" ");
        f = f[0].split("/");
        if (f.length == 3) {
            b.published = {
                year: f[2],
                month: f[0],
                day: f[1]
            };
        }
        for (var g = 0; g < $(a).find("h1").length; g++) {
            var h = $(a).find("#h-" + g).text().trim();
            switch (h) {
              case "AGENCY:":
                if (b.author) break;
                d = $(a).find("#h-" + g).next().text();
                b.author = [ {
                    collective: d
                } ];
                break;

              case "SUMMARY:":
                var i = $(a).find("#h-" + g).next().text();
                if (i) b.abstract = i;

              default:
                break;
            }
        }
        var j = $(a).find("dt");
        for (var k = 0; k < j.length; k++) {
            var l = $(j[k]).text().trim();
            switch (l) {
              case "Publication Date:":
                if (b.published) break;
                e = $(j[k]).next().text().trim();
                f = e.split(" ");
                f = f[0].split("/");
                if (f.length == 3) {
                    b.published = {
                        year: f[2],
                        month: f[0],
                        day: f[1]
                    };
                }
                break;

              case "Document Citation:":
                var m = $(j[k]).next().text().trim();
                var n = m.match(/(\d+) FR/);
                if (n && n[1]) {
                    b.volume = n[1];
                }
                break;

              case "Page:":
                var o = $(j[k]).next().text().trim();
                var p = o.match(/(\d+-\d+)/);
                if (p && p[1]) {
                    b.pages = p[1];
                }
                break;

              case "Shorter Document URL":
                var q = $(j[k]).next().text().trim();
                var r = q.match(/(http\S+)/);
                if (r && r[1]) {
                    b.url = [ r[1] ];
                }
                break;

              case "Scheduled Publication Date:":
                b.title += " [Public Inspection Version]";
                break;

              case "Filed at:":
                if (b.published) break;
                var e = $(j[k]).next().text().trim();
                f = e.split(" ");
                f = f[0].split("/");
                if (f.length == 3) {
                    b.published = {
                        year: f[2],
                        month: f[0],
                        day: f[1]
                    };
                }
                break;

              case "Document Number:":
                var s = $(j[k]).next().text().trim();
                if (s) b.number = s;
                break;

              default:
                break;
            }
        }
        return b;
    }
});

PP.format.FederalRegister = new PP.format._FederalRegister();

PP.format._HTML = PP.format.AbstractReader.extend({
    getName: function() {
        return "HTML";
    },
    doRead: function(a) {
        return this._readHTML(a);
    },
    getMetaTags: function(a) {
        var b = this;
        if (typeof HTMLDocument != "undefined") {
            if (a instanceof HTMLDocument || a instanceof XMLDocument || a instanceof Document) {
                var c = "";
                var d = a.getElementsByTagName("head");
                if (d.length > 0) {
                    c += $(d[0]).html();
                }
                var e = a.getElementsByTagName("body");
                if (e.length > 0) {
                    c += $(e[0]).html();
                }
                a = c;
                c = "";
            }
        }
        var f = [ "related-?post", "related-?article", "popular-?article", "popular-?post", "recent-?post", "recent-?article", "\\.node-commentary", "other-?stories", "story-frag-list", "top-stories" ];
        var g = new RegExp("(" + f.join("|") + ")");
        var h, i;
        var j = $("<div>" + a + "</div>");
        try {
            h = j.find("meta, title");
        } catch (a) {
            h = [];
        }
        var k = {};
        var l = [];
        for (var i = 0; i < h.length; i++) {
            var m = h[i];
            var n = false;
            var o = false;
            if (typeof HTMLMetaElement != "undefined") {
                if (m instanceof HTMLMetaElement) n = true;
                if (m instanceof HTMLTitleElement) o = true;
            } else {
                if ("type" in m && "name" in m) {
                    if (m.type == "tag" && m.name == "meta") n = true;
                    if (m.type == "tag" && m.name == "title") o = true;
                }
            }
            if (n) {
                var p = $(m)[0];
                if (!p) continue;
                var q = b._getAttribute(p, "name");
                if (!q) {
                    q = b._getAttribute(p, "property");
                    if (!q) {
                        q = b._getAttribute(p, "itemprop");
                    }
                }
                if (!q) continue;
                var r = b._getAttribute(p, "content");
                if (!r) continue;
                if (b._getPath(p).match(g)) continue;
                if (q.match(/DC:(.+)/)) {
                    q = "DC." + RegExp.$1;
                }
                if (q.match(/PRISM:(.+)/)) {
                    q = "PRISM." + RegExp.$1;
                }
                q = q.toUpperCase();
                if (q === "SAILTHRU.AUTHOR" || q === "SAILTHRU.AUTHOR_NAME") {
                    if (r.match(/(href=|&lt;span|title=|rel=)/)) continue;
                }
                if (q === "DCTERMS.CREATOR") {
                    if (r.match(/@/)) continue;
                }
                if (q === "PARSELY-PAGE") {
                    var s = JSON.parse(r);
                    if (s) {
                        if ("title" in s && PP.Utils.isString(s.title)) {
                            l.push(b._newMetaTag("PARSELY-TITLE", s.title));
                        }
                        if ("author" in s && PP.Utils.isString(s.author)) {
                            l.push(b._newMetaTag("PARSELY-AUTHOR", s.author));
                        }
                        if ("link" in s && PP.Utils.isString(s.link)) {
                            l.push(b._newMetaTag("PARSELY-URL", s.link.replace(/\\\//g, "/")));
                        }
                        if ("pub_date" in s && PP.Utils.isString(s.pub_date)) {
                            l.push(b._newMetaTag("PARSELY-PUB-DATE", s.pub_date));
                        }
                    }
                    continue;
                }
                if (r.match(/\|\[/)) {
                    r = r.replace(/\|\[/g, "&");
                    r = r.replace(/\]\|/g, ";");
                    var t = document.createElement("span");
                    t.innerHTML = r;
                    r = t.innerText;
                }
                k[q] = true;
                b._setAttribute(p, "name", q);
                b._setAttribute(p, "content", r);
                l.push(p);
            } else if (o) {
                var p = $(m)[0];
                if ($(p).text()) {
                    b._setAttribute(p, "name", "WEBSITE_TITLE");
                    b._setAttribute(p, "content", $(p).text());
                    k["WEBSITE_TITLE"] = true;
                    l.push(p);
                }
            }
        }
        var u = j.find('script[type="application/ld+json"]').text();
        if (u && u.length > 10) {
            var v = null;
            try {
                v = JSON.parse(u);
            } catch (a) {}
            if (v) {
                if (PP.Utils.isArray(v) && v.length > 0) {
                    v = v[0];
                }
                if (PP.Utils.isObject(v)) {
                    if ("author" in v) {
                        if (PP.Utils.isArray(v.author)) {
                            for (i = 0; i < v.author.length; i++) {
                                if (PP.Utils.isObject(v.author[i]) && "name" in v.author[i]) {
                                    l.push(b._newMetaTag("LDJSON_AUTHORS", v.author[i].name));
                                }
                            }
                        } else if (PP.Utils.isString(v.author)) {
                            l.push(b._newMetaTag("LDJSON_AUTHORS", v.author));
                        } else if (PP.Utils.isObject(v.author) && "name" in v.author) {
                            l.push(b._newMetaTag("LDJSON_AUTHORS", v.author.name));
                        }
                    }
                    if ("datePublished" in v && PP.Utils.isString(v.datePublished)) {
                        l.push(b._newMetaTag("DATEPUBLISHED", v.datePublished));
                    }
                    if ("dateCreated" in v && PP.Utils.isString(v.dateCreated)) {
                        l.push(b._newMetaTag("DATECREATED", v.dateCreated));
                    }
                    if ("uploadDate" in v && PP.Utils.isString(v.uploadDate)) {
                        l.push(b._newMetaTag("DATEPUBLISHED", v.uploadDate));
                    }
                    if ("publisher" in v && PP.Utils.isObject(v.publisher)) {
                        if ("name" in v.publisher && PP.Utils.isString(v.publisher.name)) {
                            l.push(b._newMetaTag("PUBLISHER", v.publisher.name));
                        }
                    }
                }
            }
        }
        var w = [ 'a[rel="author"]', 'span[itemprop="author"]', 'a[itemprop="author"]', 'span[property="schema:author"]', 'div[itemprop="creator"] span[itemprop="name"]', "div.authorName > a", ".author-name", '.post-author > a[href*="author"]', "span.author.vcard > a", "a.author-link", '.author > a[href*="author"]', '.author-card a[href*="author"]' ];
        var x = [];
        w.forEach(function(a, b) {
            x.push(a);
            w[b] = {
                pattern: a,
                data: []
            };
        });
        h = j.find(x.join(","));
        for (i = 0; i < h.length; i++) {
            var y = b._getPath(h[i]);
            w.forEach(function(a, b) {
                if ($(h[i]).is(a.pattern)) {
                    a.data.push({
                        content: PP.Utils.normalizeString($(h[i]).text()),
                        path: y
                    });
                }
            });
        }
        var z = 0;
        for (i = 0; i < w.length; i++) {
            if (w[i].data.length > 0) {
                for (var A = 0; A < w[i].data.length; A++) {
                    if (!w[i].data[A].path.match(g)) {
                        l.push(b._newMetaTag("BODY_AUTHORS", w[i].data[A].content));
                        z = 1;
                    }
                }
                if (z) break;
            }
        }
        var B = a.match(/EBcitation\s*=\s*(\{[^\}]+\});\s*/);
        if (B && B.length == 2) {
            try {
                var C = JSON.parse(B[1]);
                if (C) {
                    if (C.page) {
                        l.push(b._newMetaTag("EB_PAGE", C.page));
                    }
                    if (C.site) {
                        l.push(b._newMetaTag("EB_SITE", C.site));
                    }
                    if (C.date) {
                        l.push(b._newMetaTag("EB_DATE", C.date));
                    }
                    if (C.authors) {
                        l.push(b._newMetaTag("EB_AUTHORS", C.authors));
                    }
                }
            } catch (a) {}
        }
        var D = j.find('time[itemprop="datePublished"]');
        if (D && D.length > 0) {
            for (i = 0; i < D.length; i++) {
                if (!b._getPath(D[i]).match(g)) {
                    var E = q = b._getAttribute(D[i], "datetime");
                    if (E) l.push(b._newMetaTag("BODY_DATE", E));
                }
            }
        }
        var F = /<meta\s+name\s*=\s*["']([^'"]+)['"]\s*content\s*=['"]([^'"]+)['"]\s*?\/?>/gim;
        a.replace(F, function(a, c, d) {
            if (!k[c.toUpperCase()]) {
                var e = 1;
                if (c.toUpperCase() === "DCTERMS.CREATOR") {
                    if (d.match(/@/)) e = 0;
                }
                if (e) l.push(b._newMetaTag(c.toUpperCase(), d));
            }
        });
        return l;
    },
    _readHTML: function(a) {
        var b = this.getMetaTags(a);
        var c = [];
        c[0] = [];
        for (var d = 0; d < b.length; d++) {
            if (this._getAttribute(b[d], "name") === "CITATION_REFERENCE") {
                var e = this._getAttribute(b[d], "content");
                e = e.replace(/;\s*$/, "");
                e = e.replace(/\n/g, " ");
                var f = e.split(/;?\s*(citation_[A-Z_]+)\s*=/i);
                var g = "";
                var h = false;
                for (var i = 0; i < f.length - 1; i++) {
                    if (f[i].match(/^citation_[A-Z_]+$/i)) {
                        if (!f[i + 1].match(/^citation_[A-Z_]+$/i)) {
                            g += '<meta name="' + f[i] + '" content="';
                            g += f[i + 1] + '">\n';
                            if (f[i].match(/citation_title/i)) h = true;
                            if (f[i].match(/citation_author/i)) h = true;
                            i++;
                        }
                    }
                }
                if (h) {
                    var j = this.getMetaTags(g);
                    c.push(j);
                }
            } else {
                c[0].push(b[d]);
            }
        }
        var k = [];
        for (var d = 0; d < c.length; d++) {
            k.push(this._parseDOM(c[d]));
        }
        return k;
    },
    _newMetaTag: function(a, b) {
        var c;
        if (typeof document != "undefined") {
            c = document.createElement("meta");
        } else {
            c = $("<meta></meta>")[0];
        }
        this._setAttribute(c, "name", a);
        this._setAttribute(c, "content", b);
        return c;
    },
    _parseDOM: function(a) {
        var b = {};
        b["GoogleAuthors"] = {
            CITATION_AUTHOR: "author",
            CITATION_AUTHORS: "author"
        };
        b["Google"] = {
            CITATION_INBOOK_TITLE: "booktitle",
            CITATION_ABSTRACT: "abstract",
            CITATION_ABSTRACT_HTML_URL: "url",
            CITATION_ARXIV_ID: "arxivid",
            CITATION_BOOK_TITLE: "title",
            CITATION_CONFERENCE: "booktitle",
            CITATION_CONFERENCE_TITLE: "booktitle",
            CITATION_DATE: "published",
            CITATION_DISSERTATION_INSTITUTION: "school",
            CITATION_END_DATE: "dateend",
            CITATION_TECHNICAL_REPORT_INSTITUTION: "institution",
            CITATION_TECHNICAL_REPORT_NUMBER: "number",
            CITATION_DOI: "doi",
            CITATION_FIRSTPAGE: "startpage",
            CITATION_FULLTEXT_HTML_URL: "url",
            CITATION_ISBN: "isbn",
            CITATION_EISSN: "issn_alt",
            CITATION_ISSN: "issn",
            CITATION_ISSUE: "issue",
            CITATION_JOURNAL_ISSN: "issn",
            CITATION_JOURNAL_TITLE: "journalfull",
            CITATION_JOURNAL_TITLE_ABBREV: "journal",
            CITATION_JOURNAL_ABBREV: "journal",
            CITATION_KEYWORD: "keywords",
            CITATION_KEYWORDS: "keywords",
            CITATION_LANGUAGE: "language",
            CITATION_LASTPAGE: "endpage",
            CITATION_LOCATION: "conference_location",
            CITATION_PATENT_NUMBER: "patent_number",
            CITATION_PATENT_APPLICATION_NUMBER: "application_number",
            CITATION_PATENT_PUBLICATION_NUMBER: "patent_number",
            CITATION_PDF_URL: "url",
            CITATION_PMID: "pmid",
            CITATION_PMCID: "pmc",
            CITATION_PROCEEDINGS: "booktitle",
            CITATION_PUBLIC_URL: "url",
            CITATION_PUBLICATION_DATE: "published",
            CITATION_PUBLISHER: "publisher",
            CITATION_SERIES_TITLE: "series",
            CITATION_START_DATE: "datestart",
            CITATION_TITLE: "title",
            CITATION_VOLUME: "volume",
            CITATION_YEAR: "published",
            CITATION_COVER_DATE: "published",
            CITATION_ONLINE_DATE: "published",
            CITATION_ZBL: "zbl",
            CITATION_MR: "mr"
        };
        b["DublinCore"] = {
            "DC.TITLE": "title",
            "DC.CITATION.VOLUME": "volume",
            "DC.CITATION.ISSUE": "issue",
            "DC.CITATION.SPAGE": "startpage",
            "DC.CITATION.EPAGE": "endpage",
            "DC.CONTRIBUTOR": "author",
            "DC.CONTRIBUTOR.PERSONALNAME": "author",
            "DC.CREATOR": "author",
            "DC.CREATOR.PERSONALNAME": "author",
            "DC.CREATOR.CORPORATENAME": "author",
            "DC.DESCRIPTION": "abstract",
            "DC.IDENTIFIER": "doi",
            "DC.IDENTIFIER.ISBN": "isbn",
            "DC.IDENTIFIER.DOI": "doi",
            "DC.IDENTIFIER.PAGENUMBER": "pages",
            "DC.IDENTIFIER.URI": "url",
            "DC.LANGUAGE": "language",
            "DC.PUBLISHER": "publisher",
            "DC.PUBLISHER.CORPORATENAME": "publisher",
            "DC.SOURCE.ISSN": "issn",
            "DC.SOURCE.EISSN": "issn_alt",
            "DC.SOURCE.ISSUE": "issue",
            "DC.SOURCE.VOLUME": "volume",
            "DC.RELATION": "url",
            "DC.RELATION.ISPARTOF": "journal",
            "DCTERMS.ISREFERENCEDBY": "associated_doi",
            "DCTERMS.ABSTRACT": "abstract",
            "DCTERMS.CREATOR": "author",
            "DCTERMS.PUBLISHER": "journal",
            "DC.TYPE.ARTICLETYPE": "subtype",
            "DC.TYPE": "subtype"
        };
        b["Prism"] = {
            "PRISM.ENDINGPAGE": "endpage",
            "PRISM.DOI": "doi",
            "PRISM.ISSUEIDENTIFIER": "issue",
            "PRISM.ISBN": "isbn",
            "PRISM.ISSN": "issn",
            "PRISM.EISSN": "issn_alt",
            "PRISM.NUMBER": "issue",
            "PRISM.PUBLICATIONDATE": "published",
            "PRISM.PUBLICATIONNAME": "journal",
            "PRISM.STARTINGPAGE": "startpage",
            "PRISM.VOLUME": "volume",
            "PRISM.SECTION": "subtype",
            "PRISM.TEASER": "abstract",
            "PRISM.COVERDISPLAYDATE": "published"
        };
        b["EPrints"] = {
            "EPRINTS.ABSTRACT": "abstract",
            "EPRINTS.BOOK_TITLE": "booktitle",
            "EPRINTS.CREATORS_NAME": "author",
            "EPRINTS.DATE": "published",
            "EPRINTS.DEPARTMENT": "department",
            "EPRINTS.DOCUMENT_URL": "url",
            "EPRINTS.EDITORS_NAME": "editor",
            "EPRINTS.EVENT_TITLE": "conference",
            "EPRINTS.EVENT_LOCATION": "conference_location",
            "EPRINTS.EVENT_DATES": "conference_date",
            "EPRINTS.ID_NUMBER": "doi",
            "EPRINTS.INSTITUTION": "eprintsschool",
            "EPRINTS.FACULTY_NAME": "school",
            "EPRINTS.ISBN": "isbn",
            "EPRINTS.ISSN": "issn",
            "EPRINTS.ISSUE": "issue",
            "EPRINTS.JOURNAL": "journal",
            "EPRINTS.KEYWORDS": "keywords",
            "EPRINTS.NUMBER": "issue",
            "EPRINTS.OFFICIAL_URL": "url",
            "EPRINTS.PAGES": "pages",
            "EPRINTS.PAGERANGE": "pages",
            "EPRINTS.PLACE_OF_PUB": "address",
            "EPRINTS.PUBLICATION": "journal",
            "EPRINTS.PUBLISHER": "publisher",
            "EPRINTS.RELATED_URL_URL": "url",
            "EPRINTS.SERIES": "series",
            "EPRINTS.THESIS_TYPE": "genre",
            "EPRINTS.TITLE": "title",
            "EPRINTS.VOLUME": "volume"
        };
        b["Others"] = {
            EB_AUTHORS: "author",
            "BOOK:AUTHOR": "author",
            WKHEALTH_AUTHORS: "author",
            "OG:BOOK:AUTHOR": "author",
            LDJSON_AUTHORS: "author",
            "PARSELY-AUTHOR": "author",
            "ARTICLE:AUTHOR_NAME": "author",
            "BOOK.AUTHOR": "author",
            BODY_AUTHORS: "author",
            "SAILTHRU.AUTHOR": "author",
            AUTHOR: "author",
            "ARTICLE.AUTHOR": "author",
            "ARTICLE:AUTHOR": "author",
            "ARTICLE:AUTHORNAME": "author",
            "SAILTHRU.AUTHOR_NAME": "author",
            RBAUTHORS: "author",
            "HTTP://SCHEMA.ORG/AUTHOR": "author",
            "SAILTHRU.TITLE": "website_title",
            "PARSELY-TITLE": "website_title",
            "TWITTER:TITLE": "website_title",
            "OG:TITLE": "website_title",
            EB_PAGE: "title",
            EB_SITE: "website_name",
            EB_DATE: "published",
            "BOOK:TITLE": "title",
            "BOOK:ISBN": "isbn",
            "BOOKS:ISBN": "isbn",
            "BOOK:RELEASE_DATE": "published",
            "BOOKS:RELEASE_DATE": "published",
            "BOOK:YEAR": "published",
            "DC.DATE.CREATED": "published",
            "DC.DATE": "published",
            "DC.DATE.PUBLISHED": "published",
            "DC.DATE.ISSUED": "published",
            "DCTERMS.ISSUED": "published",
            REVISED: "published",
            "PPL.DOI": "doi",
            "PPL.FIRSTPAGE": "startpage",
            "PPL.ISSUE": "issue",
            "PPL.LASTPAGE": "endpage",
            "PPL.VOLUME": "volume",
            RFT_ATITLE: "title",
            RFT_DATE: "published",
            RFT_ID: "doi",
            RFT_ISSN: "issn",
            RFT_JTITLE: "journal",
            RFT_PUB: "publisher",
            "WT.CG_S": "subtype",
            PMID: "pmid",
            ISSN: "issn",
            PATENT_ISSUED: "published",
            PATENT_FILED: "filed",
            PATENT_ASSIGNEE: "assignee",
            WKHEALTH_JOURNAL_TITLE: "journal",
            WKHEALTH_ISSUE: "issue",
            WKHEALTH_VOLUME: "volume",
            WKHEALTH_TITLE: "title",
            WKHEALTH_DOI: "doi",
            WKHEALTH_DATE: "published",
            WKHEALTH_ISSN: "issn",
            WKHEALTH_FIRSTPAGE: "startpage",
            WKHEALTH_ABSTRACT_HTML_URL: "url",
            "OG:SITE_NAME": "website_name",
            "OG:URL": "url",
            "OG:ISBN": "isbn",
            "OG:TYPE": "pubtype",
            "OG:PUBLISHED_TIME": "published",
            "OG:DESCRIPTION": "abstract",
            "OG:BOOK:ISBN": "isbn",
            "OG:VIDEO:URL": "url",
            "OG:VIDEO:TAG": "keywords",
            "OG:VIDEO:DURATION": "running_time",
            "TWITTER:TEXT:ISBN": "isbn",
            "VIDEO:TAG": "keywords",
            DESCRIPTION: "abstract",
            DATEPUBLISHED: "published",
            PUBDATE: "published",
            DASHBOARD_PUBLISHED_DATE: "published",
            "VR:PUBLISHED_TIME": "published",
            DAT: "published",
            CRE: "journal",
            "ARTICLE.ORIGHEADLINE": "title",
            "ARTICLE.SUMMARY": "abstract",
            "ARTICLE.PUBLISHED": "published",
            "ARTICLE:PUBLISHED": "published",
            "ARTICLE:PUBLISHED_TIME": "published",
            "ARTICLE:PUBLICATIONDATE": "published",
            "PAGE.CONTENT.SOURCE": "journal",
            "BOOK.TITLE": "title",
            "BOOK.ISBN": "isbn",
            "BOOK.YEAR": "published",
            PUBLISHER: "publisher",
            FULLTEXT_HTML: "url",
            FULLTEXT_PDF: "url",
            "PARSELY-URL": "url",
            "PARSELY-PUB-DATE": "published",
            "SAILTHRU.DATE": "published",
            RBPUBDATE: "published",
            RBTITLE: "title",
            RBPUBNAME: "website_name",
            RBMAINURL: "url",
            DURATION: "running_time",
            "MODS.LCCN": "lccn",
            "GOOD_READS:ISBN": "isbn",
            "HTTP://SCHEMA.ORG/ISBN": "isbn",
            "HTTP://SCHEMA.ORG/PUBLISHER": "publisher",
            "HTTP://SCHEMA.ORG/BOOKEDITION": "edition",
            "HTTP://PURL.ORG/DC/TERMS/IDENTIFIER": "doi",
            DOI: "doi",
            "PARSED.JOURNAL": "journal",
            "PARSED.VOLUME": "volume",
            "PARSED.ISSUE": "issue",
            "PARSED.PAGES": "pages",
            "PARSED.YEAR": "published",
            ADVISOR: "editor",
            "ST.ISBN": "isbn",
            "ST.DOI": "doi",
            "ST.PUBLISHER": "publisher",
            DATECREATED: "published",
            GWA_AUTHOR: "author",
            GWA_PUBDATE: "published",
            BODY_DATE: "published",
            ABSTRACT: "abstract",
            DATE: "published"
        };
        b["NYTimes"] = {
            HDL: "title"
        };
        b["LastRessort"] = {
            WEBSITE_TITLE: "website_title"
        };
        for (var c in b["Google"]) {
            b["Others"]["BEPRESS_" + c] = b["Google"][c];
        }
        for (var c in b["GoogleAuthors"]) {
            b["Others"]["BEPRESS_" + c] = b["GoogleAuthors"][c];
        }
        var d = {};
        var e = false;
        var f = {
            pubtype: "PP_ARTICLE",
            author: [],
            editor: [],
            url: [],
            issn: [],
            keywords: [],
            abstract: ""
        };
        var g = 0;
        for (var c = 0; c < a.length; c++) {
            var h = a[c];
            var i = this._getAttribute(h, "name");
            var j = this._getAttribute(h, "content");
            var k = this._getAttribute(h, "scheme");
            if (k) {
                k = k.toUpperCase();
            }
            if (i === "DC.RELATION" && k === "REFERENCES") {
                continue;
            }
            if (i == "DC.IDENTIFIER" && k) {
                if (k == "PMID") {
                    i = "PMID";
                }
                if (k == "ISSN") {
                    i = "ISSN";
                }
            }
            if (i == "DC.IDENTIFIER") {
                if (j.match(/oai:pubmedcentral/i)) {
                    i = "CITATION_PMCID";
                } else if (j.match(/oai:arXiv/i)) {
                    i = "CITATION_ARXIV_ID";
                }
            }
            if (i == "DC.DATE" && k) {
                if (k === "ISSUED") {
                    i = "PATENT_ISSUED";
                }
                if (k === "SUBMITTED" || k === "DATESUBMITTED") {
                    i = "PATENT_FILED";
                }
            }
            if (i == "DCTERMS.ISPARTOF") {
                if (j.match(/^urn:ISSN:(.*)/)) {
                    i = "ISSN";
                    j = RegExp.$1;
                }
            }
            if (i === "OG:TYPE") {
                if (j.match(/^VIDEO/i)) {
                    f.pubtype = "PP_VIDEO";
                    continue;
                }
            }
            if (i === "DC.TYPE") {
                if (j.toUpperCase() === "PATENT APPLICATION" || j.toUpperCase() === "PATENT") {
                    f.pubtype = "PP_PATENT";
                    continue;
                }
                if (j.toUpperCase() === "CHAPTER") {
                    f.pubtype = "PP_BOOK_CHAPTER";
                }
                if (j.match(/THESIS/i)) {
                    f.pubtype = "PP_THESIS";
                }
                if (j.toUpperCase() === "DATASET") {
                    f.pubtype = "PP_DATASET";
                }
            }
            if (i === "EPRINTS.TYPE") {
                if (j.match(/THESIS/i)) {
                    f.pubtype = "PP_THESIS";
                }
                if (j.match(/book_section/i)) {
                    f.pubtype = "PP_BOOK_CHAPTER";
                }
                if (j.match(/conference/i)) {
                    f.pubtype = "PP_CONFERENCE_PAPER";
                }
            }
            if (i === "ARTICLE.ORIGHEADLINE") {
                f.pubtype = "PP_NEWS_ARTICLE";
            }
            if (i === "RBTITLE") {
                f.pubtype = "PP_WEBSITE";
            }
            if (i == "EB_PAGE") {
                f.pubtype = "PP_WEBSITE";
            }
            if (i === "BOOK.TITLE") {
                f.pubtype = "PP_BOOK";
            }
            if (i === "DC.CONTRIBUTOR" && k) {
                if (k === "ASSIGNEE") {
                    i = "PATENT_ASSIGNEE";
                    f.pubtype = "PP_PATENT";
                }
            }
            if (i === "DCTERMS.BIBLIOGRAPHICCITATION") {
                var l = PP.library.BibliographicData.parse(j);
                if (l) {
                    if (l.journal) d["PARSED.JOURNAL"] = [ l.journal ];
                    if (l.volume) d["PARSED.VOLUME"] = [ l.volume ];
                    if (l.issue) d["PARSED.ISSUE"] = [ l.issue ];
                    if (l.year) d["PARSED.YEAR"] = [ l.year ];
                    if (l.pages) d["PARSED.PAGES"] = [ l.pages ];
                }
            }
            if (i === "TWITTER:TITLE" || i === "OG:TITLE") {
                var m = i === "TWITTER:TITLE" ? "OG:TITLE" : "TWITTER:TITLE";
                for (var n = 0; n < a.length; n++) {
                    if (this._getAttribute(a[n], "name") == m) {
                        if (j.length > this._getAttribute(a[n], "content").length) {
                            this._setAttribute(a[n], "content", j);
                        } else if (j.length < this._getAttribute(a[n], "content").length) {
                            j = this._getAttribute(a[n], "content");
                        }
                    }
                }
            }
            if (!d[i]) {
                d[i] = [];
            }
            d[i].push(j);
        }
        var o = [ "GoogleAuthors", "DublinCore", "Prism", "Google", "EPrints", "NYTimes", "Others", "LastRessort" ];
        var p = 0;
        for (var q = 0; q < o.length; q++) {
            var r = o[q];
            for (var i in b[r]) {
                if (d[i]) {
                    var s = b[r][i];
                    if (i.match(/CITATION_CONFERENCE/)) f.pubtype = "PP_CONFERENCE_PAPER";
                    if (i.match(/CITATION_CONFERENCE_TITLE/)) f.pubtype = "PP_CONFERENCE_PAPER";
                    if (i.match(/EPRINTS.PUBLICATION/) && f.pubtype == "PP_CONFERENCE_PAPER") s = "booktitle";
                    if (f.pubtype == "PP_CONFERENCE_PAPER" && i.match(/CITATION_PROCEEDINGS/) && f["booktitle"]) {
                        f["conference"] = f["booktitle"];
                        delete f["booktitle"];
                    }
                    if (f.pubtype == "PP_CONFERENCE_PAPER" && i.match(/CITATION_CONFERENCE/) && f["booktitle"]) {
                        s = "conference";
                    }
                    if (!this._checkIfNeeded(s, f, i)) {
                        continue;
                    }
                    if (s === "author" || s === "editor") {
                        if (f.pubtype == "PP_THESIS") {
                            if (i == "DC.CONTRIBUTOR" && d["DC.CREATOR"]) {
                                if (d["DC.CREATOR"].length == 1) {
                                    continue;
                                }
                            }
                        } else {
                            if (i == "DC.CONTRIBUTOR" && d["DC.CREATOR"]) {
                                if (d["DC.CREATOR"].length > d[i].length) continue;
                            }
                            if (i == "DC.CREATOR" && d["DC.CONTRIBUTOR"]) {
                                if (d["DC.CONTRIBUTOR"].length > d[i].length) continue;
                            }
                        }
                        if (q <= 3) p = 1;
                        if (i == "BODY_AUTHORS" && p === 1) continue;
                        var t = d[i];
                        if (t) {
                            t = PP.Array.unique(t);
                        }
                        if (t && t.length === 1) {
                            var u = d[i][0].match(/\;/g);
                            var v = d[i][0].match(/,/g);
                            if (u) {
                                t = d[i][0].split(/;/);
                            } else if (v && !u) {
                                if (d[i][0].match(/\S+\s*,\s\S+\s*\S*/) && v.length === 1) {
                                    t = [ d[i][0] ];
                                } else if (d[i][0].match(/\S+\s*,\s\S+\s*\S*/) && d[i][0].match(/(, \d\d\d\d-|, \d\d\d\d-\d\d\d\d|, \d\d\d\d)/) && v.length === 2) {
                                    t = [ d[i][0].replace(RegExp.$1, "") ];
                                } else {
                                    t = d[i][0].split(/,/);
                                }
                            }
                            var w = [];
                            for (var x = 0; x < t.length; x++) {
                                if (t[x].match(/\s+(?:and|&)\s+/)) {
                                    t[x].split(/\s+(?:and|&)\s+/).forEach(function(a) {
                                        w.push(a);
                                    });
                                } else {
                                    w.push(t[x]);
                                }
                            }
                            t = w;
                        }
                        for (var x = 0; x < t.length; x++) {
                            t[x] = PP.String.stripHtml(t[x], {
                                replacement: "",
                                exclude: []
                            });
                            t[x] = t[x].replace(/[a-z\d\.]+@[a-z\d\.]+/, "");
                            t[x] = t[x].replace(/\s*[\|\-,;\.]\s*$/, "");
                            if (!t[x].match(/^https?:\/\//)) {
                                f[s].push(PP.library.Author.parseAuthor(t[x], {
                                    familyNameFirst: false
                                }));
                            }
                        }
                    } else if (s == "url") {
                        for (var x = 0; x < d[i].length; x++) {
                            f[s].push(d[i][x]);
                        }
                    } else if (s == "eprintsschool") {
                        if (f["pubtype"] == "PP_THESIS") {
                            f["school"] = d[i][0];
                        }
                    } else if (s == "pmc") {
                        if (d[i][0].match(/oai:pubmedcentral.nih.gov:(\d+)/i)) {
                            f[s] = "PMC" + RegExp.$1;
                        } else {
                            f[s] = d[i][0];
                        }
                    } else if (s == "arxivid") {
                        if (d[i][0].match(/oai:arXiv.org:(.+)/i)) {
                            f[s] = RegExp.$1;
                        } else {
                            f[s] = d[i][0];
                        }
                    } else if (s == "keywords") {
                        for (var x = 0; x < d[i].length; x++) {
                            f[s].push(d[i][x]);
                        }
                    } else if (s == "running_time") {
                        var y = d[i][0].replace(/^PT/i, "");
                        var z = y.split(/([HMS])/);
                        var A = 0;
                        for (var x = 0; x < z.length; x++) {
                            if (z[x].match(/^\d+$/)) {
                                var B = 0;
                                if (x + 1 < z.length && z[x + 1].match(/^[HMS]$/)) {
                                    if (z[x + 1] == "H") B = 3600;
                                    if (z[x + 1] == "M") B = 60;
                                    if (z[x + 1] == "S") B = 1;
                                }
                                A += parseInt(z[x]) * B;
                            }
                        }
                        if (A > 0) {
                            f[s] = A + " sec";
                        } else {
                            f[s] = y;
                        }
                    } else if (s == "issn_alt") {
                        var C = PP.library.Publication.checkValidityOfISSN(d[i][0]);
                        if (C !== "") {
                            f[s] = C;
                        }
                    } else if (s == "issn") {
                        for (var x = 0; x < d[i].length; x++) {
                            var C = PP.library.Publication.checkValidityOfISSN(d[i][x]);
                            if (C !== "") f[s].push(C);
                        }
                    } else if (s == "isbn") {
                        var D = PP.Utils.extractISBNs(d[i].join(" "), {
                            convert: true,
                            unique: true
                        });
                        var E;
                        while (E = D.shift()) {
                            if (!f.isbn) {
                                f.isbn = E;
                            } else {
                                if (!f.isbn_alt) f.isbn_alt = E;
                            }
                        }
                    } else if (s == "doi") {
                        for (var x = 0; x < d[i].length; x++) {
                            var F = d[i][x] || "";
                            if (F.match(/(http:\/\/)?dx\.doi\.org\/10\./)) {
                                f["doi"] = F;
                                break;
                            } else if (F.match(/^10\.\d{4,}\//)) {
                                f["doi"] = F;
                                break;
                            } else if (F.match(/^doi:10\.\d{4,}\//i)) {
                                f["doi"] = F;
                                break;
                            } else if (F.match(/^info:doi\/(10\.\d{4,}\/.+)/i)) {
                                f["doi"] = RegExp.$1;
                                break;
                            } else if (F.match(/http:\/\//)) {
                                f["url"].push(F);
                            } else if (F.match(/URN:ISBN:([\dX]+)/i)) {
                                var D = PP.Utils.extractISBNs(F, {
                                    convert: true,
                                    unique: true
                                });
                                var E;
                                while (E = D.shift()) {
                                    if (!f.isbn) {
                                        f.isbn = E;
                                    } else {
                                        if (!f.isbn_alt) f.isbn_alt = E;
                                    }
                                }
                            } else {
                                if (F.match(/(.*)(10\.\d{4,}\/\S+)(\s.*)?/)) {
                                    f["doi"] = RegExp.$2;
                                } else {
                                    if (f.pubtype == "PP_PATENT") {
                                        f["patent_number"] = F;
                                    }
                                }
                            }
                        }
                    } else if (s == "published" || s == "conference_date" || s == "filed") {
                        var G = PP.library.Date.parseDate(d[i][0]);
                        for (var x = 0; x < d[i].length; x++) {
                            var G = PP.library.Date.parseDate(d[i][x]);
                            var H = 1;
                            if (s in f && PP.Utils.isObject(f[s])) {
                                H = 0;
                                if (G["year"] && !f[s]["year"]) {
                                    H = 1;
                                }
                                if (G["month"] && G["year"] && !f[s]["month"]) {
                                    H = 1;
                                }
                                if (G["day"] && G["month"] && G["year"] && !f[s]["day"]) {
                                    H = 1;
                                }
                            }
                            if (H == 1) {
                                if (!(s in f)) f[s] = {};
                                if (G["year"]) f[s]["year"] = parseInt(G["year"]) + "";
                                if (G["month"]) f[s]["month"] = parseInt(G["month"]) + "";
                                if (G["day"]) f[s]["day"] = parseInt(G["day"]) + "";
                            }
                        }
                    } else if (s == "abstract") {
                        if (i == "DCTERMS.ABSTRACT" || i == "EPRINTS.ABSTRACT") {
                            f[s] = d[i][0];
                            g = 1;
                        }
                        if (g == 0) {
                            if (d[i][0].length > f[s].length) f[s] = d[i][0];
                        }
                    } else {
                        f[s] = d[i][0];
                    }
                }
            }
        }
        f["keywords"] = f["keywords"].join("; ");
        if (f["pubtype"] === undefined) {
            f["pubtype"] = "PP_ARTICLE";
        }
        if (f.subtype && f.subtype.toUpperCase() === "PATENT") {
            f.pubtype = "PP_PATENT";
            delete f.subtype;
        }
        if (f.subtype && f.subtype.toUpperCase() === "LEGISLATION") {
            f.pubtype = "PP_BILL";
            delete f.subtype;
        }
        if (f["booktitle"] && f.pubtype === "PP_ARTICLE") {
            f.pubtype = "PP_BOOK_CHAPTER";
        }
        if (f["pubtype"] === "book") {
            f["pubtype"] = "PP_BOOK";
        }
        if (f["school"] && f["school"] !== "") {
            f["pubtype"] = "PP_THESIS";
        }
        if (f["number"] && f["number"] !== "") {
            f["pubtype"] = "PP_REPORT";
        }
        if (!f["pubtype"].match(/^PP_/)) {
            f["pubtype"] = "PP_ARTICLE";
        }
        if (f["doi"]) {
            if (f["doi"].match(/dryad/i)) {
                f["pubtype"] = "PP_DATASET";
                f["journal"] = "Dryad Digital Repository";
            }
        }
        f["accessed"] = moment(new Date()).format("MMM DD, YYYY");
        if (f["datestart"] || f["dateend"]) {
            f["conference_date"] = {
                literal: (f["datestart"] || "") + "-" + (f["dateend"] || "")
            };
            delete f["datestart"];
            delete f["dateend"];
        }
        if (f.subtype) {
            var I = f.subtype;
            delete f.subtype;
            if (I.match(/news\s+views/i)) {
                f.kind = "Commentary";
                f.pubtype = "PP_ARTICLE";
            } else if (I.match(/news/i)) {
                f.kind = "News";
                f.pubtype = "PP_ARTICLE";
            } else if (I.match(/review/i)) {
                f.kind = "Review";
                f.pubtype = "PP_ARTICLE";
            }
        }
        var J = f.journal || f.journalfull;
        if (J && J.match(/bioRxiv/i)) {
            f.pubtype = "PP_PREPRINT";
        }
        if (f.arxivid) {
            f.pubtype = "PP_PREPRINT";
        }
        if (!f.title) {
            if (f.pubtype != "PP_VIDEO") {
                f.pubtype = "PP_WEBSITE";
            }
            if (f["website_title"]) {
                f.title = f["website_title"];
            } else {
                f.title = "[No title]";
            }
        }
        if (f["language"]) f["language"] = PP.Utils.normalizeLanguage(f["language"]);
        if (f["isbn"]) {
            if (f.pubtype === "PP_ARTICLE" || f.pubtype === "PP_WEBSITE") {
                f["pubtype"] = "PP_BOOK";
            }
        }
        if (f.pubtype === "PP_WEBSITE" && !f.doi && f.issn.length === 0) {
            if (f["website_name"] && !f.booktitle) {
                f.booktitle = f["website_name"];
            }
            if (f["publisher"] && !f.booktitle) {
                f.booktitle = f["publisher"];
                delete f["publisher"];
            }
        }
        if (f.pubtype == "PP_BILL" && f.title) {
            if (f.title.match(/([^\d]+)(\d+)\s+-\s+(\d+.+Congress).+\):\s+(.+)/)) {
                f.number = RegExp.$2;
                f.session = RegExp.$3;
                f.title = RegExp.$4;
                var K = RegExp.$1;
                if (K.match(/H\./)) {
                    f.legislative_body = "House of Representatives";
                } else {
                    f.legislative_body = "Senate";
                }
            }
        }
        if (f.issn.length === 0) delete f.issn;
        if (f.editor.length === 0) delete f.editor;
        if (f["website_title"]) delete f["website_title"];
        if (f["website_name"]) delete f["website_name"];
        return f;
    },
    _getPath: function(a) {
        var b = [];
        var c;
        for (c = a; c; c = c.parentNode) {
            if (c === undefined || c.tagName === undefined) break;
            var d = "tagName" in c ? c.tagName.toLowerCase() : c.name.toLowerCase();
            if (d === "html") break;
            if (c.className) d += "." + c.className.toLowerCase().replace(/\s+/g, ".");
            if (c.id) d += "#" + c.id.toLowerCase();
            if ("attribs" in c) {
                if (c.attribs.class) d += "." + c.attribs.class.replace(/\s+/g, ".");
                if (c.attribs.id) d += "#" + c.attribs.id.toLowerCase();
            }
            b.push(d);
        }
        return b.reverse().join(" ");
    },
    _checkIfNeeded: function(a, b, c) {
        var d = 1;
        if (a == "author") {
            if (b["author"].length > 0) d = 0;
        } else if (a == "editor") {
            if (b["editor"].length > 0) d = 0;
        } else if (a == "url") {
            d = 1;
        } else if (a == "issn") {
            d = 1;
        } else if (a == "isbn") {
            d = 1;
        } else if (a == "keywords") {
            d = 1;
        } else if (a == "abstract") {
            d = 1;
        } else {
            if (c == "DCTERMS.ABSTRACT" || c == "EPRINTS.ABSTRACT") {
                d = 1;
            } else {
                if (b[a]) {
                    d = 0;
                }
            }
        }
        return d;
    }
});

PP.format.HTML = new PP.format._HTML();

PP.format._ISI = PP.format.AbstractReader.extend({
    mapIn: {
        TI: "title",
        AB: "abstract",
        PU: "publisher",
        DI: "doi",
        BP: "startpage",
        EP: "endpage",
        PG: "num_pages",
        VL: "volume",
        IS: "issue",
        SN: "issn",
        EI: "issn",
        AF: "author",
        AU: "author",
        JI: "journal",
        J9: "journal",
        BN: "isbn",
        UR: "url",
        DT: "pubtype",
        PT: "pubtype",
        PY: "year",
        PD: "date",
        BE: "editor",
        LA: "language",
        AE: "assignee",
        PN: "patent_number",
        SO: "SO",
        SE: "series",
        CT: "booktitle",
        CL: "address",
        DE: "keywords",
        ID: "keywords",
        WC: "keywords",
        SC: "keywords",
        PA: "address",
        PI: "address",
        EM: "note",
        FU: "note",
        FX: "note",
        C1: "affiliation"
    },
    mapOut: {},
    hierarchy: [ "PT", "DT", "TI", "AB", "PU", "DI", "VL", "IS", "BP", "EP", "SN", "EI", "AF", "AU", "BE", "JI", "J9", "BN", "UR", "PY", "PD", "LA", "AE", "PN", "SE", "CT", "CL", "DE", "ID", "PI", "PA", "WC", "SC", "EM", "FU", "FX", "C1", "SO", "PG" ],
    getName: function() {
        return "ISI";
    },
    getKeyValuePairs: function(a) {
        var b = {};
        var c = "empty";
        for (var d in a) {
            if (a[d].match(/^([A-Z][A-Z\d])\s+(.*)/)) {
                c = RegExp.$1;
                if (b[c]) c = "dummy";
                b[c] = [];
                b[c].push(RegExp.$2);
            } else if (a[d] == "" || a[d].match(/^\s+$/)) {} else {
                if (!b[c]) b[c] = [];
                b[c].push(a[d]);
            }
        }
        return b;
    },
    processAuthors: function(a, b) {
        a.forEach(function(a) {
            var c = a.replace(/^\s*/, "").split(/,\s*/);
            var d = {};
            if (c.length == 2) {
                d = {
                    last: c[0],
                    first: c[1]
                };
            } else if (c.length == 3) {
                d = {
                    last: c[0],
                    first: c[1]
                };
                if (c[2].match(/^\s*(I|II|III|IV|V|Jun|Sen)/)) {
                    d.jr = c[2];
                }
            } else if (c.length == 1) {
                d = {
                    collective: c[0]
                };
            }
            b.push(d);
        });
    },
    doRead: function(a) {
        var b = a.split(/\n+/);
        var c = [];
        var d = [];
        var e = this;
        var f = 0;
        b.forEach(function(a) {
            if (a.match(/^ER\s*$/)) f++;
        });
        if (f <= 1) {
            d.push(b);
        } else if (f > 1) {
            var g = [];
            b.forEach(function(a) {
                if (a.match(/^ER\s*$/)) {
                    if (g.length > 0) {
                        d.push(g);
                    }
                    g = [];
                }
                g.push(a);
            });
        }
        for (var h = 0; h < d.length; h++) {
            this.fire("progress", {
                progress: h / d.length,
                totalCount: d.length
            });
            var i = this.getKeyValuePairs(d[h]);
            var j = {
                pubtype: "PP_ARTICLE",
                note: ""
            };
            e.hierarchy.forEach(function(a) {
                var b = i[a];
                if (b) {
                    var c = b.join(" ").replace(/\s+/g, " ");
                    c = c.replace(/^\s+/, "");
                    c = c.replace(/\s+$/, "");
                    var d = e.mapIn[a];
                    if (d == "pubtype") {
                        if (c.toUpperCase() == "REVIEW") {
                            j.kind = "Review";
                        }
                        if (c.match(/Data\s*set/i)) {
                            j.pubtype = "PP_DATASET";
                        }
                        if (a == "PT" && c.match(/^P\s*/)) {
                            j.pubtype = "PP_PATENT";
                        }
                        if (a == "PT" && c.match(/^B\s*/)) {
                            j.pubtype = "PP_BOOK";
                        }
                        return;
                    } else if (d == "author" || d == "editor") {
                        if (j[d]) return;
                        j[d] = [];
                        e.processAuthors(b, j[d]);
                        return;
                    } else if (d == "issn") {
                        c = c.replace(/\(.*/, "");
                        if (j[d]) d = "issn_alt";
                        j[d] = c;
                        return;
                    } else if (d == "endpage") {
                        if (!c.match(/^\+/)) {
                            j[d] = c;
                        }
                        return;
                    } else if (d == "note") {
                        var f = "";
                        if (a == "EM") f = "e-mail: ";
                        if (a == "FU" || a == "FX") f = "Funding:\n";
                        j[d] += f + c + "\n";
                        return;
                    } else if (d == "isbn") {
                        var g = PP.Utils.extractISBNs(c, {
                            convert: true,
                            unique: true
                        });
                        if (g[0]) j.isbn = g[0];
                        if (g[1]) j.isbn_alt = g[1];
                        return;
                    } else if (d == "address") {
                        if (j[d]) return;
                        j[d] = c;
                        return;
                    } else if (d == "journal") {
                        if (j[d]) return;
                        j[d] = c;
                        return;
                    } else if (d == "keywords") {
                        if (!j[d]) j[d] = [];
                        c.split(/\s*;\s*/).forEach(function(a) {
                            j[d].push(a);
                        });
                        return;
                    } else if (d == "date") {
                        c = c.replace(/\./g, " ");
                        if (c.match(/^\s*([A-Z]+)\s+(\d+)\s*$/i)) {
                            j.month = RegExp.$1;
                            j.day = RegExp.$2;
                        } else if (c.match(/^\s*([A-Z]+)\s*$/i)) {
                            j.month = c;
                        } else if (c.match(/^\s*([A-Z]+)\s+(\d+)\s+(\d\d\d\d)\s*$/i)) {
                            j.month = RegExp.$1;
                            j.day = RegExp.$2;
                            j.year = RegExp.$3;
                        } else if (c.match(/^\s*(\d\d\d\d)\s*-\s*([A-Z]+)\s*-\s*(\d+)\s*$/i)) {
                            j.month = RegExp.$2;
                            j.day = RegExp.$3;
                            j.year = RegExp.$1;
                        }
                        return;
                    } else if (d == "url") {
                        if (!j[d]) j[d] = [];
                        b.forEach(function(a) {
                            a = a.replace(/^\s*/, "");
                            if (a.match(/^(http|ftp)/)) j[d].push(a);
                        });
                        return;
                    } else {
                        if (d == "SO") {
                            if (j.pubtype == "PP_PATENT") {
                                d = "journalfull";
                            }
                            if (j.pubtype == "PP_DATASET") {
                                d = "archivePrefix";
                            }
                            if (j.pubtype == "PP_ARTICLE" && !j["journal"]) {
                                d = "journal";
                            }
                        }
                        if (d == "booktitle" && a == "CT") {
                            j.pubtype = "PP_CONFERENCE_PAPER";
                        }
                        if (!j[d]) {
                            j[d] = c;
                        }
                    }
                }
            });
            if (j["keywords"]) {
                j["keywords"] = j["keywords"].join("; ");
            }
            c.push(j);
        }
        return c;
    }
});

PP.format.ISI = new PP.format._ISI();

PP.format._MARC = PP.format.AbstractReader.extend({
    mapIn: {
        leader: "leader",
        "007": "007",
        "010": "lccn",
        "010a": "lccn",
        "019a": "issn",
        "020a": "isbn",
        "020": "isbn",
        "022a": "issn",
        "022": "issn",
        "100a": "author",
        "100": "author",
        "111": "conference",
        "245": "title",
        "245a": "title",
        "245b": "addtitle",
        "250": "edition",
        "250a": "edition",
        "260": "address",
        "260a": "address",
        "260b": "publisher",
        "260c": "year",
        "264": "address",
        "264a": "address",
        "264b": "publisher",
        "264c": "year",
        "300a": "num_pages",
        "440": "series",
        "440a": "series",
        "440v": "volume",
        "490": "series",
        "490a": "series",
        "490v": "volume",
        "490x": "issn",
        "507a": "scale",
        "520a": "abstract",
        "520": "abstract",
        "650a": "keywords",
        "700": "editor",
        "700a": "editor",
        "776z": "isbn",
        "856u": "url",
        "956u": "url"
    },
    doRead: function(a) {
        var b = {};
        if (a.match(new RegExp("\x1e")) && a.match(new RegExp("\x1f"))) {
            b = this._parseMARCBinary(a);
        } else {
            b = this._parseMARC(a);
        }
        var c = this.applyMapping(b);
        PP.library.Publication.autoClean(c);
        return [ c ];
    },
    applyMapping: function(a) {
        var b = this;
        var c, d, e, f;
        var g = {
            pubtype: "PP_BOOK",
            author: [],
            editor: [],
            keywords: [],
            url: []
        };
        var h = {};
        for (c in a) {
            if (!(c in b.mapIn)) continue;
            d = b.mapIn[c];
            if (!(d in h)) {
                h[d] = [];
            }
            h[d] = PP.Array.merge(h[d], a[c]);
        }
        for (c in h) {
            var i = h[c];
            if (!i[0]) continue;
            if (c == "007") {
                e = i[0].split("");
                if (e && e[0]) {
                    if (e[0] == "v") {
                        g.pubtype = "PP_VIDEO";
                    }
                    if (e[0] == "s") {
                        g.pubtype = "PP_AUDIO";
                    }
                }
                i = undefined;
            } else if (c == "leader") {
                e = i[0].split("");
                if (e && e[6]) {
                    if (e[6] == "c" || e[6] == "d") {
                        g.pubtype = "PP_SCORE";
                    } else if (e[6] == "e") {
                        g.pubtype = "PP_MAP";
                    }
                }
                i = undefined;
            } else if (c == "isbn") {
                var j = PP.Utils.extractISBNs(i.join(" "), {
                    convert: true,
                    unique: true
                });
                var k;
                while (k = j.shift()) {
                    if (!g.isbn) {
                        g.isbn = k;
                    } else {
                        if (!g.isbn_alt) g.isbn_alt = k;
                    }
                }
                i = undefined;
            } else if (c == "issn") {
                i[0] = i[0].replace(/\(.+/, "").replace(/\s+$/, "");
                if (i[0].match(/(\d\d\d\d-\d\d\d[\dX])/i)) {
                    i = RegExp.$1;
                } else {
                    i = undefined;
                }
            } else if (c == "address") {
                i = i.join(" ").replace(/\s+/, " ").replace(/\s+$/, "");
            } else if (c == "year") {
                i = i[0].replace(/[a-z\.]/gi, "").replace(/-\d.+/, "").replace(/[\s\-]$/, "");
                i = i.replace(/(\[)(\d\d\d\d)(\])/, "$2");
            } else if (c == "publisher") {
                i = i.join(", ").replace(/\s+/, " ").replace(/\s+$/, "");
            } else if (c == "url") {
                for (f = 0; f < i.length; f++) {
                    i[f] = i[f].replace(/\s+/g, "");
                }
            } else if (c == "abstract") {
                i = i.join("\n").replace(/\s+/, " ").replace(/\s+$/, "");
            } else if (c == "author" || c == "editor") {
                for (f = 0; f < i.length; f++) {
                    i[f] = i[f].replace(/\s*[,;\.]\s*$/, "");
                    i[f] = i[f].replace(/\[.*/, "");
                    i[f] = PP.library.Author.parseAuthor(i[f]);
                }
            } else {
                i = i[0].replace(/\s*[,;\.]\s*$/, "").replace(/\s+$/, "");
            }
            if (i) {
                g[c] = i;
            }
        }
        if (g.addtitle && g.title) {
            g.title = g.title + ": " + g.addtitle;
            delete g.addtitle;
        }
        return g;
    },
    _parseMARCBinary: function(a) {
        var b, c;
        var d = a.substr(0, 24);
        var e = parseInt(d.substr(10, 1), 10);
        c = a.substr(parseInt(d.substr(12, 5), 10));
        var f = "";
        for (b = 0; b < c.length; b++) {
            f += c.substr(b, 1);
            if (c.charCodeAt(b) > 65535) {
                f += "\0\0\0";
            } else if (c.charCodeAt(b) > 2047) {
                f += "\0\0";
            } else if (c.charCodeAt(b) > 127) {
                f += "\0";
            }
        }
        var g = a.substr(24, a.indexOf("\x1e") - 24);
        c = {};
        for (var b = 0; b < g.length; b += 12) {
            var h = g.substr(b, 3);
            var i = parseInt(g.substr(b + 3, 4), 10);
            var j = parseInt(g.substr(b + 7, 5), 10);
            var k = f.substr(j + e, i - e - 1).replace(/\x00/g, "");
            k = k.split("\x1f").join("|").replace(/^\s+/, "");
            if (!(h in c)) c[h] = [];
            c[h].push(k);
        }
        var l = this._parseSubfields(c);
        if (d) l["leader"] = [ d ];
        return l;
    },
    _parseMARC: function(a) {
        var b = "NA";
        var c = {};
        var d, e, f, g, h;
        c[b] = [ "" ];
        a.split(/[\r\n]/).forEach(function(a) {
            e = a.match(/^(LEADER\s)(.+)/i);
            if (e && e[2]) {
                h = e[2];
            } else {
                e = a.match(/^(\d\d\d)\s(.+)/);
                if (e && e[2]) {
                    b = e[1];
                    if (!(b in c)) {
                        c[b] = [];
                    }
                    c[b].push("");
                    e[2] = e[2].replace(/^(\d\d\s|\d\s\s|\s\d\s)/, "");
                    c[b][c[b].length - 1] += e[2].replace(/^\s+/, "");
                } else {
                    c[b][c[b].length - 1] += a;
                }
            }
        });
        var i = this._parseSubfields(c);
        if (h) i["leader"] = [ h ];
        return i;
    },
    _parseSubfields: function(a) {
        var b = {};
        var c = "abcdefghijklmnopqrstuvwxyz=".split("");
        for (tag in a) {
            a[tag].forEach(function(a) {
                a = a.replace(/\s+/g, " ");
                r = a.split(new RegExp("(\\|" + c.join("|\\|") + ")"));
                if (r.length > 0 && r[0] == "") {
                    r.shift();
                }
                var d = tag;
                for (k = 0; k < r.length; k++) {
                    t = r[k].match(/^\|([a-z=])$/);
                    if (t && t[1]) {
                        d = tag + t[1];
                        continue;
                    }
                    if (!(d in b)) {
                        b[d] = [];
                    }
                    b[d].push(r[k]);
                }
            });
        }
        return this.cleanDict(b);
    },
    cleanDict: function(a) {
        var b = {};
        for (var c in a) {
            b[c] = [];
            for (var d = 0; d < a[c].length; d++) {
                var e = a[c][d];
                e = e.replace(/[:,\.\/]\s*$/, "");
                e = e.replace(/\s+;/g, "; ");
                e = e.replace(/\s+/g, " ");
                e = e.replace(/\s+$/, "");
                e = e.replace(/^\s+/, "");
                b[c][d] = e;
            }
        }
        return b;
    },
    getName: function() {
        return "MARC";
    }
});

PP.format.MARC = new PP.format._MARC();

PP.format._MARCXML = PP.format.AbstractReader.extend({
    doRead: function(a) {
        var b;
        if (typeof a == "string") {
            if (!isBrowserEnvironment()) {
                b = this.getXMLParser("<wrapper>" + a + "</wrapper>");
            } else {
                b = this.getXMLParser(a);
            }
        } else if (typeof a == "object") {
            b = a;
        }
        if (b) {
            var c = [];
            var d, e;
            var f = $(b).find("numberOfRecords");
            var g = 0;
            if (f && f.length) {
                try {
                    g = parseInt($(f).text());
                } catch (a) {}
            }
            var h = $(b).find("record");
            if (h && h.length) {
                if (g === 0) g = h.length;
                for (var i = 0; i < g; i++) {
                    d = null;
                    d = this._parseMARCXML(h[i]);
                    if (d) {
                        e = PP.format.MARC.applyMapping(d);
                        PP.library.Publication.autoClean(e);
                        c.push(e);
                    }
                }
            }
            return c;
        } else {
            return [];
        }
    },
    _parseMARCXML: function(a) {
        var b = {};
        var c, d, e, f, g;
        var h = $(a).find("leader");
        if (h && h.length) {
            b["leader"] = [ $(h[0]).text() ];
        }
        var i = $(a).find("controlfield");
        if (i && i.length) {
            for (c = 0; c < i.length; c++) {
                f = this._getAttribute(i[c], "tag");
                if (!(f in b)) b[f] = [];
                e = $(i[c]).text();
                b[f].push(e);
            }
        }
        var j = $(a).find("datafield");
        if (j && j.length) {
            for (c = 0; c < j.length; c++) {
                f = this._getAttribute(j[c], "tag");
                var k = $(j[c]).find("subfield");
                if (k && k.length) {
                    var l = {};
                    for (d = 0; d < k.length; d++) {
                        g = this._getAttribute(k[d], "code");
                        if (g) {
                            l[g] = $(k[d]).text();
                        }
                    }
                    if (f == "700" && "4" in l) {
                        if (l["4"].match(/^aut/i)) {
                            f = "100";
                        }
                    }
                    for (g in l) {
                        var m = f + g;
                        if (!(m in b)) b[m] = [];
                        b[m].push(l[g]);
                    }
                }
            }
        }
        return PP.format.MARC.cleanDict(b);
    },
    getName: function() {
        return "MARCXML";
    }
});

PP.format.MARCXML = new PP.format._MARCXML();

PP.format._MendeleyJson = PP.format.AbstractReader.extend({
    getName: function() {
        return "Mendeley JSON";
    },
    doRead: function(a) {
        if (a) {
            if (PP.Utils.isString(a)) {
                a = PP.Utils.decode(a);
            } else {
                a = [ a ];
            }
        } else {
            return [];
        }
        var b = this._readMendeleyItems(a);
        b.forEach(function(a) {
            PP.library.Publication.autoClean(a);
        });
        return b;
    },
    _readMendeleyItems: function(a) {
        var b = [];
        var c, d;
        var e = this;
        a.forEach(function(a) {
            var d = {};
            var f = e.jsonGetPubtypeAndKind(a.type);
            d["pubtype"] = f.pubtype;
            if (f.kind) d["kind"] = f.kind;
            var g = e.jsonMapToPaperpileFields(a, d["pubtype"]);
            for (c in g) {
                if (g[c].length === 0) continue;
                var h = g[c][0];
                var i = e.jsonIninitalizeValue(c);
                c = c.replace(/\..+/, "");
                if (c === "keywords") {
                    if (PP.Utils.isArray(h)) {
                        i[c] = h.join("; ");
                    }
                } else if (c === "url") {
                    if (PP.Utils.isArray(h)) {
                        i[c] = [];
                        h.forEach(function(a) {
                            a = a.replace(/;$/, "");
                            if (a.match(/^(http|ftp)/)) {
                                i[c].push(a);
                            }
                        });
                    }
                } else if (c === "issn") {
                    i = e.jsonCheckISSN(h);
                } else if (c === "isbn") {
                    i = e.jsonCheckISBN(h);
                } else if (c === "kind") {
                    if (h.match(/phdthesis/i)) {
                        i[c] = "Ph.D. Thesis";
                    } else if (h.match(/mastersthesis/i)) {
                        i[c] = "Masters Thesis";
                    }
                } else if (c === "author" || c === "editor" || c === "translator") {
                    i[c] = [];
                    h.forEach(function(a) {
                        var b = {};
                        b.first = a.first_name;
                        b.last = a.last_name;
                        PP.library.Author.autoClean(b);
                        i[c].push(b);
                    });
                } else if (c === "journal") {
                    if (PP.Utils.isArray(h)) {
                        if (h[0] && h[0].last_name) {
                            i[c] = h[0].last_name;
                        }
                    } else {
                        i[c] = h;
                    }
                } else {
                    e.jsonSetValue(c, i, h);
                }
                e.jsonAssignValuesToPub(i, d);
            }
            b.push(d);
        });
        return b;
    }
});

PP.format.MendeleyJson = new PP.format._MendeleyJson();

PP.format._OCLC = PP.format.AbstractReader.extend({
    getName: function() {
        return "OCLC";
    },
    doRead: function(a) {
        var b;
        try {
            b = JSON.parse(a);
        } catch (a) {
            b = undefined;
        }
        if (b && b.stat === "ok") {
            var c = this._readOCLCItems(b.list);
            c.forEach(function(a) {
                PP.library.Publication.autoClean(a);
            });
            return c;
        } else {
            return [];
        }
    },
    _readOCLCItems: function(a) {
        var b = [];
        var c, d, e;
        var f = this;
        for (var e = 0; e < a.length; e++) {
            var g = {
                pubtype: "PP_BOOK",
                author: [],
                url: []
            };
            var h = a[e];
            if ("title" in h) {
                g.title = h.title;
            }
            if ("year" in h) {
                g.published = {
                    year: h.year
                };
                if ("month" in h) g.published.month = h.month;
                if ("day" in h) g.published.day = h.day;
            }
            var i = {
                publisher: "publisher",
                city: "address",
                ed: "edition",
                lang: "language",
                url: "url",
                isbn: "isbn",
                lccn: "lccn"
            };
            for (var j in i) {
                if (j in h) {
                    var c = i[j];
                    g[c] = [];
                    if (PP.Utils.isArray(h[j])) {
                        g[c] = "";
                        h[j].forEach(function(a) {
                            g[c] += a;
                        });
                    } else if (PP.Utils.isString(h[j]) || PP.Utils.isNumeric(h[j])) {
                        g[c] = h[j];
                    }
                }
            }
            if ("author" in h) {
                var k = h.author;
                var l = false;
                if (k.indexOf("edited") >= 0 || k.indexOf("editors") >= 0 || k.indexOf("editor") >= 0) {
                    l = true;
                    k = k.replace("edited by ", "");
                    k = k.replace(/edit\S+ for volume \S+,/, "");
                }
                k = k.substring(0, k.length - 1);
                k = k.replace(" and ", ",");
                var m = [];
                auSplit = k.split(",");
                auSplit.forEach(function(a) {
                    m.push(PP.library.Author.parseAuthor(a, {
                        familyNameFirst: false
                    }));
                });
                if (l) {
                    g.editor = m;
                } else {
                    g.author = m;
                }
            }
            b.push(g);
        }
        return b;
    }
});

PP.format.OCLC = new PP.format._OCLC();

PP.format._OpenLibrary = PP.format.AbstractReader.extend({
    getName: function() {
        return "OpenLibrary JSON";
    },
    doRead: function(a) {
        if (a) {
            if (PP.Utils.isString(a)) {
                a = PP.Utils.decode(a);
                if (a && "title" in a) {
                    a = {
                        DUMMY: a
                    };
                }
            }
        } else {
            return [];
        }
        var b = this._readOpenLibraryItems(a);
        b.forEach(function(a) {
            PP.library.Publication.autoClean(a);
        });
        return b;
    },
    _readOpenLibraryItems: function(a) {
        var b = [];
        var c, d, e;
        var f = this;
        for (var g in a) {
            var h = {
                pubtype: "PP_BOOK",
                author: [],
                url: []
            };
            var i = a[g];
            if ("title" in i) {
                h.title = i.title;
            }
            if ("subtitle" in i) {
                var j = i.title.match(/[\?\.\!]$/) ? " " : ": ";
                h.title += j + i.subtitle;
            }
            var k = {
                publishers: "publisher",
                publish_places: "address",
                lccn: "lccn",
                isbn_10: "isbn",
                number_of_pages: "num_pages"
            };
            for (var l in k) {
                if (l in i) {
                    var c = k[l];
                    h[c] = [];
                    if (PP.Utils.isArray(i[l])) {
                        i[l].forEach(function(a) {
                            if (PP.Utils.isObject(a)) {
                                if ("name" in a) {
                                    h[c].push(a.name);
                                }
                            } else {
                                h[c].push(a);
                            }
                        });
                    } else if (PP.Utils.isString(i[l]) || PP.Utils.isNumeric(i[l])) {
                        h[c].push(i[l]);
                    }
                    h[c] = h[c].join("; ");
                }
            }
            if ("authors" in i) {
                if (i.authors.length) {
                    i.authors.forEach(function(a) {
                        if ("name" in a) {
                            h["author"].push(PP.library.Author.parseAuthor(a.name, {
                                familyNameFirst: false
                            }));
                        }
                    });
                }
            }
            if ("publish_date" in i) {
                var m = PP.library.Date.parseDate(i.publish_date);
                if (m["year"]) h["year"] = m["year"];
                if (m["month"]) h["month"] = m["month"];
                if (m["day"]) h["day"] = m["day"];
            }
            if ("identifiers" in i) {
                var n = [];
                if ("isbn_13" in i.identifiers) {
                    n = n.concat(i.identifiers.isbn_13);
                }
                if ("isbn_10" in i.identifiers) {
                    n = n.concat(i.identifiers.isbn_10);
                }
                n = PP.Utils.extractISBNs(n.join(" "), {
                    convert: true,
                    unique: true
                });
                if (n[0]) h.isbn = n[0];
                if (n[1]) h.isbn_alt = n[1];
                if ("lccn" in i.identifiers) {
                    if (i.identifiers.lccn.length) {
                        h.lccn = i.identifiers.lccn[0];
                    }
                }
            }
            if ("url" in i) {
                h.url.push(i.url);
            }
            if ("ebooks" in i) {
                if (i.ebooks.length) {
                    if (i.ebooks[0].formats && i.ebooks[0].formats.pdf) {
                        h.url.push(i.ebooks[0].formats.pdf.url);
                    }
                }
            }
            b.push(h);
        }
        return b;
    }
});

PP.format.OpenLibrary = new PP.format._OpenLibrary();

PP.format._Ovid = PP.format.AbstractReader.extend({
    doRead: function(a) {
        var b = this._readHTML(a);
        PP.library.Publication.autoClean(b);
        return [ b ];
    },
    _readHTML: function(a) {
        var b = {
            pubtype: "PP_ARTICLE",
            keywords: [],
            url: [],
            issn: []
        };
        var c = this;
        var d;
        var e = $(a).find("table.citation-block tr");
        if (e && e.length > 0) {
            for (var f = 0; f < e.length; f++) {
                var g = $(e[f]).find("th");
                var h = $(e[f]).find("td");
                var i = $(e[f]).find("td a");
                if (g[0] && h[0]) {
                    var j = $(g[0]).text().replace(/\n/g, " ");
                    j = this.normalizeStr(j).replace(/:?\s*$/, "");
                    var k = $(h[0]).text().replace(/\n/g, " ");
                    k = this.normalizeStr(k).replace(/:?\s*$/, "");
                    if (j == "Title" || j == "Book Title") {
                        k = k.replace("Chapter:", "");
                        k = k.replace(" [References]", "");
                        k = k.replace(/\s*\.?\s*\[[A-Z]+\]$/i, "");
                        b.title = k;
                    }
                    if (j == "Publication Type") {
                        if (k.match(/Government Publication/)) {
                            if (!k.match(/Journal Article/)) {
                                b.pubtype = "PP_REPORT";
                            }
                        }
                        if (k.match(/Dissertation/)) {
                            b.pubtype = "PP_THESIS";
                        }
                        if (k.match(/Conference Paper/)) {
                            b.pubtype = "PP_CONFERENCE_PAPER";
                        }
                        if (k.match(/Chapter/)) {
                            b.pubtype = "PP_BOOK_CHAPTER";
                        }
                    }
                    if (j == "Document Type") {
                        if (k.match(/Chapter/)) {
                            b.pubtype = "PP_BOOK_CHAPTER";
                        }
                    }
                    if (j == "Source") {
                        var l = PP.library.BibliographicData.parse(k);
                        if (l && l.journal) {
                            b.journal = l.journal;
                            if (l.volume) b.volume = l.volume;
                            if (l.issue) b.issue = l.issue;
                            if (l.pages) b.pages = l.pages;
                            if (l.year) b.year = l.year;
                            if (l.month) b.month = l.month;
                            if (l.day) b.day = l.day;
                            if (l.place) b.address = l.place;
                            if (l.publisher) b.publisher = l.publisher;
                            if (l.institution) b.institution = l.institution;
                            if (l.number) b.number = l.number;
                            if (l.conference) b.conference = l.conference;
                            if (l.conference_location) b.conference_location = l.conference_location;
                            if (l.conference_date) b.conference_date = l.conference_date;
                            if (l.editor) {
                                b.editor = l.editor;
                                b.booktitle = b.journal;
                                delete b.journal;
                                b.pubtype = "PP_BOOK_CHAPTER";
                            }
                        } else {
                            k = k.replace(/\d.*$/, "");
                            b.journal = k;
                        }
                        if (b.journal) {
                            b.journal = b.journal.replace(/\s*\.*$/, "");
                        }
                    }
                    if (j == "Reviewed Source") {
                        var m = {
                            authorParseParams: {
                                familyNameFirst: true,
                                commasWithinNames: true
                            }
                        };
                        var n = PP.library.BibliographicData.parse(k, m);
                        if (n && n.title) {
                            b.pubtype = "PP_REVIEW";
                            b.booktitle = n.title;
                            if (n.year) {
                                b.originally_published = {
                                    year: n.year
                                };
                            }
                            if (n.author) b.contributor = n.author;
                        } else {
                            k = k.replace(/\d.*$/, "");
                            b.journal = k;
                        }
                        if (b.journal) {
                            b.journal = b.journal.replace(/\s*\.*$/, "");
                        }
                    }
                    if (j == "Abstract" || j == "Abstract (English)" || j == "Study Information") {
                        k = k.replace(/^:\s*/, "");
                        b["abstract"] = k;
                    }
                    if (j == "Author Keywords" || j == "Keyword") {
                        k = k.replace(/\s*\.$/, "");
                        b.keywords = b.keywords.concat(k.split(/\s;\s/));
                    }
                    if (j == "Subject Headings" || j == "Indexer-Assigned Descriptors (English)") {
                        k = k.replace(/\s*\.$/, "");
                        b.keywords = b.keywords.concat(k.split(/\s;\s/));
                    }
                    if (j == "Publisher") {
                        b["publisher"] = k;
                    }
                    if (j == "Location of Publisher") {
                        b["address"] = k;
                    }
                    if (j == "ISSN" || j == "ISSN Print" || j == "Electronic ISSN" || j == "ISSN Electronic") {
                        b["issn"].push(k.replace(/\s*\(.*/, ""));
                    }
                    if (j == "ISBN") {
                        var o = PP.Utils.extractISBNs(k, {
                            convert: true,
                            unique: true
                        });
                        if (o[0]) b.isbn = o[0];
                        if (o[1]) b.isbn_alt = o[1];
                    }
                    if (j == "Unique Identifier") {
                        d = k;
                    }
                    if (j == "Status") {
                        if (k.match(/(\d\d\d\d)$/)) {
                            b.year = RegExp.$1;
                        } else if (k.match(/MEDLINE/) && d) {
                            b["pmid"] = d;
                        }
                    }
                    if (j == "Edition Statement") {
                        b["edition"] = k;
                    }
                    if (j == "Book Text Excerpt") {
                        var p;
                        if (p = k.match(/Chapter Author:\s*(.+)\s+Chapter Title/)) {
                            q = "author";
                            if (!b[q]) b[q] = [];
                            b[q] = b[q].concat(c.parseAuthors(p[1]));
                        }
                        if (p = k.match(/Chapter Title:\s*(.+)\s+Passage Text/)) {
                            if (b.title) {
                                b.booktitle = b.title;
                            }
                            b.title = p[1];
                            b.pubtype = "PP_BOOK_CHAPTER";
                        }
                    }
                    if (j == "Year of Publication") {
                        b.year = k;
                    }
                    if (j == "Reviewed Article Year of Publication") {
                        b.originally_published = {
                            year: k
                        };
                    }
                    if (j == "Date of Publication") {
                        var p;
                        if (p = k.match(/(\d\d\d\d)/)) {
                            b.year = p[1];
                        }
                    }
                    if (j == "DOI" || j == "DOI Number" || j == "Digital Object Identifier") {
                        if (i && i[0]) {
                            b.doi = $(i[0]).attr("href");
                        } else {
                            b["doi"] = k;
                        }
                    }
                    if (j == "URL") {
                        if (i && i[0]) {
                            b.url.push($(i[0]).attr("href"));
                        }
                    }
                    if (j == "Electronic Location" || j == "Related URI" || j == "URI of Resource") {
                        if (i && i[0]) {
                            b.url.push($(i[0]).attr("href"));
                        }
                    }
                    if (j == "Journal Abbreviation") {
                        if (b["journal"]) {
                            b["journalfull"] = b["journal"];
                        }
                        b["journal"] = k;
                    }
                    if (j == "Author" || j == "Authors" || j == "Book Editor" || j == "Authors Full Name" || j == "Reviewed Article Authors" || j == "Instrument Author") {
                        var q = j == "Book Editor" ? "editor" : "author";
                        q = j == "Reviewed Article Authors" ? "contributor" : q;
                        if (!b[q]) b[q] = [];
                        var r = [];
                        var s = "children";
                        if (!(s in h[0])) {
                            s = "childNodes";
                        } else if (s in h[0] && "childNodes" in h[0] && h[0].childNodes.length >= h[0][s].length) {
                            s = "childNodes";
                        }
                        for (var t = 0; t < h[0][s].length; t++) {
                            var u = $(h[0][s][t]).text();
                            if (u && u.match(/[A-Z]/i)) {
                                r.push(u);
                            }
                        }
                        if (r.length > 1) {
                            b[q] = b[q].concat(c.parseAuthors(r));
                        } else {
                            b[q] = b[q].concat(c.parseAuthors(k));
                            if (b[q].length > 3 && b[q].length % 2 === 0) {
                                var v = b[q].length / 2;
                                var w = false;
                                for (var x = 0; x < v; x++) {
                                    if (b[q][x].last != b[q][x + v].last) w = true;
                                }
                                if (!w) {
                                    b[q] = b[q].slice(v);
                                }
                            }
                        }
                    }
                    if (j == "Language") {
                        b.language = k.match(/([A-z]*)/)[0];
                    }
                    if (j == "Institution") {
                        b.affiliation = k;
                    }
                    if (j == "Note") {
                        b.note = k;
                    }
                    if (j == "Publisher Information") {
                        b.publisher = k;
                    }
                    if (j == "Year") {
                        if (!b.published) {
                            b.published = {
                                year: k
                            };
                        } else if (!b.published.year) {
                            b.published.year = k;
                        }
                    }
                    if (j == "Page Count") {
                        b.num_pages = k;
                    }
                }
            }
        }
        if (b.editor && !b.booktitle) {}
        if (b.pubtype == "PP_BOOK_CHAPTER") {
            if (!b.booktitle && b.journal) {
                b.booktitle = b.journal;
            }
            if (!b.publisher && b.institution) {
                b.publisher = b.institution;
            }
            delete b.institution;
            if (typeof b.editor == "string") {
                b.editor = c.parseAuthors(b.editor);
            }
        }
        if (b["language"]) b["language"] = PP.Utils.normalizeLanguage(b["language"]);
        if (b.keywords.length > 0) {
            b.keywords = b.keywords.join("; ");
        } else {
            delete b.keywords;
        }
        return b;
    },
    parseAuthors: function(a) {
        var b = [];
        var c;
        if (Array.isArray(a)) {
            c = a;
        } else {
            if (a.indexOf(";") > 0) {
                c = a.split(/\s*;\s*/);
            } else {
                c = a.split(/\s*\.\s*/);
            }
        }
        for (var d = 0; d < c.length; d++) {
            var e = c[d].split(/,/);
            if (e.length > 1) {
                c[d] = e[0] + ", " + e[1];
            }
            c[d] = c[d].replace(/\s+MS$/, "");
            c[d] = c[d].replace(/\s+\[.*$/, "");
            if (c[d]) b.push(PP.library.Author.parseAuthor(c[d]));
        }
        return b;
    },
    normalizeStr: function(a) {
        var b = "";
        if (a) {
            b = a.replace(/^[\n\t\r\s]+/, "").replace(/[\n\t\r\s]+$/, "").replace(/[\t\r\n\s]+/g, " ");
        }
        return b;
    },
    getName: function() {
        return "Ovid";
    }
});

PP.format.Ovid = new PP.format._Ovid();

PP.format._ORBi = PP.format.AbstractReader.extend({
    doRead: function(a) {
        var b = this._readHTML(a);
        PP.library.Publication.autoClean(b);
        return [ b ];
    },
    _readHTML: function(a) {
        var b = {
            url: [],
            pubtype: "PP_ARTICLE",
            keywords: [],
            authors: [],
            editors: []
        };
        var c = $(a).find("td.label");
        var d = $(a).find("td.data");
        if (c.length > 0 && c.length == d.length) {
            var e;
            for (var f = 0; f < c.length; f++) {
                var g = $(c[f]).text().replace(/\n/g, " ");
                g = this.normalizeStr(g).replace(/:.*/, "").toUpperCase().trim();
                if (g !== "") {
                    e = g;
                } else {
                    g = e;
                }
                var h = $(d[f]).text().replace(/\n/g, " ");
                h = this.normalizeStr(h).trim();
                b = this.parseKeyValue(g, h, b);
            }
        }
        if (b.authors.length) b["author"] = this.parseAuthors(b.authors);
        if (b.editors.length) b["editor"] = this.parseAuthors(b.editors);
        if (b.series_editor && b.series_editor.length) b["series_editor"] = this.parseAuthors(b.series_editor);
        delete b.editors;
        delete b.authors;
        delete b.series_editor;
        return b;
    },
    normalizeStr: function(a) {
        var b = "";
        if (a) {
            b = a.replace(/^[\n\t\r\s]+/, "").replace(/[\n\t\r\s]+$/, "").replace(/[\t\r\n\s]+/g, " ");
        }
        return b;
    },
    parseKeyValue: function(a, b, c) {
        while (a.indexOf("_") >= 0) {
            a = a.replace("_", " ");
        }
        if (a == "DOCUMENT TYPE") {
            if (b.match(/(conference|congress|symposium|workshop)/i)) {
                c.pubtype = "PP_CONFERENCE_PAPER";
            } else if (b.match(/(parts of books)/i)) {
                c.pubtype = "PP_BOOK_CHAPTER";
            } else if (b.match(/(books)/i)) {
                c.pubtype = "PP_BOOK";
            } else if (b.match(/(thesis|dissertation)/i)) {
                c.pubtype = "PP_THESIS";
            }
        } else if (a == "TITLE") {
            c.title = b;
        } else if (a == "AUTHOR" || a == "AUTHOR, CO-AUTHOR") {
            var d = b.replace(/(\[.*\])/, "");
            c.authors.push(d);
        } else if (a == "EDITOR" || a == "EDITOR, CO-EDITOR" || a == "SUPERVISOR") {
            var e = b.replace(/(\[.*\])/, "");
            c.editors.push(e);
        } else if (a == "PUBLISHER") {
            if (!c.publisher) {
                if (b.charAt(b.length - 1) == ",") {
                    b = b.substring(0, b.length - 1);
                }
                c.publisher = b;
            }
        } else if (a == "KEYWORDS") {
            var f = b.split(";");
            f.forEach(function(a) {
                a = a.trim();
                if (c.keywords.indexOf(a) === -1) c.keywords.push(a);
            });
        } else if (a == "ISBN") {
            var g = PP.Utils.extractISBNs(b, {
                convert: true,
                unique: true
            });
            var h;
            while (h = g.shift()) {
                if (!c.isbn) {
                    c.isbn = h;
                } else {
                    if (!c.isbn_alt) c.isbn_alt = h;
                }
            }
        } else if (a == "ISSN") {
            c.issn = b;
        } else if (a == "E-ISSN") {
            c.issn_alt = b;
        } else if (a == "LCCN") {
            c.lccn = b;
        } else if (a == "EDITION") {
            c.edition = b;
        } else if (a == "ABSTRACT") {
            c.abstract = b;
        } else if (a == "MAIN DOCUMENT TITLE") {
            c.booktitle = b;
        } else if (a == "JOURNAL TITLE") {
            c.journal = b;
        } else if (a == "COLLECTION AND COLLECTION VOLUME") {
            if (b.indexOf(", Editor") != -1) {
                var i = b.substring(b.indexOf(", Editor") + 10);
                c.series_editor = [ i ];
                b = b.substring(0, b.indexOf(", Editor") - 1);
            }
            c.series = b;
        } else if (a == "INSTITUTION") {
            c.school = b;
        } else if (a == "LANGUAGE") {
            c.langage = b;
        } else if (a == "PUBLICATION DATE") {
            var j = {};
            var k = b;
            var l = k.match(/(\d{4})/);
            if (l && l[1]) {
                j.year = l[1];
            }
            c.published = j;
        } else if (a == "PAGE NUMBER" || a == "PAGES") {
            c.pages = b;
        } else if (a == "CITY" || a == "COUNTRY") {
            if (c.address) {
                c.address += ", " + b;
            } else {
                c.address = b;
            }
        } else if (a == "EVENT NAME") {
            c.conference = b;
        } else if (a == "EVENT DATE") {
            c.conference_date = b;
        } else if (a == "EVENT PLACE (CITY)" || a == "EVENT COUNTRY") {
            if (c.conference_location) {
                c.conference_location += ", " + b;
            } else {
                c.conference_location = b;
            }
        } else if (a == "PERMALINK" || a == "OTHER URL") {
            c.url.push(b);
        } else if (a == "DOI") {
            c.doi = b;
        }
        return c;
    },
    parseAuthors: function(a) {
        var b = [];
        for (var c = 0; c < a.length; c++) {
            a[c] = a[c].replace(/[\+\*\[\(\d].*$/g, "");
            a[c] = a[c].replace(/\s*(MD|PhD|MSc)\s*,?\s*/g, "");
            a[c] = a[c].replace(/[0-9]{4}-[0-9]{4}/g, "");
            a[c] = a[c].replace(/[0-9]{4}-/g, "");
            var d = a[c].split(/,\s*/);
            if (d.length >= 2) {
                b.push({
                    last: d[0],
                    first: d[1]
                });
            }
        }
        return b;
    },
    getName: function() {
        return "ORBi";
    }
});

PP.format.ORBi = new PP.format._ORBi();

PP.format._PaperpileJSON = PP.format.AbstractReader.extend({
    getName: function() {
        return "PaperpileJSON";
    },
    doRead: function(a) {
        var b = [];
        if (a) {
            if (PP.Utils.isString(a)) {
                a = a.replace(/%%PAPERPILEJSONEXPORT%%/, "");
                b = PP.Utils.decode(a);
            } else {
                b = [ a ];
            }
        } else {
            return b;
        }
        var c = [ "sha1", "folders", "labels", "autoCleaned", "dup_sha1", "shared_folders", "id_list", "incomplete", "count_index", "imported", "owner", "journal_checked", "subfolders", "updated", "collection_timestamps", "external_pdf_filename", "duplicates", "created", "crawl_urls", "gs_cluster_id", "pdf_restricted" ];
        var d = [ "author", "editor", "series_editor", "contributor", "translator" ];
        var e = [];
        b.forEach(function(a) {
            for (var b in a) {
                if (b.match(/^_/)) delete a[b];
                if (c.indexOf(b) > -1) delete a[b];
                if (PP.Utils.isObject(a[b])) {
                    if ("$numberLong" in a[b]) {
                        a[b] = parseInt(a[b]["$numberLong"]);
                    }
                    for (var f in a[b]) {
                        if (PP.Utils.isObject(a[b][f])) {
                            if ("$numberLong" in a[b][f]) {
                                a[b][f] = parseInt(a[b][f]["$numberLong"]);
                            }
                        }
                    }
                }
                if (b === "source") {
                    delete a.source.pdf_crawl_status;
                    delete a.source.pdf_crawl_current_url;
                    delete a.source.pdf_crawl_error;
                    delete a.source.pdf_web_url;
                    delete a.source._existing_pub_data;
                }
                if (b === "url") {
                    if (PP.Utils.isArray(a.url)) {
                        var g = [];
                        a.url.forEach(function(a) {
                            if (PP.Utils.isString(a)) {
                                a = a.replace(/\s.+/, "");
                                if (a.length > 10) g.push(a);
                            }
                        });
                        a.url = g;
                    }
                }
            }
            d.forEach(function(b) {
                if (b in a) {
                    a[b].forEach(function(a) {
                        delete a._id;
                    });
                }
            });
            PP.library.Publication.autoClean(a);
            if (a.trashed !== "1" && a.trashed !== 1) e.push(a);
        });
        return e;
    }
});

PP.format.PaperpileJSON = new PP.format._PaperpileJSON();

PP.format._Pdf = PP.format.AbstractReader.extend({
    getName: function() {
        return "PDF Parsing";
    },
    isAsync: function() {
        return true;
    },
    doRead: function(a, b) {
        var c = function(a, c) {
            if (c) {
                console.log("PDF parse failed:", c);
                PP.Utils.callback(b, null, [ null, c ]);
            } else {
                PP.Utils.callback(b, null, [ [ a ], null ]);
            }
        };
        var d = new PP.pdf.Pdf();
        if (a.match("http")) {
            d.getPubFromPdf(a, c);
        } else {
            var e = chrome.extension.getURL(a);
            d.getPubFromPdf(e, c);
        }
        return null;
    },
    readMendeleyItem: function(a) {
        var b = {
            pubtype: "PP_ARTICLE",
            folders: [],
            labels: []
        };
    }
});

PP.format.Pdf = new PP.format._Pdf();

PP.format._PNX = PP.format.AbstractReader.extend({
    doRead: function(a) {
        if (typeof a == "string") {
            var b = this.getXMLParser(a);
            var c = this._readXML(b);
            PP.library.Publication.autoClean(c);
            return [ c ];
        } else if (typeof a == "object") {
            var c = this._readXML(a);
            PP.library.Publication.autoClean(c);
            return [ c ];
        } else {
            return [];
        }
    },
    _readXML: function(a) {
        var b;
        var c = {
            author: [],
            url: [],
            pubtype: "PP_MISC",
            keywords: []
        };
        var d = $(a).find("addata ristype").text();
        if (d && d.length > 0) {
            var e = PP.library.PublicationTypes.getInputTypeForPub(d, "ris");
            if (e && e.pubtype) {
                c.pubtype = e.pubtype;
            }
        }
        d = $(a).find("display type").text();
        if (d && d.length > 0) {
            if (d.match(/thesis/i)) {
                c.pubtype = "PP_THESIS";
            }
            if (d.match(/audio/i)) {
                c.pubtype = "PP_AUDIO";
            }
            if (d.match(/video/i)) {
                c.pubtype = "PP_VIDEO";
            }
            if (d.match(/audiovisual/i)) {
                c.pubtype = "PP_AUDIO";
            }
        }
        d = $(a).find("addata format").text();
        if (d && d.length > 0) {
            if (d.match(/dissertation/i)) {
                c.pubtype = "PP_THESIS";
                c.kind = "Ph.D. Thesis";
            }
            if (d.match(/patent/i)) {
                c.pubtype = "PP_PATENT";
            }
            if (c.pubtype == "PP_MISC" && d.match(/book/i)) {
                c.pubtype = "PP_BOOK";
            }
        }
        var f = {
            "addata doi": "doi",
            "addata pmid": "pmid",
            "addata jtitle": "journal",
            "addata issue": "issue",
            "addata volume": "volume",
            "addata pages": "pages",
            "addata abstract": "abstract",
            "display description": "abstract",
            "display edition": "edition",
            "display format": "medium",
            "addata atitle": "title",
            "addata issn": "issn",
            "addata eissn": "issn_alt",
            "addata au": "author",
            "addata aucorp": "author",
            "addata date": "date",
            "addata btitle": "title",
            "addata pub": "publisher",
            "addata cop": "address",
            "addata isbn": "isbn",
            "addata seriestitle": "series",
            "links linktorsrc": "url",
            "addata url": "url",
            "addata spage": "startpage",
            "addata epage": "endpage",
            "facets topic": "keywords",
            "display type": "tmptype",
            "addata lccn": "lccn"
        };
        this._assignMapValues(f, a, c);
        if (c.author.length === 0) {
            this._assignMapValues({
                "addata addau": "author"
            }, a, c);
        }
        if (c.author.length === 0) {
            this._assignMapValues({
                "display creator": "author"
            }, a, c);
        }
        if (c.author.length === 0) {
            this._assignMapValues({
                "display contributor": "author"
            }, a, c);
        }
        this._assignMapValues({
            "display publisher": "publisher",
            "display title": "title",
            "display creationdate": "date"
        }, a, c);
        if (c.series) {
            b = c.series.match(/(.+)\s*;\s*(\d+)\s*$/);
            if (b && b[2]) {
                c.series = b[1].replace(/\s+$/, "");
                c.series_number = b[2];
            }
        }
        if (c.pubtype == "PP_THESIS" && c.publisher) {
            c.school = c.publisher;
            delete c.publisher;
        }
        if (c.title) {
            c.title = c.title.replace(/\s*\/\s*edited\s+by.+/i, "");
        }
        if (c.tmptype) {
            if (c.tmptype.match(/score/)) {
                c.pubtype = "PP_SCORE";
            } else if (c.tmptype.match(/newspaper/)) {
                c.pubtype = "PP_NEWS_ARTICLE";
            }
            delete c.tmptype;
        }
        if (c.pages) {
            delete c.startpage;
            delete c.endpage;
        }
        c.keywords = c.keywords.join(";");
        return c;
    },
    _assignMapValues: function(a, b, c) {
        var d, e, f;
        for (f in a) {
            d = $(b).find(f);
            if (d && d.length > 0) {
                if (a[f] === "author") {
                    for (var g = 0; g < d.length; g++) {
                        $(d[g]).text().split("|").forEach(function(b) {
                            if (!b.match(/(SpringerLink)/)) {
                                b = $("<div>" + b + "</div>").text();
                                b = b.replace(/\s+author\s*$/i, "");
                                b = b.replace(/\s+editor\s*$/i, "");
                                b = b.replace(/\s+\(.*$/i, "");
                                b = b.replace(/\s*\d\d\d\d.*$/, "");
                                b = b.replace(/\[.+$/, "");
                                b = b.replace(/[,\-]\s*$/, "");
                                if (f.match(/aucorp/)) {
                                    c[a[f]].push({
                                        collective: b
                                    });
                                } else {
                                    if (!b.match(/;/)) {
                                        c[a[f]].push(PP.library.Author.parseAuthor(b));
                                    } else {
                                        c[a[f]] = c[a[f]].concat(PP.library.Author.parseAuthorList(b, {
                                            auto: false,
                                            delimiter: ";"
                                        }));
                                    }
                                }
                            }
                        });
                    }
                } else if (a[f] === "date") {
                    e = $(d[0]).text().match(/^(\d\d\d\d)(\d\d)(\d\d)$/);
                    if (e && e[3]) {
                        c.year = e[1];
                        c.month = e[2];
                        c.day = e[3];
                    } else {
                        e = $(d[0]).text().match(/^(\d\d\d\d)$/);
                        if (e && e[1]) {
                            c.year = e[1];
                        }
                    }
                } else if (a[f] === "url") {
                    e = $(d[0]).text().match(/\$\$U(.+)\$\$E/);
                    if (e && e[1]) {
                        c.url.push(e[1]);
                    } else {
                        e = $(d[0]).text().match(/^(http.+)\$\$U/);
                        if (e && e[1]) {
                            c.url.push(e[1]);
                        } else {
                            e = $(d[0]).text();
                            if (!e.match(/\$/)) {
                                c.url.push(e);
                            }
                        }
                    }
                } else if (a[f] === "abstract") {
                    c["abstract"] = [];
                    for (var g = 0; g < d.length; g++) {
                        c["abstract"].push($(d[g]).text());
                    }
                    c["abstract"] = PP.Array.unique(c["abstract"]).join("\n");
                } else if (a[f] === "keywords") {
                    for (var g = 0; g < d.length; g++) {
                        c.keywords.push($(d[g]).text());
                    }
                } else if (a[f] === "isbn") {
                    var h = [];
                    for (var g = 0; g < d.length; g++) {
                        h.push($(d[g]).text());
                    }
                    h = PP.Utils.extractISBNs(h.join(" "), {
                        convert: true,
                        unique: true
                    });
                    var i;
                    while (i = h.shift()) {
                        if (!c.isbn) {
                            c.isbn = i;
                        } else {
                            if (!c.isbn_alt) c.isbn_alt = i;
                        }
                    }
                } else {
                    if (!(a[f] in c)) {
                        e = $(d[0]).text();
                        e = $("<div>" + e + "</div>").text();
                        if (!e.match(/^None$/i)) {
                            c[a[f]] = e;
                        }
                    }
                }
            }
        }
    },
    getName: function() {
        return "PNX";
    }
});

PP.format.PNX = new PP.format._PNX();

PP.format._ProQuest = PP.format.AbstractReader.extend({
    doRead: function(a) {
        var b = this._readHTML(a);
        PP.library.Publication.autoClean(b);
        return [ b ];
    },
    _readHTML: function(a) {
        var b, c, d, e;
        var f = this;
        var g = {
            url: [],
            pubtype: "PP_MISC",
            keywords: []
        };
        var h = {
            Author: "author",
            "Country of publication": "country",
            Department: "department",
            "Document author": "author",
            "Document type": "pubtype",
            "Document URL": "url",
            DOI: "doi",
            Editor: "editor",
            eISSN: "issn",
            ISBN: "isbn",
            ISSN: "issn",
            Issue: "issue",
            "Journal abbreviation": "journal",
            Location: "address",
            Language: "language",
            "Language of publication": "language",
            "Monograph title": "booktitle",
            "Number of pages": "num_pages",
            Pages: "pages",
            "Place of publication": "address",
            "Publication date": "date",
            "Publication details": "details",
            "Publication title": "journal",
            "Publication type": "pubtype",
            "Publication year": "year",
            Publisher: "publisher",
            "PubMed ID": "pmid",
            "Record type": "pubtype",
            School: "school",
            Series: "series",
            "Source type": "pubtype",
            Title: "title",
            "University/institution": "school",
            URL: "url",
            Volume: "volume",
            Advisor: "editor",
            "First page": "pages"
        };
        var i = {
            Author: [ "Autor", "Auteur", "\uc800\uc790", "Autore", "Szerz\u0151", "\u8457\u8005", "Forfatter", "\u0410\u0432\u0442\u043e\u0440", "\u0e1c\u0e39\u0e49\u0e41\u0e15\u0e48\u0e07", "Yazar ad\u0131", "\u4f5c\u8005" ],
            Copyright: [ "\u8457\u4f5c\u6a29", "Opphavsrett", "Prawa autorskie", "\u0e25\u0e34\u0e02\u0e2a\u0e34\u0e17\u0e18\u0e34\u0e4c", "Telif Hakk\u0131", "\u7248\u6743", "\u8457\u4f5c\u6b0a" ],
            "Country of publication": [ "Publikationsland", "Pa\xeds de publicaci\xf3n", "Pays de publication", "\ucd9c\ud310 \uad6d\uac00", "Paese di pubblicazione", "Publik\xe1ci\xf3 orsz\xe1ga", "\u51fa\u7248\u56fd", "Utgivelsesland", "Kraj publikacji", "Pa\xeds de publica\xe7\xe3o", "\u0421\u0442\u0440\u0430\u043d\u0430 \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438", "\u0e1b\u0e23\u0e30\u0e40\u0e17\u0e28\u0e17\u0e35\u0e48\u0e1e\u0e34\u0e21\u0e1e\u0e4c", "Yay\u0131nlanma \xfclkesi", "\u51fa\u7248\u7269\u56fd\u5bb6/\u5730\u533a", "\u51fa\u7248\u570b\u5bb6/\u5730\u5340" ],
            Database: [ "Datenbank", "Base de datos", "Base de donn\xe9es", "\ub370\uc774\ud130\ubca0\uc774\uc2a4", "Adatb\xe1zis", "\u30c7\u30fc\u30bf\u30d9\u30fc\u30b9", "Baza danych", "Base de dados", "\u0411\u0430\u0437\u0430", "\u0e10\u0e32\u0e19\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25", "Veritaban\u0131", "\u6570\u636e\u5e93", "\u8cc7\u6599\u5eab" ],
            Department: [ "Abteilung" ],
            Degree: [ "Studienabschluss", "T\xedtulo universitario", "Dipl\xf4me", "\ud559\uc704", "Titolo accademico", "Diploma", "\u5b66\u4f4d\u79f0\u53f7", "Grad", "Stopie\u0144", "Gradua\xe7\xe3o", "Licenciatura", "\u0421\u0442\u0435\u043f\u0435\u043d\u044c", "\u0e1b\u0e23\u0e34\u0e0d\u0e0d\u0e32\u0e1a\u0e31\u0e15\u0e23", "Derece", "\u5b66\u4f4d", "\u5b78\u4f4d" ],
            "Document type": [ "Dokumententyp", "Tipo de documento", "Type de document", "\ubb38\uc11c \ud615\uc2dd", "Tipo di documento", "Dokumentum t\xedpusa", "\u30c9\u30ad\u30e5\u30e1\u30f3\u30c8\u306e\u30bf\u30a4\u30d7", "Dokumenttype\u0646\u062f", "Rodzaj dokumentu", "\u0422\u0438\u043f \u0434\u043e\u043a\u0443\u043c\u0435\u043d\u0442\u0430", "\u0e1b\u0e23\u0e30\u0e40\u0e20\u0e17\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23", "Belge t\xfcr\xfc", "\u6587\u6863\u7c7b\u578b", "\u6587\u4ef6\u985e\u578b" ],
            "Identifier / keyword": [ "Identifikator/Schl\xfcsselwort", "Identificador / palabra clave", "Identificateur / mot-cl\xe9", "\uc2dd\ubcc4\uc790/\ud0a4\uc6cc\ub4dc", "Identificativo/parola chiave", "Azonos\xedt\xf3 / kulcssz\xf3", "\u8b58\u5225\u5b50 / \u30ad\u30fc\u30ef\u30fc\u30c9", "Identifikator/n\xf8kkelord", "Identyfikator/s\u0142owo kluczowe", "Identificador / palavra-chave", "\u0418\u0434\u0435\u043d\u0442\u0438\u0444\u0438\u043a\u0430\u0442\u043e\u0440 / \u043a\u043b\u044e\u0447\u0435\u0432\u043e\u0435 \u0441\u043b\u043e\u0432\u043e", "\u0e15\u0e31\u0e27\u0e1a\u0e48\u0e07\u0e0a\u0e35\u0e49/\u0e04\u0e33\u0e2a\u0e33\u0e04\u0e31\u0e0d", "Tan\u0131mlay\u0131c\u0131 / anahtar kelime", "\u6807\u8bc6\u7b26/\u5173\u952e\u5b57", "\u8b58\u5225\u78bc/\u95dc\u9375\u5b57" ],
            Issue: [ "Ausgabe", "N\xfamero", "Num\xe9ro", "\ud638", "Fascicolo", "Sz\xe1m", "\u53f7", "Utgave", "Wydanie", "Edi\xe7\xe3o", "\u0412\u044b\u043f\u0443\u0441\u043a", "\u0e09\u0e1a\u0e31\u0e1a\u0e17\u0e35\u0e48", "Say\u0131", "\u671f" ],
            "Journal subject": [ "Zeitschriftenthema", "Materia de la revista", "Sujet de la publication", "\uc800\ub110 \uc8fc\uc81c", "Soggetto rivista", "Foly\xf3irat t\xe1rgya", "\u5b66\u8853\u8a8c\u306e\u4e3b\u984c", "Journalemne", "Tematyka czasopisma", "Assunto do peri\xf3dico", "Assunto da publica\xe7\xe3o peri\xf3dica", "\u0422\u0435\u043c\u0430\u0442\u0438\u043a\u0430 \u0436\u0443\u0440\u043d\u0430\u043b\u0430", "\u0e2b\u0e31\u0e27\u0e40\u0e23\u0e37\u0e48\u0e2d\u0e07\u0e02\u0e2d\u0e07\u0e27\u0e32\u0e23\u0e2a\u0e32\u0e23", "Dergi konusu", "\u671f\u520a\u4e3b\u9898", "\u671f\u520a\u4e3b\u984c" ],
            Language: [ "Sprache", "Idioma", "Langue", "\uc5b8\uc5b4", "Lingua", "Nyelv", "\u8a00\u8a9e", "Spr\xe5k", "J\u0119zyk", "\u042f\u0437\u044b\u043a", "\u0e20\u0e32\u0e29\u0e32", "Dil", "\u8bed\u8a00", "\u8a9e\u8a00" ],
            "Language of publication": [ "Publikationssprache", "Idioma de la publicaci\xf3n", "Langue de publication", "\ucd9c\ud310 \uc5b8\uc5b4", "Lingua di pubblicazione", "Publik\xe1ci\xf3 nyelve", "\u51fa\u7248\u7269\u306e\u8a00\u8a9e", "Utgivelsesspr\xe5k", "J\u0119zyk publikacji", "Idioma de publica\xe7\xe3o", "\u042f\u0437\u044b\u043a \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438", "\u0e20\u0e32\u0e29\u0e32\u0e02\u0e2d\u0e07\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e2a\u0e34\u0e48\u0e07\u0e1e\u0e34\u0e21\u0e1e\u0e4c", "Yay\u0131n Dili", "\u51fa\u7248\u7269\u8bed\u8a00", "\u51fa\u7248\u7269\u8a9e\u8a00" ],
            "Number of pages": [ "Seitenanzahl", "N\xfamero de p\xe1ginas", "Nombre de pages", "\ud398\uc774\uc9c0 \uc218", "Numero di pagine", "Oldalsz\xe1m", "\u30da\u30fc\u30b8\u6570", "Antall sider", "Liczba stron", "\u0427\u0438\u0441\u043b\u043e \u0441\u0442\u0440\u0430\u043d\u0438\u0446", "\u0e08\u0e33\u0e19\u0e27\u0e19\u0e2b\u0e19\u0e49\u0e32", "Sayfa say\u0131s\u0131", "\u9875\u6570", "\u9801\u6578" ],
            Pages: [ "Seiten", "P\xe1ginas", "\ud398\uc774\uc9c0", "Pagine", "Oldalak", "\u30da\u30fc\u30b8", "Sider", "Strony", "\u0421\u0442\u0440\u0430\u043d\u0438\u0446\u044b", "\u0e2b\u0e19\u0e49\u0e32", "Sayfalar", "\u9875", "\u9801\u9762" ],
            "Place of publication": [ "Verlagsort", "Lugar de publicaci\xf3n", "Lieu de publication", "\ucd9c\ud310 \uc9c0\uc5ed", "Luogo di pubblicazione:", "Publik\xe1ci\xf3 helye", "\u51fa\u7248\u5730", "Utgivelsessted", "Miejsce publikacji", "Local de publica\xe7\xe3o", "\u041c\u0435\u0441\u0442\u043e \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438", "\u0e2a\u0e16\u0e32\u0e19\u0e17\u0e35\u0e48\u0e1e\u0e34\u0e21\u0e1e\u0e4c", "Bas\u0131m yeri", "\u51fa\u7248\u7269\u5730\u70b9" ],
            "Publication date": [ "Publikationsdatum", "Fecha de titulaci\xf3n", "Date du dipl\xf4me", "\ucd9c\ud310 \ub0a0\uc9dc", "Data di pubblicazione", "Publik\xe1ci\xf3 d\xe1tuma", "\u51fa\u7248\u65e5", "Utgivelsesdato", "Data publikacji", "Data de publica\xe7\xe3o", "Data da publica\xe7\xe3o", "\u0414\u0430\u0442\u0430 \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438", "\u0e27\u0e31\u0e19\u0e17\u0e35\u0e48\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e2a\u0e34\u0e48\u0e07\u0e1e\u0e34\u0e21\u0e1e\u0e4c", "Yay\u0131nlanma tarihi", "\u51fa\u7248\u65e5\u671f" ],
            "Publication title": [ "Titel der Publikation", "T\xedtulo de publicaci\xf3n", "Titre de la publication", "\ucd9c\ud310\ubb3c \uc81c\ubaa9", "Titolo pubblicazione", "Publik\xe1ci\xf3 c\xedme", "\u51fa\u7248\u7269\u306e\u30bf\u30a4\u30c8\u30eb", "Utgivelsestittel", "Tytu\u0142 publikacji", "T\xedtulo da publica\xe7\xe3o", "\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435 \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438", "\u0e0a\u0e37\u0e48\u0e2d\u0e40\u0e2d\u0e01\u0e2a\u0e32\u0e23\u0e2a\u0e34\u0e48\u0e07\u0e1e\u0e34\u0e21\u0e1e\u0e4c", "Yay\u0131n ad\u0131", "\u51fa\u7248\u7269\u540d\u79f0", "\u51fa\u7248\u7269\u540d\u7a31" ],
            "Publication year": [ "Erscheinungsjahr", "A\xf1o de publicaci\xf3n", "Ann\xe9e de publication", "\ucd9c\ud310 \uc5f0\ub3c4", "Anno di pubblicazione", "Publik\xe1ci\xf3 \xe9ve", "\u51fa\u7248\u5e74", "Utgivelses\xe5r", "Rok publikacji", "Ano de publica\xe7\xe3o", "Ano da publica\xe7\xe3o", "\u0413\u043e\u0434 \u043f\u0443\u0431\u043b\u0438\u043a\u0430\u0446\u0438\u0438", "\u0e1b\u0e35\u0e17\u0e35\u0e48\u0e1e\u0e34\u0e21\u0e1e\u0e4c", "Yay\u0131n Y\u0131l\u0131", "\u51fa\u7248\u5e74\u4efd" ],
            Publisher: [ "Herausgeber", "Editorial", "\xc9diteur", "\ucd9c\ud310\uc0ac", "Casa editrice", "Kiad\xf3", "\u51fa\u7248\u793e", "Utgiver", "Wydawca", "Editora", "\u0418\u0437\u0434\u0430\u0442\u0435\u043b\u044c\u0441\u0442\u0432\u043e", "\u0e2a\u0e33\u0e19\u0e31\u0e01\u0e1e\u0e34\u0e21\u0e1e\u0e4c", "Yay\u0131nc\u0131", "\u51fa\u7248\u5546", "\u51fa\u7248\u8005" ],
            School: [ "Bildungseinrichtung", "Instituci\xf3n", "\xc9cole", "\ud559\uad50", "Istituzione accademica", "Iskola", "\u5b66\u6821", "Skole", "Uczelnia", "Escola", "\u0423\u0447\u0435\u0431\u043d\u043e\u0435 \u0437\u0430\u0432\u0435\u0434\u0435\u043d\u0438\u0435", "\u0e2a\u0e16\u0e32\u0e1a\u0e31\u0e19\u0e01\u0e32\u0e23\u0e28\u0e36\u0e01\u0e29\u0e32", "Okul", "\u5b78\u6821" ],
            "School location": [ "Standort der Bildungseinrichtung", "Lugar de la instituci\xf3n", "\ud559\uad50 \uc9c0\uc5ed", "Localit\xe0 istituzione accademica", "Iskola helysz\xedne:", "\u5b66\u6821\u6240\u5728\u5730", "Skolested", "Lokalizacja uczelni", "Localiza\xe7\xe3o da escola", "\u041c\u0435\u0441\u0442\u043e\u043d\u0430\u0445\u043e\u0436\u0434\u0435\u043d\u0438\u0435 \u0443\u0447\u0435\u0431\u043d\u043e\u0433\u043e \u0437\u0430\u0432\u0435\u0434\u0435\u043d\u0438\u044f", "\u0e2a\u0e16\u0e32\u0e19\u0e17\u0e35\u0e48\u0e15\u0e31\u0e49\u0e07\u0e02\u0e2d\u0e07\u0e2a\u0e16\u0e32\u0e1a\u0e31\u0e19\u0e01\u0e32\u0e23\u0e28\u0e36\u0e01\u0e29\u0e32", "Okul konumu", "\u5b66\u6821\u5730\u70b9", "\u5b78\u6821\u5730\u9ede" ],
            Section: [ "Bereich", "Secci\xf3n", "\uc139\uc158", "Sezione", "R\xe9sz", "\u30bb\u30af\u30b7\u30e7\u30f3", "Del", "Rozdzia\u0142", "Se\xe7\xe3o", "Sec\xe7\xe3o", "\u0420\u0430\u0437\u0434\u0435\u043b", "\u0e2a\u0e48\u0e27\u0e19", "B\xf6l\xfcm", "\u7ae0\u8282", "\u5340\u6bb5" ],
            "Source type": [ "Quellentyp", "Tipo de fuente", "Type de source", "\uc6d0\ubcf8 \uc720\ud615", "Tipo di fonte", "Forr\xe1st\xedpus", "\u30ea\u30bd\u30fc\u30b9\u30bf\u30a4\u30d7", "Kildetype", "Typ \u017ar\xf3d\u0142a", "Tipo de fonte", "\u0422\u0438\u043f \u0438\u0441\u0442\u043e\u0447\u043d\u0438\u043a\u0430", "\u0e1b\u0e23\u0e30\u0e40\u0e20\u0e17\u0e02\u0e2d\u0e07\u0e41\u0e2b\u0e25\u0e48\u0e07\u0e02\u0e49\u0e2d\u0e21\u0e39\u0e25", "Yay\u0131n t\xfcr\xfc", "\u6765\u6e90\u7c7b\u578b", "\u4f86\u6e90\u985e\u578b" ],
            Subject: [ "Thema", "Materia", "Sujet", "\uc8fc\uc81c", "Soggetto", "T\xe1rgy", "\u4e3b\u984c", "Emne", "Temat", "Assunto", "\u0422\u0435\u043c\u0430", "\u0e2b\u0e31\u0e27\u0e40\u0e23\u0e37\u0e48\u0e2d\u0e07", "Konu", "\u4e3b\u9898" ],
            Title: [ "Titel", "T\xedtulo", "Titre", "\uc81c\ubaa9", "Titolo", "C\xedm", "\u30bf\u30a4\u30c8\u30eb", "Tittel", "Tytu\u0142", "\u041d\u0430\u0437\u0432\u0430\u043d\u0438\u0435", "\u0e0a\u0e37\u0e48\u0e2d\u0e40\u0e23\u0e37\u0e48\u0e2d\u0e07", "Ba\u015fl\u0131k", "\u6807\u9898", "\u6a19\u984c" ],
            Volume: [ "Band", "Tomo", "\uad8c", "K\xf6tet", "\u5dfb", "Volum", "Tom", "\u0422\u043e\u043c", "\u0e40\u0e25\u0e48\u0e21", "Cilt", "\u5377", "\u5377\u671f" ],
            Year: [ "Jahr", "A\xf1o", "Ann\xe9e", "\uc5f0\ub3c4", "Anno", "\xc9v", "\u5e74", "\xc5r", "Rok", "Ano", "\u0413\u043e\u0434", "\u0e1b\u0e35", "Y\u0131l", "\u51fa\u7248\u5e74" ],
            "University/institution": [ "Universit\xe4t/Einrichtung", "\u5927\u5b66/\u6559\u80b2\u6a5f\u95a2" ],
            Advisor: [ "Doktorvater", "\u30a2\u30c9\u30d0\u30a4\u30b6\u30fc" ]
        };
        for (var j in i) {
            if (j in h) {
                i[j].forEach(function(a) {
                    h[a] = h[j];
                });
            }
        }
        var k = $("<div>" + a + "</div>");
        var l = k.find("div.display_record_indexing_row");
        var m = {};
        for (d = 0; d < l.length; d++) {
            var n = f.normalizeStr($(l[d]).find("div.display_record_indexing_fieldname").text());
            c = $(l[d]).find("div.display_record_indexing_data");
            var o = f.normalizeStr(c.text());
            b = $(l[d]).find("div.display_record_indexing_data > a, div.display_record_indexing_data > span");
            var p = [];
            if (b.length) {
                for (e = 0; e < b.length; e++) {
                    var q = f.normalizeStr($(b[e]).text());
                    p.push(q);
                }
            }
            var r = h[n];
            if (r) {
                if (!(r in m)) m[r] = [];
                m[r].push({
                    str: o,
                    spans: p
                });
            }
        }
        if (m.pubtype) {
            for (e = 0; e < m.pubtype.length; e++) {
                c = m.pubtype[e].str;
                if (c.match(/(journal\s+article|Scholarly\s+Journals|Historical\s+Periodicals)/i)) {
                    g.pubtype = "PP_ARTICLE";
                } else if (c.match(/^article$/i)) {
                    g.pubtype = "PP_ARTICLE";
                } else if (c.match(/^review$/i)) {
                    g.pubtype = "PP_ARTICLE";
                    g.kind = "Review";
                } else if (c.match(/(chapter|book\s+article)/i)) {
                    g.pubtype = "PP_BOOK_CHAPTER";
                } else if (c.match(/book/i)) {
                    g.pubtype = "PP_BOOK";
                } else if (c.match(/(Thesis|Dissertation)/i)) {
                    g.pubtype = "PP_THESIS";
                } else if (c.match(/Magazine/i)) {
                    g.pubtype = "PP_NEWS_ARTICLE";
                    g.kind = "Magazine Article";
                } else if (c.match(/Newspapers/i)) {
                    g.pubtype = "PP_NEWS_ARTICLE";
                    g.kind = "Newspaper Article";
                } else if (c.match(/Conference\s+Paper/i)) {
                    g.pubtype = "PP_CONFERENCE_PAPER";
                }
            }
            delete m.pubtype;
        }
        for (var r in m) {
            m[r].forEach(function(a) {
                c = a.str;
                var d = a.spans;
                if (r == "url") {
                    c = c.replace(/\?accountid=.+/, "");
                    g.url.push(c);
                } else if (r == "issn") {
                    if (g["issn"]) r = "issn_alt";
                    g[r] = c;
                } else if (r == "isbn") {
                    var f = PP.Utils.extractISBNs(c, {
                        convert: true,
                        unique: true
                    });
                    if (f[0]) g.isbn = f[0];
                    if (f[1]) g.isbn_alt = f[1];
                } else if (r == "date") {
                    var h = PP.library.Date.parseDate(c);
                    if (h.month) g.month = h.month;
                    if (h.year) g.year = h.year;
                    if (h.day) g.day = h.day;
                } else if (r == "author" || r == "editor") {
                    if (!(r in g)) g[r] = [];
                    if (d.length === 0 && a.str) {
                        d = [ a.str ];
                    }
                    for (e = 0; e < d.length; e++) {
                        d[e] = d[e].replace(/,\s*$/, "");
                        b = PP.library.Author.parseAuthor(d[e], {
                            familyNameFirst: false
                        });
                        g[r].push(b);
                    }
                } else if (r == "details") {
                    if (g.pubtype == "PP_ARTICLE") {
                        g.journal = d[0];
                        if (d.length == 6) {
                            g.volume = d[1].replace(/[\(\)]/g, "");
                            g.pages = d[3].replace(/[\(\)]/g, "");
                            var h = PP.library.Date.parseDate(d[4]);
                            if (h.month) g.month = h.month;
                            if (h.year) g.year = h.year;
                        }
                    } else if (g.pubtype == "PP_BOOK") {
                        g.address = d[0] + " " + d[1];
                        g.publisher = d[2];
                    } else if (g.pubtype == "PP_BOOK_CHAPTER") {
                        for (e = 0; e < d.length; e++) {
                            if (d[e].match(/^\d\d\d\d$/)) {
                                g.booktitle = d[e - 4];
                                g.address = d[e - 3] + " " + d[e - 2];
                                g.publisher = d[e - 1];
                            }
                        }
                    }
                } else {
                    if (!g[r]) g[r] = c;
                }
            });
        }
        if (g.country) {
            if (!g.address) {
                g.address = "";
            } else {
                g.address += ", ";
            }
            g.address += g.country;
            delete g.country;
        }
        if (g.pages && g.pages.match(/^\d+$/) && g.num_pages && g.num_pages.match(/^\d+$/)) {
            var s = parseInt(g.pages) + parseInt(g.num_pages);
            g.pages = g.pages + "-" + s;
            delete g.num_pages;
        }
        g["abstract"] = f.normalizeStr(k.find("#abstractZone root").text());
        if (g["language"]) g["language"] = PP.Utils.normalizeLanguage(g["language"]);
        if (g.pubtype == "PP_CONFERENCE_PAPER" && g.journal) {
            g.booktitle = g.journal;
            delete g.journal;
        }
        return g;
    },
    normalizeStr: function(a) {
        var b = "";
        if (a) {
            b = a.replace(/^[\n\t\r\s]+/, "").replace(/[\n\t\r\s]+$/, "").replace(/[\t\r\n\s]+/g, " ");
        }
        return b;
    },
    getName: function() {
        return "ProQuest";
    }
});

PP.format.ProQuest = new PP.format._ProQuest();

PP.format._PubMedXML = PP.format.AbstractReader.extend({
    debug: false,
    doRead: function(a, b) {
        var c = this.parsePubMedXml(a, b);
        return c;
    },
    parsePubMedXml: function(a, b) {
        if (b === undefined) {
            b = {};
        }
        var c = [], d, e, f;
        if (a && a["documentElement"] && a["xmlVersion"]) {} else if (this.isXmlDoc(a)) {} else {
            a = this.convertStringToXml(a, b);
        }
        var g = [];
        var h = this.find(a, "PubmedArticle");
        for (var d = 0; d < h.length; d++) {
            g.push(h[d]);
        }
        var i = this.find(a, "PubmedBookArticle");
        for (var d = 0; d < i.length; d++) {
            g.push(i[d]);
        }
        if (this.isXmlDoc(a) && a.name && a.name.toLowerCase() == "pubmedarticle") {
            g.push(a);
        } else if (a.length > 0) {
            for (var d = 0; d < a.length; d++) {
                var j = a[d].tagName;
                if (j && j.toLowerCase() == "pubmedarticle") {
                    g.push($(a[d]));
                }
            }
        }
        for (d = 0; d < g.length; d++) {
            var k = g[d];
            var l = this.parsePubMedItem(k);
            if (!("refs" in b)) {
                delete l.refs;
            }
            if (l) {
                c.push(l);
            }
        }
        return c;
    },
    isXmlDoc: function(a) {
        if (a && a.name && a.attr && a.children) {
            return true;
        } else {
            return false;
        }
    },
    convertStringToXml: function(a, b) {
        if (PP.Globals.isDocAddOn() || b.useXmlDocument == true) {
            var c = new XmlDocument(a);
            return c;
        } else {
            return $(a);
        }
    },
    findSingle: function(a, b) {
        if (this.isXmlDoc(a)) {
            var c = this.find(a, b);
            if (c.length > 0) {
                return c[0];
            } else {
                return null;
            }
        } else {
            var c = $(a).find(b);
            if (c.length > 0) {
                return c.first();
            } else {
                return null;
            }
        }
    },
    find: function(a, b) {
        if (this.isXmlDoc(a)) {
            return this.findWithXmlDoc(a, b);
        } else {
            return $(a).find(b);
        }
    },
    findWithXmlDoc: function(a, b) {
        var c = b.split(" ");
        var d = this.findXmlChildren(a, c);
        return d;
    },
    findXmlChildren: function(a, b) {
        var c = [];
        var d = b.shift();
        var e, f, g;
        if (d.match(/(.*?)\[(.*?)=(.*?)\]/)) {
            e = RegExp.$1;
            f = RegExp.$2;
            g = RegExp.$3;
        } else {
            e = d;
        }
        var h = a.childrenNamed(e);
        if (f) {
            h = h.filter(function(a) {
                return a.attr[f] == g;
            });
        } else {}
        if (h.length == 0) {
            return [];
        } else if (b.length == 0) {
            return h;
        } else {
            var i = [];
            for (var j = 0; j < h.length; j++) {
                var k = h[j];
                var l = PP.Utils.clone(b);
                i = i.concat(this.findXmlChildren(k, l));
            }
            return i;
        }
    },
    text: function(a) {
        if (this.isXmlDoc(a)) {
            return a.val;
        } else {
            return $(a).text();
        }
    },
    attr: function(a, b) {
        if (this.isXmlDoc(a)) {
            return a.attr[b];
        } else {
            if ("attribs" in a) {
                return a.attribs[b.toLowerCase()];
            } else {
                return $(a).attr(b);
            }
        }
    },
    parsePubMedItem: function(a) {
        var b = this.findSingle(a, "MedlineCitation");
        if (!b) {
            b = this.findSingle(a, "BookDocument Book");
        }
        if (!b) {
            console.log("N entry found!");
            return null;
        }
        var c = {
            year: undefined
        };
        this.parseSimpleTextFields(c, b, a);
        this.parseDateFields(c, b, a);
        this.parseXrefs(c, b, a);
        this.parseAuthors(c, b, a);
        this.parseAbstract(c, b, a);
        this.parseKeywords(c, b, a);
        this.parseAffiliations(c, b, a);
        this.fixPubtypes(c, b, a);
        this.fixBooks(c, b, a);
        this.finalCleanup(c, b, a);
        return c;
    },
    parseSimpleTextFields: function(a, b, c) {
        var d = {
            title: "Article ArticleTitle",
            title2: "BookDocument ArticleTitle",
            original_title: "Article VernacularTitle",
            volume: "Article Journal JournalIssue Volume",
            issue: "Article Journal JournalIssue Issue",
            pages: "Article Pagination MedlinePgn",
            language: "Article Language",
            journal: "MedlineJournalInfo MedlineTA",
            journal2: "Article Journal ISOAbbreviation",
            journalfull: "Article Journal Title",
            issn: "Article Journal ISSN",
            issn2: "MedlineJournalInfo ISSNLinking",
            doi: "PubmedData ArticleIdList ArticleId[IdType=doi]",
            pii: "PubmedData ArticleIdList ArticleId[IdType=pii]",
            pmid: "PubmedData ArticleIdList ArticleId[IdType=pubmed]",
            doi2: "PubmedBookData ArticleIdList ArticleId[IdType=doi]",
            pii2: "PubmedBookData ArticleIdList ArticleId[IdType=pii]",
            pmid2: "PubmedBookData ArticleIdList ArticleId[IdType=pubmed]",
            pmid3: ">PMID",
            doi3: "Article ELocationID[EIdType=doi]",
            doi4: "Book ELocationID[EIdType=doi]",
            doi5: "BookDocument ArticleIdList ArticleId[IdType=doi]",
            pii3: "Article ELocationID[EIdType=pii]",
            pii4: "Book ELocationID[EIdType=pii]",
            pii5: "BookDocument ArticleIdList ArticleId[IdType=pii]",
            booktitle: "BookTitle",
            publisher: "Publisher PublisherName",
            address: "Publisher PublisherLocation",
            isbn: "Isbn",
            pmc: "PubmedData ArticleIdList ArticleId[IdType=pmc]"
        };
        for (var e in d) {
            var f = d[e];
            e = e.replace(/\d/g, "");
            if (a[e] === undefined) {
                var g = this.findSingle(b, f);
                if (g && this.attr(g, "ValidYN") !== "N") {
                    var h = this.text(g);
                    if (h !== "") {
                        a[e] = h;
                    }
                } else {
                    var g = this.findSingle(c, f);
                    if (g && this.attr(g, "ValidYN") !== "N") {
                        var h = this.text(g);
                        if (h !== "") {
                            a[e] = h;
                        }
                    }
                }
            } else {
                if (e.match(/issn/)) {
                    var g = this.findSingle(b, f);
                    if (g && this.attr(g, "ValidYN") !== "N") {
                        var h = this.text(g);
                        if (h !== "" && h !== a[e]) {
                            a["issn_alt"] = h;
                        }
                    }
                }
            }
        }
        if (!("pmc" in a)) {
            var i = this.find(b, "OtherID");
            for (var j = 0; j < i.length; j++) {
                var k = this.text(i[j]);
                if (k.match(/^PMC/)) {
                    a["pmc"] = k.replace(/(PMC\d+)(\s.*)/, "$1");
                }
            }
        }
        if (a["language"]) {
            a["language"] = PP.Utils.normalizeLanguage(a["language"]);
        }
    },
    parseDateFields: function(a, b, c) {
        this.extractDate(b, "Article Journal JournalIssue PubDate MedlineDate", a);
        this.extractDate(b, "Article Journal JournalIssue PubDate", a);
        this.extractDate(b, "Article ArticleDate", a);
        this.extractDate(b, "ContributionDate", a);
        this.extractDate(b, "PubMedPubDate[PubStatus=accepted]", a);
        this.extractDate(b, "PubMedPubDate[PubStatus=pubmed]", a);
        this.extractDate(c, "BookDocument ContributionDate", a);
        this.extractDate(c, "PubmedBookData History PubMedPubDate[PubStatus=pubmed]", a);
    },
    extractDate: function(a, b, c) {
        if (c["year"] === undefined) {
            var d = this.findSingle(a, b);
            if (d) {
                var e = this.findSingle(d, "Year");
                var f = this.findSingle(d, "Month");
                var g = this.findSingle(d, "Day");
                var h = this.findSingle(d, "Season");
                if (e) {
                    c["year"] = this.text(e);
                    if (f) {
                        c["month"] = this.text(f);
                    }
                    if (g) {
                        c["day"] = this.text(g);
                    }
                    if (h && !f && !g) {
                        c["season"] = this.text(h);
                    }
                } else {
                    var i = this.text(d);
                    var j = PP.library.Date.parseDate(i);
                    if (j.year !== null) {
                        c["year"] = j.year;
                    }
                    if (j.month !== null) {
                        c["month"] = j.month;
                    }
                    if (j.day !== null) {
                        c["day"] = j.day;
                    }
                }
            }
        } else {
            if (b.match(/ArticleDate/) && c["month"] === undefined) {
                var d = this.findSingle(a, b);
                if (d) {
                    var e = this.findSingle(d, "Year");
                    var f = this.findSingle(d, "Month");
                    var g = this.findSingle(d, "Day");
                    if (e && f && this.text(e) === c["year"]) {
                        c["month"] = this.text(f);
                        if (g) {
                            c["day"] = this.text(g);
                        }
                    }
                }
            }
        }
    },
    parseXrefs: function(a, b, c) {
        var d = this.find(c, "MedlineCitation CommentsCorrectionsList CommentsCorrections");
        for (var e = 0; e < d.length; e++) {
            var f = d[e];
            var g = this.findSingle(f, "PMID");
            if (g) {
                var h = this.attr(f, "RefType");
                if (h === "Cites") {
                    if (!("refs" in a)) a.refs = [];
                    a.refs.push({
                        pmid: this.text(g)
                    });
                    continue;
                }
                var i = {
                    type: h,
                    pmid: this.text(g)
                };
                PP.library.Publication.addXref(a, i);
            }
        }
    },
    parseAuthors: function(a, b, c) {
        var d = this.findAuthors(b, "Article AuthorList Author");
        var e = this.findAuthors(b, "Article AuthorList[Type=authors] Author");
        if (e.length == 0) {
            e = this.findAuthors(c, "BookDocument AuthorList[Type=authors] Author");
            if (e.length == 0) {
                e = this.findAuthors(c, "BookDocument Book AuthorList[Type=authors] Author");
            }
        }
        var f = this.findAuthors(b, "AuthorList[Type=editors] Author");
        if (f.length == 0) {
            f = this.findAuthors(c, "BookDocument AuthorList[Type=editors] Author");
            if (f.length == 0) {
                f = this.findAuthors(c, "BookDocument Book AuthorList[Type=editors] Author");
            }
        }
        if (e.length > 0 && f.length > 0) {
            a.author = e;
        } else if (e.length > 0 && d.length == 0) {
            a.author = e;
        } else if (d.length > 0) {
            a.author = d;
        }
        if (f.length > 0) {
            a.editor = f;
        }
    },
    findAuthors: function(a, b) {
        var c = this.find(a, b);
        var d = [];
        for (var e = 0; e < c.length; e++) {
            var f = c[e];
            var g = {};
            var h = this.findSingle(f, "ForeName");
            var i = this.findSingle(f, "LastName");
            var j = this.findSingle(f, "Initials");
            var k = this.findSingle(f, "CollectiveName");
            var l = this.findSingle(f, "Suffix");
            var m = this.findSingle(f, "Identifier");
            if (h) {
                g.first = this.text(h);
            }
            if (i) {
                g.last = this.text(i);
            }
            if (j) {
                g.initials = this.text(j);
            }
            if (k) {
                g.collective = this.text(k);
            }
            if (l) {
                g.jr = this.text(l);
            }
            if (m && (isBrowserEnvironment() && m.attr || !isBrowserEnvironment() && "attribs" in m)) {
                m = [ m ];
            }
            if (m && m.length > 0) {
                for (var n = 0; n < m.length; n++) {
                    if (this.attr(m[n], "Source") == "ORCID" && !g.orcid) {
                        g.orcid = this.text(m[n]).replace(/https?:\/\/orcid\.org\//i, "");
                    }
                }
            }
            PP.library.Author.autoClean(g);
            d.push(g);
        }
        return d;
    },
    parseAffiliations: function(a, b, c) {
        var d = [];
        var e = this.find(b, "Article AuthorList Author Affiliation");
        for (var f = 0; f < e.length; f++) {
            var g = PP.Utils.normalizeString(this.text(e[f]));
            if (d.indexOf(g) === -1) {
                d.push(g);
            }
        }
        a["affiliation"] = d.join(" ");
    },
    parseKeywords: function(a, b, c) {
        var d = [];
        var e = this.find(b, "KeywordList Keyword");
        for (var f = 0; f < e.length; f++) {
            d.push(this.text(e[f]));
        }
        a["keywords"] = d.join("; ");
    },
    parseAbstract: function(a, b, c) {
        var d = [], e, f;
        var g = this.find(b, "Article Abstract AbstractText");
        if (g.length == 0) {
            g = this.find(c, "BookDocument Abstract AbstractText");
        }
        for (var h = 0; h < g.length; h++) {
            var i = g[h];
            e = this.attr(i, "Label");
            if (e !== undefined && e !== null && e !== "") {
                d.push(e + ":");
            }
            f = this.text(i);
            d.push(f);
        }
        a["abstract"] = d.join(" ");
    },
    fixPubtypes: function(a, b, c) {
        var d = {};
        var e = this.find(b, "Article PublicationTypeList PublicationType");
        for (var f = 0; f < e.length; f++) {
            var g = e[f];
            var h = this.text(g).toLowerCase();
            if (h.match(/Journal Article/i)) {} else if (h.match(/^Review/i)) {
                d["Review"] = true;
            } else if (h.match(/^News/i)) {
                d["News"] = true;
            } else if (h.match(/Erratum/i)) {
                d["Erratum"] = true;
            } else if (h.match(/Comment/i)) {
                d["Commentary"] = true;
            } else if (h.match(/Retracted/i)) {
                d["Retracted"] = true;
            } else if (h.match(/Retraction/i)) {}
        }
        a.kind = "Research Article";
        if (d["Retracted"]) {} else if (d["Review"]) {
            a.kind = "Review";
        } else if (d["Commentary"]) {
            a.kind = "Commentary";
        } else if (d["News"]) {
            a.kind = "News";
        }
        a.pubtype = "PP_ARTICLE";
    },
    fixBooks: function(a, b, c) {
        var d = this.findSingle(c, "BookDocument ArticleTitle");
        if (d) {
            a.pubtype = "PP_BOOK_CHAPTER";
            delete a.kind;
            var e = this.findSingle(c, "PubmedBookData ArticleIdList ArticleId[IdType=bookaccession]");
            if (e) {
                var f = this.text(e);
                a.url = "https://www.ncbi.nlm.nih.gov/books/" + f + "/";
            }
        }
        if (a.booktitle && !a.title) {
            a.pubtype = "PP_BOOK";
            a.title = a.booktitle;
            delete a.kind;
            delete a.booktitle;
            var e = this.findSingle(b, "PubmedData ArticleIdList ArticleId[IdType=bookaccession]");
            if (e) {
                var f = this.text(e);
                a.url = "https://www.ncbi.nlm.nih.gov/books/" + f + "/";
            }
        }
    },
    finalCleanup: function(a, b, c) {
        a["abstract"] = a["abstract"].replace(/(\n|\t)/g, " ");
        a["abstract"] = a["abstract"].replace(/\s+/g, " ");
        if (a.title !== undefined) {
            a.title = a.title.replace(/\s*\.$/, "");
        }
        if (a.booktitle !== undefined) {
            a.booktitle = a.booktitle.replace(/\s*\.$/, "");
        }
    }
});

PP.format.PubMedXML = new PP.format._PubMedXML();

PP.format._References = PP.format.AbstractReader.extend({
    debug: true,
    buildReferenceExtractor: function(a, b, c) {
        var d = this;
        var e = b.split(/\s+/);
        var f = 1;
        var g = {};
        var h = [];
        if (c === undefined) {
            c = {
                authorParseParams: {
                    familyNameFirst: true,
                    commasWithinNames: false
                }
            };
        }
        e.forEach(function(a) {
            var b = a.replace(/_/g, "");
            if (d.patterns[b]) {
                var c = d.patterns[b];
                var e = false;
                if (c.match(/\(/)) {
                    e = true;
                }
                if (e) {
                    g[b] = f++;
                }
                h.push(c);
            } else {
                h.push(b);
            }
        });
        var i = new RegExp(h.join("\\s?"), "g");
        var j = {
            name: a,
            captureMap: g,
            regexp: i,
            params: c,
            getCount: function(a) {
                var b = 0, c = null;
                while ((c = this.regexp.exec(a)) !== null) {
                    b++;
                }
                return b;
            },
            getRefs: function(a, b) {
                var c = [], d = null;
                while ((d = this.regexp.exec(a)) !== null) {
                    var e = this.getData(d, b);
                    c.push(e);
                }
                return c;
            },
            getData: function(a, b) {
                var c = {};
                c._origText = a[0];
                c._extractor = this.name;
                var d = PP.Utils.apply(this.params.authorParseParams, b.authorParseParams);
                for (var e in this.captureMap) {
                    if (!e.match(/^(NO|VOL)$/)) {
                        var f = this.captureMap[e];
                        var g = a[f];
                        g = PP.Utils.strip(g);
                        var h = e;
                        switch (e) {
                          case "authors":
                            h = "author";
                            if (g.indexOf("NCBI Google Scholar") >= 0) {
                                g = g.substring(g.indexOf("NCBI Google Scholar") + 19);
                            }
                            g = g.replace(/^\s*\d+\.\s*/g, "");
                            g = PP.library.Author.parseAuthorList(g, d);
                            break;

                          case "yearParens":
                            h = "year";
                            break;

                          case "issueParens":
                            h = "issue";
                            break;

                          case "pagesSingle":
                            h = "pages";
                            break;

                          default:
                            break;
                        }
                        c[h] = g;
                    }
                }
                c.pubtype = "PP_ARTICLE";
                return c;
            }
        };
        return j;
    },
    patterns: {
        any: "(.*)",
        year: "(\\d{4}[a-z]?)",
        yearParens: "\\((\\s?\\d{4}[a-z]?\\s?)\\)",
        colon: ":",
        semicolon: ";",
        period: "\\.",
        seperator: "[\\.;,:\\|]",
        stop: "[\\.\\?\\!:]",
        journal: "([^\\d\\|]+)",
        volume: "(\\d+)",
        VOL: "([Vv]olume|VOLUME|VOL|[Vv]ol)\\.?",
        NO: "([Ii]ssue|ISSUE|[Nn]umber|NUMBER|NO|[Nn]o)\\.?",
        month: "(Jan|January|Feb|February|Mar|March|Apr|April|May|June?|July?|Aug|August|Sep|September|Oct|October|Nov|Novemer|Dec|December)\\.?",
        PP: "p{1,2}\\.?",
        issue: "(\\d+)",
        issueParens: "\\((\\d+)\\)",
        pages: "(\\d+[^\\/,]{1,3}\\d+|e\\d+)",
        pagesSingle: "([RrEe]\\d+|\\d+)",
        title: "([^\\.]*?)",
        authors: "([\\w\xc4-\xff,\\.\\; \\n-]+?)"
    },
    addExtractor: function(a, b, c) {
        this.extractors.push(this.buildReferenceExtractor(a, b, c));
    },
    getExtractors: function() {
        if (this._extractors) {
            return this._extractors;
        }
        this.extractors = [];
        this.addExtractor("PLOS", "_authors_ _yearParens_ _title_ _stop_ _journal_ _volume_ _stop_ _pages_ _stop_");
        this.addExtractor("BMC", "_authors_ _colon_ _title_ _period_ _journal_ _year_ , _volume_ _issueParens_ _colon_ _pages_ _stop_", {
            authorParseParams: {
                familyNameFirst: true
            }
        });
        this.addExtractor("BMC2", "_authors_ _colon_ _title_ _period_ _journal_ _year_ , _volume_ _colon_ _pages_ _stop_", {
            authorParseParams: {
                familyNameFirst: true
            }
        });
        this.addExtractor("Highwire", "_authors_ _yearParens_ _title_ _period_ _journal_ _volume_ _colon_ _pages_ _stop_", {
            authorParseParams: {
                familyNameFirst: true,
                commasWithinNames: false
            }
        });
        this.addExtractor("HighwireWithCommas", "_authors_ _yearParens_ _title_ _period_ _journal_ _volume_ _colon_ _pages_ _stop_", {
            authorParseParams: {
                familyNameFirst: true,
                commasWithinNames: true
            }
        });
        this.addExtractor("MBE", "_authors_ _year_ _period_ _title_ _period_ _journal_ _volume_ _colon_ _pages_ _stop_", {
            authorParseParams: {
                familyNameFirst: true,
                commasWithinNames: true
            }
        });
        this.addExtractor("NAR", "_authors_ _period_ _title_ _period_ _journal_ _year_ _semicolon_ _volume_ _colon_ _pages_ _stop_", {
            authorParseParams: {
                familyNameFirst: true,
                commasWithinNames: false
            }
        });
        return this.extractors;
    },
    doRead: function(a, b) {
        var c = this.getExtractors();
        var d = this.readPubsFromText(a, c, b);
        return d;
    },
    getDefaultParams: function() {
        return {
            removeNewlines: true,
            collapseWhitespace: true,
            extractor: undefined
        };
    },
    readPubsFromText: function(a, b, c) {
        if (!PP.Utils.isArray(a) && PP.Utils.isString(a)) {
            a = [ a ];
        }
        var d = this.getDefaultParams();
        c = PP.Utils.apply(d, c);
        for (var e = 0; e < a.length; e++) {
            var f = a[e];
            if (c.removeNewlines === true) {
                f = f.replace(/\n/g, "");
            }
            if (c.collapseWhitespace === true) {
                f = f.replace(/\s+/g, " ");
            }
            a[e] = f;
        }
        if (c.extractors !== undefined) {
            var g = PP.Array.mapBoolean(c.extractors);
            b = PP.Array.filter(b, function(a) {
                return g[a.name] === true;
            });
        }
        for (var e = 0; e < b.length; e++) {
            var h = b[e];
            this.c.log("applying extractor", h.name, "to", a.length, "strings");
            var i = [];
            for (var j = 0; j < a.length; j++) {
                i = i.concat(h.getRefs(a[j], c));
            }
            this.c.log("  got ", i.length, "refs");
            if (!this.refsLookGood(i)) {
                continue;
            }
            return i;
        }
        return [];
    },
    refsLookGood: function(a) {
        if (a.length == 0) {
            return false;
        }
        if (a.length > 300) {
            return false;
        }
        var b = 0;
        var c = 0;
        var d = 0;
        a.forEach(function(a) {
            if (!a.title) {
                b++;
            }
            if (!a.author || a.author.length < 1) {
                c++;
            }
            var e = a.author;
            for (var f = 0; f < e.length; f++) {
                var g = e[f];
                var h = g.first != undefined;
                var i = g.last != undefined;
                if (!h || !i) {
                    d++;
                }
            }
        });
        var e = a.length / 2;
        if (b > e || c > e) {
            console.log("  refs look bad due to missing title and/or authors");
            console.log(PP.pp(a));
            return false;
        }
        if (d > e) {
            console.log("  refs look bad due to single-word authors");
            console.log(PP.pp(a));
            return false;
        }
        return true;
    }
});

PP.format.References = new PP.format._References();

PP.format._Ris = PP.format.AbstractReader.extend({
    mapOut: {},
    hierarchy: [ "T1", "TI", "ST", "CT", "BT", "T3", "A1", "AU", "A3", "A2", "A4", "ED", "ET", "SE", "IS", "CP", "SP", "EP", "PG", "AD", "CY", "VL", "AB", "N2", "PB", "KW", "PY", "Y1", "DA", "DO", "DOI", "ID", "SN", "JF", "JO", "JA", "UR", "L1", "L2", "L4", "RN", "NV", "OP", "N1", "N2", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "M1", "M2", "M3", "L3", "U2", "IB", "RT" ],
    getName: function() {
        return "RIS";
    },
    doRead: function(a) {
        var b = this._readRis(a);
        return b;
    },
    _extractRis: function(a) {
        var b = "";
        var c = a.split(/\n/);
        var d = false;
        for (var e = 0; e < c.length; e++) {
            if (c[e].match(/^TY\s\s-\s/)) d = true;
            if (d) {
                if (c[e].match(/^\s*<\/body>/)) d = false;
                var f = c[e].replace(/\s*(<p>|<br>|<\/a>)+\s*$/i, "");
                f = f.replace(/<A HREF="([^"]+)">/, "");
                b += f + "\n";
            }
        }
        return b;
    },
    _readRis: function(a) {
        if (a.match(/^\s*<!doctype html/)) {
            a = this._extractRis(a);
        }
        var b = a.split(/[\r\n]+/);
        var c = [];
        var d = [];
        var e = "";
        for (var f = 0; f < b.length; f++) {
            b[f] = b[f].replace(/\t/g, " ");
            if (b[f].match(/^\s+..\s\s-\s/)) {
                b[f] = b[f].replace(/^\s+/, "");
            }
            b[f] = b[f].replace(/\s+$/, "");
            if (b[f].match(/^ER\s+-\s*/)) {
                c.push(e);
                d.push(c);
                c = [];
                e = "";
            } else if (b[f].match(/^([A-Z\d]{2}|DOI)\s+-\s*/)) {
                if (e == "") {
                    e = b[f];
                } else {
                    c.push(e);
                    e = b[f];
                }
            } else if (b[f].match(/\S/)) {
                e = e.replace(/\s+$/, "");
                b[f] = b[f].replace(/^\s+/, "");
                e += " " + b[f];
            }
        }
        if (e != "") {
            c.push(e);
            d.push(c);
        }
        var g = [];
        for (var f = 0; f < d.length; f++) {
            if (f % 10 === 0) {
                this.fire("progress", {
                    progress: f / d.length,
                    totalCount: d.length
                });
            }
            try {
                var h = d[f];
                var i = this.handleEntry(h);
                if (i) g.push(i);
            } catch (a) {
                if (PP.Utils.isFunction(PP.log)) {
                    PP.log({
                        type: "exception",
                        subtype: "Parsing",
                        msg: "Caught error when parsing RIS: " + a.message
                    });
                }
            }
        }
        return g;
    },
    handleEntry: function(a) {
        var b = {};
        var c, d, e, f, g, h;
        for (d = 0; d < a.length; d++) {
            a[d] = a[d].replace(/\u2028/g, " ");
            g = undefined;
            f = undefined;
            e = a[d].match(/^([A-Z\d]{2}|DOI)\s+\-\s(.+)/);
            if (e && e.length === 3) {
                f = e[1];
                g = e[2];
            }
            if (g === undefined) continue;
            g = g.replace(/^\s+/, "");
            if (g == "") continue;
            if (f === undefined) continue;
            if (!b[f]) b[f] = [];
            b[f].push(g);
        }
        var i = Object.keys(b);
        if (i.length <= 1) {
            return undefined;
        }
        if (b["PY"] && b["Y2"]) {
            if (b["PY"][0] && b["Y2"][0]) {
                if (b["PY"][0].match(/^\d{4}$/) && b["Y2"][0].match(/^[A-Z\.]+$/i)) {
                    b["PY"][0] = b["Y2"][0] + " " + b["PY"][0];
                    delete b["Y2"];
                }
            }
        }
        if (b["A1"] && b["AU"]) {
            if (b["A1"][0] && b["AU"][0]) {
                if (b["A1"][0] === b["AU"][0]) {
                    delete b["A1"];
                }
            }
        }
        if (b["T2"] && b["JO"]) {
            if (b["T2"][0] && b["JO"][0]) {
                if (b["T2"][0] === b["JO"][0]) {
                    delete b["T2"];
                }
            }
        }
        if (b["T2"] && b["JF"]) {
            if (b["T2"][0] && b["JF"][0]) {
                if (b["T2"][0] === b["JF"][0]) {
                    delete b["T2"];
                }
            }
        }
        if (b["T2"] && b["JA"]) {
            if (b["T2"][0] && b["JA"][0]) {
                if (b["T2"][0] === b["JA"][0]) {
                    delete b["T2"];
                }
            }
        }
        if (b["EP"]) {
            if (b["SP"] && b["SP"][0] && b["EP"][0]) {
                b["SP"][0] += "-" + b["EP"][0];
            }
            delete b["EP"];
        }
        var j = {
            pubtype: "PP_MISC"
        };
        var k = {
            T1: false
        };
        if (b["RT"] && !b["TY"]) {
            if (b["RT"][0] === "Journal Article") {
                b["TY"] = [ "JOUR" ];
            } else if (b["RT"][0] === "Book") {
                b["TY"] = [ "BOOK" ];
            }
        }
        if (!("TY" in b)) {
            b["TY"] = [ "JOUR" ];
        }
        if (b["TY"] && b["TY"].length > 0) {
            b["TY"][0] = b["TY"][0].toUpperCase();
            if (b["TY"][0] == "CONF") {
                if (b["BT"] && !b["T2"]) {
                    b["TY"][0] = "CPAPER";
                    b["T2"] = b["BT"];
                    delete b["BT"];
                }
            }
            if (b["TY"][0] == "ELEC") {
                if (b["SN"] && b["SN"].length) {
                    if (b["SN"][0].match(/^\s*\d{4}-[\dX]{4}/)) {
                        b["TY"][0] = "JOUR";
                    } else {
                        var l = PP.Utils.extractISBNs(b["SN"][0]);
                        if (l.length > 0) b["TY"][0] = "BOOK";
                    }
                }
            }
            var m = PP.library.PublicationTypes.getInputTypeForPub(b["TY"], "ris");
            j["pubtype"] = m.pubtype;
            if (m.kind) j["kind"] = m.kind;
        }
        var n = PP.library.PublicationFields.getInputMapForPubType(j.pubtype, "ris");
        if (b["TY"] && b["TY"] == "CONF") {
            n["T2"] = "conference";
            n["T3"] = "series";
            n["A2"] = "editor";
            n["A3"] = "series_editor";
            n["DA"] = "conference_date";
        }
        var o = {};
        for (var p = 0; p < this.hierarchy.length; p++) {
            var q = this.hierarchy[p];
            if (b[q] === undefined) continue;
            h = n[q];
            if (h === undefined) {
                o[q] = b[q];
                continue;
            }
            if (b[q]) {
                if (q == "T1") k["T1"] = true;
                for (var r = 0; r < b[q].length; r++) {
                    c = b[q][r];
                    if (h === "author" || h === "editor" || h === "series_editor" || h === "translator") {
                        if (!(h in j)) {
                            j[h] = [];
                        }
                        c = c.replace(/,\s*$/, "");
                        c = c.replace(/,,/g, ",");
                        var s = c.split(/,\s*/);
                        if (s.length > 2) {
                            if (s[2] && s[2].match(/Sen|Jr|V|IV|III|3rd|II|2nd/)) {
                                j[h].push({
                                    last: s[0],
                                    first: s[1],
                                    jr: s[2]
                                });
                            } else {
                                if (c.match(/\|/)) {
                                    s = c.split(/\|/);
                                    for (var t = 0; t < s.length; t++) {
                                        var u = {};
                                        u = PP.library.Author.parseAuthor(s[t], {
                                            familyNameFirst: false
                                        });
                                        j[h].push(u);
                                    }
                                } else {
                                    var v = PP.library.Author.parseAuthorList(c, {
                                        delimiter: ",",
                                        familyNameFirst: false
                                    });
                                    j[h] = j[h].concat(v);
                                }
                            }
                        } else if (s.length == 2) {
                            var u = {};
                            u = PP.library.Author.parseAuthor(c, {
                                familyNameFirst: false
                            });
                            j[h].push(u);
                        } else {
                            j[h].push({
                                collective: c
                            });
                        }
                    } else if (h == "keywords") {
                        if (!j["keywords"]) j["keywords"] = [];
                        j["keywords"].push(c);
                    } else if (h == "published" || h == "filed" || h == "conference_date" || h == "accessed") {
                        var w = this.scorePubDate(j, h);
                        var x = PP.library.Date.parseDate(c);
                        var y = 0;
                        if (x.year) y += 3;
                        if (x.month) y += 2;
                        if (x.day) y += 1;
                        w = this.scorePubDate(j, h);
                        if (y > w) {
                            if (!(h in j)) j[h] = {};
                            if (x.year) j[h]["year"] = x.year;
                            if (x.month) j[h]["month"] = x.month;
                            if (x.day) j[h]["day"] = x.day;
                            if (x.literal) j[h]["literal"] = x.literal;
                        }
                    } else if (h == "doi") {
                        if (c.match(/^https?:\/\/(dx\.|)doi\.org/) || c.match(/^\d\d\.\d\d\d\d\/\S+/)) {
                            j[h] = c;
                        } else if (c.match(/^doi:?\s*(.+)/i)) {
                            var z = c.replace(/^doi:?\s*/i, "");
                            j[h] = c;
                        }
                    } else if (h == "pmid") {
                        if (c.match(/PMID:\s*(\d+)/i)) {
                            j[h] = RegExp.$1;
                        }
                    } else if (h == "genre") {
                        j[h] = c;
                        if (c.match(/(PHD|doctor)/i)) {
                            j["kind"] = "Ph.D. Thesis";
                        } else if (c.match(/(master|MSc)/i)) {
                            j["kind"] = "Masters Thesis";
                        } else if (c.match(/(Bachelor|BSc)/i)) {
                            j["kind"] = "Bachelor's Thesis";
                        }
                    } else if (h == "note") {
                        if (!j["note"]) j["note"] = [];
                        j[h].push(c);
                    } else if (h == "address") {
                        if (j.pubtype === "PP_BOOK" && j.kind && j.kind == "Proceedings") {
                            j["conference_location"] = c;
                        } else {
                            j[h] = c;
                        }
                    } else if (h == "issn") {
                        if (c.match(/\d\d\d\d\-?\d\d\d[\dX]/)) {
                            var A = c.split(/[\s;\(\)]+/);
                            var B = {};
                            for (var C = 0; C < A.length; C++) {
                                var D = PP.library.Publication.checkValidityOfISSN(A[C]);
                                if (D != "") {
                                    B[D] = 1;
                                }
                            }
                            var u = [];
                            for (var C in B) {
                                if (B[C]) u.push(C);
                            }
                            j["issn"] = u.join(";");
                            if (j["issn"] !== "") flagSN = 1;
                        }
                    } else if (h == "isbn") {
                        var E = PP.Utils.extractISBNs(c, {
                            convert: true,
                            unique: true
                        });
                        var F;
                        while (F = E.shift()) {
                            if (!j.isbn) {
                                j.isbn = F;
                            } else {
                                if (!j.isbn_alt) j.isbn_alt = F;
                            }
                        }
                    } else if (h == "url") {
                        if (!j["url"]) {
                            j["url"] = [];
                        }
                        if (c.match(/file:\/\//i) || c.match(/\.pdf/i) && !c.match(/http:\/\//i)) {
                            if (c.match(/%/)) {
                                try {
                                    c = decodeURIComponent(c);
                                } catch (a) {
                                    try {
                                        c = decodeURI(c);
                                    } catch (a) {
                                        if (PP.Utils.isFunction(PP.log)) {
                                            PP.log({
                                                type: "error",
                                                subtype: "Error decoding URI component in RIS import",
                                                msg: "An RIS entry contained a URL with encoded chars, but could not be decoded",
                                                fieldValue: c
                                            });
                                        }
                                    }
                                }
                            }
                            j.external_pdf_filename = c;
                        } else if (c.match(/&amp;/)) {
                            j.url.push(c);
                        } else {
                            if (c.match(/\;/)) {
                                var G = c.split(/\;/);
                                var H = true;
                                for (var I = 0; I < G.length; I++) {
                                    if (!PP.Utils.isUrlLike(G[I])) {
                                        H = false;
                                    }
                                }
                                if (H) {
                                    j["url"] = j["url"].concat(G);
                                } else {
                                    j["url"].push(c);
                                }
                            } else {
                                c = c.replace(/(.*)((?:https?|ftp):\/\/\S+)/, "$2");
                                c = c.replace(/^\s+/, "");
                                c = c.replace(/(\S+)([\t\r\n\s].*)/, "$1");
                                if (c && c.match(/^(http|ftp)/)) {
                                    j["url"].push(c);
                                } else if (c.match(/www\.\w+\.\w+/) || c.match(/^\w+\.\w+/)) {
                                    j["url"].push("http://" + c);
                                }
                            }
                        }
                    } else {
                        if (!j[h]) {
                            j[h] = c;
                        }
                    }
                }
            }
        }
        if (j["keywords"]) {
            j["keywords"] = j["keywords"].join("; ");
        }
        if (j["note"]) {
            j["note"] = j["note"].join("\n");
        }
        if (j.pubtype === "PP_BOOK" && j.kind) {
            if (j.kind === "Proceedings" && j.title && k["T1"]) {
                j.pubtype = "PP_CONFERENCE_PAPER";
                if (j["num_pages"]) {
                    j["pages"] = j["num_pages"];
                    delete j["num_pages"];
                }
            }
        }
        if (j.pubtype === "PP_BOOK" && !j.title) {
            if (o.BT && o.BT[0]) j.title = o.BT[0];
        }
        for (var q in b) {
            if (b[q] === undefined) continue;
            for (var r = 0; r < b[q].length; r++) {
                var c = b[q][r];
                if (q == "T2") {
                    var h = n[q];
                    if (h) {
                        if (j["pubtype"] === "PP_BOOK" && !j["title"]) {
                            j["title"] = c;
                        } else if (j["pubtype"] === "PP_CONFERENCE_PAPER" && !j["booktitle"]) {
                            j["booktitle"] = c;
                        } else if (j["pubtype"] === "PP_PATENT" && !j["journal"]) {
                            j["journal"] = c;
                        } else if (!j[h]) {
                            j[h] = c;
                        }
                    }
                } else if (q == "N1" || q == "N2") {
                    if (c.match(/^http:\/\/dx\.doi\.org/) || c.match(/^\d\d\.\d\d\d\d\/\S+/)) {
                        if (!j["doi"]) j["doi"] = c;
                    } else {
                        if (c.split(/\s+/).length > 7) {
                            if (!j["abstract"]) j["abstract"] = c;
                        }
                    }
                }
            }
        }
        if (j.title && j.title.indexOf("}$") != -1) {
            j.title = PP.Utils.convertInlineLatexToHtml(j.title);
        }
        return j;
    },
    doWrite: function(a, b) {
        if (!PP.Utils.isArray(a)) {
            a = [ a ];
        }
        var c = "";
        var d = [ "AU", "A2", "A3", "A4", "AD", "TI", "T2", "T3", "J2", "ET", "VL", "IS", "SP", "PY", "DA", "Y2", "PB", "CY", "AB", "DP", "SN", "DO", "M1", "M2", "M3", "C1", "C2", "C3", "C4", "C5", "C6", "C7", "C8", "UR", "KW", "N1", "L1", "LB" ];
        for (var e = 0; e < a.length; e++) {
            var f = a[e];
            if (f.labelsNamed || f.foldersNamed) {
                if (f.keywords === undefined || f.keywords === null) {
                    f.keywords = "";
                }
                if (f.labelsNamed && PP.Utils.isArray(f.labelsNamed)) {
                    f.keywords += ";" + f.labelsNamed.join(";");
                }
                if (f.foldersNamed && PP.Utils.isArray(f.foldersNamed)) {
                    f.keywords += ";" + f.foldersNamed.join(";");
                }
                f.keywords = f.keywords.replace(/^\s*;\s*/, "");
                if (f.keywords === "") {
                    delete f.keywords;
                }
            }
            var g = PP.library.PublicationTypes.getOutputTypeForPub(f, "ris");
            var h = PP.library.PublicationFields.getOutputMapForPubType(f.pubtype, "ris");
            if (!g) g = "MISC";
            c += "TY  - " + g + "\n";
            for (var i = 0; i < d.length; i++) {
                var j = d[i];
                if (j === "PY") {
                    if (f.published && f.published.year) {
                        c += j + "  - " + f.published.year + "\n";
                    }
                } else if (j === "TI" || j === "T2") {
                    if (f[h[j]]) {
                        var k = PP.String.interconvertString(f[h[j]], {
                            format: "nomarkup"
                        });
                        k = this._wrapText(k, 74);
                        for (var l = 0; l < k.length; l++) {
                            var m = l == 0 ? j + "  - " : "      ";
                            c += m + k[l] + "\n";
                        }
                    }
                } else if (j === "DA") {
                    if (f.published && f.published.year) {
                        c += j + "  - " + f.published.year;
                        if (f.published.month) {
                            c += "/" + f.published.month;
                            if (f.published.day) {
                                c += "/" + f.published.day;
                            }
                        }
                        c += "\n";
                    }
                } else if (j === "Y2" || j === "M1" && h[j] == "accessed") {
                    if (f.accessed && f.accessed.year) {
                        c += j + "  - " + f.accessed.year;
                        if (f.accessed.month) {
                            c += "/" + f.accessed.month;
                            if (f.accessed.day) {
                                c += "/" + f.accessed.day;
                            }
                        }
                        c += "\n";
                    }
                } else if (j === "C2" && h["C2"] === "filed") {
                    if (f.filed && f.filed.year) {
                        c += j + "  - " + f.filed.year;
                        if (f.filed.month) {
                            c += "/" + f.filed.month;
                            if (f.filed.day) {
                                c += "/" + f.filed.day;
                            }
                        }
                        c += "\n";
                    }
                } else if (j === "UR") {
                    if (f.url) {
                        for (var l = 0; l < f.url.length; l++) {
                            c += j + "  - " + f.url[l] + "\n";
                        }
                    }
                } else if (j === "L1") {
                    if (f["attachments"]) {
                        for (var l = 0; l < f["attachments"].length; l++) {
                            var n = f["attachments"][l].subfolders[0] ? f["attachments"][l].subfolders[0] : "";
                            var o = n + "/" + f["attachments"][l].filename;
                            if (f["attachments"][l].article_pdf) {
                                c += j + "  - " + o + "\n";
                            } else {
                                c += "L4" + "  - " + o + "\n";
                            }
                        }
                    }
                } else {
                    if (f[h[j]]) {
                        if (j === "AU" || j === "A2" || j === "A4" || j === "A3") {
                            if (j === "A2" && g === "PAT") {
                                c += j + "  - " + f[h[j]] + "\n";
                            } else if (j === "A3" && (g === "RPRT" || g === "GOVDOC")) {
                                c += j + "  - " + f[h[j]] + "\n";
                            } else {
                                for (var l = 0; l < f[h[j]].length; l++) {
                                    c += j + "  - " + PP.library.Author.toRis(f[h[j]][l]) + "\n";
                                }
                            }
                        } else if (j === "KW") {
                            var p = f[h[j]].split(/;\s*/);
                            for (var l = 0; l < p.length; l++) {
                                if (p[l].length > 0) {
                                    c += j + "  - " + p[l] + "\n";
                                }
                            }
                        } else {
                            var k = this._wrapText(f[h[j]], 74);
                            for (var l = 0; l < k.length; l++) {
                                var m = l == 0 ? j + "  - " : "      ";
                                c += m + k[l] + "\n";
                            }
                        }
                    }
                }
            }
            c += "ER  - \n";
            if (e < a.length - 1) {
                c += "\n";
            }
        }
        return c;
    },
    _wrapText: function(a, b) {
        if (!a) return "";
        if (PP.Utils.isArray(a)) {
            var c = "";
            a.forEach(function(a) {
                if ("last" in a) {
                    c = a["last"];
                    if ("first" in a) {
                        c += ", " + a["first"];
                    }
                } else if ("collective" in a) {
                    c = a["collective"];
                }
            });
            a = c;
        } else if (!PP.Utils.isString(a)) {
            a = a.toString();
        }
        var d = a.split(/\s+/);
        var e = [];
        var c = [];
        for (var f = 0; f < d.length; f++) {
            if (d[f].length >= b) {
                e.push(c.join(" "));
                c = [];
                c.push(d[f]);
            } else {
                if (c.join(" ").length + 1 + d[f].length > b) {
                    e.push(c.join(" "));
                    c = [];
                    c.push(d[f]);
                } else {
                    c.push(d[f]);
                }
            }
        }
        e.push(c.join(" "));
        return e;
    },
    scorePubDate: function(a, b) {
        var c = 0;
        if (a[b]) {
            if (a[b]["year"]) c += 3;
            if (a[b]["month"]) c += 2;
            if (a[b]["day"]) c += 1;
        }
        return c;
    }
});

PP.format.Ris = new PP.format._Ris();

PP.format._RSS = PP.format.AbstractReader.extend({
    mapIn: {
        volume: "volume",
        "number,issue": "issue",
        "startingPage,startPage": "startpage",
        "endingPage,endPage": "endpage",
        publisher: "publisher",
        link: "url",
        description: "abstract",
        content: "abstract",
        summary: "abstract",
        creator: "author",
        date: "date",
        title: "title",
        identifier: "identifier",
        pubDate: "date",
        issued: "date",
        published: "date",
        guid: "identifier",
        id: "identifier",
        doi: "identifier",
        origLink: "url",
        "author,Author,authors": "author2",
        coverDate: "date",
        updated: "date",
        placeOfPublication: "address",
        edition: "edition",
        lccn: "lccn",
        language: "language",
        extent: "num_pages",
        rights: "copyright"
    },
    hierarchy: [ "title", "creator", "description", "content", "volume", "number,issue", "startingPage,startPage", "endingPage,endPage", "publisher", "placeOfPublication", "issued", "date", "link", "origLink", "identifier", "pubDate", "published", "edition", "guid", "id", "doi", "author,Author,authors", "language", "lccn", "extent", "coverDate", "updated", "summary", "rights" ],
    getName: function() {
        return "RSS";
    },
    doRead: function(a) {
        var b = [];
        var c = this;
        var d;
        if (typeof a == "string") {
            a = a.replace(/(<)(\w+:)(\w+)/g, "$1$3");
            a = a.replace(/(<\/)(\w+:)(\w+)/g, "$1$3");
            d = this.getXMLParser(a);
        }
        var e = c._getChannelInfo(d);
        var f = [];
        if (isBrowserEnvironment()) {
            f = $(d).find("item, entry, record");
        } else {
            f = d.find("item, entry, record");
            if (f.length == 0 && d[0] && d[0].name == "entry") {
                f = $xmlNodeJs(d[0]);
            }
        }
        f.each(function(a, d) {
            if (!isBrowserEnvironment()) {
                if ($xmlNodeJs(d).find("dc").length) {
                    d = $xmlNodeJs($xmlNodeJs(d).find("dc")[0]);
                }
            }
            var e = {
                pubtype: "PP_MISC",
                url: [],
                author: [],
                author2: []
            };
            var f = [ "" ];
            c.hierarchy.forEach(function(a) {
                var b = c.mapIn[a];
                if (isBrowserEnvironment()) {
                    var f = $(d).find(a);
                    f.each(function(d, f) {
                        if (a == "link") {
                            var g = $(f).attr("href");
                            if (g && g.match(/^(http|ftp)/)) {
                                e.url.push(g);
                            }
                        }
                        var h;
                        if ($(f).find("name").length) {
                            h = $(f).find("name").text();
                        } else {
                            h = $(f).text();
                        }
                        e = c._processText(h, b, e);
                    });
                } else {
                    if ($xmlNodeJs(d).children(a).length) {
                        for (var g = 0; g < $xmlNodeJs(d).find(a).length; g++) {
                            if (a.toLowerCase().indexOf("link") > -1) {
                                var h = $xmlNodeJs(d).children(a)[g].attribs.href;
                                if (h === undefined && $xmlNodeJs(d).children(a)[g].next && $xmlNodeJs(d).children(a)[g].next.data) {
                                    h = $xmlNodeJs(d).children(a)[g].next.data;
                                }
                                if (h && h.match(/^(http|ftp)/)) {
                                    e.url.push(h);
                                }
                            }
                            var i;
                            if ($xmlNodeJs(d).children(a)[g].children && $xmlNodeJs(d).children(a)[g].children[0] && $xmlNodeJs(d).children(a)[g].children[0].type == "comment" && $xmlNodeJs(d).children(a)[g].children[0].data) {
                                i = $xmlNodeJs(d).children(a)[g].children[0].data;
                                if (i.indexOf("[CDATA[") > -1) {
                                    i = i.replace("[CDATA[", "");
                                    if (i.indexOf("[") > -1) i = i.substring(0, i.indexOf("["));
                                    if (i.indexOf("]") > -1) i = i.substring(0, i.indexOf("]"));
                                }
                            } else {
                                i = $xmlNodeJs($xmlNodeJs(d).children(a)[g]).text();
                            }
                            if (i) e = c._processText(i, b, e);
                        }
                    } else {
                        for (var g = 0; g < $xmlNodeJs(d)[0].children.length; g++) {
                            if ($xmlNodeJs(d)[0].children[g].name && $xmlNodeJs(d)[0].children[g].name.match(a.toLowerCase())) {
                                var i = $xmlNodeJs($xmlNodeJs(d)[0].children[g]).text();
                                if (i) e = c._processText(i, b, e);
                            }
                        }
                    }
                }
            });
            b.push(e);
        });
        c._screenAbstract(b, e);
        b.forEach(function(a) {
            if (a.author2.length > a.author.length) {
                a.author = PP.Utils.clone(a.author2);
            }
            delete a.author2;
        });
        c._cleanPubs(b, e);
        return b;
    },
    _processText: function(a, b, c) {
        if (a && a.length > 0) {
            if (b !== "url" && b !== "identifier") {
                a = a.replace(/https:\S+/g, "");
                a = a.replace(/http:\S+/g, "");
            }
            a = a.replace(/^\s+/, "").replace(/\s+$/, "");
            a = a.replace(/\s+/g, " ");
            if (b == "identifier") {
                if (a.match(/10\.\d{4,5}\//) && !a.match(/^http/i)) {
                    if (!c["doi"]) c["doi"] = a;
                } else if (a.match(/^https?:\/\/.+doi\.org\/(10\.\d+.+)/)) {
                    if (!c["doi"]) c["doi"] = RegExp.$1;
                } else if (a.match(/^https?:\/\/.+\/.+/i)) {
                    c.url.push(a);
                } else if (a.match(/urn:ISBN:/)) {
                    var d = PP.Utils.extractISBNs(a, {
                        convert: true,
                        unique: true
                    });
                    if (d[0]) c.isbn = d[0];
                    if (d[1]) c.isbn_alt = d[1];
                }
            } else if (b == "date") {
                var e = PP.library.Date.parseDate(a);
                if (!c["year"] && e["year"]) {
                    c["year"] = e["year"];
                    if (e["month"]) c["month"] = e["month"];
                    if (e["day"]) c["day"] = e["day"];
                }
            } else if (b == "url") {
                a = a.replace(/^HTTP/, "http");
                if (a.match(/^(http|ftp)/)) {
                    c.url.push(a);
                }
            } else if (b == "num_pages") {
                if (a.match(/(\d+)\s*p\./)) {
                    c[b] = RegExp.$1;
                } else if (a.match(/^\d+$/)) {
                    c[b] = a;
                }
            } else if (b == "author" || b == "author2") {
                var f = 0;
                if (a.match(/(.+)(\s+et\s+al\.?\s*)$/)) {
                    f = 1;
                    a = RegExp.$1;
                }
                if (a.match(/(,|;|&|\sand\s)/) && !(a.match(/^[^,]+,\s+[^,]+$/) || a.match(/^[^,]+,\s+[^,]+\s+[^,]+$/))) {
                    PP.library.Author.parseAuthorList(a, {
                        multiple: true,
                        auto: true
                    }).forEach(function(a) {
                        c[b].push(a);
                    });
                } else {
                    var g = PP.library.Author.parseAuthor(a, {
                        familyNameFirst: false
                    });
                    c[b].push(g);
                }
                if (f) {
                    c[b].push({
                        collective: "others"
                    });
                }
            } else {
                if (!c[b]) c[b] = a;
            }
        }
        if (c["language"]) c["language"] = PP.Utils.normalizeLanguage(c["language"]);
        return c;
    },
    _screenAbstract: function(a, b) {
        a.forEach(function(a) {
            if (a["abstract"]) {
                var c = a["abstract"];
                if (c.match(/Source:<\/b>([^,]+), Volume (\d+), Issue (\d+)/)) {
                    if (!a.journal) a.journal = RegExp.$1;
                    if (!a.volume) a.volume = RegExp.$2;
                    if (!a.issue) a.issue = RegExp.$3;
                }
                if (c.match(/^(Journal[^>]+Volume[^>]+<br)/)) {
                    var d = PP.library.BibliographicData.parse(RegExp.$1);
                    if (d.journal) a.journal = d.journal;
                    if (d.volume) a.volume = d.volume;
                    if (d.issue) a.issue = d.issue;
                    if (d.pages) a.pages = d.pages;
                    if (d.year) a.year = d.year;
                }
                if (c.match(/Author\(s\):([^<]+)<\/br>/)) {
                    if (a.author.length == 0) {
                        PP.library.Author.parseAuthorList(RegExp.$1, {
                            multiple: true,
                            auto: true
                        }).forEach(function(b) {
                            a.author.push(b);
                        });
                    }
                } else if (c.match(/^<p>[Bb]y\s+([^<]+)<\/p>/)) {
                    if (a.author.length == 0) {
                        PP.library.Author.parseAuthorList(RegExp.$1, {
                            multiple: true,
                            auto: true
                        }).forEach(function(b) {
                            a.author.push(b);
                        });
                    }
                }
                if (c.match(/pubDate>([^<]+)<\/pubDate/)) {
                    var e = PP.library.Date.parseDate(RegExp.$1);
                    if (e["year"]) a["year"] = e["year"];
                    if (e["month"]) a["month"] = e["month"];
                    if (e["day"]) a["day"] = e["day"];
                }
                if (b.copyright && b.copyright.match(/Karger/)) {
                    if (c.match(/<br\s\/>(.+)/)) {
                        var d = PP.library.BibliographicData.parse(RegExp.$1);
                        if (d.journal) a.journal = d.journal;
                        if (d.volume) a.volume = d.volume;
                        if (d.issue) a.issue = d.issue;
                        if (d.pages) a.pages = d.pages;
                        if (d.year) a.year = d.year;
                    }
                }
            }
        });
    },
    _getChannelInfo: function(a) {
        var b = {};
        var c = $(a);
        c.find("publicationName").each(function(a, c) {
            if (a == 0) {
                var d = $(c)[0];
                var e = "parentElement" in d ? d.parentElement.nodeName : d.parent.name;
                if (e && e.match(/channel/)) {
                    b.publicationName = $(c).text();
                }
            }
        });
        c.find("channel > title").each(function(a, c) {
            if (a == 0) b.title = $(c).text();
        });
        c.find("title").each(function(a, c) {
            if (a == 0 && !b.title) {
                var d = $(c)[0];
                var e = "parentElement" in d ? d.parentElement.nodeName : d.parent.name;
                if (e && e.toLowerCase() == "feed") b.title = $(c).text();
            }
        });
        c.find("channel > issn").each(function(a, c) {
            if (a == 0) b.issn = $(c).text();
        });
        c.find("channel > eIssn").each(function(a, c) {
            if (a == 0) b.eissn = $(c).text();
        });
        c.find("channel > volume").each(function(a, c) {
            if (a == 0) b.volume = $(c).text();
        });
        c.find("channel > number").each(function(a, c) {
            if (a == 0) b.issue = $(c).text();
        });
        c.find("channel > pubDate").each(function(a, c) {
            var d = $(c).text();
            b.date = PP.library.Date.parseDate(d);
        });
        c.find("channel > copyright").each(function(a, c) {
            if (a == 0) b.copyright = $(c).text();
        });
        return b;
    },
    _cleanPubs: function(a, b) {
        a.forEach(function(a) {
            if (a.title && a.journal) {
                if (a.journal == a.title) delete a.journal;
            }
            if (!a.journal) {
                if (b.publicationName) {
                    a.journal = b.publicationName;
                } else if (b.title) {
                    if (b.title.match(/Latest Results for\s+(.+)/)) {
                        a.journal = RegExp.$1;
                    } else if (b.title.match(/ScienceDirect Publication:\s*(.+)/)) {
                        a.journal = RegExp.$1;
                    } else if (b.title.match(/(.+)- new TOC\s*$/)) {
                        a.journal = RegExp.$1;
                    } else if (b.title.match(/(.+)\s+Current Issue$/)) {
                        a.journal = RegExp.$1;
                    } else if (b.title.match(/New content is available for\s+(.+)$/)) {
                        a.journal = RegExp.$1;
                    } else if (b.title.match(/(.+): (Latest|New) Articles/)) {
                        a.journal = RegExp.$1;
                    } else if (b.title.match(/(.+)\s*[-:]\s*Table of Contents$/)) {
                        a.journal = RegExp.$1;
                    } else {
                        a.journal = b.title;
                    }
                    a.journal = a.journal.replace(/\s*[:-]\s*$/, "");
                }
            }
            if (!a.issn && b.issn) {
                a.issn = b.issn;
            }
            if (!a.issn_alt && b.eissn) {
                a.issn_alt = b.eissn;
            }
            if (!a.volume && b.volume) {
                a.volume = b.volume;
            }
            if (!a.issue && b.issue) {
                a.issue = b.issue;
            }
            if (!a.year && b.date && b.date.year) {
                a.year = b.date.year;
            }
            if (!a.month && b.date && b.date.month) {
                a.month = b.date.month;
            }
            if (a.title) {
                a.title = a.title.replace(/\s+\[[A-Z]+\]$/, "");
            }
            if (a.volume || a.journal) {
                a.pubtype = "PP_ARTICLE";
            }
            if (a["isbn"]) {
                a.pubtype = "PP_BOOK";
            }
        });
    }
});

PP.format.RSS = new PP.format._RSS();

PP.format._SIRSI = PP.format.AbstractReader.extend({
    doRead: function(a) {
        var b = this._readHTML(a);
        PP.library.Publication.autoClean(b);
        return [ b ];
    },
    _readHTML: function(a) {
        var b = {
            url: [],
            pubtype: "PP_BOOK",
            keywords: [],
            authors: [],
            editors: [],
            titleField: ""
        };
        var c, d, e, f, g;
        var h = false;
        var i = $(a).find("#detail_marc_record dl dd");
        var j = $(a).find("#detail_marc_record dl dt");
        if (i.length > 0) {
            h = true;
        } else {
            i = $(a).find("tr td.viewmarctags");
            j = $(a).find("tr th.viewmarctags");
            if (i.length > 0) {
                h = true;
            }
        }
        if (!h) i = $(a).find("#detail_item_information dl dd");
        var k, l;
        if (h && i.length > 0 && i.length == j.length) {
            for (var c = 0; c < i.length; c++) {
                k = $(j[c]).text().replace(/\n/g, " ");
                k = PP.Utils.normalizeString(k).replace(/:.*/, "").toUpperCase();
                l = $(i[c]).text().replace(/\n/g, " ");
                l = PP.Utils.normalizeString(l);
                b = this.parseKeyValue(k, l, b);
            }
        } else if (i.length > 0) {
            for (c = 0; c < i.length; c++) {
                if ($(i[c]).length) {
                    for (d = 0; d < $(i[c]).length; d++) {
                        var m = $(i[c])[0];
                        var n = null;
                        if ("className" in m) {
                            n = m.className;
                        } else if (m.attribs && "class" in m.attribs) {
                            n = m.attribs.class;
                        }
                        if (n && $(m).text()) {
                            k = n;
                            k = PP.Utils.normalizeString(k).replace(/:.*/, "").toUpperCase();
                            l = $(m).text().trim().replace(/\n/g, " ");
                            l = PP.Utils.normalizeString(l);
                            b = this.parseKeyValue(k, l, b);
                        }
                    }
                }
            }
        }
        var o = $(a).find("ul.detail_page dl");
        var c, d;
        if (o && o.length > 0) {
            for (c = 0; c < o.length; c++) {
                var p = $(o[c]).find("dd.publisher");
                if (p.length && !b.publisher) b["publisher"] = $(p[0]).text();
                e = $(o[c]).find("dd.publishing_date");
                if (e.length) {
                    f = $(e[0]).text().trim();
                    year = f.match(/(\d{4})/);
                    if (year && year.length == 2) {
                        g = {};
                        g.year = year[1];
                        b.published = g;
                    }
                } else {
                    e = $(o[c]).find("dd.period_date");
                    if (e.length) {
                        f = $(e[0]).text().trim();
                        year = f.match(/(\d{4})/);
                        if (year && year.length == 2) {
                            g = {};
                            g.year = year[1];
                            b.published = g;
                        }
                    }
                }
                var q = $(o[c]).find("dd.isbn");
                if (q.length) {
                    var r = PP.Utils.extractISBNs($(q[0]).text(), {
                        convert: true,
                        unique: true
                    });
                    var s;
                    while (s = r.shift()) {
                        if (!b.isbn) b.isbn = s;
                        if (!b.isbn_alt) b.isbn_alt = s;
                    }
                }
                var t = $(o[c]).find("dd input");
                if (t.length) {
                    var u;
                    if ("name" in t[0]) {
                        u = t[0].name;
                    } else if ("attribs" in t[0]) {
                        u = t[0].attribs.name;
                    }
                    if (u == "permalink") {
                        if ("value" in t[0]) {
                            b["url"] = [ t[0].value ];
                        } else if ("attribs" in t[0]) {
                            b["url"] = [ t[0].attribs.value ];
                        }
                    }
                }
            }
        }
        o = $(a).find("div.displayElementText");
        if (o && o.length > 0) {
            for (c = 0; c < o.length; c++) {
                if ($(o[c]).length) {
                    for (d = 0; d < $(o[c]).length; d++) {
                        var m = $(o[c])[d];
                        var v;
                        if ("className" in m) {
                            v = m.className;
                        } else if ("attribs" in m) {
                            v = m.attribs.class;
                        }
                        if (v && $(m).text()) {
                            v = v.replace("displayElementText ", "");
                            b = this.parseKeyValue(v, $(m).text().trim(), b);
                        }
                    }
                }
            }
        }
        e = $(a).find("div.PUBDATE_value");
        if (e.length) {
            f = $(e[0]).text().trim();
            year = f.match(/(\d{4})/);
            if (year && year.length == 2) {
                g = {};
                g.year = year[1];
                b.published = g;
            }
        }
        e = $(a).find("div.PUBDATE");
        if (e.length) {
            f = $(e[0]).text().trim();
            year = f.match(/(\d{4})/);
            if (year && year.length == 2) {
                g = {};
                g.year = year[1];
                b.published = g;
            }
        }
        if (b.authors.length) b["author"] = this.parseAuthors(b.authors);
        if (b.editors.length) b["editor"] = this.parseAuthors(b.editors);
        delete b.editors;
        delete b.authors;
        if (b.author && !b.editor && b.titleField.indexOf("edited") >= 0) {
            var w = false;
            for (c = 0; c < b.author.length; c++) {
                if (b.titleField.indexOf(b.author[c].last) == -1) w = true;
            }
            if (!w) {
                b.editor = b.author;
                delete b.author;
            }
        }
        delete b.titleField;
        if (b.publisher) {
            b.publisher = PP.Utils.normalizeString(b.publisher.replace(/\s*:\s*$/, ""));
        }
        if (b.address) {
            b.address = PP.Utils.normalizeString(b.address).replace(/^(\[)(.+)(\])$/, "$2");
        }
        if (b.language) b.language = PP.Utils.normalizeLanguage(b.language);
        return b;
    },
    parseKeyValue: function(a, b, c) {
        a = a.toUpperCase().replace(/\_/g, " ").replace(/\s+/g, " ");
        if (a == "TITLE" || a == "INITIAL TITLE SRCH") {
            c.titleField = b;
            var d = b.replace(/\/\s+edited.*/, "");
            d = d.replace(/ \/.*/, "");
            if (d.indexOf("[videorecording]") >= 0) {
                d = d.replace(" [videorecording]", "");
                c.pubtype = "PP_VIDEO";
            }
            if (d.indexOf("[DVD]") >= 0) {
                d = d.replace(" [DVD]", "");
                c.pubtype = "PP_VIDEO";
            }
            d = d.replace(" [electronic resource]", "");
            c.title = d;
        } else if (a == "PERSONAL AUTHOR" || a == "ADDED AUTHOR" || a == "ADDED PERSONAL AUTH" || a == "OTHER AUTHOR/EDITOR" || a == "AUTHOR" || a == "ADDED AUTHOR-UCA") {
            if (b.indexOf(" collection") == -1) {
                var e = b.replace(/\/\s+editor.*/, "");
                var e = e.replace(/\/\s+author.*/, "");
                if (b.indexOf("editor") >= 0) {
                    c.editors.push(e);
                } else {
                    c.authors.push(e);
                }
            }
        } else if (a == "PUBLISHER") {
            if (!c.publisher) {
                if (b.charAt(b.length - 1) == ",") {
                    b = b.substring(0, b.length - 1);
                }
                c.publisher = b;
            }
        } else if (a == "PUBLICATION INFO" || a == "PUBLICATION" || a == "PUBLICATION NOTE" || a == "PUBLISHED") {
            var f = b;
            if (b.indexOf(":") >= 0) {
                f = b.split(":")[1];
                c.address = b.split(":")[0].trim();
            }
            var g = f.split(",");
            var h;
            for (var i = 0; i < g.length; i++) {
                if (!g[i].match(/\d{4}/)) {
                    if (i > 0) {
                        h += ", " + g[i].trim();
                    } else {
                        h = g[i].trim();
                    }
                } else if (!c.published) {
                    var j = g[i].match(/(\d{4})/);
                    if (j && j.length == 2) {
                        c.published = {
                            year: j[1]
                        };
                    }
                }
            }
            if (h && h.charAt(h.length - 1) == ",") {
                h = h.substring(0, h.length - 1);
            }
            if (h) c.publisher = h;
        } else if (a == "SUBJECT" || a == "CRANFIELD SUBJECT" || a == "SUBJECT TERM") {
            if (c.keywords.indexOf(b) === -1) {
                b = b.replace(/\s*\.\s*$/, "");
                c.keywords.push(b);
            }
        } else if (a == "ISBN" || a == "ISBN UCA" || a == "ISBN/PRICE") {
            if (!c.isbn && b.indexOf("invalid") == -1) {
                c.isbn = b.split(" ")[0];
            }
        } else if (a == "LCCN") {
            c.lccn = b;
        } else if (a == "EDITION") {
            c.edition = b;
        } else if (a == "SUMMARY" || a == "BIBSUMMARY") {
            c.abstract = b;
        } else if (a == "CORPORATE AUTHOR" || a == "ADDED CORPORATE AUTH" || a == "ADDED CORPORATE AUTHOR") {
            c.institution = b;
        } else if (a == "LANGUAGE") {
            c.language = b;
        } else if (a == "PERIOD DATE" || a == "PUBLISHING DATE") {
            var k = b.match(/(\d{4})/);
            if (k && k.length == 2) {
                c.published = {
                    year: k[1]
                };
            }
        } else if (a == "GENRE TERM") {
            c.genre = b;
            if (b == "Documentary films.") c.pubtype = "PP_VIDEO";
        } else if (a == "JOURNAL TITLE") {
            c.journal = b;
            c.pubtype = "PP_ARTICLE";
        } else if (a == "CITATION") {
            var l = PP.library.BibliographicInferer.parse(b);
            if (l.published && l.published.year) {
                var m = {
                    year: l.published.year
                };
                if (l.published.month) m.month = l.published.month;
                if (l.published.day) m.day = l.published.day;
                if (!c.published) c.published = m;
            }
            if (l.volume && !c.volume) c.volume = l.volume;
            if (l.issue && !c.issue) c.issue = l.issue;
            if (l.number && !c.number) c.number = l.number;
            if (l.pages && !c.pages) c.pages = l.pages;
        } else {}
        return c;
    },
    parseAuthors: function(a) {
        var b = [];
        for (var c = 0; c < a.length; c++) {
            a[c] = a[c].replace(/[\+\*\[\(\d].*$/g, "");
            a[c] = a[c].replace(/\s*(MD|PhD|MSc)\s*,?\s*/g, "");
            a[c] = a[c].replace(/[0-9]{4}-[0-9]{4}/g, "");
            a[c] = a[c].replace(/[0-9]{4}-/g, "");
            var d = a[c].split(/,\s*/);
            if (d.length >= 2) {
                b.push({
                    last: d[0],
                    first: d[1]
                });
            }
        }
        return b;
    },
    getName: function() {
        return "SIRSI";
    }
});

PP.format.SIRSI = new PP.format._SIRSI();

PP.format._Unixref = PP.format.AbstractReader.extend({
    parsingRules: {
        title: [ "journal_article > titles title", "conference_paper > titles title", "content_item[component_type=chapter] > titles title", "content_item[component_type=reference_entry] > titles title", "book_series_metadata > titles title", "dissertation > titles title", "report-paper titles title", "dataset titles title", "component titles title", "standard_metadata > titles title" ],
        subtitle: [ "journal_article > titles subtitle", "conference_paper > titles subtitle", "content_item[component_type=chapter] > titles subtitle", "content_item[component_type=reference_entry] > titles subtitle", "book_series_metadata > titles subtitle", "dissertation > titles subtitle", "report-paper titles subtitle", "dataset titles subtitle" ],
        abstract: [ "journal_article description", "conference_paper description", "content_item[component_type=chapter] description", "book_series_metadata description", "dissertation description", "report-paper description", "dataset description" ],
        series: [ "series_metadata > titles title", "series_title" ],
        booktitle: [ "book book_metadata > titles title", "proceedings_title", "book_series_metadata > titles title" ],
        conference: [ "conference event_metadata conference_name" ],
        conference_location: [ "conference event_metadata conference_location" ],
        conference_date: [ "conference event_metadata conference_date" ],
        startpage: [ "first_page" ],
        endpage: [ "last_page" ],
        volume: [ "volume" ],
        issue: [ "journal_issue issue" ],
        genre: [ "dissertation degree" ],
        edition: [ "book_metadata edition_number", "report-paper_metadata edition_number" ],
        journal: [ "journal_metadata abbrev_title", "journal_metadata full_title", "database database_metadata titles title" ],
        journalfull: [ "journal_metadata full_title" ],
        publisher: [ "publisher publisher_name" ],
        address: [ "publisher publisher_place", "dissertation institution_place" ],
        institution: [ "institution > institution_name" ],
        author: [ "journal_article > contributors *[contributor_role]", "conference_paper > contributors *[contributor_role]", "chapter_contributors > contributors *[contributor_role]", "content_item[component_type=chapter] > contributors *[contributor_role]", "dissertation *[contributor_role]", "report-paper contributors *[contributor_role]", "dataset *[contributor_role]", "component *[contributor_role]", "standard *[contributor_role]" ],
        book_contributors: [ "book book_metadata > contributors *[contributor_role]" ],
        series_contributors: [ "book book_series_metadata series_metadata > contributors *[contributor_role]" ],
        bookseries_contributors: [ "book book_series_metadata > contributors *[contributor_role]" ],
        url: [ "journal_article doi_data resource", "conference_paper doi_data resource", "book content_item resource", "book_metadata doi_data resource", "book_series_metadata doi_data resource", "sa_component component_list component doi_data resource", "dissertation doi_data resource", "report-paper doi_data resource", "dataset doi_data resource", "component doi_data resource", "standard doi_data resource" ],
        number: [ 'report-paper item_number[item_number_type="Report Number"]', 'report-paper item_number[item_number_type="article-number"]' ],
        year: [ "journal_article publication_date[media_type=print] year", "journal_article publication_date[media_type=online] year", "journal_article publication_date year", "conference_paper publication_date[media_type=print] year", "conference_paper publication_date[media_type=online] year", "conference_paper publication_date year", "book_metadata publication_date[media_type=print] year", "book_metadata publication_date[media_type=online] year", "book_metadata publication_date year", "book_series_metadata publication_date[media_type=print] year", "book_series_metadata publication_date[media_type=online] year", "book_series_metadata publication_date year", "dissertation approval_date year", "report-paper publication_date[media_type=print] year", "report-paper publication_date[media_type=online] year", "report-paper publication_date year", "dataset publication_date year", "component publication_date year", "standard approval_date year" ],
        month: [ "journal_article publication_date[media_type=print] month", "journal_article publication_date[media_type=online] month", "journal_article publication_date month", "conference_paper publication_date[media_type=print] month", "conference_paper publication_date[media_type=online] month", "conference_paper publication_date month", "book_metadata publication_date[media_type=print] month", "book_metadata publication_date[media_type=online] month", "book_metadata publication_date month", "book_series_metadata publication_date[media_type=print] month", "book_series_metadata publication_date[media_type=online] month", "dissertation approval_date month", "report-paper publication_date[media_type=print] month", "report-paper publication_date[media_type=online] month", "report-paper publication_date month", "dataset publication_date month", "component publication_date month", "standard approval_date month" ],
        day: [ "journal_article publication_date[media_type=print] day", "journal_article publication_date[media_type=online] day", "journal_article publication_date day", "conference_paper publication_date[media_type=print] day", "conference_paper publication_date[media_type=online] day", "conference_paper publication_date day", "book_metadata publication_date[media_type=print] day", "book_metadata publication_date[media_type=online] day", "book_metadata publication_date day", "book_series_metadata publication_date[media_type=print] day", "book_series_metadata publication_date[media_type=online] day", "book_series_metadata publication_date day", "dissertation approval_date day", "report-paper publication_date[media_type=print] day", "report-paper publication_date[media_type=online] day", "report-paper publication_date day", "dataset publication_date day", "component publication_date day", "standard approval_date day" ],
        issn: [ "issn" ],
        isbn: [ "isbn" ],
        doi: [ "conference_paper doi_data doi", "journal_article doi_data doi", "book content_item doi_data doi", "book_metadata doi_data doi", "sa_component component_list component doi_data doi", "dissertation doi_data doi", "report-paper doi_data doi", "book_series_metadata doi_data doi", "dataset doi_data doi", "component doi_data doi", "standard doi_data doi" ]
    },
    doRead: function(a) {
        if (typeof a == "string") {
            var b = this.getXMLParser(a);
            var c = this._readUnixref(b);
            PP.library.Publication.autoClean(c);
            return [ c ];
        } else if (typeof a == "object") {
            var c = this._readUnixref(a);
            PP.library.Publication.autoClean(c);
            return [ c ];
        } else {
            return [];
        }
    },
    isUnixref: function(a) {
        var b;
        if (typeof a == "string") {
            b = this.getXMLParser(a);
        } else if (typeof a == "object") {
            b = a;
        }
        var c = false;
        if (b) {
            if ($(b).find("doi_record").length > 0) c = true;
        }
        return c;
    },
    _readUnixref: function(a) {
        var b = {
            author: [],
            editor: [],
            series_editor: [],
            url: [],
            bookurl: [],
            issn: [],
            isbn: [],
            book_contributors: [],
            bookseries_contributors: [],
            series_contributors: []
        };
        for (var c in this.parsingRules) {
            for (var d = 0; d < this.parsingRules[c].length; d++) {
                var e = $(a).find(this.parsingRules[c][d]);
                if (e) {
                    if (e[0]) {
                        if (c == "author" || c == "editor" || c.match(/contributors/)) {
                            for (var f = 0; f < e.length; f++) {
                                var g = this._processAuthor(e[f]);
                                if (c === "book_contributors") {
                                    b["book_contributors"].push(g);
                                } else if (c === "bookseries_contributors") {
                                    b["bookseries_contributors"].push(g);
                                } else if (c === "series_contributors") {
                                    b["series_contributors"].push(g);
                                } else {
                                    if (g.role && g.role == "editor") {
                                        b["editor"].push(g);
                                    } else {
                                        b["author"].push(g);
                                    }
                                }
                            }
                        } else if (c == "url") {
                            var h = this.parsingRules[c][d].match(/(book_metadata|book_series_metadata)/) ? "bookurl" : "url";
                            for (var f = 0; f < e.length; f++) {
                                if ($(e[f]).text().match(/^http/)) b[h].push($(e[f]).text());
                            }
                        } else if (c == "isbn" || c == "issn") {
                            for (var f = 0; f < e.length; f++) {
                                b[c].push($(e[f]).text());
                            }
                        } else if (c == "conference_date") {
                            if (this._getAttribute(e[0], "start_year") && this._getAttribute(e[0], "end_year")) {
                                var i = [ "", "/", "", "/", "", "-", "", "/", "", "/", "" ];
                                if (this._getAttribute(e[0], "start_day")) i[0] = this._getAttribute(e[0], "start_day");
                                if (this._getAttribute(e[0], "start_month")) i[2] = this._getAttribute(e[0], "start_month");
                                if (this._getAttribute(e[0], "end_day")) i[6] = this._getAttribute(e[0], "end_day");
                                if (this._getAttribute(e[0], "end_month")) i[8] = this._getAttribute(e[0], "end_month");
                                i[4] = this._getAttribute(e[0], "start_year");
                                i[10] = this._getAttribute(e[0], "end_year");
                                b[c] = {
                                    literal: i.join("")
                                };
                            }
                        } else {
                            if (!b[c]) b[c] = $(e[0]).text();
                        }
                    }
                }
            }
        }
        b.pubtype = "PP_MISC";
        var j = {
            journal: "PP_ARTICLE",
            conference_paper: "PP_CONFERENCE_PAPER",
            book: "PP_BOOK",
            "report-paper": "PP_REPORT",
            dissertation: "PP_THESIS",
            dataset: "PP_DATASET",
            component: "PP_DATASET",
            standard: "PP_STANDARD"
        };
        for (var k in j) {
            if (j.hasOwnProperty(k)) {
                if ($(a).find(k).length > 0) {
                    b.pubtype = j[k];
                }
            }
        }
        if (b.pubtype == "PP_THESIS") {
            b.kind = "Ph.D. Thesis";
            if (b.institution) {
                b.school = b.institution;
                delete b.institution;
            }
        }
        if (b.pubtype == "PP_BOOK") {
            if ($(a).find("content_item[component_type=chapter]").length > 0) {
                b.pubtype = "PP_BOOK_CHAPTER";
            }
            if ($(a).find("content_item[component_type=reference_entry]").length > 0) {
                b.pubtype = "PP_BOOK_CHAPTER";
            }
        }
        if (b.pubtype == "PP_BOOK_CHAPTER") {
            if (b.book_contributors.length > 0) {
                for (var f = 0; f < b.book_contributors.length; f++) {
                    b.editor.push(b.book_contributors[f]);
                }
            } else {
                if (b.bookseries_contributors.length > 0) {
                    for (var f = 0; f < b.bookseries_contributors.length; f++) {
                        b.editor.push(b.bookseries_contributors[f]);
                    }
                }
                if (b.series_contributors.length > 0) {
                    for (var f = 0; f < b.series_contributors.length; f++) {
                        b.series_editor.push(b.series_contributors[f]);
                    }
                }
            }
        }
        if (b.pubtype === "PP_BOOK") {
            if (!b.title && b.booktitle) {
                b.title = b.booktitle;
                delete b.booktitle;
            }
            if (b.book_contributors.length > 0) {
                for (var f = 0; f < b.book_contributors.length; f++) {
                    if (b.book_contributors[f].role == "author") {
                        b.author.push(b.book_contributors[f]);
                    }
                    if (b.book_contributors[f].role == "editor") {
                        b.editor.push(b.book_contributors[f]);
                    }
                }
            } else if (b.bookseries_contributors.length > 0) {
                for (var f = 0; f < b.bookseries_contributors.length; f++) {
                    if (b.bookseries_contributors[f].role == "author") {
                        b.author.push(b.bookseries_contributors[f]);
                    }
                    if (b.bookseries_contributors[f].role == "editor") {
                        b.editor.push(b.bookseries_contributors[f]);
                    }
                }
            }
            if (b.series_contributors.length > 0) {
                for (var f = 0; f < b.series_contributors.length; f++) {
                    b.series_editor.push(b.series_contributors[f]);
                }
            }
            b.url = b.url.concat(b.bookurl);
        }
        if (b.subtitle) {
            if (!b.title) {
                b.title = b.subtitle;
            } else {
                b.title = b.title.replace(/\s*:\s*$/, "");
                b.title = b.title + ": " + b.subtitle;
            }
            delete b.subtitle;
        }
        if (b.title) {
            b.title = b.title.replace(/\s*<\/title>\s*$/, "");
            b.title = b.title.replace(/^\s*<title>\s*/, "");
        }
        for (var f = 0; f < b.author.length; f++) {
            if (b.author[f].role) delete b.author[f].role;
        }
        for (var f = 0; f < b.editor.length; f++) {
            if (b.editor[f].role) delete b.editor[f].role;
        }
        delete b.book_contributors;
        delete b.bookseries_contributors;
        delete b.series_contributors;
        delete b.bookurl;
        if (!b.title) {
            if (b.doi) {
                b.title = b.doi;
                b.pubtype = "PP_MISC";
            }
        }
        if (!b.series_editor) {
            delete b.series_editor;
        }
        return b;
    },
    _processAuthor: function(a) {
        var b = {
            first: undefined,
            last: undefined,
            collective: undefined,
            jr: undefined
        };
        if (a.nodeName == "organization" || a.name == "organization") {
            b.collective = $(a).text();
        } else {
            var c = $(a).find("given_name");
            if (c && c[0]) {
                b.first = $(c[0]).text();
            }
            var d = $(a).find("surname");
            if (d && d[0]) {
                b.last = $(d[0]).text();
            }
            var e = $(a).find("suffix");
            if (e && e[0]) {
                b.jr = $(e[0]).text();
            }
        }
        if (b.last && b.first && b.last.length == 1 && b.first.length > 1) {
            var f = b.first;
            b.first = b.last;
            b.last = f;
        }
        b.role = this._getAttribute(a, "contributor_role");
        return b;
    },
    getName: function() {
        return "Unixref";
    }
});

PP.format.Unixref = new PP.format._Unixref();

PP.format._XMP = PP.format.AbstractReader.extend({
    readBasicPdfInfo: function(a) {
        if (typeof a == "string") {
            var b = this.getXMLParser(a);
            var c = {
                source: {}
            };
            var d = $(b).filterNode("dc:title");
            if (d[0]) {
                c.source.pdf_title = this.trim($(d[0]).text());
            }
            var e = $(b).filterNode("dc:description");
            if (e[0]) {
                c.source.pdf_description = this.trim($(e[0]).text());
            }
            return c;
        } else {
            return null;
        }
    },
    doRead: function(a) {
        if (typeof a == "string") {
            var b = this.getXMLParser(a);
            var c = this._readXMP(b);
            PP.library.Publication.autoClean(c);
            return [ c ];
        } else {
            return [];
        }
    },
    trim: function(a) {
        a = a.replace(/^[\n\s]+/g, "");
        a = a.replace(/[\n\s]+$/g, "");
        return a;
    },
    _readXMP: function(a) {
        var b = {
            author: [],
            pubtype: "PP_ARTICLE"
        };
        var c = $(a).filterNode("prism:doi");
        if (c[0]) b["doi"] = $(c[0]).text();
        var d = $(a).filterNode("prism:issn");
        if (d[0]) {
            b["issn"] = $(d[0]).text();
            if (b["issn"] == "") delete b["issn"];
        }
        var e = $(a).filterNode("prism:eIssn");
        if (e[0]) {
            b["issn_alt"] = $(e[0]).text();
            if (b["issn_alt"] == "") delete b["issn_alt"];
        }
        var f = $(a).filterNode("prism:volume");
        if (f[0]) b["volume"] = $(f[0]).text();
        var g = $(a).filterNode("prism:issueidentifier");
        if (g[0]) b["issue"] = $(g[0]).text();
        var h = $(a).filterNode("prism:number");
        if (h[0] && !b["issue"]) b["issue"] = $(h[0]).text();
        var i = $(a).filterNode("prism:publicationName");
        if (i[0]) b["journal"] = $(i[0]).text();
        var j = $(a).filterNode("prism:startingPage");
        if (j[0]) b["startpage"] = $(j[0]).text();
        var k = $(a).filterNode("prism:endingPage");
        if (k[0]) b["endpage"] = $(k[0]).text();
        var l = $(a).filterNode("prism:publicationDate");
        if (l[0]) {
            var m = PP.library.Date.parseDate($(l[0]).text());
            b["year"] = m["year"];
            b["month"] = m["month"];
            b["day"] = m["day"];
        }
        var n = $(a).filterNode("dc:title");
        if (n[0]) b["title"] = $(n[0]).text();
        var o = $(a).filterNode("dc:publisher");
        if (o[0]) b["publisher"] = $(o[0]).text();
        var o = $(a).filterNode("dc:publisher");
        if (o[0]) b["publisher"] = $(o[0]).text();
        var p = $(a).filterNode("dc:creator").filterNode("rdf:li");
        if (p[0]) {
            if (p.length == 1 && $(p[0]).text().match(/;/)) {
                var q = $(p[0]).text().split(/;/);
                for (var r = 0; r < q.length; r++) {
                    b["author"].push(PP.library.Author.parseAuthor(q[r], {
                        familyNameFirst: false
                    }));
                }
            } else {
                for (var r = 0; r < p.length; r++) {
                    b["author"].push(PP.library.Author.parseAuthor($(p[r]).text(), {
                        familyNameFirst: false
                    }));
                }
            }
        }
        return b;
    },
    getName: function() {
        return "XMP";
    }
});

PP.format.XMP = new PP.format._XMP();

PP.format._Zotero = PP.format.AbstractReader.extend({
    getName: function() {
        return "Zotero JSON";
    },
    doRead: function(a) {
        if (a) {
            var b = PP.Utils.decode($(a).filterNode("content").text());
            if (b) {
                var c = this._readZoteroJSON(b);
                return [ c ];
            } else {
                return [];
            }
        } else {
            return [];
        }
    },
    _readZoteroJSON: function(a) {
        var b = this;
        var c, d, e, f, g, h;
        var i = {
            url: [],
            zotero_tags: []
        };
        var j = b.jsonGetPubtypeAndKind(a.itemType);
        i["pubtype"] = j.pubtype;
        if (j.kind) i["kind"] = j.kind;
        var k = b.jsonMapToPaperpileFields(a, i["pubtype"]);
        for (c in k) {
            if (k[c].length === 0) continue;
            var e = k[c][0];
            var f = b.jsonIninitalizeValue(c);
            c = c.replace(/\..+/, "");
            if (c === "published" || c === "filed") {
                f[c] = PP.library.Date.parseDate(e);
            } else if (c === "zotero_tags") {
                f[c] = [];
                for (var l = 0; l < e.length; l++) {
                    if (e[l].type && e[l].type == 1) {
                        continue;
                    }
                    f[c].push(e[l].tag);
                }
            } else if (c === "creators") {
                f = {};
                e.forEach(function(a) {
                    if (a.creatorType) {
                        var b = "author";
                        if (a.creatorType === "editor") b = "editor";
                        if (a.creatorType === "translator") b = "translator";
                        if (a.creatorType === "castMember") b = "editor";
                        if (a.creatorType === "producer") b = "series_editor";
                        if (a.creatorType === "recipient") b = "editor";
                        if (!(b in f)) f[b] = [];
                        var c = {};
                        if (a.name) {
                            c.collective = a.name;
                        } else {
                            c.first = a.firstName;
                            c.last = a.lastName;
                        }
                        PP.library.Author.autoClean(c);
                        f[b].push(c);
                    }
                });
            } else if (c === "issn") {
                f = b.jsonCheckISSN(e);
            } else if (c === "isbn") {
                f = b.jsonCheckISBN(e);
            } else {
                b.jsonSetValue(c, f, e);
            }
            b.jsonAssignValuesToPub(f, i);
        }
        return i;
    }
});

PP.format.Zotero = new PP.format._Zotero();

PP.format._WoK = PP.format.AbstractReader.extend({
    map: {
        PUBLISHER: [ "EDITORIAL", "EDITOR", "\u0410\u0414\u0420\u0415\u0421\u0410" ],
        VOLUME: [ "VOLUMEN", "\u0422\u041e\u041c" ],
        ISSUE: [ "N\xdaMERO", "EDI\xc7\xc3O", "\u0412\u042b\u041f\u0423\u0421\u041a" ],
        PAGES: [ "P\xc1GINAS", "\u0421\u0422\u0420." ],
        PUBLISHED: [ "FECHA DE PUBLICACI\xd3N", "PUBLICADO", "\u041e\u041f\u0423\u0411\u041b\u0418\u041a\u041e\u0412\u0410\u041d\u041e" ],
        "DOCUMENT TYPE": [ "TIPO DE DOCUMENTO", "\u0422\u0418\u041f \u0414\u041e\u041a\u0423\u041c\u0415\u041d\u0422\u0410" ],
        BY: [ "POR", "\u0410\u0412\u0422\u041e\u0420" ],
        "EDITED BY": [],
        LANGUAGE: [ "IDIOMA", "\u042f\u0417\u042b\u041a" ]
    },
    doRead: function(a) {
        var b = this._readHTML(a);
        PP.library.Publication.autoClean(b);
        return [ b ];
    },
    _readHTML: function(a) {
        var b = {
            url: [],
            pubtype: "PP_BOOK",
            keywords: [],
            authors: [],
            editors: []
        };
        var c, d, e, f, g, h;
        h = $(a).find(".title");
        if (h && h.length > 0) {
            b.title = $(h[0]).text();
        }
        h = $(a).find(".sourceTitle");
        if (h && h.length > 0) {
            var i = $(h[0]).text();
            b.journal = PP.String.toTitleCase(PP.Utils.normalizeString(i));
        }
        headings = $(a).find(".title3");
        for (var d = 0; d < headings.length; d++) {
            if ($(headings[d]).text() == "Abstract") {
                b.abstract = $(headings[d]).next().text();
                d = headings.length;
            }
        }
        fields = $(a).find(".FR_field");
        for (var c = 0; c < fields.length; c++) {
            var j, k;
            var l = $(fields[c]).children();
            k = "";
            for (var d = 0; d < l.length; d++) {
                var m = $(l[d]);
                if (m.hasClass("FR_label")) {
                    j = m.text();
                } else if (j) {
                    if (k.length) {
                        k += ":::" + m.text();
                    } else {
                        k = m.text();
                    }
                }
            }
            if (!k) {
                k = $(fields[c]).text();
                k = k.replace(j, "");
            }
            if (j) {
                j = j.replace(/\n/g, " ");
                j = PP.Utils.normalizeString(j).replace(/:.*/, "").toUpperCase();
            }
            var n = this.getKey(j);
            if (n == "BY" || n == "EDITED BY") {
                k = $(fields[c]).text();
                k = k.replace(/^[^:]+:/g, "");
            }
            if (j) {
                k = k.replace(/\n/g, " ");
                k = PP.Utils.normalizeString(k);
                b = this.parseKeyValue(j, k, b);
            }
        }
        if (b.authors.length) b["author"] = this.parseAuthors(b.authors);
        if (b.editors.length) b["editor"] = this.parseAuthors(b.editors);
        delete b.editors;
        delete b.authors;
        var o = false;
        if (b.pubtype == "PP_BOOK_CHAPTER") o = true;
        if (b.pubtype == "PP_CONFERENCE_PAPER" && b.isbn) o = true;
        if (o) {
            if (b.journal) {
                b.booktitle = b.journal;
                delete b.journal;
            }
        }
        if ("publisher" in b) {
            pubString = PP.String.toTitleCase(b.publisher);
            if (pubString.indexOf(",") > -1) {
                b.publisher = pubString.substring(0, pubString.indexOf(","));
                b.address = pubString.substring(pubString.indexOf(",") + 2, pubString.length);
            } else {
                b.publisher = pubString;
            }
            publisherArray = b.publisher.split(",");
            locationString = "";
            for (var p = 0; p < publisherArray.length; p++) {
                if (p === 0) {
                    b.publisher = PP.String.toTitleCase(publisherArray[p]);
                } else if (p == 1) {
                    locationString += b.publisher[p];
                } else {
                    locationString += b.publisher[p];
                }
            }
            if (locationString.length) {
                b.address = PP.String.toTitleCase(locationString);
            }
        }
        if (b["language"]) b["language"] = PP.Utils.normalizeLanguage(b["language"]);
        return b;
    },
    getKey: function(a) {
        var b = a;
        for (var c in this.map) {
            if (this.map[c].indexOf(a) > -1) {
                b = c;
            }
        }
        return b;
    },
    parseKeyValue: function(a, b, c) {
        while (a.indexOf("_") >= 0) {
            a = a.replace("_", " ");
        }
        a = this.getKey(a);
        if (a == "BY") {
            c.authors = b.split(";");
        }
        if (a == "EDITED BY") {
            c.editors = b.split(";");
        } else if (a == "BOOK SERIES") {
            c.series = b;
        } else if (a == "VOLUME") {
            c.volume = b;
        } else if (a == "ISSUE") {
            c.issue = b;
        } else if (a == "PAGES") {
            c.pages = b;
        } else if (a == "PUBLISHED") {
            var d = b.match(/(\d{4})/);
            if (d && d.length == 2) {
                var e = {};
                e.year = d[1];
                c.published = e;
            }
        } else if (a == "PUBLISHER") {
            c.publisher = b;
        } else if (a == "DOCUMENT TYPE") {
            if (b == "Book") {
                c.pubtype = "PP_BOOK";
            } else if (b == "Article") {
                c.pubtype = "PP_ARTICLE";
            } else if (b == "Proceedings Paper") {
                c.pubtype = "PP_CONFERENCE_PAPER";
            } else if (b == "Book Chapter") {
                c.pubtype = "PP_BOOK_CHAPTER";
            } else if (b == "News Item") {
                c.pubtype = "PP_NEWS_ARTICLE";
            } else if (b == "Meeting Abstract") {
                if ("conference" in c) {
                    c.pubtype = "PP_CONFERENCE_PAPER";
                } else {
                    c.pubtype = "PP_MISC";
                }
            } else {
                c.pubtype = "PP_ARTICLE";
            }
        } else if (a == "LANGUAGE") {
            c.language = b;
        } else if (a == "ISBN") {
            var f = PP.Utils.extractISBNs(b, {
                convert: true,
                unique: true
            });
            if (f[0]) c.isbn = f[0];
            if (f[1]) c.isbn_alt = f[1];
        } else if (a == "ISSN") {
            c.issn = b;
        } else if (a == "EISSN") {
            c.issn_alt = b;
        } else if (a == "DOI") {
            c.doi = b;
        } else if (a == "PUBMED ID") {
            c.pmid = b;
        } else if (a == "AUTHOR KEYWORDS") {
            if (!c.keywords.length) c.keywords = b.split(":::");
        } else if (a == "KEYWORDS PLUS") {
            if (!c.keywords.length) c.keywords = b.split(":::");
        } else if (a == "CONFERENCE") {
            c.conference = b;
        } else if (a == "LOCATION") {
            if ("conference" in c) c.conference_location = b;
        } else if (a == "DATE") {
            if ("conference" in c) {
                var d = b.match(/(\d{4})/);
                if (d && d.length == 2) {
                    var g = {};
                    g.year = d[1];
                    g.literal = b;
                    c.conference_date = g;
                }
            }
        } else {}
        return c;
    },
    parseAuthors: function(a) {
        var b = [];
        for (var c = 0; c < a.length; c++) {
            a[c] = a[c].replace(/.*\(/, "");
            a[c] = a[c].replace(/\).*/, "");
            var d = a[c].split(/,\s*/);
            if (d.length >= 2) {
                b.push({
                    last: d[0],
                    first: d[1]
                });
            } else if (a == "[Anonymous]") {
                b.push({
                    collective: "Anonymous"
                });
            }
        }
        return b;
    },
    getName: function() {
        return "WoK";
    }
});

PP.format.WoK = new PP.format._WoK();

PP.format._Tests = PP.Class.extend({
    getTests: function() {
        if (!this._tests) {
            this._tests = [ {
                target: "Ris",
                test_description: "Authors names are all pooled in one line",
                file: "tests_ris/file001.ris",
                pubtype: "PP_ARTICLE",
                title: "Stromal cell-derived factor-1\u03b1-directed chemoattraction of transiently CXCR4-overexpressing bone marrow stromal cells into functionalized three-dimensional biomimetic scaffolds",
                "author.0.last": "Thieme",
                "author.1.last": "Ryser",
                volume: "15",
                issue: "4",
                publisher: "Mary Ann Liebert, Inc.",
                journalfull: "Tissue Engineering: Part C",
                "url.0": "http://www.liebertonline.com/doi/abs/10.1089/ten.tec.2008.0556",
                pages: "687",
                "published.year": "2009",
                journal: "Tissue Engineering: Part C",
                doi: "10.1089/ten.tec.2008.0556"
            }, {
                target: "Ris",
                test_description: "standard journal article with abstract",
                file: "tests_ris/file002.ris",
                pubtype: "PP_ARTICLE",
                abstract: "The penetration of US national security by foreign agents as well as American citizens is a historical and current reality that's a persistent and increasing phenomenon. Surveys, such as the e-crime watch survey, reveal that current or former employees and contractors are the second greatest cybersecurity threat, exceeded only by hackers, and that the number of security incidents has increased geometrically in recent years. The insider threat is manifested when human behavior departs from compliance with established policies, regardless of whether it results from malice or a disregard for security policies. In this article, we focus on the need for effective training to raise staff awareness about insider threats and the need for organizations to adopt a more effective approach to identifying potential risks and then taking proactive steps to mitigate them.",
                journal: "IEEE Security and Privacy",
                issue: "1",
                title: "Combating the Inside Cyber Threat",
                volume: "6",
                pages: "61-64",
                "published.year": "2008",
                "author.0.last": "Greitzer",
                "author.1.last": "Moore"
            }, {
                target: "Ris",
                test_description: "standard book entry",
                file: "tests_ris/file003.ris",
                pubtype: "PP_BOOK",
                address: "New York, NY, USA",
                publisher: "Penguin Classics",
                title: "The Odyssey",
                "published.year": "2003",
                "author.0.collective": "Homer"
            }, {
                target: "Ris",
                test_description: "standard book entry with ISBN",
                file: "tests_ris/file004.ris",
                pubtype: "PP_BOOK",
                address: "New York, NY, USA",
                isbn: "9780375507458",
                publisher: "Random House",
                title: "Spy: The Inside Story of How the FBI's Robert Hanssen Betrayed America",
                "author.0.last": "Wise"
            }, {
                target: "Ris",
                test_description: "conference paper",
                file: "tests_ris/file005.ris",
                pubtype: "PP_CONFERENCE_PAPER",
                abstract: "Insider Threat has become one of the most important types of attacks to identify and combat for both government and commercial organizations in recent years. The irreversible financial and security damages that can result from this type of threat have placed Insider Threat among the most important problems in cybersecurity [1]. The complexity of the problem is mainly due to the fact that the attacker is a legitimate user of the system, which makes it very difficult to draw a clear line between legitimate and malicious actions. This paper presents a multi-perspective approach for detection of insider threats in typical enterprise networks. In this approach, multiple detection engines monitor network activities from different perspectives and use the aggregate information to adjust their detection sensitivities. Experimental results from our studies show that this approach results in reduced false alarm probability as well as an increased ability to detect attacks by colluding insiders.",
                address: "Los Alamitos, CA, USA",
                publisher: "IEEE Computer Society",
                title: "A Multi-Perspective Approach to Insider Threat Detection",
                journal: "Proceedings of the 2011 Military Communications Conference",
                pages: "1164-1169",
                "published.year": "2011",
                "author.0.last": "Raissi-Dehkordi",
                "author.1.last": "Carr"
            }, {
                target: "Ris",
                test_description: "general entry - misc",
                file: "tests_ris/file006.ris",
                pubtype: "PP_MISC",
                title: "Implementation of $K$-ary Viruses in Python",
                "published.year": "2009",
                "author.0.last": "Desnos"
            }, {
                target: "Ris",
                test_description: "report",
                file: "tests_ris/file007.ris",
                pubtype: "PP_REPORT",
                title: "Better Design, Better Elections",
                "published.year": "2012",
                "url.0": "http://www.brennancenter.org/page/-/Democracy/VRE/Better_Design_Better_Elections.pdf",
                "author.0.last": "Norden",
                "author.1.last": "Quesenbery",
                "author.2.last": "Kimball"
            }, {
                target: "Ris",
                test_description: "article type: unpublished",
                file: "tests_ris/file008.ris",
                pubtype: "PP_UNPUBLISHED",
                abstract: "The 1997 re-identification of Massachusetts Governor William ...The complete story of ...",
                title: "The `Re-Identification' of Governor William Weld's Medical Information: A Critical Re-Examination of Health Data Identification Risks and Privacy Protections, Then and Now",
                "url.0": "http://ssrn.com/abstract=2076397",
                "author.0.last": "Barth-Jones",
                "published.year": "2012"
            }, {
                target: "Ris",
                test_description: "article type: webiste",
                file: "tests_ris/file009.ris",
                pubtype: "PP_WEBSITE",
                abstract: "Secretary of State Debra Bowen conducted ...",
                title: "Top-to-Bottom Review",
                "url.0": "http://www.sos.ca.gov/voting-systems/oversight/top-to-bottom-review.htm",
                "published.year": "2007"
            }, {
                target: "Ris",
                test_description: "another book entry",
                file: "tests_ris/file010.ris",
                pubtype: "PP_BOOK",
                address: "Sebastopol, CA, USA",
                isbn: "9780596510336",
                publisher: "O'Reilly and Associates",
                title: "Version Control with Subversion",
                "published.year": "2008",
                "author.0.last": "Pilato",
                "author.1.last": "Collins-Sussman",
                "author.2.last": "Fitzpatrick"
            }, {
                target: "Ris",
                test_description: "PhD thesis",
                file: "tests_ris/file011.ris",
                pubtype: "PP_THESIS",
                abstract: "In this thesis, we detail an approach to ...",
                address: "Cambridge, MA, USA",
                title: "Was the Patient Cured? Understanding Semantic Categories and Their Relationships in Patient Records",
                "author.0.last": "Sibanda",
                "published.year": "2006"
            }, {
                target: "Ris",
                test_description: "article type: manual",
                file: "tests_ris/file012.ris",
                pubtype: "PP_MISC",
                address: "Santa Clara, CA, USA",
                issue: "Order Number 253668-033US",
                title: "Intel 64 and IA-32 Architectures Software Developer's Manual Volume 3A: System Programming Guide, Part 1",
                "url.0": "http://www.intel.com/Assets/PDF/manual/253668.pdf",
                "published.year": "2009"
            }, {
                target: "Ris",
                test_description: "Master thesis",
                file: "tests_ris/file013.ris",
                pubtype: "PP_THESIS",
                abstract: "The Domain Name System (DNS) is ... This thesis describes problems ...",
                address: "West Lafayette, IN 47904",
                title: "Addressing Weaknesses in the Domain Name System Protocol",
                "url.0": "http://ftp.cerias.purdue.edu/pub/doc/network/schuba-DNS-msthesis.ps.Z",
                "published.year": "1993",
                "author.0.last": "Schuba"
            }, {
                target: "Ris",
                test_description: "book chapter",
                file: "tests_ris/file014.ris",
                pubtype: "PP_BOOK_CHAPTER",
                address: "Piscataway, NJ, USA",
                isbn: "9780470544327",
                publisher: "IEEE Press",
                title: "Stream Ciphers",
                "url.0": "http://ieeexplore.ieee.org/xpl/ebooks/bookPdfWithBanner.jsp?fileName=5265909.pdf&bkn=5265879",
                journal: "Contemporary Cryptology: The Science of Information Integrity",
                "author.0.last": "Rueppel",
                "editor.0.last": "Simmons",
                pages: "65-134",
                "published.year": "1992"
            }, {
                target: "Ris",
                test_description: "",
                file: "tests_ris/file015.ris",
                pubtype: "PP_MISC",
                abstract: "Recently there has been much interest in ...",
                address: "Berkeley, CA, USA",
                publisher: "USENIX Association",
                title: "On the Security of UNIX",
                volume: "2",
                journal: "UNIX Programmer's Manual",
                "published.year": "1978",
                "author.0.last": "Ritchie"
            }, {
                target: "Ris",
                test_description: "Thesis",
                file: "tests_ris/file016.ris",
                pubtype: "PP_THESIS",
                title: "Acting Processes in Contemporary British Verbatim Theatre",
                abstract: "This thesis is the first investigation to ...",
                "published.year": "2010",
                "author.0.last": "Cantrell"
            }, {
                target: "Ris",
                test_description: "article with abstract and keywords",
                file: "tests_ris/file017.ris",
                pubtype: "PP_ARTICLE",
                title: "Not 'Going There' - Limits to the Professionalisation of our Emotional Lives",
                abstract: "This article takes as its ...",
                keywords: "emotions talk; therapeutic professionals; cultural beliefs; privacy boundaries; need",
                doi: "10.1111/j.1467-9566.2010.01269.x",
                journal: "Sociology of Health & Illness",
                journalfull: "Sociology of Health & Illness",
                issn: "0141-9889",
                issue: "1",
                volume: "33",
                "published.year": "2011",
                "url.0": "http://dx.doi.org/10.1111/j.1467-9566.2010.01269.x",
                pages: "130-144",
                "author.0.last": "Brownlie"
            } ];
        }
        return this._tests;
    }
});

PP.format.Tests = new PP.format._Tests();

PP.write._Utils = PP.Class.extend({
    getBase: function() {
        if (PP.Globals.isStaging()) {
            return "stage.paperpile.com";
        } else if (PP.Globals.isDev()) {
            return "127.0.0.1:8080";
        } else {
            return "paperpile.com";
        }
    },
    isPaperpileUrl: function(a) {
        return this.isBibliographyItemUrl(a) || this.isCitationUrl(a) || this.isErrorUrl(a);
    },
    isBibliographyItemUrl: function(a) {
        if (!a) {
            return false;
        }
        var b = this.getBase();
        b = b.replace(/\./g, ".");
        var c = new RegExp(b + "/b/");
        if (a.match(c)) {
            return true;
        } else {
            return false;
        }
    },
    isCitationUrl: function(a) {
        if (!a) {
            return false;
        }
        var b = this.getBase();
        b = b.replace(/\./g, ".");
        var c = new RegExp(b + "/c/");
        if (a.match(c)) {
            var d = new RegExp(b + "/c/error");
            if (a.match(d)) {
                return false;
            } else {
                return true;
            }
        } else {
            return false;
        }
    },
    isErrorUrl: function(a) {
        if (!a) {
            return false;
        }
        var b = this.getBase();
        b = b.replace(/\./g, ".");
        var c = new RegExp(b + "/c/error");
        if (a.match(c)) {
            return true;
        } else {
            return false;
        }
    },
    getErrorUrl: function() {
        var a = this.getBase();
        return "http://" + a + "/c/error";
    },
    getCiteAliases: function(a) {
        if (a.match(/\/(c|b|bibliography)\/(\w+)\/([\w+]+)\/?(.*)/)) {
            var b = RegExp.$3;
            var c = b.split("+");
            return c;
        } else {
            return [];
        }
    },
    getDocAlias: function(a) {
        if (a.match(/\/(c|b|bibliography)\/(\w+)\/?/)) {
            var b = RegExp.$2;
            return b;
        } else {
            return null;
        }
    },
    parseCitationUrl: function(a) {
        var b = this;
        var c = [];
        var d = {};
        var e;
        var f = /\/c\/(\w+)\/([\w+]+)(.*)?/.exec(a);
        if (f && f.length > 0) {
            e = f[1];
            var g = f[2];
            var h = f[3];
            var i = g.split("+");
            i.forEach(function(a) {
                var c = b.getDefaultCitationOptions();
                d[a] = c;
            });
            var j = new URI(a);
            if (j.getQuery() !== null) {
                var k = j.parseQuery();
                var l = b.getDefaultCitationOptions();
                for (var m in l) {
                    var n = k.getParam(m);
                    if (n !== null) {
                        var o = n.split(",");
                        o = o.map(function(a) {
                            return decodeURIComponent(a);
                        });
                        if (o.length !== i.length) {
                            console.error("ERROR: We should have equal number of option-pieces as we have aliases!");
                        }
                        for (var p = 0; p < o.length; p++) {
                            var q = o[p];
                            var r = i[p];
                            d[r][m] = q;
                        }
                    }
                }
            }
            i.forEach(function(a) {
                d[a].citeAlias = a;
                c.push(d[a]);
            });
        }
        return {
            docAlias: e,
            citations: c
        };
    },
    encodeCitationUrl: function(a, b, c) {
        var d = a + "/c/" + b + "/";
        var e = [];
        for (var f = 0; f < c.length; f++) {
            if (c[f].citeAlias || c[f].cite_alias) {
                e.push(c[f].citeAlias || c[f].cite_alias);
            }
        }
        d += e.join("+");
        var g = {};
        var h = this.getDefaultCitationOptions();
        var i = {};
        c.forEach(function(a) {
            var b = {};
            var c = false;
            for (var d in h) {
                if (a[d] === undefined) continue;
                if (a[d] !== h[d]) {
                    b[d] = a[d];
                    i[d] = true;
                    c = true;
                }
            }
            if (c) {
                g[a.cite_alias || a.citeAlias] = b;
            }
        });
        var j = [];
        var k = Object.keys(i);
        for (var f = 0; f < k.length; f++) {
            var l = k[f];
            var m = [];
            for (var n = 0; n < c.length; n++) {
                var o = c[n];
                var p = o[l];
                m.push(encodeURIComponent(p));
            }
            var q = l + "=" + m.join(",");
            j.push(q);
        }
        var q = j.join("&");
        if (q) {
            d += "/?" + q;
        }
        return d;
    },
    getDefaultCitationOptions: function() {
        return {
            locator_label: "page",
            locator: "",
            prefix: "",
            suffix: "",
            noauthor: 0
        };
    },
    stripStyles: function(a, b) {
        var c = b.mode;
        var d = {
            string: "",
            styles: []
        };
        if (c === "bibliography") {
            a = this.extractNotesAndNumerals(a, d);
        }
        a = this.removeDivs(a);
        a = this.removeNewlines(a);
        if (a.match(/^\s+$/)) {
            if (d.numeral && d.numeral.match(/[A-Z]/i)) {
                a = this.removeDivs(d.numeral);
                a = this.removeNewlines(a);
                delete d.numeral;
            }
        }
        a = this.removeSpans(a);
        a = this.stripWhitespace(a);
        a = this.decodeHtml(a);
        if (d.numeral) {
            d.numeral = this.removeTextDecoration(d.numeral);
        }
        if (d.preNote) {
            d.preNote = this.removeTextDecoration(d.preNote);
        }
        if (d.postNote) {
            d.postNote = this.removeTextDecoration(d.postNote);
        }
        var e = {
            ITALIC: [],
            OBLIQUE: [],
            BOLD: [],
            SUPERSCRIPT: [],
            SUBSCRIPT: [],
            LINK: [],
            NONE: []
        };
        var f = new RegExp("(</?i>|</?b>|</?em>|</?sup>|</?sub>|</?a[^>]*?>)", "");
        a.split(f).forEach(function(a) {
            if (a.match(f)) {
                var b = "NONE";
                if (a.match(/^<\/?i/)) {
                    b = "ITALIC";
                } else if (a.match(/^<\/?b/)) {
                    b = "BOLD";
                } else if (a.match(/^<\/?em/)) {
                    b = "OBLIQUE";
                } else if (a.match(/^<\/?sup/)) {
                    b = "SUPERSCRIPT";
                } else if (a.match(/^<\/?sub/)) {
                    b = "SUBSCRIPT";
                } else if (a.match(/^<\/?a/)) {
                    b = "LINK";
                }
                if (!a.match(/^<\//)) {
                    var c = undefined;
                    if (a.match(/href=\"([^\"]*)\"/i)) {
                        c = RegExp.$1;
                    }
                    e[b].push([ d.string.length, c ]);
                } else {
                    if (e[b].length > 0) {
                        var g = e[b].pop();
                        var h = g[0];
                        var i = d.string.length;
                        if (i > h) {
                            var j = {
                                style: b,
                                offsets: [ h, i ]
                            };
                            if (g[1] && b === "LINK") {
                                j.url = g[1];
                            }
                            d.styles.push(j);
                        }
                    }
                }
            } else {
                d.string += a;
            }
        });
        return d;
    },
    extractNotesAndNumerals: function(a, b) {
        var c = a.split(/(<\/div>|<div\s+class="csl-block">)/g);
        for (var d = 0; d < c.length; d++) {
            if (c[d].match(/csl-block/)) {
                if (d + 2 < c.length && c[d + 2] == "</div>") {
                    var e = 0;
                    var f = 0;
                    for (var g = 0; g < c.length; g++) {
                        if (!c[g].match(/(<\/div>|<div\s+class="csl-block">)/)) {
                            if (g < d) {
                                e += c[g].replace(/[\s\n]/g, "").length;
                            }
                            if (g > d + 2) {
                                f += c[g].replace(/[\s\n]/g, "").length;
                            }
                        }
                    }
                    if (f >= e) {
                        b.preNote = c[d + 1];
                    } else {
                        b.postNote = c[d + 1];
                    }
                    c[d] = "";
                    c[d + 1] = "";
                    c[d + 2] = "";
                }
            }
        }
        a = c.join("");
        var h = new RegExp('<div class=\\"csl-left-margin\\">(.*?)</div>');
        if (a.match(h)) {
            b.numeral = RegExp.$1;
            a = a.replace(h, "");
        }
        return a;
    },
    removeNewlines: function(a) {
        return a.replace(/\n/g, "");
    },
    stripWhitespace: function(a) {
        a = a.replace(/\s+/g, " ");
        a = a.replace(/^\s+/, "");
        a = a.replace(/\s+$/, "");
        return a;
    },
    removeDivs: function(a) {
        var b = new RegExp("<div [^>]*>", "g");
        a = a.replace(b, " ");
        var c = new RegExp("</div>", "g");
        a = a.replace(c, " ");
        return a;
    },
    removeSpans: function(a) {
        a = a.replace(/<span\s+style\s*=\s*\"[^\"]*\"\s*>/g, "");
        a = a.replace(/<\/span>/g, "");
        return a;
    },
    removeTextDecoration: function(a) {
        a = a.replace(/(<\/?i>|<\/?b>|<\/?sup>|<\/?sub>)/g, "");
        return a;
    },
    decodeHtml: function(a) {
        if (isNodeEnvironment()) {
            a = PP.ent.decode(a);
        } else {
            a = $("<div/>").html(a).html();
        }
        return a;
    },
    shortenLinkText: function(a) {
        var b = new RegExp('(<a href="([^"]*?)">)(.*?)(</a>)', "gi");
        a = a.replace(b, function(a, b, c, d, e, f, g) {
            var h = c;
            if (d.match(/doi:/g)) {
                return b + d + e;
            }
            var i = PP.Utils.getDomainSuffix(h);
            return b + i + e;
        });
        return a;
    },
    checkAjaxError: function(a) {
        if (a && a.match(/(401|503)/i)) {
            PP.log({
                type: "exception",
                subtype: "Google Docs",
                msg: "Received an Ajax error response from Paperpile server: " + a
            });
            PP.write.App.setStatus({
                text: "Whoops &mdash; could not access your Paperpile library. You may be logged out.",
                links: [ {
                    text: "Learn more",
                    fn: function() {
                        var a = PP.Globals.getUrlBase();
                        window.open(a + "/troubleshooting#server-communication");
                    }
                } ]
            });
        }
    },
    combineAndRemoveDuplicates: function(a, b) {
        var c = {};
        var d = [];
        var e = function(a, b) {
            for (var e = 0; e < a.length; e++) {
                var f = true;
                if (a[e].searchError) {
                    d.push(a[e]);
                    continue;
                }
                var g = a[e].id_list || [];
                for (var h = 0; h < g.length; h++) {
                    if (g[h] in c) {
                        if (f) f = false;
                        if (c[g[h]] == a[e].owner) {
                            if ("duplicates" in a[e] && b == "local") {
                                if (a[e].duplicates.length === 0) {
                                    f = true;
                                    a[e].forceInsertInDocument = 1;
                                }
                            }
                        }
                    } else {
                        c[g[h]] = a[e].owner || Math.random();
                    }
                }
                if (f) {
                    d.push(a[e]);
                }
            }
        };
        e(a, "local");
        e(b, "remote");
        for (var f = 0; f < d.length; f++) {
            if (d[f]._multiSearchScore !== undefined) {
                d[f]._first_web_item = 1;
                break;
            }
        }
        return d;
    }
});

createSingleton(PP.write, "_Utils", "Utils");