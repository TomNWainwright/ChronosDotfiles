var INITIAL_VALUE_ATTRIBUTE="com.onepassword.iv";function isFirefox(){return false}function ag_focusField(field,preserveValue){if(!field){return false}let previousValue=field.value;if(typeof field.click==="function"){field.click()}if(typeof field.focus==="function"){field.focus()}if(preserveValue&&field.value!==previousValue){field.value=previousValue}return typeof field.click==="function"||typeof field.focus==="function"}function firePreSetValueEvents(element){var elementValue=element.value;ag_focusField(element,false);element.dispatchEvent(createKeyboardEvent(element,"keydown",0,0));element.dispatchEvent(createKeyboardEvent(element,"keypress",0,0));element.dispatchEvent(createKeyboardEvent(element,"keyup",0,0));if(element.value===""||element.dataset[INITIAL_VALUE_ATTRIBUTE]&&element.value===element.dataset[INITIAL_VALUE_ATTRIBUTE]){element.value=elementValue}}function firePostSetValueEvents(element){var elementValue=element.value;var change=element.ownerDocument.createEvent("HTMLEvents");var input=element.ownerDocument.createEvent("HTMLEvents");element.dispatchEvent(createKeyboardEvent(element,"keydown",0,0));element.dispatchEvent(createKeyboardEvent(element,"keypress",0,0));element.dispatchEvent(createKeyboardEvent(element,"keyup",0,0));input.initEvent("input",true,true);element.dispatchEvent(input);change.initEvent("change",true,true);element.dispatchEvent(change);element.blur();if(element.value===""||element.dataset[INITIAL_VALUE_ATTRIBUTE]&&element.value===element.dataset[INITIAL_VALUE_ATTRIBUTE]){element.value=elementValue}}function createKeyboardEvent(element,eventName,keyCode,charCode){let kEvent;if(isFirefox()){kEvent=document.createEvent("KeyboardEvent");kEvent.initKeyEvent(eventName,true,false,null,false,false,false,false,keyCode,charCode)}else{kEvent=element.ownerDocument.createEvent("Events");kEvent.initEvent(eventName,true,false);kEvent.charCode=charCode;kEvent.keyCode=keyCode;kEvent.which=keyCode;kEvent.srcElement=element;kEvent.target=element}return kEvent}var DEBUG_FILL=false;(function(tab){DEBUG_FILL&&console.log("Filling ",requestUUID,documentUUID);let fillables=document.querySelectorAll("input, select, button");let filledCount=0;let opidFromString=function(opidStr){if(!opidStr||opidStr.length<3)return-1;return parseInt(opidStr.substr(2))};let fillByOPID=function(opid,value){let field=fillables[opidFromString(opid)];if(!field){console.warn(`Was asked to fill opid ${opid} but no element matched that.`);return}if(field.type==="checkbox"){let enabled=!!value;if(field.checked!=enabled){field.click()}}else{firePreSetValueEvents(field);field.value=value;firePostSetValueEvents(field)}filledCount++};let performOperation=function(op){if(op.action==="fopid"){fillByOPID(op.values[0],op.values[1])}else if(op.action==="fq"){let query=op.values[0];let value=op.values[1];let el=document.querySelector(query);if(el&&el.value!==undefined){firePreSetValueEvents(el);el.value=value;firePostSetValueEvents(el);filledCount++}else{}}else if(op.action==="copid"){let opid=opidFromString(op.values[0]);if(fillables[opid]){let field=fillables[opid];if(typeof field.click==="function"){field.click()}else{console.warn(`Was asked to click opid ${opid} found element had no click() method.`)}filledCount++}else{console.warn(`Was asked to click opid ${opid} but no element matched that.`)}}else if(op.action==="focusopid"){let opid=opidFromString(op.values[0]);if(fillables[opid]){let field=fillables[opid];DEBUG_FILL&&console.log("Focusing ",opid,field);ag_focusField(field,true)}else{console.warn(`Was asked to focus opid ${opid} but no element matched that.`)}}else{console.warn("Unhandled action: "+op.action)}};let executeFS=function(fillScript){if(!fillScript.script){console.log("Missing script");return-1}for(let i=0;i<fillScript.script.length;i++){let op=fillScript.script[i];performOperation(op)}if(fillScript.autosubmit){let retryCount=0;let performAutosubmit=()=>{performOperation(fillScript.autosubmit);if(document.activeElement.opid!==fillScript.autosubmit.values[0]&&retryCount<10){DEBUG_FILL&&console.log("Retrying in 50ms");retryCount++;setTimeout(performAutosubmit,50)}};setTimeout(performAutosubmit,1)}return filledCount};if(requestUUID!==tab.uuid){console.warn("Preventing fill due to tab uuid mismatch.");return null}if(tab.allowedDomains){let hostname=window.location.hostname;let allowed=tab.allowedDomains.find(allowed=>{return allowed===hostname||hostname.endsWith("."+allowed)});if(!allowed){console.warn("Unable to fill because "+window.location.hostname+" is not within our allowed domains.",tab.allowedDomains);return null}}for(let i=0;i<tab.scripts.length;i++){let script=tab.scripts[i];if(script.documentUUID!==documentUUID)continue;if(tab.requireHTTPS&&window.location.protocol!=="https:"){let confirmResult=confirm("1Password warning: This is an unsecured (HTTP) page, and any information you submit can potentially be "+"seen and changed by others. This Login was originally saved on a secure (HTTPS) page.\r\n\r\nDo you still wish to fill this login?");if(!confirmResult){console.warn("User aborted fill on unsecured HTTP page.");return null}}return executeFS(script)}console.warn("No script found for documentUUID "+documentUUID);return null});