const FILLABLE_INPUT_FIELD_TYPES=["text","email","number","password","url","tel"],OPFIELD_ID_ATTRIBUTE="data-op-id",OPFORM_ID_ATTRIBUTE="data-op-form-id",MIN_OPFIELD_WIDTH=50;function initCollection(e){return t=>t.forEach(e)}function getPasswordFields(e){return Array.from(e.getElementsByTagName("input")).filter(e=>"password"===e.type)}function getFillableInputFields(e){return Array.from(e.getElementsByTagName("input")).filter(e=>FILLABLE_INPUT_FIELD_TYPES.indexOf(e.type)>=0)}function elementIsVisible(e){let t,n=e,i=e.ownerDocument,o=i?i.defaultView:{};for(;n&&n!==i;){if(!(t=o.getComputedStyle&&n instanceof Element?o.getComputedStyle(n,null):n.style))return!0;if("none"===t.display||"hidden"==t.visibility)return!1;n=n.parentNode}return n===i}function elementIsNotTooNarrow(e){const t=e.getBoundingClientRect().width,n=window.getComputedStyle(e);return t-parseFloat(n.paddingLeft||"0")-parseFloat(n.paddingRight||"0")>=MIN_OPFIELD_WIDTH}function hasOPForm(e){const t=e.form;return!!t&&t.hasAttribute(OPFORM_ID_ATTRIBUTE)}function getFirstInputField(e){const t=getFillableInputFields(e).filter(e=>elementIsVisible(e)&&elementIsNotTooNarrow(e));return 0===t.length?null:t[0]}function initForm(e,t){0!==getPasswordFields(e).length&&e.setAttribute(OPFORM_ID_ATTRIBUTE,""+t)}function initField(e,t){const n="password"===e.type;(hasOPForm(e)||n)&&e.setAttribute(OPFIELD_ID_ATTRIBUTE,""+t)}function collectInlineForms(){const e=initCollection(initForm),t=initCollection(initField);e(Array.from(document.forms)),t(getFillableInputFields(document.body))}function promoteFieldToOPField(e){if(!e)return;let t=Array.from(document.getElementsByTagName("input")).map(e=>{let t=e.getAttribute(OPFIELD_ID_ATTRIBUTE);return t?parseInt(t,10):-1}),n=Math.max(...t,777);e.setAttribute(OPFIELD_ID_ATTRIBUTE,""+n)}function promoteFormToOPForm(e){if(!e)return;let t=Array.from(document.getElementsByTagName("form")).map(e=>{let t=e.getAttribute(OPFORM_ID_ATTRIBUTE);return t?parseInt(t,10):-1}),n=Math.max(...t,777);e.setAttribute(OPFORM_ID_ATTRIBUTE,""+n)}const FORM_KEYS=["ArrowDown","ArrowUp","Escape","Enter","Tab"],BUTTON_WIDTH_MEDIUM=16,BUTTON_SIZE_LARGE=24,BUTTON_SIZE_SMALL=12;class OPFormManager{constructor(e){this.handleFieldChanged=(e=>{e.addEventListener("keydown",this.handleKeyDown,!0),e.addEventListener("input",this.handleInput,!0),this.props.onFieldChanged(e)}),this.handleLockStateChanged=(e=>{this.state.buttonState=e?"locked":"active";const t=document.activeElement;t.blur(),t.focus(),this.render()}),this.handleOPButtonClick=(e=>{e.stopImmediatePropagation(),e.preventDefault();const t=getFieldForButton(e.target);t&&(this.props.onOPButtonClicked(t),t.focus(),this.render())}),this.handleFocusIn=(e=>{if(e.target.id===IFRAME_ID)return;if(e.relatedTarget&&e.relatedTarget.id===IFRAME_ID)return;const t=e.target;menu.activeInput!==t&&t.hasAttribute(OPFIELD_ID_ATTRIBUTE)&&(this.handleFieldChanged(t),this.render())}),this.handleFocusOut=(e=>{if(!e.target.hasAttribute(OPFIELD_ID_ATTRIBUTE))return;const t=e.relatedTarget;t&&t.id===IFRAME_ID||menu.frameCreationInProgress||(menu.isLoaded()?window.setTimeout(()=>document.activeElement.id===IFRAME_ID?void 0:document.activeElement===menu.activeInput?void 0:(menu.unload(),void this.render()),1):this.render())}),this.handleKeyDown=(e=>{if(!e.isTrusted)return;if(FORM_KEYS.indexOf(e.key)<0)return;e.target.hasAttribute(OPFIELD_ID_ATTRIBUTE)&&(this.props.onKeyDown(e),menu.isVisible()&&"ArrowDown"===e.key||this.render())}),this.handleBodyKeyDownEvent=(e=>{if(!e.isTrusted)return;if(220!==e.keyCode||!e.metaKey)return;const t=e.target;"INPUT"===t.tagName&&(t.hasAttribute(OPFIELD_ID_ATTRIBUTE)?this.props.onKeyDown(e):(promoteFieldToOPField(t),promoteFormToOPForm(t.form),this.render(),t.blur(),setTimeout(()=>{t.focus()},1)),e.preventDefault(),e.stopPropagation())}),this.handleInput=(e=>{const t=e.target;t.hasAttribute(OPFIELD_ID_ATTRIBUTE)&&(t.form&&this.handleFormChanged(t.form),this.props.onInput(t))}),this.handleFormChanged=(e=>{const t=e.getAttribute(OPFORM_ID_ATTRIBUTE);if(!t)return;const n=this.state.formData[t];if(!n)return;const i=hasFormChanged(n,new FormData(e));this.props.onFormEdited(e,i)}),this.createOPButtonElement=(e=>{const t=getOPButtonOffsetByFieldPadding(e),n=document.createElement("op-button");n.addEventListener("mousedown",this.handleOPButtonClick,!0),n.setAttribute("data-op-target",""+e.getAttribute(OPFIELD_ID_ATTRIBUTE)),n.setAttribute("data-state",this.state.buttonState),e.insertAdjacentElement("beforebegin",n);const i=e.getBoundingClientRect();let o=n.getBoundingClientRect();const s=e.offsetHeight,a=e.offsetWidth,r=calculateButtonSizeForField(e),l=r===BUTTON_SIZE_LARGE;r===BUTTON_SIZE_SMALL&&!n.classList.contains("op-small")?(n.classList.add("op-small"),o=n.getBoundingClientRect()):l&&!n.classList.contains("op-large")&&(n.classList.add("op-large"),o=n.getBoundingClientRect());const d=i.top-o.top,u=i.left-o.left;n.setAttribute("style",`\n        margin-left: ${u+a-t-1.5*o.width}px;\n        margin-top: ${d+(s-o.height)/2}px;\n        `)}),this.startPageChangeObserver=(()=>{this.state.allInputFields=document.getElementsByTagName("input"),this.state.lastInputFieldCount=this.state.allInputFields.length,this.state.lastFillableFieldCount=getFillableInputFields(document.body).length,this.state.observer.observe(document.documentElement,{childList:!0,subtree:!0})}),this.documentDidUpdate=((e,t)=>{if(this.state.lastInputFieldCount===this.state.allInputFields.length)return;let n=getFillableInputFields(document.body);if(this.state.lastFillableFieldCount===n.length)return;debounce(()=>{let e="INPUT"===(document.activeElement?document.activeElement.tagName.toUpperCase():"")?document.activeElement:null;this.state.lastFillableFieldCount,n.length;let t=!0;e&&!e.getAttribute(OPFIELD_ID_ATTRIBUTE)&&(t=!1),collectInlineForms(),formManager.updateFormData(),this.render(),this.state.lastInputFieldCount=this.state.allInputFields.length,this.state.lastFillableFieldCount=n.length,e&&e.getAttribute(OPFIELD_ID_ATTRIBUTE)&&!t&&(e.blur(),setTimeout(()=>{e&&e.focus()},1))},50,this)()}),this.render=(()=>{this.state.buttonState,document.activeElement;document.querySelectorAll("op-button").forEach(removeElement),Array.from(document.forms).forEach(e=>{if(!e.hasAttribute(OPFORM_ID_ATTRIBUTE))return;const t=getFillableInputFields(e).filter(e=>e===document.activeElement&&elementIsNotTooNarrow(e));if(0!==t.length)this.createOPButtonElement(t[0]);else{const t=getFirstInputField(e);t&&this.createOPButtonElement(t)}});Array.from(document.getElementsByTagName("input")).filter(e=>!e.form&&e.hasAttribute(OPFIELD_ID_ATTRIBUTE)).forEach(this.createOPButtonElement)}),this.props=e;const t=keyedFormData(document.forms);this.state={buttonState:this.props.initialButtonState,formData:t,observer:new MutationObserver(this.documentDidUpdate),allInputFields:[],lastInputFieldCount:0,lastFillableFieldCount:0},document.activeElement.hasAttribute(OPFIELD_ID_ATTRIBUTE)&&this.handleFieldChanged(document.activeElement),document.body.addEventListener("focusin",this.handleFocusIn),document.body.addEventListener("focusout",this.handleFocusOut),document.body.addEventListener("keydown",this.handleBodyKeyDownEvent,!0)}get button(){const e=document.activeElement,t=e.getAttribute(OPFIELD_ID_ATTRIBUTE);if(!t)return null;const n=document.querySelector(`op-button[data-op-target='${t}']`);return n}click(){const e=this.button;e&&e.dispatchEvent(new MouseEvent("mousedown"))}updateFormData(){this.state.formData=keyedFormData(document.forms)}}function isOPEnabled(e){return e.hasAttribute(OPFIELD_ID_ATTRIBUTE)}function getButtonForField(e){const t=e.getAttribute(OPFIELD_ID_ATTRIBUTE),n=document.getElementsByTagName("op-button");if(0===n.length)return null;for(let e=0;e<n.length;e++){const i=n[e],o=i.getAttribute("data-op-target");if(o&&o===t)return i}return null}function hasButton(e){return null!==getButtonForField(e)}function getFieldForButton(e){const t=e.getAttribute("data-op-target");return document.querySelector(`input[${OPFIELD_ID_ATTRIBUTE}='${t}'`)}function calculateButtonSizeForField(e){let t=BUTTON_WIDTH_MEDIUM;return e.offsetHeight>=38&&(t=BUTTON_SIZE_LARGE),e.offsetHeight<BUTTON_WIDTH_MEDIUM+4&&(t=BUTTON_SIZE_SMALL),t}function removeElement(e){const t=e.parentNode;t&&t.removeChild(e)}function getOPButtonOffsetByFieldPadding(e){const t=window.getComputedStyle(e),n=parseFloat(t.paddingLeft||"0"),i=parseFloat(t.paddingRight||"0");var o=i-n;if(o<=Number.EPSILON)return 0;console.group("@OPFormaManger-OPButtonOffset");let s=parseFloat(t.lineHeight||"normal");return isNaN(s)&&(s=1.2*parseFloat(t.fontSize||"0")),console.groupEnd(),o>s?o+4:0}function keyedFormData(e){return Array.from(e).reduce((e,t)=>{const n=t.getAttribute(OPFORM_ID_ATTRIBUTE);return n?Object.assign(e,{[n]:new FormData(t)}):e},{})}function hasFormChanged(e,t){const n=e.values(),i=t.values();for(let e of n)if(e!==i.next().value)return!0;return!1}function stealFocusFromMenu(e){if(!e)return;const t=document.querySelector(`input[data-op-id='${e}']`);t&&t.focus()}function debounce(e,t,n,i=!1){var o,s,a,r,l,d=function(){var n=Date.now()-r;n<t&&n>=0?o=setTimeout(d,t-n):(o=null,i||(l=e.apply(a,s),o||(a=s=null)))};return()=>{a=n,s=arguments,r=Date.now();var u=i&&!o;return o||(o=setTimeout(d,t)),u&&(l=e.apply(a,s),a=s=null),l}}const MENU_WIDTH=250,IFRAME_ID="op-popup",ZINDEX_MAX=2147483647;class InlineMenuFrame{constructor(){this.focused=!1,this.activeInput=null,this.frameCreationInProgress=!1,this.onLoad=(e=>{addMessageListener(function t(n){"inline-ready"===n.name&&(e(),removeMessageListener(t))})}),this.isLoaded=(()=>null!==this.element),this.isVisible=(()=>!!this.element&&(this.element.classList.contains("ready")&&"0"!==this.element.getAttribute("data-rows"))),this.isFocused=(()=>this.focused),this.filterBy=(e=>{sendValue(e)}),this.show=(()=>{this.element&&(this.isVisible()||(this.element.classList.add("ready"),this.notch&&this.notch.classList.add("ready")))}),this.hide=(()=>{this.notch&&this.notch.classList.remove("ready"),this.element&&this.element.classList.remove("ready")}),this.focus=(()=>{let e=document.activeElement;if(!e||e.id===IFRAME_ID)return;let t=this.element;t&&t.contentWindow&&(t.focus(),t.contentWindow.focus())}),this.resize=(e=>{this.element&&(this.element.setAttribute("data-rows",""+e),e>3?this.element.classList.add("overflow"):this.element.classList.remove("overflow"),e>0?(this.show(),this.positionMenu()):this.hide())}),this.down=(()=>sendKey("ArrowDown")),this.up=(()=>sendKey("ArrowUp")),this.enter=(()=>sendKey("Enter")),this.load=((e,t,n="")=>{this.isLoaded()&&this.unload(),this.activeInput=e,this.createMenu(IFRAME_ID,n,chrome.runtime.getURL("/inline/inline.html#"+t),e=>{this.frameCreationInProgress=!1}),this.positionMenu(),document.body.addEventListener("mousedown",this.handleClickOutsidePopup),window.addEventListener("resize",this.handlePageResize)}),this.unload=(()=>{this.element&&(this.frameCreationInProgress=!1,this.focused=!1,document.body.removeEventListener("mousedown",this.handleClickOutsidePopup),window.removeEventListener("resize",this.handlePageResize),this.destroyIFrame(this.element),this.notch&&removeElement(this.notch),this.activeInput=null)}),this.handleClickOutsidePopup=(e=>{const t=e.target;hasButton(t)?sendMessageToInline({name:"inline-reset-menu"}):document.activeElement!==t&&(this.unload(),formManager.render())}),this.positionMenu=(()=>{if(this.isLoaded()){if(!this.activeInput)return;const e=this.calcFrameStyle();this.element.setAttribute("style",e);const t=this.notch;if(t){const e=this.calcNotchStyle(t);t.setAttribute("style",e)}}}),this.createMenu=((e,t,n,i)=>{const o=this.createIFrame(e,t,n,i);return this.createNotch(t),o}),this.handlePageResize=debounce(()=>{this.positionMenu()},100,this),this.calcFrameStyle=(()=>{if(!this.activeInput)return"";const{offsetX:e,offsetY:t}=calculateIframePosition(this.activeInput);return`position:absolute; top:${t}px; left:${e}px; z-index: ${ZINDEX_MAX};`}),this.calcNotchStyle=(e=>{if(!this.activeInput)return"";const{x:t,offsetY:n}=calculateIframePosition(this.activeInput),i=getOPButtonOffsetByFieldPadding(this.activeInput),o=calculateButtonSizeForField(this.activeInput),s=ZINDEX_MAX;return`left: ${t+MENU_WIDTH-i-o/2-o+(o-e.offsetWidth)/2}px; top: ${n-10}px; z-index:${s};`}),this.createIFrame=((e,t,n,i)=>{this.frameCreationInProgress=!0;let o=document.createElement("iframe");return o.id=e,o.src=n,o.onload=(()=>{i(o)}),o.className=t,document.body.appendChild(o),o}),this.createNotch=(e=>{const t=document.createElement("op-notch");t.className=e,document.body.appendChild(t)}),this.listen()}listen(){addMessageListener(e=>{switch(e.name,e.name){case"inline-ready":break;case"inline-items-loaded":this.resize(e.data.numItems);break;case"inline-focus-changed":let t=e.data.index;this.focused=t.section>=0,e.data;let n=0===t.section&&0===t.row,i=this.notch;i&&(i.style.zIndex=`${n?ZINDEX_MAX-10:ZINDEX_MAX}`)}})}get element(){return document.getElementById(IFRAME_ID)}get notch(){const e=document.getElementsByTagName("op-notch");return e&&e.length>0?e[0]:null}destroyIFrame(e){e&&document.body.removeChild(e)}}function calculateIframePosition(e){const t=e.getBoundingClientRect(),n={x:0,y:0},i=getRelativeBodyMargin();JSON.stringify(i),i&&(n.y=i.marginTop,n.x=i.marginLeft);const o=t.right-MENU_WIDTH+window.scrollX-n.x,s=t.top+e.offsetHeight+window.scrollY-n.y;let a={offsetX:Math.max(o,0),offsetY:s,x:o,y:s};return t.top,e.offsetHeight,window.scrollY,t.right,window.scrollX,a}const getRelativeBodyMargin=(()=>{let e=null;return()=>{if(e&&e.isRelative)return e;if(e&&!e.isRelative)return null;const t=window.getComputedStyle(document.body);return(e={marginTop:parseFloat(t.marginTop||"0"),marginLeft:parseFloat(t.marginLeft||"0"),isRelative:"relative"==t.position}).isRelative?e:null}})();function addMessageListener(e){chrome.runtime.onMessage.addListener(e)}function removeMessageListener(e){chrome.runtime.onMessage.removeListener(e)}function sendKey(e){return new Promise(t=>{sendMessageToInline({name:"key-pressed",data:{key:e}},e=>{t(e)})})}function sendValue(e){sendMessageToInline({name:"value-changed",data:{value:e}})}class Knight{constructor(){this.updateInlineConfig=(()=>{updateInlineConfig({edited:this.state.edited,fieldType:this.state.fieldType})}),this.state={locked:!0,autoshow:!0,updateMode:!1,edited:!1,tabId:0,frameId:0,locale:"en",fieldType:"any"}}setState(e){this.state=Object.assign({},this.state,e),this.updateInlineConfig()}getActiveFillMode(e){return this.state.updateMode?"update":"password"===e.type?"all":"mixed"}getPassiveFillMode(e){return this.state.updateMode?"update":"password"===e.type?this.state.edited?"save":"mixed-auto":this.state.edited?"none":"fill"}handleFormEditChange(e){this.setState({edited:e})}}collectInlineForms();const menu=new InlineMenuFrame;let formManager;const knight=new Knight;function handleFieldChanged(e){if(e===menu.activeInput)return;if(knight.setState({fieldType:e.type}),knight.state.locked)return;const t=knight.state.autoshow;menu.unload();const n=knight.getPassiveFillMode(e);if("none"!==n&&t){if(menu.frameCreationInProgress||menu.activeInput===e)return;menu.activeInput,menu.load(e,`/${knight.state.locale}/fill/login/${n}/${knight.state.tabId}/${e.getAttribute(OPFIELD_ID_ATTRIBUTE)}`),menu.onLoad(()=>{knight.state.edited?knight.updateInlineConfig():menu.filterBy(e.value),fixNestedIframeBug(e)})}}function handleOPButtonClicked(e){if(knight.state,knight.setState({fieldType:e.type}),menu.isVisible())menu.unload(),knight.setState({autoshow:!1});else if(knight.state.locked)menu.load(e,`/${knight.state.locale}/locked/${knight.state.tabId}`,"locked"),menu.onLoad(()=>{menu.show()});else{if(menu.frameCreationInProgress,menu.frameCreationInProgress)return;knight.setState({autoshow:!0}),menu.load(e,`/${knight.state.locale}/fill/login/${knight.getActiveFillMode(e)}/${knight.state.tabId}/${e.getAttribute(OPFIELD_ID_ATTRIBUTE)}`),menu.onLoad(()=>{fixNestedIframeBug(e),knight.updateInlineConfig()})}}function handleKeyDown(e){switch(e.key){case"ArrowDown":e.stopPropagation(),e.preventDefault(),menu.isVisible()?(menu.down(),!knight.state.locked&&menu.focus()):formManager.click();break;case"ArrowUp":if(!menu.isLoaded())return;if(e.stopPropagation(),e.preventDefault(),knight.state.locked)return void formManager.click();menu.isFocused()?menu.up():formManager.click();break;case"Escape":if(!menu.isVisible())return;formManager.click();break;case"Enter":if(!menu.isVisible()||!menu.isFocused())return;e.stopPropagation(),e.preventDefault(),menu.enter()}handleCommandBackslash(e)}function handleCommandBackslash(e){e.metaKey&&220===e.keyCode&&!e.shiftKey&&(e.stopPropagation(),e.preventDefault(),menu.isVisible()?menu.hide():formManager.click())}function handleInput(e){menu.isLoaded()&&menu.filterBy(e.value)}function handleFormEditChange(e,t){knight.handleFormEditChange(t)}function handleFillSuggestedPassword(e){const t=e.context,n=t.details.password;let i=fillActivePasswordAndConfirmationFields(t.details.password);0===i&&(i=fillAllEmptyPasswordFields(n)),chrome.runtime.sendMessage({name:"suggested-password-filled",data:{context:t}})}function fillActivePasswordAndConfirmationFields(e){const t=[...document.querySelectorAll("input[type='password']")],n=document.activeElement;let i=0;for(let o=0;o<t.length;o++){let s=t[o];if(s===n&&(s.value=e,i++,o+1<t.length)){(s=t[o+1]).value=e,i++;break}}return i}function fillAllEmptyPasswordFields(e){let t=0;for(let n of document.querySelectorAll("input[type='password']")){let i=n;""===i.value&&(i.value=e,t++)}return t}function showSaveLoginPrompt(e){knight.setState({autoshow:!1});let t=document.createElement("iframe");t.id="op-save-login",t.src=`chrome-extension://${chrome.runtime.id}/inline/inline.html#/${knight.state.locale}/savelogin/${knight.state.tabId}/${e}`,document.body.appendChild(t),document.body.setAttribute("op-scroll-lock","1")}function hideSaveLoginPrompt(){knight.setState({autoshow:!0});const e=document.getElementById("op-save-login");e&&(document.body.removeChild(e),document.body.removeAttribute("op-scroll-lock"))}function updateInlineConfig(e){sendMessageToInline({name:"form-state-changed",data:e})}function runtimeMessageHander(e){if(e.name,"configure-knight"===e.name){let{tabId:t,frameId:n,locale:i,locked:o,activeByDefault:s,traits:a,recipe:r}=e.data,l=!("Pending"===a.fillState||!s);knight.setState({tabId:t,frameId:n,locale:i,locked:o,autoshow:l});let d=o?"locked":"active";window._opformManager||((formManager=new OPFormManager({traits:a,recipe:r,initialButtonState:d,onFieldChanged:handleFieldChanged,onFormEdited:handleFormEditChange,onInput:handleInput,onOPButtonClicked:handleOPButtonClicked,onKeyDown:handleKeyDown})).render(),window._opformManager=!0,formManager.startPageChangeObserver())}else if("lock-state-changed"===e.name)menu.unload(),knight.setState({locked:e.data.locked}),formManager.handleLockStateChanged(e.data.locked);else if("inline-lose-focus"===e.name)stealFocusFromMenu(e.data.fieldOPID);else if("inline-close-menu"===e.name){if(!menu.isVisible())return;stealFocusFromMenu(e.data.fieldOPID),formManager.click()}else if("inline-tab-key-pressed"===e.name)stealFocusFromMenu(e.data.fieldOPID),e.data.forward;else if("item-fill-start"===e.name)knight.setState({autoshow:!1}),menu.unload(),formManager.render();else if("fill-suggested-password"===e.name)handleFillSuggestedPassword(e.data);else if("use-suggested-password-end"===e.name)menu.unload();else if("show-save-login-prompt"===e.name){if(menu.unload(),window===window.top){showSaveLoginPrompt(e.data.sessionId)}}else"close-save-login-prompt"===e.name&&window===window.top&&(hideSaveLoginPrompt(),e.data.saved&&(knight.setState({updateMode:!0,edited:!1}),formManager.updateFormData()))}function listen(){chrome.runtime.onMessage.addListener(runtimeMessageHander),chrome.runtime.sendMessage({name:"knight-ready"})}listen();function fixNestedIframeBug(e){window.self!==window.top&&document.activeElement===e&&(menu.element.focus(),menu.element.contentWindow.focus(),stealFocusFromMenu(e.getAttribute(OPFIELD_ID_ATTRIBUTE)))}function sendMessageToInline(e,t){return chrome.runtime.sendMessage({name:"send-message-to-inline",data:{message:e}},t),!!t}