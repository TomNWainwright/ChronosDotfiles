webpackJsonp([7],{106:function(e,t,n){"use strict";function r(e,t){let n=i.defer(),r=new u.node.BrowserWindow({width:500,height:800,show:!1,"node-integration":!1,"web-security":!1});return r.loadUrl(e),r.webContents.on("did-stop-loading",function(e,t,n,o){r&&r.show()}),r.webContents.on("did-get-redirect-request",function(e,s,c,u){let p=l.parseUrlQueryString(c);p&&p.code?Object(d.c)().then(()=>i(a.ajax({url:t,type:"POST",xhrFields:{withCredentials:!0},dataType:"json",data:{code:p.code}})).then(e=>{log.debug("data",e),n.resolve(e.ncode),r&&r.close(),r=null},e=>{log.error("server auth failed!",e&&e.statusCode,e&&e.responseText),n.reject(e.responseText),r&&r.close(),r=null})):p&&p.error?(log.error("redirect error:",p.error),o.delay(function(){n.reject(p.error)}),r&&r.close(),r=null):log.log("ignore a redirect:",c)}),r.on("closed",function(){r&&(n.reject("cancel"),r=null)}),n.promise}n.d(t,"a",function(){return r});var o=n(19),s=(n.n(o),n(23)),a=(n.n(s),n(9)),i=(n.n(a),n(20)),c=(n.n(i),n(91),n(7)),l=(n.n(c),n(22),n(21)),u=(n.n(l),n(24)),d=n(95)},93:function(e,t,n){"use strict";function r(e,t){return C(b.ajax({url:q.default.makeApiUrl("/api/node-gg-token"),type:"POST",xhrFields:{withCredentials:!0},dataType:"json",data:{type:"refresh",ncode:t}})).then(e=>e.token)}function o(e,t,n){var o=X[e];o.token=n;let s=Object.create(z);s.create({token:n,refreshHandler:R.partial(r,e,t),onNewToken:e=>{o.token=e}}),o.auth=s}function s(e){return X[e].auth}function a(e){return"string"==typeof e?JSON.parse(e):e}function i(e){return!!(e&&void 0!==e.code&&e.code>=500&&e.code<600)}function c(e){var t;if(e)if(console.error(e),e instanceof Error&&e.stack&&console.error(e.stack),"string"==typeof e)t=new Error(e);else if(e instanceof Error&&e.appName)t=e;else{var n=e.code,r="Google error ("+(e.code?e.code+": ":"")+e.message+").";401===e.code||403===e.code||"token_refresh_required"==e.code?(E.each(X,function(e){e.setRefreshFlag()}),r=e.message?e.message:localString("google_author_error")):e.code<=0&&(F=!1,E.each(X,function(e){e.setRefreshFlag()}),r=0!==e.code||navigator.onLine?"Network error ("+e.code+": "+(e.message||"")+").":window.localString("network_not_availiable")),(t=new Error(r)).code=n}else t=new Error(localString("common_unknown_error"));throw t}function l(e){var t={},n=!0;this.setRefreshFlag=function(){n=!0},this.isAuthorized=function(e){return!1===n&&E.has(t,e)},this.add=function(e){t[e]=!0,n=!1},this.getListWithNew=function(e){var n=E.keys(t);return E.has(t,e)||n.push(e),n};var r=q.default.appSettings[e+".userId"];this.setUserId=function(t){r=t,q.default.appSettings[e+".userId"]=r,q.default.saveAppSettings()},this.getUserId=function(){return r}}function u(){return C.Promise(function(e,t){B?e():b.ajax({url:"https://apis.google.com/js/js/client.js",type:"HEAD"}).done(function(){F=!0,e()}).fail(function(e){var n={code:e.status,message:e.statusText};t(n)})})}function d(e,t){var n=[e],r=E.chain(G).pick(n).values().flatten().union().value(),o={client_id:_.GOOGLE_NODE_CLIETN_ID,redirect_uri:q.default.makeApiUrl("/node-gg-oauth2callback"),response_type:"code",scope:r.join("+"),include_granted_scopes:"true",access_type:"offline",approval_prompt:"force"};t&&(o.login_hint=t);var s=b.param(o);let a="https://accounts.google.com/o/oauth2/auth?"+(s=s.replace(/%2B/g,"+")),i=q.default.makeApiUrl("/api/node-gg-auth");return N.a(a,i)}function p(e){return Object(O.c)().then(()=>(log.log("get token"),C(b.ajax({url:q.default.makeApiUrl("/api/node-gg-token"),type:"POST",xhrFields:{withCredentials:!0},dataType:"json",data:{type:"access",ncode:e}})).then(e=>e.token,e=>{throw"no-token"===q.default.xhrSafeResponseText(e)?"need-redir":q.default.xhrSafeErrorString(e)})))}function f(e,t,n){return C.resolve().then(()=>(log.log("check token"),s(e).request({url:"https://www.googleapis.com/oauth2/v1/tokeninfo",type:"GET",dataType:"json",qs:{access_token:t},bDontSetTokenInHeader:!0}).catch(e=>{throw"no-token"===q.default.xhrSafeResponseText(e)?"need-redir":q.default.xhrSafeErrorString(e)}))).then(e=>{let t=e.scope.split(" "),r=[n],o=E.chain(G).pick(r).values().flatten().union().value(),s=t.indexOf("https://www.googleapis.com/auth/userinfo.profile");if(-1!==s&&(t[s]="profile"),-1!==(s=t.indexOf("https://www.googleapis.com/auth/userinfo.email"))&&(t[s]="email"),E.intersection(t,o).length===o.length)return e.user_id;throw"need-redir"})}function g(e,t,n){return p(t).then(r=>(o(e,t,r),f(e,r,n).then(o=>(X[e].add(n),{token:r,ncode:t,userId:o}))))}function h(e,t,n){return C.resolve().then(()=>{let n=q.default.appSettings[t+".gg.nc"];if(n)return g(t,n,e);throw"need-redir"}).catch(r=>{if("need-redir"===r){if(n){let n=q.default.appSettings[t+".gg.uid"];return d(e,n).then(n=>g(t,n,e))}var o=new Error(localString("google_author_error"));throw o.appName="need-redir",o}throw r}).then(({token:e,ncode:n,userId:r})=>{let o=q.default.appSettings[t+".gg.uid"],s=q.default.appSettings[t+".gg.nc"];if(o&&o!==r){M.warn("cancel for signing in with different google user",o,r);var a=new Error(localString("google_account_diff_error"));throw a.appName="account-different",a}o===r&&s===n||(q.default.appSettings[t+".gg.nc"]=n,q.default.appSettings[t+".gg.uid"]=r,q.default.saveAppSettings())})}function v(e,t,n){function r(t){b.ajax({url:"https://www.googleapis.com/oauth2/v1/tokeninfo",data:{access_token:t},timeout:A.a.AJAX_TIMEOUT,type:"GET"}).done(function(r){if(s.getUserId()&&s.getUserId()!=r.user_id)if(s.setUserId(null),n)chrome.identity.removeCachedAuthToken({token:t},function(){o(!1)});else{M.error(I,"getTokenInfo failed");var i=new Error(localString("google_author_error"));i.appName="need-redir",a.reject(i)}else s.setUserId(r.user_id),s.add(e),s.token=t,a.resolve()}).fail(function(e){if(M.error(e.responseText),400===e.status)s.setUserId(null),chrome.identity.removeCachedAuthToken({token:t},function(){if(n)o(!1);else{var e=new Error(localString("google_author_error"));e.appName="need-redir",a.reject(e)}});else{var r={code:e.status,message:e.statusText};a.reject(r)}})}function o(s){console.assert(n||s);var i=[e],c=E.chain(G).pick(i).values().flatten().union().value(),l={interactive:!s,scopes:c};if(U("AndroidApp")||U("iOSApp")){var u=q.default.appSettings[t+".mobileEmail"];u&&(l.accountHint=u)}chrome.identity.getAuthToken(l,function(e){if(U("AndroidApp")||U("iOSApp")){var i=arguments[1];q.default.appSettings[t+".mobileEmail"]=i,q.default.saveAppSettings()}if(e)r(e);else if(!0===s&&n)o(!1);else{M.error(I,"getAuthToken with interative failed, lastError:",chrome.runtime.lastError);let e;e="ChromeOS"===q.default.getOSName()?localString("google_getauthtoken_error_chromebook",chrome.runtime.lastError):U("MobileApp")?localString("google_getauthtoken_error_normal",chrome.runtime.lastError):localString("google_getauthtoken_error_chrome",chrome.runtime.lastError);var c=new Error(e);s&&!n&&(c.appName="need-redir"),a.reject(c)}})}var s=X[t];s||(s=new l(t),X[t]=s);var a=C.defer();return s.token&&s.isAuthorized(e)?a.resolve():U("Node")?h(e,t,n).then(a.resolve,a.reject):o(!0),a.promise}function m(e,t){X[e];t()}function w(e,t){function n(){e().then(function(e){r.resolve(e)},function(e){i(e)&&++o<P?(M.warn("retry num:",o),n()):r.reject(e)},r.notify)}var r=C.defer(),o=0;return n(),r.promise}function T(e,t,n){var r,o,s,i=U("MobileApp")&&n.targetUrl,c=C.defer(),l=C.resolve();return l=l.then(function(){var r=C.defer(),i=X[t],c="https://www.googleapis.com/drive/v2/files/"+e,l=new XMLHttpRequest;return l.open("GET",c),l.setRequestHeader("Authorization","Bearer "+i.token),l.responseType="json",l.onload=function(){if(200===l.status){var e=a(l.response);s=e.etag,n.format&&n.format!==e.mimeType?e.exportLinks[n.format]?(o=e.exportLinks[n.format],r.resolve()):r.reject("Can't convert format to "+n.format):(e.downloadUrl||log.error("convert gdoc to gdoc?"),o=e.downloadUrl,r.resolve())}else r.reject({code:l.status,message:l.statusText})},l.onerror=function(){r.reject({code:l.status,message:l.statusText})},l.send(),r.promise}),(l=l.then(function(){var s=C.defer(),l=X[t];if(i){var u=new window.FileTransfer,d={Authorization:"Bearer "+l.token};u.onprogress=function(e){c.notify({name:"progress",loaded:e.loaded,total:e.total})},u.download(o,n.targetUrl,function(e){s.resolve()},function(e){console.log("download error source "+e.source),console.log("download error target "+e.target),console.log("upload error code"+e.code),s.reject({code:e.code,message:"unknown"})},!0,{headers:d})}else{var p=new XMLHttpRequest;p.open("GET",o),p.setRequestHeader("Authorization","Bearer "+l.token),p.responseType=n.responseType||"blob",p.onload=function(){if(200===p.status){var e;e="json"===n.responseType?a(p.response):p.response,r=e,s.resolve()}else s.reject({code:p.status,message:p.statusText})},p.onerror=function(){s.reject({code:p.status,message:p.statusText})},p.onprogress=function(e){c.notify({name:"progress",loaded:e.loaded,total:e.total})},p.send(),c.notify({name:"cancel-handler",handler:function(t){M.warn("download canceled:",e),p.abort();var n=new Error(localString("common_cancel"));n.appName=t||"cancel",c.reject(n)}})}return s.promise})).then(function(){return n.bWithETag?{content:r,etag:s}:r}).then(c.resolve.bind(c),c.reject.bind(c)),c.promise}function y(e){var t={};return t.code=e.status,e.response&&e.response.error&&e.response.error.message?t.message="Google error: "+e.response.error.message:t.message=e.statusText,t}function j(e,t,n,r){console.assert(e);var o=C.defer(),s=X[t],i="https://www.googleapis.com/drive/v2/files/"+e;n&&(i+="?fields="+n);var c=new XMLHttpRequest;return c.open("GET",i),c.setRequestHeader("Authorization","Bearer "+s.token),c.responseType="json",c.onload=function(){200===c.status?a(c.response).explicitlyTrashed?(M.log("file in trash:",c.response.title,c.response.id),o.reject({code:404,message:"file not found"})):o.resolve(a(c.response)):o.reject(y(c))},c.onerror=function(){o.reject({code:c.status,message:c.statusText})},c.send(),r&&r.push(c),o.promise}function k(e,t,n,r){var o=b.isArray(e)?e:[e],s=C.resolve(),a=[];return(s=s.then(function(){function e(){if(i<o.length)j(o[i++],t,n,r).then(function(t){a.push(t),e()},s.reject);else if(a.length===o.length){s.resolve()}}for(var s=C.defer(),i=0,c=0;c<4;c++)e();return s.promise})).then(function(){return b.isArray(e)?a:a[0]})}function x(e,t,n){var r=C.defer(),o=C.resolve(),s=[],i=[];return(o=o.then(function(){function r(e){var t=e,n=new XMLHttpRequest;n.open("GET",t),n.setRequestHeader("Authorization","Bearer "+l.token),n.responseType="json",n.onload=function(){if(200===n.status){var e=C.resolve(),t=a(n.response);t.items.forEach(function(e){s.push(e.id)}),e.then(function(){t.nextLink?r(t.nextLink):c.resolve()}).catch(function(e){c.reject(e)})}else c.reject({code:n.status,message:n.statusText})},n.onerror=function(){c.reject({code:n.status,message:n.statusText})},n.send(),i.push(n)}var o,c=C.defer(),l=X[t];return o=e?"https://www.googleapis.com/drive/v2/files/"+e+"/children":"https://www.googleapis.com/drive/v2/files",n&&(o+="?"+b.param({q:n})),r(o),c.promise})).then(function(){r.resolve(s)},function(e){r.reject(e)}),E.delay(function(){r.notify({name:"cancel-handler",handler:function(t){M.warn("listChildren canceled, folderId:",e),E.each(i,function(e){e.abort()});var n=new Error(localString("common_cancel"));n.appName=t||"cancel",r.reject(n)}})}),r.promise}function S(e,t,n,r,o,s,i,c,l,u){function d(){var e=X[l],t=C.defer(),n=new XMLHttpRequest;n.open("PUT",g,!0),n.setRequestHeader("Authorization","Bearer "+e.token),n.setRequestHeader("Content-Range","bytes */"+h),n.addEventListener("load",function(e,r){if(200===n.status){var o=n.getResponseHeader("Range");y=parseInt(o.split("-")[1]),t.resolve(p())}else t.reject({code:n.status,message:n.statusText})}),n.addEventListener("error",function(e){t.reject({code:n.status,message:n.statusText})}),n.send()}function p(){var e=X[l],t=C.defer(),n=new XMLHttpRequest;n.open("PUT",g,!0),n.setRequestHeader("Authorization","Bearer "+e.token),n.setRequestHeader("Content-Range",H.sprintf("bytes %d-%d/%d",y+1,h-1,h)),n.addEventListener("load",function(e,r){200===n.status?(f=JSON.parse(n.responseText),t.resolve()):503===n.status?t.resolve(d()):t.reject({code:n.status,message:n.statusText})}),n.addEventListener("error",function(e){t.reject({code:n.status,message:n.statusText})});var o;return o="string"==typeof r?r.slice(y+1):new Uint8Array(r,y+1),n.send(o),t.promise}var f,g,h,v=C.defer(),w=U("MobileApp")&&u.fileUrl;w?(console.assert(!r),h=u.byteLength):"string"==typeof r?h=void 0:(console.assert(void 0!==r.byteLength),h=r.byteLength);var T=C.resolve();(T=(T=(T=T.then(function(){var r=C.defer(),a=(X[l],{title:n,mimeType:o=o||"application/octet-stream"});t&&(a.parents=[{kind:"drive#fileLink",id:t}]),i&&(a.createdDate=i),c&&(a.modifiedDate=c,a.modifiedByMeDate=c),u.properties&&(a.properties=[],E.each(u.properties,(e,t)=>{a.properties.push({key:t,value:e,visibility:"PRIVATE"})}));var d="https://www.googleapis.com/upload/drive/v2/files",p="POST";e&&(d+="/"+e,p="PUT"),d+="?uploadType=resumable",u.bConvertToGDoc&&(d+="&convert=true");var f=JSON.stringify(a);return m(l,function(){var t=X[l],n=new XMLHttpRequest;n.open(p,d,!0),n.setRequestHeader("Authorization","Bearer "+t.token),n.setRequestHeader("Content-Type","application/json"),n.setRequestHeader("X-Upload-Content-Type",o),void 0!==h&&n.setRequestHeader("X-Upload-Content-Length",h),s&&n.setRequestHeader("If-Match",s),n.addEventListener("load",function(t,o){if(200===n.status)g=n.getResponseHeader("Location"),r.resolve();else{var s=n.statusText;void 0!==e&&412===n.status&&(s="ETag check failed!|ETagChanged"),r.reject(s)}}),n.addEventListener("error",function(e){r.reject(n.statusText)}),n.send(f)}),r.promise})).then(function(){var e=X[l],t=C.defer();if(w){var i=function(e){200===e.responseCode?(f=JSON.parse(e.response),t.resolve()):t.reject({code:e.responseCode,message:"unknown"})},c=function(e){t.reject({code:e.code,message:"unnknown"})},p=u.fileUrl,h=new window.FileUploadOptions;h.fileKey="file",h.fileName=p.substr(p.lastIndexOf("/")+1),h.mimeType=o,h.httpMethod="PUT",h.trustAllHosts=!0;var m={Authorization:"Bearer "+e.token,"Content-Type":o};h.headers=m;var T=new window.FileTransfer;T.onprogress=function(e){let t={name:"progress",loaded:e.loaded,total:e.total};v.notify(t),u.notify(t)},T.upload(p,g,i,c,h)}else{var y=new XMLHttpRequest;y.open("PUT",g,!0),y.setRequestHeader("Authorization","Bearer "+e.token),y.setRequestHeader("Content-Type",o),y.responseType="json",y.onload=function(e,n){200===y.status?(f=a(y.response),t.resolve()):503===y.status?t.resolve(d()):s&&412===y.status?t.reject("ETag check failed!|ETagChanged"):t.reject({code:y.status,message:y.statusText})},y.onerror=function(e){t.reject({code:y.status,message:y.statusText})},y.upload.onprogress=function(e){let t={name:"progress",loaded:e.loaded,total:e.total};v.notify(t),u.notify(t)};var j;"string"==typeof r?(y.setRequestHeader("Content-Encoding","base64"),j=q.default.encodeBase64(r)):j=new Uint8Array(r),y.send(j);let i={name:"cancel-handler",handler:function(e){M.warn("upload canceled:",n),y.abort();var t=new Error(localString("common_cancel"));t.appName=e||"cancel",v.reject(t)}};v.notify(i),u.notify(i)}return t.promise})).then(function(){var t=C.defer();X[l];return e&&f.explicitlyTrashed?m(l,function(){var n=X[l],r="https://www.googleapis.com/drive/v2/files/"+e+"/untrash",o=new XMLHttpRequest;o.open("POST",r,!0),o.setRequestHeader("Authorization","Bearer "+n.token),o.onload=function(e){200===o.status?t.resolve():t.reject({code:o.status,message:o.statusText})},o.onerror=function(e){t.reject({code:o.status,message:o.statusText})},o.send()}):t.resolve(),t.promise})).then(function(){v.resolve(f)},function(e){v.reject(e)});var y;return v.promise}Object.defineProperty(t,"__esModule",{value:!0});var E=n(19),H=(n.n(E),n(23)),b=(n.n(H),n(9)),A=(n.n(b),n(91)),_=n(7),q=(n.n(_),n(22)),L=n(21),C=(n.n(L),n(103),n(92),n(20)),U=(n.n(C),n(6)),O=(n.n(U),n(24),n(95)),N=n(106),I="[googleHelper]",M=log.reg("googleHelper"),P=3,B=!1,z={create:function(e){this.token=e.token,this.refreshHandler=e.refreshHandler,this.onNewToken=e.onNewToken},request:function(e){function t(u){let d=C.defer(),p=new XMLHttpRequest;var f=r;i&&("object"==typeof i&&i.access_token&&(i.access_token=l.token),f+="?"+("string"==typeof i?i:b.param(i))),p.open(n,f,!0),E.each(o,(e,t)=>{p.setRequestHeader(t,e)}),c||p.setRequestHeader("Authorization","Bearer "+l.token),s&&(p.responseType=s),p.onload=(()=>{let n=p.status,r=p.response&&p.response.error;e._bTestExpire&&!u&&(n=400,r="invalid_token"),200===n?d.resolve(p.response):u?d.reject(p):400===n&&"invalid_token"===r?(M.log("refresh token"),l.refreshHandler().then(e=>{l.token=e,l.onNewToken&&l.onNewToken(e),t(!0).then(d.resolve,d.reject)},e=>{d.reject(e)})):d.reject(p)}),p.onerror=(()=>{d.reject(p)});var g=JSON.stringify(a);return p.send(g),d.promise}let n=e.type,r=e.url,o=e.headers||{},s=e.dataType,a=e.data,i=e.qs,c=e.bDontSetTokenInHeader,l=this;return t(!1)}},F=!1,X={},D={},G={profile:["profile","email"],gdrive:["profile","https://www.googleapis.com/auth/drive","https://www.googleapis.com/auth/drive.appdata"],gmail:["profile","email","https://www.googleapis.com/auth/gmail.compose"],groupAdmin:["https://www.googleapis.com/auth/admin.directory.group","https://www.googleapis.com/auth/admin.directory.user"]};D.getUserProfile=function(e){M.log(I,"getUserProfile, accountId:",e);var t,n=C.defer(),r=C.resolve();return(r=r.then(function(){var n=C.defer(),r=X[e],o=new XMLHttpRequest;return o.open("GET","https://www.googleapis.com/plus/v1/people/me",!0),o.setRequestHeader("Authorization","Bearer "+r.token),o.responseType="json",o.onload=function(){200===o.status?(t=a(o.response),n.resolve()):n.reject({code:o.status,message:o.statusText})},o.onerror=function(){n.reject({code:o.status,message:o.statusText})},o.send(),n.promise})).then(function(){n.resolve(t)},n.reject.bind(n)),n.promise},D.download=function(e,t,n){return M.log(I,"download, fileId: "+e),n||(n={}),w(function(){return T(e,t,n)}).catch(c)},D.downloadMeta=function(e,t,n){M.log(I,"download meta, fileId: "+(b.isArray(e)?"num "+e.length:e));var r=[],o=C.defer();return w(function(){return k(e,t,n,r)}).catch(c).then(o.resolve,o.reject),E.delay(function(){o.notify({name:"cancel-handler",handler:function(e){M.warn("cancel downloadMeda, xhr num:",r.length),E.each(r,function(e){e.abort()});var t=new Error(localString("common_cancel"));t.appName=e||"cancel",o.reject(t)}})}),o.promise},D.listFiles=function(e,t){return x(null,e,t).catch(c)},D.listChildren=function(e,t,n){return x(e,t,n).catch(c)},D.upload=function(e,t,n,r,o,s,a,i,l,u=null){M.log(I,"upload, title: "+n);let d=E.defaults(u||{},{notify:null});return d.notify||(d.notify=function(){}),console.assert(!d.bConvertToGDoc||!e),w(function(){return S(e,t,n,r,o,s,a,i,l,d)}).catch(c)},D.createDir=function(e,t,n){M.log("createDir:",t);var r,o=C.defer(),s=C.resolve();return(s=s.then(function(){var o=C.defer(),s="-------314159265358979323846",i="\r\n--"+s+"\r\n",c="\r\n--"+s+"--",l={title:t,mimeType:"application/vnd.google-apps.folder"};n&&(l.parents=[{kind:"drive#fileLink",id:n}]);var u=[i,"Content-Type: application/json\r\n\r\n",JSON.stringify(l),c].join("");return m(e,function(){var t=X[e],n=new XMLHttpRequest;n.open("POST","https://www.googleapis.com/upload/drive/v2/files",!0),n.setRequestHeader("Authorization","Bearer "+t.token),n.setRequestHeader("Content-Type",'multipart/mixed; boundary="'+s+'"'),n.responseType="json",n.addEventListener("load",function(e,t){200===n.status?(r=a(n.response).id,o.resolve()):o.reject({code:n.status,message:n.statusText})}),n.addEventListener("error",function(e){o.reject({code:n.status,message:n.statusText})}),n.send(u)}),o.promise})).then(function(){o.resolve(r)},function(e){o.reject(e)}),o.promise.catch(c)},D.moveFile=function(e,t,n,r){M.log(I,"moveFile, title:",r),console.assert(t);var o,s=C.resolve();return(s=s.then(function(){var s=C.defer();return m(e,function(){var i="https://www.googleapis.com/drive/v2/files/"+t,c={};r&&(c.title=r),c.parents=[{kind:"drive#fileLink",id:n}];var l=JSON.stringify(c),u=X[e],d=new XMLHttpRequest;d.open("POST",i,!0),d.setRequestHeader("Authorization","Bearer "+u.token),d.setRequestHeader("Content-Type","application/json"),d.setRequestHeader("X-HTTP-Method-Override","PATCH"),d.responseType="json",d.onload=function(e,t){if(200===d.status)o=a(d.response),s.resolve();else{var n;n={code:d.status,message:d.statusText},s.reject(n)}},d.onerror=function(e){s.reject({code:d.status,message:d.statusText})},d.send(l)}),s.promise})).then(function(){return o}).catch(c)},D.trashFile=function(e,t){var n=C.resolve();return(n=n.then(function(){var n=C.defer(),r={Authorization:"Bearer "+X[e].token},o="https://www.googleapis.com/drive/v2/files/"+t+"/trash";return b.ajax({type:"POST",url:o,headers:r}).done(function(e){n.resolve()}).fail(function(e){404===e.status?(M.warn(I,"deleted file was not found, skip. fileId: "+t),n.resolve()):n.reject({code:e.status,message:e.statusText})}),n.promise})).catch(c)},D.deleteFile=function(e,t){var n=C.resolve();return(n=n.then(function(){var n=C.defer(),r={Authorization:"Bearer "+X[e].token},o="https://www.googleapis.com/drive/v2/files/"+t;return b.ajax({type:"DELETE",url:o,headers:r}).done(function(e){n.resolve()}).fail(function(e){404===e.status?(M.warn(I,"deleted file was not found, skip. fileId: "+t),n.resolve()):n.reject({code:e.status,message:e.statusText})}),n.promise})).catch(c)},D.copyFile=function(e,t,n,r,o){M.log(I,"copyFile: fid:",t," to:",n);var s=o||{},a=C.resolve();return(a=a.then(function(){var o=C.defer(),a={Authorization:"Bearer "+X[e].token},i="https://www.googleapis.com/drive/v2/files/"+t+"/copy",c={};s.gdriveConvert&&(c.convert=!0);var l=b.param(c);l&&(i+="?"+l);var u={title:n};return r&&(u.parents=[{kind:"drive#fileLink",id:r}]),b.ajax({type:"POST",url:i,headers:a,processData:!1,contentType:"application/json",data:JSON.stringify(u)}).done(function(e){o.resolve(e)}).fail(function(e){o.reject({code:e.status,message:e.statusText})}),o.promise})).catch(c)},D.sendGmail=function(e,t){M.log(I,"sendGmail, draft:",t.bDraft||"0");var n=t.attach,r=t.msg,o=C.defer(),s=C.resolve();return(s=s.then(function(){var s,a,i,c,l=C.defer(),u=X[e],d=(u.token,{}),p=["To: "+t.to,"Subject: "+q.default.base64ForMailHeader(t.subject||"")].join("\n"),f="-------314159265358979323846",g="--"+f,h="--"+f+"--";n&&("string"==typeof n.data?(i=n.data,c="quoted-printable"):(i=q.default.arrayBufferToBase64(n.data),c="base64")),s=t.bDraft?"https://www.googleapis.com/upload/gmail/v1/users/me/drafts":"https://www.googleapis.com/upload/gmail/v1/users/me/messages/send",d.uploadType="multipart",a=n?["MIME-Version: 1.0",p,'Content-Type: multipart/mixed; boundary="'+f+'"',"",g,'Content-Type: text/html; charset="UTF-8"',"",r,"",g,"Content-Type: "+n.type+';name="'+n.name+'"',"Content-Transfer-Encoding: "+c,'Content-Disposition: attachment; filename="'+n.name+'"',"",i,"",h].join("\n"):["MIME-Version: 1.0",p,'Content-Type: multipart/mixed; boundary="'+f+'"',"",g,'Content-Type: text/html; charset="UTF-8"',"",r,"",h].join("\n");var v=b.param(d);v&&(s+="?"+v);var m=new XMLHttpRequest;return m.open("POST",s,!0),m.setRequestHeader("Authorization","Bearer "+u.token),m.setRequestHeader("Content-Type","message/rfc822"),m.responseType="json",m.onload=function(){200===m.status?(console.debug(m.response),l.resolve({msgId:t.bDraft?m.response.message.id:m.response.id})):(M.error(m.response),l.reject({code:m.status,message:m.statusText}))},m.onerror=function(){l.reject({code:m.status,message:m.statusText})},m.onprogress=function(e){o.notify({name:"progress",loaded:e.loaded,total:e.total})},m.send(a),E.delay(function(){o.notify({name:"cancel-handler",handler:function(e){M.warn("sending email canceled:"),m.abort();var t=new Error(localString("common_cancel"));t.appName=e||"cancel",l.reject(t)}})}),l.promise})).catch(c).then(o.resolve,o.reject),o.promise},D.share=function(e,t,n){M.log(I,"share, fileId:",e);var r=C.resolve();return(r=r.then(function(){var n,r=C.defer(),o=X[t];n=H.sprintf("https://www.googleapis.com/drive/v2/files/%s/permissions",e);var s=b.param({});s&&(n+="?"+s);var a=JSON.stringify({role:"reader",type:"anyone",id:"anyoneWithLink",withLink:!0}),i=new XMLHttpRequest;return i.open("POST",n,!0),i.setRequestHeader("Authorization","Bearer "+o.token),i.setRequestHeader("Content-Type","application/json"),i.responseType="json",i.onload=function(){200===i.status?r.resolve({link:H.sprintf("https://drive.google.com/file/d/%s/view?usp=sharing",e)}):(M.error(i.response),r.reject({code:i.status,message:i.statusText}))},i.onerror=function(){r.reject({code:i.status,message:i.statusText})},i.send(a),r.promise})).catch(c)},D.gmailGetUserProfile=function(e){M.log(I,"gmailGetUserProfile, accountId:",e);var t=C.resolve();return(t=t.then(function(){return D.getUserProfile(e)}).then(function(e){return e})).catch(c)},D.authenticate=function(e,t){M.log(I,"authenticate");let n=C.defer();return C.resolve().then(function(){E.delay(()=>{n.notify({name:"cancel-handler",handler:function(e){M.warn("authenticate canceled:");var t=new Error(localString("common_cancel"));t.appName=e||"cancel",n.reject(t)}})})}).then(u).then(v.bind(window,"gdrive",e,t)).catch(c).then(n.resolve,n.reject,n.notify),n.promise},D.authenticateEx=function(e,t,n){M.log(I,"authenticateEx",t);let r=C.defer();return C.resolve().then(function(){E.delay(()=>{r.notify({name:"cancel-handler",handler:function(e){M.warn("authenticate canceled:");var t=new Error(localString("common_cancel"));t.appName=e||"cancel",r.reject(t)}})})}).then(u).then(v.bind(window,t,e,n)).catch(c).then(r.resolve,r.reject,r.notify),r.promise},D.shortUrl=function(e){let t="https://www.googleapis.com/urlshortener/v1/url";t+="?"+b.param({key:"AIzaSyATYjAyIYVJYfTps3VL5qidcEn_cl3PujU"});let n={longUrl:e},r=C.defer();var o=new XMLHttpRequest;o.open("POST",t,!0),o.responseType="json",o.setRequestHeader("Content-Type","application/json"),o.onload=function(){if(200===o.status){let e=a(o.response);r.resolve(e.id)}else r.reject({code:o.status,message:o.statusText})},o.onerror=function(){r.reject({code:o.status,message:o.statusText})};let s=JSON.stringify(n);return o.send(s),r.promise},window.delayedFunction=void 0,window.runDelayedFunction=function(){void 0!==window.delayedFunction&&window.delayedFunction()},U("MobileApp")&&(window.dbgRevokeGoogleAuthToken=function(){var e=X["google.gdrive0"];chrome.identity.revokeAuthToken({token:e.token},function(){M.debug(I,"Revvoke succeed")})}),t.default=D}});
//# sourceMappingURL=7.bundle.js.map