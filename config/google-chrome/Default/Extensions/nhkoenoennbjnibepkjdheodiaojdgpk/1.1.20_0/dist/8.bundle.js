webpackJsonp([8],{88:function(e,n,i){"use strict";function o(){u.resolve().then(function(){return u.nfcall(r.default.loadAppSettings)}).then(function(){if(g("ChromeApp")){var e=u.defer();if(r.default.getAppSettings().bBrowsedChecked)e.resolve();else{var n=""!==(new window.Audio).canPlayType("audio/mpeg");if(r.default.hasNacl()&&n)e.resolve();else{console.assert(!1);var i={btnOk:!0,btnCancel:!0,okTitle:"Let Me Run Anyhow",cancelTitle:"Quit App",okClass:"btn-warning",cancelClass:"btn-primary",bBackdrop:!1};r.default.messageBox("Can't Run on Your Browser","You browser seems not <strong>Google Chrome</strong> (Is it Chromium?), Mic Note may behave abnormally.",i,function(n){"Ok"===n?e.resolve():window.close()})}r.default.getAppSettings().bBrowsedChecked=!0,r.default.saveAppSettings()}return e.promise}}).then(function(){var e=u.defer();r.default.saveAppSettings();var n=s.getMajorVersion(l.CLIENT_VERSION);if(s.getMajorVersion(r.default.getAppSettings().lastShowUpdateListVer)!=n){var i=l.updateList[l.appName];if(i.length){for(var o="Pro"===r.default.getAppSettings().loginAccountType,a="<p><ul>",g=0;g<i.length;g++){var c=i[g];(-1===c.indexOf("pro-only")||o)&&(-1!==c.indexOf("pro-hide")&&o||(a+="<li>"+i[g]+"</li>"))}a+="</ul></p>";var d=t("#loading-screen .changes-list-view");d.find(".heading").html(localString("av_update")),d.find(".content").html(localString("av_welcome_new_ver",n,a)),d.find(".action-ok").html(localString("common_ok")),d.fadeIn(),d.find(".action-ok").on("click",function(){d.fadeOut(),r.default.getAppSettings().lastShowUpdateListVer=l.CLIENT_VERSION,r.default.saveAppSettings(),e.resolve()})}else r.default.getAppSettings().lastShowUpdateListVer=l.CLIENT_VERSION,r.default.saveAppSettings(),e.resolve()}else e.resolve();return e.promise}).then(function(){l.bAppOffline=!d&&!navigator.onLine,log.log("navigator.onLine: "+navigator.onLine),window.bAppInited=!0,c.a()}).catch(function(e){log.error(e)})}Object.defineProperty(n,"__esModule",{value:!0}),i.d(n,"render",function(){return o});var t=i(9),a=(i.n(t),i(19)),r=(i.n(a),i(22)),l=i(7),s=(i.n(l),i(21)),g=(i.n(s),i(6)),u=(i.n(g),i(20)),c=(i.n(u),i(95)),d=!1;d&&log.log("DEBUG_FORCE_ONLINE is on!")},95:function(e,n,i){"use strict";function o(e){$("#loading-state").text(e)}function t(){E.info("checkVersion");var e=v.defer();return c().then(function(n){window._versionPassToken=n.versionPassToken,n.newVersion&&(window._serverNewVersion=n.newVersion),e.resolve()}).catch(function(n){var i;i="version-too-low"==n?"version-too-low":"version-error"==n?localString("av_ver_error",y.CLIENT_VERSION):localString("common_net_err_retry_later"),e.reject(i)}),e.promise}function a(){function e(){g().then(function(){T.default.getLoginData("loginToken");var e=T.default.getLoginData("loginUserId"),n=T.default.getLoginData("loginEmail"),i=T.default.getLoginData("loginSignInType"),o=T.default.getLoginData("loginSignInUserId"),t=T.default.getLoginData("loginSignInUserEmail"),a=T.default.getLoginData("loginSignInShowName");T.default.onLoginSuccess(e,n,i,o,t,a)}).catch(function(e){let n=T.default.getShowError(e);$("#loading-state").text(n),T.default.messageBox(localString("common_error"),n,{btnOk:!1})})}E.info("flowLoginStart");var n=T.default.getLoginData("loginToken"),i=T.default.getLoginData("loginUserId"),o=T.default.getLoginData("loginEmail"),t=T.default.getLoginData("loginSignInType"),a=T.default.getLoginData("loginSignInUserId"),r=T.default.getLoginData("loginSignInUserEmail"),l=T.default.getLoginData("loginSignInShowName"),s=T.default.getAppSettings();if(s.bSwitchNewAccount&&(window._bFirstRun=!0,delete s.bSwitchNewAccount,T.default.saveAppSettings()),n&&i)E.info("offline login success"),T.default.onLoginSuccess(i,o,t,a,r,l);else{window._bFirstRun=!0;_("ChromeApp")?f().then(function(){T.default.getLoginData("loginToken");var e=T.default.getLoginData("loginUserId"),n=T.default.getLoginData("loginEmail"),i=T.default.getLoginData("loginSignInType"),o=T.default.getLoginData("loginSignInUserId"),t=T.default.getLoginData("loginSignInUserEmail"),a=T.default.getLoginData("loginSignInShowName");T.default.onLoginSuccess(e,n,i,o,t,a)},function(){e()}):e()}}function r(){return window.arOnlineLoginSuccess?v.resolve():(P=!0,t().then(function(){var e=v.defer(),n=T.default.getAppSettings();return _("ChromeApp")&&!n.loginSignInUserEmail?(E.debug("patch for sign in email"),chrome.identity.getProfileUserInfo(function(i){E.debug("found user profile:",i),N&&(i.id=""),k&&(i.email=""),i.email&&(i.email=i.email.toLowerCase()),i.email||i.id?$.ajax({url:T.default.makeApiUrl("/api/patch-social"),type:"POST",xhrFields:{withCredentials:!0},data:{uid:n.loginUserId,signInType:"Google",signInUserEmail:i.email,signInUserId:i.id}}).done(function(e){n.loginSignInType="Google",i.email&&(n.loginSignInUserEmail=i.email),i.id&&(n.loginSignInUserId=i.id),T.default.saveAppSettings()}).error(function(e){E.error("patch-social failed:",e.responseText)}).always(function(){e.resolve()}):(E.error("no email found, patch failed"),e.resolve())})):e.resolve(),e.promise}).then(function(){var e=T.default.getLoginData("loginToken"),n=T.default.getLoginData("loginUserId");T.default.getLoginData("loginEmail");return u(n,e)}).then(function(){E.info("online login succeed"),window.arOnlineLoginSuccess=!0,P=!1,L.emit("success")},e=>{throw P=!1,L.emit("failed"),e}))}function l(){E.info("getGoogleUserProfile");var e=v.defer();return i.e(7).then(function(){var n=[i(93)];(function(n){n.authenticateEx("google.gdrive0","profile",!0).then(function(){return n.getUserProfile("google.gdrive0")}).then(function(n){var i={signInType:"Google",signInUserId:n.id,signInUserEmail:n.emails&&n.emails.length&&n.emails[0].value,signInShowName:n.displayName};i.signInUserEmail&&(i.signInUserEmail=i.signInUserEmail.toLowerCase()),e.resolve(i)},function(n){let i;i="cancel"===n||n&&"cancel"===n.message?"cancel":_("ChromeApp")?localString("get_google_profile_failed_chrome"):localString("get_google_profile_failed_normal"),e.reject(i)})}).apply(null,n)}).catch(i.oe),e.promise}function s(){var e=v.defer();return $.ajax({url:T.default.makeApiUrl("/api/new-unreg"),type:"POST",xhrFields:{withCredentials:!0},data:{lang:y.lang,market:y.market,versionPassToken:window._versionPassToken,appName:y.appName,version:y.CLIENT_VERSION},success:function(n){var i=T.default.getAppSettings();i.loginUserId=n.uid,i.loginAccountType=n.accountType,i.loginFreePlan=n.freePlan,i.loginProPlan=n.proPlan,i.loginTrialEndDate=new Date(n.trialEndDate),i.loginToken=n.loginToken,i.unregLoginUserId=n.uid,i.unregLoginAccountType=n.accountType,i.unregLoginFreePlan=n.freePlan,i.unregLoginProPlan=n.proPlan,i.unregLoginTrialEndDate=new Date(n.trialEndDate),i.unregLoginToken=n.loginToken,T.default.saveAppSettings(),E.log("a default account created."),e.resolve({uid:n.uid,token:n.loginToken})},error:function(n){E.log(n.responseText+" :: "+n.statusText),e.reject()}}),e.promise}function g(){E.info("flowCreateUnregAccount");var e=v.defer();return o(localString("creating_account")),t().then(function(){return s()}).then(function(n){u(n.uid,n.token).then(function(){e.resolve()},function(n){e.reject(n)})}).catch(function(){e.reject(localString("av_unreg_create_failed"))}),e.promise}function u(e,n){E.info("doOnlineLogin");var i=v.defer(),o={};return o.loginUserId=e,o.loginToken=n,o.lang=y.lang,o.version=y.CLIENT_VERSION,o.bUseCookies=!1,o.versionPassToken=window._versionPassToken,$.ajax({url:T.default.makeApiUrl("/api/auto-login"),type:"POST",xhrFields:{withCredentials:!0},data:o,dataType:"json",success:function(e){var n=e.trialEndDate?new Date(e.trialEndDate):new Date,o=T.default.getAppSettings();if(o.loginAccountType=e.accountType,o.loginFreePlan=e.freePlan,o.loginProPlan=e.proPlan,o.loginTrialEndDate=n,o.loginEmail=e.email,o.loginSignInType=e.signInType,o.loginSignInUserId=e.signInUserId,o.loginSignInUserEmail=e.signInUserEmail,o.loginSignInShowName=e.signInShowName,window.ar_bottomMsgType=e.bottomMsgType,window.ar_bottomMsgBody=e.bottomMsgBody,window.ar_bottomMsgArg=e.bottomMsgArg,e.forceSettings)try{o.forceSettings=JSON.parse(e.forceSettings),T.default.unsafeConvertBoolString(o.forceSettings)}catch(e){o.forceSettings={}}else o.forceSettings={};T.default.saveAppSettings(),$.ajaxSetup({beforeSend:function(n){n.setRequestHeader("X-CSRF-TOKEN",e.loginCsrf)}}),window.loginCsrf=e.loginCsrf,i.resolve({email:e.email,accountType:e.accountType,freePlan:e.freePlan,proPlan:e.proPlan,trialEndDate:n,signInType:e.signInType,signInUserId:e.signInUserId,signInUserEmail:e.signInUserEmail,signInShowName:e.signInShowName})},error:function(e){E.error("online auto-login failed"),E.log(e.responseText+" :: "+e.statusText);var n;n="invalid-token"==e.responseText?localString("av_auto_login_token_error"):"user-not-found"==e.responseText?localString("av_auto_login_user_not_found"):localString("av_online_login_failed"),i.reject(n)}}),i.promise}function c(){return v.Promise(function(e,n){$.ajax({url:T.default.makeApiUrl("/api/check-version"),type:"GET",xhrFields:{withCredentials:!0},timeout:1e4,dataType:"json",data:{version:y.CLIENT_VERSION,osName:y.osName,appName:y.appName,lang:y.lang},success:function(n){e(n)},error:function(e){n(e.responseText)}})})}function d(e,n){var i=v.defer();return $.ajax({url:T.default.makeApiUrl("/api/reg-social"),type:"POST",xhrFields:{withCredentials:!0},data:{uid:e,signInType:n.signInType,signInUserId:n.signInUserId,signInUserEmail:n.signInUserEmail,signInShowName:n.signInShowName}}).done(function(){var e=T.default.getAppSettings();e.loginSignInType=n.signInType,e.loginSignInUserId=n.signInUserId,e.loginSignInUserEmail=n.signInUserEmail,e.loginSignInShowName=n.signInShowName,T.default.saveAppSettings(),i.resolve()}).fail(function(e){i.reject(e.responseText)}),i.promise}function f(){return E.info("flowCreateRegAccountWithGoogle"),t().then(function(){var e=v.defer();return chrome.identity.getProfileUserInfo(function(n){o(localString("creating_account")),E.info("found user info:",n),N&&(n.id=""),k&&(n.email=""),n.email&&(n.email=n.email.toLowerCase()),n.id||n.email?e.resolve({signInUserId:n.id,signInUserEmail:n.email,signInShowName:""}):T.default.messageBoxPromise(localString("signin_run_title"),localString("signin_run_body"),{btnOk:!0,btnCancel:!0,okTitle:localString("signin_run_signin"),cancelTitle:localString("signin_run_exit"),cancelType:"dismissive",parentEl:$("#loading-screen")[0]}).then(function(n){"Ok"===n?l().then(function(n){n.signInUserEmail&&n.signInUserId?e.resolve({signInUserId:n.signInUserId,signInUserEmail:n.signInUserEmail,signInShowName:n.signInShowName}):e.reject("Could not find user email or id")},e.reject):window.close()})}),e.promise}).then(function(e){console.assert(e&&(e.signInUserId||e.signInUserEmail));var n=v.defer();return $.ajax({url:T.default.makeApiUrl("/api/new-social-account"),type:"POST",xhrFields:{withCredentials:!0},data:{versionPassToken:window._versionPassToken,lang:y.lang,market:y.market,appName:y.appName,version:y.CLIENT_VERSION,signInType:"Google",signInUserId:e.signInUserId,signInUserEmail:e.signInUserEmail,signInShowName:e.signInShowName}}).done(function(e){e.bNewUser?E.info("created social account succeed"):(E.info("restored social account succeed"),window._bOldUser=!0);var i=T.default.getAppSettings();i.loginUserId=e.uid,i.loginEmail=e.email,i.loginToken=e.loginToken,i.loginAccountType=e.accountType,i.loginSignInType=e.signInType,i.loginSignInUserId=e.signInUserId,i.loginSignInUserEmail=e.signInUserEmail,i.loginSignInShowName=e.signInShowName,T.default.saveAppSettings(),e.preDefSettings&&(window._preDefSettings=e.preDefSettings),n.resolve(e)}).fail(function(e){n.reject()}),n.promise}).then(function(e){return u(e.uid,e.loginToken)})}function p(e){E.info("signInWithGoogle");var n;return v.resolve().then(function(){return l()}).then(function(e){n=e;var i=v.defer();return $.ajax({url:T.default.makeApiUrl("/api/signin-social"),type:"POST",xhrFields:{withCredentials:!0},data:{versionPassToken:window._versionPassToken,signInType:n.signInType,signInUserId:n.signInUserId,signInUserEmail:n.signInUserEmail,appName:y.appName,version:y.CLIENT_VERSION}}).done(function(e){E.info("sign in with google success"),i.resolve(e)}).fail(function(e){E.error("sign in with google failed",e.responseText),i.reject(e.responseText)}),i.promise}).then(function(n){function i(){return{uid:n.uid,email:n.email,accountType:n.accountType,freePlan:n.freePlan,proPlan:n.proPlan,signInType:n.signInType,signInUserId:n.signInUserId,signInShowName:n.signInShowName}}if(e)return i();var o=T.default.getAppSettings();return o.loginUserId=n.uid,o.loginEmail=n.email,o.loginToken=n.loginToken,o.loginAccountType=n.accountType,o.loginSignInType=n.signInType,o.loginSignInUserId=n.signInUserId,o.loginSignInShowName=n.signInShowName,T.default.saveAppSettings(),u(n.uid,n.loginToken).then(function(e){return i()})})}function I(){E.info("signUpWithGoogle");var e,n=T.default.getLoginData("loginUserId"),i=T.default.getLoginData("loginToken");return l().then(function(i){return e=i,d(n,e)}).then(function(){return u(n,i)}).then(function(e){return{uid:n,email:e.email,accountType:e.accountType,freePlan:e.freePlan,proPlan:e.proPlan,trialEndDate:e.trialEndDate,signInType:e.signInType,signInUserId:e.signInUserId,signInShowName:e.signInShowName}})}function m(){}function S(){return window.arOnlineLoginSuccess?v.resolve():(P||r(),L.take(1).toPromise(v.Promise).then(e=>{if("failed"===e)throw localString("login_app_server_failed")}))}i.d(n,"a",function(){return a}),i.d(n,"b",function(){return r}),i.d(n,"f",function(){return m}),i.d(n,"d",function(){return p}),i.d(n,"e",function(){return I}),i.d(n,"c",function(){return S});var h=i(19),w=(i.n(h),i(23)),v=(i.n(w),i(20)),T=(i.n(v),i(22)),U=i(21),_=(i.n(U),i(6)),y=(i.n(_),i(7)),E=(i.n(y),i(91),i(92),log.reg("onlineMgr")),N=!1,k=!1;let L=new Kefir.Bus,P=!1}});
//# sourceMappingURL=8.bundle.js.map